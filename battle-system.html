<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grindly | Battle Arena</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ===== BATTLE SYSTEM STYLES - EXACTLY LIKE BEFORE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0f1f;
            --card: #151e2f;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #2a3548;
            --accent: #4f46e5;
            --battle-gold: #fbbf24;
            --battle-silver: #94a3b8;
            --battle-health: #ef4444;
            --battle-mana: #3b82f6;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Press Start 2P', cursive;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .battle-header {
            background: linear-gradient(135deg, var(--card), #0f172a);
            border: 4px solid var(--battle-gold);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .battle-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--battle-gold);
            text-shadow: 3px 3px 0 #000;
        }

        .back-btn {
            background: var(--battle-gold);
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(251,191,36,0.3);
        }

        .main-menu {
            text-align: center;
            padding: 40px;
        }

        .menu-title {
            font-size: 3rem;
            color: var(--battle-gold);
            margin-bottom: 30px;
            text-shadow: 4px 4px 0 #000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 40px 0;
        }

        .stat-card {
            background: var(--card);
            border: 3px solid var(--battle-gold);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--battle-gold);
        }

        .battle-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            margin: 40px 0;
        }

        .battle-card {
            background: linear-gradient(135deg, var(--card), var(--bg));
            border: 4px solid var(--battle-gold);
            border-radius: 40px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .battle-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.3s ease;
        }

        .battle-card:hover {
            transform: translateY(-15px);
            box-shadow: 0 30px 40px rgba(251,191,36,0.3);
        }

        .battle-card.create {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
        }

        .battle-card.join {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .battle-icon {
            font-size: 6rem;
            margin-bottom: 20px;
        }

        .battle-card-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 #000;
        }

        .battle-card-desc {
            color: rgba(255,255,255,0.9);
            margin-bottom: 30px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .battle-cost {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 15px;
            color: var(--battle-gold);
            font-size: 1rem;
            display: inline-block;
            border: 2px solid var(--battle-gold);
        }

        .code-view {
            max-width: 600px;
            margin: 0 auto;
            background: linear-gradient(135deg, var(--card), var(--bg));
            border: 4px solid var(--battle-gold);
            border-radius: 40px;
            padding: 50px;
            text-align: center;
        }

        .code-display {
            font-family: 'Press Start 2P', cursive;
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 15px;
            padding: 40px;
            background: #000;
            border-radius: 20px;
            border: 4px solid var(--battle-gold);
            margin: 30px 0;
            color: var(--battle-gold);
            text-shadow: 0 0 20px rgba(251,191,36,0.5);
            word-break: break-all;
        }

        .code-input {
            width: 100%;
            padding: 20px;
            font-size: 2rem;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            letter-spacing: 10px;
            background: #000;
            border: 4px solid var(--battle-gold);
            border-radius: 20px;
            color: var(--battle-gold);
            margin: 20px 0;
            text-transform: uppercase;
        }

        .code-input:focus {
            outline: none;
            box-shadow: 0 0 30px rgba(251,191,36,0.5);
        }

        .battle-btn {
            background: linear-gradient(135deg, var(--battle-gold), #f59e0b);
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.3s ease;
            margin: 10px;
            border: 3px solid #000;
            min-width: 200px;
        }

        .battle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--battle-gold);
        }

        .battle-btn.secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }

        .battle-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .waiting-room {
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, var(--card), var(--bg));
            border: 4px solid var(--battle-gold);
            border-radius: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .waiting-players {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 80px;
            margin: 60px 0;
            flex-wrap: wrap;
        }

        .waiting-player {
            text-align: center;
            width: 250px;
        }

        .waiting-avatar {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 40px;
            border: 4px solid var(--battle-gold);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            animation: avatarPulse 2s infinite;
        }

        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .waiting-vs {
            font-size: 4rem;
            font-weight: 900;
            color: var(--battle-gold);
            text-shadow: 4px 4px 0 #000;
            animation: vsPulse 1s infinite;
        }

        @keyframes vsPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .waiting-status {
            color: var(--battle-gold);
            font-size: 1rem;
            margin-top: 30px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .active-view {
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, var(--card), var(--bg));
            border: 4px solid var(--battle-gold);
            border-radius: 40px;
            max-width: 600px;
            margin: 0 auto;
        }

        .loading {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 6px solid rgba(251,191,36,0.3);
            border-radius: 50%;
            border-top-color: var(--battle-gold);
            animation: spin 1s ease-in-out infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--card), #0f172a);
            border: 2px solid var(--battle-gold);
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            min-width: 300px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.7rem;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .error-message {
            color: #ef4444;
            margin: 15px 0;
            padding: 15px;
            background: rgba(239,68,68,0.1);
            border-radius: 10px;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .battle-grid {
                grid-template-columns: 1fr;
            }
            
            .waiting-players {
                flex-direction: column;
                gap: 30px;
            }
            
            .code-display {
                font-size: 2rem;
                letter-spacing: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="battle-header">
            <div class="battle-title">‚öîÔ∏è BATTLE ARENA</div>
            <button class="back-btn" onclick="goBack()">‚Üê BACK</button>
        </div>

        <div id="battleContent">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ===== BATTLE SYSTEM WITH COMPLETE DATA FOR FIREBASE RULES =====
        (function() {
            console.log("‚öîÔ∏è Battle System loaded with complete data");

            // Firebase Config
            const firebaseConfig = {
                apiKey: "AIzaSyBAIPxgXPZmGdPvB98TLFRfTAClgXWEIM0",
                authDomain: "student-teacher-app-4e7c9.firebaseapp.com",
                databaseURL: "https://student-teacher-app-4e7c9-default-rtdb.firebaseio.com",
                projectId: "student-teacher-app-4e7c9",
                storageBucket: "student-teacher-app-4e7c9.firebasestorage.app",
                messagingSenderId: "737621420458",
                appId: "1:737621420458:web:74c873869a1a47c2ce23d3"
            };

            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const database = firebase.database();

            // State
            let currentBattleCode = null;
            let currentBattleRole = null;
            let battleCheckInterval = null;
            let redirectAttempted = false;

            // Get player info
            function getPlayerId() {
                return localStorage.getItem('studentUserId') || 'player_' + Date.now();
            }

            function getPlayerName() {
                return localStorage.getItem('studentName') || 'Player';
            }

            function getRpgData() {
                try {
                    const saved = localStorage.getItem('trueRpgData');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {}
                return { 
                    level: 1, 
                    mana: 50, 
                    strength: 5, 
                    intelligence: 5, 
                    wisdom: 5, 
                    luck: 5,
                    wins: 0,
                    losses: 0
                };
            }

            function saveRpgData(data) {
                localStorage.setItem('trueRpgData', JSON.stringify(data));
            }

            function showNotification(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            function generateBattleCode() {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                return code;
            }

            // Show main menu
            function showMainMenu() {
                const rpgData = getRpgData();
                
                document.getElementById('battleContent').innerHTML = `
                    <div class="main-menu">
                        <div class="menu-title">‚öîÔ∏è BATTLE ARENA</div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">üíô</div>
                                <div class="stat-label">MANA</div>
                                <div class="stat-value">${Math.round(rpgData.mana)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üèÜ</div>
                                <div class="stat-label">LEVEL</div>
                                <div class="stat-value">${rpgData.level}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">‚öîÔ∏è</div>
                                <div class="stat-label">WINS</div>
                                <div class="stat-value">${rpgData.wins || 0}</div>
                            </div>
                        </div>
                        
                        <div class="battle-grid">
                            <div class="battle-card create" onclick="window.createBattle()">
                                <div class="battle-icon">‚öîÔ∏è</div>
                                <div class="battle-card-title">CREATE</div>
                                <div class="battle-card-desc">Generate a code and invite a friend</div>
                                <div class="battle-cost">COST: 20 MANA</div>
                            </div>
                            
                            <div class="battle-card join" onclick="window.showJoinView()">
                                <div class="battle-icon">ü§ù</div>
                                <div class="battle-card-title">JOIN</div>
                                <div class="battle-card-desc">Enter a friend's code</div>
                                <div class="battle-cost">FREE</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Show join view
            function showJoinView() {
                document.getElementById('battleContent').innerHTML = `
                    <div class="code-view">
                        <h2 style="color: #fbbf24; margin-bottom: 30px;">ENTER BATTLE CODE</h2>
                        <input type="text" class="code-input" id="joinBattleCode" placeholder="------" maxlength="6">
                        <div>
                            <button class="battle-btn" onclick="window.joinBattle()">JOIN BATTLE</button>
                            <button class="battle-btn secondary" onclick="window.showMainMenu()">CANCEL</button>
                        </div>
                        <div id="battleJoinError" class="error-message"></div>
                    </div>
                `;
            }

            // Create battle - WITH COMPLETE DATA FOR FIREBASE RULES
            async function createBattle() {
                const rpgData = getRpgData();
                
                if (rpgData.mana < 20) {
                    showNotification("Not enough mana! Need 20 mana to create a battle.", "error");
                    return;
                }
                
                rpgData.mana -= 20;
                saveRpgData(rpgData);
                
                const code = generateBattleCode();
                currentBattleCode = code;
                currentBattleRole = 'creator';
                
                document.getElementById('battleContent').innerHTML = `
                    <div class="code-view">
                        <h2 style="color: #fbbf24; margin-bottom: 30px;">YOUR BATTLE CODE</h2>
                        <div class="code-display" id="generatedBattleCode">${code}</div>
                        <button class="battle-btn" onclick="window.copyBattleCode()">üìã COPY</button>
                        <button class="battle-btn" onclick="window.waitForOpponent()" id="waitForOpponentBtn">WAIT FOR OPPONENT</button>
                        <button class="battle-btn secondary" onclick="window.cancelBattle()">CANCEL</button>
                    </div>
                `;
                
                await createBattleInFirebase(code, rpgData);
            }

            // Create battle in Firebase - WITH ALL REQUIRED FIELDS
            async function createBattleInFirebase(code, rpgData) {
                try {
                    const playerId = getPlayerId();
                    const playerName = getPlayerName();
                    
                    // Complete battle data with ALL required fields for Firebase rules
                    const battleData = {
                        metadata: {
                            code: code,
                            status: 'waiting',
                            createdAt: Date.now(),
                            round: 1,
                            roundTime: 99,
                            roundStartTime: Date.now()
                        },
                        player1: {
                            id: playerId,
                            name: playerName,
                            gender: 'boy',
                            level: rpgData.level || 1,
                            strength: rpgData.strength || 5,
                            intelligence: rpgData.intelligence || 5,
                            wisdom: rpgData.wisdom || 5,
                            luck: rpgData.luck || 5,
                            health: 100,
                            maxHealth: 100,
                            mana: 0,
                            maxMana: 100,
                            side: 'left'
                        },
                        player2: null,
                        actions: {},
                        winner: null,
                        roundWins: {
                            player1: 0,
                            player2: 0
                        }
                    };
                    
                    console.log("Creating battle with data:", battleData);
                    
                    // Set the battle data
                    await database.ref('battles/' + code).set(battleData);
                    console.log("‚úÖ Battle created successfully:", code);
                    
                    // Verify it was created
                    const verifySnapshot = await database.ref('battles/' + code).once('value');
                    if (verifySnapshot.exists()) {
                        console.log("‚úÖ Battle verified in Firebase");
                        showNotification("Battle created successfully!", "success");
                    } else {
                        console.error("‚ùå Battle not found after creation");
                        showNotification("Battle created but verification failed", "warning");
                    }
                    
                } catch (error) {
                    console.error("‚ùå Error creating battle:", error);
                    showNotification("Failed to create battle: " + error.message, "error");
                }
            }

            // Wait for opponent
            function waitForOpponent() {
                if (!currentBattleCode) return;
                
                showWaitingRoom();
                startBattleCheck(currentBattleCode);
            }

            // Show waiting room
            function showWaitingRoom() {
                const playerName = getPlayerName();
                
                document.getElementById('battleContent').innerHTML = `
                    <div class="waiting-room">
                        <h2 style="color: #fbbf24; margin-bottom: 40px;">WAITING FOR OPPONENT</h2>
                        
                        <div class="waiting-players">
                            <div class="waiting-player">
                                <div class="waiting-avatar">üë§</div>
                                <div style="color: white; margin-top: 15px;">${playerName}</div>
                                <div style="color: #10b981; margin-top: 10px;">‚úÖ READY</div>
                            </div>
                            
                            <div class="waiting-vs">VS</div>
                            
                            <div class="waiting-player">
                                <div class="waiting-avatar">‚ùì</div>
                                <div style="color: white; margin-top: 15px;">Waiting...</div>
                                <div style="color: #fbbf24; margin-top: 10px;">‚è≥ JOINING</div>
                            </div>
                        </div>
                        
                        <div class="waiting-status">Code: ${currentBattleCode} ‚Ä¢ Looking for opponent...</div>
                        
                        <button class="battle-btn danger" onclick="window.cancelBattle()">CANCEL</button>
                    </div>
                `;
                
                redirectAttempted = false;
            }

            // Start battle check
            function startBattleCheck(code) {
                if (battleCheckInterval) {
                    clearInterval(battleCheckInterval);
                }
                
                battleCheckInterval = setInterval(() => {
                    checkBattleStatus(code);
                }, 2000);
            }

            // Check battle status
            async function checkBattleStatus(code) {
                if (!code || redirectAttempted) return;
                
                try {
                    const snapshot = await database.ref('battles/' + code).once('value');
                    const battle = snapshot.val();
                    
                    if (!battle) return;
                    
                    if (battle.player2 && !redirectAttempted) {
                        console.log("‚úÖ Opponent found!");
                        redirectAttempted = true;
                        
                        if (battleCheckInterval) {
                            clearInterval(battleCheckInterval);
                            battleCheckInterval = null;
                        }
                        
                        const playerName = getPlayerName();
                        const playerId = getPlayerId();
                        
                        document.getElementById('battleContent').innerHTML = `
                            <div class="active-view">
                                <div class="loading"></div>
                                <h2 style="color: #fbbf24; margin: 30px 0;">OPPONENT FOUND!</h2>
                                <p style="color: white; margin-bottom: 20px;">${battle.player2.name} has joined!</p>
                                <p style="color: var(--text-muted);">Redirecting to battle arena...</p>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            window.location.href = `fighting_game.html?code=${code}&role=player1&name=${encodeURIComponent(playerName)}&id=${playerId}`;
                        }, 2000);
                    }
                } catch (error) {
                    console.error("Error checking battle status:", error);
                }
            }

            // Join battle
            async function joinBattle() {
                const input = document.getElementById('joinBattleCode');
                const errorEl = document.getElementById('battleJoinError');
                
                if (!input) return;
                
                const code = input.value.toUpperCase().trim();
                
                if (!code || code.length !== 6) {
                    if (errorEl) errorEl.textContent = "Invalid code. Please enter 6 characters.";
                    return;
                }
                
                try {
                    console.log("Attempting to join battle:", code);
                    
                    const snapshot = await database.ref('battles/' + code).once('value');
                    const battle = snapshot.val();
                    
                    if (!battle) {
                        if (errorEl) errorEl.textContent = "Battle not found";
                        return;
                    }
                    
                    if (battle.metadata?.status !== 'waiting') {
                        if (errorEl) errorEl.textContent = "Battle already started";
                        return;
                    }
                    
                    const playerId = getPlayerId();
                    
                    if (battle.player1?.id === playerId) {
                        if (errorEl) errorEl.textContent = "You cannot join your own battle";
                        return;
                    }
                    
                    const playerName = getPlayerName();
                    const rpgData = getRpgData();
                    
                    // Add player2 with ALL required fields
                    await database.ref('battles/' + code + '/player2').set({
                        id: playerId,
                        name: playerName,
                        gender: 'girl',
                        level: rpgData.level || 1,
                        strength: rpgData.strength || 5,
                        intelligence: rpgData.intelligence || 5,
                        wisdom: rpgData.wisdom || 5,
                        luck: rpgData.luck || 5,
                        health: 100,
                        maxHealth: 100,
                        mana: 0,
                        maxMana: 100,
                        side: 'right'
                    });
                    
                    // Update status
                    await database.ref('battles/' + code + '/metadata/status').set('fighting');
                    
                    console.log("‚úÖ Joined battle successfully");
                    
                    document.getElementById('battleContent').innerHTML = `
                        <div class="active-view">
                            <div class="loading"></div>
                            <h2 style="color: #fbbf24; margin: 30px 0;">JOINED BATTLE!</h2>
                            <p style="color: white; margin-bottom: 20px;">Battle against ${battle.player1.name}</p>
                            <p style="color: var(--text-muted);">Redirecting to battle arena...</p>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = `fighting_game.html?code=${code}&role=player2&name=${encodeURIComponent(playerName)}&id=${playerId}`;
                    }, 2000);
                    
                } catch (error) {
                    console.error("Error joining battle:", error);
                    if (errorEl) errorEl.textContent = "Failed to join battle: " + error.message;
                }
            }

            // Copy battle code
            function copyBattleCode() {
                if (!currentBattleCode) return;
                navigator.clipboard.writeText(currentBattleCode).then(() => {
                    showNotification("Code copied: " + currentBattleCode, "success");
                });
            }

            // Cancel battle
            async function cancelBattle() {
                if (battleCheckInterval) {
                    clearInterval(battleCheckInterval);
                    battleCheckInterval = null;
                }
                
                if (currentBattleCode) {
                    try {
                        await database.ref('battles/' + currentBattleCode).remove();
                        console.log("Battle cancelled:", currentBattleCode);
                    } catch (error) {
                        console.error("Error removing battle:", error);
                    }
                }
                
                currentBattleCode = null;
                redirectAttempted = false;
                showMainMenu();
            }

            // Go back
            function goBack() {
                if (battleCheckInterval) {
                    clearInterval(battleCheckInterval);
                }
                window.location.href = 'studentmode.html';
            }

            // Make functions global
            window.showMainMenu = showMainMenu;
            window.showJoinView = showJoinView;
            window.createBattle = createBattle;
            window.joinBattle = joinBattle;
            window.waitForOpponent = waitForOpponent;
            window.copyBattleCode = copyBattleCode;
            window.cancelBattle = cancelBattle;
            window.goBack = goBack;

            // Initialize
            showMainMenu();
        })();
    </script>
</body>
</html>