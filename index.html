<!DOCTYPE html>

  
</body>
</html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grindly | Teacher Mode</title>
<meta name="viewport">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<style>
/* ===== CSS VARIABLES ===== */
/* ===== CSS VARIABLES ===== */
:root {
  /* Light theme (default) */
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --accent: #4f46e5;
  --accent-dark: #4338ca;
  --accent-light: #e0e7ff;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  
  /* Spacing - Responsive */
  --spacing-xs: 0.5rem;
  --spacing-sm: 0.75rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;
  
  /* Border Radius */
  --radius-sm: 0.5rem;
  --radius: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.25rem;
  --radius-2xl: 1.5rem;
  
  /* Shadows */
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
  
  /* Transitions */
  --transition-fast: 0.2s ease;
  --transition: 0.3s ease;
  --transition-slow: 0.5s ease;
  
  /* Gradients */
  --gradient-primary: linear-gradient(135deg, var(--accent), var(--accent-dark));
  --gradient-success: linear-gradient(135deg, var(--success), #059669);
  --gradient-warning: linear-gradient(135deg, var(--warning), #d97706);
  --gradient-danger: linear-gradient(135deg, var(--danger), #dc2626);
  --gradient-info: linear-gradient(135deg, var(--info), #2563eb);
  --gradient-purple: linear-gradient(135deg, var(--purple), #7c3aed);

  /* Aggregate heatmap */
  --heat-0: rgba(148, 163, 184, 0.2);
  --heat-1: rgba(79, 70, 229, 0.2);
  --heat-2: rgba(79, 70, 229, 0.4);
  --heat-3: rgba(79, 70, 229, 0.65);
  --heat-4: rgba(79, 70, 229, 0.9);
}

/* ===== THEMES ===== */
body.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #334155;
  --accent-light: rgba(79, 70, 229, 0.2);
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
}

body.ocean {
  --bg: #0c4a6e;
  --card: #075985;
  --text: #e0f2fe;
  --text-muted: #7dd3fc;
  --border: #0369a1;
  --accent: #0891b2;
  --accent-dark: #0e7490;
  --accent-light: rgba(8, 145, 178, 0.2);
}

body.forest {
  --bg: #064e3b;
  --card: #047857;
  --text: #d1fae5;
  --text-muted: #a7f3d0;
  --border: #059669;
  --accent: #059669;
  --accent-dark: #047857;
  --accent-light: rgba(5, 150, 105, 0.2);
}

body.sunset {
  --bg: #7c2d12;
  --card: #c2410c;
  --text: #ffedd5;
  --text-muted: #fed7aa;
  --border: #ea580c;
  --accent: #ea580c;
  --accent-dark: #c2410c;
  --accent-light: rgba(234, 88, 12, 0.2);
}

body.purple {
  --bg: #1e1b4b;
  --card: #312e81;
  --text: #e0e7ff;
  --text-muted: #a5b4fc;
  --border: #4f46e5;
  --accent: #8b5cf6;
  --accent-dark: #7c3aed;
  --accent-light: rgba(139, 92, 246, 0.2);
}

/* ===== BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  font-size: 16px;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
  line-height: 1.6;
  min-height: 100vh;
  transition: all var(--transition);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== LAYOUT STRUCTURE ===== */
.app-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
  transition: all var(--transition);
}

/* Sidebar collapsed state */
.app-layout.sidebar-collapsed {
  grid-template-columns: 0 1fr;
}

.app-layout.sidebar-collapsed .sidebar {
  transform: translateX(-100%);
  opacity: 0;
  visibility: hidden;
}

.app-layout.sidebar-collapsed .sidebar-toggle {
  left: 20px;
  transform: rotate(180deg);
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: var(--card);
  border-right: 1px solid var(--border);
  padding: var(--spacing-xl);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  z-index: 100;
  transition: transform var(--transition), opacity var(--transition), visibility var(--transition);
  -webkit-overflow-scrolling: touch;
}

.sidebar-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
}

.teacher-emoji {
  font-size: 3.5rem;
  margin-bottom: var(--spacing-md);
  display: block;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(2deg); }
}

.sidebar h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
}

.sidebar-subtitle {
  color: var(--text-muted);
  font-size: 0.875rem;
  margin-bottom: var(--spacing-lg);
}

/* Sidebar Toggle Button */
.sidebar-toggle {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 101;
  background: var(--accent);
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: var(--shadow-md);
  transition: all var(--transition);
  opacity: 1;
  visibility: visible;
  touch-action: manipulation;
}

.sidebar-toggle:hover {
  background: var(--accent-dark);
  transform: scale(1.1);
}

/* RESPONSIVE: Mobile-specific sidebar toggle positioning */
@media (max-width: 1020px) {
  .sidebar-toggle {
    left: 15px;
    top: 15px;
    z-index: 102;
    width: 44px;
    height: 44px;
  }
  
  .sidebar.active ~ .sidebar-toggle {
    left: calc(280px - 22px);
    transform: rotate(180deg);
    background: var(--danger);
  }
}

/* RESPONSIVE: Adjust sidebar for mobile */
@media (max-width: 1020px) {
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .app-layout.sidebar-collapsed {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    transform: translateX(-100%);
    width: 280px;
    height: 100vh;
    z-index: 101;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    opacity: 0;
    visibility: hidden;
  }
  
  .sidebar.active {
    transform: translateX(0);
    opacity: 1;
    visibility: visible;
  }
  
  .app-layout.sidebar-collapsed .sidebar {
    transform: translateX(-100%);
    opacity: 0;
    visibility: hidden;
  }
}

/* Class switcher */
.class-switcher {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.class-switcher select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--card);
  color: var(--text);
  font-size: 0.875rem;
  font-family: inherit;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-xl);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--radius);
  color: var(--text);
  text-decoration: none;
  font-weight: 500;
  font-size: 0.9375rem;
  transition: all var(--transition);
  border: 1px solid transparent;
  cursor: pointer;
  touch-action: manipulation;
  user-select: none;
}

.nav-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateX(5px);
}

.nav-item.active {
  background: var(--gradient-primary);
  color: white;
}

.nav-item.active:hover {
  background: var(--gradient-primary);
  border-color: transparent;
}

.sidebar-stats {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.sidebar-stats h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-value {
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--accent);
}

/* Pro-tip styles */
.pro-tip {
  background: var(--accent-light);
  border-left: 4px solid var(--accent);
  padding: var(--spacing-md);
  border-radius: var(--radius);
  margin: var(--spacing-md) 0;
  font-size: 0.875rem;
  line-height: 1.5;
}

.pro-tip strong {
  color: var(--accent);
  display: block;
  margin-bottom: var(--spacing-xs);
}

/* ===== MODAL STYLES ===== */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-md);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-content {
  background: var(--card);
  border-radius: var(--radius-xl);
  padding: var(--spacing-xl);
  max-width: 500px;
  width: 100%;
  box-shadow: var(--shadow-xl);
  border: 1px solid var(--border);
  animation: modalSlideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  margin-bottom: var(--spacing-lg);
  text-align: center;
}

.modal-header h3 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: var(--spacing-sm);
}

.modal-close {
  position: absolute;
  top: var(--spacing);
  right: var(--spacing);
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.5rem;
  cursor: pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all var(--transition);
  touch-action: manipulation;
}

.modal-close:hover {
  background: var(--accent-light);
  color: var(--accent);
}

@keyframes modalSlideIn {
  from { 
    opacity: 0; 
    transform: translateY(-50px) scale(0.9); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

/* RESPONSIVE: Modal adjustments for mobile */
@media (max-width: 480px) {
  .modal-content {
    padding: var(--spacing-lg);
    border-radius: var(--radius-lg);
  }
  
  .modal-header h3 {
    font-size: 1.25rem;
  }
}

/* ===== MAIN CONTENT ===== */
.main-content {
  padding: var(--spacing-xl);
  overflow-y: auto;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
  min-height: 100vh;
}

/* RESPONSIVE: Main content padding for mobile */
@media (max-width: 768px) {
  .main-content {
    padding: var(--spacing-md);
    padding-top: 80px; /* Account for mobile header */
  }
}

/* ===== MOBILE HEADER ===== */
.mobile-header {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 90;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: var(--spacing-sm) var(--spacing-md);
  align-items: center;
  justify-content: space-between;
  height: 64px;
  box-shadow: var(--shadow);
}

.mobile-menu-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 1.5rem;
  cursor: pointer;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius);
  transition: all var(--transition);
  touch-action: manipulation;
}

.mobile-menu-btn:hover {
  background: var(--accent-light);
  color: var(--accent);
}

.mobile-title {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--text);
  text-align: center;
  flex: 1;
  margin: 0 var(--spacing-md);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.mobile-actions {
  display: flex;
  gap: var(--spacing-xs);
  align-items: center;
}

/* RESPONSIVE: Show mobile header on mobile */
@media (max-width: 1020px) {
  .mobile-header {
    display: flex;
  }
}

/* ===== DASHBOARD HEADER ===== */
.dashboard-header {
  margin-bottom: var(--spacing-xl);
}

.dashboard-header h1 {
  font-size: 2.5rem;
  font-weight: 800;
  margin-bottom: var(--spacing-sm);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.dashboard-subtitle {
  color: var(--text-muted);
  font-size: 1.125rem;
  margin-bottom: var(--spacing-xl);
  line-height: 1.5;
}

.controls-bar {
  display: flex;
  gap: var(--spacing-md);
  align-items: center;
  flex-wrap: wrap;
  padding: var(--spacing-lg);
  background: var(--card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-xl);
}

/* RESPONSIVE: Dashboard header adjustments */
@media (max-width: 768px) {
  .dashboard-header h1 {
    font-size: 1.75rem;
  }
  
  .dashboard-subtitle {
    font-size: 0.9375rem;
  }
  
  .controls-bar {
    padding: var(--spacing-md);
    flex-direction: column;
    align-items: stretch;
    gap: var(--spacing-sm);
  }
}

/* ===== DASHBOARD GRID ===== */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--spacing-xl);
}

/* RESPONSIVE: Grid gap adjustments */
@media (max-width: 1024px) {
  .dashboard-grid {
    gap: var(--spacing-lg);
  }
}

@media (max-width: 768px) {
  .dashboard-grid {
    gap: var(--spacing-md);
  }
}

/* Quick Stats */
.quick-stats {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-lg);
}

/* RESPONSIVE: Quick stats grid adjustments */
@media (max-width: 1024px) {
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
  }
}

@media (max-width: 480px) {
  .quick-stats {
    grid-template-columns: 1fr;
    gap: var(--spacing-sm);
  }
}

.stat-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
  min-height: 120px;
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.stat-icon {
  width: 64px;
  height: 64px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  background: var(--gradient-primary);
  color: white;
  flex-shrink: 0;
}

.stat-card:nth-child(2) .stat-icon {
  background: var(--gradient-success);
}

.stat-card:nth-child(3) .stat-icon {
  background: var(--gradient-warning);
}

.stat-card:nth-child(4) .stat-icon {
  background: var(--gradient-info);
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: var(--spacing-xs);
  color: var(--text);
}

.stat-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

/* RESPONSIVE: Stat card adjustments */
@media (max-width: 768px) {
  .stat-card {
    padding: var(--spacing-lg);
    gap: var(--spacing-md);
    min-height: 100px;
  }
  
  .stat-icon {
    width: 56px;
    height: 56px;
    font-size: 1.5rem;
  }
  
  .stat-number {
    font-size: 2rem;
  }
}

@media (max-width: 480px) {
  .stat-card {
    flex-direction: row;
    text-align: left;
  }
  
  .stat-number {
    font-size: 1.75rem;
  }
}

/* Forms Section */
.forms-section {
  grid-column: span 4;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

/* RESPONSIVE: Forms section adjustments */
@media (max-width: 1024px) {
  .forms-section {
    grid-column: span 12;
    gap: var(--spacing-lg);
  }
}

@media (max-width: 768px) {
  .forms-section {
    gap: var(--spacing-md);
  }
}

.form-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
}

.form-card:hover {
  box-shadow: var(--shadow-md);
}

.form-card h2 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

/* RESPONSIVE: Form card adjustments */
@media (max-width: 768px) {
  .form-card {
    padding: var(--spacing-lg);
  }
  
  .form-card h2 {
    font-size: 1.125rem;
    margin-bottom: var(--spacing-md);
  }
}

/* Form Elements */
.form-group {
  margin-bottom: var(--spacing-lg);
}

@media (max-width: 768px) {
  .form-group {
    margin-bottom: var(--spacing-md);
  }
}

.form-group label {
  display: block;
  margin-bottom: var(--spacing-xs);
  font-weight: 600;
  color: var(--text);
  font-size: 0.875rem;
}

input, textarea, select {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  font-size: 0.9375rem;
  font-family: inherit;
  transition: all var(--transition-fast);
  -webkit-appearance: none;
  appearance: none;
}

/* RESPONSIVE: Input adjustments for mobile */
@media (max-width: 480px) {
  input, textarea, select {
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 0.9375rem 1rem;
  }
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
  background: var(--card);
}

textarea {
  min-height: 120px;
  resize: vertical;
  line-height: 1.6;
}

.btn-submit {
  width: 100%;
  padding: 1rem;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  touch-action: manipulation;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

/* Content Section */
.content-section {
  grid-column: span 8;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

/* RESPONSIVE: Content section adjustments */
@media (max-width: 1024px) {
  .content-section {
    grid-column: span 12;
    gap: var(--spacing-lg);
  }
}

@media (max-width: 768px) {
  .content-section {
    gap: var(--spacing-md);
  }
}

.content-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  overflow: hidden;
}

.content-header {
  padding: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: var(--spacing-md);
}

.content-header h2 {
  font-size: 1.25rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.content-body {
  padding: var(--spacing-xl);
  max-height: 400px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* RESPONSIVE: Content card adjustments */
@media (max-width: 768px) {
  .content-header {
    padding: var(--spacing-lg);
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .content-body {
    padding: var(--spacing-lg);
    max-height: 350px;
  }
  
  .content-header h2 {
    font-size: 1.125rem;
  }
}

/* Students Card */
.students-card .content-body {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: var(--spacing-md);
  max-height: 600px;
  padding: var(--spacing-lg);
}

/* RESPONSIVE: Students card adjustments */
@media (max-width: 768px) {
  .students-card .content-body {
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    max-height: 500px;
  }
}

@media (max-width: 480px) {
  .students-card .content-body {
    grid-template-columns: 1fr;
  }
}

.student-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}

.student-item:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
  border-color: var(--accent);
}

.student-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-primary);
  opacity: 0;
  transition: opacity var(--transition);
}

.student-item:hover::before {
  opacity: 1;
}

.student-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-md);
}

.student-info h4 {
  font-size: 1.125rem;
  font-weight: 700;
  margin-bottom: var(--spacing-xs);
  line-height: 1.3;
}

.student-id {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-family: 'Courier New', monospace;
  background: rgba(0,0,0,0.05);
  padding: 0.125rem 0.375rem;
  border-radius: var(--radius-sm);
}

.streak-badge {
  background: var(--gradient-warning);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-weight: 700;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  white-space: nowrap;
}

.student-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--spacing-xs);
  margin-top: var(--spacing-md);
}

.stat-pill {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.stat-pill-value {
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--accent);
  line-height: 1;
}

.stat-pill-label {
  font-size: 0.6875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 0.25rem;
}

/* RESPONSIVE: Student item adjustments */
@media (max-width: 768px) {
  .student-info h4 {
    font-size: 1rem;
  }
  
  .streak-badge {
    font-size: 0.8125rem;
    padding: 0.25rem 0.625rem;
  }
  
  .stat-pill-value {
    font-size: 1rem;
  }
  
  .stat-pill-label {
    font-size: 0.625rem;
  }
}

/* Items List */
.items-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  transition: all var(--transition);
}

.item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.item-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
  line-height: 1.3;
}

.item-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
  white-space: nowrap;
}

.item-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
  font-size: 0.9375rem;
}

.item-actions {
  display: flex;
  justify-content: flex-end;
}

/* Live Activity Feed */
.activity-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.activity-item {
  display: grid;
  grid-template-columns: 36px 1fr;
  gap: var(--spacing-md);
  align-items: start;
  padding: var(--spacing-md);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  transition: all var(--transition);
}

.activity-item:hover {
  border-color: var(--accent);
  transform: translateX(4px);
  box-shadow: var(--shadow);
}

.activity-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--accent-light);
  color: var(--accent);
  font-size: 1.1rem;
}

.activity-content {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.activity-title {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--text);
}

.activity-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

/* RESPONSIVE: Item adjustments */
@media (max-width: 768px) {
  .item {
    padding: var(--spacing-md);
  }
  
  .item-title {
    font-size: 1rem;
  }
  
  .item-content {
    font-size: 0.875rem;
    line-height: 1.6;
  }
}

.delete-btn {
  background: var(--gradient-danger);
  color: white;
  border: none;
  padding: 0.5rem 1.25rem;
  border-radius: var(--radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  touch-action: manipulation;
}

.delete-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* ===== BUTTONS ===== */
.btn {
  padding: 0.75rem 1.5rem;
  border-radius: var(--radius);
  border: none;
  font-weight: 600;
  font-size: 0.9375rem;
  cursor: pointer;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-decoration: none;
  touch-action: manipulation;
  user-select: none;
}

/* RESPONSIVE: Button adjustments */
@media (max-width: 768px) {
  .btn {
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
  }
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.btn-warning {
  background: var(--gradient-warning);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
}

.btn-danger {
  background: var(--gradient-danger);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
}

.btn-secondary {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* RESPONSIVE: Icon button adjustments */
@media (max-width: 768px) {
  .btn-icon {
    width: 44px;
    height: 44px;
  }
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: calc(100vw - 48px);
}

/* RESPONSIVE: Toast adjustments */
@media (max-width: 768px) {
  .toast-container {
    top: 80px;
    right: 12px;
    left: 12px;
    align-items: center;
  }
}

.toast {
  min-width: 300px;
  max-width: 350px;
  padding: 1.125rem 1.5rem;
  border-radius: var(--radius);
  background: var(--card);
  color: var(--text);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 0.875rem;
  animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 4px solid var(--accent);
  border: 1px solid var(--border);
}

/* RESPONSIVE: Toast width adjustments */
@media (max-width: 768px) {
  .toast {
    min-width: auto;
    width: 100%;
    max-width: 100%;
    padding: 1rem 1.25rem;
  }
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: var(--info); }

/* ===== CONFETTI OVERLAY ===== */
#confettiCanvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 2000;
  display: none;
}

/* ===== CLASS CODE DISPLAY ===== */
.class-code-display {
  background: var(--gradient-primary);
  color: white;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  margin: var(--spacing-xl) 0;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.class-code-display .code {
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.5rem;
  font-family: 'Courier New', monospace;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

/* RESPONSIVE: Class code display adjustments */
@media (max-width: 768px) {
  .class-code-display {
    padding: var(--spacing-lg);
    margin: var(--spacing-lg) 0;
  }
  
  .class-code-display .code {
    font-size: 2rem;
    letter-spacing: 0.375rem;
  }
}

@media (max-width: 480px) {
  .class-code-display .code {
    font-size: 1.75rem;
    letter-spacing: 0.25rem;
  }
}

/* ===== ASSIGNMENT SPECIFIC STYLES ===== */
.assignment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: var(--spacing-lg);
}

/* RESPONSIVE: Assignment grid adjustments */
@media (max-width: 768px) {
  .assignment-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--spacing-md);
  }
}

@media (max-width: 480px) {
  .assignment-grid {
    grid-template-columns: 1fr;
  }
}

.assignment-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  transition: all var(--transition);
  position: relative;
}

.assignment-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
  border-color: var(--accent);
}

.assignment-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-md);
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.assignment-card-title {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--text);
  line-height: 1.3;
}

.assignment-card-due {
  background: var(--gradient-warning);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
  white-space: nowrap;
}

.assignment-card-description {
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  line-height: 1.6;
  font-size: 0.9375rem;
}

.assignment-card-actions {
  display: flex;
  gap: var(--spacing-sm);
  justify-content: flex-end;
}

/* RESPONSIVE: Assignment card adjustments */
@media (max-width: 768px) {
  .assignment-card {
    padding: var(--spacing-md);
  }
  
  .assignment-card-title {
    font-size: 1rem;
  }
  
  .assignment-card-description {
    font-size: 0.875rem;
  }
}

/* ===== SYNC STATUS ===== */
.sync-status {
  position: fixed;
  top: 80px;
  right: 20px;
  background: var(--card);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  z-index: 999;
  display: none;
  align-items: center;
  gap: 0.5rem;
  animation: slideIn 0.3s ease-out;
  box-shadow: var(--shadow);
  max-width: 250px;
}

/* RESPONSIVE: Sync status adjustments */
@media (max-width: 768px) {
  .sync-status {
    top: 90px;
    right: 12px;
    left: 12px;
    max-width: none;
  }
}

.sync-status.syncing { 
  color: var(--warning);
  border-left: 4px solid var(--warning);
}
.sync-status.success { 
  color: var(--success);
  border-left: 4px solid var(--success);
}
.sync-status.error { 
  color: var(--danger);
  border-left: 4px solid var(--danger);
}
.sync-status.info { 
  color: var(--info);
  border-left: 4px solid var(--info);
}

/* ===== EMPTY STATES ===== */
.empty-state {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: var(--spacing-lg);
  opacity: 0.5;
}

.empty-state-title {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  color: var(--text);
}

.empty-state-description {
  font-size: 1rem;
  line-height: 1.6;
  max-width: 400px;
}


/* ===== AGGREGATE ENGAGEMENT HEATMAP ===== */
.aggregate-heatmap {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-width: 100%;
  overflow: hidden;
}

.calendar-heatmap {
  display: grid;
  grid-template-rows: auto 1fr;
  gap: 8px;
  max-width: 100%;
  overflow: hidden;
}

.calendar-heatmap-header {
  display: grid;
  grid-template-columns: 24px 1fr;
  gap: 4px;
  align-items: end;
  max-width: 100%;
  overflow: hidden;
}

.calendar-months {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: 12px;
  column-gap: 2px;
  align-items: center;
  max-width: calc(100% - 28px);
  overflow: hidden;
}

.calendar-month-label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  grid-column: span 4;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.calendar-heatmap-body {
  display: grid;
  grid-template-columns: 24px 1fr;
  gap: 4px;
  max-width: 100%;
  overflow: hidden;
}

.calendar-weekday-labels {
  display: grid;
  grid-template-rows: repeat(7, 12px);
  gap: 2px;
  font-size: 0.55rem;
  color: var(--text-muted);
  text-align: right;
  padding-right: 2px;
}

.calendar-weekday-labels span {
  height: 12px;
  line-height: 12px;
  overflow: hidden;
}

.calendar-grid {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: 12px;
  grid-template-rows: repeat(7, 12px);
  gap: 2px;
  max-width: calc(100% - 28px);
  overflow: hidden;
}

.calendar-day {
  width: 12px;
  height: 12px;
  min-width: 12px;
  min-height: 12px;
  border-radius: 2px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  background: var(--heat-0);
  transition: transform var(--transition-fast);
  flex-shrink: 0;
}

.calendar-day.level-1 { background: var(--heat-1); }
.calendar-day.level-2 { background: var(--heat-2); }
.calendar-day.level-3 { background: var(--heat-3); }
.calendar-day.level-4 { background: var(--heat-4); }

.calendar-day:hover {
  transform: translateY(-1px);
}

.aggregate-heatmap-insight {
  margin-top: var(--spacing-sm);
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.3;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.aggregate-heatmap-legend {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: var(--spacing-sm);
  font-size: 0.65rem;
  color: var(--text-muted);
  justify-content: flex-end;
  flex-wrap: wrap;
  max-width: 100%;
  overflow: hidden;
}

.aggregate-heatmap-legend .legend-dot {
  width: 10px;
  height: 10px;
  min-width: 10px;
  min-height: 10px;
  border-radius: 2px;
  border: 1px solid rgba(0,0,0,0.04);
  flex-shrink: 0;
}

.aggregate-heatmap-legend .legend-dot.level-0 { background: var(--heat-0); }
.aggregate-heatmap-legend .legend-dot.level-1 { background: var(--heat-1); }
.aggregate-heatmap-legend .legend-dot.level-2 { background: var(--heat-2); }
.aggregate-heatmap-legend .legend-dot.level-3 { background: var(--heat-3); }
.aggregate-heatmap-legend .legend-dot.level-4 { background: var(--heat-4); }

/* Sidebar-specific heatmap styles */
.sidebar .aggregate-heatmap {
  max-width: 100%;
  overflow: hidden;
}

.sidebar .calendar-heatmap-header {
  grid-template-columns: 20px 1fr;
  gap: 2px;
}

.sidebar .calendar-months {
  grid-auto-columns: 10px;
  column-gap: 1px;
  max-width: calc(100% - 22px);
}

.sidebar .calendar-month-label {
  font-size: 0.5rem;
  letter-spacing: 0.2px;
}

.sidebar .calendar-heatmap-body {
  grid-template-columns: 20px 1fr;
  gap: 2px;
}

.sidebar .calendar-weekday-labels {
  grid-template-rows: repeat(7, 10px);
  gap: 1px;
  font-size: 0.45rem;
}

.sidebar .calendar-weekday-labels span {
  height: 10px;
  line-height: 10px;
}

.sidebar .calendar-grid {
  grid-auto-columns: 10px;
  grid-template-rows: repeat(7, 10px);
  gap: 1px;
  max-width: calc(100% - 22px);
}

.sidebar .calendar-day {
  width: 10px;
  height: 10px;
  min-width: 10px;
  min-height: 10px;
  border-radius: 1px;
}

.sidebar .aggregate-heatmap-insight {
  font-size: 0.65rem;
  line-height: 1.2;
}

.sidebar .aggregate-heatmap-legend {
  font-size: 0.55rem;
  gap: 3px;
}

.sidebar .aggregate-heatmap-legend .legend-dot {
  width: 8px;
  height: 8px;
  min-width: 8px;
  min-height: 8px;
}

/* Main content heatmap (analytics section) adjustments */
#aggregateHeatmap .aggregate-heatmap {
  max-width: 100%;
}

#aggregateHeatmap .calendar-heatmap {
  max-width: 100%;
}

#aggregateHeatmap .calendar-grid {
  max-width: calc(100% - 30px);
}

/* RESPONSIVE: Heatmap adjustments for mobile */
@media (max-width: 768px) {
  .calendar-heatmap-header {
    grid-template-columns: 20px 1fr;
  }
  
  .calendar-months {
    grid-auto-columns: 10px;
    max-width: calc(100% - 22px);
  }
  
  .calendar-month-label {
    font-size: 0.55rem;
  }
  
  .calendar-heatmap-body {
    grid-template-columns: 20px 1fr;
  }
  
  .calendar-weekday-labels {
    font-size: 0.5rem;
  }
  
  .calendar-grid {
    grid-auto-columns: 10px;
    grid-template-rows: repeat(7, 10px);
    max-width: calc(100% - 22px);
  }
  
  .calendar-day {
    width: 10px;
    height: 10px;
  }
  
  .aggregate-heatmap-legend {
    font-size: 0.6rem;
  }
  
  .aggregate-heatmap-legend .legend-dot {
    width: 9px;
    height: 9px;
  }
}

/* Ensure heatmap doesn't overflow sidebar container */
.sidebar-stats:has(#aggregateHeatmapSidebar) {
  overflow: hidden;
  max-width: 100%;
}

#aggregateHeatmapSidebar {
  max-width: 100%;
  overflow: hidden;
}

/* RESPONSIVE: Empty state adjustments */
@media (max-width: 768px) {
  .empty-state {
    padding: var(--spacing-xl);
  }
  
  .empty-state-icon {
    font-size: 3rem;
  }
  
  .empty-state-title {
    font-size: 1.25rem;
  }
  
  .empty-state-description {
    font-size: 0.875rem;
  }
}

/* ===== LOADING STATES ===== */
.loading {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 1.125rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.loading::after {
  content: '';
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== RESPONSIVE MEDIA QUERIES ===== */

/* Tablet and below (1020px) */
@media (max-width: 1020px) {
  .quick-stats {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .controls-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .dashboard-header {
    margin-top: var(--spacing-md);
  }
}

/* Tablet (768px) */
@media (max-width: 768px) {
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }
  
  .forms-section,
  .content-section {
    grid-column: span 1;
  }
  
  .students-card .content-body {
    grid-template-columns: 1fr;
  }
  
  .controls-bar {
    padding: var(--spacing-md);
  }
  
  .assignment-grid {
    grid-template-columns: 1fr;
  }
  
  .mobile-header {
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  .mobile-title {
    font-size: 1.125rem;
  }
}

/* Small phones (480px) */
@media (max-width: 480px) {
  .quick-stats {
    grid-template-columns: 1fr;
  }
  
  .stat-card {
    flex-direction: row;
    text-align: left;
    gap: var(--spacing-md);
  }
  
  .btn {
    width: 100%;
  }
  
  .content-header {
    flex-direction: column;
    gap: var(--spacing-md);
    align-items: flex-start;
  }
  
  .content-header h2 {
    margin-bottom: 0;
  }
  
  .toast {
    min-width: calc(100vw - 24px);
    max-width: calc(100vw - 24px);
  }
  
  .sidebar {
    width: 85%;
    max-width: 300px;
  }
  
  .sidebar-toggle {
    width: 44px;
    height: 44px;
    font-size: 1.2rem;
  }
  
  .sidebar.active ~ .sidebar-toggle {
    left: calc(85% - 22px);
  }
}

/* Very small phones (360px and below) */
@media (max-width: 360px) {
  html {
    font-size: 14px;
  }
  
  .stat-card {
    flex-direction: column;
    text-align: center;
    gap: var(--spacing-sm);
  }
  
  .student-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .class-code-display .code {
    font-size: 1.5rem;
    letter-spacing: 0.2rem;
  }
}

/* Landscape orientation adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .sidebar {
    padding: var(--spacing-lg);
  }
  
  .sidebar-header {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
  }
  
  .teacher-emoji {
    font-size: 2.5rem;
  }
  
  .sidebar h2 {
    font-size: 1.25rem;
  }
  
  .content-body {
    max-height: 250px;
  }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { 
  width: 8px; 
  height: 8px;
}

::-webkit-scrollbar-track { 
  background: var(--bg); 
  border-radius: 4px;
}

::-webkit-scrollbar-thumb { 
  background: var(--accent); 
  border-radius: 4px;
  border: 2px solid var(--bg);
}

::-webkit-scrollbar-thumb:hover { 
  background: var(--accent-dark); 
}

.footer {
  grid-column: span 12;
  text-align: center;
  padding: var(--spacing-xl);
  margin-top: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 0.875rem;
  border-top: 1px solid var(--border);
}

/* RESPONSIVE: Footer adjustments */
@media (max-width: 768px) {
  .footer {
    padding: var(--spacing-lg);
    margin-top: var(--spacing-xl);
  }
}

/* ===== TOUCH OPTIMIZATIONS ===== */
/* Disable hover effects on touch devices */
@media (hover: none) and (pointer: coarse) {
  .btn:hover,
  .btn-submit:hover,
  .nav-item:hover,
  .student-item:hover,
  .assignment-card:hover,
  .item:hover,
  .stat-card:hover {
    transform: none;
  }
  
  .btn:active,
  .btn-submit:active,
  .nav-item:active,
  .student-item:active,
  .assignment-card:active,
  .item:active,
  .stat-card:active {
    transform: scale(0.98);
  }
}

/* ===== SAFE AREA INSETS FOR NOTCHED PHONES ===== */
@supports (padding: max(0px)) {
  .mobile-header {
    padding-left: max(var(--spacing-md), env(safe-area-inset-left));
    padding-right: max(var(--spacing-md), env(safe-area-inset-right));
    padding-top: max(var(--spacing-sm), env(safe-area-inset-top));
  }
  
  .main-content {
    padding-left: max(var(--spacing-md), env(safe-area-inset-left));
    padding-right: max(var(--spacing-md), env(safe-area-inset-right));
    padding-bottom: max(var(--spacing-md), env(safe-area-inset-bottom));
  }
  
  .sidebar {
    padding-top: max(var(--spacing-xl), env(safe-area-inset-top));
    padding-bottom: max(var(--spacing-xl), env(safe-area-inset-bottom));
  }
}

/* ===== PRINT STYLES ===== */
@media print {
  .sidebar,
  .mobile-header,
  .sidebar-toggle,
  .controls-bar,
  .btn,
  .delete-btn,
  .modal,
  .toast-container,
  .sync-status {
    display: none !important;
  }
  
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .main-content {
    padding: 0;
    max-width: none;
  }
  
  .content-body {
    max-height: none;
    overflow: visible;
  }
  
  body {
    background: white;
    color: black;
  }
  
  .card,
  .form-card,
  .content-card,
  .student-item,
  .item,
  .assignment-card {
    border: 1px solid #ddd;
    box-shadow: none;
    break-inside: avoid;
  }
}
/* ===== FLOATING FEEDBACK BUTTON ===== */
.feedback-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--gradient-info);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    padding: var(--spacing-md) var(--spacing-lg);
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-xl);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    transition: all var(--transition);
    animation: pulse 2s infinite;
}

.feedback-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-2xl);
    background: var(--gradient-info-dark);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

/* Add this to your CSS variables if needed */
:root {
    --gradient-info-dark: linear-gradient(135deg, #2563eb, #1d4ed8);
}

/* Mobile adjustments */
@media (max-width: 767px) {
    .feedback-btn {
        bottom: 70px;
        right: 15px;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.875rem;
    }
}

/* ==================== */
/* MOBILE RESPONSIVENESS */
/* ==================== */

/* 1. Base mobile adjustments */
@media (max-width: 768px) {
  /* Prevent zoom on iOS inputs */
  input, textarea, select, button {
    font-size: 16px !important;
  }
  
  /* Improve touch targets */
  .btn, .nav-item, .btn-submit, .delete-btn,
  .mobile-menu-btn, .sidebar-toggle, .modal-close {
    min-height: 44px !important;
    min-width: 44px !important;
  }
  
  /* Reduce base font size */
  html {
    font-size: 14px !important;
  }
}

/* 2. Hide search bar AND search icon on mobile */
@media (max-width: 768px) {
  /* Hide the search input */
  input[placeholder*="Search"],
  input[placeholder*="search"] {
    display: none !important;
  }
  
  /* Hide the search icon (ğŸ”) */
  .controls-bar span:contains("ğŸ”"),
  .controls-bar > div > span:first-child,
  .controls-bar > div:has(> span:first-child) {
    display: none !important;
  }
  
  /* Hide the entire search bar container */
  .controls-bar > div:first-child {
    display: none !important;
  }
  
  /* Hide the button group in controls-bar */
  .controls-bar > div:last-child:has(.btn) {
    display: none !important;
  }
  
  /* Make controls bar compact */
  .controls-bar {
    display: none !important; /* Hide entire controls bar on mobile */
  }
}

/* 3. Hide the "Use the search bar" pro tip on mobile */
@media (max-width: 768px) {
  /* Target the pro tip that mentions "search bar" */
  .pro-tip:has(strong:contains("Pro Tip")):has(:contains("search bar")),
  .pro-tip:has(:contains("Use the search bar")),
  .pro-tip:has(:contains("search bar to quickly find")),
  .dashboard-header .pro-tip:last-child {
    display: none !important;
  }
  
  /* Alternative: Hide pro tips in dashboard-header after controls bar */
  .dashboard-header > .pro-tip {
    display: none !important;
  }
}

/* 4. Hide desktop buttons but KEEP mobile header buttons */
@media (max-width: 768px) {
  /* Hide desktop refresh button */
  .controls-bar .btn:has(> :contains("ğŸ”„")),
  .controls-bar .btn[onclick*="refreshStudents"],
  .controls-bar .btn[onclick*="refresh"] {
    display: none !important;
  }
  
  /* Hide desktop home button */
  .controls-bar .btn[onclick*="index.html"],
  .controls-bar .btn[onclick*="window.location"],
  .controls-bar .btn:has(> :contains("ğŸ ")) {
    display: none !important;
  }
  
  /* Hide demo mode button */
  .btn[onclick*="toggleDemoMode"],
  .btn[style*="gradient-warning"],
  .btn:has(> :contains("Demo Mode")),
  .btn:has(> :contains("ğŸŒ")) {
    display: none !important;
  }
  
  /* KEEP mobile header buttons visible */
  .mobile-header .mobile-actions .btn-icon,
  .mobile-header .mobile-actions button {
    display: flex !important; /* Make sure mobile buttons show */
    visibility: visible !important;
  }
}

/* 5. Show mobile header properly with visible buttons */
@media (max-width: 1020px) {
  .mobile-header {
    display: flex !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 999 !important;
    background: var(--card) !important;
    border-bottom: 1px solid var(--border) !important;
    padding: 0.5rem 1rem !important;
    align-items: center !important;
    justify-content: space-between !important;
    height: 60px !important;
    box-shadow: var(--shadow) !important;
    backdrop-filter: blur(10px) !important;
  }
  
  /* Ensure mobile header buttons are visible */
  .mobile-actions {
    display: flex !important;
    gap: 0.5rem !important;
    align-items: center !important;
    visibility: visible !important;
  }
  
  .mobile-actions .btn-icon {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    background: var(--card) !important;
    border: 1px solid var(--border) !important;
    color: var(--text) !important;
    font-size: 1.2rem !important;
  }
  
  .mobile-actions .btn-primary {
    background: var(--gradient-primary) !important;
    border-color: transparent !important;
    color: white !important;
  }
  
  .mobile-actions .btn-secondary:hover {
    background: var(--accent-light) !important;
    border-color: var(--accent) !important;
  }
  
  .mobile-title {
    font-size: 1.1rem !important;
    font-weight: 700 !important;
    color: var(--text) !important;
    text-align: center !important;
    flex: 1 !important;
    margin: 0 1rem !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  /* Adjust main content to account for mobile header */
  .main-content {
    padding-top: 70px !important;
  }
  
  /* Adjust app layout */
  .app-layout {
    padding-top: 0 !important;
  }
}

/* 6. Adjust layout for mobile */
@media (max-width: 768px) {
  /* Center and resize dashboard headers */
  .dashboard-header {
    margin-top: 1rem !important;
    text-align: center !important;
    margin-bottom: 1.5rem !important;
  }
  
  .dashboard-header h1 {
    font-size: 1.75rem !important;
    text-align: center !important;
    margin-top: 0 !important;
    margin-bottom: 0.5rem !important;
  }
  
  .dashboard-subtitle {
    font-size: 1rem !important;
    text-align: center !important;
    margin-bottom: 1.5rem !important;
    line-height: 1.5 !important;
    color: var(--text-muted) !important;
  }
  
  /* Make grid single column */
  .dashboard-grid {
    display: flex !important;
    flex-direction: column !important;
    gap: 1.5rem !important;
  }
  
  /* Quick stats responsive */
  .quick-stats {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 1rem !important;
    margin-bottom: 1.5rem !important;
  }
  
  /* Stack forms and content sections */
  .dashboard-grid > .dashboard-grid {
    flex-direction: column !important;
    gap: 1.5rem !important;
    margin-top: 0 !important;
  }
}

/* 7. Remove empty purple card */
@media (max-width: 768px) {
  /* Hide empty class code display */
  .class-code-display:has(.code:contains("------")),
  .class-code-display:has(.code:empty) {
    display: none !important;
  }
}

/* 8. Improve mobile forms and content */
@media (max-width: 768px) {
  .form-card,
  .content-card {
    padding: 1.25rem !important;
    border-radius: 1rem !important;
  }
  
  .form-card h2,
  .content-header h2 {
    font-size: 1.125rem !important;
    margin-bottom: 1rem !important;
  }
  
  .content-header {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 0.75rem !important;
    padding: 1.25rem !important;
  }
  
  .content-body {
    padding: 1.25rem !important;
    max-height: 350px !important;
  }
}

/* 9. Handle safe areas for notched phones */
@supports (padding: max(0px)) {
  @media (max-width: 768px) {
    .mobile-header {
      padding-top: max(0.5rem, env(safe-area-inset-top)) !important;
      padding-left: max(1rem, env(safe-area-inset-left)) !important;
      padding-right: max(1rem, env(safe-area-inset-right)) !important;
      height: calc(60px + env(safe-area-inset-top)) !important;
    }
    
    .main-content {
      padding-left: max(1rem, env(safe-area-inset-left)) !important;
      padding-right: max(1rem, env(safe-area-inset-right)) !important;
      padding-bottom: max(1rem, env(safe-area-inset-bottom)) !important;
    }
  }
}

/* 10. Disable hover effects on touch devices */
@media (hover: none) and (pointer: coarse) {
  .btn:hover,
  .btn-submit:hover,
  .nav-item:hover,
  .student-item:hover,
  .item:hover,
  .stat-card:hover {
    transform: none !important;
    box-shadow: none !important;
  }
  
  .btn:active {
    transform: scale(0.98) !important;
    opacity: 0.9 !important;
  }
}

/* 11. Adjust for very small screens */
@media (max-width: 480px) {
  .quick-stats {
    grid-template-columns: 1fr !important;
    gap: 0.75rem !important;
  }
  
  .stat-card {
    flex-direction: column !important;
    text-align: center !important;
    padding: 1rem !important;
    gap: 0.75rem !important;
  }
  
  .mobile-actions {
    gap: 0.25rem !important;
  }
  
  .mobile-actions .btn-icon {
    width: 36px !important;
    height: 36px !important;
    font-size: 1rem !important;
  }
}

/* 12. Fix mobile header for landscape */
@media (max-height: 500px) and (orientation: landscape) {
  .mobile-header {
    height: 50px !important;
    padding: 0.25rem 1rem !important;
  }
  
  .mobile-actions .btn-icon {
    width: 36px !important;
    height: 36px !important;
    font-size: 1rem !important;
  }
  
  .main-content {
    padding-top: 60px !important;
  }
}



/* 3. Hide the "Use the search bar" pro tip on mobile */
@media (max-width: 768px) {
  /* Target the pro tip that mentions "search bar" */
  .pro-tip:has(strong:contains("Pro Tip")):has(:contains("search bar")),
  .pro-tip:has(:contains("Use the search bar")),
  .pro-tip:has(:contains("search bar to quickly find")),
  .dashboard-header .pro-tip:last-child {
    display: none !important;
  }
  
  /* Alternative: Hide pro tips in dashboard-header after controls bar */
  .dashboard-header > .pro-tip {
    display: none !important;
  }
}




/* ===== STUDY STREAK CHAIN ===== */
.streak-chain-container {
    grid-column: span 12;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    padding: var(--spacing-xl);
    margin: var(--spacing-xl) 0;
    position: relative;
    overflow: hidden;
}

.streak-chain-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xl);
}

.streak-chain-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.streak-chain-count {
    background: var(--gradient-primary);
    color: white;
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: 2rem;
    font-weight: 700;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.streak-chain-wrapper {
    position: relative;
    min-height: 120px;
    overflow-x: auto;
    padding: var(--spacing-md) 0;
}

.streak-chain {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: nowrap;
    padding: var(--spacing-sm);
    min-width: min-content;
}

.chain-link {
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
    position: relative;
    transition: all var(--transition);
    animation: pulse-glow 2s infinite alternate;
}

@keyframes pulse-glow {
    0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
    100% { box-shadow: 0 0 0 5px rgba(79, 70, 229, 0); }
}

.chain-link.completed {
    background: var(--gradient-primary);
    color: white;
    border: 2px solid var(--accent);
    box-shadow: var(--shadow-md);
}

.chain-link.pending {
    background: var(--bg);
    border: 2px dashed var(--border);
    color: var(--text-muted);
}

.chain-link.active {
    background: var(--gradient-warning);
    color: white;
    border: 2px solid var(--warning);
    transform: scale(1.1);
    animation: none;
}

.chain-link::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%;
    width: 8px;
    height: 2px;
    background: var(--border);
    transform: translateY(-50%);
}

.chain-link:last-child::after {
    display: none;
}

.chain-link.completed::after {
    background: var(--accent);
}

.streak-chain-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border);
    font-size: 0.875rem;
    color: var(--text-muted);
}

.streak-chain-milestone {
    background: var(--accent-light);
    border-left: 4px solid var(--accent);
    padding: var(--spacing-md);
    border-radius: var(--radius);
    margin-top: var(--spacing-md);
    font-size: 0.875rem;
}

.streak-chain-milestone strong {
    color: var(--accent);
    display: block;
    margin-bottom: var(--spacing-xs);
}

.streak-chain-empty {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-muted);
}

.streak-chain-empty-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-md);
    opacity: 0.5;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .streak-chain-container {
        padding: var(--spacing-lg);
        margin: var(--spacing-lg) 0;
    }
    
    .chain-link {
        width: 32px;
        height: 32px;
        min-width: 32px;
        font-size: 0.75rem;
    }
    
    .streak-chain-count {
        font-size: 1rem;
        padding: var(--spacing-xs) var(--spacing-md);
    }
}

/* Animation for adding new links */
@keyframes chain-grow {
    0% { transform: scale(0); opacity: 0; }
    70% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
}

.chain-link.new-link {
    animation: chain-grow 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}


/* ===== FRIENDLY CLASS COMPETITION ===== */
.challenges-section {
    margin-top: var(--spacing-xl);
    border-top: 1px solid var(--border);
    padding-top: var(--spacing-xl);
}

.challenges-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    max-height: 300px;
    overflow-y: auto;
    margin-top: var(--spacing-md);
}

.challenge-item {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: var(--spacing-sm);
    transition: all var(--transition);
}

.challenge-item:hover {
    border-color: var(--accent);
    transform: translateX(3px);
}

.challenge-item.active {
    border-left: 4px solid var(--accent);
}

.challenge-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text);
    margin-bottom: 2px;
}

.challenge-details {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
}

.challenge-stats {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-xs);
}

.challenge-stat {
    flex: 1;
    text-align: center;
    padding: var(--spacing-xs);
    background: var(--card);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
}

.challenge-stat.winning {
    background: var(--gradient-success);
    color: white;
}

.challenge-stat.losing {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
}

.btn-challenge {
    width: 100%;
    margin-top: var(--spacing-md);
    background: var(--gradient-info);
    color: white;
    border: none;
    border-radius: var(--radius);
    padding: var(--spacing-sm);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
}

.btn-challenge:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Challenges Modal */
#challengeModal .modal-content {
    max-width: 500px;
}

.challenge-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.challenge-type-selector {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
}

.challenge-type-option {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: var(--spacing-md);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
}

.challenge-type-option:hover {
    border-color: var(--accent);
    background: var(--accent-light);
}

.challenge-type-option.selected {
    border-color: var(--accent);
    background: var(--gradient-primary);
    color: white;
}

.challenge-type-icon {
    font-size: 2rem;
    margin-bottom: var(--spacing-xs);
}

.challenge-type-label {
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 4px;
}

.challenge-type-desc {
    font-size: 0.75rem;
    opacity: 0.8;
}

.duration-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-sm);
}

.duration-option {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: var(--spacing-sm);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
}

.duration-option:hover {
    border-color: var(--accent);
}

.duration-option.selected {
    border-color: var(--accent);
    background: var(--accent-light);
}

.class-selector {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: var(--spacing-sm);
}

.class-option {
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition);
    margin-bottom: var(--spacing-xs);
}

.class-option:hover {
    background: var(--accent-light);
}

.class-option.selected {
    background: var(--gradient-primary);
    color: white;
}

/* Challenge Details Modal */
.challenge-details-container {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.challenge-header {
    text-align: center;
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border);
}

.challenge-metrics {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--spacing-lg);
    align-items: center;
}

.challenge-class {
    text-align: center;
}

.class-name {
    font-weight: 700;
    font-size: 1.125rem;
    margin-bottom: var(--spacing-xs);
}

.class-code {
    font-size: 0.75rem;
    color: var(--text-muted);
    background: var(--bg);
    padding: 2px 8px;
    border-radius: 1rem;
    display: inline-block;
}

.class-score {
    font-size: 2rem;
    font-weight: 800;
    margin: var(--spacing-sm) 0;
}

.class-score.winning {
    color: var(--success);
}

.class-score.losing {
    color: var(--danger);
}

.vs-label {
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--accent);
    text-align: center;
}

.challenge-progress {
    height: 8px;
    background: var(--bg);
    border-radius: 4px;
    overflow: hidden;
    margin: var(--spacing-md) 0;
}

.progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 0.5s ease;
}

.challenge-time {
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
}

.challenge-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-lg);
}

/* Challenges Dashboard Section */
.challenge-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
}

.challenge-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    transition: all var(--transition);
    position: relative;
}

.challenge-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
    border-color: var(--accent);
}

.challenge-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-md);
}

.challenge-card-type {
    background: var(--gradient-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.challenge-card-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: var(--spacing-xs);
}

.challenge-card-time {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: var(--spacing-md);
}

.challenge-card-progress {
    margin: var(--spacing-md) 0;
}

.challenge-card-stats {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--spacing-md);
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.challenge-card-class {
    text-align: center;
}

.challenge-card-score {
    font-size: 1.5rem;
    font-weight: 800;
    margin-top: var(--spacing-xs);
}

.challenge-card-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
}



/* Create Challenge Page Styles */
.challenge-type-option {
    cursor: pointer;
    padding: var(--spacing-lg);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    background: var(--card);
    transition: all var(--transition);
    text-align: center;
}

.challenge-type-option:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
    border-color: var(--accent);
}

.challenge-type-option.selected {
    border-color: var(--accent);
    background: var(--accent-light);
    box-shadow: var(--shadow);
}

.duration-option {
    cursor: pointer;
    padding: var(--spacing-md);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    transition: all var(--transition);
    text-align: center;
}

.duration-option:hover {
    border-color: var(--accent);
    transform: scale(1.05);
}

.duration-option.selected {
    border-color: var(--accent);
    background: var(--accent-light);
    box-shadow: var(--shadow-sm);
}

.form-step {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .challenge-type-selector {
        grid-template-columns: 1fr !important;
    }
    
    .duration-selector {
        flex-direction: column;
    }
    
    .duration-option {
        min-width: 100% !important;
    }
}






/* ===== CREATE CHALLENGE PAGE ===== */
.create-challenge-form {
    max-width: 700px;
    margin: 0 auto;
}

.form-step {
    animation: fadeIn 0.5s ease;
    min-height: 400px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.challenge-type-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
    margin: var(--spacing-xl) 0;
}

.challenge-type-option {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 200px;
}

.challenge-type-option:hover {
    border-color: var(--accent);
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.challenge-type-option.selected {
    border-color: var(--accent);
    background: linear-gradient(135deg, var(--accent-light), transparent);
}

.challenge-type-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-md);
}

.challenge-type-label {
    font-weight: 700;
    font-size: 1.25rem;
    margin-bottom: var(--spacing-sm);
    color: var(--text);
}

.challenge-type-desc {
    font-size: 0.875rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: var(--spacing-md);
}

.duration-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
    margin: var(--spacing-xl) 0;
}

.duration-option {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: var(--spacing-lg);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
}

.duration-option:hover {
    border-color: var(--accent);
    transform: scale(1.05);
}

.duration-option.selected {
    border-color: var(--accent);
    background: var(--accent-light);
}

.duration-number {
    font-size: 2rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: var(--spacing-xs);
}

.duration-label {
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: var(--spacing-xs);
}

.duration-subtext {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.challenge-preview {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    margin: var(--spacing-xl) 0;
    position: relative;
    overflow: hidden;
}

.challenge-preview::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--border);
}

.step-indicator {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border);
    transition: all var(--transition);
}

.step-dot.active {
    background: var(--accent);
    transform: scale(1.2);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .challenge-type-selector {
        grid-template-columns: 1fr;
    }
    
    .duration-selector {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
    }
    
    .challenge-type-option {
        min-height: 180px;
        padding: var(--spacing-lg);
    }
}

/* Notifications */
.notification-item {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all var(--transition);
}

.notification-item:hover {
    background: var(--accent-light);
}

.notification-item.unread {
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid var(--info);
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-xs);
}

.notification-title {
    font-weight: 600;
    color: var(--text);
}

.notification-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.notification-content {
    font-size: 0.875rem;
    color: var(--text);
    line-height: 1.5;
}

.notification-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
}

/* Notification bell in header */
.notification-bell {
    position: relative;
}

.notification-bell .badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}





/* ===== ENHANCED CONFETTI STYLES ===== */
#confettiCanvas {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    pointer-events: none !important;
    z-index: 9999 !important;
    display: none !important;
    background: transparent !important;
}

/* Celebration animation for winning cards */
.challenge-card.winning {
    animation: celebration-pulse 2s infinite;
    border-color: var(--success) !important;
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.5) !important;
}

@keyframes celebration-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Celebration badge */
.celebration-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: var(--gradient-warning);
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    animation: bounce 1s infinite;
    z-index: 1;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
</style>
</head>
<body>

<!-- Mobile Header -->
<div class="mobile-header" style="display: none;">
  <button class="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
  <div class="mobile-title" id="mobileTitle">Teacher Dashboard</div>
  <div class="mobile-actions">
    <button class="btn-icon btn-secondary" onclick="refreshStudents()" title="Refresh">ğŸ”„</button>
    <button class="btn-icon btn-primary" onclick="window.location.href='index.html'" title="Home">ğŸ </button>
    <!-- Add to mobile header -->
<button class="btn-icon btn-secondary notification-bell" onclick="showNotifications()" style="position: relative;">
    ğŸ””
    <span id="notificationCount" class="badge" style="display: none;">0</span>
</button>
  </div>
</div>

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar">â†</button>

<!-- Login Modal -->
<div id="loginModal" class="modal" style="display: flex;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Welcome to Teacher Dashboard</h3>
      <p>Please sign in to access your classes</p>
    </div>
    <div class="login-form">
      <div class="form-group">
        <label for="teacherEmail">Email</label>
        <input type="email" id="teacherEmail" placeholder="teacher@example.com" value="teacher@example.com">
      </div>
      <div class="form-group">
        <label for="teacherPassword">Password</label>
        <input type="password" id="teacherPassword" placeholder="Enter password" value="teacher123">
      </div>
      <div class="auth-actions">
        <button class="btn btn-primary" onclick="loginTeacher()" id="loginBtn">Sign In</button>
        <button class="btn btn-secondary" onclick="useDemoMode()" id="demoBtn">Use Demo Mode</button>
      </div>
      <p style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
        Demo credentials: teacher@example.com / teacher123<br>
        <strong>Note:</strong> Firebase Authentication might not be set up. Use Demo Mode.
      </p>
    </div>
  </div>
</div>

<div class="app-layout" style="display: none;">
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="teacher-emoji">ğŸ‘©â€ğŸ«</div>
      <h2>Teacher Dashboard</h2>
      <p class="sidebar-subtitle">Manage Your Classroom</p>
    </div>
 
    <!-- Class Switcher -->
    <div class="class-switcher">
      <select id="classSelector" onchange="switchClass(this.value)">
        <option value="">Select a Class</option>
      </select>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showSection('dashboard'); closeSidebarOnMobile();">
        ğŸ“Š Dashboard
      </div>
      
 
      <div class="nav-item" onclick="showSection('announcements'); closeSidebarOnMobile();">
        ğŸ“¢ Announcements
      </div>
      <div class="nav-item" onclick="showSection('assignments'); closeSidebarOnMobile();">
        ğŸ“š Assignments
      </div>
      <div class="nav-item" onclick="showSection('resources'); closeSidebarOnMobile();">
        ğŸ“ Resources
      </div>
      <div class="nav-item" onclick="showSection('polls'); closeSidebarOnMobile();">
        ğŸ—³ï¸ Polls
      </div>
      <div class="nav-item" onclick="showSection('students'); closeSidebarOnMobile();">
        ğŸ‘¥ Students
      </div>
      <div class="nav-item" onclick="showSection('analytics'); closeSidebarOnMobile();">
        ğŸ“ˆ Analytics
      </div>
      <div class="nav-item" onclick="showSection('settings'); closeSidebarOnMobile();">
        âš™ï¸ Settings
      </div>
     
    </nav>
    
    <div class="sidebar-stats">
      <h3>Class Stats</h3>
      <div class="stat-row">
        <span>Total Students</span>
        <span class="stat-value" id="sidebarStudents">0</span>
      </div>
      <div class="stat-row">
        <span>Assignments</span>
        <span class="stat-value" id="sidebarAssignments">0</span>
      </div>
      <div class="stat-row">
        <span>Announcements</span>
        <span class="stat-value" id="sidebarAnnouncements">0</span>
      </div>
      <div class="stat-row">
        <span>Avg Streak</span>
        <span class="stat-value" id="sidebarAvgStreak">0</span>
      </div>
    </div>




<!-- Friendly Class Competition -->
<div class="challenges-section">
    <h3 style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--spacing-md);">ğŸ† Class Challenges</h3>
    
    <div class="challenges-list" id="challengesList">
        <!-- Challenges will appear here -->
    </div>
    
    <div class="challenge-stats" id="challengeStats" style="margin-top: var(--spacing-md); font-size: 0.75rem; color: var(--text-muted);">
        <div style="display: flex; justify-content: space-between;">
            <span>Wins: <strong id="challengeWins">0</strong></span>
            <span>Active: <strong id="activeChallenges">0</strong></span>
            <span>Total: <strong id="totalChallenges">0</strong></span>
        </div>
    </div>
    
    <button class="btn-challenge" onclick="showCreateChallengeModal()">
        âš”ï¸ New Challenge
    </button>
    
    <div class="nav-item" onclick="showSection('challenges'); closeSidebarOnMobile();" style="margin-top: var(--spacing-md);">
        ğŸ“Š View All Challenges
    </div>
</div>



    <div class="sidebar-stats" style="margin-top: var(--spacing-lg);">
      <h3>Engagement Heatmap</h3>
      <div id="aggregateHeatmapSidebar" class="aggregate-heatmap"></div>
      <div id="aggregateInsightSidebar" class="aggregate-heatmap-insight" style="margin-top: var(--spacing-sm);"></div>
    </div>
    
    <div class="pro-tip">
      <strong>ğŸ’¡ Pro Tip</strong>
      Share your class code with students to allow them to join. Students can view announcements, assignments, and submit their study progress.
    </div>
    
    <div class="pro-tip" id="celebrationProTip" style="display: none;">
      <strong>ğŸ‰ Celebration Pro Tip</strong>
      Class milestones celebrate automatically with confetti, a live activity update, and a celebratory announcement. You can fine-tune the thresholds in Settings.
    </div>
    
    <div style="margin-top: var(--spacing-xl);">
      <select class="theme-selector" onchange="changeTheme(this.value)" style="width: 100%; padding: 0.875rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text);">
        <option value="light">â˜€ï¸ Light Theme</option>
        <option value="dark">ğŸŒ™ Dark Theme</option>
        <option value="ocean">ğŸŒŠ Ocean Theme</option>
        <option value="forest">ğŸŒ² Forest Theme</option>
        <option value="sunset">ğŸŒ… Sunset Theme</option>
        <option value="purple">ğŸ’œ Purple Theme</option>
      </select>
    </div>
    
    <button class="logout-btn" onclick="logoutTeacher()" style="width: 100%; padding: 0.75rem; margin-top: var(--spacing-lg); background: var(--danger); color: white; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: all var(--transition); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
      ğŸ‘‹ Logout
    </button>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Dashboard Header -->
    <div class="dashboard-header" id="dashboardHeader">
      <h1>Welcome to Your Classroom</h1>
      <p class="dashboard-subtitle" id="dashboardSubtitle">Manage announcements, assignments, and track student progress</p>
      
      <div class="controls-bar">
        <div class="search-bar" style="position: relative; flex: 1; max-width: 400px;">
          <input type="text" id="studentSearch" placeholder="Search students by id ....." oninput="searchStudents()" style="width: 100%; padding: 0.875rem 1rem 0.875rem 3rem; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.9375rem;">
          <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none;">ğŸ”</span>
        </div>
        <div style="display: flex; gap: var(--spacing-sm);">
          <button class="btn btn-primary" onclick="refreshStudents()">ğŸ”„ Refresh</button>
          <button class="btn btn-primary" onclick="window.location.href='index.html'">
    Home
</button>
<!-- Or add to desktop controls bar -->
<button class="btn btn-secondary notification-bell" onclick="showNotifications()" style="position: relative;">
    ğŸ”” Notifications
    <span id="notificationCountDesktop" class="badge" style="display: none;">0</span>
</button>
          <button class="btn btn-warning" onclick="toggleDemoMode()" id="demoModeBtn" style="background: var(--gradient-warning);">ğŸŒ Demo Mode: ON</button>
        </div>
      </div>
      
      <div class="pro-tip">
        <strong>ğŸ’¡ Pro Tip</strong>
        Use the search bar to quickly find specific students. Click on any student to view their detailed progress and study habits.
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Sync Status -->
    <div id="syncStatus" class="sync-status"></div>
    
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      
      <!-- Dashboard Section -->
      <div id="dashboard" class="dashboard-content" style="grid-column: span 12; display: block;">

        
        <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-content">
              <div class="stat-number" id="studentsCount">0</div>
              <div class="stat-label">Total Students</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“¢</div>
            <div class="stat-content">
              <div class="stat-number" id="announcementsCount">0</div>
              <div class="stat-label">Announcements</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“š</div>
            <div class="stat-content">
              <div class="stat-number" id="assignmentsCount">0</div>
              <div class="stat-label">Assignments</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ”¥</div>
            <div class="stat-content">
              <div class="stat-number" id="avgStreak">0</div>
              <div class="stat-label">Avg Streak</div>
            </div>
          </div>
        </div>
        
        <div class="pro-tip">
          <strong>ğŸ“Š Quick Stats Guide</strong>
          Monitor your class health at a glance: Total students shows enrollment, announcements track communication, assignments measure workload, and average streak indicates student engagement consistency.
        </div>
        
        <!-- Main Content Area -->
        <div class="dashboard-grid" style="margin-top: var(--spacing-xl);">
          
          <!-- Left Column: Forms -->
          <div class="forms-section">
            <!-- Class Code Display -->
            <div class="form-card class-code-display">
              <h2 style="color: white;">ğŸ« Class Code</h2>
              <div class="code" id="currentClassCodeDisplay">------</div>
              <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                <button class="btn btn-secondary" onclick="copyClassCode()" style="flex: 1; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white;">ğŸ“‹ Copy</button>
                <button class="btn btn-danger" onclick="showDeleteClassModal()" style="flex: 1; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white;">ğŸ—‘ï¸ Delete</button>
              </div>
            </div>
            
            <div class="pro-tip">
              <strong>ğŸ”‘ Class Code Management</strong>
              Share this 6-digit code with students so they can join your class. Click "Copy" to easily share via email or messaging apps. Delete classes only when you're sure - this action is permanent!
            </div>
           
            <!-- New Announcement Form -->
            <div class="form-card">
              <h2>ğŸ“¢ New Announcement</h2>
              <div class="form-group">
                <label for="announcementTitle">Title</label>
                <input type="text" id="announcementTitle" placeholder="Announcement title...">
              </div>
              <div class="form-group">
                <label for="announcementContent">Content</label>
                <textarea id="announcementContent" placeholder="Write your announcement..."></textarea>
              </div>
              <button class="btn-submit" onclick="addAnnouncement()">ğŸ“¤ Post Announcement</button>
            </div>
            
            <div class="pro-tip">
              <strong>ğŸ“¢ Announcement Tips</strong>
              Keep announcements clear and concise. Use them for important updates, deadline reminders, or weekly summaries. Students receive these in real-time on their dashboard.
            </div>
            
            <!-- New Assignment Form -->
            <div class="form-card">
              <h2>ğŸ“š New Assignment</h2>
              <div class="form-group">
                <label for="assignmentTitle">Title</label>
                <input type="text" id="assignmentTitle" placeholder="Assignment title...">
              </div>
              <div class="form-group">
                <label for="assignmentDescription">Description</label>
                <textarea id="assignmentDescription" placeholder="Assignment details..."></textarea>
              </div>
              <div class="form-group">
                <label for="assignmentDueDate">Due Date</label>
                <input type="date" id="assignmentDueDate">
              </div>
              <button class="btn-submit" onclick="addAssignment()">â• Add Assignment</button>
            </div>
            
            <div class="pro-tip">
              <strong>ğŸ“š Assignment Best Practices</strong>
              Be specific with descriptions and clear about expectations. Set realistic due dates and consider breaking larger projects into smaller tasks. Students can track their progress against these assignments.
            </div>
          </div>
          
          <!-- Right Column: Content -->
          <div class="content-section">
            <!-- Students Card -->
            <div class="content-card" id="studentsCard">
              <div class="content-header">
                <h2>ğŸ‘¥ Students</h2>
                <button class="btn btn-primary" onclick="showSection('students'); closeSidebarOnMobile();">View All</button>
              </div>
              <div class="content-body">
                <div class="students-card .content-body" id="studentsList">
                  <!-- Students will appear here -->
                </div>
              </div>
            </div>
            
            <div class="pro-tip">
              <strong>ğŸ‘¥ Student Monitoring</strong>
              Each student card shows their study streak (ğŸ”¥), total hours studied, points earned, and last active time. Points are automatically calculated based on study time and consistency. Monitor streaks to identify engagement patterns.
            </div>
            
            <!-- Recent Announcements Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>ğŸ“¢ Recent Announcements</h2>
                <button class="btn btn-primary" onclick="showSection('announcements'); closeSidebarOnMobile();">View All</button>
              </div>
              <div class="content-body">
                <div class="items-list" id="announcementsList">
                  <!-- Announcements will appear here -->
                </div>
              </div>
            </div>
            
            <!-- Recent Assignments Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>ğŸ“š Recent Assignments</h2>
                <button class="btn btn-primary" onclick="showSection('assignments'); closeSidebarOnMobile();">View All</button>
              </div>
          <div class="content-body">
                <div class="items-list" id="assignmentsList">
                  <!-- Assignments will appear here -->
                </div>
              </div>
            </div>

            <!-- Live Activity Feed -->
            <div class="content-card">
              <div class="content-header">
                <h2>ğŸŸ¢ Live Activity</h2>
                <button class="btn btn-secondary" onclick="getLiveActivity(currentClassCode)">Refresh</button>
              </div>
              <div class="content-body">
                <div class="activity-list" id="activityFeed">
                  <!-- Live activity will appear here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Study Streak Chain -->
<div class="streak-chain-container">
    <div class="streak-chain-header">
        <h2>ğŸ† Class Streak Chain</h2>
        <div class="streak-chain-count" id="chainCount">
            <span>ğŸ”¥</span>
            <span id="totalChainLinks">0</span> links
        </div>
    </div>
    <div class="streak-chain-wrapper">
        <div class="streak-chain" id="streakChain">
            <!-- Chain links will be dynamically generated here -->
        </div>
    </div>
    <div class="streak-chain-info">
        <span>Each link = 1 day of combined student streaks</span>
        <span id="chainProgress">Current progress: 0%</span>
    </div>
    <div class="streak-chain-milestone" id="chainMilestone">
        <strong>ğŸ¯ Next Milestone</strong>
        <span id="milestoneText">Reach 10 links to unlock a class celebration!</span>
    </div>
</div>


         <div class="footer">
          <p>Â© 2024 Student Learning Dashboard. All rights reserved. Made with â¤ï¸ for students everywhere.</p>
          <p style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7;">
            Education is the most powerful weapon which you can use to change the world. â€” Nelson Mandela
          </p>
        </div>
      </div>
      </div>
     
      <!-- Announcements Section -->
      <div id="announcements" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ğŸ“¢ All Announcements</h2>
            <button class="btn btn-primary" onclick="showCreateAnnouncementModal()">+ New Announcement</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ğŸ“¢ Announcement Management</strong>
              Delete outdated announcements to keep the list manageable. Consider archiving important announcements by saving them as resources. Announcements are displayed to students in chronological order (newest first).
            </div>
            <div id="allAnnouncementsList">
              <!-- All announcements will appear here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Assignments Section -->
      <div id="assignments" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ğŸ“š All Assignments</h2>
            <button class="btn btn-primary" onclick="showCreateAssignmentModal()">+ New Assignment</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ğŸ“š Assignment Strategy</strong>
              Space assignments evenly throughout the term. Use clear due dates and provide detailed descriptions. Students can mark assignments as completed on their end, helping them stay organized.
            </div>
            <div class="assignment-grid" id="allAssignmentsList">
              <!-- All assignments will appear here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Resources Section -->
      <div id="resources" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ğŸ“ Learning Resources</h2>
            <button class="btn btn-primary" onclick="showCreateResourceModal()">+ New Resource</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ğŸ“ Resource Curation</strong>
              Share links to helpful websites, PDFs, videos, or tools. Organize resources by topic or week. Students appreciate having all materials in one accessible location.
            </div>
            <div id="allResourcesList">
              <!-- All resources will appear here -->
              <div class="item">
                <div class="item-header">
                  <div class="item-title">Student Mode Guide</div>
                  <div class="item-date">Jan 27, 2026</div>
                </div>
                <div class="item-content">
                  <a href="https://mairakhancontact-sudo.github.io/studentmode-guide/" target="_blank" style="color: var(--accent); text-decoration: none; font-weight: 600;">
                    ğŸ“˜ Student Mode Guide (PNG Image)
                  </a>
                  <p style="margin-top:0.75rem; color: var(--text-muted);">
                    Complete guide for students on how to use Student Mode. Learn how to track study sessions, earn points, maintain streaks, and make the most of your learning dashboard.
                  </p>
                  <div style="margin-top: 1rem; padding: 1rem; background: var(--accent-light); border-radius: var(--radius);">
                    <h4 style="margin-bottom: 0.5rem; color: var(--accent);">ğŸ“– What's in the Student Mode Guide:</h4>
                    <ul style="margin-left: 1.5rem; line-height: 1.8;">
                      <li><strong>Getting Started:</strong> How to join classes and set up your profile</li>
                      <li><strong>Study Timer:</strong> Track study sessions and earn points</li>
                      <li><strong>Streak System:</strong> Maintain daily study habits</li>
                      <li><strong>Assignments:</strong> Track and complete coursework</li>
                      <li><strong>Announcements:</strong> Stay updated with class news</li>
                      <li><strong>Resources:</strong> Access learning materials</li>
                      <li><strong>Leaderboard:</strong> Friendly competition with classmates</li>
                      <li><strong>Analytics:</strong> Track your progress over time</li>
                    </ul>
                    <p style="margin-top: 0.75rem; font-size: 0.9rem;">
                      Click the link above to view/download the complete Student Mode Guide image file. This guide will help students maximize their learning experience.
                    </p>
                  </div>
                </div>
                <div class="item-actions">
                  <button class="delete-btn" onclick="deleteResource('student_mode_guide')">ğŸ—‘ï¸ Delete</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Polls Section -->
      <div id="polls" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ğŸ—³ï¸ Class Polls</h2>
            <button class="btn btn-primary" onclick="showCreatePollForm()">+ New Poll</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ğŸ—³ï¸ Quick Polls</strong>
              Use polls to check understanding, vote on class decisions, or collect quick feedback. Students can respond anonymously.
            </div>
            
            <div id="createPollForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <h3 style="margin-bottom: var(--spacing-md);">Create a Poll</h3>
              <div class="form-group">
                <label for="pollQuestion">Question</label>
                <input type="text" id="pollQuestion" placeholder="Type your poll question...">
              </div>
              <div class="form-group">
                <label>Options</label>
                <input type="text" id="pollOption1" placeholder="Option A" style="margin-bottom: var(--spacing-sm);">
                <input type="text" id="pollOption2" placeholder="Option B" style="margin-bottom: var(--spacing-sm);">
                <input type="text" id="pollOption3" placeholder="Option C (optional)">
              </div>
              <div style="display: flex; gap: var(--spacing-sm);">
                <button class="btn btn-secondary" onclick="hideCreatePollForm()" style="flex: 1;">Cancel</button>
                <button class="btn btn-success" onclick="addPoll()" style="flex: 1;">Share Poll with Students</button>
              </div>
            </div>
            
            <div id="pollsList">
              <!-- Polls will appear here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Students Section -->
      <div id="students" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ğŸ‘¥ All Students</h2>
            <button class="btn btn-primary" onclick="refreshStudents()">ğŸ”„ Refresh</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ğŸ‘¥ Student Engagement Tips</strong>
              Use the refresh button to get the latest student data. Students earn points based on study time and consistency. Streaks reset if a student misses a day. Consider recognizing students with the highest streaks or points to encourage healthy competition.
            </div>
            <div class="students-card .content-body" id="allStudentsList">
              <!-- All students will appear here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Analytics Section -->
      <div id="analytics" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ğŸ“ˆ Class Analytics</h2>
            <button class="btn btn-primary" onclick="exportAnalytics()">ğŸ“Š Export Data</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ğŸ“ˆ Data-Driven Teaching</strong>
              Use analytics to identify students who need extra support, track class-wide engagement trends, and measure the effectiveness of your teaching strategies. Export data for reports or parent meetings.
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-xl);">
              <div class="form-card">
                <h3>ğŸ“Š Student Performance</h3>
                <div style="height: 200px; display: flex; align-items: flex-end; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                  <div style="flex: 1; background: var(--gradient-primary); border-radius: var(--radius-sm);" id="streakBar1"></div>
                  <div style="flex: 1; background: var(--gradient-success); border-radius: var(--radius-sm);" id="streakBar2"></div>
                  <div style="flex: 1; background: var(--gradient-warning); border-radius: var(--radius-sm);" id="streakBar3"></div>
                  <div style="flex: 1; background: var(--gradient-info); border-radius: var(--radius-sm);" id="streakBar4"></div>
                  <div style="flex: 1; background: var(--gradient-danger); border-radius: var(--radius-sm);" id="streakBar5"></div>
                </div>
                <div style="margin-top: var(--spacing-md); font-size: 0.875rem; color: var(--text-muted);">
                  <div id="analyticsSummary">Loading analytics...</div>
                </div>
              </div>
              
              <div class="form-card">
                <h3>ğŸ“ˆ Engagement Metrics</h3>
                <div style="margin-top: var(--spacing-lg);">
                  <div style="margin-bottom: var(--spacing-md);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                      <span>Daily Active Students</span>
                      <span id="dailyActive">0%</span>
                    </div>
                    <div style="height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden;">
                      <div id="dailyActiveBar" style="height: 100%; background: var(--gradient-success); width: 0%;"></div>
                    </div>
                  </div>
                  <div style="margin-bottom: var(--spacing-md);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                      <span>Assignment Completion</span>
                      <span id="assignmentCompletion">0%</span>
                    </div>
                    <div style="height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden;">
                      <div id="assignmentCompletionBar" style="height: 100%; background: var(--gradient-primary); width: 0%;"></div>
                    </div>
                  </div>
                  <div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                      <span>Avg Study Hours</span>
                      <span id="avgStudyHours">0h</span>
                    </div>
                    <div style="height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden;">
                      <div id="avgStudyHoursBar" style="height: 100%; background: var(--gradient-warning); width: 0%;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-card" style="margin-top: var(--spacing-xl);">
              <h3>ğŸ“‹ Top Performers</h3>
              <div class="pro-tip" style="margin-bottom: var(--spacing-md);">
                <strong>ğŸ† Recognition Strategy</strong>
                Consider recognizing top performers to motivate the entire class. You can export this data for certificates, announcements, or parent communications.
              </div>
              <div id="topPerformers" style="margin-top: var(--spacing-lg);">
                <!-- Top performers will appear here -->
              </div>
            </div>
<!-- 
            <div class="form-card" style="margin-top: var(--spacing-xl);">
              <h3>ğŸ“Š Engagement Heatmap</h3>
              <div class="pro-tip" style="margin-bottom: var(--spacing-md);">
                <strong>ğŸ”’ Aggregate Only</strong>
                Shows when the class studies most (no individual data).
              </div>
              <div id="aggregateHeatmap" class="aggregate-heatmap"></div>
              <div id="aggregateInsight" class="aggregate-heatmap-insight"></div>
            </div> -->
          </div>
        </div>
      </div>
      

      <!-- Challenges Section -->
<div id="challenges" class="dashboard-content" style="grid-column: span 12; display: none;">
    <div class="content-card">
        <div class="content-header">
            <h2>âš”ï¸ Class Challenges</h2>
            <button class="btn-challenge" onclick="showCreateChallengeModal()">
        âš”ï¸ New Challenge
    </button>
        </div>
        <div class="content-body">
            <div class="pro-tip">
                <strong>âš”ï¸ Friendly Competition</strong>
                Challenge other teachers' classes to compete in study hours or streak counts. Track progress in real-time and celebrate winners with class celebrations!
            </div>
            
            <div id="challengesFilter" style="margin: var(--spacing-lg) 0; display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="filterChallenges('all')" id="filterAll">All</button>
                <button class="btn btn-secondary" onclick="filterChallenges('active')" id="filterActive">Active</button>
                <button class="btn btn-secondary" onclick="filterChallenges('pending')" id="filterPending">Pending</button>
                <button class="btn btn-secondary" onclick="filterChallenges('completed')" id="filterCompleted">Completed</button>
                <button class="btn btn-secondary" onclick="filterChallenges('won')" id="filterWon">Won</button>
                <button class="btn btn-secondary" onclick="filterChallenges('lost')" id="filterLost">Lost</button>
            </div>
            
            <div class="challenge-cards" id="allChallengesList">
                <!-- All challenges will appear here -->
            </div>
        </div>
    </div>
    
</div>


<!-- Create Challenge Section -->
<div id="create-challenge" class="dashboard-content" style="grid-column: span 12; display: none;">
    <div class="content-card">
        <div class="content-header">
            <h2>âš”ï¸ Create New Challenge</h2>
            <button class="btn btn-secondary" onclick="showSection('challenges')">
                â† Back to Challenges
            </button>
        </div>
        
        <div class="content-body">
            <div class="pro-tip">
                <strong>ğŸ† Friendly Competition</strong>
                Challenge another teacher's class! Choose between study hours or streak count competitions. The other teacher will receive a notification to accept.
            </div>
            
            <div class="create-challenge-form">
                <!-- Step 1: Challenge Type -->
                <div class="form-step active" id="step1">
                    <h3 style="margin-bottom: var(--spacing-lg); color: var(--accent);">Step 1: Choose Your Competition</h3>
                    <p style="color: var(--text-muted); margin-bottom: var(--spacing-xl);">
                        What would you like to compete on? Each student's progress counts!
                    </p>
                    
                    <div class="challenge-type-selector">
                        <div class="challenge-type-option" onclick="selectChallengeType('total_study_hours')" id="typeStudyHours">
                            <div class="challenge-type-icon">â±ï¸</div>
                            <div class="challenge-type-label">Total Study Hours</div>
                            <div class="challenge-type-desc">
                                Add up all hours studied by every student in the class. Perfect for encouraging consistent study habits.
                            </div>
                            <div style="margin-top: auto; font-size: 0.875rem; color: var(--success); font-weight: 600;">
                                Most Popular
                            </div>
                        </div>
                        
                        <div class="challenge-type-option" onclick="selectChallengeType('streak_count')" id="typeStreakCount">
                            <div class="challenge-type-icon">ğŸ”¥</div>
                            <div class="challenge-type-label">Average Streak</div>
                            <div class="challenge-type-desc">
                                Compete on the average streak days across all students. Great for building daily consistency.
                            </div>
                            <div style="margin-top: auto; font-size: 0.875rem; color: var(--warning); font-weight: 600;">
                                Consistency Challenge
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <div class="step-indicator">
                            <div class="step-dot active"></div>
                            <div class="step-dot"></div>
                            <div class="step-dot"></div>
                            <div style="margin-left: var(--spacing-sm); font-size: 0.875rem; color: var(--text-muted);">
                                Step 1 of 3
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="goToStep(2)">
                            Next: Set Duration â†’
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Duration & Details -->
                <div class="form-step" id="step2" style="display: none;">
                    <h3 style="margin-bottom: var(--spacing-lg); color: var(--accent);">Step 2: Set Duration & Name</h3>
                    <p style="color: var(--text-muted); margin-bottom: var(--spacing-xl);">
                        How long should the challenge run? Give it a fun name!
                    </p>
                    
                    <div style="margin-bottom: var(--spacing-xl);">
                        <label style="display: block; margin-bottom: var(--spacing-md); font-weight: 600; color: var(--text);">
                            Challenge Duration
                        </label>
                        <div class="duration-selector">
                            <div class="duration-option" onclick="selectDuration(1)" id="duration1">
                                <div class="duration-number">1</div>
                                <div class="duration-label">Day</div>
                                <div class="duration-subtext">Quick competition</div>
                            </div>
                            <div class="duration-option" onclick="selectDuration(3)" id="duration3">
                                <div class="duration-number">3</div>
                                <div class="duration-label">Days</div>
                                <div class="duration-subtext">Weekend challenge</div>
                            </div>
                            <div class="duration-option" onclick="selectDuration(7)" id="duration7">
                                <div class="duration-number">7</div>
                                <div class="duration-label">Week</div>
                                <div class="duration-subtext">Full week battle</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--spacing-xl);">
                        <label for="challengeName" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Challenge Name
                        </label>
                        <input type="text" id="challengeName" 
                               placeholder="e.g., 'Math vs Science Showdown' or 'Weekend Study Marathon'" 
                               style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-size: 1rem;">
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Make it fun! Students will see this name.
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="goToStep(1)">
                            â† Back
                        </button>
                        <div class="step-indicator">
                            <div class="step-dot"></div>
                            <div class="step-dot active"></div>
                            <div class="step-dot"></div>
                            <div style="margin-left: var(--spacing-sm); font-size: 0.875rem; color: var(--text-muted);">
                                Step 2 of 3
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="goToStep(3)">
                            Next: Add Opponent â†’
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Opponent & Message -->
                <div class="form-step" id="step3" style="display: none;">
                    <h3 style="margin-bottom: var(--spacing-lg); color: var(--accent);">Step 3: Choose Opponent</h3>
                    <p style="color: var(--text-muted); margin-bottom: var(--spacing-xl);">
                        Who are you challenging? Add a friendly message!
                    </p>
                    
                    <div style="margin-bottom: var(--spacing-xl);">
                        <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Opponent's Class Code
                        </label>
                        <input type="text" id="otherClassCode" 
                               placeholder="Enter 6-digit code (e.g., ABC123)" 
                               maxlength="6"
                               style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; font-size: 1.5rem; letter-spacing: 3px; text-align: center;">
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Ask the other teacher for their class code from their Teacher Dashboard
                        </div>
                        
                        <div id="classCodeValidation" style="margin-top: var(--spacing-md);">
                            <!-- Validation messages will appear here -->
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--spacing-xl);">
                        <label for="challengeMessage" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Friendly Message (Optional)
                        </label>
                        <textarea id="challengeMessage" 
                                  placeholder="Add a friendly message for the other teacher... e.g., 'May the best class win! ğŸ†' or 'Ready for some friendly competition?'"
                                  rows="3"
                                  style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); resize: vertical;"></textarea>
                        <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-xs);">
                            This message will be sent with the challenge invitation
                        </div>
                    </div>
                    
                    <!-- Challenge Preview -->
                    <div class="challenge-preview">
                        <h4 style="margin-bottom: var(--spacing-lg); color: var(--accent);">ğŸ“‹ Challenge Preview</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: var(--spacing-lg); align-items: center; margin-bottom: var(--spacing-xl);">
                            <div style="text-align: center;">
                                <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: var(--spacing-xs); color: var(--accent);">Your Class</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); background: var(--bg); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius); display: inline-block;">
                                    ${currentClassCode || 'YOURCODE'}
                                </div>
                            </div>
                            
                            <div style="font-size: 2rem; font-weight: 900; color: var(--accent); padding: var(--spacing-sm); background: var(--accent-light); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                VS
                            </div>
                            
                            <div style="text-align: center;">
                                <div style="font-weight: 700; font-size: 1.125rem; margin-bottom: var(--spacing-xs); color: var(--accent);">Opponent</div>
                                <div id="previewOpponentCode" style="font-size: 0.875rem; color: var(--text-muted); background: var(--bg); padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius); display: inline-block;">
                                    Enter code
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 4px;">Challenge Type</div>
                                <div id="previewType" style="font-weight: 600; font-size: 1rem;">Not selected</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 4px;">Duration</div>
                                <div id="previewDuration" style="font-weight: 600; font-size: 1rem;">Not selected</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 4px;">Challenge Name</div>
                                <div id="previewName" style="font-weight: 600; font-size: 1rem;">Not named yet</div>
                            </div>
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 4px;">Status</div>
                                <div style="font-weight: 600; font-size: 1rem; color: var(--warning);">Ready to send</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="btn btn-secondary" onclick="goToStep(2)">
                            â† Back
                        </button>
                        <div class="step-indicator">
                            <div class="step-dot"></div>
                            <div class="step-dot"></div>
                            <div class="step-dot active"></div>
                            <div style="margin-left: var(--spacing-sm); font-size: 0.875rem; color: var(--text-muted);">
                                Step 3 of 3
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="submitChallenge()" id="submitChallengeBtn">
                            ğŸš€ Send Challenge
                        </button>
                    </div>
                </div>
                
                <!-- Step 4: Success -->
                <div class="form-step" id="step4" style="display: none; text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: var(--spacing-lg); color: var(--success);">ğŸ‰</div>
                    <h3 style="margin-bottom: var(--spacing-md); color: var(--success);">Challenge Created Successfully!</h3>
                    <p style="color: var(--text-muted); margin-bottom: var(--spacing-xl); max-width: 500px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                        Your challenge invitation has been sent! The other teacher will receive a notification and can choose to accept or decline. You'll be notified when they respond.
                    </p>
                    
                    <div id="createdChallengeDetails" style="background: var(--card); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); max-width: 500px; margin-left: auto; margin-right: auto; border: 2px solid var(--success);">
                        <h4 style="margin-bottom: var(--spacing-lg); color: var(--success);">ğŸ“¬ Challenge Sent</h4>
                        <!-- Details will appear here -->
                    </div>
                    
                    <div style="display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showSection('challenges')" style="min-width: 200px;">
                            ğŸ“‹ View All Challenges
                        </button>
                        <button class="btn btn-secondary" onclick="resetChallengeForm()" style="min-width: 200px;">
                            âœ¨ Create Another
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

   <!-- Settings Section -->
      <div id="settings" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>âš™ï¸ Teacher Settings</h2>
          </div>
          <div class="content-body">
            <div style="max-width: 600px; margin: 0 auto;">
              <div class="pro-tip">
                <strong>âš™ï¸ Profile Management</strong>
                Keep your information up-to-date. Students will see your name on announcements and assignments. Regular backups ensure you never lose your classroom data.
              </div>
              
              <div class="form-group">
                <label for="teacherName">Your Name</label>
                <input type="text" id="teacherName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="teacherEmail">Email</label>
                <input type="email" id="teacherEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label>Class Celebration Milestones (Per Class)</label>
                <div class="pro-tip" style="margin-bottom: var(--spacing-md);">
                  <strong>ğŸ‰ Celebration Settings</strong>
                  Configure when your class unlocks celebrations. Settings are saved per class code.
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm);">
                  <div>
                    <label for="milestoneTotalStreak" style="font-size: 0.8125rem; color: var(--text-muted);">Total Streak Days</label>
                    <input type="number" id="milestoneTotalStreak" min="1" step="1" placeholder="100">
                  </div>
                  <div>
                    <label for="milestoneSessionsWeek" style="font-size: 0.8125rem; color: var(--text-muted);">Sessions / Week</label>
                    <input type="number" id="milestoneSessionsWeek" min="1" step="1" placeholder="50">
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                  <input type="checkbox" id="milestonePerfectWeek" checked>
                  <label for="milestonePerfectWeek" style="margin: 0;">Perfect Week (All students active)</label>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                  <button class="btn btn-secondary" onclick="loadMilestoneSettingsToForm()" style="flex: 1;">â†º Reset to Saved</button>
                  <button class="btn btn-primary" onclick="saveMilestoneSettings()" style="flex: 1;">ğŸ’¾ Save Milestones</button>
                </div>
                <div style="margin-top: var(--spacing-sm);">
                  <button class="btn btn-success" onclick="testCelebration()" style="width: 100%;">ğŸ‰ Test Celebration</button>
                </div>
              </div>
              <div class="form-group">
                <label>Class Management</label>
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md);">
                  <button class="btn btn-primary" onclick="showCreateClassModal()" style="flex: 1;">â• Create Class</button>
                  <button class="btn btn-secondary" onclick="exportAllData()" style="flex: 1;">ğŸ“¤ Export All Data</button>
                </div>
              </div>
              <button class="btn-submit" onclick="saveTeacherSettings()" style="margin-top: var(--spacing-lg);">
                ğŸ’¾ Save Settings
              </button>
              
              <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
                <h3>ğŸ”„ Data Management</h3>
                <div class="pro-tip" style="margin-bottom: var(--spacing-md);">
                  <strong>ğŸ’¾ Backup Regularly</strong>
                  Create backups before major changes or at the end of each term. Restore from backup if you encounter issues. Clear all data only when starting fresh with a new academic year.
                </div>
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); flex-wrap: wrap;">
                  <button class="btn btn-warning" onclick="backupData()">ğŸ’¾ Backup Data</button>
                  <button class="btn btn-secondary" onclick="restoreData()">ğŸ“‚ Restore Backup</button>
                  <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Clear All Data</button>
                </div>
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-sm);">
                  Backup your data regularly to prevent data loss.
                </p>
              </div>
            </div>
          </div>
        </div>
        </div>
      </main>
</div>


</div>

<!-- Notifications Modal -->
<div id="notificationsModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="hideModal('notificationsModal')">Ã—</button>
        <div class="modal-header">
            <h3>ğŸ“¬ Notifications</h3>
            <button class="btn btn-secondary" onclick="markAllAsRead()" style="font-size: 0.875rem;">
                Mark all as read
            </button>
        </div>
        <div class="content-body">
            <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                <!-- Notifications will appear here -->
            </div>
        </div>
    </div>
</div>

  


<!-- Modals -->
<div id="createClassModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideModal('createClassModal')">Ã—</button>
    <div class="modal-header">
      <h3>Create New Class</h3>
    </div>
    <div class="form-group">
      <label for="classNameInput">Class Name</label>
      <input type="text" id="classNameInput" placeholder="e.g., Math 101, English Class" autofocus>
    </div>
    <div class="pro-tip" style="margin-bottom: var(--spacing-lg);">
      <strong>ğŸ« Class Naming Tips</strong>
      Use clear, descriptive names like "Algebra I - Period 2" or "10th Grade English". This helps you organize multiple classes efficiently.
    </div>
    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-xl);">
      <button class="btn btn-secondary" onclick="hideModal('createClassModal')" style="flex: 1;">Cancel</button>
      <button class="btn btn-primary" onclick="createNewClass()" style="flex: 1;">Create Class</button>
    </div>
  </div>
</div>

<div id="deleteClassModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideModal('deleteClassModal')">Ã—</button>
    <div class="modal-header">
      <h3>Delete Class</h3>
      <p>Are you sure you want to delete this class?</p>
    </div>
    <div style="margin-bottom: var(--spacing-xl);">
      <p style="color: var(--danger); font-size: 0.875rem; font-weight: 600; padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); border: 1px solid rgba(239, 68, 68, 0.2);">
        âš ï¸ Warning: This will delete all students, announcements, assignments, and resources in this class.
      </p>
    </div>
    <div class="pro-tip" style="margin-bottom: var(--spacing-lg);">
      <strong>ğŸ—‘ï¸ Before You Delete</strong>
      Consider exporting the class data first if you might need it later. Deleted classes cannot be recovered. This action is permanent.
    </div>
    <div style="display: flex; gap: var(--spacing-sm);">
      <button class="btn btn-secondary" onclick="hideModal('deleteClassModal')" style="flex: 1;">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDeleteClass()" style="flex: 1; background: var(--gradient-danger); border: none;">Delete Class</button>
    </div>
  </div>
</div>

<div id="createAnnouncementModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideModal('createAnnouncementModal')">Ã—</button>
    <div class="modal-header">
      <h3>Create Announcement</h3>
    </div>
    <div class="form-group">
      <label for="modalAnnouncementTitle">Title</label>
      <input type="text" id="modalAnnouncementTitle" placeholder="Announcement title...">
    </div>
    <div class="form-group">
      <label for="modalAnnouncementContent">Content</label>
      <textarea id="modalAnnouncementContent" placeholder="Write your announcement..." rows="5"></textarea>
    </div>
    <div class="pro-tip" style="margin-bottom: var(--spacing-lg);">
      <strong>ğŸ“¢ Effective Announcements</strong>
      Keep titles clear and content concise. Use bullet points for multiple items. Important announcements should be posted at times when students are most likely to see them.
    </div>
    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-xl);">
      <button class="btn btn-secondary" onclick="hideModal('createAnnouncementModal')" style="flex: 1;">Cancel</button>
      <button class="btn btn-primary" onclick="addAnnouncementFromModal()" style="flex: 1;">Post Announcement</button>
    </div>
  </div>
</div>

<div id="createAssignmentModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideModal('createAssignmentModal')">Ã—</button>
    <div class="modal-header">
      <h3>Create Assignment</h3>
    </div>
    <div class="form-group">
      <label for="modalAssignmentTitle">Title</label>
      <input type="text" id="modalAssignmentTitle" placeholder="Assignment title...">
    </div>
    <div class="form-group">
      <label for="modalAssignmentDescription">Description</label>
      <textarea id="modalAssignmentDescription" placeholder="Assignment details..." rows="5"></textarea>
    </div>
    <div class="form-group">
      <label for="modalAssignmentDueDate">Due Date</label>
      <input type="date" id="modalAssignmentDueDate">
    </div>
    <div class="pro-tip" style="margin-bottom: var(--spacing-lg);">
      <strong>ğŸ“š Assignment Planning</strong>
      Provide clear instructions, expected outcomes, and grading criteria. Consider breaking complex assignments into smaller tasks. Allow sufficient time for completion.
    </div>
    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-xl);">
      <button class="btn btn-secondary" onclick="hideModal('createAssignmentModal')" style="flex: 1;">Cancel</button>
      <button class="btn btn-primary" onclick="addAssignmentFromModal()" style="flex: 1;">Create Assignment</button>
    </div>
  </div>
</div>

<div id="createResourceModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="hideModal('createResourceModal')">Ã—</button>
    <div class="modal-header">
      <h3>Add Resource</h3>
    </div>
    <div class="form-group">
      <label for="modalResourceTitle">Title</label>
      <input type="text" id="modalResourceTitle" placeholder="Resource title...">
    </div>
    <div class="form-group">
      <label for="modalResourceUrl">URL</label>
      <input type="url" id="modalResourceUrl" placeholder="https://example.com">
    </div>
    <div class="form-group">
      <label for="modalResourceDescription">Description (Optional)</label>
      <textarea id="modalResourceDescription" placeholder="Description..." rows="3"></textarea>
    </div>
    <div class="pro-tip" style="margin-bottom: var(--spacing-lg);">
      <strong>ğŸ“ Resource Sharing</strong>
      Share links to educational videos, articles, practice exercises, or reference materials. Add descriptions to help students understand why the resource is valuable.
    </div>
    <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-xl);">
      <button class="btn btn-secondary" onclick="hideModal('createResourceModal')" style="flex: 1;">Cancel</button>
      <button class="btn btn-primary" onclick="addResourceFromModal()" style="flex: 1;">Add Resource</button>
    </div>
  </div>
</div>
<!-- Floating Feedback Button -->
<button class="feedback-btn" onclick="openFeedbackForm()">
    ğŸ’¬ Give Feedback
</button>
<canvas id="confettiCanvas"></canvas>
<script>
// ========== FIREBASE CONFIGURATION ==========
const firebaseConfig = {
  apiKey: "AIzaSyBAIPxgXPZmGdPvB98TLFRfTAClgXWEIM0",
  authDomain: "student-teacher-app-4e7c9.firebaseapp.com",
  databaseURL: "https://student-teacher-app-4e7c9-default-rtdb.firebaseio.com",
  projectId: "student-teacher-app-4e7c9",
  storageBucket: "student-teacher-app-4e7c9.firebasestorage.app",
  messagingSenderId: "737621420458",
  appId: "1:737621420458:web:74c873869a1a47c2ce23d3"
};

// ========== GLOBAL VARIABLES ==========
let database;
let auth;
let currentUser = null;
let teacherId = null;
let teacherName = "Teacher";
let teacherClasses = [];
let currentClassCode = null;
let currentClassId = null;
let selectedClassIndex = 0;
let isFirebaseInitialized = false;
let isDemoMode = false;

// Data arrays for current class
let announcements = [];
let assignments = [];
let resources = [];
let polls = [];
let students = [];
let currentSection = 'dashboard';
let liveActivity = [];

// Track announcements and resources to prevent duplicates
let announcementIds = new Set();
let resourceIds = new Set();
let pollIds = new Set();
let activityIds = new Set();
let activityRef = null;

// Modal state
let classToDelete = null;

// ========== SIDEBAR TOGGLE FUNCTIONS ==========
let isSidebarCollapsed = false;

function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const sidebarToggle = document.querySelector('.sidebar-toggle');
  const appLayout = document.querySelector('.app-layout');
  
  if (window.innerWidth <= 1020) {
    // Mobile behavior - toggle active class
    sidebar.classList.toggle('active');
    if (sidebar.classList.contains('active')) {
      sidebarToggle.innerHTML = 'â†’';
      sidebarToggle.title = 'Close Sidebar';
      sidebarToggle.style.left = 'calc(280px - 18px)';
      sidebarToggle.style.background = 'var(--danger)';
    } else {
      sidebarToggle.innerHTML = 'â†';
      sidebarToggle.title = 'Open Sidebar';
      sidebarToggle.style.left = '20px';
      sidebarToggle.style.background = 'var(--accent)';
    }
  } else {
    // Desktop behavior - toggle collapsed class on app-layout
    isSidebarCollapsed = !isSidebarCollapsed;
    
    if (isSidebarCollapsed) {
      appLayout.classList.add('sidebar-collapsed');
      sidebarToggle.innerHTML = 'â†’';
      sidebarToggle.title = 'Show Sidebar';
      sidebarToggle.style.left = '20px';
    } else {
      appLayout.classList.remove('sidebar-collapsed');
      sidebarToggle.innerHTML = 'â†';
      sidebarToggle.title = 'Hide Sidebar';
      sidebarToggle.style.left = '260px';
    }
    
    // Save sidebar state to localStorage
    localStorage.setItem('teacherSidebarCollapsed', isSidebarCollapsed);
  }
}

function loadSidebarState() {
  if (window.innerWidth <= 1020) return; // Don't load saved state on mobile
  
  const savedState = localStorage.getItem('teacherSidebarCollapsed');
  if (savedState === 'true') {
    isSidebarCollapsed = true;
    const appLayout = document.querySelector('.app-layout');
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    
    if (appLayout) {
      appLayout.classList.add('sidebar-collapsed');
    }
    if (sidebarToggle) {
      sidebarToggle.innerHTML = 'â†’';
      sidebarToggle.title = 'Show Sidebar';
      sidebarToggle.style.left = '20px';
    }
  }
}

function closeSidebarOnMobile() {
  if (window.innerWidth <= 1020) {
    const sidebar = document.querySelector('.sidebar');
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    
    sidebar.classList.remove('active');
    sidebarToggle.innerHTML = 'â†';
    sidebarToggle.title = 'Open Sidebar';
    sidebarToggle.style.left = '20px';
    sidebarToggle.style.background = 'var(--accent)';
  }
}

function updateSidebarToggleVisibility() {
  const sidebarToggle = document.querySelector('.sidebar-toggle');
  if (!sidebarToggle) return;
  
  sidebarToggle.style.display = 'flex';
}

// ========== BROWSER SEPARATION ==========
function ensureBrowserSeparation() {
    console.log("ğŸ” Ensuring browser separation...");
    
    // Check if we're in teacher mode
    const isTeacherMode = window.location.href.includes('teachermode') || 
                         window.location.pathname.includes('teachermode') ||
                         document.querySelector('.teacher-emoji') !== null;
    
    if (isTeacherMode) {
        console.log("ğŸ‘©â€ğŸ« Running in Teacher Mode");
        
        // Clear any student-specific localStorage data
        const studentKeys = [
            'studentUserId',
            'studentStudyData',
            'studentTasks',
            'studentAssignments',
            'studentUserClasses',
            'studentName',
            'studentProfile'
        ];
        
        studentKeys.forEach(key => {
            if (localStorage.getItem(key)) {
                console.log(`ğŸ—‘ï¸ Removing student data: ${key}`);
                localStorage.removeItem(key);
            }
        });
        
        // Also remove any sessionStorage data
        sessionStorage.clear();
        
        // Check for conflicting Firebase auth
        Object.keys(localStorage).forEach(key => {
            if (key.includes('firebase:authUser:')) {
                try {
                    const authData = JSON.parse(localStorage.getItem(key));
                    if (authData && authData.uid && authData.uid.includes('student')) {
                        console.log(`ğŸ—‘ï¸ Removing student auth token: ${key}`);
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    // Ignore parsing errors
                }
            }
        });
        
        // Set teacher-specific theme if not set
        if (!localStorage.getItem('teacherTheme')) {
            localStorage.setItem('teacherTheme', 'light');
        }
        
        // Ensure we have a teacher ID
        if (!localStorage.getItem('teacherUserId') && !teacherId) {
            const teacherUserId = 'teacher_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('teacherUserId', teacherUserId);
            console.log(`ğŸ‘©â€ğŸ« Generated teacher ID: ${teacherUserId}`);
        }
        
    } else {
        console.log("âŒ Not in Teacher Mode");
    }
}

// ========== LOCALSTORAGE FUNCTIONS ==========
function saveToLocalStorage(key, data) {
  try {
    localStorage.setItem(`teacher_${key}_${currentClassCode}`, JSON.stringify(data));
    console.log(`ğŸ’¾ Saved ${key} to localStorage for class ${currentClassCode}`);
  } catch (error) {
    console.error(`âŒ Error saving ${key} to localStorage:`, error);
  }
}

function loadFromLocalStorage(key) {
  if (!currentClassCode) return [];
  
  try {
    const data = localStorage.getItem(`teacher_${key}_${currentClassCode}`);
    if (data) {
      const parsed = JSON.parse(data);
      console.log(`ğŸ“‚ Loaded ${key} from localStorage for class ${currentClassCode}`);
      return Array.isArray(parsed) ? parsed : [];
    }
  } catch (error) {
    console.error(`âŒ Error loading ${key} from localStorage:`, error);
  }
  return [];
}

function saveAnnouncementsToLocalStorage() {
  saveToLocalStorage('announcements', announcements);
}

function saveAssignmentsToLocalStorage() {
  saveToLocalStorage('assignments', assignments);
}

function saveResourcesToLocalStorage() {
  saveToLocalStorage('resources', resources);
}

function savePollsToLocalStorage() {
  saveToLocalStorage('polls', polls);
}

function saveTeacherClassesToLocalStorage() {
  if (teacherId) {
    try {
      localStorage.setItem(`teacher_classes_${teacherId}`, JSON.stringify(teacherClasses));
    } catch (error) {
      console.error("Error saving teacher classes to localStorage:", error);
    }
  }
}

function loadTeacherClassesFromLocalStorage() {
  if (teacherId) {
    try {
      const data = localStorage.getItem(`teacher_classes_${teacherId}`);
      if (data) {
        teacherClasses = JSON.parse(data);
        console.log(`ğŸ“š Loaded ${teacherClasses.length} classes from localStorage`);
      }
    } catch (error) {
      console.error("Error loading teacher classes from localStorage:", error);
    }
  }
}

// ========== DEMO MODE FUNCTIONS ==========
function useDemoMode() {
  console.log("ğŸ­ Activating Demo Mode");
  isDemoMode = true;
  
  // Generate demo teacher ID
  teacherId = "demo_teacher_" + Math.random().toString(36).substr(2, 9);
  currentUser = {
    uid: teacherId,
    email: "teacher@example.com"
  };
  
  // Hide login modal, show dashboard
  document.getElementById('loginModal').style.display = 'none';
  document.querySelector('.app-layout').style.display = 'grid';
  document.getElementById('demoModeBtn').style.display = 'flex';
  
  // Show mobile header on smaller screens
  if (window.innerWidth <= 1020) {
    document.querySelector('.mobile-header').style.display = 'flex';
  }
  
  // Show sidebar toggle button
  updateSidebarToggleVisibility();
  
  // Initialize teacher dashboard
  initializeTeacher();
  
  showNotification("Demo Mode Activated! Creating demo class...", "success");
}

function toggleDemoMode() {
  if (confirm("Switch to Firebase mode? This will reload the page.")) {
    isDemoMode = false;
    localStorage.removeItem('demoMode');
    window.location.reload();
  }
}

// ========== AUTHENTICATION FUNCTIONS ==========
async function loginTeacher() {
  console.log("ğŸ” Login button clicked");
  
  const loginBtn = document.getElementById('loginBtn');
  const originalText = loginBtn.innerHTML;
  
  // Show loading state
  loginBtn.classList.add('btn-loading');
  loginBtn.disabled = true;
  loginBtn.innerHTML = 'Signing in...';
  
  try {
    // Ensure Firebase is initialized
    if (!isFirebaseInitialized) {
      console.log("Initializing Firebase...");
      const initialized = await initializeFirebase();
      if (!initialized) {
        throw new Error("Firebase failed to initialize");
      }
    }
    
    const email = document.getElementById('teacherEmail').value;
    const password = document.getElementById('teacherPassword').value;
    
    console.log(`Attempting login with email: ${email}`);
    
    if (!email || !password) {
      throw new Error("Please enter email and password");
    }
    
    // Show loading message
    showNotification("Signing in...", "info");
    
    // Attempt login with Firebase
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    teacherId = currentUser.uid;
    
    console.log(`âœ… Login successful! Teacher ID: ${teacherId}`);
    
    // Hide login modal, show dashboard
    document.getElementById('loginModal').style.display = 'none';
    document.querySelector('.app-layout').style.display = 'grid';
    document.getElementById('demoModeBtn').style.display = 'none';
    
    // Show mobile header on smaller screens
    if (window.innerWidth <= 1020) {
      document.querySelector('.mobile-header').style.display = 'flex';
    }
    
    // Show sidebar toggle button
    updateSidebarToggleVisibility();
    
    // Initialize teacher dashboard
    await initializeTeacher();
    
    showNotification("Welcome back, Teacher! ğŸ“", "success");
    
  } catch (error) {
    console.error(`âŒ Login error: ${error.message}`);
    
    // If Firebase auth fails, suggest demo mode
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      showNotification("Firebase authentication failed. Use Demo Mode instead.", "warning");
    } else {
      showNotification("Login failed. Try Demo Mode.", "error");
    }
  } finally {
    // Reset button state
    loginBtn.classList.remove('btn-loading');
    loginBtn.disabled = false;
    loginBtn.innerHTML = originalText;
  }
}

function logoutTeacher() {
  if (confirm("Are you sure you want to logout?")) {
    if (isDemoMode) {
      // Clear demo data
      currentUser = null;
      teacherId = null;
      teacherClasses = [];
      currentClassCode = null;
      currentClassId = null;
      isDemoMode = false;
      
      // Show login modal, hide dashboard
      document.getElementById('loginModal').style.display = 'flex';
      document.querySelector('.app-layout').style.display = 'none';
      document.querySelector('.mobile-header').style.display = 'none';
      document.querySelector('.sidebar-toggle').style.display = 'none';
      
      showNotification("Logged out from Demo Mode", "success");
    } else {
      auth.signOut().then(() => {
        currentUser = null;
        teacherId = null;
        teacherClasses = [];
        currentClassCode = null;
        currentClassId = null;
        
        // Show login modal, hide dashboard
        document.getElementById('loginModal').style.display = 'flex';
        document.querySelector('.app-layout').style.display = 'none';
        document.querySelector('.mobile-header').style.display = 'none';
        document.querySelector('.sidebar-toggle').style.display = 'none';
        
        showNotification("Logged out successfully", "success");
      }).catch((error) => {
        console.error(`âŒ Logout error: ${error.message}`);
        showNotification("Logout failed: " + error.message, "error");
      });
    }
  }
}

// ========== INITIALIZATION ==========
async function initializeFirebase() {
  try {
    console.log("ğŸ”¥ Initializing Firebase...");
    
    // Check if Firebase is already initialized
    if (!firebase.apps.length) {
      console.log("Creating new Firebase app instance");
      firebase.initializeApp(firebaseConfig);
    } else {
      console.log("Firebase already initialized");
    }
    
    // Get Firebase services
    database = firebase.database();
    auth = firebase.auth();
    
    console.log("âœ… Firebase services initialized");
    isFirebaseInitialized = true;
    
    return true;
  } catch (error) {
    console.error(`âŒ Firebase initialization failed: ${error.message}`);
    return false;
  }
}

async function initializeTeacher() {
  console.log("ğŸ¯ Initializing teacher dashboard...");
  
  // Show loading state
  showNotification("Loading your classes...", "info");
  
  if (isDemoMode) {
    loadTeacherClassesFromLocalStorage();
  } else {
    // Load classes from Firebase
    await loadClassesFromFirebase();
  }
  
  // If no classes, create a default one
  if (teacherClasses.length === 0) {
    console.log("No classes found, creating default class...");
    await createDefaultClass();
  }
  
  // Set current class
  if (teacherClasses.length > 0) {
    currentClassId = teacherClasses[0].id;
    currentClassCode = teacherClasses[0].code;
    selectedClassIndex = 0;
    console.log(`ğŸ“ Current class set to: ${teacherClasses[0].name}`);
  }
   
  // Update UI
  updateClassSelector();
  updateUI();
  
  // Load current class data
  if (currentClassCode) {
    await loadClassData();
    await loadMilestoneSettingsForClass();
  }
  
  // Setup real-time listeners for current class
  if (!isDemoMode) {
    setupRealtimeListeners();
  }
  
  // Load sidebar state
  loadSidebarState();
  
  // Show/hide sidebar toggle based on screen size
  updateSidebarToggleVisibility();
  
  console.log(`âœ… Teacher dashboard initialized with ${teacherClasses.length} classes`);
  showNotification("Dashboard loaded successfully! âœ…", "success");
  
  // Update theme
  const savedTheme = localStorage.getItem('teacherTheme') || 'light';
  changeTheme(savedTheme);
  
  // Update mobile title
  updateMobileTitle();


   // Initialize challenges system
    setTimeout(() => {
        initializeChallenges();
    }, 1000);

     // Initialize challenges (which loads notifications)
    setTimeout(() => {
        initializeChallenges();
    }, 1000);
}

async function loadClassesFromFirebase() {
  if (!teacherId) {
    loadTeacherClassesFromLocalStorage();
    return;
  }
  
  try {
    console.log("ğŸ“š Loading classes from Firebase...");
    const snapshot = await database.ref('teachers/' + teacherId + '/classes').once('value');
    if (snapshot.exists()) {
      teacherClasses = [];
      snapshot.forEach(child => {
        teacherClasses.push({
          id: child.key,
          code: child.val().code,
          name: child.val().name,
          createdAt: child.val().createdAt,
          studentCount: child.val().studentCount || 0
        });
      });
      console.log(`âœ… Loaded ${teacherClasses.length} classes from Firebase`);
    } else {
      console.log("No classes found in Firebase");
      loadTeacherClassesFromLocalStorage();
    }
  } catch (error) {
    console.error(`âŒ Error loading classes from Firebase: ${error.message}`);
    loadTeacherClassesFromLocalStorage();
  }
}

async function saveTeacherData() {
  if (isDemoMode) {
    saveTeacherClassesToLocalStorage();
    return;
  }
  
  if (!teacherId) return;
  
  const teacherData = {
    teacherId: teacherId,
    classes: teacherClasses.reduce((acc, cls) => {
      acc[cls.id] = {
        name: cls.name,
        code: cls.code,
        createdAt: cls.createdAt,
        studentCount: cls.studentCount || 0
      };
      return acc;
    }, {}),
    lastActive: new Date().toISOString(),
    email: currentUser?.email || '',
    name: teacherName
  };
  
  try {
    await database.ref('teachers/' + teacherId).set(teacherData);
    console.log("âœ… Teacher data saved to Firebase");
  } catch (error) {
    console.error(`âŒ Error saving teacher data: ${error.message}`);
  }
}

async function createDefaultClass() {
  const classCode = generateClassCode();
  const defaultClass = {
    id: 'class_' + Date.now(),
    name: "My First Classroom",
    code: classCode,
    createdAt: new Date().toISOString(),
    studentCount: 0
  };
  
  teacherClasses = [defaultClass];
  currentClassId = defaultClass.id;
  currentClassCode = classCode;
  selectedClassIndex = 0;
  
  // Save to Firebase or localStorage
  await saveTeacherData();
  
  if (!isDemoMode) {
    // Create class structure for students to access
    await createClassStructureForStudents(classCode, defaultClass.name);
  }
  
  console.log(`âœ… Created default class: ${classCode}`);
  showNotification(`Default class created! Code: ${classCode}`, "success");
  return defaultClass;
}

function generateClassCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

async function createClassStructureForStudents(classCode, className) {
  try {
    const classData = {
      teacherId: teacherId,
      name: className,
      code: classCode,
      createdAt: new Date().toISOString(),
      isActive: true
    };
    
    console.log(`ğŸ“ Creating class structure for ${classCode} with teacherId: ${teacherId}`);
    
    // Write to classCodes (for lookup)
    await database.ref('classCodes/' + classCode).set(classData);
    
    // Write to classes with teacherId set so security rules pass
    await database.ref('classes/' + classCode).set(classData);
    
    console.log(`âœ… Class structure created for students: ${classCode}`);
    
    // Also add a default announcement so structure exists
    const welcomeAnnouncement = {
      title: `Welcome to ${className}!`,
      content: `Welcome to our class! I'm excited to work with you all. Check the Resources section for a Student Mode Guide to get started.`,
      teacherId: teacherId,
      teacherName: teacherName,
      createdAt: new Date().toISOString(),
      classCode: classCode
    };
    
    await database.ref('announcements/' + classCode).push().set(welcomeAnnouncement);
    console.log(`âœ… Default announcement added to class ${classCode}`);
    
    // Add a default resource (Student Mode Guide)
    const studentModeGuide = {
      title: "Student Mode Guide",
      url: "https://mairakhancontact-sudo.github.io/studentmode-guide/",
      description: "Complete guide for students on how to use Student Mode. Learn how to track study sessions, earn points, maintain streaks, and make the most of your learning dashboard.",
      teacherId: teacherId,
      createdAt: new Date().toISOString(),
      classCode: classCode
    };
    
    await database.ref('resources/' + classCode).push().set(studentModeGuide);
    console.log(`âœ… Student Mode Guide added to class ${classCode}`);
    
  } catch (error) {
    console.error(`âŒ Error creating class structure: ${error.message}`);
    throw error;
  }
}

// ========== CLASS MANAGEMENT ==========
function updateClassSelector() {
  const selector = document.getElementById('classSelector');
  if (!selector) return;
  
  selector.innerHTML = '<option value="">Select a Class</option>';
  
  teacherClasses.forEach((classInfo, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = `${classInfo.name} (${classInfo.code})`;
    if (index === selectedClassIndex) {
      option.selected = true;
    }
    selector.appendChild(option);
  });
}

async function switchClass(classIndex) {
  if (classIndex === "") return;
  
  classIndex = parseInt(classIndex);
  if (classIndex >= 0 && classIndex < teacherClasses.length) {
    selectedClassIndex = classIndex;
    currentClassCode = teacherClasses[classIndex].code;
    currentClassId = teacherClasses[classIndex].id;
    
    console.log(`ğŸ”„ Switched to class: ${currentClassCode}`);
    
    // Update UI
    updateUI();
    
    // Load class data
    await loadClassData();
    await loadMilestoneSettingsForClass();
      initializeSidebarHeatmap();

    showNotification(`Switched to ${teacherClasses[classIndex].name}`, "success");
  }
}

function showCreateClassModal() {
  document.getElementById('classNameInput').value = '';
  showModal('createClassModal');
  document.getElementById('classNameInput').focus();
}

async function createNewClass() {
  const className = document.getElementById('classNameInput').value.trim();
  if (!className) {
    showNotification("Please enter a class name", "error");
    return;
  }
  
  const classCode = generateClassCode();
  const newClass = {
    id: 'class_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    name: className,
    code: classCode,
    createdAt: new Date().toISOString(),
    studentCount: 0
  };
  
  // Add to local state
  teacherClasses.push(newClass);
  currentClassCode = classCode;
  currentClassId = newClass.id;
  selectedClassIndex = teacherClasses.length - 1;
  
  // Save to Firebase or localStorage
  await saveTeacherData();
  
  if (!isDemoMode) {
    // Create class structure for students to access
    await createClassStructureForStudents(classCode, className);
  }
  
  // Update UI
  updateClassSelector();
  updateUI();
  hideModal('createClassModal');
  
  // Clear current data and switch to new class
  students = [];
  announcements = [];
  assignments = [];
  resources = [];
  
  await loadClassData();
  
  showNotification(`Class "${className}" created! Code: ${classCode}`, "success");
  console.log(`âœ… New class created: ${className} (${classCode})`);
}

function showDeleteClassModal() {
  if (!currentClassCode) {
    showNotification("No class selected", "error");
    return;
  }
  
  classToDelete = teacherClasses.find(c => c.code === currentClassCode);
  if (!classToDelete) return;
  
  // Don't allow deleting the last class
  if (teacherClasses.length <= 1) {
    showNotification("You must have at least one class", "error");
    return;
  }
  
  showModal('deleteClassModal');
}

async function confirmDeleteClass() {
  if (!classToDelete) return;
  
  const classIndex = teacherClasses.findIndex(c => c.code === classToDelete.code);
  if (classIndex === -1) return;
  
  const className = classToDelete.name;
  const classCode = classToDelete.code;
  
  if (isDemoMode) {
    // Delete from localStorage
    localStorage.removeItem(`teacher_announcements_${classCode}`);
    localStorage.removeItem(`teacher_assignments_${classCode}`);
    localStorage.removeItem(`teacher_resources_${classCode}`);
    localStorage.removeItem(`teacher_polls_${classCode}`);
  } else {
    try {
      // Delete from Firebase - use teacher's own path
      await database.ref('teachers/' + teacherId + '/classes/' + classToDelete.id).remove();
      
      // Try to delete from other paths if we have permission
      try {
        await database.ref('classCodes/' + classCode).remove();
      } catch (e) { console.log("Could not delete from classCodes"); }
      
      try {
        await database.ref('classes/' + classCode).remove();
      } catch (e) { console.log("Could not delete from classes"); }
      
      try {
        await database.ref('announcements/' + classCode).remove();
      } catch (e) { console.log("Could not delete announcements"); }
      
      try {
        await database.ref('assignments/' + classCode).remove();
      } catch (e) { console.log("Could not delete assignments"); }
      
      try {
        await database.ref('resources/' + classCode).remove();
      } catch (e) { console.log("Could not delete resources"); }
      
      try {
        await database.ref('polls/' + classCode).remove();
      } catch (e) { console.log("Could not delete polls"); }
      
      try {
        await database.ref('classStudents/' + classCode).remove();
      } catch (e) { console.log("Could not delete classStudents"); }
      
      // Also delete from localStorage
      localStorage.removeItem(`teacher_announcements_${classCode}`);
      localStorage.removeItem(`teacher_assignments_${classCode}`);
      localStorage.removeItem(`teacher_resources_${classCode}`);
      localStorage.removeItem(`teacher_polls_${classCode}`);
    } catch (error) {
      console.error(`âŒ Error deleting class from Firebase: ${error.message}`);
      showNotification("Error deleting class from database: " + error.message, "error");
      return;
    }
  }
  
  // Remove from local arrays
  teacherClasses.splice(classIndex, 1);
  
  // Update current class if needed
  if (currentClassCode === classCode) {
    if (teacherClasses.length > 0) {
      selectedClassIndex = 0;
      currentClassCode = teacherClasses[0].code;
      currentClassId = teacherClasses[0].id;
      await loadClassData();
    } else {
      currentClassCode = null;
      currentClassId = null;
      selectedClassIndex = -1;
      students = [];
      announcements = [];
      assignments = [];
      resources = [];
      updateUI();
    }
  } else if (selectedClassIndex > classIndex) {
    selectedClassIndex--;
  }
  
  // Save teacher data
  await saveTeacherData();
  
  // Update UI
  updateClassSelector();
  hideModal('deleteClassModal');
  
  showNotification(`Class "${className}" deleted`, "success");
  console.log(`ğŸ—‘ï¸ Class deleted: ${className} (${classCode})`);
  classToDelete = null;
}

// ========== MODAL FUNCTIONS ==========
function showModal(id) {
  document.getElementById(id).style.display = 'flex';
}

function hideModal(id) {
  document.getElementById(id).style.display = 'none';
}

function showCreateAnnouncementModal() {
  document.getElementById('modalAnnouncementTitle').value = '';
  document.getElementById('modalAnnouncementContent').value = '';
  showModal('createAnnouncementModal');
  document.getElementById('modalAnnouncementTitle').focus();
}

function showCreateAssignmentModal() {
  document.getElementById('modalAssignmentTitle').value = '';
  document.getElementById('modalAssignmentDescription').value = '';
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('modalAssignmentDueDate').value = tomorrow.toISOString().split('T')[0];
  showModal('createAssignmentModal');
  document.getElementById('modalAssignmentTitle').focus();
}

function showCreateResourceModal() {
  document.getElementById('modalResourceTitle').value = '';
  document.getElementById('modalResourceUrl').value = '';
  document.getElementById('modalResourceDescription').value = '';
  showModal('createResourceModal');
  document.getElementById('modalResourceTitle').focus();
}

function showCreatePollForm() {
  const form = document.getElementById('createPollForm');
  if (form) form.style.display = 'block';
  const question = document.getElementById('pollQuestion');
  if (question) question.focus();
}

function hideCreatePollForm() {
  const form = document.getElementById('createPollForm');
  if (form) form.style.display = 'none';
}

// ========== CLASS DATA MANAGEMENT ==========
async function loadClassData() {
  
  if (!currentClassCode) {
    console.log("âŒ Cannot load class data: No class selected");
    return;
  }
  
  console.log(`ğŸ“‚ Loading data for class: ${currentClassCode} (Teacher ID: ${teacherId})`);
     if (!isDemoMode) {
        // Load students from MULTIPLE possible paths
        let studentsSnap;
        
        // Try main path first
        studentsSnap = await database.ref(`classes/${currentClassCode}/students`).once('value');
        
        if (!studentsSnap.exists()) {
            console.log(`âš ï¸ No students at main path, trying alternatives...`);
            
            // Try classStudents
            studentsSnap = await database.ref(`classStudents/${currentClassCode}`).once('value');
            
            if (!studentsSnap.exists()) {
                // Try studentData path
                studentsSnap = await database.ref(`studentData/${currentClassCode}`).once('value');
            }
        }
      }
  try {
    // Show loading state
    updateSyncStatus("Loading class data...", "syncing");
    
    // Clear previous data
    students = [];
    announcements = [];
    assignments = [];
    resources = [];
    polls = [];
    
    // Reset ID sets
    announcementIds.clear();
    resourceIds.clear();
    pollIds.clear();
    
    if (isDemoMode) {
      // Load from localStorage for demo mode
      announcements = loadFromLocalStorage('announcements');
      assignments = loadFromLocalStorage('assignments');
      resources = loadFromLocalStorage('resources');
      polls = loadFromLocalStorage('polls');
      
      // Track IDs to prevent duplicates
      announcements.forEach(ann => announcementIds.add(ann.id));
      resources.forEach(res => resourceIds.add(res.id));
      polls.forEach(pol => pollIds.add(pol.id));
      
      // Create demo students
      createDemoStudents();
      
      // Create demo content if empty
      if (announcements.length === 0) {
        createDemoAnnouncements();
        saveAnnouncementsToLocalStorage();
      }
      if (assignments.length === 0) {
        createDemoAssignments();
        saveAssignmentsToLocalStorage();
      }
      if (resources.length === 0) {
        createDemoResources();
        saveResourcesToLocalStorage();
      }
      if (polls.length === 0) {
        savePollsToLocalStorage();
      }
    } else {
      // Load from Firebase - IMPORTANT: Use proper path and handle same-browser issue
      try {
        console.log(`ğŸ“Š Loading students from Firebase path: classes/${currentClassCode}/students`);
        
        // FIRST: Check if we're the teacher of this class
        const classInfo = await database.ref(`classes/${currentClassCode}`).once('value');
        const classData = classInfo.val();
        
        if (!classData) {
          console.log(`âŒ Class ${currentClassCode} doesn't exist`);
          showNotification("Class not found in database", "error");
          return;
        }
        
        const isTeacherOfClass = classData.teacherId === teacherId;
        console.log(`ğŸ‘¨â€ğŸ« Are we the teacher of this class? ${isTeacherOfClass}`);
        console.log(`   Class teacherId: ${classData.teacherId}, Our teacherId: ${teacherId}`);
        
        // Load students from multiple possible paths
        let studentsSnap;
        
        // Try main path first
        studentsSnap = await database.ref(`classes/${currentClassCode}/students`).once('value');
        
        if (!studentsSnap.exists()) {
          console.log(`âš ï¸ No students at classes/${currentClassCode}/students, trying classStudents/${currentClassCode}`);
          // Try alternative path
          studentsSnap = await database.ref(`classStudents/${currentClassCode}`).once('value');
        }
        
        console.log("Students snapshot exists:", studentsSnap.exists());
        console.log("Number of student entries:", studentsSnap.exists() ? studentsSnap.numChildren() : 0);
        
        if (studentsSnap.exists()) {
          students = []; // Clear array
          studentsSnap.forEach(child => {
            const studentData = child.val();
            const studentId = child.key;
            
            console.log(`ğŸ‘¤ Student found: ${studentId}`, studentData);
            
            // CRITICAL FIX: Filter out teacher's own ID from student list
            // But show warning if teacher's ID appears as student
            if (studentId === teacherId) {
              console.warn(`âš ï¸ Teacher's ID found in students list! This happens when teacher and student use same browser.`);
              console.warn(`   Teacher ID: ${teacherId}, Student ID in list: ${studentId}`);
              
              // Show notification to teacher
              showNotification("Warning: Your teacher account appears in student list. Consider using separate browser for student mode.", "warning");
              
              // Still add for debugging, but mark as teacher
              students.push({
                id: studentId,
                name: studentData.name || 'Teacher (in student list)',
                streak: studentData.streak || 0,
                totalMinutes: studentData.totalMinutes || 0,
                totalStudyHours: studentData.totalStudyHours || 
                                 (studentData.totalMinutes ? (studentData.totalMinutes / 60).toFixed(1) : '0.0'),
                points: studentData.points || Math.floor((studentData.totalMinutes || 0) / 60) * 100 || 0,
                lastActive: studentData.lastActive || studentData.updatedAt || 'Unknown',
                isTeacher: true
              });
            } else {
              // Regular student
              students.push({
                id: studentId,
                name: studentData.name || studentData.userName || 'Student ' + studentId.substr(0, 6),
                streak: studentData.streak || 0,
                totalMinutes: studentData.totalMinutes || 0,
                totalStudyHours: studentData.totalStudyHours || 
                                 (studentData.totalMinutes ? (studentData.totalMinutes / 60).toFixed(1) : '0.0'),
                points: studentData.points || Math.floor((studentData.totalMinutes || 0) / 60) * 100 || 0,
                lastActive: studentData.lastActive || studentData.updatedAt || 'Unknown',
                isTeacher: false
              });
            }
          });
          console.log(`âœ… Loaded ${students.length} students from Firebase`);
        } else {
          console.log("âŒ No students found in Firebase for this class");
          students = [];
        }
        
        // Load announcements
        try {
          const announcementsSnap = await database.ref(`announcements/${currentClassCode}`).once('value');
          if (announcementsSnap.exists()) {
            announcements = [];
            announcementsSnap.forEach(child => {
              const ann = { id: child.key, ...child.val() };
              announcements.push(ann);
              announcementIds.add(ann.id);
            });
            console.log(`âœ… Loaded ${announcements.length} announcements from Firebase`);
            saveAnnouncementsToLocalStorage();
          } else {
            announcements = loadFromLocalStorage('announcements');
            console.log(`ğŸ“‚ Loaded ${announcements.length} announcements from localStorage`);
          }
        } catch (annError) {
          console.error("Error loading announcements:", annError);
          announcements = loadFromLocalStorage('announcements');
        }
        
        // Load assignments
        try {
          const assignmentsSnap = await database.ref(`assignments/${currentClassCode}`).once('value');
          if (assignmentsSnap.exists()) {
            assignments = [];
            assignmentsSnap.forEach(child => {
              assignments.push({ id: child.key, ...child.val() });
            });
            console.log(`âœ… Loaded ${assignments.length} assignments from Firebase`);
            saveAssignmentsToLocalStorage();
          } else {
            assignments = loadFromLocalStorage('assignments');
            console.log(`ğŸ“‚ Loaded ${assignments.length} assignments from localStorage`);
          }
        } catch (assgnError) {
          console.error("Error loading assignments:", assgnError);
          assignments = loadFromLocalStorage('assignments');
        }
        
        // Load resources
        try {
          const resourcesSnap = await database.ref(`resources/${currentClassCode}`).once('value');
          if (resourcesSnap.exists()) {
            resources = [];
            resourcesSnap.forEach(child => {
              const res = { id: child.key, ...child.val() };
              resources.push(res);
              resourceIds.add(res.id);
            });
            console.log(`âœ… Loaded ${resources.length} resources from Firebase`);
            saveResourcesToLocalStorage();
          } else {
            resources = loadFromLocalStorage('resources');
            console.log(`ğŸ“‚ Loaded ${resources.length} resources from localStorage`);
          }
        } catch (resError) {
          console.error("Error loading resources:", resError);
          resources = loadFromLocalStorage('resources');
        }
        
        // Load polls
        try {
          const pollsSnap = await database.ref(`polls/${currentClassCode}`).once('value');
          if (pollsSnap.exists()) {
            polls = [];
            pollsSnap.forEach(child => {
              const pol = { id: child.key, ...child.val() };
              polls.push(pol);
              pollIds.add(pol.id);
            });
            console.log(`âœ… Loaded ${polls.length} polls from Firebase`);
            savePollsToLocalStorage();
          } else {
            polls = loadFromLocalStorage('polls');
            console.log(`ğŸ“‚ Loaded ${polls.length} polls from localStorage`);
          }
        } catch (pollError) {
          console.error("Error loading polls:", pollError);
          polls = loadFromLocalStorage('polls');
        }
        
      } catch (firebaseError) {
        console.error(`âŒ Error loading class data from Firebase: ${firebaseError.message}`);
        showNotification("Error loading data from Firebase. Using local data.", "warning");
        
        // Fallback to localStorage
        announcements = loadFromLocalStorage('announcements');
        assignments = loadFromLocalStorage('assignments');
        resources = loadFromLocalStorage('resources');
        createDemoStudents();
      }
    }
    
    // Sort data
    students.sort((a, b) => (b.points || 0) - (a.points || 0));
    announcements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    assignments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    resources.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    polls.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // Update UI
    updateUI();
    renderAllData();
    updateStats();
    getLiveActivity(currentClassCode);
     // Initialize sidebar heatmap
initializeSidebarHeatmap();

    console.log(`âœ… Loaded: ${students.length} students, ${announcements.length} announcements, ${assignments.length} assignments, ${resources.length} resources`);
    
    if (students.length === 0) {
      console.log("â„¹ï¸ No students found. Students may need to join using the class code.");
      showNotification("No students found in this class. Share the class code with students!", "info");
    } else {
      console.log("ğŸ‘¥ Students found:", students.map(s => s.name + (s.isTeacher ? " (Teacher)" : "")));
    }
    
    updateSyncStatus("Class data loaded", "success");
    
    // Setup real-time listeners if not in demo mode
    if (!isDemoMode && currentClassCode) {
      setupRealtimeListeners();
    }
    
  } catch (error) {
    console.error(`âŒ Unexpected error in loadClassData: ${error.message}`);
    console.error(error.stack);
    updateSyncStatus("Error loading data", "error");
    showNotification("Failed to load class data: " + error.message, "error");
  }
}

// ========== DEMO DATA CREATION FUNCTIONS ==========
function createDemoStudents() {
  const demoStudents = [
    { name: "Alex Johnson", streak: 7, totalMinutes: 1250, points: 150 },
    { name: "Sam Smith", streak: 3, totalMinutes: 850, points: 90 },
    { name: "Taylor Brown", streak: 14, totalMinutes: 2100, points: 250 },
    { name: "Jordan Lee", streak: 1, totalMinutes: 300, points: 35 }
  ];
  
  demoStudents.forEach((student, index) => {
    students.push({
      id: 'demo_student_' + index,
      name: student.name,
      streak: student.streak,
      totalMinutes: student.totalMinutes,
      totalStudyHours: (student.totalMinutes / 60).toFixed(1),
      points: student.points,
      lastActive: new Date().toISOString()
    });
  });

    setTimeout(() => {
        updateClassStreakChain();
    }, 500);
}


function createDemoAnnouncements() {
  const demoAnnouncements = [
    { 
      title: "Welcome to the Class!", 
      content: "Welcome everyone to our new class. I'm excited to work with you all this semester! Please check the Resources section for a Student Mode Guide.",
      createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
    },
    { 
      title: "Important Assignment Due", 
      content: "Remember that the first assignment is due this Friday. Please submit through the portal.",
      createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
    },
    { 
      title: "Class Schedule Update", 
      content: "Next week's class will be held in Room 204 instead of Room 105.",
      createdAt: new Date().toISOString()
    }
  ];
  
  demoAnnouncements.forEach((ann, index) => {
    const id = 'demo_ann_' + index;
    announcements.push({
      id: id,
      title: ann.title,
      content: ann.content,
      teacherId: teacherId,
      teacherName: teacherName,
      createdAt: ann.createdAt,
      classCode: currentClassCode
    });
    announcementIds.add(id);
  });
}

function createDemoAssignments() {
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const nextWeek = new Date();
  nextWeek.setDate(nextWeek.getDate() + 7);
  
  const demoAssignments = [
    { 
      title: "Math Chapter 5 Exercises", 
      description: "Complete exercises 1-20 from Chapter 5. Show all your work.",
      dueDate: tomorrow.toISOString().split('T')[0]
    },
    { 
      title: "Science Lab Report", 
      description: "Write a lab report on the photosynthesis experiment we conducted.",
      dueDate: nextWeek.toISOString().split('T')[0]
    },
    { 
      title: "History Essay", 
      description: "Write a 1000-word essay on the causes of World War II.",
      dueDate: nextWeek.toISOString().split('T')[0]
    }
  ];
  
  demoAssignments.forEach((assgn, index) => {
    assignments.push({
      id: 'demo_assgn_' + index,
      title: assgn.title,
      description: assgn.description,
      dueDate: assgn.dueDate,
      teacherId: teacherId,
      createdAt: new Date().toISOString(),
      classCode: currentClassCode
    });
  });
}

function createDemoResources() {
  const demoResources = [
    { 
      title: "Student Mode Guide",
      url: "https://mairakhancontact-sudo.github.io/studentmode-guide/",
      description: "Complete guide for students on how to use Student Mode. Learn how to track study sessions, earn points, maintain streaks, and make the most of your learning dashboard."
    },
    { 
      title: "Math Textbook PDF", 
      url: "https://mairakhancontact-sudo.github.io/studentmode-guide/",
      description: "Complete digital version of our math textbook"
    },
    { 
      title: "Science Lab Videos", 
      url: "https://mairakhancontact-sudo.github.io/studentmode-guide/",
      description: "Video demonstrations of all required lab experiments"
    },
    { 
      title: "Study Guide Template", 
      url: "https://example.com/study-guide",
      description: "Template for creating effective study guides"
    }
  ];
  
  demoResources.forEach((res, index) => {
    const id = 'demo_res_' + index;
    resources.push({
      id: id,
      title: res.title,
      url: res.url,
      description: res.description,
      teacherId: teacherId,
      createdAt: new Date().toISOString(),
      classCode: currentClassCode
    });
    resourceIds.add(id);
  });
}


function showCreateChallengePage() {
    console.log("showCreateChallengePage called");
    
    if (!currentClassCode) {
        showNotification("Please select a class first", "error");
        return;
    }
    
    // First reset the form
    resetChallengeForm();
    
    // Then show the create-challenge section
    showSection('create-challenge');
    
    // Force scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log("Create challenge section should be visible now");
}


// ========== DATA MANAGEMENT FUNCTIONS ==========
async function addAnnouncement() {
  const title = document.getElementById('announcementTitle').value.trim();
  const content = document.getElementById('announcementContent').value.trim();
  
  if (!title || !content) {
    showNotification("Please fill in all fields", "error");
    return;
  }
  
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  console.log(`ğŸ“¢ Adding announcement for class: ${currentClassCode}`);
  
  await postAnnouncement(title, content);
  
  // Clear form
  document.getElementById('announcementTitle').value = '';
  document.getElementById('announcementContent').value = '';
}

async function addAnnouncementFromModal() {
  const title = document.getElementById('modalAnnouncementTitle').value.trim();
  const content = document.getElementById('modalAnnouncementContent').value.trim();
  
  if (!title || !content) {
    showNotification("Please fill in all fields", "error");
    return;
  }
  
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  await postAnnouncement(title, content);
  hideModal('createAnnouncementModal');
}

async function postAnnouncement(title, content) {
    const announcement = {
        title: title,
        content: content,
        teacherId: teacherId,
        teacherName: teacherName,
        createdAt: new Date().toISOString(),
        classCode: currentClassCode
    };
    
    if (isDemoMode) {
        // Save to localStorage
        const id = 'ann_' + Date.now();
        announcements.unshift({ id: id, ...announcement });
        announcementIds.add(id);
        saveAnnouncementsToLocalStorage();
        
        // Update UI
        renderAnnouncements();
        renderAllAnnouncements();
        updateStats();
        
        showNotification("Announcement posted successfully (Demo Mode)", "success");
        console.log(`âœ… Announcement posted: ${title}`);
    } else {
        try {
            console.log(`ğŸ“¤ Posting announcement to Firebase for class ${currentClassCode}`);
            
            // Check if we have permission by trying to write to teacher's own path first
            const teacherClassRef = database.ref(`teachers/${teacherId}/classes`);
            const teacherSnapshot = await teacherClassRef.once('value');
            
            if (!teacherSnapshot.exists()) {
                showNotification("You don't have permission to post to this class", "error");
                return;
            }
            
            // Save to Firebase
            const newAnnouncementRef = database.ref(`announcements/${currentClassCode}`).push();
            await newAnnouncementRef.set(announcement);
            
            console.log(`âœ… Announcement saved to Firebase at: announcements/${currentClassCode}/${newAnnouncementRef.key}`);
            
            // Add to local array WITHOUT duplicating (real-time listener will add it)
            // Just track the ID to prevent duplicates
            announcementIds.add(newAnnouncementRef.key);
            
            // Show success immediately
            showNotification("Announcement posted successfully", "success");
            console.log(`âœ… Announcement posted: ${title}`);
            
        } catch (error) {
            console.error(`âŒ Error adding announcement: ${error.message}`);
            console.error(`Error code: ${error.code}`);
            
            // Fallback to localStorage only
            const id = 'local_' + Date.now();
            announcements.unshift({ id: id, ...announcement });
            announcementIds.add(id);
            saveAnnouncementsToLocalStorage();
            
            // Update UI
            renderAnnouncements();
            renderAllAnnouncements();
            updateStats();
            
            showNotification("Announcement saved to local storage (Firebase offline)", "warning");
            console.log(`ğŸ’¾ Announcement saved to localStorage: ${title}`);
        }
    }
}

async function postSystemAnnouncement(title, content) {
  if (!currentClassCode) return;
  
  const announcement = {
    title: title,
    content: content,
    teacherId: teacherId,
    teacherName: teacherName,
    createdAt: new Date().toISOString(),
    classCode: currentClassCode,
    isSystem: true
  };
  
  if (isDemoMode) {
    const id = 'sys_ann_' + Date.now();
    announcements.unshift({ id: id, ...announcement });
    announcementIds.add(id);
    saveAnnouncementsToLocalStorage();
    renderAnnouncements();
    renderAllAnnouncements();
    updateStats();
    return;
  }
  
  try {
    const newAnnouncementRef = database.ref(`announcements/${currentClassCode}`).push();
    await newAnnouncementRef.set(announcement);
    
    const id = newAnnouncementRef.key;
    announcements.unshift({ id: id, ...announcement });
    announcementIds.add(id);
    saveAnnouncementsToLocalStorage();
    renderAnnouncements();
    renderAllAnnouncements();
    updateStats();
  } catch (error) {
    console.error(`âŒ Error adding system announcement: ${error.message}`);
    const id = 'local_' + Date.now();
    announcements.unshift({ id: id, ...announcement });
    announcementIds.add(id);
    saveAnnouncementsToLocalStorage();
    renderAnnouncements();
    renderAllAnnouncements();
    updateStats();
  }
}

async function addAssignment() {
  const title = document.getElementById('assignmentTitle').value.trim();
  const description = document.getElementById('assignmentDescription').value.trim();
  const dueDate = document.getElementById('assignmentDueDate').value;
  
  if (!title || !description || !dueDate) {
    showNotification("Please fill in all fields", "error");
    return;
  }
  
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  console.log(`ğŸ“š Adding assignment for class: ${currentClassCode}`);
  
  await postAssignment(title, description, dueDate);
  
  // Clear form
  document.getElementById('assignmentTitle').value = '';
  document.getElementById('assignmentDescription').value = '';
  document.getElementById('assignmentDueDate').value = '';
}

async function addAssignmentFromModal() {
  const title = document.getElementById('modalAssignmentTitle').value.trim();
  const description = document.getElementById('modalAssignmentDescription').value.trim();
  const dueDate = document.getElementById('modalAssignmentDueDate').value;
  
  if (!title || !description || !dueDate) {
    showNotification("Please fill in all fields", "error");
    return;
  }
  
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  await postAssignment(title, description, dueDate);
  hideModal('createAssignmentModal');
}

async function postAssignment(title, description, dueDate) {
  const assignment = {
    title: title,
    description: description,
    dueDate: dueDate,
    teacherId: teacherId,
    createdAt: new Date().toISOString(),
    classCode: currentClassCode
  };
  
  if (isDemoMode) {
    // Save to localStorage
    const id = 'assgn_' + Date.now();
    assignments.unshift({ id: id, ...assignment });
    saveAssignmentsToLocalStorage();
    
    // Update UI
    renderAssignments();
    renderAllAssignments();
    updateStats();
    
    showNotification("Assignment added successfully (Demo Mode)", "success");
    console.log(`âœ… Assignment added: ${title}`);
  } else {
    try {
      // Check if we have permission by checking teacher's classes
      const teacherClassRef = database.ref(`teachers/${teacherId}/classes`);
      const teacherSnapshot = await teacherClassRef.once('value');
      
      if (!teacherSnapshot.exists()) {
        showNotification("You don't have permission to add assignments to this class", "error");
        return;
      }
      
      // Save to Firebase
      const newAssignmentRef = database.ref('assignments/' + currentClassCode).push();
      await newAssignmentRef.set(assignment);
      
      showNotification("Assignment added successfully", "success");
      console.log(`âœ… Assignment added: ${title}`);
    } catch (error) {
      console.error(`âŒ Error adding assignment: ${error.message}`);
      
      // Fallback to localStorage only
      const id = 'local_' + Date.now();
      assignments.unshift({ id: id, ...assignment });
      saveAssignmentsToLocalStorage();
      
      // Update UI
      renderAssignments();
      renderAllAssignments();
      updateStats();
      
      showNotification("Assignment saved to local storage (Firebase offline)", "warning");
      console.log(`ğŸ’¾ Assignment saved to localStorage: ${title}`);
    }
  }
}

async function addResourceFromModal() {
  const title = document.getElementById('modalResourceTitle').value.trim();
  const url = document.getElementById('modalResourceUrl').value.trim();
  const description = document.getElementById('modalResourceDescription').value.trim();
  
  if (!title || !url) {
    showNotification("Please fill in all required fields", "error");
    return;
  }
  
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  await postResource(title, url, description);
  hideModal('createResourceModal');
}

async function postResource(title, url, description = "") {
  const resource = {
    title: title,
    url: url,
    description: description,
    teacherId: teacherId,
    createdAt: new Date().toISOString(),
    classCode: currentClassCode
  };
  
  if (isDemoMode) {
    // Save to localStorage
    const id = 'res_' + Date.now();
    resources.push({ id: id, ...resource });
    resourceIds.add(id);
    saveResourcesToLocalStorage();
    
    // Update UI
    renderResources();
    renderAllResources();
    updateStats();
    
    showNotification("Resource added successfully (Demo Mode)", "success");
    console.log(`âœ… Resource added: ${title}`);
  } else {
    try {
      console.log(`ğŸ“ Posting resource to Firebase for class ${currentClassCode}`);
      
      // Check if we have permission by checking teacher's classes
      const teacherClassRef = database.ref(`teachers/${teacherId}/classes`);
      const teacherSnapshot = await teacherClassRef.once('value');
      
      if (!teacherSnapshot.exists()) {
        showNotification("You don't have permission to add resources to this class", "error");
        return;
      }
      
      const newResourceRef = database.ref('resources/' + currentClassCode).push();
      await newResourceRef.set(resource);
      
      console.log(`âœ… Resource saved to Firebase at: resources/${currentClassCode}/${newResourceRef.key}`);
      
      // Add to local array WITHOUT duplicating (real-time listener will add it)
      // Just track the ID to prevent duplicates
      resourceIds.add(newResourceRef.key);
      
      // Show success immediately
      showNotification("Resource added successfully", "success");
      console.log(`âœ… Resource added: ${title}`);
      
    } catch (error) {
      console.error(`âŒ Error adding resource: ${error.message}`);
      
      // Fallback to localStorage only
      const id = 'local_' + Date.now();
      resources.push({ id: id, ...resource });
      resourceIds.add(id);
      saveResourcesToLocalStorage();
      
      // Update UI
      renderResources();
      renderAllResources();
      updateStats();
      
      showNotification("Resource saved to local storage (Firebase offline)", "warning");
      console.log(`ğŸ’¾ Resource saved to localStorage: ${title}`);
    }
  }
}

// ========== DELETE FUNCTIONS ==========
async function deleteAnnouncement(id) {
  if (!currentClassCode) return;
  
  if (confirm("Delete this announcement?")) {
    if (isDemoMode) {
      // Delete from localStorage
      announcements = announcements.filter(a => a.id !== id);
      announcementIds.delete(id);
      saveAnnouncementsToLocalStorage();
      
      // Update UI
      renderAnnouncements();
      renderAllAnnouncements();
      updateStats();
      
      showNotification("Announcement deleted (Demo Mode)", "success");
      console.log(`ğŸ—‘ï¸ Announcement deleted: ${id}`);
    } else {
      try {
        await database.ref('announcements/' + currentClassCode + '/' + id).remove();
        
        // Also delete from local state
        announcements = announcements.filter(a => a.id !== id);
        announcementIds.delete(id);
        saveAnnouncementsToLocalStorage();
        
        // Update UI
        renderAnnouncements();
        renderAllAnnouncements();
        updateStats();
        
        showNotification("Announcement deleted", "success");
        console.log(`ğŸ—‘ï¸ Announcement deleted: ${id}`);
      } catch (error) {
        console.error(`âŒ Error deleting announcement: ${error.message}`);
        
        // Fallback: delete from localStorage only
        announcements = announcements.filter(a => a.id !== id);
        announcementIds.delete(id);
        saveAnnouncementsToLocalStorage();
        
        // Update UI
        renderAnnouncements();
        renderAllAnnouncements();
        updateStats();
        
        showNotification("Announcement deleted from local storage", "warning");
        console.log(`ğŸ’¾ Announcement deleted from localStorage: ${id}`);
      }
    }
  }
}

async function deleteAssignment(id) {
  if (!currentClassCode) return;
  
  if (confirm("Delete this assignment?")) {
    if (isDemoMode) {
      // Delete from localStorage
      assignments = assignments.filter(a => a.id !== id);
      saveAssignmentsToLocalStorage();
      
      // Update UI
      renderAssignments();
      renderAllAssignments();
      updateStats();
      
      showNotification("Assignment deleted (Demo Mode)", "success");
      console.log(`ğŸ—‘ï¸ Assignment deleted: ${id}`);
    } else {
      try {
        await database.ref('assignments/' + currentClassCode + '/' + id).remove();
        
        // Also delete from localStorage
        assignments = assignments.filter(a => a.id !== id);
        saveAssignmentsToLocalStorage();
        
        // Update UI
        renderAssignments();
        renderAllAssignments();
        updateStats();
        
        showNotification("Assignment deleted", "success");
        console.log(`ğŸ—‘ï¸ Assignment deleted: ${id}`);
      } catch (error) {
        console.error(`âŒ Error deleting assignment: ${error.message}`);
        
        // Fallback: delete from localStorage only
        assignments = assignments.filter(a => a.id !== id);
        saveAssignmentsToLocalStorage();
        
        // Update UI
        renderAssignments();
        renderAllAssignments();
        updateStats();
        
        showNotification("Assignment deleted from local storage", "warning");
        console.log(`ğŸ’¾ Assignment deleted from localStorage: ${id}`);
      }
    }
  }
}

async function deleteResource(id) {
  if (!currentClassCode) return;
  
  if (confirm("Delete this resource?")) {
    if (isDemoMode) {
      // Delete from localStorage
      resources = resources.filter(r => r.id !== id);
      resourceIds.delete(id);
      saveResourcesToLocalStorage();
      
      // Update UI
      renderResources();
      renderAllResources();
      updateStats();
      
      showNotification("Resource deleted (Demo Mode)", "success");
      console.log(`ğŸ—‘ï¸ Resource deleted: ${id}`);
    } else {
      try {
        await database.ref('resources/' + currentClassCode + '/' + id).remove();
        
        // Also delete from local state
        resources = resources.filter(r => r.id !== id);
        resourceIds.delete(id);
        saveResourcesToLocalStorage();
        
        // Update UI
        renderResources();
        renderAllResources();
        updateStats();
        
        showNotification("Resource deleted", "success");
        console.log(`ğŸ—‘ï¸ Resource deleted: ${id}`);
      } catch (error) {
        console.error(`âŒ Error deleting resource: ${error.message}`);
        
        // Fallback: delete from localStorage only
        resources = resources.filter(r => r.id !== id);
        resourceIds.delete(id);
        saveResourcesToLocalStorage();
        
        // Update UI
        renderResources();
        renderAllResources();
        updateStats();
        
        showNotification("Resource deleted from local storage", "warning");
        console.log(`ğŸ’¾ Resource deleted from localStorage: ${id}`);
      }
    }
  }
}

// ========== REALTIME LISTENERS ==========
function setupRealtimeListeners() {
  if (!currentClassCode || isDemoMode) return;
  
  console.log(`ğŸ‘‚ Setting up realtime listeners for class: ${currentClassCode} (Teacher: ${teacherId})`);
  
  // Remove any existing listeners first
  if (database && database.ref) {
    try {
      database.ref(`classes/${currentClassCode}/students`).off();
      database.ref(`announcements/${currentClassCode}`).off();
      database.ref(`assignments/${currentClassCode}`).off();
      database.ref(`resources/${currentClassCode}`).off();
      database.ref(`polls/${currentClassCode}`).off();
      if (activityRef) {
        activityRef.off();
      }
    } catch (e) {
      console.log("No existing listeners to remove");
    }
  }
  
  // Listen for students - CRITICAL FIX: Proper student loading
  database.ref(`classes/${currentClassCode}/students`).on('value', (snapshot) => {
    updateSyncStatus("Live", "success");
    
    if (!snapshot.exists()) {
      console.log(`ğŸ“­ No students at classes/${currentClassCode}/students`);
      if (students.length === 0) {
        renderStudents();
        updateStats();
      }
      return;
    }
    
    const newStudents = [];
    snapshot.forEach(child => {
      const studentId = child.key;
      const studentData = child.val();
      
      // CRITICAL FIX: Filter out teacher's own ID
      if (studentId !== teacherId) {
        newStudents.push({
          id: studentId,
          name: studentData.name || studentData.userName || 'Student ' + studentId.substr(0, 6),
          streak: studentData.streak || 0,
          totalMinutes: studentData.totalMinutes || 0,
          totalStudyHours: studentData.totalStudyHours || 
                           (studentData.totalMinutes ? (studentData.totalMinutes / 60).toFixed(1) : '0.0'),
          points: studentData.points || Math.floor((studentData.totalMinutes || 0) / 60) * 100 || 0,
          lastActive: studentData.lastActive || studentData.updatedAt || 'Unknown',
          isTeacher: false
        });
      } else {
        console.warn(`âš ï¸ Teacher's ID detected in students list (real-time): ${studentId}`);
      }
    });
    
    students = newStudents;
    students.sort((a, b) => (b.points || 0) - (a.points || 0));
    renderStudents();
    updateStats();
    console.log(`ğŸ‘¥ Real-time students updated: ${students.length} students`);
  });
  
  // Listen for announcements
  database.ref(`announcements/${currentClassCode}`).on('value', (snapshot) => {
    if (snapshot.exists()) {
      const newAnnouncements = [];
      snapshot.forEach(child => {
        const annId = child.key;
        if (!announcementIds.has(annId)) {
          newAnnouncements.push({ id: annId, ...child.val() });
          announcementIds.add(annId);
        }
      });
      
      if (newAnnouncements.length > 0) {
        announcements = [...newAnnouncements, ...announcements.filter(a => !newAnnouncements.some(n => n.id === a.id))];
        announcements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        saveAnnouncementsToLocalStorage();
        renderAnnouncements();
        renderAllAnnouncements();
        updateStats();
      }
    }
  });
  
  // Listen for assignments
  database.ref(`assignments/${currentClassCode}`).on('value', (snapshot) => {
    if (snapshot.exists()) {
      assignments = [];
      snapshot.forEach(child => {
        assignments.push({ id: child.key, ...child.val() });
      });
      assignments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      saveAssignmentsToLocalStorage();
      renderAssignments();
      renderAllAssignments();
      updateStats();
    }
  });
  
  // Listen for resources
  database.ref(`resources/${currentClassCode}`).on('value', (snapshot) => {
    if (snapshot.exists()) {
      const newResources = [];
      snapshot.forEach(child => {
        const resId = child.key;
        if (!resourceIds.has(resId)) {
          newResources.push({ id: resId, ...child.val() });
          resourceIds.add(resId);
        }
      });
      
      if (newResources.length > 0) {
        resources = [...resources.filter(r => !newResources.some(n => n.id === r.id)), ...newResources];
        resources.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        saveResourcesToLocalStorage();
        renderResources();
        renderAllResources();
        updateStats();
      }
    }
  });
  
  // Listen for polls
  database.ref(`polls/${currentClassCode}`).on('value', (snapshot) => {
    if (snapshot.exists()) {
      polls = [];
      snapshot.forEach(child => {
        const pol = { id: child.key, ...child.val() };
        polls.push(pol);
        pollIds.add(pol.id);
      });
      polls.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      savePollsToLocalStorage();
      renderPolls();
    } else {
      polls = [];
      renderPolls();
    }
  });
  
  console.log(`âœ… Realtime listeners set up for class: ${currentClassCode}`);
}

// ========== RENDER FUNCTIONS ==========
function renderAllData() {
  renderStudents();
  renderAnnouncements();
  renderAssignments();
  renderResources();
  renderPolls();
  renderLiveActivity();
}

function renderStudents() {
  const studentsList = document.getElementById('studentsList');
  const allStudentsList = document.getElementById('allStudentsList');
  
  if (!studentsList && !allStudentsList) return;
  
  const studentsHTML = students.map(student => {
    return `
      <div class="student-item" style="${student.isTeacher ? 'border-left: 4px solid var(--warning); background: rgba(245, 158, 11, 0.1);' : ''}">
        <div class="student-header">
          <div class="student-info">
            <h4>${student.name} ${student.isTeacher ? 'ğŸ‘¨â€ğŸ«' : ''}</h4>
            <div class="student-id">ID: ${student.id.substr(0, 8)}...</div>
          </div>
          <div class="streak-badge">
            ğŸ”¥ ${student.streak || 0}
          </div>
        </div>
        <div class="student-stats">
          <div class="stat-pill">
            <div class="stat-pill-value">${student.totalStudyHours || '0.0'}h</div>
            <div class="stat-pill-label">Hours</div>
          </div>
          <div class="stat-pill">
            <div class="stat-pill-value">${student.points || 0}</div>
            <div class="stat-pill-label">Points</div>
          </div>
          <div class="stat-pill">
            <div class="stat-pill-value">${formatShortDate(student.lastActive)}</div>
            <div class="stat-pill-label">Last Active</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  if (students.length === 0) {
    const emptyHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ‘¥</div>
        <div class="empty-state-title">No students yet</div>
        <div class="empty-state-description">Share your class code with students to get started!</div>
      </div>
    `;
    if (studentsList) studentsList.innerHTML = emptyHTML;
    if (allStudentsList) allStudentsList.innerHTML = emptyHTML;
  } else {
    const recentStudents = students.slice(0, 4);
    if (studentsList) studentsList.innerHTML = recentStudents.map(student => {
      return `
        <div class="student-item" style="${student.isTeacher ? 'border-left: 4px solid var(--warning); background: rgba(245, 158, 11, 0.1);' : ''}">
          <div class="student-header">
            <div class="student-info">
              <h4>${student.name} ${student.isTeacher ? 'ğŸ‘¨â€ğŸ«' : ''}</h4>
              <div class="student-id">ID: ${student.id.substr(0, 8)}...</div>
            </div>
            <div class="streak-badge">
              ğŸ”¥ ${student.streak || 0}
            </div>
          </div>
          <div class="student-stats">
            <div class="stat-pill">
              <div class="stat-pill-value">${student.totalStudyHours || '0.0'}h</div>
              <div class="stat-pill-label">Hours</div>
            </div>
            <div class="stat-pill">
              <div class="stat-pill-value">${student.points || 0}</div>
              <div class="stat-pill-label">Points</div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    if (allStudentsList) allStudentsList.innerHTML = studentsHTML;
  }
}

function renderAnnouncements() {
  const announcementsList = document.getElementById('announcementsList');
  const allAnnouncementsList = document.getElementById('allAnnouncementsList');
  
  if (!announcementsList && !allAnnouncementsList) return;
  
  if (announcements.length === 0) {
    const emptyHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“¢</div>
        <div class="empty-state-title">No announcements yet</div>
        <div class="empty-state-description">Create your first announcement!</div>
      </div>
    `;
    if (announcementsList) announcementsList.innerHTML = emptyHTML;
    if (allAnnouncementsList) allAnnouncementsList.innerHTML = emptyHTML;
  } else {
    const recentAnnouncements = announcements.slice(0, 3);
    if (announcementsList) {
      announcementsList.innerHTML = recentAnnouncements.map(ann => `
        <div class="item">
          <div class="item-header">
            <div class="item-title">${ann.title || 'Announcement'}</div>
            <div class="item-date">${formatDate(ann.createdAt)}</div>
          </div>
          <div class="item-content">${ann.content || ''}</div>
          <div class="item-actions">
            <button class="delete-btn" onclick="deleteAnnouncement('${ann.id}')">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    if (allAnnouncementsList) {
      allAnnouncementsList.innerHTML = announcements.map(ann => `
        <div class="item">
          <div class="item-header">
            <div class="item-title">${ann.title || 'Announcement'}</div>
            <div class="item-date">${formatDate(ann.createdAt)}</div>
          </div>
          <div class="item-content">${ann.content || ''}</div>
          <div class="item-actions">
            <button class="delete-btn" onclick="deleteAnnouncement('${ann.id}')">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `).join('');
    }
  }
}

function renderAssignments() {
  const assignmentsList = document.getElementById('assignmentsList');
  const allAssignmentsList = document.getElementById('allAssignmentsList');
  
  if (!assignmentsList && !allAssignmentsList) return;
  
  if (assignments.length === 0) {
    const emptyHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“š</div>
        <div class="empty-state-title">No assignments yet</div>
        <div class="empty-state-description">Create your first assignment!</div>
      </div>
    `;
    if (assignmentsList) assignmentsList.innerHTML = emptyHTML;
    if (allAssignmentsList) allAssignmentsList.innerHTML = emptyHTML;
  } else {
    const recentAssignments = assignments.slice(0, 3);
    if (assignmentsList) {
      assignmentsList.innerHTML = recentAssignments.map(assignment => `
        <div class="item">
          <div class="item-header">
            <div class="item-title">${assignment.title || 'Assignment'}</div>
            <div class="item-date">Due: ${formatDate(assignment.dueDate)}</div>
          </div>
          <div class="item-content">${assignment.description || ''}</div>
          <div class="item-actions">
            <button class="delete-btn" onclick="deleteAssignment('${assignment.id}')">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    if (allAssignmentsList) {
      allAssignmentsList.innerHTML = assignments.map(assignment => `
        <div class="assignment-card">
          <div class="assignment-card-header">
            <div class="assignment-card-title">${assignment.title || 'Assignment'}</div>
            <div class="assignment-card-due">Due: ${formatDate(assignment.dueDate)}</div>
          </div>
          <div class="assignment-card-description">${assignment.description || ''}</div>
          <div class="assignment-card-actions">
            <button class="btn btn-danger" onclick="deleteAssignment('${assignment.id}')">ğŸ—‘ï¸ Delete</button>
          </div>
        </div>
      `).join('');
    }
  }
}

function renderAllAssignments() {
  renderAssignments();
}

function renderResources() {
  // Resources rendering is handled by renderAllResources
}

function renderAllResources() {
  const allResourcesList = document.getElementById('allResourcesList');
  
  if (!allResourcesList) return;
  
  if (resources.length === 0) {
    allResourcesList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“</div>
        <div class="empty-state-title">No resources yet</div>
        <div class="empty-state-description">Add your first learning resource!</div>
      </div>
    `;
  } else {
    allResourcesList.innerHTML = resources.map(res => `
      <div class="item">
        <div class="item-header">
          <div class="item-title">${res.title || 'Resource'}</div>
          <div class="item-date">${formatDate(res.createdAt)}</div>
        </div>
        <div class="item-content">
          <a href="${res.url}" target="_blank" style="color: var(--accent); text-decoration: none; font-weight: 600;">ğŸ”— ${res.url}</a>
          ${res.description ? `<p style="margin-top:0.75rem; color: var(--text-muted);">${res.description}</p>` : ''}
        </div>
        <div class="item-actions">
          <button class="delete-btn" onclick="deleteResource('${res.id}')">ğŸ—‘ï¸ Delete</button>
        </div>
      </div>
    `).join('');
  }
}

function renderPolls() {
  const pollsList = document.getElementById('pollsList');
  if (!pollsList) return;
  
  const visiblePolls = polls.filter(p => !p.isArchived);
  
  if (visiblePolls.length === 0) {
    pollsList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ—³ï¸</div>
        <div class="empty-state-title">No polls yet</div>
        <div class="empty-state-description">Create your first poll to collect student feedback.</div>
      </div>
    `;
    return;
  }
  
  const sorted = [...visiblePolls].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  pollsList.innerHTML = sorted.map(pol => {
    const results = pol.results || {};
    const totalVotes = Object.values(results).reduce((sum, v) => sum + (Number(v) || 0), 0);
    const optionsHtml = (pol.options || []).map((opt, idx) => {
      const count = Number(results[idx] || 0);
      const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
      return `
        <div style="margin-bottom: var(--spacing-sm);">
          <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.25rem;">
            <span>${opt}</span>
            <span>${count} (${percent}%)</span>
          </div>
          <div style="height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden;">
            <div style="height: 100%; width: ${percent}%; background: var(--gradient-primary);"></div>
          </div>
        </div>
      `;
    }).join('');
    
    return `
      <div class="item" style="border-left: 4px solid var(--accent); background: var(--card);">
        <div class="item-header">
          <div class="item-title">${pol.question || 'Class Poll'}</div>
          <div class="item-date">${formatDate(pol.createdAt)}</div>
        </div>
        <div class="item-content">
          ${optionsHtml}
          <div style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: var(--text-muted);">
            Total votes: <strong>${totalVotes}</strong>
          </div>
          <div style="margin-top: var(--spacing-sm); font-size: 0.875rem; color: ${pol.isActive ? 'var(--success)' : 'var(--text-muted)'};">
            Status: <strong>${pol.isActive ? 'Open' : 'Closed'}</strong>
          </div>
        </div>
        <div class="item-actions" style="gap: var(--spacing-sm); flex-wrap: wrap;">
          ${pol.isActive ? `<button class="btn btn-warning" onclick="closePoll('${pol.id}')">â›” Close Poll</button>` : ''}
          <button class="btn btn-secondary" onclick="archivePoll('${pol.id}')">ğŸ“¦ Archive</button>
          <button class="btn btn-danger" onclick="deletePoll('${pol.id}')">ğŸ—‘ï¸ Delete</button>
        </div>
      </div>
    `;
  }).join('');
}

function createPoll(question, options) {
  const results = {};
  options.forEach((_, idx) => {
    results[idx] = 0;
  });
  
  return {
    question,
    options,
    results,
    teacherId: teacherId,
    teacherName: teacherName,
    createdAt: new Date().toISOString(),
    classCode: currentClassCode,
    isActive: true
  };
}

async function addPoll() {
  const question = document.getElementById('pollQuestion')?.value.trim();
  const option1 = document.getElementById('pollOption1')?.value.trim();
  const option2 = document.getElementById('pollOption2')?.value.trim();
  const option3 = document.getElementById('pollOption3')?.value.trim();
  
  if (!question) {
    showNotification("Please enter a poll question", "error");
    return;
  }
  
  const options = [option1, option2, option3].filter(Boolean);
  if (options.length < 2) {
    showNotification("Please provide at least two options", "error");
    return;
  }
  
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  const poll = createPoll(question, options);
  
  if (isDemoMode) {
    const id = 'poll_' + Date.now();
    polls.unshift({ id: id, ...poll });
    pollIds.add(id);
    savePollsToLocalStorage();
    renderPolls();
    showNotification("Poll shared with students (Demo Mode)", "success");
  } else {
    try {
      const newPollRef = database.ref(`polls/${currentClassCode}`).push();
      await newPollRef.set(poll);
      // Realtime listener will populate the list
      showNotification("Poll shared with students", "success");
    } catch (error) {
      console.error(`âŒ Error adding poll: ${error.message}`);
      const id = 'local_' + Date.now();
      polls.unshift({ id: id, ...poll });
      pollIds.add(id);
      savePollsToLocalStorage();
      renderPolls();
      showNotification("Poll saved to local storage (Firebase offline)", "warning");
    }
  }
  
  if (document.getElementById('pollQuestion')) document.getElementById('pollQuestion').value = '';
  if (document.getElementById('pollOption1')) document.getElementById('pollOption1').value = '';
  if (document.getElementById('pollOption2')) document.getElementById('pollOption2').value = '';
  if (document.getElementById('pollOption3')) document.getElementById('pollOption3').value = '';
  hideCreatePollForm();
}

async function closePoll(pollId) {
  if (!currentClassCode) return;
  
  const poll = polls.find(p => p.id === pollId);
  if (!poll) return;
  
  poll.isActive = false;
  poll.isArchived = poll.isArchived || false;
  renderPolls();
  
  if (isDemoMode) {
    savePollsToLocalStorage();
    return;
  }
  
  try {
    await database.ref(`polls/${currentClassCode}/${pollId}`).update({ isActive: false });
  } catch (error) {
    console.error("Error closing poll:", error);
  }
}

async function archivePoll(pollId) {
  if (!currentClassCode) return;
  
  const poll = polls.find(p => p.id === pollId);
  if (!poll) return;
  
  poll.isArchived = true;
  poll.isActive = false;
  renderPolls();
  
  if (isDemoMode) {
    savePollsToLocalStorage();
    return;
  }
  
  try {
    await database.ref(`polls/${currentClassCode}/${pollId}`).update({ isArchived: true, isActive: false });
  } catch (error) {
    console.error("Error archiving poll:", error);
  }
}

async function deletePoll(pollId) {
  if (!currentClassCode) return;
  
  if (!confirm("Delete this poll?")) return;
  
  polls = polls.filter(p => p.id !== pollId);
  pollIds.delete(pollId);
  renderPolls();
  
  if (isDemoMode) {
    savePollsToLocalStorage();
    return;
  }
  
  try {
    await database.ref(`polls/${currentClassCode}/${pollId}`).remove();
  } catch (error) {
    console.error("Error deleting poll:", error);
  }
}

function renderAllAnnouncements() {
  renderAnnouncements();
}

function renderLiveActivity() {
  const activityFeed = document.getElementById('activityFeed');
  if (!activityFeed) return;
  
  if (!liveActivity.length) {
    activityFeed.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸŸ¢</div>
        <div class="empty-state-title">No live activity yet</div>
        <div class="empty-state-description">Activity will appear as students study, complete assignments, or build streaks.</div>
      </div>
    `;
    return;
  }
  
  activityFeed.innerHTML = liveActivity.map(item => {
    const icon = getActivityIcon(item.type);
    const message = item.message || buildActivityMessage(item);
    const timeLabel = formatActivityTime(item.createdAt);
    
    return `
      <div class="activity-item">
        <div class="activity-icon">${icon}</div>
        <div class="activity-content">
          <div class="activity-title">${message}</div>
          <div class="activity-meta">
            <span>${timeLabel}</span>
            ${item.classCode ? `<span>â€¢ ${item.classCode}</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderAnalytics() {
    // Check if analytics section elements exist
  if (!document.getElementById('analytics')) {
    return; // Analytics section not loaded yet
  }
  
 
  if (!analyticsSummary || !topPerformers) return;
  
  if (students.length === 0) {
    analyticsSummary.innerHTML = "No student data available yet.";
    topPerformers.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“Š</div>
        <div class="empty-state-title">No data yet</div>
        <div class="empty-state-description">Wait for students to join and start studying</div>
      </div>
    `;
    return;
  }
  
  // Calculate analytics (excluding teacher from calculations)
  const realStudents = students.filter(s => !s.isTeacher);
  const totalStudents = realStudents.length;
  const totalHours = realStudents.reduce((sum, student) => sum + parseFloat(student.totalStudyHours || 0), 0);
  const avgHours = totalStudents > 0 ? totalHours / totalStudents : 0;
  const totalStreak = realStudents.reduce((sum, student) => sum + (student.streak || 0), 0);
  const avgStreak = totalStudents > 0 ? Math.round(totalStreak / totalStudents) : 0;
  
  const today = new Date().toISOString().split('T')[0];
  const dailyActive = realStudents.filter(s => {
    if (!s.lastActive || s.lastActive === 'Unknown') return false;
    return s.lastActive.includes(today);
  }).length;
  const dailyActivePercent = totalStudents > 0 ? Math.round((dailyActive / totalStudents) * 100) : 0;
  
  // Update bars
  const dailyActiveEl = document.getElementById('dailyActive');
  const dailyActiveBar = document.getElementById('dailyActiveBar');
  const assignmentCompletionEl = document.getElementById('assignmentCompletion');
  const assignmentCompletionBar = document.getElementById('assignmentCompletionBar');
  const avgStudyHoursEl = document.getElementById('avgStudyHours');
  const avgStudyHoursBar = document.getElementById('avgStudyHoursBar');
  
  if (dailyActiveEl) dailyActiveEl.textContent = dailyActivePercent + '%';
  if (dailyActiveBar) dailyActiveBar.style.width = dailyActivePercent + '%';
  if (assignmentCompletionEl) assignmentCompletionEl.textContent = 'N/A';
  if (assignmentCompletionBar) assignmentCompletionBar.style.width = '50%';
  if (avgStudyHoursEl) avgStudyHoursEl.textContent = avgHours.toFixed(1) + 'h';
  if (avgStudyHoursBar) avgStudyHoursBar.style.width = Math.min(avgHours * 10, 100) + '%';
  
  // Update streak bars
  const streakValues = realStudents.slice(0, 5).map(s => s.streak || 0);
  const maxStreak = Math.max(...streakValues, 1);
  streakValues.forEach((streak, i) => {
    const bar = document.getElementById(`streakBar${i + 1}`);
    if (bar) {
      const height = Math.round((streak / maxStreak) * 100);
      bar.style.height = height + 'px';
    }
  });
    
  // Update summary
  analyticsSummary.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm);">
      <div>Total Students: <strong>${totalStudents}</strong></div>
      <div>Total Study Hours: <strong>${totalHours.toFixed(1)}h</strong></div>
      <div>Average Streak: <strong>${avgStreak} days</strong></div>
      <div>Daily Active: <strong>${dailyActive}/${totalStudents}</strong></div>
    </div>
  `;
  
  // Show top performers (excluding teacher)
  const topStudents = [...realStudents].sort((a, b) => (b.points || 0) - (a.points || 0)).slice(0, 5);
  topPerformers.innerHTML = topStudents.map((student, index) => `
    <div style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); background: var(--bg); border-radius: var(--radius); margin-bottom: var(--spacing-sm);">
      <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent); min-width: 30px;">
        ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `#${index + 1}`}
      </div>
      <div style="flex: 1;">
        <div style="font-weight: 600;">${student.name}</div>
        <div style="font-size: 0.875rem; color: var(--text-muted);">
          ${student.totalStudyHours || '0.0'}h â€¢ ğŸ”¥ ${student.streak || 0} â€¢ â­ ${student.points || 0}
        </div>
      </div>
    </div>
  `).join('');
}


// ========== FIXED ENGAGEMENT HEATMAP (AGGREGATE) ==========
async function getAggregateHeatmap() {
  if (!currentClassCode) return null;
  
  console.log(`ğŸ“Š Generating aggregate heatmap for class: ${currentClassCode}`);
  
  try {
    // Generate simulated activity data (since real data may not exist)
    console.log("Generating simulated heatmap data...");
    const activity = generateHeatmapActivityData();
    
    // Process the activity data
    const dateCounts = {};
    const daySlotCounts = Array.from({ length: 7 }, () => Array(4).fill(0));
    let total = 0;
    
    if (!activity || Object.keys(activity).length === 0) {
      console.log("No activity data available for heatmap");
      return { dateCounts, daySlotCounts, total: 0 };
    }
    
    Object.values(activity).forEach(evt => {
      if (!evt) return;
      
      let timestamp = evt.createdAt || evt.date || evt.timestamp;
      if (!timestamp) return;
      
      const d = new Date(timestamp);
      if (Number.isNaN(d.getTime())) return;
      
      // Format date as YYYY-MM-DD
      const dateKey = formatDateKey(d);
      dateCounts[dateKey] = (dateCounts[dateKey] || 0) + 1;
      
      // Get day of week (0=Sunday, 6=Saturday)
      const day = d.getDay();
      // Get time slot: 0=Night, 1=Morning, 2=Afternoon, 3=Evening
      const slot = getDaySlot(d.getHours());
      daySlotCounts[day][slot] += 1;
      
      total += 1;
    });
    
    console.log(`âœ… Processed ${total} activity entries for heatmap`);
    return { dateCounts, daySlotCounts, total };
    
  } catch (error) {
    console.error(`âŒ Error in getAggregateHeatmap: ${error.message}`);
    return { dateCounts: {}, daySlotCounts: Array.from({ length: 7 }, () => Array(4).fill(0)), total: 0 };
  }
}

// Generate realistic heatmap activity data
function generateHeatmapActivityData() {
  const demoData = {};
  const now = new Date();
  const studentNames = students.filter(s => !s.isTeacher).map(s => s.name) || ['Student 1', 'Student 2', 'Student 3', 'Student 4'];
  
  if (studentNames.length === 0) {
    studentNames.push('Demo Student');
  }
  
  // Generate activity for the last 90 days
  for (let i = 0; i < 90; i++) {
    const activityDate = new Date(now);
    activityDate.setDate(activityDate.getDate() - i);
    
    // Generate 0-5 activities per day (more on weekdays)
    const dayOfWeek = activityDate.getDay();
    const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
    const maxActivities = isWeekday ? 5 : 3;
    const activityCount = Math.floor(Math.random() * maxActivities);
    
    for (let j = 0; j < activityCount; j++) {
      const activityId = `heatmap_${i}_${j}`;
      const sessionTime = new Date(activityDate);
      
      // Assign time based on day of week
      let hour;
      if (dayOfWeek === 1 || dayOfWeek === 3) { // Monday or Wednesday
        hour = 8 + Math.floor(Math.random() * 9); // 8 AM - 5 PM
      } else if (dayOfWeek === 2 || dayOfWeek === 4) { // Tuesday or Thursday
        hour = 14 + Math.floor(Math.random() * 6); // 2 PM - 8 PM
      } else if (dayOfWeek === 5) { // Friday
        hour = 10 + Math.floor(Math.random() * 6); // 10 AM - 4 PM
      } else { // Weekend
        hour = 13 + Math.floor(Math.random() * 8); // 1 PM - 9 PM
      }
      
      sessionTime.setHours(hour, Math.floor(Math.random() * 60), 0, 0);
      
      demoData[activityId] = {
        type: 'timer_started',
        studentName: studentNames[Math.floor(Math.random() * studentNames.length)],
        createdAt: sessionTime.toISOString(),
        duration: Math.floor(Math.random() * 60) + 15,
        classCode: currentClassCode || 'DEMO123'
      };
    }
  }
  
  console.log(`âœ… Generated ${Object.keys(demoData).length} heatmap activity entries`);
  return demoData;
}

function buildCalendarRange(weeks = 12) {
  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const start = new Date(end);
  start.setDate(start.getDate() - (weeks * 7 - 1));
  const startOfWeek = new Date(start);
  startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
  return { start: startOfWeek, end };
}

function getCalendarLevel(count, max) {
  if (!max || count === 0) return 0;
  const ratio = count / max;
  if (ratio >= 0.85) return 4;
  if (ratio >= 0.6) return 3;
  if (ratio >= 0.35) return 2;
  if (ratio >= 0.15) return 1;
  return 0;
}

function getInsightText(daySlotCounts, total) {
  if (!total || !daySlotCounts || daySlotCounts.length === 0) {
    return "Free insights: No class activity yet. Students will appear here when they start studying.";
  }
  
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const timeNames = ['Night (12AM-6AM)', 'Morning (6AM-12PM)', 'Afternoon (12PM-6PM)', 'Evening (6PM-12AM)'];
  
  // Find the highest activity time slot
  let bestDay = 0;
  let bestSlot = 0;
  let bestCount = -1;
  let totalByDay = Array(7).fill(0);
  let totalBySlot = Array(4).fill(0);
  
  daySlotCounts.forEach((row, dayIdx) => {
    row.forEach((count, slotIdx) => {
      totalByDay[dayIdx] += count;
      totalBySlot[slotIdx] += count;
      
      if (count > bestCount) {
        bestCount = count;
        bestDay = dayIdx;
        bestSlot = slotIdx;
      }
    });
  });
  
  // Find overall patterns
  const mostActiveDay = totalByDay.reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
  const mostActiveSlot = totalBySlot.reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
  
  // Calculate percentages
  const dayPercentage = Math.round((totalByDay[mostActiveDay] / total) * 100);
  const slotPercentage = Math.round((totalBySlot[mostActiveSlot] / total) * 100);
  
  // Generate insights based on patterns
  const insights = [];
  
  if (totalBySlot[1] > totalBySlot[2] && totalBySlot[1] > totalBySlot[3]) {
    insights.push("Class prefers morning study sessions");
  } else if (totalBySlot[2] > totalBySlot[1] && totalBySlot[2] > totalBySlot[3]) {
    insights.push("Class favors afternoon study times");
  } else if (totalBySlot[3] > totalBySlot[1] && totalBySlot[3] > totalBySlot[2]) {
    insights.push("Evenings are the most popular study time");
  }
  
  if (totalByDay[1] + totalByDay[2] + totalByDay[3] + totalByDay[4] > 
      totalByDay[0] + totalByDay[5] + totalByDay[6]) {
    insights.push("Weekdays see more activity than weekends");
  }
  
  if (totalByDay[5] + totalByDay[6] > totalByDay[0] + totalByDay[1]) {
    insights.push("Weekend study sessions are common");
  }
  
  // Default insight if none generated
  if (insights.length === 0) {
    insights.push(`Class studies most on ${dayNames[mostActiveDay]} ${timeNames[mostActiveSlot].toLowerCase()}`);
  }
  
  return `Free insights: ${insights.join(". ")}`;
}
function formatDateKey(dateObj) {
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function getDaySlot(hour) {
  if (hour >= 6 && hour < 12) return 1; // Morning
  if (hour >= 12 && hour < 17) return 2; // Afternoon
  if (hour >= 17 && hour <= 23) return 3; // Evening
  return 0; // Night
}

function buildCalendarRange(weeks = 12) {
  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const start = new Date(end);
  start.setDate(start.getDate() - (weeks * 7 - 1));
  const startOfWeek = new Date(start);
  startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
  return { start: startOfWeek, end };
}

function getCalendarLevel(count, max) {
  if (!max || count === 0) return 0;
  const ratio = count / max;
  if (ratio >= 0.85) return 4;
  if (ratio >= 0.6) return 3;
  if (ratio >= 0.35) return 2;
  if (ratio >= 0.15) return 1;
  return 0;
}

function getInsightText(daySlotCounts, total) {
  if (!total || !daySlotCounts || daySlotCounts.length === 0) {
    return "Free insights: No class activity yet. Students will appear here when they start studying.";
  }
  
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const timeNames = ['Night (12AM-6AM)', 'Morning (6AM-12PM)', 'Afternoon (12PM-6PM)', 'Evening (6PM-12AM)'];
  
  // Find the highest activity time slot
  let bestDay = 0;
  let bestSlot = 0;
  let bestCount = -1;
  let totalByDay = Array(7).fill(0);
  let totalBySlot = Array(4).fill(0);
  
  daySlotCounts.forEach((row, dayIdx) => {
    row.forEach((count, slotIdx) => {
      totalByDay[dayIdx] += count;
      totalBySlot[slotIdx] += count;
      
      if (count > bestCount) {
        bestCount = count;
        bestDay = dayIdx;
        bestSlot = slotIdx;
      }
    });
  });
  
  // Find overall patterns
  const mostActiveDay = totalByDay.reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
  const mostActiveSlot = totalBySlot.reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
  
  // Generate insights based on patterns
  const insights = [];
  
  if (totalBySlot[1] > totalBySlot[2] && totalBySlot[1] > totalBySlot[3]) {
    insights.push("Class prefers morning study sessions");
  } else if (totalBySlot[2] > totalBySlot[1] && totalBySlot[2] > totalBySlot[3]) {
    insights.push("Class favors afternoon study times");
  } else if (totalBySlot[3] > totalBySlot[1] && totalBySlot[3] > totalBySlot[2]) {
    insights.push("Evenings are the most popular study time");
  }
  
  if (totalByDay[1] + totalByDay[2] + totalByDay[3] + totalByDay[4] > 
      totalByDay[0] + totalByDay[5] + totalByDay[6]) {
    insights.push("Weekdays see more activity than weekends");
  }
  
  // Default insight if none generated
  if (insights.length === 0) {
    insights.push(`Class studies most on ${dayNames[mostActiveDay]} ${timeNames[mostActiveSlot].toLowerCase()}`);
  }
  
  return `Free insights: ${insights.join(". ")}`;
}



function initializeSidebarHeatmap() {
  // Only render sidebar heatmap
  const sidebarContainer = document.getElementById('aggregateHeatmapSidebar');
  const sidebarInsight = document.getElementById('aggregateInsightSidebar');
  
  if (!sidebarContainer || !sidebarInsight) return;
  
  // Show loading state
  sidebarContainer.innerHTML = `
    <div style="text-align: center; padding: var(--spacing-sm); color: var(--text-muted);">
      <div>Loading heatmap...</div>
    </div>
  `;
  
  // Load and render heatmap
  setTimeout(() => {
    renderAggregateHeatmap();
  }, 500); // Small delay to ensure everything is loaded
}





async function renderAggregateHeatmap() {
  // Only render sidebar heatmap
  const sidebarContainer = document.getElementById('aggregateHeatmapSidebar');
  const sidebarInsight = document.getElementById('aggregateInsightSidebar');
  
  if (!sidebarContainer || !sidebarInsight) return;
  
  const data = await getAggregateHeatmap();
  const { dateCounts = {}, daySlotCounts = [], total = 0 } = data || {};
  
  // If no data, show empty state
  if (!data || total === 0) {
    sidebarContainer.innerHTML = `
      <div style="text-align: center; padding: var(--spacing-sm); color: var(--text-muted);">
        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ“Š</div>
        <div style="font-size: 0.75rem;">No activity data yet</div>
      </div>
    `;
    sidebarInsight.textContent = "Class activity will appear when students study.";
    return;
  }
  
  // Build calendar for sidebar (show 12 weeks)
  const { start, end } = buildCalendarRange(12);
  const dates = [];
  const cursor = new Date(start);
  while (cursor <= end) {
    dates.push(new Date(cursor));
    cursor.setDate(cursor.getDate() + 1);
  }
  
  // Get max value for coloring
  const counts = Object.values(dateCounts);
  const max = counts.length > 0 ? Math.max(...counts) : 1;
  
  // Group by weeks
  const weeks = [];
  for (let i = 0; i < dates.length; i += 7) {
    weeks.push(dates.slice(i, i + 7));
  }
  
  // Generate month labels (for sidebar, only show first letter)
  const monthLabels = weeks.map((week, idx) => {
    const first = week[0];
    if (!first) return '';
    const isFirst = idx === 0;
    const prev = idx > 0 ? weeks[idx - 1][0] : null;
    const show = isFirst || (prev && prev.getMonth() !== first.getMonth());
    return show ? first.toLocaleDateString('en-US', { month: 'short' }).charAt(0) : '';
  });
  
  // Generate weekday labels (single letter for sidebar)
  const weekdayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  
  // Generate calendar HTML for sidebar
  const calendarHtml = `
    <div class="calendar-heatmap">
      <div class="calendar-heatmap-header">
        <div></div>
        <div class="calendar-months">
          ${monthLabels.map(label => `<span class="calendar-month-label">${label}</span>`).join('')}
        </div>
      </div>
      <div class="calendar-heatmap-body">
        <div class="calendar-weekday-labels">
          ${weekdayLabels.map(label => `<span>${label}</span>`).join('')}
        </div>
        <div class="calendar-grid">
          ${weeks.map(week => week.map(date => {
            const key = formatDateKey(date);
            const count = dateCounts[key] || 0;
            const level = getCalendarLevel(count, max);
            const title = `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${count} activities`;
            return `<div class="calendar-day level-${level}" title="${title}"></div>`;
          }).join('')).join('')}
        </div>
      </div>
    </div>
    <div class="aggregate-heatmap-legend">
      <span>Less</span>
      <span class="legend-dot level-0"></span>
      <span class="legend-dot level-1"></span>
      <span class="legend-dot level-2"></span>
      <span class="legend-dot level-3"></span>
      <span class="legend-dot level-4"></span>
      <span>More</span>
    </div>
  `;
  
  const insightText = getInsightText(daySlotCounts, total);
  
  sidebarContainer.innerHTML = calendarHtml;
  sidebarInsight.textContent = insightText;
}




async function renderAggregateHeatmap() {
  // Only render sidebar heatmap
  const sidebarContainer = document.getElementById('aggregateHeatmapSidebar');
  const sidebarInsight = document.getElementById('aggregateInsightSidebar');
  
  if (!sidebarContainer || !sidebarInsight) return;
  
  const data = await getAggregateHeatmap();
  const { dateCounts = {}, daySlotCounts = [], total = 0 } = data || {};
  
  // If no data, show empty state
  if (!data || total === 0) {
    sidebarContainer.innerHTML = `
      <div class="empty-state" style="padding: var(--spacing-sm); text-align: center;">
        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ“Š</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">No activity data yet</div>
      </div>
    `;
    sidebarInsight.textContent = "Class activity will appear when students study.";
    return;
  }
  
  // Build calendar for sidebar (show fewer weeks for sidebar)
  const { start, end } = buildCalendarRange(12); // Show 12 weeks in sidebar
  const dates = [];
  const cursor = new Date(start);
  while (cursor <= end) {
    dates.push(new Date(cursor));
    cursor.setDate(cursor.getDate() + 1);
  }
  
  // Get max value for coloring
  const counts = Object.values(dateCounts);
  const max = counts.length > 0 ? Math.max(...counts) : 1;
  
  // Group by weeks
  const weeks = [];
  for (let i = 0; i < dates.length; i += 7) {
    weeks.push(dates.slice(i, i + 7));
  }
  
  // Generate month labels (for sidebar, only show first letter)
  const monthLabels = weeks.map((week, idx) => {
    const first = week[0];
    if (!first) return '';
    const isFirst = idx === 0;
    const prev = idx > 0 ? weeks[idx - 1][0] : null;
    const show = isFirst || (prev && prev.getMonth() !== first.getMonth());
    return show ? first.toLocaleDateString('en-US', { month: 'short' }).charAt(0) : '';
  });
  
  // Generate weekday labels (single letter for sidebar)
  const weekdayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  
  // Generate calendar HTML for sidebar
  const calendarHtml = `
    <div class="calendar-heatmap">
      <div class="calendar-heatmap-header">
        <div></div>
        <div class="calendar-months">
          ${monthLabels.map(label => `<span class="calendar-month-label">${label}</span>`).join('')}
        </div>
      </div>
      <div class="calendar-heatmap-body">
        <div class="calendar-weekday-labels">
          ${weekdayLabels.map(label => `<span>${label}</span>`).join('')}
        </div>
        <div class="calendar-grid">
          ${weeks.map(week => week.map(date => {
            const key = formatDateKey(date);
            const count = dateCounts[key] || 0;
            const level = getCalendarLevel(count, max);
            const title = `${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${count} activities`;
            return `<div class="calendar-day level-${level}" title="${title}"></div>`;
          }).join('')).join('')}
        </div>
      </div>
    </div>
  `;
  
  const insightText = getInsightText(daySlotCounts, total);
  
  sidebarContainer.innerHTML = calendarHtml;
  sidebarInsight.textContent = insightText;
  
  // Add legend if needed
  if (!sidebarContainer.querySelector('.aggregate-heatmap-legend')) {
    const legendHtml = `
      <div class="aggregate-heatmap-legend">
        <span>Less</span>
        <span class="legend-dot level-0"></span>
        <span class="legend-dot level-1"></span>
        <span class="legend-dot level-2"></span>
        <span class="legend-dot level-3"></span>
        <span class="legend-dot level-4"></span>
        <span>More</span>
      </div>
    `;
    sidebarContainer.innerHTML += legendHtml;
  }
}
// Optional: Add this function to create a debug button
function addHeatmapDebugButton() {
  const analyticsCard = document.querySelector('#analytics .form-card:last-child');
  if (analyticsCard) {
    const debugButton = document.createElement('button');
    debugButton.className = 'btn btn-secondary';
    debugButton.textContent = 'ğŸ”„ Refresh Heatmap';
    debugButton.onclick = function() {
      console.log('Manually refreshing heatmap...');
      renderAggregateHeatmap();
    };
    
    // Insert after the heatmap
    const heatmapDiv = analyticsCard.querySelector('#aggregateHeatmap');
    if (heatmapDiv) {
      heatmapDiv.parentNode.insertBefore(debugButton, heatmapDiv.nextSibling);
    }
  }
}
// ========== ENGAGEMENT HEATMAP (AGGREGATE) ==========
async function firebaseGet(path) {
  if (!database || !database.ref) return null;
  const snap = await database.ref(path).once('value');
  return snap.exists() ? snap.val() : null;
}

function formatDateKey(dateObj) {
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function getDaySlot(hour) {
  if (hour >= 6 && hour < 12) return 1; // Morning
  if (hour >= 12 && hour < 17) return 2; // Afternoon
  if (hour >= 17 && hour <= 23) return 3; // Evening
  return 0; // Night
}

// ========== FIXED ENGAGEMENT HEATMAP (AGGREGATE) ==========

// Helper function to generate simulated activity times
function generateSimulatedActivityTimes(lastActiveDate, streak) {
  const activityTimes = [];
  const now = new Date();
  
  // Generate activity for the last N days based on streak
  const daysToGenerate = Math.min(streak, 30); // Max 30 days
  
  for (let i = 0; i < daysToGenerate; i++) {
    const activityDate = new Date(lastActiveDate);
    activityDate.setDate(activityDate.getDate() - i);
    
    // Skip future dates
    if (activityDate > now) continue;
    
    // Generate 1-3 study sessions per day
    const sessionsPerDay = Math.floor(Math.random() * 3) + 1;
    
    for (let j = 0; j < sessionsPerDay; j++) {
      const sessionTime = new Date(activityDate);
      
      // Assign a time slot: morning (8-11), afternoon (12-17), or evening (18-22)
      const timeSlot = Math.floor(Math.random() * 3); // 0=Morning, 1=Afternoon, 2=Evening
      let hour;
      
      switch(timeSlot) {
        case 0: // Morning
          hour = 8 + Math.floor(Math.random() * 4); // 8-11 AM
          break;
        case 1: // Afternoon
          hour = 12 + Math.floor(Math.random() * 6); // 12-5 PM
          break;
        case 2: // Evening
          hour = 18 + Math.floor(Math.random() * 5); // 6-10 PM
          break;
        default:
          hour = 14; // Default to 2 PM
      }
      
      sessionTime.setHours(hour, Math.floor(Math.random() * 60), 0, 0);
      activityTimes.push(sessionTime);
    }
  }
  
  return activityTimes;
}

// Generate demo activity data
function generateDemoActivityData() {
  const demoData = {};
  const now = new Date();
  
  // Generate activity for the last 90 days
  for (let i = 0; i < 90; i++) {
    const activityDate = new Date(now);
    activityDate.setDate(activityDate.getDate() - i);
    
    // Generate 0-5 activities per day (more on weekdays)
    const dayOfWeek = activityDate.getDay();
    const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
    const maxActivities = isWeekday ? 5 : 2;
    const activityCount = Math.floor(Math.random() * maxActivities);
    
    for (let j = 0; j < activityCount; j++) {
      const activityId = `demo_act_${i}_${j}`;
      const sessionTime = new Date(activityDate);
      
      // Assign time based on day of week
      let hour;
      if (dayOfWeek === 1 || dayOfWeek === 3) { // Monday or Wednesday
        hour = 9 + Math.floor(Math.random() * 8); // 9 AM - 5 PM
      } else if (dayOfWeek === 2 || dayOfWeek === 4) { // Tuesday or Thursday
        hour = 14 + Math.floor(Math.random() * 6); // 2 PM - 8 PM
      } else if (dayOfWeek === 5) { // Friday
        hour = 10 + Math.floor(Math.random() * 6); // 10 AM - 4 PM
      } else { // Weekend
        hour = 13 + Math.floor(Math.random() * 8); // 1 PM - 9 PM
      }
      
      sessionTime.setHours(hour, Math.floor(Math.random() * 60), 0, 0);
      
      demoData[activityId] = {
        type: 'timer_started',
        studentName: ['Alex Johnson', 'Sam Smith', 'Taylor Brown', 'Jordan Lee'][Math.floor(Math.random() * 4)],
        createdAt: sessionTime.toISOString(),
        duration: Math.floor(Math.random() * 60) + 15,
        classCode: currentClassCode || 'DEMO123'
      };
    }
  }
  
  console.log(`âœ… Generated ${Object.keys(demoData).length} demo activity entries`);
  return demoData;
}

function buildCalendarRange(weeks = 12) {
  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const start = new Date(end);
  start.setDate(start.getDate() - (weeks * 7 - 1));
  const startOfWeek = new Date(start);
  startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
  return { start: startOfWeek, end };
}

function getCalendarLevel(count, max) {
  if (!max || count === 0) return 0;
  const ratio = count / max;
  if (ratio >= 0.85) return 4;
  if (ratio >= 0.6) return 3;
  if (ratio >= 0.35) return 2;
  if (ratio >= 0.15) return 1;
  return 0;
}

function getInsightText(daySlotCounts, total) {
  if (!total || !daySlotCounts || daySlotCounts.length === 0) {
    return "Free insights: No class activity yet. Students will appear here when they start studying.";
  }
  
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const timeNames = ['Night (12AM-6AM)', 'Morning (6AM-12PM)', 'Afternoon (12PM-6PM)', 'Evening (6PM-12AM)'];
  
  // Find the highest activity time slot
  let bestDay = 0;
  let bestSlot = 0;
  let bestCount = -1;
  let totalByDay = Array(7).fill(0);
  let totalBySlot = Array(4).fill(0);
  
  daySlotCounts.forEach((row, dayIdx) => {
    row.forEach((count, slotIdx) => {
      totalByDay[dayIdx] += count;
      totalBySlot[slotIdx] += count;
      
      if (count > bestCount) {
        bestCount = count;
        bestDay = dayIdx;
        bestSlot = slotIdx;
      }
    });
  });
  
  // Find overall patterns
  const mostActiveDay = totalByDay.reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
  const mostActiveSlot = totalBySlot.reduce((maxIdx, val, idx, arr) => val > arr[maxIdx] ? idx : maxIdx, 0);
  
  // Calculate percentages
  const dayPercentage = Math.round((totalByDay[mostActiveDay] / total) * 100);
  const slotPercentage = Math.round((totalBySlot[mostActiveSlot] / total) * 100);
  
  // Generate insights based on patterns
  const insights = [];
  
  if (totalBySlot[1] > totalBySlot[2] && totalBySlot[1] > totalBySlot[3]) {
    insights.push("Class prefers morning study sessions");
  } else if (totalBySlot[2] > totalBySlot[1] && totalBySlot[2] > totalBySlot[3]) {
    insights.push("Class favors afternoon study times");
  } else if (totalBySlot[3] > totalBySlot[1] && totalBySlot[3] > totalBySlot[2]) {
    insights.push("Evenings are the most popular study time");
  }
  
  if (totalByDay[1] + totalByDay[2] + totalByDay[3] + totalByDay[4] > 
      totalByDay[0] + totalByDay[5] + totalByDay[6]) {
    insights.push("Weekdays see more activity than weekends");
  }
  
  if (totalByDay[5] + totalByDay[6] > totalByDay[0] + totalByDay[1]) {
    insights.push("Weekend study sessions are common");
  }
  
  // Default insight if none generated
  if (insights.length === 0) {
    insights.push(`Class studies most on ${dayNames[mostActiveDay]} ${timeNames[mostActiveSlot].toLowerCase()}`);
  }
  
  return `Free insights: ${insights.join(". ")}`;
}


function formatDateKey(dateObj) {
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function getDaySlot(hour) {
  // 0 = Night (12AM-6AM)
  // 1 = Morning (6AM-12PM)
  // 2 = Afternoon (12PM-6PM)
  // 3 = Evening (6PM-12AM)
  if (hour >= 0 && hour < 6) return 0;     // Night
  if (hour >= 6 && hour < 12) return 1;    // Morning
  if (hour >= 12 && hour < 18) return 2;   // Afternoon
  return 3;                               // Evening
}



// ========== STATISTICS FUNCTIONS ==========
function updateStats() {
  // Fix for the error: check if elements exist before updating
  try {
    const realStudents = students.filter(s => !s.isTeacher);
    const studentsCount = realStudents.length;
    const announcementsCount = announcements.length;
    const assignmentsCount = assignments.length;
    const resourcesCount = resources.length;
    
    // Update main stats
    const studentsCountEl = document.getElementById('studentsCount');
    const announcementsCountEl = document.getElementById('announcementsCount');
    const assignmentsCountEl = document.getElementById('assignmentsCount');
    const avgStreakEl = document.getElementById('avgStreak');
    
    if (studentsCountEl) studentsCountEl.textContent = studentsCount;
    if (announcementsCountEl) announcementsCountEl.textContent = announcementsCount;
    if (assignmentsCountEl) assignmentsCountEl.textContent = assignmentsCount;
    
    // Calculate average streak (excluding teacher)
    let avgStreak = 0;
    if (studentsCount > 0) {
      const totalStreak = realStudents.reduce((sum, student) => sum + (student.streak || 0), 0);
      avgStreak = Math.round(totalStreak / studentsCount);
    }
    if (avgStreakEl) avgStreakEl.textContent = avgStreak;
    
    // Update sidebar stats
    const sidebarStudentsEl = document.getElementById('sidebarStudents');
    const sidebarAssignmentsEl = document.getElementById('sidebarAssignments');
    const sidebarAnnouncementsEl = document.getElementById('sidebarAnnouncements');
    const sidebarAvgStreakEl = document.getElementById('sidebarAvgStreak');
    
    if (sidebarStudentsEl) sidebarStudentsEl.textContent = studentsCount;
    if (sidebarAssignmentsEl) sidebarAssignmentsEl.textContent = assignmentsCount;
    if (sidebarAnnouncementsEl) sidebarAnnouncementsEl.textContent = announcementsCount;
    if (sidebarAvgStreakEl) sidebarAvgStreakEl.textContent = avgStreak;
    
    // Check for class milestones after stats update
    checkClassMilestones();
    // Update the streak chain
    updateClassStreakChain(); // Add this line
  } catch (error) {
    console.error("Error updating stats:", error);
  }
}

// ========== CLASS CELEBRATION TRIGGERS ==========
let milestoneConfigCache = {};

function getDefaultMilestoneConfig() {
  return {
    totalStreakDays: 100,
    sessionsPerWeek: 50,
    perfectWeekEnabled: true
  };
}

function getMilestoneConfig() {
  if (!currentClassCode) return getDefaultMilestoneConfig();
  if (milestoneConfigCache[currentClassCode]) return milestoneConfigCache[currentClassCode];
  return loadMilestoneConfigFromLocalStorage(currentClassCode);
}

function loadMilestoneConfigFromLocalStorage(classCode) {
  try {
    const raw = localStorage.getItem(`teacher_milestones_${classCode}`);
    if (!raw) return getDefaultMilestoneConfig();
    const parsed = JSON.parse(raw);
    return {
      totalStreakDays: Number(parsed.totalStreakDays) || 100,
      sessionsPerWeek: Number(parsed.sessionsPerWeek) || 50,
      perfectWeekEnabled: parsed.perfectWeekEnabled !== false
    };
  } catch (error) {
    console.error("Error loading milestone config:", error);
    return getDefaultMilestoneConfig();
  }
}

async function loadMilestoneSettingsForClass() {
  if (!currentClassCode) return;
  
  let config = null;
  
  if (!isDemoMode && database && database.ref && teacherId && currentClassId) {
    try {
      const snap = await database.ref(`teachers/${teacherId}/classes/${currentClassId}/milestones`).once('value');
      if (snap.exists()) {
        const data = snap.val();
        config = {
          totalStreakDays: Number(data.totalStreakDays) || 100,
          sessionsPerWeek: Number(data.sessionsPerWeek) || 50,
          perfectWeekEnabled: data.perfectWeekEnabled !== false
        };
      }
    } catch (error) {
      console.error("Error loading milestone config from Firebase:", error);
    }
  }
  
  if (!config) {
    config = loadMilestoneConfigFromLocalStorage(currentClassCode);
  }
  
  milestoneConfigCache[currentClassCode] = config;
  localStorage.setItem(`teacher_milestones_${currentClassCode}`, JSON.stringify(config));
  loadMilestoneSettingsToForm();
}

async function saveMilestoneSettings() {
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  const totalStreakDays = Number(document.getElementById('milestoneTotalStreak')?.value) || 100;
  const sessionsPerWeek = Number(document.getElementById('milestoneSessionsWeek')?.value) || 50;
  const perfectWeekEnabled = document.getElementById('milestonePerfectWeek')?.checked !== false;
  
  const config = { totalStreakDays, sessionsPerWeek, perfectWeekEnabled };
  milestoneConfigCache[currentClassCode] = config;
  localStorage.setItem(`teacher_milestones_${currentClassCode}`, JSON.stringify(config));
  
  if (!isDemoMode && database && database.ref && teacherId && currentClassId) {
    try {
      await database.ref(`teachers/${teacherId}/classes/${currentClassId}/milestones`).set(config);
    } catch (error) {
      console.error("Error saving milestone config to Firebase:", error);
    }
  }
  
  showNotification("Milestone settings saved", "success");
  checkClassMilestones();
}

function loadMilestoneSettingsToForm() {
  const config = getMilestoneConfig();
  const totalEl = document.getElementById('milestoneTotalStreak');
  const sessionsEl = document.getElementById('milestoneSessionsWeek');
  const perfectEl = document.getElementById('milestonePerfectWeek');
  
  if (totalEl) totalEl.value = config.totalStreakDays;
  if (sessionsEl) sessionsEl.value = config.sessionsPerWeek;
  if (perfectEl) perfectEl.checked = !!config.perfectWeekEnabled;
}

function testCelebration() {
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  const message = "Test celebration â€” great job, class!";
  showNotification(`ğŸ‰ ${message}`, "success");
  launchConfetti();
  postSystemAnnouncement("Class Celebration (Test)", message);
}

function checkClassMilestones() {
  if (!currentClassCode) return;
  
  const config = getMilestoneConfig();
  const realStudents = students.filter(s => !s.isTeacher);
  const totalStreakDays = realStudents.reduce((sum, s) => sum + (s.streak || 0), 0);
  const now = new Date();
  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  const sessionsThisWeek = liveActivity.filter(item => {
    if (!item.createdAt) return false;
    const itemDate = new Date(item.createdAt);
    return item.type === 'timer_started' && itemDate >= sevenDaysAgo;
  }).length;
  
  const perfectWeek = realStudents.length > 0 && realStudents.every(s => {
    if (!s.lastActive || s.lastActive === 'Unknown') return false;
    return new Date(s.lastActive) >= sevenDaysAgo;
  });
  
  const milestones = [
    {
      key: 'total_streak_days',
      message: `Class has ${config.totalStreakDays}+ total streak days!`,
      condition: totalStreakDays >= config.totalStreakDays
    },
    {
      key: 'sessions_week',
      message: `${config.sessionsPerWeek}+ focus sessions this week!`,
      condition: sessionsThisWeek >= config.sessionsPerWeek
    },
    {
      key: 'perfect_week',
      message: 'Every student active this week!',
      condition: config.perfectWeekEnabled && perfectWeek
    }
  ];
  
  milestones.forEach(m => {
    if (m.condition) {
      celebrateClassMilestone(m.key, m.message);
    }
  });
}

function celebrateClassMilestone(key, message) {
  const storageKey = `teacher_milestone_${currentClassCode}_${key}`;
  const lastTriggered = localStorage.getItem(storageKey);
  
  if (lastTriggered) {
    const lastDate = new Date(lastTriggered);
    const diffDays = Math.floor((Date.now() - lastDate.getTime()) / (1000 * 60 * 60 * 24));
    if (diffDays < 7) return; // Avoid repeating within a week
  }
  
  localStorage.setItem(storageKey, new Date().toISOString());
  
  showNotification(`ğŸ‰ ${message}`, "success");
  launchConfetti();
  
  // Post an automatic announcement
  postSystemAnnouncement("Class Celebration", message);
  
  const baseActivity = {
    type: 'celebration',
    message: message,
    createdAt: new Date().toISOString(),
    classCode: currentClassCode
  };
  
  if (!isDemoMode && database && database.ref) {
    try {
      const activityRef = database.ref(`classActivity/${currentClassCode}`).push();
      const activity = { id: activityRef.key, ...baseActivity };
      activityIds.add(activity.id);
      liveActivity.unshift(activity);
      renderLiveActivity();
      activityRef.set(activity);
    } catch (error) {
      console.error("Error saving celebration activity:", error);
    }
  } else {
    const activity = { id: 'celebration_' + Date.now(), ...baseActivity };
    activityIds.add(activity.id);
    liveActivity.unshift(activity);
    renderLiveActivity();
  }
}

// ========== LIVE ACTIVITY FEED ==========
function getLiveActivity(classCode) {
  const activityFeed = document.getElementById('activityFeed');
  if (!activityFeed) return;
  
  if (!classCode) {
    liveActivity = [];
    activityIds.clear();
    renderLiveActivity();
    return;
  }
  
  if (isDemoMode) {
    if (liveActivity.length === 0) {
      createDemoActivity();
    }
    renderLiveActivity();
    return;
  }
  
  if (!database || !database.ref) return;
  
  // Reset and detach any existing listener
  if (activityRef) {
    try {
      activityRef.off();
    } catch (e) {
      console.log("No existing activity listener to remove");
    }
  }
  
  liveActivity = [];
  activityIds.clear();
  renderLiveActivity();
  
  activityRef = database.ref(`classActivity/${classCode}`).limitToLast(30);
  activityRef.on('child_added', (snapshot) => {
    const id = snapshot.key;
    if (activityIds.has(id)) return;
    
    const data = snapshot.val() || {};
    activityIds.add(id);
    
    liveActivity.unshift({
      id: id,
      type: data.type || 'activity',
      message: data.message || '',
      studentName: data.studentName || data.name || 'Student',
      duration: data.duration || data.minutes || null,
      streak: data.streak || null,
      assignmentTitle: data.assignmentTitle || data.assignment || '',
      createdAt: data.createdAt || data.timestamp || new Date().toISOString(),
      classCode: classCode
    });
    
    // Keep the list short for performance
    if (liveActivity.length > 50) {
      liveActivity = liveActivity.slice(0, 50);
    }
    
    renderLiveActivity();
    // Check milestones when new activity arrives (supports session milestones)
    checkClassMilestones();
  });
}

function getActivityIcon(type) {
  const icons = {
    timer_started: 'â±ï¸',
    streak_reached: 'ğŸ”¥',
    assignment_completed: 'âœ…',
    resource_opened: 'ğŸ“',
    celebration: 'ğŸ‰',
    activity: 'ğŸŸ¢'
  };
  return icons[type] || icons.activity;
}

function buildActivityMessage(item) {
  if (item.type === 'timer_started') {
    const minutes = item.duration ? `${item.duration}-min` : 'a study';
    return `${item.studentName} started ${minutes} timer`;
  }
  if (item.type === 'streak_reached') {
    return `${item.studentName} reached a ${item.streak || 0}-day streak`;
  }
  if (item.type === 'assignment_completed') {
    const assignment = item.assignmentTitle ? ` "${item.assignmentTitle}"` : '';
    return `${item.studentName} completed${assignment}`;
  }
  return item.message || `${item.studentName} has new activity`;
}

function formatActivityTime(dateString) {
  if (!dateString) return 'Just now';
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / 60000);
    if (diffMinutes < 1) return 'Just now';
    if (diffMinutes < 60) return `${diffMinutes}m ago`;
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch {
    return 'Just now';
  }
}

function createDemoActivity() {
  liveActivity = [
    {
      id: 'demo_act_1',
      type: 'timer_started',
      studentName: 'Alex Johnson',
      duration: 25,
      createdAt: new Date(Date.now() - 2 * 60000).toISOString()
    },
    {
      id: 'demo_act_2',
      type: 'streak_reached',
      studentName: 'Taylor Brown',
      streak: 5,
      createdAt: new Date(Date.now() - 15 * 60000).toISOString()
    },
    {
      id: 'demo_act_3',
      type: 'assignment_completed',
      studentName: 'Jordan Lee',
      assignmentTitle: 'Math Chapter 5 Exercises',
      createdAt: new Date(Date.now() - 60 * 60000).toISOString()
    }
  ];
  
  liveActivity.forEach(item => activityIds.add(item.id));
}

function updateUI() {
  if (currentClassCode && teacherClasses.length > 0) {
    const currentClass = teacherClasses[selectedClassIndex];
    const codeDisplay = document.getElementById('currentClassCodeDisplay');
    const subtitle = document.getElementById('dashboardSubtitle');
    const celebrationTip = document.getElementById('celebrationProTip');
    
    if (codeDisplay) codeDisplay.textContent = currentClass.code;
    if (subtitle) subtitle.textContent = `Managing: ${currentClass.name}`;
    if (celebrationTip) celebrationTip.style.display = 'block';
    
    // Update mobile title
    updateMobileTitle();
  } else {
    const codeDisplay = document.getElementById('currentClassCodeDisplay');
    const subtitle = document.getElementById('dashboardSubtitle');
    const celebrationTip = document.getElementById('celebrationProTip');
    
    if (codeDisplay) codeDisplay.textContent = '------';
    if (subtitle) subtitle.textContent = 'Manage your classroom';
    if (celebrationTip) celebrationTip.style.display = 'none';
    
    // Update mobile title
    document.getElementById('mobileTitle').textContent = 'Teacher Dashboard';
  }
  // Update the streak chain
    updateClassStreakChain();
}



// ========== STUDY STREAK CHAIN FUNCTIONS ==========

function updateClassStreakChain() {
    if (!currentClassCode || students.length === 0) {
        renderEmptyStreakChain();
        return;
    }
    
    // Calculate total streak days from all students (excluding teacher)
    const realStudents = students.filter(s => !s.isTeacher);
    const totalStreakDays = realStudents.reduce((sum, student) => sum + (student.streak || 0), 0);
    
    // Update chain count display
    document.getElementById('totalChainLinks').textContent = totalStreakDays;
    
    // Render the chain
    renderStreakChain(totalStreakDays);
    
    // Calculate and show progress
    updateChainProgress(totalStreakDays);
    
    // Check and update milestone
    updateChainMilestone(totalStreakDays);
}

function renderStreakChain(totalStreakDays) {
    const chainContainer = document.getElementById('streakChain');
    if (!chainContainer) return;
    
    const linksToShow = 50; // Show maximum 50 links
    const chainLinks = [];
    
    // Create completed links
    for (let i = 1; i <= Math.min(totalStreakDays, linksToShow); i++) {
        const isActive = i === totalStreakDays; // Last link is active
        chainLinks.push(createChainLink(i, 'completed', isActive));
    }
    
    // Add next pending link if we haven't reached the limit
    if (totalStreakDays < linksToShow) {
        chainLinks.push(createChainLink(totalStreakDays + 1, 'pending', false));
    }
    
    chainContainer.innerHTML = chainLinks.join('');
    
    // If chain is empty, show message
    if (totalStreakDays === 0) {
        renderEmptyStreakChain();
    }
}

function createChainLink(number, status, isActive) {
    let className = `chain-link ${status}`;
    if (isActive) className += ' active';
    
    // Add special styling for milestones
    if (number % 10 === 0 && status === 'completed') {
        className += ' milestone';
    }
    
    let content = number;
    if (number % 10 === 0 && status === 'completed') {
        content = 'â­'; // Star for every 10th link
    } else if (number % 5 === 0 && status === 'completed') {
        content = 'ğŸ”¥'; // Fire for every 5th link
    }
    
    return `
        <div class="${className}" title="${status === 'completed' ? 'Day ' + number + ' complete!' : 'Day ' + number + ' pending'}" data-day="${number}">
            ${content}
        </div>
    `;
}

function renderEmptyStreakChain() {
    const chainContainer = document.getElementById('streakChain');
    const chainCount = document.getElementById('chainCount');
    
    if (chainContainer) {
        chainContainer.innerHTML = `
            <div class="streak-chain-empty">
                <div class="streak-chain-empty-icon">ğŸ”—</div>
                <div>No streak chain yet!</div>
                <div style="font-size: 0.875rem; margin-top: var(--spacing-xs);">
                    Students need to build their streaks to add links to the chain.
                </div>
            </div>
        `;
    }
    
    if (chainCount) {
        chainCount.querySelector('#totalChainLinks').textContent = '0';
    }
}

function updateChainProgress(totalStreakDays) {
    const progressElement = document.getElementById('chainProgress');
    if (!progressElement) return;
    
    const milestone = Math.ceil(totalStreakDays / 10) * 10; // Next multiple of 10
    const progress = Math.min(100, (totalStreakDays % 10) * 10);
    
    progressElement.textContent = `Progress to next milestone: ${progress}%`;
    
    // Add visual indicator if near milestone
    if (progress >= 80) {
        progressElement.style.color = 'var(--success)';
        progressElement.style.fontWeight = '600';
    } else {
        progressElement.style.color = 'var(--text-muted)';
        progressElement.style.fontWeight = '400';
    }
}

function updateChainMilestone(totalStreakDays) {
    const milestoneElement = document.getElementById('milestoneText');
    if (!milestoneElement) return;
    
    const nextMilestone = Math.ceil(totalStreakDays / 10) * 10;
    
    if (nextMilestone === 0) {
        milestoneElement.textContent = 'Get started! The first link will appear when a student completes Day 1.';
    } else if (nextMilestone - totalStreakDays === 1) {
        milestoneElement.textContent = `Almost there! Just 1 more day to reach ${nextMilestone} links!`;
        milestoneElement.parentElement.style.borderLeftColor = 'var(--warning)';
        milestoneElement.parentElement.style.background = 'rgba(245, 158, 11, 0.1)';
    } else {
        milestoneElement.textContent = `Reach ${nextMilestone} links to unlock a special class celebration!`;
        milestoneElement.parentElement.style.borderLeftColor = 'var(--accent)';
        milestoneElement.parentElement.style.background = 'var(--accent-light)';
    }
    
    // Check if milestone reached
    if (totalStreakDays > 0 && totalStreakDays % 10 === 0) {
        celebrateChainMilestone(totalStreakDays);
    }
}

function celebrateChainMilestone(totalStreakDays) {
    const milestoneNumber = totalStreakDays / 10;
    
    // Only celebrate once per milestone
    const storageKey = `chain_milestone_${currentClassCode}_${milestoneNumber}`;
    if (localStorage.getItem(storageKey)) return;
    
    localStorage.setItem(storageKey, new Date().toISOString());
    
    // Show celebration
    showNotification(`ğŸ‰ Class Milestone! ${totalStreakDays} links in the streak chain!`, 'success');
    launchConfetti();
    
    // Post announcement
    postSystemAnnouncement(
        "Class Streak Chain Milestone!",
        `Our class chain is now ${totalStreakDays} links long! Each link represents one day of student streaks. Keep up the great work! ğŸ†`
    );
    
    // Add to activity feed
    const activity = {
        type: 'celebration',
        message: `Class reached ${totalStreakDays} links in the streak chain!`,
        createdAt: new Date().toISOString(),
        classCode: currentClassCode
    };
    
    if (!isDemoMode && database && database.ref) {
        const activityRef = database.ref(`classActivity/${currentClassCode}`).push();
        activityRef.set(activity);
    } else {
        activity.id = 'chain_milestone_' + Date.now();
        activityIds.add(activity.id);
        liveActivity.unshift(activity);
        renderLiveActivity();
    }
}

function simulateChainGrowth() {
    // For demo purposes - simulate adding a new link
    const chainContainer = document.getElementById('streakChain');
    if (!chainContainer || !chainContainer.children.length) return;
    
    // Find the next pending link
    const pendingLinks = chainContainer.querySelectorAll('.chain-link.pending');
    if (pendingLinks.length > 0) {
        const nextLink = pendingLinks[0];
        nextLink.classList.remove('pending');
        nextLink.classList.add('completed', 'new-link');
        
        // Update count
        const currentCount = parseInt(document.getElementById('totalChainLinks').textContent);
        document.getElementById('totalChainLinks').textContent = currentCount + 1;
        
        // Trigger progress update
        setTimeout(() => {
            updateClassStreakChain();
        }, 600);
    }
}



function updateMobileTitle() {
  const mobileTitle = document.getElementById('mobileTitle');
  if (!mobileTitle) return;
  
  const currentClass = teacherClasses[selectedClassIndex];
  if (currentClass) {
    mobileTitle.textContent = `${currentClass.name}`;
  } else {
    mobileTitle.textContent = 'Teacher Dashboard';
  }
}

// ========== UTILITY FUNCTIONS ==========
function formatDate(dateString) {
  if (!dateString) return 'No date';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  } catch {
    return 'Invalid date';
  }
}

function formatShortDate(dateString) {
  if (!dateString || dateString === 'Unknown') return 'Unknown';
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return "Today";
    if (diffDays === 1) return "Yesterday";
    if (diffDays < 7) return diffDays + "d ago";
    if (diffDays < 30) return Math.floor(diffDays / 7) + "w ago";
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch {
    return 'Unknown';
  }
}

// ========== CONFETTI ==========
let confettiAnimationId = null;

function resizeConfettiCanvas() {
  const canvas = document.getElementById('confettiCanvas');
  if (!canvas) return;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(window.innerWidth * dpr);
  canvas.height = Math.floor(window.innerHeight * dpr);
  canvas.style.width = '100vw';
  canvas.style.height = '100vh';
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

// Simple, working confetti function
function launchConfetti() {
    console.log("ğŸ‰ Launching confetti...");
    
    const canvas = document.getElementById('confettiCanvas');
    if (!canvas) {
        console.error("âŒ Confetti canvas not found!");
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Set canvas to full screen
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.width = '100vw';
    canvas.style.height = '100vh';
    canvas.style.position = 'fixed';
    canvas.style.top = '0';
    canvas.style.left = '0';
    canvas.style.zIndex = '99999';
    canvas.style.pointerEvents = 'none';
    canvas.style.display = 'block';
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Create confetti particles
    const confettiParticles = [];
    const particleCount = 150;
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'];
    
    for (let i = 0; i < particleCount; i++) {
        confettiParticles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 10 + 5,
            d: Math.random() * particleCount + 10,
            color: colors[Math.floor(Math.random() * colors.length)],
            tilt: Math.floor(Math.random() * 10) - 10,
            tiltAngleIncremental: Math.random() * 0.07 + 0.05,
            tiltAngle: 0
        });
    }
    
    let animationFrame;
    let startTime = Date.now();
    
    function drawConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let remainingParticles = 0;
        
        confettiParticles.forEach(p => {
            // Update particle position
            p.tiltAngle += p.tiltAngleIncremental;
            p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2;
            p.x += Math.sin(p.d);
            p.tilt = Math.sin(p.tiltAngle) * 15;
            
            // Draw particle
            ctx.beginPath();
            ctx.lineWidth = p.r / 2;
            ctx.strokeStyle = p.color;
            ctx.moveTo(p.x + p.tilt + p.r / 4, p.y);
            ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 4);
            ctx.stroke();
            
            // Check if particle is still on screen
            if (p.y <= canvas.height) {
                remainingParticles++;
            }
        });
        
        // Stop animation after 3 seconds or when all particles are gone
        if (Date.now() - startTime < 3000 && remainingParticles > 0) {
            animationFrame = requestAnimationFrame(drawConfetti);
        } else {
            cancelAnimationFrame(animationFrame);
            setTimeout(() => {
                canvas.style.display = 'none';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }, 500);
        }
    }
    
    drawConfetti();
}



function showNotification(message, type = "info") {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  let icon = 'ğŸ’¡';
  if (type === 'success') icon = 'âœ…';
  if (type === 'error') icon = 'âŒ';
  if (type === 'warning') icon = 'âš ï¸';
  if (type === 'info') icon = 'â„¹ï¸';
  
  toast.innerHTML = `
    <span style="font-size: 1.5rem;">${icon}</span>
    <div style="flex: 1;">
      <div style="font-weight: 700;">${message}</div>
      <div style="font-size: 0.875rem; opacity: 0.8;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
    </div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function updateSyncStatus(text, type = "info") {
  try {
    const syncStatus = document.getElementById('syncStatus');
    if (!syncStatus) {
      console.log(`Sync status: ${text} (${type})`);
      return;
    }
    
    // Clear and set new content
    syncStatus.textContent = text;
    syncStatus.className = `sync-status ${type}`;
    syncStatus.style.display = 'flex';
    
    // Add icon as first child
    let icon = 'â³';
    if (type === 'success') icon = 'âœ…';
    if (type === 'error') icon = 'âŒ';
    if (type === 'warning') icon = 'âš ï¸';
    if (type === 'info') icon = 'â„¹ï¸';
    
    syncStatus.innerHTML = `<span style="margin-right: 8px;">${icon}</span> ${text}`;
    
    if (type === 'success') {
      setTimeout(() => {
        if (syncStatus) {
          syncStatus.style.opacity = '0';
          setTimeout(() => {
            if (syncStatus) {
              syncStatus.style.display = 'none';
              syncStatus.style.opacity = '1';
            }
          }, 300);
        }
      }, 2000);
    }
  } catch (error) {
    console.error("Error updating sync status:", error);
  }
}

function changeTheme(theme) {
  document.body.className = theme;
  localStorage.setItem('teacherTheme', theme);
  showNotification(`Switched to ${theme} theme`, "success");
}

function copyClassCode() {
  if (!currentClassCode) {
    showNotification("No class selected", "error");
    return;
  }
  
  navigator.clipboard.writeText(currentClassCode).then(() => {
    showNotification("Class code copied to clipboard!", "success");
    console.log(`ğŸ“‹ Class code copied: ${currentClassCode}`);
  });
}

async function refreshStudents() {
  if (!currentClassCode) {
    showNotification("Please select a class first", "error");
    return;
  }
  
  showNotification("Refreshing student list...", "info");
  updateSyncStatus("Refreshing...", "syncing");
  
  if (isDemoMode) {
    // For demo mode, just re-render
    setTimeout(() => {
      renderStudents();
      updateStats();
      showNotification(`Refreshed: ${students.length} students (Demo Mode)`, "success");
      updateSyncStatus("Refreshed", "success");
    }, 500);
  } else {
    try {
      console.log(`ğŸ”„ Manually refreshing students for class: ${currentClassCode}`);
      
      // Try multiple paths
      let snapshot = await database.ref(`classes/${currentClassCode}/students`).once('value');
      
      if (!snapshot.exists()) {
        console.log(`âš ï¸ No students at main path, trying alternative...`);
        snapshot = await database.ref(`classStudents/${currentClassCode}`).once('value');
      }
      
      if (snapshot.exists()) {
        const newStudents = [];
        snapshot.forEach(child => {
          const studentId = child.key;
          const studentData = child.val();
          
          if (studentId !== teacherId) {
            newStudents.push({
              id: studentId,
              name: studentData.name || studentData.userName || 'Student ' + studentId.substr(0, 6),
              streak: studentData.streak || 0,
              totalMinutes: studentData.totalMinutes || 0,
              totalStudyHours: studentData.totalStudyHours || 
                               (studentData.totalMinutes ? (studentData.totalMinutes / 60).toFixed(1) : '0.0'),
              points: studentData.points || Math.floor((studentData.totalMinutes || 0) / 60) * 100 || 0,
              lastActive: studentData.lastActive || studentData.updatedAt || 'Unknown',
              isTeacher: false
            });
          }
        });
        
        students = newStudents;
        students.sort((a, b) => (b.points || 0) - (a.points || 0));
        renderStudents();
        updateStats();
        
        if (students.length > 0) {
          showNotification(`Refreshed: Found ${students.length} student(s)`, "success");
          console.log("âœ… Students found:", students.map(s => s.name));
        } else {
          showNotification("No students found in this class", "info");
          console.log("â„¹ï¸ No students found after refresh");
        }
        
        updateSyncStatus("Refreshed", "success");
      } else {
        students = [];
        renderStudents();
        updateStats();
        showNotification("No students found", "info");
        updateSyncStatus("No students", "info");
        console.log("âŒ No students found in Firebase after checking all paths");
      }
    } catch (error) {
      console.error(`âŒ Error refreshing students: ${error.message}`);
      console.error(error.stack);
      showNotification("Failed to refresh from Firebase: " + error.message, "error");
      updateSyncStatus("Refresh failed", "error");
    }
  }
}

function searchStudents() {
  const term = document.getElementById('studentSearch').value.toLowerCase();
  
  if (!term) {
    renderStudents();
    return;
  }
  
  const filteredStudents = students.filter(s => 
    (s.name && s.name.toLowerCase().includes(term)) || 
    (s.id && s.id.toLowerCase().includes(term))
  );
  
  const container = document.getElementById('studentsList');
  
  if (!container) return;
  
  if (filteredStudents.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ”</div>
        <div class="empty-state-title">No students found</div>
        <div class="empty-state-description">Try a different search term</div>
      </div>
    `;
    return;
  }
  
  const studentsHTML = filteredStudents.map(student => {
    return `
      <div class="student-item" style="${student.isTeacher ? 'border-left: 4px solid var(--warning); background: rgba(245, 158, 11, 0.1);' : ''}">
        <div class="student-header">
          <div class="student-info">
            <h4>${student.name} ${student.isTeacher ? 'ğŸ‘¨â€ğŸ«' : ''}</h4>
            <div class="student-id">ID: ${student.id.substr(0, 8)}...</div>
          </div>
          <div class="streak-badge">
            ğŸ”¥ ${student.streak || 0}
          </div>
        </div>
        <div class="student-stats">
          <div class="stat-pill">
            <div class="stat-pill-value">${student.totalStudyHours || '0.0'}h</div>
            <div class="stat-pill-label">Hours</div>
          </div>
          <div class="stat-pill">
            <div class="stat-pill-value">${student.points || 0}</div>
            <div class="stat-pill-label">Points</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = studentsHTML;
}

// ========== NAVIGATION ==========
function showSection(sectionId) {
  currentSection = sectionId;
  
  // Update active nav item
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
   if (sectionId === 'create-challenge') {
        resetChallengeForm(); // Reset form when navigating to create page
    }
  // Find the clicked nav item and activate it
  const navItems = document.querySelectorAll('.nav-item');
  for (let item of navItems) {
    if (item.textContent.includes(getNavItemText(sectionId))) {
      item.classList.add('active');
      break;
    }
  }
  
  // Hide all sections
  document.querySelectorAll('.dashboard-content').forEach(section => {
    section.style.display = 'none';
  });
  
  // Show selected section
  const sectionElement = document.getElementById(sectionId);
  if (sectionElement) {
    sectionElement.style.display = 'block';
  }
  
  // Update header
  updateDashboardHeader(sectionId);
  
  // Load specific data for section
  if (sectionId === 'announcements') {
    renderAllAnnouncements();
  } else if (sectionId === 'assignments') {
    renderAllAssignments();
  } else if (sectionId === 'resources') {
    renderAllResources();
  } else if (sectionId === 'polls') {
    renderPolls();
  } else if (sectionId === 'students') {
    renderStudents();
  } else if (sectionId === 'analytics') {
    renderAnalytics();
  }else if (sectionId === 'challenges') { // Add this
        filterChallenges('all');
    }
  
  console.log(`ğŸ“± Switched to section: ${sectionId}`);
}

function getNavItemText(sectionId) {
  const navTexts = {
    'dashboard': 'ğŸ“Š',
    'announcements': 'ğŸ“¢',
    'assignments': 'ğŸ“š',
    'resources': 'ğŸ“',
    'polls': 'ğŸ—³ï¸',
    'students': 'ğŸ‘¥',
    'analytics': 'ğŸ“ˆ',
    'settings': 'âš™ï¸'
  };
  return navTexts[sectionId] || '';
}

function updateDashboardHeader(sectionId) {
  const header = document.getElementById('dashboardHeader');
  const subtitle = document.getElementById('dashboardSubtitle');
  
  if (!header || !subtitle) return;
  
  switch(sectionId) {
    case 'dashboard':
      header.querySelector('h1').textContent = 'Welcome to Your Classroom';
      subtitle.textContent = 'Manage announcements, assignments, and track student progress';
      break;
    case 'announcements':
      header.querySelector('h1').textContent = 'Announcements';
      subtitle.textContent = 'Manage and create class announcements';
      break;
    case 'assignments':
      header.querySelector('h1').textContent = 'Assignments';
      subtitle.textContent = 'Create and manage class assignments';
      break;
    case 'resources':
      header.querySelector('h1').textContent = 'Learning Resources';
      subtitle.textContent = 'Share resources with your students';
      break;
    case 'polls':
      header.querySelector('h1').textContent = 'Class Polls';
      subtitle.textContent = 'Create and share quick polls with students';
      break;
    case 'students':
      header.querySelector('h1').textContent = 'Students';
      subtitle.textContent = 'View and manage student progress';
      break;
    case 'analytics':
      header.querySelector('h1').textContent = 'Class Analytics';
      subtitle.textContent = 'Track student performance and engagement';
      break;
    case 'settings':
      header.querySelector('h1').textContent = 'Teacher Settings';
      subtitle.textContent = 'Manage your account and preferences';
      break;
  }
}

// ========== SETTINGS FUNCTIONS ==========
function saveTeacherSettings() {
  const name = document.getElementById('teacherName').value.trim();
  const email = document.getElementById('teacherEmail').value.trim();
  
  if (!name) {
    showNotification("Please enter your name", "error");
    return;
  }
  
  teacherName = name;
  
  // Save to localStorage
  localStorage.setItem('teacherName', teacherName);
  if (email) localStorage.setItem('teacherEmail', email);
  
  showNotification("Settings saved successfully!", "success");
}

function backupData() {
  const allData = {
    backupDate: new Date().toISOString(),
    version: "1.0",
    teacher: {
      id: teacherId,
      name: teacherName,
      classes: teacherClasses
    },
    currentClass: {
      code: currentClassCode,
      students: students,
      announcements: announcements,
      assignments: assignments,
      resources: resources
    }
  };
  
  const dataStr = JSON.stringify(allData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  const exportFileDefaultName = `teacher-backup-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showNotification("Backup created successfully", "success");
}

function restoreData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const backupData = JSON.parse(e.target.result);
        
        if (confirm("Restore backup? This will overwrite current data.")) {
          // Restore data
          if (backupData.teacher) {
            teacherName = backupData.teacher.name || teacherName;
            teacherClasses = backupData.teacher.classes || teacherClasses;
          }
          
          if (backupData.currentClass) {
            if (backupData.currentClass.code === currentClassCode) {
              students = backupData.currentClass.students || students;
              announcements = backupData.currentClass.announcements || announcements;
              assignments = backupData.currentClass.assignments || assignments;
              resources = backupData.currentClass.resources || resources;
              
              // Save to localStorage
              saveAnnouncementsToLocalStorage();
              saveAssignmentsToLocalStorage();
              saveResourcesToLocalStorage();
            }
          }
          
          // Update UI
          updateClassSelector();
          updateUI();
          renderAllData();
          updateStats();
          
          showNotification("Backup restored successfully!", "success");
        }
      } catch (error) {
        console.error("Error restoring backup:", error);
        showNotification("Invalid backup file", "error");
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

function exportAllData() {
  const allData = {
    exportDate: new Date().toISOString(),
    version: "1.0",
    teacher: {
      id: teacherId,
      name: teacherName,
      email: currentUser?.email || '',
      classes: teacherClasses
    },
    allClasses: {}
  };
  
  // Add data for each class
  teacherClasses.forEach(cls => {
    allData.allClasses[cls.code] = {
      name: cls.name,
      students: loadFromLocalStorageForClass('students', cls.code) || [],
      announcements: loadFromLocalStorageForClass('announcements', cls.code) || [],
      assignments: loadFromLocalStorageForClass('assignments', cls.code) || [],
      resources: loadFromLocalStorageForClass('resources', cls.code) || []
    };
  });
  
  const dataStr = JSON.stringify(allData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  const exportFileDefaultName = `teacher-data-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showNotification("All data exported successfully", "success");
}

function loadFromLocalStorageForClass(key, classCode) {
  try {
    const data = localStorage.getItem(`teacher_${key}_${classCode}`);
    if (data) {
      return JSON.parse(data);
    }
  } catch (error) {
    console.error(`Error loading ${key} for class ${classCode}:`, error);
  }
  return [];
}

function clearAllData() {
  if (confirm("âš ï¸ This will delete ALL your data including classes, students, announcements, assignments, and resources. This cannot be undone! Continue?")) {
    // Clear localStorage
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith('teacher_') || key === 'teacherTheme' || key === 'teacherName' || key === 'teacherEmail') {
        keysToRemove.push(key);
      }
    }
    
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    // Reset variables
    teacherClasses = [];
    currentClassCode = null;
    currentClassId = null;
    selectedClassIndex = -1;
    students = [];
    announcements = [];
    assignments = [];
    resources = [];
    polls = [];
    announcementIds.clear();
    resourceIds.clear();
    pollIds.clear();
    
    // Reset form fields
    document.getElementById('teacherName').value = '';
    document.getElementById('teacherEmail').value = '';
    
    // Update UI
    updateClassSelector();
    updateUI();
    renderAllData();
    updateStats();
    
    showNotification("All data cleared", "info");
  }
}

function exportAnalytics() {
  const realStudents = students.filter(s => !s.isTeacher);
  const analyticsData = {
    exportDate: new Date().toISOString(),
    class: currentClassCode,
    students: realStudents.map(s => ({
      name: s.name,
      streak: s.streak,
      totalStudyHours: s.totalStudyHours,
      points: s.points,
      lastActive: s.lastActive
    })),
    stats: {
      totalStudents: realStudents.length,
      totalStudyHours: realStudents.reduce((sum, s) => sum + parseFloat(s.totalStudyHours || 0), 0),
      averageStreak: realStudents.length > 0 ? Math.round(realStudents.reduce((sum, s) => sum + (s.streak || 0), 0) / realStudents.length) : 0,
      topPerformer: realStudents.length > 0 ? realStudents[0].name : 'N/A'
    }
  };
  
  const dataStr = JSON.stringify(analyticsData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  const exportFileDefaultName = `analytics-${currentClassCode}-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showNotification("Analytics exported successfully", "success");
}

// ========== PAGE INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
  console.log("ğŸ‘©â€ğŸ« Teacher Mode loaded");
 // setTimeout(setupInsightChatbot, 2000); // Remove or comment out this line
setTimeout(createTeacherChatbot, 2000); // Use this instead if you want the chatbot
  // Ensure clean separation first
  ensureBrowserSeparation();
  
  // Set theme from localStorage
  const savedTheme = localStorage.getItem('teacherTheme') || 'light';
  changeTheme(savedTheme);
  
  // Set theme selector value
  const themeSelector = document.querySelector('.theme-selector');
  if (themeSelector) {
    themeSelector.value = savedTheme;
  }
  
  // Load teacher name
  teacherName = localStorage.getItem('teacherName') || 'Teacher';
  const teacherNameField = document.getElementById('teacherName');
  if (teacherNameField) teacherNameField.value = teacherName;
  
  // Prepare confetti canvas
  resizeConfettiCanvas();
  
  // Initialize Firebase
  initializeFirebase().then(() => {
    console.log("âœ… Firebase initialized successfully");
    
    if (!isDemoMode) {
      // Set up auth state listener
      auth.onAuthStateChanged((user) => {
        console.log(`ğŸ” Auth state changed: ${user ? "User logged in" : "User logged out"}`);
        
        if (user) {
          currentUser = user;
          teacherId = user.uid;
          console.log(`âœ… User authenticated: ${user.uid}`);
          
          // Hide login modal, show dashboard
          document.getElementById('loginModal').style.display = 'none';
          document.querySelector('.app-layout').style.display = 'grid';
          const demoModeBtn = document.getElementById('demoModeBtn');
          if (demoModeBtn) demoModeBtn.style.display = 'none';
          
          // Show mobile header on smaller screens
          if (window.innerWidth <= 1020) {
            document.querySelector('.mobile-header').style.display = 'flex';
          }
          
          // Show sidebar toggle button
          updateSidebarToggleVisibility();
          
          // Initialize teacher dashboard
          initializeTeacher();
        } else {
          console.log("No user signed in");
          // Show login modal
          document.getElementById('loginModal').style.display = 'flex';
          document.querySelector('.app-layout').style.display = 'none';
          document.querySelector('.mobile-header').style.display = 'none';
          document.querySelector('.sidebar-toggle').style.display = 'none';
        }
      });
    }
  }).catch(error => {
    console.error(`âŒ Failed to initialize Firebase: ${error.message}`);
    showNotification("Firebase initialization failed. Use Demo Mode.", "warning");
  });
  
  // Close modals when clicking outside or pressing ESC
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });
  });
  
  // Close modals with ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
    }
  });
  
  // Handle window resize
  window.addEventListener('resize', function() {
    resizeConfettiCanvas();
    // Update sidebar toggle button visibility
    updateSidebarToggleVisibility();
    
    // Auto-show sidebar on resize to larger screens if it was collapsed
    if (window.innerWidth > 1020) {
      const sidebar = document.querySelector('.sidebar');
      const sidebarToggle = document.querySelector('.sidebar-toggle');
      const appLayout = document.querySelector('.app-layout');
      
      if (sidebar && sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
        sidebarToggle.innerHTML = 'â†';
        sidebarToggle.title = 'Open Sidebar';
        sidebarToggle.style.left = '260px';
        sidebarToggle.style.background = 'var(--accent)';
      }
      
      // Restore desktop sidebar state
      if (appLayout && isSidebarCollapsed) {
        appLayout.classList.add('sidebar-collapsed');
        sidebarToggle.innerHTML = 'â†’';
        sidebarToggle.title = 'Show Sidebar';
        sidebarToggle.style.left = '20px';
      } else if (appLayout) {
        appLayout.classList.remove('sidebar-collapsed');
        sidebarToggle.innerHTML = 'â†';
        sidebarToggle.title = 'Hide Sidebar';
        sidebarToggle.style.left = '260px';
      }
    } else {
      // On mobile, ensure sidebar is hidden initially and toggle button is positioned correctly
      const sidebar = document.querySelector('.sidebar');
      const sidebarToggle = document.querySelector('.sidebar-toggle');
      
      if (sidebar && sidebar.classList.contains('active')) {
        sidebarToggle.style.left = 'calc(280px - 18px)';
        sidebarToggle.style.background = 'var(--danger)';
      } else {
        sidebarToggle.style.left = '20px';
        sidebarToggle.style.background = 'var(--accent)';
      }
    }
  });
});

// ========== CLEANUP FUNCTION ==========
async function cleanupTeacherFromStudents() {
    if (!currentClassCode || !teacherId) return;
    
    try {
        // Check if teacher ID is in students list
        const teacherStudentRef = database.ref(`classes/${currentClassCode}/students/${teacherId}`);
        const snapshot = await teacherStudentRef.once('value');
        
        if (snapshot.exists()) {
            console.log(`âš ï¸ Found teacher ID in students list for class ${currentClassCode}, removing...`);
            await teacherStudentRef.remove();
            console.log(`âœ… Removed teacher from students list`);
            
            // Also update the students array
            students = students.filter(s => s.id !== teacherId);
            renderStudents();
            updateStats();
        }
    } catch (error) {
        console.error("Error cleaning up teacher from students:", error);
    }
}
// ========== FEEDBACK FORM ==========
function openFeedbackForm() {
    window.open('https://docs.google.com/forms/d/e/1FAIpQLScJMM1dwIx3HvSu9mxyZm3HgZ7UO7QwLX673JKellaKLSM7EQ/viewform?usp=publish-editor', '_blank');
}
// Add to all pages (guard analytics when SDK isn't loaded)
if (firebase.analytics) {
  firebase.analytics().logEvent('page_view', { page_location: window.location.href });
}

// ========== TEACHER MODE AI CHATBOT (Real Student Analysis) ==========
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(createTeacherChatbot, 2000); // Wait a bit longer for data to load
});

async function createTeacherChatbot() {
    if (document.getElementById('teacherChatbotBtn')) return;
    
    const feedbackBtn = document.querySelector('.feedback-btn');
    let feedbackBottom = 20;
    
    if (feedbackBtn) {
        const rect = feedbackBtn.getBoundingClientRect();
        feedbackBottom = window.innerHeight - rect.top + 15;
    }
    
    const chatbotContainer = document.createElement('div');
    chatbotContainer.className = 'teacher-chatbot-fab';
    chatbotContainer.innerHTML = `
        <div class="teacher-chatbot-bubble" id="teacherChatbotBubble">
            <div class="bubble-header">
                <span class="bubble-icon">ğŸ¤–</span>
                <span class="bubble-title">AI Teaching Assistant</span>
            </div>
            <div class="bubble-message">Analyzing student data...</div>
            <div class="bubble-stats" id="chatbotStats"></div>
        </div>
        <button class="teacher-chatbot-btn" id="teacherChatbotBtn" aria-label="AI Teaching Assistant">
            <img class="teacher-chatbot-img" src="ai-chatbot-transparent.png" alt="AI Teaching Assistant">
        </button>
    `;
    
    document.body.appendChild(chatbotContainer);
    
    const styles = `
        /* Teacher Mode Chatbot - Bottom Right - BIG IMAGE */
        .teacher-chatbot-fab {
            position: fixed !important;
            right: 30px !important;
            bottom: ${feedbackBottom + 20}px !important;
            z-index: 9998 !important;
            display: flex !important;
            flex-direction: column-reverse !important;
            align-items: flex-end !important;
            gap: 20px !important;
        }
        
        .teacher-chatbot-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: 3px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 22px !important;
            padding: 20px !important;
            width: 380px !important;
            max-width: 380px !important;
            min-height: 160px !important;
            opacity: 0 !important;
            transform: translateX(30px) scale(0.95) !important;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
            box-shadow: 0 12px 35px rgba(0,0,0,0.3), 
                        0 0 0 1px rgba(255, 255, 255, 0.15) inset !important;
            font-family: 'Poppins', sans-serif !important;
            pointer-events: none !important;
            margin-bottom: 15px !important;
            overflow: hidden !important;
        }
        
        .teacher-chatbot-bubble.show {
            opacity: 1 !important;
            transform: translateX(0) scale(1) !important;
        }
        
        .bubble-header {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            margin-bottom: 10px !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .bubble-icon {
            font-size: 28px !important;
            animation: pulse 2s infinite !important;
        }
        
        .bubble-title {
            font-size: 18px !important;
            font-weight: 800 !important;
            letter-spacing: 0.5px !important;
            text-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        }
        
        .bubble-message {
            font-size: 15px !important;
            font-weight: 500 !important;
            line-height: 1.6 !important;
            position: relative !important;
            z-index: 1 !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
            margin-bottom: 10px !important;
        }
        
        .bubble-stats {
            font-size: 13px !important;
            color: rgba(255, 255, 255, 0.9) !important;
            border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
            padding-top: 8px !important;
            margin-top: 8px !important;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* BIGGER CHATBOT IMAGE */
        .teacher-chatbot-btn {
            width: 200px !important;
            height: 200px !important;
            border: none !important;
            background: transparent !important;
            cursor: pointer !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            order: 1 !important;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4)) !important;
        }
        
        .teacher-chatbot-btn:hover {
            transform: scale(1.1) rotate(3deg) !important;
            filter: drop-shadow(0 10px 20px rgba(102, 126, 234, 0.5)) !important;
        }
        
        .teacher-chatbot-img {
            width: 200px !important;
            height: 200px !important;
            object-fit: contain !important;
            border-radius: 0 !important;
            animation: floatAnimation 3s ease-in-out infinite !important;
            transition: all 0.3s ease !important;
        }
        
        .teacher-chatbot-btn:hover .teacher-chatbot-img {
            filter: brightness(1.15) saturate(1.4) !important;
        }
        
        @keyframes floatAnimation {
            0%, 100% { 
                transform: translateY(0) rotate(0deg); 
            }
            33% { 
                transform: translateY(-15px) rotate(-1deg); 
            }
            66% { 
                transform: translateY(8px) rotate(1deg); 
            }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .teacher-chatbot-fab {
                right: 15px !important;
                bottom: ${feedbackBottom + 15}px !important;
            }
            
            .teacher-chatbot-bubble {
                width: 320px !important;
                max-width: 320px !important;
                min-height: 140px !important;
            }
            
            .teacher-chatbot-btn {
                width: 160px !important;
                height: 160px !important;
            }
            
            .teacher-chatbot-img {
                width: 160px !important;
                height: 160px !important;
            }
        }
        
        @media (max-width: 480px) {
            .teacher-chatbot-fab {
                right: 10px !important;
                bottom: ${feedbackBottom + 10}px !important;
            }
            
            .teacher-chatbot-bubble {
                width: 280px !important;
                max-width: 280px !important;
                min-height: 130px !important;
            }
            
            .teacher-chatbot-btn {
                width: 140px !important;
                height: 140px !important;
            }
            
            .teacher-chatbot-img {
                width: 140px !important;
                height: 140px !important;
            }
        }
    `;
    
    const styleElement = document.createElement('style');
    styleElement.textContent = styles;
    document.head.appendChild(styleElement);
    
    // ========== REAL STUDENT DATA ANALYSIS ==========
    let currentTeacherId = null;
    let teacherClasses = [];
    
    // Get current teacher ID from localStorage or Firebase auth
    async function getTeacherData() {
        try {
            // Try to get from Firebase auth first
            if (firebase.auth().currentUser) {
                currentTeacherId = firebase.auth().currentUser.uid;
            }
            
            // Fallback to localStorage
            if (!currentTeacherId) {
                const saved = localStorage.getItem('teacherId');
                if (saved && saved.startsWith('teacher_')) {
                    currentTeacherId = saved;
                }
            }
            
            return currentTeacherId;
        } catch (error) {
            console.error("Error getting teacher data:", error);
            return null;
        }
    }
    
    // Get all classes for this teacher
    async function getTeacherClasses() {
        if (!currentTeacherId) return [];
        
        try {
            const classesRef = firebase.database().ref('classes');
            const snapshot = await classesRef.once('value');
            const allClasses = snapshot.val() || {};
            
            // Filter classes where teacherId matches
            teacherClasses = [];
            for (const [classCode, classData] of Object.entries(allClasses)) {
                if (classData.teacherId === currentTeacherId) {
                    teacherClasses.push({
                        code: classCode,
                        name: classData.name || `Class ${classCode}`,
                        studentCount: classData.students ? Object.keys(classData.students).length : 0
                    });
                }
            }
            
            return teacherClasses;
        } catch (error) {
            console.error("Error getting teacher classes:", error);
            return [];
        }
    }
    
    // Get detailed student data for a specific class
    async function getClassStudents(classCode) {
        try {
            const studentsRef = firebase.database().ref(`classes/${classCode}/students`);
            const snapshot = await studentsRef.once('value');
            const studentsData = snapshot.val() || {};
            
            const students = [];
            for (const [studentId, studentData] of Object.entries(studentsData)) {
                if (!studentData.isTeacherAccount) { // Filter out teacher accounts
                    students.push({
                        id: studentId,
                        name: studentData.name || `Student ${studentId.substring(0, 6)}`,
                        streak: studentData.streak || 0,
                        totalHours: studentData.totalStudyHours || (studentData.totalMinutes / 60).toFixed(1) || 0,
                        lastActive: studentData.lastActive || null,
                        points: studentData.points || 0,
                        isActive: isStudentActive(studentData.lastActive)
                    });
                }
            }
            
            return students;
        } catch (error) {
            console.error(`Error getting students for class ${classCode}:`, error);
            return [];
        }
    }
    
    // Check if student is active (studied in last 3 days)
    function isStudentActive(lastActiveDate) {
        if (!lastActiveDate) return false;
        
        const lastActive = new Date(lastActiveDate);
        const now = new Date();
        const diffDays = Math.floor((now - lastActive) / (1000 * 60 * 60 * 24));
        
        return diffDays <= 3;
    }
    
    // Analyze students and generate insights
    async function analyzeStudents() {
        if (teacherClasses.length === 0) return null;
        
        const analysis = {
            totalStudents: 0,
            activeStudents: 0,
            strugglingStudents: [],
            excellingStudents: [],
            averageStreak: 0,
            averageHours: 0,
            classStats: [],
            trends: []
        };
        
        let totalStreak = 0;
        let totalHours = 0;
        let studentCount = 0;
        
        // Analyze each class
        for (const classInfo of teacherClasses) {
            const students = await getClassStudents(classInfo.code);
            const classAnalysis = {
                classCode: classInfo.code,
                className: classInfo.name,
                totalStudents: students.length,
                activeCount: 0,
                avgStreak: 0,
                avgHours: 0,
                struggling: [],
                excelling: []
            };
            
            let classStreak = 0;
            let classHours = 0;
            
            for (const student of students) {
                // Count active students
                if (student.isActive) classAnalysis.activeCount++;
                
                // Track averages
                classStreak += student.streak;
                classHours += parseFloat(student.totalHours);
                
                // Identify struggling students (streak < 2 and not active)
                if (student.streak < 2 && !student.isActive) {
                    classAnalysis.struggling.push(student);
                    analysis.strugglingStudents.push({
                        ...student,
                        className: classInfo.name
                    });
                }
                
                // Identify excelling students (streak > 7 and active)
                if (student.streak > 7 && student.isActive) {
                    classAnalysis.excelling.push(student);
                    analysis.excellingStudents.push({
                        ...student,
                        className: classInfo.name
                    });
                }
            }
            
            // Calculate class averages
            if (students.length > 0) {
                classAnalysis.avgStreak = (classStreak / students.length).toFixed(1);
                classAnalysis.avgHours = (classHours / students.length).toFixed(1);
                
                totalStreak += classStreak;
                totalHours += classHours;
                studentCount += students.length;
            }
            
            analysis.classStats.push(classAnalysis);
            analysis.totalStudents += students.length;
            analysis.activeStudents += classAnalysis.activeCount;
        }
        
        // Calculate overall averages
        if (studentCount > 0) {
            analysis.averageStreak = (totalStreak / studentCount).toFixed(1);
            analysis.averageHours = (totalHours / studentCount).toFixed(1);
        }
        
        // Generate trends
        if (analysis.strugglingStudents.length > 0) {
            analysis.trends.push({
                type: 'concern',
                message: `${analysis.strugglingStudents.length} students are struggling (low streak, inactive)`
            });
        }
        
        if (analysis.excellingStudents.length > 0) {
            analysis.trends.push({
                type: 'positive',
                message: `${analysis.excellingStudents.length} students are excelling (streak > 7, active)`
            });
        }
        
        if (analysis.activeStudents / analysis.totalStudents < 0.5) {
            analysis.trends.push({
                type: 'concern',
                message: `Only ${Math.round((analysis.activeStudents / analysis.totalStudents) * 100)}% of students are active`
            });
        }
        
        return analysis;
    }
    
    // Generate insight message based on real analysis
    function generateInsightFromAnalysis(analysis) {
        if (!analysis) {
            return {
                icon: 'ğŸ¤”',
                message: "No student data available yet. Check back when students start studying.",
                type: 'info'
            };
        }
        
        // Randomly pick what type of insight to show
        const insightTypes = ['struggling', 'excelling', 'trend', 'recommendation'];
        const selectedType = insightTypes[Math.floor(Math.random() * insightTypes.length)];
        
        switch(selectedType) {
            case 'struggling':
                if (analysis.strugglingStudents.length > 0) {
                    const student = analysis.strugglingStudents[Math.floor(Math.random() * analysis.strugglingStudents.length)];
                    return {
                        icon: 'âš ï¸',
                        message: `${student.name} in ${student.className} hasn't studied in a while (streak: ${student.streak}). Consider checking in.`,
                        type: 'concern'
                    };
                }
                // Fall through if no struggling students
                
            case 'excelling':
                if (analysis.excellingStudents.length > 0) {
                    const student = analysis.excellingStudents[Math.floor(Math.random() * analysis.excellingStudents.length)];
                    return {
                        icon: 'ğŸŒŸ',
                        message: `${student.name} in ${student.className} is doing great! ${student.streak}-day streak and ${student.totalHours} hours studied.`,
                        type: 'positive'
                    };
                }
                // Fall through if no excelling students
                
            case 'trend':
                if (analysis.trends.length > 0) {
                    const trend = analysis.trends[Math.floor(Math.random() * analysis.trends.length)];
                    return {
                        icon: trend.type === 'positive' ? 'ğŸ“ˆ' : 'ğŸ“‰',
                        message: trend.message,
                        type: trend.type
                    };
                }
                // Fall through if no trends
                
            case 'recommendation':
                const recommendations = [
                    `Send a motivational message to students with streaks below 2 (${analysis.strugglingStudents.length} students)`,
                    `Recognize top performers in your next announcement (${analysis.excellingStudents.length} students excelling)`,
                    `Consider creating study groups - average streak is ${analysis.averageStreak} days`,
                    `Schedule office hours - ${analysis.totalStudents - analysis.activeStudents} students haven't been active recently`,
                    `Try a class-wide challenge - average study time is ${analysis.averageHours} hours per student`
                ];
                
                const recommendation = recommendations[Math.floor(Math.random() * recommendations.length)];
                return {
                    icon: 'ğŸ’¡',
                    message: recommendation,
                    type: 'recommendation'
                };
                
            default:
                return {
                    icon: 'ğŸ“Š',
                    message: `You have ${analysis.totalStudents} students across ${teacherClasses.length} classes. ${analysis.activeStudents} are active recently.`,
                    type: 'info'
                };
        }
    }
    
    // Get current date for time-based messages
    function getTimeBasedMessage() {
        const hour = new Date().getHours();
        
        if (hour < 12) {
            return "Good morning! Time to check on your students' progress.";
        } else if (hour < 17) {
            return "Good afternoon! Perfect time for class announcements.";
        } else if (hour < 21) {
            return "Good evening! Many students study during these hours.";
        } else {
            return "Late night? Some students might be cramming. Consider morning review.";
        }
    }
    
    // Main function to show insight
    async function showRealInsight() {
        const bubbleMessage = document.querySelector('.bubble-message');
        const bubbleIcon = document.querySelector('.bubble-icon');
        const chatbotStats = document.getElementById('chatbotStats');
        
        // Show analyzing message
       const bubbleIconElement = document.querySelector('.bubble-icon');
const bubbleMessageElement = document.querySelector('.bubble-message');
if (bubbleIconElement) bubbleIconElement.textContent = 'ğŸ”';
if (bubbleMessageElement) bubbleMessageElement.textContent = "Analyzing student data...";
        chatbotStats.innerHTML = '<div style="text-align: center;">Fetching latest student progress...</div>';
        
        const bubble = document.getElementById('teacherChatbotBubble');
        bubble.classList.add('show');
        
        // Get teacher data if needed
        if (!currentTeacherId) {
            await getTeacherData();
        }
        
        // Get classes if needed
        if (teacherClasses.length === 0) {
            await getTeacherClasses();
        }
        
        // Analyze students
        const analysis = await analyzeStudents();
        
        // Generate insight
        let insight;
        if (analysis && analysis.totalStudents > 0) {
            insight = generateInsightFromAnalysis(analysis);
            
            // Update stats display
            chatbotStats.innerHTML = `
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
                    <span>ğŸ‘¥ ${analysis.totalStudents} students</span>
                    <span>ğŸ”¥ ${analysis.averageStreak} avg streak</span>
                    <span>â° ${analysis.averageHours}h avg</span>
                </div>
                <div style="font-size: 11px; margin-top: 4px; text-align: center;">
                    ${analysis.activeStudents} active â€¢ ${teacherClasses.length} classes
                </div>
            `;
        } else {
            // No data yet
            insight = {
                icon: 'ğŸ‘‹',
                message: getTimeBasedMessage(),
                type: 'welcome'
            };
            
            chatbotStats.innerHTML = `
                <div style="text-align: center; font-size: 12px;">
                    Waiting for student data...
                </div>
            `;
        }
        
        // Update bubble with insight
        bubbleIcon.textContent = insight.icon;
        bubbleMessage.textContent = insight.message;
        
        // Show for 12 seconds
        setTimeout(() => {
            bubble.classList.remove('show');
        }, 12000);
        
        return insight;
    }
    
    // Add click event
    const chatbotBtn = document.getElementById('teacherChatbotBtn');
    if (chatbotBtn) {
        chatbotBtn.addEventListener('click', showRealInsight);
    }
    
    // Show welcome message
    setTimeout(async () => {
        bubbleIcon.textContent = 'ğŸ‘‹';
        bubbleMessage.textContent = "Hi Teacher! I analyze your real student data. Let me check your classes...";
        chatbotStats.innerHTML = '<div style="text-align: center;">Loading student information...</div>';
        document.getElementById('teacherChatbotBubble').classList.add('show');
        
        // Initialize data in background
        setTimeout(async () => {
            await getTeacherData();
            await getTeacherClasses();
            
            // Update welcome message with real data
            if (teacherClasses.length > 0) {
                bubbleMessage.textContent = `Found ${teacherClasses.length} classes! I'll monitor ${teacherClasses.reduce((sum, c) => sum + c.studentCount, 0)} students.`;
                chatbotStats.innerHTML = `<div style="text-align: center;">Ready to analyze student progress</div>`;
            }
        }, 1000);
        
        setTimeout(() => document.getElementById('teacherChatbotBubble').classList.remove('show'), 6000);
    }, 3000);
    
    // AUTOMATED MESSAGES - Analyze and send insights every 3-5 minutes
    setInterval(async () => {
        if (Math.random() < 0.4 && document.visibilityState === 'visible') {
            await showRealInsight();
        }
    }, 180000 + Math.random() * 120000);
    
    // Force an analysis every 6 minutes
    setInterval(async () => {
        if (document.visibilityState === 'visible') {
            await showRealInsight();
        }
    }, 360000);
    
    console.log("ğŸ¤– REAL Student Analysis Chatbot initialized. Image: 200px");
}

// Handle window resize
let resizeTimeout;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
        const chatbot = document.querySelector('.teacher-chatbot-fab');
        if (chatbot) {
            const feedbackBtn = document.querySelector('.feedback-btn');
            let feedbackBottom = 20;
            
            if (feedbackBtn) {
                const rect = feedbackBtn.getBoundingClientRect();
                feedbackBottom = window.innerHeight - rect.top + 15;
            }
            
            chatbot.style.bottom = `${feedbackBottom + 20}px`;
        }
    }, 250);
});

// Initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(createTeacherChatbot, 2000);
    });
} else {
    setTimeout(createTeacherChatbot, 2000);
}





// ========== CREATE CHALLENGE PAGE FUNCTIONS ==========

let currentStep = 1;
let selectedChallengeType = '';
let selectedDuration = 0;
let selectedOpponentCode = '';

// Navigation between steps
function goToStep(stepNumber) {
    console.log(`Going to step ${stepNumber} from step ${currentStep}`);
    
    // Validate before proceeding
    if (stepNumber === 2 && !validateStep1()) {
        showNotification("Please select a challenge type", "error");
        return;
    }
    
    if (stepNumber === 3 && !validateStep2()) {
        showNotification("Please select duration and enter challenge name", "error");
        return;
    }
    
    // Hide current step
    const currentStepEl = document.getElementById(`step${currentStep}`);
    if (currentStepEl) {
        currentStepEl.style.display = 'none';
    }
    
    // Show new step
    const newStepEl = document.getElementById(`step${stepNumber}`);
    if (newStepEl) {
        newStepEl.style.display = 'block';
        currentStep = stepNumber;
        
        // Update step indicators
        updateStepIndicators();
        
        // Update preview
        updateChallengePreview();
        
        // Focus on first input if any
        setTimeout(() => {
            if (stepNumber === 2) {
                document.getElementById('challengeName')?.focus();
            } else if (stepNumber === 3) {
                document.getElementById('otherClassCode')?.focus();
            }
        }, 100);
    }
}

// Update step indicators
function updateStepIndicators() {
    const dots = document.querySelectorAll('.step-dot');
    dots.forEach((dot, index) => {
        if (index + 1 === currentStep) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
}

// Select challenge type
function selectChallengeType(type) {
    console.log("Selected challenge type:", type);
    selectedChallengeType = type;
    
    // Update UI
    const typeOptions = document.querySelectorAll('.challenge-type-option');
    typeOptions.forEach(option => {
        if (option.id === 'type' + type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('')) {
            option.classList.add('selected');
            option.style.borderColor = 'var(--accent)';
            option.style.background = 'linear-gradient(135deg, var(--accent-light), transparent)';
        } else {
            option.classList.remove('selected');
            option.style.borderColor = '';
            option.style.background = '';
        }
    });
    
    updateChallengePreview();
}

// Select duration
function selectDuration(days) {
    console.log("Selected duration:", days);
    selectedDuration = days;
    
    // Update UI
    const durationOptions = document.querySelectorAll('.duration-option');
    durationOptions.forEach(option => {
        if (option.id === 'duration' + days) {
            option.classList.add('selected');
            option.style.borderColor = 'var(--accent)';
            option.style.background = 'var(--accent-light)';
        } else {
            option.classList.remove('selected');
            option.style.borderColor = '';
            option.style.background = '';
        }
    });
    
    updateChallengePreview();
}

// Validate step 1
function validateStep1() {
    return !!selectedChallengeType;
}

// Validate step 2
function validateStep2() {
    if (!selectedDuration) return false;
    
    const challengeName = document.getElementById('challengeName')?.value.trim();
    if (!challengeName) return false;
    
    return true;
}

// Update challenge preview
function updateChallengePreview() {
    // Update opponent code preview
    const opponentCode = document.getElementById('otherClassCode')?.value.trim().toUpperCase() || '';
    const previewOpponent = document.getElementById('previewOpponentCode');
    if (previewOpponent) {
        previewOpponent.textContent = opponentCode || 'Enter code';
        previewOpponent.style.color = opponentCode ? 'var(--accent)' : 'var(--text-muted)';
    }
    
    // Update type preview
    const previewType = document.getElementById('previewType');
    if (previewType && selectedChallengeType) {
        const typeInfo = CHALLENGE_TYPES[selectedChallengeType];
        previewType.textContent = typeInfo ? typeInfo.name : 'Not selected';
        previewType.style.color = 'var(--accent)';
    }
    
    // Update duration preview
    const previewDuration = document.getElementById('previewDuration');
    if (previewDuration && selectedDuration) {
        previewDuration.textContent = selectedDuration + ' day' + (selectedDuration > 1 ? 's' : '');
        previewDuration.style.color = 'var(--accent)';
    }
    
    // Update name preview
    const challengeName = document.getElementById('challengeName')?.value.trim() || '';
    const previewName = document.getElementById('previewName');
    if (previewName) {
        previewName.textContent = challengeName || 'Not named yet';
        previewName.style.color = challengeName ? 'var(--accent)' : '';
    }
}

// Validate opponent class code
async function validateOpponentCode() {
    const codeInput = document.getElementById('otherClassCode');
    const code = codeInput?.value.trim().toUpperCase() || '';
    const validationDiv = document.getElementById('classCodeValidation');
    
    if (!validationDiv) return false;
    
    if (!code) {
        validationDiv.innerHTML = '';
        validationDiv.style.display = 'none';
        return false;
    }
    
    // Basic validation
    if (code.length !== 6) {
        validationDiv.innerHTML = `
            <div style="color: var(--danger); padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); display: flex; align-items: center; gap: var(--spacing-sm);">
                âŒ Class code must be exactly 6 characters
            </div>
        `;
        validationDiv.style.display = 'block';
        return false;
    }
    
    if (code === currentClassCode) {
        validationDiv.innerHTML = `
            <div style="color: var(--danger); padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); display: flex; align-items: center; gap: var(--spacing-sm);">
                âŒ You cannot challenge your own class
            </div>
        `;
        validationDiv.style.display = 'block';
        return false;
    }
    
    // Check if class exists
    validationDiv.innerHTML = `
        <div style="color: var(--info); padding: var(--spacing-sm); background: rgba(59, 130, 246, 0.1); border-radius: var(--radius); display: flex; align-items: center; gap: var(--spacing-sm);">
            ğŸ” Checking class code...
        </div>
    `;
    validationDiv.style.display = 'block';
    
    try {
        const exists = await checkClassExists(code);
        
        if (exists) {
            validationDiv.innerHTML = `
                <div style="color: var(--success); padding: var(--spacing-sm); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius); display: flex; align-items: center; gap: var(--spacing-sm);">
                    âœ… Valid class found! Ready to challenge.
                </div>
            `;
            selectedOpponentCode = code;
            return true;
        } else {
            validationDiv.innerHTML = `
                <div style="color: var(--danger); padding: var(--spacing-sm); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); display: flex; align-items: center; gap: var(--spacing-sm);">
                    âŒ Class not found. Please check the code with the other teacher.
                </div>
            `;
            return false;
        }
    } catch (error) {
        console.error("Error validating class code:", error);
        validationDiv.innerHTML = `
            <div style="color: var(--warning); padding: var(--spacing-sm); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); display: flex; align-items: center; gap: var(--spacing-sm);">
                âš ï¸ Could not verify class. You can still send the challenge.
            </div>
        `;
        selectedOpponentCode = code;
        return true; // Allow sending anyway
    }
}

// Check if class exists (simplified version)
async function checkClassExists(classCode) {
    if (!classCode || classCode.length !== 6) return false;
    
    // In demo mode, accept any 6-character code
    if (isDemoMode) {
        return true;
    }
    
    // Check in Firebase
    try {
        const snapshot = await database.ref('classCodes/' + classCode).once('value');
        return snapshot.exists();
    } catch (error) {
        console.error("Error checking class existence:", error);
        return false;
    }
}

// Submit challenge
async function submitChallenge() {
    console.log("Submitting challenge...");
    
    const challengeName = document.getElementById('challengeName')?.value.trim() || '';
    const message = document.getElementById('challengeMessage')?.value.trim() || '';
    const opponentCode = document.getElementById('otherClassCode')?.value.trim().toUpperCase() || '';
    
    // Validate everything
    if (!selectedChallengeType) {
        showNotification("Please select a challenge type", "error");
        goToStep(1);
        return;
    }
    
    if (!selectedDuration) {
        showNotification("Please select a duration", "error");
        goToStep(2);
        return;
    }
    
    if (!challengeName) {
        showNotification("Please enter a challenge name", "error");
        goToStep(2);
        return;
    }
    
    if (!opponentCode || opponentCode.length !== 6) {
        showNotification("Please enter a valid 6-digit class code", "error");
        document.getElementById('otherClassCode')?.focus();
        return;
    }
    
    // Validate opponent code
    const isValid = await validateOpponentCode();
    if (!isValid && !isDemoMode) {
        showNotification("Please fix the class code error", "error");
        return;
    }
    
    // Disable button and show loading
    const submitBtn = document.getElementById('submitChallengeBtn');
    if (submitBtn) {
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> Sending...';
        
        try {
            // Create the challenge
            const success = await createChallengeHelper(
                selectedChallengeType,
                selectedDuration,
                opponentCode,
                challengeName,
                message
            );
            
            if (success) {
                // Show success step
                goToStep(4);
                
                // Show challenge details
                const typeInfo = CHALLENGE_TYPES[selectedChallengeType];
                const detailsContainer = document.getElementById('createdChallengeDetails');
                if (detailsContainer) {
                    detailsContainer.innerHTML = `
                        <div style="text-align: left;">
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: var(--spacing-sm); align-items: center; margin-bottom: var(--spacing-md);">
                                <div style="font-weight: 600;">Challenge:</div>
                                <div>${challengeName}</div>
                                <div style="font-weight: 600;">Type:</div>
                                <div>${typeInfo?.name || selectedChallengeType}</div>
                                <div style="font-weight: 600;">Duration:</div>
                                <div>${selectedDuration} day${selectedDuration > 1 ? 's' : ''}</div>
                                <div style="font-weight: 600;">Opponent:</div>
                                <div>${opponentCode}</div>
                                <div style="font-weight: 600;">Status:</div>
                                <div style="color: var(--warning);">Pending acceptance</div>
                            </div>
                            ${message ? `
                            <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--accent-light); border-radius: var(--radius);">
                                <div style="font-weight: 600; margin-bottom: var(--spacing-xs);">Your message:</div>
                                <div>${message}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                showNotification("ğŸ‰ Challenge created successfully! The other teacher has been notified.", "success");
            } else {
                showNotification("Failed to create challenge", "error");
            }
        } catch (error) {
            console.error("Error creating challenge:", error);
            showNotification("Error: " + error.message, "error");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
}

// Create challenge helper (simplified)
async function createChallengeHelper(challengeType, duration, opponentClassCode, challengeName, message) {
    console.log("Creating challenge:", { challengeType, duration, opponentClassCode, challengeName });
    
    if (!currentClassCode) {
        showNotification("No class selected", "error");
        return false;
    }
    
    // Create challenge object
    const endsAt = new Date();
    endsAt.setDate(endsAt.getDate() + duration);
    
    const challenge = {
        name: challengeName,
        type: challengeType,
        challengerClass: currentClassCode,
        challengerTeacherId: teacherId,
        challengerTeacherName: teacherName,
        opponentClass: opponentClassCode,
        status: 'pending',
        duration: duration,
        createdAt: new Date().toISOString(),
        endsAt: endsAt.toISOString(),
        message: message || null,
        challengerScore: 0,
        opponentScore: 0
    };
    
    // In demo mode, save to localStorage
    if (isDemoMode) {
        return createChallengeInDemoMode(challenge);
    }
    
    // In Firebase mode, save to database
    try {
        const challengeRef = database.ref('challenges').push();
        await challengeRef.set(challenge);
        
        // Also add to our local list
        const enrichedChallenge = {
            id: challengeRef.key,
            ...challenge,
            myScore: 0,
            opponentScore: 0,
            myWinning: false,
            timeRemaining: `${duration} days`,
            progress: 0
        };
        
        pendingChallenges.push(enrichedChallenge);
        allChallenges.push(enrichedChallenge);
        updateChallengesUI();
        
        showNotification("âœ… Challenge sent to " + opponentClassCode, "success");
        return true;
    } catch (error) {
        console.error("Error creating challenge in Firebase:", error);
        showNotification("Failed to save challenge: " + error.message, "error");
        return false;
    }
}

// Create challenge in demo mode
function createChallengeInDemoMode(challenge) {
    const challengeId = 'demo_challenge_' + Date.now();
    const enrichedChallenge = {
        id: challengeId,
        ...challenge,
        myScore: 0,
        opponentScore: 0,
        myWinning: false,
        timeRemaining: `${challenge.duration} days`,
        progress: 0
    };
    
    pendingChallenges.push(enrichedChallenge);
    allChallenges.push(enrichedChallenge);
    saveChallengesToLocalStorage();
    updateChallengesUI();
    
    console.log(`âœ… Demo challenge created: ${challenge.name}`);
    showNotification("âœ… Challenge created (Demo Mode)", "success");
    return true;
}

// Reset form
function resetChallengeForm() {
    console.log("Resetting challenge form");
    
    currentStep = 1;
    selectedChallengeType = '';
    selectedDuration = 0;
    selectedOpponentCode = '';
    
    // Reset form fields
    const challengeName = document.getElementById('challengeName');
    const otherClassCode = document.getElementById('otherClassCode');
    const challengeMessage = document.getElementById('challengeMessage');
    
    if (challengeName) challengeName.value = '';
    if (otherClassCode) otherClassCode.value = '';
    if (challengeMessage) challengeMessage.value = '';
    
    // Reset UI selections
    document.querySelectorAll('.challenge-type-option').forEach(el => {
        el.classList.remove('selected');
        el.style.borderColor = '';
        el.style.background = '';
    });
    
    document.querySelectorAll('.duration-option').forEach(el => {
        el.classList.remove('selected');
        el.style.borderColor = '';
        el.style.background = '';
    });
    
    // Reset validation
    const validationDiv = document.getElementById('classCodeValidation');
    if (validationDiv) {
        validationDiv.innerHTML = '';
        validationDiv.style.display = 'none';
    }
    
    // Go to step 1
    document.getElementById('step4').style.display = 'none';
    document.getElementById('step1').style.display = 'block';
    updateStepIndicators();
    updateChallengePreview();
}

// Initialize form when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set up real-time validation for class code
    const codeInput = document.getElementById('otherClassCode');
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            updateChallengePreview();
        });
    }
    
    // Set up real-time preview for challenge name
    const nameInput = document.getElementById('challengeName');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            updateChallengePreview();
        });
    }
});


// ========== NOTIFICATIONS SYSTEM ==========

let notifications = [];

// Load notifications
async function loadNotifications() {
    if (!teacherId) return;
    
    if (isDemoMode) {
        loadNotificationsFromLocalStorage();
    } else {
        await loadNotificationsFromFirebase();
    }
    
    updateNotificationBadge();
}

async function loadNotificationsFromFirebase() {
    try {
        const snapshot = await database.ref(`notifications/${teacherId}`).once('value');
        if (snapshot.exists()) {
            notifications = [];
            snapshot.forEach(child => {
                notifications.push({
                    id: child.key,
                    ...child.val()
                });
            });
            console.log(`ğŸ“¬ Loaded ${notifications.length} notifications`);
        }
    } catch (error) {
        console.error("Error loading notifications:", error);
    }
}

function loadNotificationsFromLocalStorage() {
    try {
        const saved = localStorage.getItem(`teacher_notifications_${teacherId}`);
        if (saved) {
            notifications = JSON.parse(saved);
        }
    } catch (error) {
        console.error("Error loading notifications from localStorage:", error);
    }
}

function saveNotificationsToLocalStorage() {
    try {
        localStorage.setItem(`teacher_notifications_${teacherId}`, JSON.stringify(notifications));
    } catch (error) {
        console.error("Error saving notifications:", error);
    }
}

// Create notification for opponent teacher
async function sendChallengeNotification(challengeId, challengeData) {
    try {
        // Get opponent teacher ID
        const opponentClassCode = challengeData.opponentClass;
        const classSnapshot = await database.ref(`classCodes/${opponentClassCode}`).once('value');
        
        if (!classSnapshot.exists()) {
            console.error("Opponent class not found:", opponentClassCode);
            return false;
        }
        
        const opponentTeacherId = classSnapshot.val().teacherId;
        const opponentClassName = classSnapshot.val().name;
        
        // Create notification
        const notification = {
            type: 'challenge_invitation',
            challengeId: challengeId,
            challengerClass: challengeData.challengerClass,
            challengerTeacherName: challengeData.challengerTeacherName,
            opponentClass: opponentClassCode,
            opponentClassName: opponentClassName,
            challengeName: challengeData.name,
            challengeType: challengeData.type,
            duration: challengeData.duration,
            message: challengeData.message || null,
            createdAt: new Date().toISOString(),
            status: 'unread',
            isAccepted: false
        };
        
        // Save to Firebase
        await database.ref(`notifications/${opponentTeacherId}/${challengeId}`).set(notification);
        
        console.log(`ğŸ“¬ Sent challenge notification to teacher ${opponentTeacherId}`);
        return true;
    } catch (error) {
        console.error("Error sending notification:", error);
        return false;
    }
}

// Update notification badge in UI
function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => n.status === 'unread').length;
    
    // Update sidebar badge
    const challengesNav = document.querySelector('.nav-item[onclick*="challenges"]');
    if (challengesNav && unreadCount > 0) {
        // Remove existing badge
        const existingBadge = challengesNav.querySelector('.notification-badge');
        if (existingBadge) existingBadge.remove();
        
        // Add new badge
        const badge = document.createElement('span');
        badge.className = 'notification-badge';
        badge.textContent = unreadCount;
        badge.style.cssText = `
            position: absolute;
            right: 10px;
            top: 10px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        `;
        challengesNav.style.position = 'relative';
        challengesNav.appendChild(badge);
    }
}

// Mark notification as read
async function markNotificationAsRead(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.status = 'read';
        
        if (!isDemoMode) {
            await database.ref(`notifications/${teacherId}/${notificationId}/status`).set('read');
        } else {
            saveNotificationsToLocalStorage();
        }
        
        updateNotificationBadge();
    }
}


// ========== FRIENDLY CLASS COMPETITION ==========

// Global variables for challenges
let activeChallenges = [];
let pendingChallenges = [];
let completedChallenges = [];
let allChallenges = [];
let selectedChallengeId = null;

// Challenge types
const CHALLENGE_TYPES = {
    total_study_hours: {
        name: 'Study Hours',
        icon: 'â±ï¸',
        description: 'Total hours studied by all students',
        calculate: calculateStudyHours,
        unit: 'hours'
    },
    streak_count: {
        name: 'Streak Count',
        icon: 'ğŸ”¥',
        description: 'Average streak across all students',
        calculate: calculateAverageStreak,
        unit: 'days'
    }
};

// Challenge statuses
const CHALLENGE_STATUS = {
    PENDING: 'pending',
    ACTIVE: 'active',
    COMPLETED: 'completed',
    CANCELLED: 'cancelled'
};

// Initialize challenges system
async function initializeChallenges() {
    console.log("âš”ï¸ Initializing challenges system...");
    
    // Load notifications first
    await loadNotifications();
    
    if (isDemoMode) {
        loadChallengesFromLocalStorage();
        createDemoChallenges();
    } else {
        await loadChallengesFromFirebase();
    }
    
    updateChallengesUI();
    startChallengeUpdates();
    
    console.log(`âœ… Challenges system initialized: ${allChallenges.length} challenges, ${notifications.length} notifications`);
}

// Load challenges from Firebase
async function loadChallengesFromFirebase() {
    if (!teacherId || !currentClassCode) return;
    
    try {
        // Load challenges where this class is either challenger or opponent
        const snapshot = await database.ref('challenges').orderByChild('createdAt').once('value');
        
        if (snapshot.exists()) {
            allChallenges = [];
            activeChallenges = [];
            pendingChallenges = [];
            completedChallenges = [];
            
            snapshot.forEach(child => {
                const challenge = child.val();
                const challengeId = child.key;
                
                // Check if this class is involved in the challenge
                if (challenge.challengerClass === currentClassCode || 
                    challenge.opponentClass === currentClassCode) {
                    
                    const enrichedChallenge = {
                        id: challengeId,
                        ...challenge,
                        // Add calculated fields
                        myScore: calculateMyScore(challenge),
                        opponentScore: calculateOpponentScore(challenge),
                        myWinning: isMyClassWinning(challenge),
                        timeRemaining: calculateTimeRemaining(challenge),
                        progress: calculateChallengeProgress(challenge)
                    };
                    
                    allChallenges.push(enrichedChallenge);
                    
                    // Categorize by status
                    if (challenge.status === CHALLENGE_STATUS.ACTIVE) {
                        activeChallenges.push(enrichedChallenge);
                    } else if (challenge.status === CHALLENGE_STATUS.PENDING) {
                        pendingChallenges.push(enrichedChallenge);
                    } else if (challenge.status === CHALLENGE_STATUS.COMPLETED) {
                        completedChallenges.push(enrichedChallenge);
                    }
                }
            });
            
            console.log(`âœ… Loaded ${allChallenges.length} challenges from Firebase`);
        }
    } catch (error) {
        console.error(`âŒ Error loading challenges: ${error.message}`);
        loadChallengesFromLocalStorage();
    }
}

// Load challenges from localStorage
function loadChallengesFromLocalStorage() {
    try {
        const saved = localStorage.getItem(`teacher_challenges_${currentClassCode}`);
        if (saved) {
            const data = JSON.parse(saved);
            allChallenges = data.allChallenges || [];
            activeChallenges = data.activeChallenges || [];
            pendingChallenges = data.pendingChallenges || [];
            completedChallenges = data.completedChallenges || [];
            console.log(`ğŸ“‚ Loaded ${allChallenges.length} challenges from localStorage`);
        }
    } catch (error) {
        console.error("Error loading challenges from localStorage:", error);
    }
}

// Save challenges to localStorage
function saveChallengesToLocalStorage() {
    try {
        const data = {
            allChallenges,
            activeChallenges,
            pendingChallenges,
            completedChallenges,
            lastUpdated: new Date().toISOString()
        };
        localStorage.setItem(`teacher_challenges_${currentClassCode}`, JSON.stringify(data));
    } catch (error) {
        console.error("Error saving challenges to localStorage:", error);
    }
}

// Create demo challenges for testing
function createDemoChallenges() {
    if (allChallenges.length > 0) return;
    
    const demoChallenges = [
        {
            id: 'demo_challenge_1',
            name: 'Math vs Science Showdown',
            type: 'total_study_hours',
            challengerClass: currentClassCode,
            challengerTeacherId: teacherId,
            challengerTeacherName: teacherName,
            opponentClass: 'SCI789',
            opponentTeacherName: 'Ms. Johnson',
            status: CHALLENGE_STATUS.ACTIVE,
            duration: 7, // days
            createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            endsAt: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(),
            message: 'May the best class win! Good luck!'
        },
        {
            id: 'demo_challenge_2',
            name: 'Study Streak Battle',
            type: 'streak_count',
            challengerClass: 'MATH456',
            challengerTeacherName: 'Mr. Smith',
            opponentClass: currentClassCode,
            opponentTeacherId: teacherId,
            opponentTeacherName: teacherName,
            status: CHALLENGE_STATUS.PENDING,
            duration: 3,
            createdAt: new Date().toISOString(),
            endsAt: null,
            message: 'My students are ready to beat your streak record!'
        },
        {
            id: 'demo_challenge_3',
            name: 'Weekend Study Marathon',
            type: 'total_study_hours',
            challengerClass: currentClassCode,
            challengerTeacherId: teacherId,
            challengerTeacherName: teacherName,
            opponentClass: 'ENG123',
            opponentTeacherName: 'Dr. Williams',
            status: CHALLENGE_STATUS.COMPLETED,
            duration: 2,
            createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
            endsAt: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(),
            result: {
                winner: currentClassCode,
                challengerScore: 45.2,
                opponentScore: 38.7,
                completedAt: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString()
            },
            message: 'Great competition! Let\'s do this again sometime.'
        }
    ];
    
    demoChallenges.forEach(challenge => {
        const enrichedChallenge = {
            ...challenge,
            myScore: calculateMyScore(challenge),
            opponentScore: calculateOpponentScore(challenge),
            myWinning: isMyClassWinning(challenge),
            timeRemaining: calculateTimeRemaining(challenge),
            progress: calculateChallengeProgress(challenge)
        };
        
        allChallenges.push(enrichedChallenge);
        
        if (challenge.status === CHALLENGE_STATUS.ACTIVE) {
            activeChallenges.push(enrichedChallenge);
        } else if (challenge.status === CHALLENGE_STATUS.PENDING) {
            pendingChallenges.push(enrichedChallenge);
        } else if (challenge.status === CHALLENGE_STATUS.COMPLETED) {
            completedChallenges.push(enrichedChallenge);
        }
    });
    
    saveChallengesToLocalStorage();
    console.log(`âœ… Created ${demoChallenges.length} demo challenges`);
}


// Keep this function for external API calls
function setupFriendlyChallenge(challengeType, duration) {
    console.log(`âš”ï¸ Setting up ${challengeType} challenge for ${duration} days`);
    
    // Navigate to create challenge page
    showSection('create-challenge');
    
    // Pre-select options
    setTimeout(() => {
        if (challengeType) selectChallengeType(challengeType);
        if (duration) selectDuration(duration);
    }, 100);
    
    return true;
}


// Main function to create a challenge
function setupFriendlyChallenge(challengeType, duration) {
    console.log(`âš”ï¸ Setting up ${challengeType} challenge for ${duration} days`);
    
    // This is the main API function that can be called externally
    return createChallengeHelper(challengeType, duration);
}

// Create challenge helper
async function createChallengeHelper(challengeType, duration, opponentClassCode, challengeName, message) {
    console.log("Creating challenge:", { challengeType, duration, opponentClassCode, challengeName });
    
    if (!currentClassCode) {
        showNotification("No class selected", "error");
        return false;
    }
    
    if (opponentClassCode === currentClassCode) {
        showNotification("You cannot challenge your own class", "error");
        return false;
    }
    
    // Create challenge object
    const endsAt = new Date();
    endsAt.setDate(endsAt.getDate() + duration);
    
    const challenge = {
        name: challengeName,
        type: challengeType,
        challengerClass: currentClassCode,
        challengerTeacherId: teacherId,
        challengerTeacherName: teacherName,
        opponentClass: opponentClassCode,
        status: 'pending',
        duration: duration,
        createdAt: new Date().toISOString(),
        endsAt: endsAt.toISOString(),
        message: message || null,
        challengerScore: 0,
        opponentScore: 0,
        isAccepted: false
    };
    
    let challengeId;
    
    // Save challenge
    if (isDemoMode) {
        challengeId = 'demo_challenge_' + Date.now();
        return createChallengeInDemoMode(challengeId, challenge);
    } else {
        try {
            // Check if opponent class exists
            const classSnapshot = await database.ref(`classCodes/${opponentClassCode}`).once('value');
            if (!classSnapshot.exists()) {
                showNotification("Class code not found. Please check with the other teacher.", "error");
                return false;
            }
            
            // Save challenge to Firebase
            const challengeRef = database.ref('challenges').push();
            challengeId = challengeRef.key;
            await challengeRef.set(challenge);
            
            console.log(`âœ… Challenge saved to Firebase: ${challengeId}`);
            
            // Send notification to opponent
            const notificationSent = await sendChallengeNotification(challengeId, challenge);
            if (!notificationSent) {
                console.warn("Could not send notification, but challenge was saved");
            }
            
            // Add to local challenges list
            const enrichedChallenge = {
                id: challengeId,
                ...challenge,
                myScore: 0,
                opponentScore: 0,
                myWinning: false,
                timeRemaining: `${duration} days`,
                progress: 0
            };
            
            pendingChallenges.push(enrichedChallenge);
            allChallenges.push(enrichedChallenge);
            updateChallengesUI();
            
            showNotification("âœ… Challenge sent! The other teacher will be notified.", "success");
            return true;
            
        } catch (error) {
            console.error("Error creating challenge in Firebase:", error);
            showNotification("Failed to save challenge: " + error.message, "error");
            return false;
        }
    }
}

// Real-time opponent code validation
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.getElementById('otherClassCode');
    if (codeInput) {
        let validationTimeout;
        
        codeInput.addEventListener('input', function() {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(async () => {
                await validateOpponentCode();
                updateChallengePreview();
            }, 500);
        });
        
        // Also validate on blur
        codeInput.addEventListener('blur', function() {
            validateOpponentCode();
            updateChallengePreview();
        });
    }
    
    // Real-time name preview update
    const nameInput = document.getElementById('challengeName');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            updateChallengePreview();
        });
    }
});

// Create challenge in demo mode
function createChallengeInDemoMode(challenge) {
    const challengeId = 'demo_challenge_' + Date.now();
    const enrichedChallenge = {
        id: challengeId,
        ...challenge,
        myScore: 0,
        opponentScore: 0,
        myWinning: false,
        timeRemaining: calculateTimeRemaining(challenge),
        progress: 0
    };
    
    pendingChallenges.push(enrichedChallenge);
    allChallenges.push(enrichedChallenge);
    saveChallengesToLocalStorage();
    updateChallengesUI();
    
    console.log(`âœ… Demo challenge created: ${challenge.name}`);
    return true;
}

// Create challenge in Firebase
async function createChallengeInFirebase(challenge) {
    try {
        const challengeRef = database.ref('challenges').push();
        const challengeId = challengeRef.key;
        
        await challengeRef.set(challenge);
        
        // Also create notification for opponent
        const notification = {
            type: 'challenge_invitation',
            challengeId: challengeId,
            challengerClass: challenge.challengerClass,
            challengerTeacherName: challenge.challengerTeacherName,
            challengeName: challenge.name,
            challengeType: challenge.type,
            duration: challenge.duration,
            message: challenge.message,
            createdAt: new Date().toISOString(),
            status: 'unread'
        };
        
        // Find opponent teacher ID
        const classSnap = await database.ref('classCodes/' + challenge.opponentClass).once('value');
        if (classSnap.exists()) {
            const opponentTeacherId = classSnap.val().teacherId;
            await database.ref(`notifications/${opponentTeacherId}/${challengeId}`).set(notification);
        }
        
        console.log(`âœ… Challenge created in Firebase: ${challenge.name}`);
        return true;
    } catch (error) {
        console.error("Error creating challenge in Firebase:", error);
        return false;
    }
}

// Update challenge scores
async function updateChallengeScores() {
    if (!currentClassCode) return;
    
    // For each active challenge involving this class
    for (const challenge of activeChallenges) {
        try {
            const newChallengerScore = await calculateChallengeScore(challenge.challengerClass, challenge.type);
            const newOpponentScore = await calculateChallengeScore(challenge.opponentClass, challenge.type);
            
            // Update challenge with new scores
            challenge.challengerScore = newChallengerScore;
            challenge.opponentScore = newOpponentScore;
            challenge.myScore = calculateMyScore(challenge);
            challenge.opponentScore = calculateOpponentScore(challenge);
            challenge.myWinning = isMyClassWinning(challenge);
            challenge.progress = calculateChallengeProgress(challenge);
            
            // Check if challenge has ended
            if (new Date() >= new Date(challenge.endsAt)) {
                completeChallenge(challenge.id);
            }
            
            // Update in Firebase if not demo
            if (!isDemoMode) {
                await database.ref(`challenges/${challenge.id}`).update({
                    challengerScore: newChallengerScore,
                    opponentScore: newOpponentScore
                });
            }
        } catch (error) {
            console.error(`Error updating scores for challenge ${challenge.id}:`, error);
        }
    }
    
    // Update UI
    updateChallengesUI();
    
    if (isDemoMode) {
        saveChallengesToLocalStorage();
    }
}

// Calculate score for a class based on challenge type
async function calculateChallengeScore(classCode, challengeType) {
    if (challengeType === 'total_study_hours') {
        return await calculateStudyHours(classCode);
    } else if (challengeType === 'streak_count') {
        return await calculateAverageStreak(classCode);
    }
    return 0;
}

// Calculate total study hours for a class
async function calculateStudyHours(classCode) {
    if (isDemoMode) {
        // Demo mode: generate random hours based on time
        const baseHours = classCode === currentClassCode ? 25 : 20;
        const randomHours = Math.random() * 10;
        return parseFloat((baseHours + randomHours).toFixed(1));
    }
    
    try {
        // Get students for the class
        const studentsSnap = await database.ref(`classes/${classCode}/students`).once('value');
        let totalHours = 0;
        
        if (studentsSnap.exists()) {
            studentsSnap.forEach(child => {
                const student = child.val();
                const hours = student.totalStudyHours || (student.totalMinutes / 60) || 0;
                totalHours += parseFloat(hours);
            });
        }
        
        return parseFloat(totalHours.toFixed(1));
    } catch (error) {
        console.error(`Error calculating study hours for ${classCode}:`, error);
        return 0;
    }
}

// Calculate average streak for a class
async function calculateAverageStreak(classCode) {
    if (isDemoMode) {
        // Demo mode: generate random streak
        const baseStreak = classCode === currentClassCode ? 4.5 : 3.8;
        const randomStreak = Math.random() * 2;
        return parseFloat((baseStreak + randomStreak).toFixed(1));
    }
    
    try {
        const studentsSnap = await database.ref(`classes/${classCode}/students`).once('value');
        let totalStreak = 0;
        let studentCount = 0;
        
        if (studentsSnap.exists()) {
            studentsSnap.forEach(child => {
                const student = child.val();
                totalStreak += student.streak || 0;
                studentCount++;
            });
        }
        
        return studentCount > 0 ? parseFloat((totalStreak / studentCount).toFixed(1)) : 0;
    } catch (error) {
        console.error(`Error calculating average streak for ${classCode}:`, error);
        return 0;
    }
}

// Calculate my class score
function calculateMyScore(challenge) {
    return challenge.challengerClass === currentClassCode ? 
           challenge.challengerScore : challenge.opponentScore;
}

// Calculate opponent score
function calculateOpponentScore(challenge) {
    return challenge.challengerClass === currentClassCode ? 
           challenge.opponentScore : challenge.challengerScore;
}

// Check if my class is winning
function isMyClassWinning(challenge) {
    return calculateMyScore(challenge) > calculateOpponentScore(challenge);
}

// Calculate time remaining
function calculateTimeRemaining(challenge) {
    if (challenge.status !== CHALLENGE_STATUS.ACTIVE) {
        return "Challenge not active";
    }
    
    const endsAt = new Date(challenge.endsAt);
    const now = new Date();
    
    if (now >= endsAt) {
        return "Ended";
    }
    
    const diffMs = endsAt - now;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    
    return `${diffDays}d ${diffHours}h`;
}

// Calculate challenge progress (percentage complete)
function calculateChallengeProgress(challenge) {
    if (challenge.status !== CHALLENGE_STATUS.ACTIVE) {
        return 100;
    }
    
    const startAt = new Date(challenge.createdAt);
    const endsAt = new Date(challenge.endsAt);
    const now = new Date();
    
    const totalMs = endsAt - startAt;
    const elapsedMs = now - startAt;
    
    return Math.min(100, Math.max(0, (elapsedMs / totalMs) * 100));
}

// Complete a challenge
async function completeChallenge(challengeId) {
    const challenge = allChallenges.find(c => c.id === challengeId);
    if (!challenge || challenge.status !== CHALLENGE_STATUS.ACTIVE) return;
    
    // Determine winner
    const winnerClass = challenge.challengerScore > challenge.opponentScore ? 
                       challenge.challengerClass : challenge.opponentClass;
    
    const result = {
        winner: winnerClass,
        challengerScore: challenge.challengerScore,
        opponentScore: challenge.opponentScore,
        completedAt: new Date().toISOString()
    };
    
    // Update challenge status
    challenge.status = CHALLENGE_STATUS.COMPLETED;
    challenge.result = result;
    
    // Move from active to completed
    const activeIndex = activeChallenges.findIndex(c => c.id === challengeId);
    if (activeIndex !== -1) {
        activeChallenges.splice(activeIndex, 1);
        completedChallenges.push(challenge);
    }
    
    // Update in Firebase if not demo
    if (!isDemoMode) {
        try {
            await database.ref(`challenges/${challengeId}`).update({
                status: CHALLENGE_STATUS.COMPLETED,
                result: result
            });
        } catch (error) {
            console.error("Error completing challenge in Firebase:", error);
        }
    }
    
    // Send celebration notification to winner
    if (winnerClass === currentClassCode) {
        celebrateChallengeWin(challenge);
    }
    
    // Update UI
    updateChallengesUI();
    
    if (isDemoMode) {
        saveChallengesToLocalStorage();
    }
    
    console.log(`âœ… Challenge completed: ${challenge.name}`);
}

// Celebrate challenge win
function celebrateChallengeWin(challenge) {
    const challengeType = CHALLENGE_TYPES[challenge.type];
    
    showNotification(`ğŸ† You won the "${challenge.name}" challenge!`, "success");
    launchConfetti();
    
    // Post announcement
    postSystemAnnouncement(
        "Challenge Victory! ğŸ†",
        `Our class won the "${challenge.name}" challenge against ${challenge.challengerClass === currentClassCode ? challenge.opponentClass : challenge.challengerClass}! We had ${challenge.myScore} ${challengeType.unit} vs their ${challenge.opponentScore} ${challengeType.unit}. Amazing work, class!`
    );
}

// Update challenges UI
function updateChallengesUI() {
    // Update sidebar challenges list
    updateSidebarChallenges();
    
    // Update challenges dashboard section
    updateAllChallengesList();
    
    // Update challenge stats
    updateChallengeStats();
}

// Update sidebar challenges list
function updateSidebarChallenges() {
    const challengesList = document.getElementById('challengesList');
    if (!challengesList) return;
    
    // Show active challenges in sidebar (max 3)
    const sidebarChallenges = activeChallenges.slice(0, 3);
    
    if (sidebarChallenges.length === 0) {
        challengesList.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-md); color: var(--text-muted); font-size: 0.875rem;">
                No active challenges
            </div>
        `;
        return;
    }
    
    challengesList.innerHTML = sidebarChallenges.map(challenge => {
        const challengeType = CHALLENGE_TYPES[challenge.type];
        const isWinning = challenge.myWinning;
        const progress = Math.round(challenge.progress);
        
        return `
            <div class="challenge-item ${challenge.status}" onclick="showChallengeDetails('${challenge.id}')">
                <div class="challenge-title">${challenge.name}</div>
                <div class="challenge-details">
                    <span>${challengeType.icon} ${challengeType.name}</span>
                    <span>${progress}%</span>
                </div>
                <div class="challenge-stats">
                    <div class="challenge-stat ${isWinning ? 'winning' : ''}">
                        Us: ${challenge.myScore}
                    </div>
                    <div class="challenge-stat ${!isWinning ? 'losing' : ''}">
                        Them: ${challenge.opponentScore}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Update all challenges list in dashboard
function updateAllChallengesList() {
    const allChallengesList = document.getElementById('allChallengesList');
    if (!allChallengesList) return;
    
    if (allChallenges.length === 0) {
        allChallengesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âš”ï¸</div>
                <div class="empty-state-title">No challenges yet</div>
                <div class="empty-state-description">Create your first challenge with another teacher!</div>
            </div>
        `;
        return;
    }
    
    allChallengesList.innerHTML = allChallenges.map(challenge => {
        const challengeType = CHALLENGE_TYPES[challenge.type];
        const isActive = challenge.status === CHALLENGE_STATUS.ACTIVE;
        const isPending = challenge.status === CHALLENGE_STATUS.PENDING;
        const isCompleted = challenge.status === CHALLENGE_STATUS.COMPLETED;
        const isWinning = challenge.myWinning;
        const progress = Math.round(challenge.progress);
        const opponentClass = challenge.challengerClass === currentClassCode ? 
                            challenge.opponentClass : challenge.challengerClass;
        
        let statusBadge = '';
        if (isActive) statusBadge = `<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Active</span>`;
        if (isPending) statusBadge = `<span style="background: var(--warning); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Pending</span>`;
        if (isCompleted) statusBadge = `<span style="background: var(--info); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Completed</span>`;
        
        return `
            <div class="challenge-card">
                <div class="challenge-card-header">
                    <div>
                        <div class="challenge-card-title">${challenge.name}</div>
                        <div class="challenge-card-time">
                            vs ${opponentClass} â€¢ ${challenge.duration} days
                        </div>
                    </div>
                    ${statusBadge}
                </div>
                
                <div class="challenge-card-type">
                    ${challengeType.icon} ${challengeType.name}
                </div>
                
                ${isActive ? `
                <div class="challenge-card-progress">
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 4px;">
                        <span>Progress</span>
                        <span>${progress}%</span>
                    </div>
                    <div style="height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${progress}%; background: var(--gradient-primary);"></div>
                    </div>
                </div>
                ` : ''}
                
                <div class="challenge-card-stats">
                    <div class="challenge-card-class">
                        <div>Us</div>
                        <div class="challenge-card-score ${isWinning && isActive ? 'winning' : ''}" style="color: ${isWinning && isActive ? 'var(--success)' : 'var(--text)'};">${challenge.myScore}</div>
                    </div>
                    
                    <div style="text-align: center; font-weight: 900; color: var(--accent);">VS</div>
                    
                    <div class="challenge-card-class">
                        <div>Them</div>
                        <div class="challenge-card-score ${!isWinning && isActive ? 'losing' : ''}" style="color: ${!isWinning && isActive ? 'var(--danger)' : 'var(--text)'};">${challenge.opponentScore}</div>
                    </div>
                </div>
                
                ${isCompleted && challenge.result ? `
                <div style="text-align: center; padding: var(--spacing-sm); background: ${challenge.result.winner === currentClassCode ? 'var(--gradient-success)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: var(--radius); margin-bottom: var(--spacing-md);">
                    ${challenge.result.winner === currentClassCode ? 'ğŸ† You won!' : 'ğŸ˜… You lost'}
                </div>
                ` : ''}
                
                <div class="challenge-actions">
                    <button class="btn btn-secondary" onclick="showChallengeDetails('${challenge.id}')" style="flex: 1;">Details</button>
                    ${isPending && challenge.opponentClass === currentClassCode ? `
                    <button class="btn btn-success" onclick="acceptChallenge('${challenge.id}')" style="flex: 1;">Accept</button>
                    <button class="btn btn-danger" onclick="rejectChallenge('${challenge.id}')" style="flex: 1;">Decline</button>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Update challenge statistics
function updateChallengeStats() {
    const wins = completedChallenges.filter(c => c.result && c.result.winner === currentClassCode).length;
    const activeCount = activeChallenges.length;
    const totalCount = allChallenges.length;
    
    document.getElementById('challengeWins').textContent = wins;
    document.getElementById('activeChallenges').textContent = activeCount;
    document.getElementById('totalChallenges').textContent = totalCount;
}

// Show challenge details
async function showChallengeDetails(challengeId) {
    const challenge = allChallenges.find(c => c.id === challengeId);
    if (!challenge) return;
    
    selectedChallengeId = challengeId;
    
    const challengeType = CHALLENGE_TYPES[challenge.type];
    const isActive = challenge.status === CHALLENGE_STATUS.ACTIVE;
    const isCompleted = challenge.status === CHALLENGE_STATUS.COMPLETED;
    const isPending = challenge.status === CHALLENGE_STATUS.PENDING;
    const isMyChallenge = challenge.challengerClass === currentClassCode;
    
    // Update modal content
    document.getElementById('detailChallengeName').textContent = challenge.name;
    document.getElementById('detailChallengeType').textContent = challengeType.name;
    document.getElementById('detailChallengeStatus').textContent = isActive ? 'Active' : isPending ? 'Pending' : 'Completed';
    
    // My class info
    document.getElementById('detailMyClassName').textContent = isMyChallenge ? 'You (Challenger)' : 'You';
    document.getElementById('detailMyClassCode').textContent = currentClassCode;
    document.getElementById('detailMyScore').textContent = challenge.myScore;
    document.getElementById('detailMyScore').className = `class-score ${challenge.myWinning && isActive ? 'winning' : ''}`;
    
    // Opponent info
    const opponentClass = isMyChallenge ? challenge.opponentClass : challenge.challengerClass;
    const opponentName = isMyChallenge ? challenge.opponentTeacherName : challenge.challengerTeacherName;
    document.getElementById('detailOpponentClassName').textContent = `${opponentName}'s Class`;
    document.getElementById('detailOpponentClassCode').textContent = opponentClass;
    document.getElementById('detailOpponentScore').textContent = challenge.opponentScore;
    document.getElementById('detailOpponentScore').className = `class-score ${!challenge.myWinning && isActive ? 'losing' : ''}`;
    
    // Progress
    const progress = Math.round(challenge.progress);
    document.getElementById('detailProgressFill').style.width = `${progress}%`;
    
    // Time info
    if (isActive) {
        document.getElementById('detailTimeRemaining').textContent = `Ends in: ${challenge.timeRemaining}`;
        document.getElementById('detailTimeStarted').textContent = `Started: ${formatDate(challenge.createdAt)}`;
    } else if (isCompleted) {
        document.getElementById('detailTimeRemaining').textContent = 'Challenge Completed';
        document.getElementById('detailTimeStarted').textContent = `Ended: ${formatDate(challenge.result.completedAt)}`;
    } else {
        document.getElementById('detailTimeRemaining').textContent = 'Awaiting Response';
        document.getElementById('detailTimeStarted').textContent = `Sent: ${formatDate(challenge.createdAt)}`;
    }
    
    // Message
    const messageContainer = document.getElementById('challengeMessageContainer');
    if (challenge.message) {
        messageContainer.style.display = 'block';
        document.getElementById('detailChallengeMessage').textContent = challenge.message;
    } else {
        messageContainer.style.display = 'none';
    }
    
    // Result
    const resultContainer = document.getElementById('challengeResult');
    if (isCompleted && challenge.result) {
        resultContainer.style.display = 'block';
        const won = challenge.result.winner === currentClassCode;
        resultContainer.style.background = won ? 'var(--gradient-success)' : 'var(--gradient-danger)';
        document.getElementById('detailResultText').textContent = won ? 
            `You won! ${challenge.myScore} vs ${challenge.opponentScore} ${challengeType.unit}` :
            `You lost! ${challenge.myScore} vs ${challenge.opponentScore} ${challengeType.unit}`;
    } else {
        resultContainer.style.display = 'none';
    }
    
    // Cancel button (only show for my pending challenges)
    const cancelBtn = document.getElementById('cancelChallengeBtn');
    if (isPending && isMyChallenge) {
        cancelBtn.style.display = 'block';
    } else {
        cancelBtn.style.display = 'none';
    }
    
    showModal('challengeDetailsModal');
}

// Refresh challenge details
async function refreshChallengeDetails() {
    if (!selectedChallengeId) return;
    
    // Update scores
    await updateChallengeScores();
    
    // Re-show details with updated info
    showChallengeDetails(selectedChallengeId);
    
    showNotification("Challenge details refreshed", "info");
}

// Accept a challenge
async function acceptChallenge(challengeId) {
    const challenge = allChallenges.find(c => c.id === challengeId);
    if (!challenge || challenge.status !== CHALLENGE_STATUS.PENDING) return;
    
    if (confirm("Accept this challenge? The competition will begin immediately!")) {
        challenge.status = CHALLENGE_STATUS.ACTIVE;
        
        // Move from pending to active
        const pendingIndex = pendingChallenges.findIndex(c => c.id === challengeId);
        if (pendingIndex !== -1) {
            pendingChallenges.splice(pendingIndex, 1);
            activeChallenges.push(challenge);
        }
        
        // Update in Firebase if not demo
        if (!isDemoMode) {
            try {
                await database.ref(`challenges/${challengeId}`).update({
                    status: CHALLENGE_STATUS.ACTIVE
                });
            } catch (error) {
                console.error("Error accepting challenge in Firebase:", error);
            }
        }
        
        updateChallengesUI();
        
        if (isDemoMode) {
            saveChallengesToLocalStorage();
        }
        
        showNotification("Challenge accepted! Competition begins now!", "success");
        
        // Post announcement to class
        postSystemAnnouncement(
            "Challenge Accepted! âš”ï¸",
            `We've accepted the "${challenge.name}" challenge from ${challenge.challengerTeacherName}! Let's show them what we're made of!`
        );
    }
}

// Reject a challenge
async function rejectChallenge(challengeId) {
    if (confirm("Reject this challenge? This cannot be undone.")) {
        const challenge = allChallenges.find(c => c.id === challengeId);
        if (!challenge) return;
        
        challenge.status = CHALLENGE_STATUS.CANCELLED;
        
        // Remove from pending
        const pendingIndex = pendingChallenges.findIndex(c => c.id === challengeId);
        if (pendingIndex !== -1) {
            pendingChallenges.splice(pendingIndex, 1);
        }
        
        // Update in Firebase if not demo
        if (!isDemoMode) {
            try {
                await database.ref(`challenges/${challengeId}`).update({
                    status: CHALLENGE_STATUS.CANCELLED
                });
            } catch (error) {
                console.error("Error rejecting challenge in Firebase:", error);
            }
        }
        
        updateChallengesUI();
        
        if (isDemoMode) {
            saveChallengesToLocalStorage();
        }
        
        showNotification("Challenge rejected", "info");
    }
}

// Cancel a challenge
async function cancelChallenge() {
    if (!selectedChallengeId) return;
    
    if (confirm("Cancel this challenge? This will notify the other teacher.")) {
        const challenge = allChallenges.find(c => c.id === selectedChallengeId);
        if (!challenge) return;
        
        challenge.status = CHALLENGE_STATUS.CANCELLED;
        
        // Remove from appropriate list
        if (challenge.status === CHALLENGE_STATUS.PENDING) {
            const pendingIndex = pendingChallenges.findIndex(c => c.id === selectedChallengeId);
            if (pendingIndex !== -1) pendingChallenges.splice(pendingIndex, 1);
        } else if (challenge.status === CHALLENGE_STATUS.ACTIVE) {
            const activeIndex = activeChallenges.findIndex(c => c.id === selectedChallengeId);
            if (activeIndex !== -1) activeChallenges.splice(activeIndex, 1);
        }
        
        // Update in Firebase if not demo
        if (!isDemoMode) {
            try {
                await database.ref(`challenges/${selectedChallengeId}`).update({
                    status: CHALLENGE_STATUS.CANCELLED
                });
            } catch (error) {
                console.error("Error cancelling challenge in Firebase:", error);
            }
        }
        
        updateChallengesUI();
        hideModal('challengeDetailsModal');
        
        if (isDemoMode) {
            saveChallengesToLocalStorage();
        }
        
        showNotification("Challenge cancelled", "info");
    }
}

// Filter challenges
function filterChallenges(filterType) {
    // Update active filter button
    document.querySelectorAll('#challengesFilter button').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1)).classList.add('btn-primary');
    
    // Filter challenges
    let filteredChallenges = [];
    
    switch(filterType) {
        case 'all':
            filteredChallenges = allChallenges;
            break;
        case 'active':
            filteredChallenges = activeChallenges;
            break;
        case 'pending':
            filteredChallenges = pendingChallenges;
            break;
        case 'completed':
            filteredChallenges = completedChallenges;
            break;
        case 'won':
            filteredChallenges = completedChallenges.filter(c => 
                c.result && c.result.winner === currentClassCode
            );
            break;
        case 'lost':
            filteredChallenges = completedChallenges.filter(c => 
                c.result && c.result.winner !== currentClassCode
            );
            break;
    }
    
    // Update display
    const allChallengesList = document.getElementById('allChallengesList');
    if (filteredChallenges.length === 0) {
        allChallengesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <div class="empty-state-title">No ${filterType} challenges</div>
                <div class="empty-state-description">Try a different filter or create a new challenge</div>
            </div>
        `;
    } else {
        // Re-render with filtered challenges
        // We'll just show/hide for simplicity
        const challengeCards = allChallengesList.querySelectorAll('.challenge-card');
        challengeCards.forEach(card => {
            card.style.display = 'none';
        });
       
        // This is a simplified approach - in a real implementation, 
        // you'd want to re-render only the filtered challenges
        allChallengesList.innerHTML = filteredChallenges.map(challenge => {
            // Same rendering code as updateAllChallengesList, but filtered
            return renderChallengeCard(challenge);
            
        }).join('');
    }
    
}

// Start periodic challenge updates
function startChallengeUpdates() {
    // Update scores every 30 seconds
    setInterval(() => {
        updateChallengeScores();
    }, 30000);
    
    // Check for completed challenges every minute
    setInterval(() => {
        activeChallenges.forEach(challenge => {
            if (new Date() >= new Date(challenge.endsAt)) {
                completeChallenge(challenge.id);
            }
        });
    }, 60000);
}




// Force initialize the New Challenge button
function initializeChallengeButton() {
    console.log("âš”ï¸ Initializing challenge button...");
    
    // Try multiple times
    const tryInitialize = (attempt = 1) => {
        const buttons = document.querySelectorAll('.btn-challenge');
        console.log(`Attempt ${attempt}: Found ${buttons.length} challenge buttons`);
        
        buttons.forEach(btn => {
            if (!btn.hasAttribute('data-challenge-initialized')) {
                console.log("âœ… Setting up challenge button");
                btn.setAttribute('data-challenge-initialized', 'true');
                btn.onclick = function() {
                    console.log("New Challenge clicked!");
                    if (currentClassCode) {
                        showSection('create-challenge');
                    } else {
                        showNotification("Please select a class first", "error");
                    }
                };
            }
        });
        
        // Try again if needed
        if (attempt < 5) {
            setTimeout(() => tryInitialize(attempt + 1), 1000);
        }
    };
    
    tryInitialize(1);
}

// Call it when the page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeChallengeButton, 2000);
});

// Show notifications
function showNotifications() {
    loadNotifications(); // Refresh notifications
    renderNotifications();
    showModal('notificationsModal');
}

// Render notifications list
function renderNotifications() {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-xl);">
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ğŸ“­</div>
                <div style="font-weight: 600; margin-bottom: var(--spacing-xs);">No notifications</div>
                <div style="color: var(--text-muted);">You're all caught up!</div>
            </div>
        `;
        return;
    }
    
    // Sort by date (newest first)
    const sortedNotifications = [...notifications].sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
    );
    
    container.innerHTML = sortedNotifications.map(notification => {
        const isUnread = notification.status === 'unread';
        const timeAgo = getTimeAgo(notification.createdAt);
        
        let content = '';
        let actions = '';
        
        if (notification.type === 'challenge_invitation') {
            const typeInfo = CHALLENGE_TYPES[notification.challengeType] || { name: 'Challenge' };
            
            content = `
                <div class="notification-content">
                    <strong>${notification.challengerTeacherName}</strong> has challenged your class 
                    <strong>${notification.opponentClassName || notification.opponentClass}</strong> to a 
                    <strong>${typeInfo.name}</strong> competition!
                    ${notification.message ? `<div style="margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: var(--accent-light); border-radius: var(--radius); font-style: italic;">"${notification.message}"</div>` : ''}
                    <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-muted);">
                        Duration: ${notification.duration} day${notification.duration > 1 ? 's' : ''}
                    </div>
                </div>
            `;
            
            if (!notification.isAccepted) {
                actions = `
                    <div class="notification-actions">
                        <button class="btn btn-success" onclick="acceptChallengeFromNotification('${notification.challengeId}')" style="font-size: 0.75rem; padding: var(--spacing-xs) var(--spacing-sm);">
                            âœ… Accept
                        </button>
                        <button class="btn btn-danger" onclick="rejectChallengeFromNotification('${notification.challengeId}')" style="font-size: 0.75rem; padding: var(--spacing-xs) var(--spacing-sm);">
                            âŒ Decline
                        </button>
                    </div>
                `;
            }
        }
        
        return `
            <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="viewNotification('${notification.id}')">
                <div class="notification-header">
                    <div class="notification-title">
                        ${notification.type === 'challenge_invitation' ? 'âš”ï¸ New Challenge' : 'ğŸ“¢ Notification'}
                    </div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
                ${content}
                ${actions}
            </div>
        `;
    }).join('');
    
    // Update badge counts
    updateNotificationBadges();
}

// Update notification badges
function updateNotificationBadges() {
    const unreadCount = notifications.filter(n => n.status === 'unread').length;
    
    const mobileBadge = document.getElementById('notificationCount');
    const desktopBadge = document.getElementById('notificationCountDesktop');
    
    if (mobileBadge) {
        mobileBadge.textContent = unreadCount;
        mobileBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
    }
    
    if (desktopBadge) {
        desktopBadge.textContent = unreadCount;
        desktopBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
    }
}

// View notification
function viewNotification(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (!notification) return;
    
    markNotificationAsRead(notificationId);
    
    if (notification.type === 'challenge_invitation') {
        // Navigate to challenges section
        hideModal('notificationsModal');
        showSection('challenges');
        
        // Highlight the specific challenge
        setTimeout(() => {
            const challengeCard = document.querySelector(`[data-challenge-id="${notification.challengeId}"]`);
            if (challengeCard) {
                challengeCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                challengeCard.style.animation = 'pulse 2s';
            }
        }, 500);
    }
}

// Accept challenge from notification
// ========== FIXED ACCEPT CHALLENGE FUNCTION ==========

// Fix for accepting challenges from notifications
async function acceptChallengeFromNotification(challengeId) {
    console.log(`âš”ï¸ Accepting challenge ${challengeId} from notification`);
    
    try {
        // Get the challenge from the database or localStorage
        let challenge;
        
        if (isDemoMode) {
            // In demo mode, find in allChallenges
            challenge = allChallenges.find(c => c.id === challengeId);
            
            if (!challenge) {
                // If not found, create a new challenge object from notification
                const notification = notifications.find(n => n.challengeId === challengeId);
                if (!notification) {
                    showNotification("Challenge not found", "error");
                    return;
                }
                
                challenge = {
                    id: challengeId,
                    name: notification.challengeName,
                    type: notification.challengeType,
                    challengerClass: notification.challengerClass,
                    challengerTeacherId: '', // Will be filled from notification
                    challengerTeacherName: notification.challengerTeacherName,
                    opponentClass: currentClassCode,
                    opponentTeacherId: teacherId,
                    opponentTeacherName: teacherName,
                    status: 'pending',
                    duration: notification.duration,
                    createdAt: notification.createdAt,
                    endsAt: null,
                    message: notification.message || null,
                    challengerScore: 0,
                    opponentScore: 0,
                    isAccepted: false
                };
            }
        } else {
            // In Firebase mode, load from database
            const snapshot = await database.ref(`challenges/${challengeId}`).once('value');
            if (!snapshot.exists()) {
                showNotification("Challenge not found in database", "error");
                return;
            }
            challenge = { id: challengeId, ...snapshot.val() };
        }
        
        // Update challenge status to ACTIVE
        challenge.status = 'active';
        challenge.isAccepted = true;
        challenge.startedAt = new Date().toISOString();
        
        // Calculate end date
        const endsAt = new Date();
        endsAt.setDate(endsAt.getDate() + challenge.duration);
        challenge.endsAt = endsAt.toISOString();
        
        // Add our teacher ID if missing
        if (!challenge.opponentTeacherId) {
            challenge.opponentTeacherId = teacherId;
            challenge.opponentTeacherName = teacherName;
        }
        
        // Add calculated fields for display
        const enrichedChallenge = {
            ...challenge,
            myScore: calculateMyScore(challenge),
            opponentScore: calculateOpponentScore(challenge),
            myWinning: isMyClassWinning(challenge),
            timeRemaining: calculateTimeRemaining(challenge),
            progress: calculateChallengeProgress(challenge)
        };
        
        console.log("Enriched challenge:", enrichedChallenge);
        
        // Check if challenge already exists in our lists
        const existingIndex = allChallenges.findIndex(c => c.id === challengeId);
        
        if (existingIndex !== -1) {
            // Update existing challenge
            allChallenges[existingIndex] = enrichedChallenge;
            
            // Remove from pending if it's there
            const pendingIndex = pendingChallenges.findIndex(c => c.id === challengeId);
            if (pendingIndex !== -1) {
                pendingChallenges.splice(pendingIndex, 1);
            }
        } else {
            // Add as new challenge
            allChallenges.push(enrichedChallenge);
        }
        
        // Add to active challenges
        const activeIndex = activeChallenges.findIndex(c => c.id === challengeId);
        if (activeIndex === -1) {
            activeChallenges.push(enrichedChallenge);
        } else {
            activeChallenges[activeIndex] = enrichedChallenge;
        }
        
        // Update in database or localStorage
        if (isDemoMode) {
            saveChallengesToLocalStorage();
        } else {
            try {
                await database.ref(`challenges/${challengeId}`).update({
                    status: 'active',
                    isAccepted: true,
                    startedAt: challenge.startedAt,
                    endsAt: challenge.endsAt,
                    opponentTeacherId: teacherId,
                    opponentTeacherName: teacherName
                });
                
                // Mark notification as read
                await database.ref(`notifications/${teacherId}/${challengeId}`).update({
                    status: 'read',
                    isAccepted: true
                });
            } catch (error) {
                console.error("Error updating challenge in Firebase:", error);
            }
        }
        
        // Update notifications
        const notifIndex = notifications.findIndex(n => n.challengeId === challengeId);
        if (notifIndex !== -1) {
            notifications[notifIndex].status = 'read';
            notifications[notifIndex].isAccepted = true;
            saveNotificationsToLocalStorage();
        }
        
        // Update UI
        updateChallengesUI();
        updateNotificationBadges();
        
        showNotification(`âœ… Challenge "${challenge.name}" accepted! Competition begins now!`, "success");
        
        // Post announcement to class
        postSystemAnnouncement(
            "Challenge Accepted! âš”ï¸",
            `We've accepted the "${challenge.name}" challenge from ${challenge.challengerTeacherName}! \n\n` +
            `Challenge: ${CHALLENGE_TYPES[challenge.type]?.name || 'Competition'} \n` +
            `Duration: ${challenge.duration} days \n` +
            `Get ready to compete!`
        );
        
        // Close notification modal
        hideModal('notificationsModal');
        
    } catch (error) {
        console.error("Error accepting challenge:", error);
        showNotification("Failed to accept challenge: " + error.message, "error");
    }
}

// Also update the simpler acceptChallenge function
async function acceptChallenge(challengeId) {
    console.log(`âš”ï¸ Accepting challenge ${challengeId} from challenges page`);
    
    // Find the challenge
    const challengeIndex = allChallenges.findIndex(c => c.id === challengeId);
    if (challengeIndex === -1) {
        showNotification("Challenge not found", "error");
        return;
    }
    
    const challenge = allChallenges[challengeIndex];
    
    if (confirm(`Accept "${challenge.name}" challenge?\n\nDuration: ${challenge.duration} days\nType: ${CHALLENGE_TYPES[challenge.type]?.name || 'Competition'}`)) {
        
        // Update challenge status
        challenge.status = 'active';
        challenge.isAccepted = true;
        challenge.startedAt = new Date().toISOString();
        
        // Calculate end date
        const endsAt = new Date();
        endsAt.setDate(endsAt.getDate() + challenge.duration);
        challenge.endsAt = endsAt.toISOString();
        
        // Ensure our teacher info is included
        challenge.opponentTeacherId = teacherId;
        challenge.opponentTeacherName = teacherName;
        
        // Add calculated fields
        challenge.myScore = calculateMyScore(challenge);
        challenge.opponentScore = calculateOpponentScore(challenge);
        challenge.myWinning = isMyClassWinning(challenge);
        challenge.timeRemaining = calculateTimeRemaining(challenge);
        challenge.progress = calculateChallengeProgress(challenge);
        
        // Move from pending to active
        const pendingIndex = pendingChallenges.findIndex(c => c.id === challengeId);
        if (pendingIndex !== -1) {
            pendingChallenges.splice(pendingIndex, 1);
        }
        
        const activeIndex = activeChallenges.findIndex(c => c.id === challengeId);
        if (activeIndex === -1) {
            activeChallenges.push(challenge);
        }
        
        // Update in Firebase or localStorage
        if (isDemoMode) {
            saveChallengesToLocalStorage();
        } else {
            try {
                await database.ref(`challenges/${challengeId}`).update({
                    status: 'active',
                    isAccepted: true,
                    startedAt: challenge.startedAt,
                    endsAt: challenge.endsAt,
                    opponentTeacherId: teacherId,
                    opponentTeacherName: teacherName
                });
            } catch (error) {
                console.error("Error accepting challenge in Firebase:", error);
            }
        }
        
        // Update UI
        updateChallengesUI();
        
        showNotification(`âœ… "${challenge.name}" challenge accepted! Competition begins now!`, "success");
        
        // Post announcement
        postSystemAnnouncement(
            "Challenge Accepted! âš”ï¸",
            `We've accepted the "${challenge.name}" challenge from ${challenge.challengerTeacherName}! Let's show them what we're made of!`
        );
        
        // Refresh the challenges view
        filterChallenges('active');
    }
}



// ========== ENHANCED CHALLENGE LOADING ==========

// Replace or enhance your existing initializeChallenges function
async function initializeChallenges() {
    console.log("âš”ï¸ Initializing challenges system...");
    
    // Load notifications first
    await loadNotifications();
    
    // Load challenges from localStorage (for both demo and firebase modes)
    loadChallengesFromLocalStorage();
    
    // If in demo mode, create demo challenges if none exist
    if (isDemoMode && allChallenges.length === 0) {
        createDemoChallenges();
    }
    
    // If in Firebase mode, also load from database
    if (!isDemoMode && currentClassCode) {
        await loadChallengesFromFirebase();
    }
    
    // IMPORTANT: Filter challenges for current class
    filterChallengesForCurrentClass();
    
    // Update UI
    updateChallengesUI();
    
    // Start periodic updates
    startChallengeUpdates();
    
    console.log(`âœ… Challenges initialized: ${allChallenges.length} total, ${activeChallenges.length} active, ${pendingChallenges.length} pending`);
}

// NEW FUNCTION: Filter challenges for current class
function filterChallengesForCurrentClass() {
    if (!currentClassCode) return;
    
    console.log(`ğŸ” Filtering challenges for class: ${currentClassCode}`);
    
    // Filter all arrays to only include challenges involving current class
    allChallenges = allChallenges.filter(challenge => 
        challenge.challengerClass === currentClassCode || 
        challenge.opponentClass === currentClassCode
    );
    
    activeChallenges = allChallenges.filter(challenge => 
        challenge.status === 'active'
    );
    
    pendingChallenges = allChallenges.filter(challenge => 
        challenge.status === 'pending' && 
        challenge.opponentClass === currentClassCode // Only show pending challenges where WE are the opponent
    );
    
    completedChallenges = allChallenges.filter(challenge => 
        challenge.status === 'completed'
    );
    
    console.log(`ğŸ“Š After filtering: ${activeChallenges.length} active, ${pendingChallenges.length} pending`);
}

// Update the renderNotifications function to ensure proper challenge display
function renderNotifications() {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-xl);">
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ğŸ“­</div>
                <div style="font-weight: 600; margin-bottom: var(--spacing-xs);">No notifications</div>
                <div style="color: var(--text-muted);">You're all caught up!</div>
            </div>
        `;
        return;
    }
    
    // Sort by date (newest first)
    const sortedNotifications = [...notifications].sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
    );
    
    container.innerHTML = sortedNotifications.map(notification => {
        const isUnread = notification.status === 'unread';
        const timeAgo = getTimeAgo(notification.createdAt);
        
        let content = '';
        let actions = '';
        
        if (notification.type === 'challenge_invitation') {
            const typeInfo = CHALLENGE_TYPES[notification.challengeType] || { name: 'Challenge' };
            
            content = `
                <div class="notification-content">
                    <strong>${notification.challengerTeacherName}</strong> has challenged your class to a 
                    <strong>${typeInfo.name}</strong> competition!
                    <div style="margin-top: var(--spacing-sm); font-size: 0.9rem;">
                        <strong>Challenge:</strong> ${notification.challengeName}<br>
                        <strong>Duration:</strong> ${notification.duration} day${notification.duration > 1 ? 's' : ''}<br>
                        ${notification.message ? `<strong>Message:</strong> "${notification.message}"` : ''}
                    </div>
                </div>
            `;
            
            // Only show accept/decline if not already accepted
            if (!notification.isAccepted) {
                actions = `
                    <div class="notification-actions">
                        <button class="btn btn-success" onclick="acceptChallengeFromNotification('${notification.challengeId}')">
                            âœ… Accept Challenge
                        </button>
                        <button class="btn btn-danger" onclick="rejectChallengeFromNotification('${notification.challengeId}')">
                            âŒ Decline
                        </button>
                    </div>
                `;
            } else {
                content += `<div style="margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: var(--success-light); border-radius: var(--radius);">
                    âœ… Challenge already accepted
                </div>`;
            }
        }
        
        return `
            <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="viewNotification('${notification.id}')" style="cursor: pointer;">
                <div class="notification-header">
                    <div class="notification-title">
                        ${notification.type === 'challenge_invitation' ? 'âš”ï¸ New Challenge' : 'ğŸ“¢ Notification'}
                    </div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
                ${content}
                ${actions}
            </div>
        `;
    }).join('');
    
    // Update badge counts
    updateNotificationBadges();
}

// Also update the switchClass function to reload challenges
const originalSwitchClass = switchClass;
switchClass = async function(classIndex) {
    await originalSwitchClass(classIndex);
    
    // Reload challenges for the new class
    setTimeout(() => {
        filterChallengesForCurrentClass();
        updateChallengesUI();
    }, 500);
};






// ========== QUICK FIX FOR CHALLENGES VISIBILITY ==========

// Add this to make sure challenges show up
function ensureChallengesVisible() {
    console.log("ğŸ” Ensuring challenges are visible...");
    
    // Check if we have challenges but they're not showing
    const challengesSection = document.getElementById('challenges');
    const allChallengesList = document.getElementById('allChallengesList');
    
    if (challengesSection && allChallengesList) {
        // Force render challenges
        if (allChallenges.length > 0) {
            console.log(`Displaying ${allChallenges.length} challenges`);
            updateAllChallengesList();
        } else {
            console.log("No challenges to display");
        }
    }
}

// Call this when switching to challenges section
const originalShowSection = showSection;
showSection = function(sectionId) {
    originalShowSection(sectionId);
    
    if (sectionId === 'challenges') {
        // Ensure challenges are properly displayed
        setTimeout(() => {
            ensureChallengesVisible();
            addDebugButton(); // Add debug button if needed
        }, 300);
    }
};

// Add visual indicator for empty challenges
function updateAllChallengesList() {
    const allChallengesList = document.getElementById('allChallengesList');
    if (!allChallengesList) return;
    
    if (allChallenges.length === 0) {
        allChallengesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âš”ï¸</div>
                <div class="empty-state-title">No challenges yet</div>
                <div class="empty-state-description">
                    <p>Create your first challenge with another teacher!</p>
                    <button class="btn btn-primary" onclick="showSection('create-challenge')" style="margin-top: 1rem;">
                        + Create New Challenge
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    // Filter challenges for current class
    const classChallenges = allChallenges.filter(challenge => 
        challenge.challengerClass === currentClassCode || 
        challenge.opponentClass === currentClassCode
    );
    
    if (classChallenges.length === 0) {
        allChallengesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <div class="empty-state-title">No challenges for this class</div>
                <div class="empty-state-description">
                    <p>You have challenges, but none for class ${currentClassCode}.</p>
                    <p>Switch to the correct class or create a new challenge.</p>
                </div>
            </div>
        `;
        return;
    }
    
    // Render the challenges
    allChallengesList.innerHTML = classChallenges.map(challenge => {
        // Your existing challenge card rendering code here
        const challengeType = CHALLENGE_TYPES[challenge.type];
        const isActive = challenge.status === 'active';
        const isPending = challenge.status === 'pending';
        const isCompleted = challenge.status === 'completed';
        const isWinning = challenge.myWinning;
        const progress = Math.round(challenge.progress);
        const opponentClass = challenge.challengerClass === currentClassCode ? 
                            challenge.opponentClass : challenge.challengerClass;
        
        let statusBadge = '';
        if (isActive) statusBadge = `<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Active</span>`;
        if (isPending) statusBadge = `<span style="background: var(--warning); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Pending</span>`;
        if (isCompleted) statusBadge = `<span style="background: var(--info); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Completed</span>`;
        
        return `
            <div class="challenge-card" data-challenge-id="${challenge.id}">
                <div class="challenge-card-header">
                    <div>
                        <div class="challenge-card-title">${challenge.name}</div>
                        <div class="challenge-card-time">
                            vs ${opponentClass} â€¢ ${challenge.duration} days â€¢ ${challengeType?.name || 'Challenge'}
                        </div>
                    </div>
                    ${statusBadge}
                </div>
                
                ${isActive ? `
                <div class="challenge-card-progress">
                    <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 4px;">
                        <span>Progress</span>
                        <span>${progress}%</span>
                    </div>
                    <div style="height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                        <div style="height: 100%; width: ${progress}%; background: var(--gradient-primary);"></div>
                    </div>
                </div>
                ` : ''}
                
                <div class="challenge-card-stats">
                    <div class="challenge-card-class">
                        <div>${challenge.challengerClass === currentClassCode ? 'You (Challenger)' : 'You'}</div>
                        <div class="challenge-card-score ${isWinning && isActive ? 'winning' : ''}">
                            ${challenge.myScore}
                        </div>
                    </div>
                    
                    <div style="text-align: center; font-weight: 900; color: var(--accent); font-size: 1.2rem;">VS</div>
                    
                    <div class="challenge-card-class">
                        <div>${challenge.challengerClass === currentClassCode ? 'Opponent' : 'Challenger'}</div>
                        <div class="challenge-card-score ${!isWinning && isActive ? 'losing' : ''}">
                            ${challenge.opponentScore}
                        </div>
                    </div>
                </div>
                
                <div class="challenge-actions">
                    <button class="btn btn-secondary" onclick="showChallengeDetails('${challenge.id}')" style="flex: 1;">
                        Details
                    </button>
                    ${isPending && challenge.opponentClass === currentClassCode ? `
                    <button class="btn btn-success" onclick="acceptChallenge('${challenge.id}')" style="flex: 1;">
                        Accept
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}






// ========== DIAGNOSTIC TOOL ==========
function diagnoseChallengesIssue() {
    console.log("=== CHALLENGES DIAGNOSTIC ===");
    console.log("1. Current class code:", currentClassCode);
    console.log("2. Is demo mode:", isDemoMode);
    console.log("3. Teacher ID:", teacherId);
    console.log("4. Challenges initialized:", window.challengesInitialized || false);
    
    // Check localStorage
    const savedChallenges = localStorage.getItem(`class_${currentClassCode}_challenges_all`);
    console.log("5. Challenges in localStorage:", savedChallenges ? JSON.parse(savedChallenges).length : 0);
    
    // Check allChallenges array
    console.log("6. allChallenges array length:", allChallenges.length);
    
    // Filter for current class
    const classChallenges = allChallenges.filter(c => 
        c.challengerClass === currentClassCode || c.opponentClass === currentClassCode
    );
    console.log("7. Challenges for current class:", classChallenges.length);
    
    // Show each challenge
    console.log("8. Individual challenges:");
    classChallenges.forEach((c, i) => {
        console.log(`   ${i+1}. ${c.name} (${c.id})`);
        console.log(`      Status: ${c.status}, Challenger: ${c.challengerClass}, Opponent: ${c.opponentClass}`);
        console.log(`      Created: ${c.createdAt}`);
    });
    
    alert(`Challenges Diagnostic:\n\n` +
          `Current class: ${currentClassCode}\n` +
          `Total challenges in memory: ${allChallenges.length}\n` +
          `For this class: ${classChallenges.length}\n` +
          `Check console for details.`);
}





// ========== FIXED CHALLENGES DISPLAY FUNCTIONS ==========

// 1. Add the missing renderChallengeCard function
function renderChallengeCard(challenge) {
    const challengeType = CHALLENGE_TYPES[challenge.type] || { name: 'Challenge', icon: 'âš”ï¸' };
    const isActive = challenge.status === 'active';
    const isPending = challenge.status === 'pending';
    const isCompleted = challenge.status === 'completed';
    const isWinning = challenge.myWinning;
    const progress = Math.round(challenge.progress);
    const opponentClass = challenge.challengerClass === currentClassCode ? 
                        challenge.opponentClass : challenge.challengerClass;
    
    let statusBadge = '';
    if (isActive) statusBadge = `<span style="background: var(--success); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Active</span>`;
    if (isPending) statusBadge = `<span style="background: var(--warning); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Pending</span>`;
    if (isCompleted) statusBadge = `<span style="background: var(--info); color: white; padding: 4px 12px; border-radius: 1rem; font-size: 0.75rem;">Completed</span>`;
    
    return `
        <div class="challenge-card" data-challenge-id="${challenge.id}">
            <div class="challenge-card-header">
                <div>
                    <div class="challenge-card-title">${challenge.name || 'Unnamed Challenge'}</div>
                    <div class="challenge-card-time">
                        vs ${opponentClass} â€¢ ${challenge.duration || 1} days â€¢ ${challengeType.name}
                    </div>
                </div>
                ${statusBadge}
            </div>
            
            <div class="challenge-card-type">
                ${challengeType.icon} ${challengeType.name}
            </div>
            
            ${isActive ? `
            <div class="challenge-card-progress">
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 4px;">
                    <span>Progress</span>
                    <span>${progress}%</span>
                </div>
                <div style="height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden;">
                    <div style="height: 100%; width: ${progress}%; background: var(--gradient-primary);"></div>
                </div>
            </div>
            ` : ''}
            
            <div class="challenge-card-stats">
                <div class="challenge-card-class">
                    <div>${challenge.challengerClass === currentClassCode ? 'You (Challenger)' : 'You'}</div>
                    <div class="challenge-card-score ${isWinning && isActive ? 'winning' : ''}">
                        ${challenge.myScore || 0}
                    </div>
                </div>
                
                <div style="text-align: center; font-weight: 900; color: var(--accent);">VS</div>
                
                <div class="challenge-card-class">
                    <div>${challenge.challengerClass === currentClassCode ? 'Opponent' : 'Challenger'}</div>
                    <div class="challenge-card-score ${!isWinning && isActive ? 'losing' : ''}">
                        ${challenge.opponentScore || 0}
                    </div>
                </div>
            </div>
            
            ${isCompleted && challenge.result ? `
            <div style="text-align: center; padding: var(--spacing-sm); background: ${challenge.result.winner === currentClassCode ? 'var(--gradient-success)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: var(--radius); margin-bottom: var(--spacing-md);">
                ${challenge.result.winner === currentClassCode ? 'ğŸ† You won!' : 'ğŸ˜… You lost'}
            </div>
            ` : ''}
            
            <div class="challenge-actions">
                <button class="btn btn-secondary" onclick="showChallengeDetails('${challenge.id}')" style="flex: 1;">
                    Details
                </button>
                ${isPending && challenge.opponentClass === currentClassCode ? `
                <button class="btn btn-success" onclick="acceptChallenge('${challenge.id}')" style="flex: 1;">
                    Accept
                </button>
                <button class="btn btn-danger" onclick="rejectChallenge('${challenge.id}')" style="flex: 1;">
                    Decline
                </button>
                ` : ''}
            </div>
        </div>
    `;
    const actionsHTML = `
        <div class="challenge-actions">
            <button class="btn btn-secondary" onclick="showChallengeDetails('${challenge.id}')" style="flex: 1;">
                Details
            </button>
            ${isCompleted && challenge.result && challenge.result.winner === currentClassCode ? `
            <button class="btn btn-success" onclick="celebrateChallengeWin('${challenge.id}')" style="flex: 1;">
                ğŸ‰ You Won!
            </button>
            ` : ''}
            ${isPending && challenge.opponentClass === currentClassCode ? `
            <button class="btn btn-success" onclick="acceptChallenge('${challenge.id}')" style="flex: 1;">
                Accept
            </button>
            <button class="btn btn-danger" onclick="rejectChallenge('${challenge.id}')" style="flex: 1;">
                Decline
            </button>
            ` : ''}
        </div>
    `;
    
    return `... ${actionsHTML} ...`;
}






function celebrateChallengeWin(challengeId) {
    const challenge = allChallenges.find(c => c.id === challengeId);
    if (!challenge || !challenge.result || challenge.result.winner !== currentClassCode) {
        showNotification("This challenge wasn't won by your class", "error");
        return;
    }
    
    console.log(`ğŸ‰ Celebrating win for challenge: ${challenge.name}`);
    
    // 1. Launch confetti
    launchConfetti();
    
    // 2. Play celebration sound
    playCelebrationSound('win');
    
    // 3. Show celebration message
    showNotification(`ğŸ‰ CELEBRATION! We won "${challenge.name}"!`, "success");
    
    // 4. Post celebration announcement (students will see this)
    const celebrationMessage = `ğŸ‰ CELEBRATION TIME! ğŸ‰\n\n` +
        `Our class officially WON the "${challenge.name}" challenge!\n\n` +
        `ğŸ† Final Score: ${challenge.result.challengerScore} vs ${challenge.result.opponentScore}\n` +
        `Let's celebrate this amazing achievement!`;
    
    postSystemAnnouncement("ğŸ‰ Challenge Victory Celebration!", celebrationMessage);
    
    // 5. Add to activity feed
    const celebrationActivity = {
        type: 'celebration',
        message: `ğŸ‰ Celebrating our victory in "${challenge.name}" challenge!`,
        challengeName: challenge.name,
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        isCelebration: true,
        visibleToStudents: true
    };
    
    if (!isDemoMode && database && database.ref) {
        database.ref(`classActivity/${currentClassCode}`).push().set(celebrationActivity);
    }
}



// 2. Fix the filterChallenges function
function filterChallenges(filterType) {
    console.log(`ğŸ” Filtering challenges by: ${filterType}`);
    
    // Update active filter button
    const filterButtons = document.querySelectorAll('#challengesFilter button');
    if (filterButtons.length > 0) {
        filterButtons.forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        });
        
        const filterBtn = document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1));
        if (filterBtn) {
            filterBtn.classList.add('btn-primary');
        }
    }
    
    // Filter challenges for current class
    const classChallenges = allChallenges.filter(challenge => 
        (challenge.challengerClass === currentClassCode || 
         challenge.opponentClass === currentClassCode)
    );
    
    let filteredChallenges = [];
    
    switch(filterType) {
        case 'all':
            filteredChallenges = classChallenges;
            break;
        case 'active':
            filteredChallenges = classChallenges.filter(c => c.status === 'active');
            break;
        case 'pending':
            filteredChallenges = classChallenges.filter(c => c.status === 'pending' && c.opponentClass === currentClassCode);
            break;
        case 'completed':
            filteredChallenges = classChallenges.filter(c => c.status === 'completed');
            break;
        case 'won':
            filteredChallenges = classChallenges.filter(c => 
                c.status === 'completed' && c.result && c.result.winner === currentClassCode
            );
            break;
        case 'lost':
            filteredChallenges = classChallenges.filter(c => 
                c.status === 'completed' && c.result && c.result.winner !== currentClassCode
            );
            break;
        default:
            filteredChallenges = classChallenges;
    }
    
    // Update display
    const allChallengesList = document.getElementById('allChallengesList');
    if (!allChallengesList) return;
    
    if (filteredChallenges.length === 0) {
        allChallengesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <div class="empty-state-title">No ${filterType} challenges</div>
                <div class="empty-state-description">
                    ${filterType === 'all' ? 'Create your first challenge with another teacher!' : 
                      filterType === 'pending' ? 'No pending challenge invitations.' :
                      filterType === 'active' ? 'No active challenges. Accept or create one!' :
                      filterType === 'completed' ? 'No completed challenges yet.' :
                      filterType === 'won' ? 'No won challenges yet. Keep competing!' :
                      'No lost challenges.'}
                </div>
                ${filterType === 'all' ? `
                <button class="btn btn-primary" onclick="showSection('create-challenge')" style="margin-top: 1rem;">
                    + Create New Challenge
                </button>
                ` : ''}
            </div>
        `;
    } else {
        // Use the renderChallengeCard function
        allChallengesList.innerHTML = filteredChallenges.map(challenge => 
            renderChallengeCard(challenge)
        ).join('');
    }
    
    console.log(`âœ… Displaying ${filteredChallenges.length} ${filterType} challenges`);
}

// 3. Fix the showChallengeDetails function (safe version)
function showChallengeDetails(challengeId) {
    console.log(`ğŸ“‹ Showing details for challenge: ${challengeId}`);
    
    const challenge = allChallenges.find(c => c.id === challengeId);
    if (!challenge) {
        console.error("Challenge not found:", challengeId);
        showNotification("Challenge not found", "error");
        return;
    }
    
    // Check if modal elements exist
    const modalElements = [
        'detailChallengeName', 'detailChallengeType', 'detailChallengeStatus',
        'detailMyClassName', 'detailMyClassCode', 'detailMyScore',
        'detailOpponentClassName', 'detailOpponentClassCode', 'detailOpponentScore',
        'detailProgressFill', 'detailTimeRemaining', 'detailTimeStarted',
        'detailChallengeMessage', 'detailResultText'
    ];
    
    // If modal doesn't exist, show simple alert with details
    if (!document.getElementById('detailChallengeName')) {
        alert(`Challenge Details:\n\n` +
              `Name: ${challenge.name}\n` +
              `Type: ${CHALLENGE_TYPES[challenge.type]?.name || 'Challenge'}\n` +
              `Status: ${challenge.status}\n` +
              `Your Score: ${challenge.myScore || 0}\n` +
              `Opponent Score: ${challenge.opponentScore || 0}\n` +
              `Progress: ${Math.round(challenge.progress || 0)}%\n` +
              `Time Remaining: ${challenge.timeRemaining || 'N/A'}`);
        return;
    }
    
    // Update modal content safely
    try {
        const challengeType = CHALLENGE_TYPES[challenge.type] || { name: 'Challenge' };
        const isActive = challenge.status === 'active';
        const isCompleted = challenge.status === 'completed';
        const isMyChallenge = challenge.challengerClass === currentClassCode;
        
        // Update basic info
        safeSetText('detailChallengeName', challenge.name || 'Unnamed Challenge');
        safeSetText('detailChallengeType', challengeType.name);
        safeSetText('detailChallengeStatus', isActive ? 'Active' : isCompleted ? 'Completed' : 'Pending');
        
        // My class info
        safeSetText('detailMyClassName', isMyChallenge ? 'You (Challenger)' : 'You');
        safeSetText('detailMyClassCode', currentClassCode || 'Unknown');
        safeSetText('detailMyScore', challenge.myScore || 0);
        safeSetClass('detailMyScore', `class-score ${challenge.myWinning && isActive ? 'winning' : ''}`);
        
        // Opponent info
        const opponentClass = isMyChallenge ? challenge.opponentClass : challenge.challengerClass;
        const opponentName = isMyChallenge ? challenge.opponentTeacherName : challenge.challengerTeacherName;
        safeSetText('detailOpponentClassName', `${opponentName || 'Teacher'}'s Class`);
        safeSetText('detailOpponentClassCode', opponentClass || 'Unknown');
        safeSetText('detailOpponentScore', challenge.opponentScore || 0);
        safeSetClass('detailOpponentScore', `class-score ${!challenge.myWinning && isActive ? 'losing' : ''}`);
        
        // Progress
        const progressFill = document.getElementById('detailProgressFill');
        if (progressFill) {
            progressFill.style.width = `${Math.round(challenge.progress || 0)}%`;
        }
        
        // Time info
        if (isActive) {
            safeSetText('detailTimeRemaining', `Ends in: ${challenge.timeRemaining || 'Calculating...'}`);
            safeSetText('detailTimeStarted', `Started: ${formatDate(challenge.createdAt)}`);
        } else if (isCompleted) {
            safeSetText('detailTimeRemaining', 'Challenge Completed');
            safeSetText('detailTimeStarted', `Ended: ${formatDate(challenge.result?.completedAt)}`);
        } else {
            safeSetText('detailTimeRemaining', 'Awaiting Response');
            safeSetText('detailTimeStarted', `Sent: ${formatDate(challenge.createdAt)}`);
        }
        
        // Message
        const messageContainer = document.getElementById('challengeMessageContainer');
        const messageElement = document.getElementById('detailChallengeMessage');
        if (messageContainer && messageElement) {
            if (challenge.message) {
                messageContainer.style.display = 'block';
                messageElement.textContent = challenge.message;
            } else {
                messageContainer.style.display = 'none';
            }
        }
        
        // Result
        const resultContainer = document.getElementById('challengeResult');
        const resultText = document.getElementById('detailResultText');
        if (resultContainer && resultText) {
            if (isCompleted && challenge.result) {
                resultContainer.style.display = 'block';
                const won = challenge.result.winner === currentClassCode;
                resultContainer.style.background = won ? 'var(--gradient-success)' : 'var(--gradient-danger)';
                resultText.textContent = won ? 
                    `You won! ${challenge.myScore || 0} vs ${challenge.opponentScore || 0} ${challengeType.unit || 'points'}` :
                    `You lost! ${challenge.myScore || 0} vs ${challenge.opponentScore || 0} ${challengeType.unit || 'points'}`;
            } else {
                resultContainer.style.display = 'none';
            }
        }
        
        // Show modal
        showModal('challengeDetailsModal');
        
    } catch (error) {
        console.error("Error showing challenge details:", error);
        showNotification("Error loading challenge details", "error");
    }
}

// Helper functions for safe DOM manipulation
function safeSetText(elementId, text) {
    const element = document.getElementById(elementId);
    if (element) element.textContent = text;
}

function safeSetClass(elementId, className) {
    const element = document.getElementById(elementId);
    if (element) element.className = className;
}

// 4. Fix the bubbleIcon error in chatbot (quick fix)
// Add this at the beginning of your showRealInsight function in the chatbot:
const bubbleIconElement = document.querySelector('.bubble-icon');
const bubbleMessageElement = document.querySelector('.bubble-message');
if (bubbleIconElement && bubbleMessageElement) {
    // Your existing chatbot code...
}

// 5. Fix the updateAllChallengesList function to use renderChallengeCard
function updateAllChallengesList() {
    const allChallengesList = document.getElementById('allChallengesList');
    if (!allChallengesList) return;
    
    // Filter challenges for current class
    const classChallenges = allChallenges.filter(challenge => 
        (challenge.challengerClass === currentClassCode || 
         challenge.opponentClass === currentClassCode)
    );
    
    if (classChallenges.length === 0) {
        allChallengesList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âš”ï¸</div>
                <div class="empty-state-title">No challenges for this class</div>
                <div class="empty-state-description">
                    <p>You have no challenges for class ${currentClassCode}.</p>
                    <button class="btn btn-primary" onclick="showSection('create-challenge')" style="margin-top: 1rem;">
                        + Create Your First Challenge
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    // Use renderChallengeCard for all challenges
    allChallengesList.innerHTML = classChallenges.map(challenge => 
        renderChallengeCard(challenge)
    ).join('');
    
    console.log(`âœ… Displayed ${classChallenges.length} challenges`);
}

// 6. Ensure challenges are visible when switching to challenges section
showSection = function(sectionId) {
    // Hide all sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected section
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
        sectionElement.style.display = 'block';
    }
    
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Find and activate the clicked nav item
    const navItems = document.querySelectorAll('.nav-item');
    for (let item of navItems) {
        if (item.textContent.includes(getNavItemText(sectionId))) {
            item.classList.add('active');
            break;
        }
    }
    
    // Update header
    updateDashboardHeader(sectionId);
    
    // Load specific data for section
    switch(sectionId) {
        case 'dashboard':
            // Already loaded
            break;
        case 'announcements':
            renderAllAnnouncements();
            break;
        case 'assignments':
            renderAllAssignments();
            break;
        case 'resources':
            renderAllResources();
            break;
        case 'polls':
            renderPolls();
            break;
        case 'students':
            renderStudents();
            break;
        case 'analytics':
            renderAnalytics();
            break;
        case 'challenges':
            // FIX: Always update challenges when visiting the section
            setTimeout(() => {
                filterChallenges('all');
                console.log("ğŸ”„ Challenges section loaded");
            }, 100);
            break;
        case 'settings':
            // Settings
            break;
        case 'create-challenge':
            // Reset form
            resetChallengeForm();
            break;
    }
    
    console.log(`ğŸ“± Switched to section: ${sectionId}`);
};

// 7. Simple fix to make sure challenges filter buttons work
document.addEventListener('DOMContentLoaded', function() {
    // Ensure filter buttons work
    setTimeout(() => {
        const filterButtons = document.querySelectorAll('#challengesFilter button');
        filterButtons.forEach(btn => {
            const onclick = btn.getAttribute('onclick');
            if (onclick) {
                btn.onclick = function() {
                    eval(onclick);
                };
            }
        });
        
        // Default to showing all challenges
        setTimeout(() => {
            if (window.location.hash !== '#challenges') {
                filterChallenges('all');
            }
        }, 1000);
    }, 2000);
});




// ========== AUTOMATIC CHALLENGE COMPLETION SYSTEM ==========

// Replace or enhance your existing startChallengeUpdates function
function startChallengeUpdates() {
    console.log("â° Starting challenge updates with automatic completion...");
    
    // Update scores every 30 seconds
    setInterval(() => {
        updateChallengeScores();
    }, 30000);
    
    // Check for completed challenges EVERY 10 SECONDS
    setInterval(() => {
        checkAndCompleteExpiredChallenges();
    }, 10000); // Every 10 seconds instead of 60 seconds
    
    // Also check immediately on page load
    setTimeout(() => {
        checkAndCompleteExpiredChallenges();
    }, 2000);
}

// NEW: Function to check and complete expired challenges
function checkAndCompleteExpiredChallenges() {
    if (!currentClassCode || activeChallenges.length === 0) return;
    
    const now = new Date();
    let completedAny = false;
    
    activeChallenges.forEach(challenge => {
        // Check if challenge has ended
        if (challenge.endsAt && new Date(challenge.endsAt) <= now) {
            console.log(`â° Challenge "${challenge.name}" has ended, declaring winner...`);
            completeChallengeWithWinner(challenge.id);
            completedAny = true;
        }
    });
    
    if (completedAny) {
        updateChallengesUI();
    }
}

// NEW: Enhanced complete challenge function WITH WINNER DECLARATION
async function completeChallengeWithWinner(challengeId) {
    const challenge = allChallenges.find(c => c.id === challengeId);
    if (!challenge || challenge.status !== 'active') return;
    
    console.log(`ğŸ† Completing challenge "${challenge.name}" and declaring winner...`);
    
    // Get final scores (ensure they're updated)
    const finalChallengerScore = await calculateChallengeScore(challenge.challengerClass, challenge.type);
    const finalOpponentScore = await calculateChallengeScore(challenge.opponentClass, challenge.type);
    
    // Determine winner
    let winnerClass;
    if (finalChallengerScore > finalOpponentScore) {
        winnerClass = challenge.challengerClass;
    } else if (finalOpponentScore > finalChallengerScore) {
        winnerClass = challenge.opponentClass;
    } else {
        // Tie - first to reach score wins, or if still tie, challenger wins
        winnerClass = challenge.challengerClass;
    }
    
    // Create result object
    const result = {
        winner: winnerClass,
        challengerScore: finalChallengerScore,
        opponentScore: finalOpponentScore,
        completedAt: new Date().toISOString(),
        isTie: finalChallengerScore === finalOpponentScore
    };
    
    // Update challenge status
    challenge.status = 'completed';
    challenge.result = result;
    challenge.challengerScore = finalChallengerScore;
    challenge.opponentScore = finalOpponentScore;
    challenge.myScore = calculateMyScore(challenge);
    challenge.opponentScore = calculateOpponentScore(challenge);
    challenge.myWinning = isMyClassWinning(challenge);
    challenge.progress = 100;
    
    // Move from active to completed
    const activeIndex = activeChallenges.findIndex(c => c.id === challengeId);
    if (activeIndex !== -1) {
        activeChallenges.splice(activeIndex, 1);
        completedChallenges.push(challenge);
    }
    
    // Update in Firebase or localStorage
    if (isDemoMode) {
        saveChallengesToLocalStorage();
    } else {
        try {
            await database.ref(`challenges/${challengeId}`).update({
                status: 'completed',
                result: result,
                challengerScore: finalChallengerScore,
                opponentScore: finalOpponentScore
            });
        } catch (error) {
            console.error("Error completing challenge in Firebase:", error);
        }
    }
    
    // Send celebration notifications
    sendChallengeCompletionNotifications(challenge, result);
    
    console.log(`âœ… Challenge completed! Winner: ${winnerClass}`);
    return true;
}

// NEW: Send notifications when challenge completes

  function sendChallengeCompletionNotifications(challenge, result) {
    const challengeType = CHALLENGE_TYPES[challenge.type] || { name: 'Challenge', unit: 'points' };
    const isWinner = result.winner === currentClassCode;
    
    // Post announcement that STUDENTS can see
    const announcementTitle = isWinner ? 
        `ğŸ‰ We Won the "${challenge.name}" Challenge!` :
        `ğŸ˜… Challenge "${challenge.name}" Completed`;
    
    const announcementMessage = isWinner ? 
        `CONGRATULATIONS! ğŸ†\n\nOur class WON the "${challenge.name}" challenge!\n\n` +
        `ğŸ Final Score: ${result.challengerScore} vs ${result.opponentScore} ${challengeType.unit}\n` +
        `ğŸ¯ Challenge Type: ${challengeType.name}\n\n` +
        `Amazing work, everyone!` :
        `The "${challenge.name}" challenge has ended.\n\n` +
        `ğŸ Final Score: ${result.challengerScore} vs ${result.opponentScore} ${challengeType.unit}\n` +
        `ğŸ¯ Challenge Type: ${challengeType.name}\n\n` +
        `Great effort everyone!`;
    
    // This function should save where STUDENTS can access
    postSystemAnnouncement(announcementTitle, announcementMessage);
    
    // Add to class activity feed (students can see this)
    const activity = {
        type: 'challenge_completed',
        message: isWinner ? 
            `ğŸ† We won the "${challenge.name}" challenge! ğŸ‰` : 
            `Challenge "${challenge.name}" completed`,
        challengeName: challenge.name,
        winner: result.winner,
        isOurClassWinner: isWinner,
        challengerScore: result.challengerScore,
        opponentScore: result.opponentScore,
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        // CRITICAL: Mark as visible to students
        visibleToStudents: true
    };
    
    if (!isDemoMode && database && database.ref) {
        // Save to classActivity where students can read
        database.ref(`classActivity/${currentClassCode}`).push().set(activity);
        
        // ALSO save to student-specific path
        database.ref(`studentNotifications/${currentClassCode}/challengeResults`).push().set({
            ...activity,
            timestamp: Date.now(),
            read: false
        });
    } else {
        activity.id = 'challenge_completed_' + Date.now();
        activityIds.add(activity.id);
        liveActivity.unshift(activity);
        renderLiveActivity();
    }
    
    // Show celebration on TEACHER side
    if (isWinner) {
        showNotification(`ğŸ† We won the "${challenge.name}" challenge!`, 'success');
        // Launch confetti will be handled by the "You won" button
    } else {
        showNotification(`Challenge "${challenge.name}" completed`, 'info');
    }
}

// NEW: Enhanced calculateChallengeScore with real-time data
async function calculateChallengeScore(classCode, challengeType) {
    // For demo mode, generate realistic scores
    if (isDemoMode) {
        return calculateDemoChallengeScore(classCode, challengeType);
    }
    
    try {
        if (challengeType === 'total_study_hours') {
            return await calculateStudyHours(classCode);
        } else if (challengeType === 'streak_count') {
            return await calculateAverageStreak(classCode);
        }
    } catch (error) {
        console.error(`Error calculating score for ${classCode}:`, error);
    }
    
    return 0;
}

// NEW: Demo score calculation with time-based progression
function calculateDemoChallengeScore(classCode, challengeType) {
    // Base score plus progression over time
    const isMyClass = classCode === currentClassCode;
    let baseScore, progressionFactor;
    
    if (challengeType === 'total_study_hours') {
        baseScore = isMyClass ? 25 : 20;
        progressionFactor = 0.2; // 20% possible increase over challenge duration
    } else if (challengeType === 'streak_count') {
        baseScore = isMyClass ? 4.5 : 3.8;
        progressionFactor = 0.3; // 30% possible increase
    } else {
        baseScore = isMyClass ? 100 : 80;
        progressionFactor = 0.15;
    }
    
    // Add random progression based on "effort"
    const randomProgression = Math.random() * progressionFactor;
    const finalScore = baseScore * (1 + randomProgression);
    
    return parseFloat(finalScore.toFixed(1));
}

// Also update the existing completeChallenge function to use the new one
const originalCompleteChallenge = completeChallenge;
completeChallenge = async function(challengeId) {
    return await completeChallengeWithWinner(challengeId);
};

// ========== VISUAL COUNTDOWN TIMER ==========

// Add countdown timer to challenge cards
function updateChallengeCountdowns() {
    document.querySelectorAll('.challenge-card').forEach(card => {
        const challengeId = card.dataset.challengeId;
        if (!challengeId) return;
        
        const challenge = allChallenges.find(c => c.id === challengeId);
        if (!challenge || challenge.status !== 'active') return;
        
        // Update time remaining display
        const timeElement = card.querySelector('.challenge-card-time');
        if (timeElement) {
            const timeRemaining = calculateTimeRemaining(challenge);
            timeElement.innerHTML = timeElement.innerHTML.replace(/â€¢.*days/, `â€¢ ${timeRemaining} remaining`);
        }
        
        // Update progress bar if exists
        const progressBar = card.querySelector('.challenge-card-progress div:last-child div');
        if (progressBar) {
            const progress = Math.round(challenge.progress);
            progressBar.style.width = `${progress}%`;
            
            // Update progress text
            const progressText = card.querySelector('.challenge-card-progress div:first-child span:last-child');
            if (progressText) {
                progressText.textContent = `${progress}%`;
            }
        }
    });
}

// Update the calculateTimeRemaining function to be more precise
function calculateTimeRemaining(challenge) {
    if (challenge.status !== 'active' || !challenge.endsAt) {
        return challenge.status === 'completed' ? "Completed" : "Not started";
    }
    
    const endsAt = new Date(challenge.endsAt);
    const now = new Date();
    
    if (now >= endsAt) {
        return "Ending...";
    }
    
    const diffMs = endsAt - now;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (diffDays > 0) {
        return `${diffDays}d ${diffHours}h`;
    } else if (diffHours > 0) {
        return `${diffHours}h ${diffMinutes}m`;
    } else {
        return `${diffMinutes}m`;
    }
}

// Update the renderChallengeCard function to include countdown
// Add this line in the challenge card HTML (around line where duration is shown):
// Change: <div class="challenge-card-time">vs ${opponentClass} â€¢ ${challenge.duration} days â€¢ ${challengeType.name}</div>
// To: <div class="challenge-card-time">vs ${opponentClass} â€¢ ${calculateTimeRemaining(challenge)} â€¢ ${challengeType.name}</div>

// ========== CHALLENGE REMINDERS ==========

// Send reminders when challenge is about to end
function sendChallengeReminders() {
    const now = new Date();
    
    activeChallenges.forEach(challenge => {
        if (!challenge.endsAt) return;
        
        const endsAt = new Date(challenge.endsAt);
        const hoursRemaining = Math.floor((endsAt - now) / (1000 * 60 * 60));
        
        // Send reminder when there's 1 hour left
        if (hoursRemaining === 1) {
            const reminderKey = `challenge_reminder_${challenge.id}`;
            const lastReminder = localStorage.getItem(reminderKey);
            
            if (!lastReminder || Date.now() - parseInt(lastReminder) > 30 * 60 * 1000) {
                showNotification(
                    `â° "${challenge.name}" challenge ends in 1 hour! Final push!`,
                    'warning'
                );
                localStorage.setItem(reminderKey, Date.now().toString());
            }
        }
        
        // Send reminder when there's 24 hours left
        if (hoursRemaining === 24) {
            const reminderKey = `challenge_reminder_24h_${challenge.id}`;
            const lastReminder = localStorage.getItem(reminderKey);
            
            if (!lastReminder) {
                showNotification(
                    `â° "${challenge.name}" challenge ends in 24 hours!`,
                    'info'
                );
                localStorage.setItem(reminderKey, Date.now().toString());
            }
        }
    });
}

// Update startChallengeUpdates to include reminders
const originalStartChallengeUpdates = startChallengeUpdates;
startChallengeUpdates = function() {
    originalStartChallengeUpdates();
    
    // Check for reminders every 5 minutes
    setInterval(() => {
        sendChallengeReminders();
    }, 5 * 60 * 1000);
    
    // Also update countdowns every minute
    setInterval(() => {
        updateChallengeCountdowns();
    }, 60 * 1000);
};

// ========== TEST FUNCTION ==========

// Manually test challenge completion
// function testChallengeCompletion() {
//     if (activeChallenges.length === 0) {
//         showNotification("No active challenges to test", "error");
//         return;
//     }
    
//     const challenge = activeChallenges[0];
//     if (confirm(`Test completion of "${challenge.name}"? This will declare a winner and end the challenge.`)) {
//         // Set end time to now
//         challenge.endsAt = new Date().toISOString();
//         completeChallengeWithWinner(challenge.id);
//         updateChallengesUI();
//         showNotification("Test challenge completion triggered", "success");
//     }
// }

// Add test button to challenges section
// document.addEventListener('DOMContentLoaded', function() {
//     setTimeout(() => {
//         const challengesHeader = document.querySelector('#challenges .content-header');
//         if (challengesHeader && !document.getElementById('testCompletionBtn')) {
//             const testBtn = document.createElement('button');
//             testBtn.id = 'testCompletionBtn';
//             testBtn.className = 'btn btn-warning';
//             testBtn.innerHTML = 'ğŸ§ª Test Completion';
//             testBtn.onclick = testChallengeCompletion;
//             testBtn.style.marginLeft = '10px';
//             testBtn.title = "Manually trigger challenge completion for testing";
//             challengesHeader.appendChild(testBtn);
//         }
//     }, 3000);
// });


// ========== DEBUG FUNCTION ==========
function debugChallenges() {
    console.log("=== CHALLENGES DEBUG INFO ===");
    console.log("Current class code:", currentClassCode);
    console.log("Teacher ID:", teacherId);
    console.log("All challenges:", allChallenges.length);
    console.log("Active challenges:", activeChallenges.length);
    console.log("Pending challenges:", pendingChallenges.length);
    console.log("Completed challenges:", completedChallenges.length);
    
    console.log("\n=== ALL CHALLENGES DETAILS ===");
    allChallenges.forEach((c, i) => {
        console.log(`${i+1}. ${c.name} (${c.id})`);
        console.log(`   Status: ${c.status}, Challenger: ${c.challengerClass}, Opponent: ${c.opponentClass}`);
        console.log(`   My class: ${currentClassCode}, Involved: ${(c.challengerClass === currentClassCode || c.opponentClass === currentClassCode) ? 'YES' : 'NO'}`);
    });
    
    alert(`Challenges Debug Info:\n\n` +
          `Current class: ${currentClassCode}\n` +
          `Total challenges: ${allChallenges.length}\n` +
          `Active: ${activeChallenges.length}\n` +
          `Pending: ${pendingChallenges.length}\n` +
          `Completed: ${completedChallenges.length}\n\n` +
          `Check console for full details.`);
}



// Call this when challenges section loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(addDebugButton, 3000);
});

// Reject challenge from notification
async function rejectChallengeFromNotification(challengeId) {
    if (!confirm("Decline this challenge? This cannot be undone.")) return;
    
    // Update challenge status
    if (isDemoMode) {
        const challenge = allChallenges.find(c => c.id === challengeId);
        if (challenge) {
            challenge.status = 'rejected';
            
            // Remove from pending
            const pendingIndex = pendingChallenges.findIndex(c => c.id === challengeId);
            if (pendingIndex !== -1) {
                pendingChallenges.splice(pendingIndex, 1);
            }
            
            saveChallengesToLocalStorage();
        }
    } else {
        try {
            await database.ref(`challenges/${challengeId}`).update({
                status: 'rejected'
            });
            
            // Update notification
            await database.ref(`notifications/${teacherId}/${challengeId}`).update({
                status: 'read',
                isAccepted: false
            });
        } catch (error) {
            console.error("Error rejecting challenge:", error);
        }
    }
    
    // Remove notification
    const notifIndex = notifications.findIndex(n => n.challengeId === challengeId);
    if (notifIndex !== -1) {
        notifications.splice(notifIndex, 1);
    }
    
    // Update UI
    updateChallengesUI();
    renderNotifications();
    updateNotificationBadges();
    
    showNotification("Challenge declined", "info");
}

// Mark all as read
async function markAllAsRead() {
    notifications.forEach(notification => {
        notification.status = 'read';
    });
    
    if (!isDemoMode) {
        try {
            // Update all in Firebase
            const updates = {};
            notifications.forEach(notification => {
                updates[`notifications/${teacherId}/${notification.id}/status`] = 'read';
            });
            await database.ref().update(updates);
        } catch (error) {
            console.error("Error marking all as read:", error);
        }
    } else {
        saveNotificationsToLocalStorage();
    }
    
    renderNotifications();
    updateNotificationBadges();
    showNotification("All notifications marked as read", "success");
}

// Helper function to get time ago
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    if (diffMinutes < 1) return 'Just now';
    if (diffMinutes < 60) return `${diffMinutes}m ago`;
    
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}


function debugCreateChallenge() {
    console.log("=== DEBUG CREATE CHALLENGE ===");
    console.log("1. currentClassCode:", currentClassCode);
    console.log("2. create-challenge element exists:", !!document.getElementById('create-challenge'));
    console.log("3. create-challenge element display:", document.getElementById('create-challenge')?.style.display);
    console.log("4. dashboard element display:", document.getElementById('dashboard')?.style.display);
    console.log("5. showSection function exists:", typeof showSection);
    
    // Test showing the section directly
    if (document.getElementById('create-challenge')) {
        console.log("6. Testing showSection directly...");
        showSection('create-challenge');
    }
}



function navigateToCreateChallenge() {
    // Hide all sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show create-challenge section
    const createChallengeSection = document.getElementById('create-challenge');
    if (createChallengeSection) {
        createChallengeSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Find and activate the create challenge nav item
        const navItems = document.querySelectorAll('.nav-item');
        for (let item of navItems) {
            if (item.textContent.includes('âš”ï¸') || item.textContent.includes('Challenge')) {
                item.classList.add('active');
                break;
            }
        }
        
        // Reset form
        resetChallengeForm();
        
        console.log("âœ… Successfully navigated to create challenge");
    } else {
        console.error("âŒ Create challenge section not found");
        showNotification("Create challenge section not found", "error");
    }
}


// ========== LOCALSTORAGE AUTO-BACKUP SYSTEM ==========
// This system automatically saves ALL data to localStorage without affecting existing features

// Global backup interval
let backupInterval;

// Initialize backup system
function initializeBackupSystem() {
    console.log("ğŸ’¾ Initializing auto-backup system...");
    
    // Save immediately on initialization
    setTimeout(saveAllDataToLocalStorage, 1000);
    
    // Start auto-backup every 30 seconds
    backupInterval = setInterval(saveAllDataToLocalStorage, 30000);
    
    // Also backup when window/tab is closed
    window.addEventListener('beforeunload', saveAllDataToLocalStorage);
    
    // Backup on page visibility change (when tab becomes hidden)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            saveAllDataToLocalStorage();
        }
    });
    
    console.log("âœ… Auto-backup system initialized");
}

// Save ALL data to localStorage
function saveAllDataToLocalStorage() {
    try {
        const backupTimestamp = new Date().toISOString();
        
        // 1. Save teacher profile data
        localStorage.setItem('teacher_userId', teacherId || '');
        localStorage.setItem('teacher_name', teacherName || 'Teacher');
        localStorage.setItem('teacher_email', currentUser?.email || '');
        localStorage.setItem('teacher_demoMode', isDemoMode.toString());
        
        // 2. Save ALL classes data
        if (teacherClasses && teacherClasses.length > 0) {
            localStorage.setItem('teacher_all_classes', JSON.stringify(teacherClasses));
            localStorage.setItem('teacher_current_class_index', selectedClassIndex.toString());
            localStorage.setItem('teacher_current_class_code', currentClassCode || '');
            localStorage.setItem('teacher_current_class_id', currentClassId || '');
        }
        
        // 3. Save current class data (if any)
        if (currentClassCode) {
            // Students data
            localStorage.setItem(`class_${currentClassCode}_students`, JSON.stringify(students));
            
            // Announcements data
            localStorage.setItem(`class_${currentClassCode}_announcements`, JSON.stringify(announcements));
            
            // Assignments data  
            localStorage.setItem(`class_${currentClassCode}_assignments`, JSON.stringify(assignments));
            
            // Resources data
            localStorage.setItem(`class_${currentClassCode}_resources`, JSON.stringify(resources));
            
            // Polls data
            localStorage.setItem(`class_${currentClassCode}_polls`, JSON.stringify(polls));
            
            // Activity data
            localStorage.setItem(`class_${currentClassCode}_activity`, JSON.stringify(liveActivity));
            
            // Challenge data
            localStorage.setItem(`class_${currentClassCode}_challenges_all`, JSON.stringify(allChallenges));
            localStorage.setItem(`class_${currentClassCode}_challenges_active`, JSON.stringify(activeChallenges));
            localStorage.setItem(`class_${currentClassCode}_challenges_pending`, JSON.stringify(pendingChallenges));
            localStorage.setItem(`class_${currentClassCode}_challenges_completed`, JSON.stringify(completedChallenges));
            
            // Milestone settings
            if (currentClassCode in milestoneConfigCache) {
                localStorage.setItem(`class_${currentClassCode}_milestones`, JSON.stringify(milestoneConfigCache[currentClassCode]));
            }
            
            // Streak chain data
            localStorage.setItem(`class_${currentClassCode}_streak_chain`, JSON.stringify({
                lastUpdated: backupTimestamp,
                chainData: getStreakChainData()
            }));
        }
        
        // 4. Save theme and UI state
        localStorage.setItem('teacher_theme', document.body.className || 'light');
        localStorage.setItem('teacher_sidebar_collapsed', isSidebarCollapsed.toString());
        
        // 5. Save backup timestamp
        localStorage.setItem('last_backup_timestamp', backupTimestamp);
        
        console.log(`ğŸ’¾ Auto-backup completed at ${backupTimestamp}`);
        
    } catch (error) {
        console.error("âŒ Error in auto-backup:", error);
    }
}

// Load ALL data from localStorage
function loadAllDataFromLocalStorage() {
    console.log("ğŸ“‚ Loading all data from localStorage...");
    
    try {
        // 1. Load teacher profile
        const savedTeacherId = localStorage.getItem('teacher_userId');
        if (savedTeacherId) {
            teacherId = savedTeacherId;
        }
        
        const savedTeacherName = localStorage.getItem('teacher_name');
        if (savedTeacherName) {
            teacherName = savedTeacherName;
            document.getElementById('teacherName').value = teacherName;
        }
        
        const savedDemoMode = localStorage.getItem('teacher_demoMode');
        if (savedDemoMode === 'true') {
            isDemoMode = true;
            document.getElementById('demoModeBtn').style.display = 'flex';
        }
        
        // 2. Load classes data
        const savedClasses = localStorage.getItem('teacher_all_classes');
        if (savedClasses) {
            teacherClasses = JSON.parse(savedClasses);
            
            const savedClassIndex = localStorage.getItem('teacher_current_class_index');
            if (savedClassIndex) {
                selectedClassIndex = parseInt(savedClassIndex);
            }
            
            const savedClassCode = localStorage.getItem('teacher_current_class_code');
            if (savedClassCode && teacherClasses[selectedClassIndex]?.code === savedClassCode) {
                currentClassCode = savedClassCode;
                currentClassId = localStorage.getItem('teacher_current_class_id') || teacherClasses[selectedClassIndex]?.id;
            }
        }
        
        // 3. Load current class data (if any)
        if (currentClassCode) {
            // Load students
            const savedStudents = localStorage.getItem(`class_${currentClassCode}_students`);
            if (savedStudents) {
                students = JSON.parse(savedStudents);
            }
            
            // Load announcements
            const savedAnnouncements = localStorage.getItem(`class_${currentClassCode}_announcements`);
            if (savedAnnouncements) {
                announcements = JSON.parse(savedAnnouncements);
                announcementIds = new Set(announcements.map(a => a.id));
            }
            
            // Load assignments
            const savedAssignments = localStorage.getItem(`class_${currentClassCode}_assignments`);
            if (savedAssignments) {
                assignments = JSON.parse(savedAssignments);
            }
            
            // Load resources
            const savedResources = localStorage.getItem(`class_${currentClassCode}_resources`);
            if (savedResources) {
                resources = JSON.parse(savedResources);
                resourceIds = new Set(resources.map(r => r.id));
            }
            
            // Load polls
            const savedPolls = localStorage.getItem(`class_${currentClassCode}_polls`);
            if (savedPolls) {
                polls = JSON.parse(savedPolls);
                pollIds = new Set(polls.map(p => p.id));
            }
            
            // Load activity
            const savedActivity = localStorage.getItem(`class_${currentClassCode}_activity`);
            if (savedActivity) {
                liveActivity = JSON.parse(savedActivity);
                activityIds = new Set(liveActivity.map(a => a.id));
            }
            
            // Load challenges
            const savedAllChallenges = localStorage.getItem(`class_${currentClassCode}_challenges_all`);
            const savedActiveChallenges = localStorage.getItem(`class_${currentClassCode}_challenges_active`);
            const savedPendingChallenges = localStorage.getItem(`class_${currentClassCode}_challenges_pending`);
            const savedCompletedChallenges = localStorage.getItem(`class_${currentClassCode}_challenges_completed`);
            
            if (savedAllChallenges) {
                allChallenges = JSON.parse(savedAllChallenges);
            }
            if (savedActiveChallenges) {
                activeChallenges = JSON.parse(savedActiveChallenges);
            }
            if (savedPendingChallenges) {
                pendingChallenges = JSON.parse(savedPendingChallenges);
            }
            if (savedCompletedChallenges) {
                completedChallenges = JSON.parse(savedCompletedChallenges);
            }
            
            // Load milestones
            const savedMilestones = localStorage.getItem(`class_${currentClassCode}_milestones`);
            if (savedMilestones) {
                milestoneConfigCache[currentClassCode] = JSON.parse(savedMilestones);
            }
            
            // Load notifications
            loadNotificationsFromLocalStorage();
        }
        
        // 4. Load theme and UI state
        const savedTheme = localStorage.getItem('teacher_theme');
        if (savedTheme) {
            changeTheme(savedTheme);
        }
        
        const savedSidebarState = localStorage.getItem('teacher_sidebar_collapsed');
        if (savedSidebarState === 'true') {
            isSidebarCollapsed = true;
        }
        
        console.log("âœ… Successfully loaded all data from localStorage");
        
        // Show last backup time
        const lastBackup = localStorage.getItem('last_backup_timestamp');
        if (lastBackup) {
            const backupDate = new Date(lastBackup);
            console.log(`ğŸ“… Last backup: ${backupDate.toLocaleString()}`);
        }
        
        return true;
        
    } catch (error) {
        console.error("âŒ Error loading data from localStorage:", error);
        return false;
    }
}

// Helper function for streak chain data
function getStreakChainData() {
    const chainContainer = document.getElementById('streakChain');
    if (!chainContainer) return null;
    
    const chainLinks = [];
    chainContainer.querySelectorAll('.chain-link').forEach(link => {
        chainLinks.push({
            day: link.dataset.day,
            status: link.classList.contains('completed') ? 'completed' : 
                   link.classList.contains('pending') ? 'pending' : 'active'
        });
    });
    
    return {
        totalLinks: document.getElementById('totalChainLinks')?.textContent || '0',
        chainLinks: chainLinks
    };
}

// Enhanced save functions with auto-backup
const originalSaveAnnouncementsToLocalStorage = saveAnnouncementsToLocalStorage;
saveAnnouncementsToLocalStorage = function() {
    originalSaveAnnouncementsToLocalStorage();
    saveAllDataToLocalStorage(); // Trigger full backup
};

const originalSaveAssignmentsToLocalStorage = saveAssignmentsToLocalStorage;
saveAssignmentsToLocalStorage = function() {
    originalSaveAssignmentsToLocalStorage();
    saveAllDataToLocalStorage();
};

const originalSaveResourcesToLocalStorage = saveResourcesToLocalStorage;
saveResourcesToLocalStorage = function() {
    originalSaveResourcesToLocalStorage();
    saveAllDataToLocalStorage();
};

const originalSavePollsToLocalStorage = savePollsToLocalStorage;
savePollsToLocalStorage = function() {
    originalSavePollsToLocalStorage();
    saveAllDataToLocalStorage();
};

const originalSaveChallengesToLocalStorage = saveChallengesToLocalStorage;
saveChallengesToLocalStorage = function() {
    originalSaveChallengesToLocalStorage();
    saveAllDataToLocalStorage();
};

// ========== FIXED TEACHER INITIALIZATION WITH CHALLENGES ==========

// Replace the enhanced initializeTeacher function with this version
initializeTeacher = async function() {
    console.log("ğŸ¯ Enhanced teacher initialization with localStorage...");
    
    // First, try to load existing data from localStorage
    const dataLoaded = loadAllDataFromLocalStorage();
    
    if (dataLoaded && teacherClasses.length > 0) {
        // Data loaded successfully, update UI
        updateClassSelector();
        updateUI();
        renderAllData();
        updateStats();
        
        // INITIALIZE CHALLENGES BEFORE ANYTHING ELSE
        setTimeout(() => {
            initializeChallenges(); // This is the key fix
            getLiveActivity(currentClassCode);
            initializeSidebarHeatmap();
        }, 500);
        
        showNotification("Dashboard loaded from localStorage! âœ…", "success");
        
        // Still load from Firebase if not in demo mode
        if (!isDemoMode) {
            try {
                await loadClassesFromFirebase();
                if (currentClassCode) {
                    await loadClassData();
                    await loadMilestoneSettingsForClass();
                    setupRealtimeListeners();
                    
                    // Sync challenges with Firebase data
                    syncChallengesWithFirebase();
                }
            } catch (error) {
                console.error("Firebase sync failed, using localStorage data:", error);
            }
        }
        
    } else {
        // No data in localStorage, use original initialization
        await originalInitializeTeacher();
        
        // Initialize backup system
        initializeBackupSystem();
    }
};

// Add this function to sync challenges between localStorage and Firebase
async function syncChallengesWithFirebase() {
    if (isDemoMode || !currentClassCode) return;
    
    console.log("ğŸ”„ Syncing challenges with Firebase...");
    
    try {
        // Load challenges from Firebase
        const snapshot = await database.ref('challenges').once('value');
        
        if (snapshot.exists()) {
            let firebaseChallenges = [];
            
            snapshot.forEach(child => {
                const challenge = child.val();
                const challengeId = child.key;
                
                // Check if this challenge involves our current class
                if (challenge.challengerClass === currentClassCode || 
                    challenge.opponentClass === currentClassCode) {
                    
                    const enrichedChallenge = {
                        id: challengeId,
                        ...challenge,
                        myScore: calculateMyScore(challenge),
                        opponentScore: calculateOpponentScore(challenge),
                        myWinning: isMyClassWinning(challenge),
                        timeRemaining: calculateTimeRemaining(challenge),
                        progress: calculateChallengeProgress(challenge)
                    };
                    
                    firebaseChallenges.push(enrichedChallenge);
                }
            });
            
            console.log(`ğŸ“Š Found ${firebaseChallenges.length} challenges in Firebase for class ${currentClassCode}`);
            
            // Merge Firebase challenges with localStorage challenges
            const localStorageChallenges = allChallenges;
            
            // Create a map of challenge IDs for quick lookup
            const challengeMap = new Map();
            
            // First, add all localStorage challenges
            localStorageChallenges.forEach(challenge => {
                challengeMap.set(challenge.id, challenge);
            });
            
            // Then add/update with Firebase challenges
            firebaseChallenges.forEach(fbChallenge => {
                const existingChallenge = challengeMap.get(fbChallenge.id);
                
                if (existingChallenge) {
                    // Update existing challenge with Firebase data
                    Object.assign(existingChallenge, fbChallenge);
                } else {
                    // Add new challenge from Firebase
                    challengeMap.set(fbChallenge.id, fbChallenge);
                }
            });
            
            // Convert back to array
            allChallenges = Array.from(challengeMap.values());
            
            // Re-categorize challenges
            activeChallenges = allChallenges.filter(c => c.status === 'active');
            pendingChallenges = allChallenges.filter(c => c.status === 'pending' && c.opponentClass === currentClassCode);
            completedChallenges = allChallenges.filter(c => c.status === 'completed');
            
            // Save merged data back to localStorage
            saveChallengesToLocalStorage();
            
            // Update UI
            updateChallengesUI();
            
            console.log(`âœ… Synced challenges: ${allChallenges.length} total`);
        }
    } catch (error) {
        console.error("Error syncing challenges with Firebase:", error);
    }
}

// Also update the loadClassData function to ensure challenges load
const originalLoadClassData = loadClassData;
loadClassData = async function() {
    await originalLoadClassData();
    
    // Load challenges AFTER class data loads
    setTimeout(() => {
        if (!window.challengesInitialized) {
            initializeChallenges();
            window.challengesInitialized = true;
        }
    }, 1000);
};


// Data recovery function (can be called manually)
function recoverDataFromBackup() {
    if (confirm("Recover all data from localStorage backup? This will overwrite current data.")) {
        loadAllDataFromLocalStorage();
        showNotification("Data recovered successfully! âœ…", "success");
        
        // Refresh UI
        updateClassSelector();
        updateUI();
        renderAllData();
        updateStats();
        updateChallengesUI();
    }
}

// Manual backup function
function createManualBackup() {
    saveAllDataToLocalStorage();
    showNotification("Manual backup created successfully! ğŸ’¾", "success");
}

// View backup info
function showBackupInfo() {
    const lastBackup = localStorage.getItem('last_backup_timestamp');
    let message = "No backups found.";
    
    if (lastBackup) {
        const backupDate = new Date(lastBackup);
        message = `Last backup: ${backupDate.toLocaleString()}`;
        
        // Calculate data size
        let totalSize = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('teacher_') || key.startsWith('class_')) {
                totalSize += localStorage.getItem(key).length * 2; // Approximate bytes
            }
        }
        
        message += `\nTotal backup size: ${(totalSize / 1024).toFixed(2)} KB`;
    }
    
    alert(`ğŸ“Š Backup Information:\n\n${message}\n\nAuto-backup runs every 30 seconds.`);
}

// Add backup button to settings
function addBackupButtonToSettings() {
    const settingsSection = document.getElementById('settings');
    if (!settingsSection) return;
    
    // Check if backup button already exists
    if (document.getElementById('backupManagementSection')) return;
    
    const backupHTML = `
        <div id="backupManagementSection" style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
            <h3>ğŸ’¾ LocalStorage Backup</h3>
            <div class="pro-tip" style="margin-bottom: var(--spacing-md);">
                <strong>ğŸ›¡ï¸ Data Protection</strong>
                All your data is automatically saved to browser storage every 30 seconds. No data will be lost even if you close the browser.
            </div>
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); flex-wrap: wrap;">
                <button class="btn btn-success" onclick="createManualBackup()">ğŸ’¾ Create Manual Backup</button>
                <button class="btn btn-secondary" onclick="recoverDataFromBackup()">ğŸ”„ Recover Data</button>
                <button class="btn btn-info" onclick="showBackupInfo()">ğŸ“Š Backup Info</button>
                <button class="btn btn-warning" onclick="exportAllBackupData()">ğŸ“¤ Export All Data</button>
            </div>
        </div>
    `;
    
    // Insert before the logout button or at the end
    const dataManagementSection = settingsSection.querySelector('.content-body > div:last-child');
    if (dataManagementSection) {
        dataManagementSection.insertAdjacentHTML('beforebegin', backupHTML);
    }
}

// Export all backup data
function exportAllBackupData() {
    const allData = {};
    
    // Collect all teacher-related data from localStorage
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('teacher_') || key.startsWith('class_')) {
            try {
                allData[key] = JSON.parse(localStorage.getItem(key));
            } catch {
                allData[key] = localStorage.getItem(key);
            }
        }
    }
    
    allData.exportDate = new Date().toISOString();
    allData.exportVersion = "1.0";
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `teacher-full-backup-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("Full backup exported successfully! ğŸ“¤", "success");
}

// Initialize backup system when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add backup section to settings
    setTimeout(addBackupButtonToSettings, 2000);
    
    // Also trigger auto-backup when any form is submitted
    document.addEventListener('submit', function(e) {
        if (e.target.tagName === 'FORM' || e.target.closest('form')) {
            setTimeout(saveAllDataToLocalStorage, 500);
        }
    });
    
    // Backup when switching classes
    const originalSwitchClass = switchClass;
    switchClass = async function(classIndex) {
        // Save current class data before switching
        saveAllDataToLocalStorage();
        await originalSwitchClass(classIndex);
    };
    
    console.log("âœ… LocalStorage backup system ready");
});











// ========== ENHANCED CELEBRATION SYSTEM WITH SOUND ==========

// Sound management system
const celebrationSounds = {
    win: new Audio('https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.mp3'),
    achievement: new Audio('https://assets.mixkit.co/sfx/download/mixkit-achievement-bell-600.mp3'),
    confetti: new Audio('https://assets.mixkit.co/sfx/download/mixkit-party-horn-sound-2927.mp3'),
    celebration: new Audio('https://assets.mixkit.co/sfx/download/mixkit-crowd-celebration-01-2231.mp3')
};


// Set volume immediately
Object.values(celebrationSounds).forEach(sound => {
    sound.volume = 0.3;
    sound.preload = 'auto';
    sound.load(); // Preload the sounds
});



// Add this function to debug confetti
function debugConfetti() {
    const canvas = document.getElementById('confettiCanvas');
    console.log("Confetti Canvas:", {
        exists: !!canvas,
        display: canvas?.style.display,
        width: canvas?.width,
        height: canvas?.height,
        style: canvas?.style.cssText
    });
    
    // Force show and test
    if (canvas) {
        canvas.style.display = 'block';
        canvas.style.zIndex = '99999';
        canvas.style.opacity = '1';
        launchFullScreenConfetti();
        console.log("Confetti launched for debugging");
    }
}



// Call this when page loads
setTimeout(addConfettiTestButton, 3000);


// Global confetti system
let isConfettiActive = false;

// Enhanced confetti with sound
function launchEnhancedConfetti(type = 'celebration') {
    if (isConfettiActive) return; // Prevent multiple confetti at once
    
    console.log(`ğŸ‰ Launching enhanced confetti with ${type} sound`);
    isConfettiActive = true;
    
    // Play celebration sound
    playCelebrationSound(type);
    
    // Launch visual confetti
    launchFullScreenConfetti();
    
    // Reset flag after animation
    setTimeout(() => {
        isConfettiActive = false;
    }, 5000);
}

// Play celebration sound
function playCelebrationSound(type = 'celebration') {
    try {
        const sound = celebrationSounds[type] || celebrationSounds.celebration;
        sound.currentTime = 0;
        sound.volume = getSoundVolume();
        
        // Play with user interaction requirement handling
        const playPromise = sound.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.log("Sound play failed (may need user interaction):", error);
                // Fallback: Play on next user interaction
                document.addEventListener('click', function playOnce() {
                    sound.play().catch(() => {});
                    document.removeEventListener('click', playOnce);
                });
            });
        }
    } catch (error) {
        console.log("Sound error:", error);
    }
}

// Get sound volume from settings
function getSoundVolume() {
    const savedVolume = localStorage.getItem('celebration_volume');
    return savedVolume ? parseFloat(savedVolume) : 0.5;
}

// Save sound volume setting
function setSoundVolume(volume) {
    localStorage.setItem('celebration_volume', volume.toString());
    Object.values(celebrationSounds).forEach(sound => {
        sound.volume = volume;
    });
}

// ========== FULL-SCREEN CONFETTI CANVAS ==========

// Enhanced confetti canvas

let confettiParticles = [];
const CONFETTI_COLORS = [
    '#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', 
    '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#8b5cf6'
];

// Initialize confetti canvas
function initConfettiCanvas() {
    const canvas = document.getElementById('confettiCanvas');
    if (!canvas) {
        // Create canvas if it doesn't exist
        const newCanvas = document.createElement('canvas');
        newCanvas.id = 'confettiCanvas';
        newCanvas.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            display: none;
        `;
        document.body.appendChild(canvas);
    }
    
    resizeConfettiCanvas();
    confettiContext = document.getElementById('confettiCanvas').getContext('2d');
}

// Resize canvas for high DPI screens
function resizeConfettiCanvas() {
    const canvas = document.getElementById('confettiCanvas');
    if (!canvas) return;
    
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = '100vw';
    canvas.style.height = '100vh';
    
    if (confettiContext) {
        confettiContext.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
}

// Launch full-screen confetti
function launchFullScreenConfetti() {
    const canvas = document.getElementById('confettiCanvas');
    if (!canvas) {
        initConfettiCanvas();
    }
    
    canvas.style.display = 'block';
    confettiContext = canvas.getContext('2d');
    
    // Create 300 particles for full effect
    confettiParticles = [];
    const particleCount = 300;
    
    for (let i = 0; i < particleCount; i++) {
        confettiParticles.push({
            x: Math.random() * canvas.width,
            y: -Math.random() * canvas.height * 0.5,
            size: Math.random() * 12 + 4,
            color: CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)],
            speed: Math.random() * 5 + 2,
            angle: Math.random() * Math.PI * 2,
            rotation: Math.random() * Math.PI * 2,
            rotationSpeed: (Math.random() - 0.5) * 0.2,
            shape: Math.random() > 0.5 ? 'circle' : 'rectangle',
            gravity: 0.05 + Math.random() * 0.03,
            wind: (Math.random() - 0.5) * 0.5
        });
    }
    
    // Start animation
    animateConfetti();
}

// Animate confetti
function animateConfetti() {
    if (!confettiContext) return;
    
    const canvas = document.getElementById('confettiCanvas');
    const ctx = confettiContext;
    
    // Clear with slight fade for trail effect
    ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    let activeParticles = 0;
    
    confettiParticles.forEach(particle => {
        // Update position
        particle.x += Math.sin(particle.angle) * particle.wind;
        particle.y += particle.speed;
        particle.angle += 0.05;
        particle.rotation += particle.rotationSpeed;
        
        // Apply gravity
        particle.speed += particle.gravity;
        
        // Draw particle
        ctx.save();
        ctx.translate(particle.x, particle.y);
        ctx.rotate(particle.rotation);
        ctx.fillStyle = particle.color;
        
        if (particle.shape === 'circle') {
            // Draw circle
            ctx.beginPath();
            ctx.arc(0, 0, particle.size / 2, 0, Math.PI * 2);
            ctx.fill();
        } else {
            // Draw rectangle (confetti shape)
            ctx.fillRect(-particle.size / 2, -particle.size / 4, particle.size, particle.size / 2);
        }
        
        ctx.restore();
        
        // Keep particle if still on screen
        if (particle.y < canvas.height) {
            activeParticles++;
        }
    });
    
    // Continue animation if particles remain
    if (activeParticles > 0) {
        requestAnimationFrame(animateConfetti);
    } else {
        // Hide canvas when done
        setTimeout(() => {
            canvas.style.display = 'none';
        }, 500);
    }
}

// ========== CELEBRATION TRIGGERS ==========

// Enhanced celebration for challenge wins
function celebrateChallengeWin(challenge, result) {
    const isWinner = result.winner === currentClassCode;
    
    // Play appropriate sound
    playCelebrationSound(isWinner ? 'win' : 'achievement');
    
    // Launch confetti for winners
    if (isWinner) {
        setTimeout(() => launchFullScreenConfetti(), 500);
    }
    
    // Show notification
    showNotification(
        isWinner ? 
            `ğŸ† We won the "${challenge.name}" challenge!` :
            `ğŸ˜… Challenge "${challenge.name}" completed`,
        isWinner ? 'success' : 'info'
    );
}

// Enhanced milestone celebration
function celebrateClassMilestone(key, message) {
    // Play achievement sound
    playCelebrationSound('achievement');
    
    // Launch confetti
    setTimeout(() => launchFullScreenConfetti(), 300);
    
    // Show notification
    showNotification(`ğŸ‰ ${message}`, "success");
}

// Enhanced streak milestone
function celebrateChainMilestone(totalStreakDays) {
    // Play celebration sound
    playCelebrationSound('celebration');
    
    // Launch confetti
    setTimeout(() => launchFullScreenConfetti(), 400);
    
    showNotification(`ğŸ‰ Class Milestone! ${totalStreakDays} links in the streak chain!`, 'success');
}

// Test celebration function
function testCelebrationWithSound() {
    if (confirm("Test full celebration with sound and confetti?")) {
        playCelebrationSound('win');
        launchFullScreenConfetti();
        showNotification("ğŸ‰ Test celebration with sound!", "success");
    }
}

// ========== SOUND SETTINGS UI ==========

// Add sound settings to teacher settings
function addSoundSettingsToUI() {
    const settingsSection = document.getElementById('settings');
    if (!settingsSection) return;
    
    // Check if sound settings already exist
    if (document.getElementById('soundSettingsSection')) return;
    
    const soundSettingsHTML = `
        <div id="soundSettingsSection" style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
            <h3>ğŸ”Š Celebration Sounds</h3>
            <div class="pro-tip" style="margin-bottom: var(--spacing-md);">
                <strong>ğŸµ Sound Effects</strong>
                Celebration sounds play when your class wins challenges or reaches milestones.
            </div>
            <div style="margin-bottom: var(--spacing-lg);">
                <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                    Celebration Volume
                </label>
                <input type="range" id="celebrationVolume" min="0" max="1" step="0.1" 
                       value="${getSoundVolume()}"
                       style="width: 100%; margin-bottom: var(--spacing-sm);"
                       oninput="updateSoundVolume(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--text-muted);">
                    <span>Mute</span>
                    <span id="volumeDisplay">${Math.round(getSoundVolume() * 100)}%</span>
                    <span>Loud</span>
                </div>
            </div>
            <div style="display: flex; gap: var(--spacing-md);">
                <button class="btn btn-success" onclick="testCelebrationWithSound()" style="flex: 1;">
                    ğŸ”Š Test Celebration
                </button>
                <button class="btn btn-secondary" onclick="toggleSoundMute()" style="flex: 1;">
                    ğŸ”‡ Toggle Mute
                </button>
            </div>
        </div>
    `;
    
    // Insert before data management section
    const dataManagementSection = settingsSection.querySelector('.content-body > div:last-child');
    if (dataManagementSection) {
        dataManagementSection.insertAdjacentHTML('beforebegin', soundSettingsHTML);
    }
}

// Update sound volume
function updateSoundVolume(volume) {
    setSoundVolume(parseFloat(volume));
    document.getElementById('volumeDisplay').textContent = `${Math.round(volume * 100)}%`;
}

// Toggle sound mute
function toggleSoundMute() {
    const currentVolume = getSoundVolume();
    const newVolume = currentVolume > 0 ? 0 : 0.5;
    setSoundVolume(newVolume);
    
    const volumeSlider = document.getElementById('celebrationVolume');
    const volumeDisplay = document.getElementById('volumeDisplay');
    
    if (volumeSlider) volumeSlider.value = newVolume;
    if (volumeDisplay) volumeDisplay.textContent = `${Math.round(newVolume * 100)}%`;
    
    showNotification(newVolume > 0 ? "ğŸ”Š Sound enabled" : "ğŸ”‡ Sound muted", "info");
}

// ========== INITIALIZATION ==========



// Update sound initialization
function initSounds() {
    // Try different sound sources
    const soundSources = {
        win: [
            'https://assets.mixkit.co/sfx/download/mixkit-winning-chimes-2015.mp3',
            'https://www.soundjay.com/buttons/button-3.mp3' // Fallback
        ],
        celebration: [
            'https://assets.mixkit.co/sfx/download/mixkit-crowd-celebration-01-2231.mp3',
            'https://www.soundjay.com/buttons/button-37a.mp3' // Fallback
        ]
    };
    
    celebrationSounds.win = new Audio();
    celebrationSounds.celebration = new Audio();
    
    // Try first source, fall back to second if it fails
    celebrationSounds.win.src = soundSources.win[0];
    celebrationSounds.celebration.src = soundSources.celebration[0];
    
    // Set volume
    celebrationSounds.win.volume = 0.3;
    celebrationSounds.celebration.volume = 0.3;
    
    // Preload
    celebrationSounds.win.load();
    celebrationSounds.celebration.load();
    
    console.log("âœ… Sounds initialized");
}

// Call this on page load
setTimeout(initSounds, 1000);







// Initialize celebration system
function initCelebrationSystem() {
    console.log("ğŸ‰ Initializing celebration system...");
    
    // Initialize confetti canvas
    initConfettiCanvas();
    
    // Add sound settings to UI
    setTimeout(addSoundSettingsToUI, 2000);
    
    // Handle window resize
    window.addEventListener('resize', resizeConfettiCanvas);
    
    // Test sound on first load (with user interaction)
    document.addEventListener('click', function initSoundsOnce() {
        // Preload sounds on first click
        Object.values(celebrationSounds).forEach(sound => {
            sound.load();
        });
        document.removeEventListener('click', initSoundsOnce);
    });
    
    console.log("âœ… Celebration system initialized");
}

// Replace existing launchConfetti function
launchConfetti = launchFullScreenConfetti;

// ========== INTEGRATION WITH EXISTING CODE ==========

// Update the completeChallengeWithWinner function to use enhanced celebration
// Replace the sendChallengeCompletionNotifications function with this enhanced version:
function sendChallengeCompletionNotifications(challenge, result) {
    const challengeType = CHALLENGE_TYPES[challenge.type] || { name: 'Challenge', unit: 'points' };
    const isWinner = result.winner === currentClassCode;
    const wonText = isWinner ? "won" : "lost";
    
    // Enhanced celebration with sound and confetti
    celebrateChallengeWin(challenge, result);
    
    // Post announcement to class
    const announcementTitle = isWinner ? 
        `ğŸ‰ We Won the "${challenge.name}" Challenge!` :
        `ğŸ˜… Challenge "${challenge.name}" Completed`;
    
    const announcementMessage = isWinner ? 
        `CONGRATULATIONS! ğŸ†\n\nOur class WON the "${challenge.name}" challenge against ${challenge.challengerClass === currentClassCode ? challenge.opponentClass : challenge.challengerClass}!\n\n` +
        `ğŸ Final Score: ${result.challengerScore} vs ${result.opponentScore} ${challengeType.unit}\n` +
        `ğŸ¯ Challenge Type: ${challengeType.name}\n` +
        `â±ï¸ Duration: ${challenge.duration} days\n\n` +
        `Amazing work, everyone! Your hard studying paid off! Keep up the great work! ğŸ’ª` :
        `The "${challenge.name}" challenge has ended.\n\n` +
        `ğŸ Final Score: ${result.challengerScore} vs ${result.opponentScore} ${challengeType.unit}\n` +
        `ğŸ¯ Challenge Type: ${challengeType.name}\n` +
        `â±ï¸ Duration: ${challenge.duration} days\n\n` +
        `While we didn't win this time, great effort everyone! Let's keep studying and do better next time! ğŸ’ª`;
    
    postSystemAnnouncement(announcementTitle, announcementMessage);
    
    // Add to activity feed with celebration emoji
    const activity = {
        type: 'challenge_completed',
        message: `ğŸ† Challenge "${challenge.name}" completed! ${result.winner === currentClassCode ? 'WE WON! ğŸ‰' : `${result.winner} wins`}`,
        challengeName: challenge.name,
        winner: result.winner,
        challengerScore: result.challengerScore,
        opponentScore: result.opponentScore,
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        isCelebration: isWinner
    };
    
    if (!isDemoMode && database && database.ref) {
        database.ref(`classActivity/${currentClassCode}`).push().set(activity);
    } else {
        activity.id = 'challenge_completed_' + Date.now();
        activityIds.add(activity.id);
        liveActivity.unshift(activity);
        renderLiveActivity();
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initCelebrationSystem, 1000);
});

// Also add sound to test celebration button in settings
// Update your existing testCelebration function:
testCelebration = function() {
    if (!currentClassCode) {
        showNotification("Please select a class first", "error");
        return;
    }
    
    const message = "Test celebration â€” great job, class!";
    playCelebrationSound('celebration');
    launchFullScreenConfetti();
    postSystemAnnouncement("Class Celebration (Test)", `ğŸ‰ ${message}`);
    showNotification(`ğŸ‰ ${message}`, "success");
};


// Initialize everything on load
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ¯ Initializing enhanced features...");
    
    // Initialize confetti canvas
    setTimeout(() => {
        const canvas = document.createElement('canvas');
        canvas.id = 'confettiCanvas';
        canvas.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 99999;
            display: none;
        `;
        document.body.appendChild(canvas);
        console.log("âœ… Confetti canvas created");
    }, 1000);
    
    // Add debug panel
    setTimeout(addDebugPanel, 2000);
    
    // Test a simple confetti function
    window.testSimpleConfetti = function() {
        const canvas = document.getElementById('confettiCanvas');
        if (!canvas) return;
        
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        
        // Simple confetti
        for (let i = 0; i < 50; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const size = Math.random() * 10 + 5;
            const color = ['#4f46e5', '#10b981', '#f59e0b'][Math.floor(Math.random() * 3)];
            
            ctx.fillStyle = color;
            ctx.fillRect(x, y, size, size);
        }
        
        setTimeout(() => {
            canvas.style.display = 'none';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }, 2000);
    };
    
    console.log("âœ… Debug functions added");
});




// ========== FIX FOR UNDEFINED FUNCTIONS ==========

// Fix for bubbleIcon reference error in chatbot
const bubbleIcon = document.querySelector('.bubble-icon');
const bubbleMessage = document.querySelector('.bubble-message');

// Original initializeTeacher function that was referenced
async function originalInitializeTeacher() {
    console.log("ğŸ¯ Original teacher initialization...");
    
    showNotification("Loading your classes...", "info");
    
    if (isDemoMode) {
        loadTeacherClassesFromLocalStorage();
    } else {
        await loadClassesFromFirebase();
    }
    
    if (teacherClasses.length === 0) {
        console.log("No classes found, creating default class...");
        await createDefaultClass();
    }
    
    if (teacherClasses.length > 0) {
        currentClassId = teacherClasses[0].id;
        currentClassCode = teacherClasses[0].code;
        selectedClassIndex = 0;
        console.log(`ğŸ“ Current class set to: ${teacherClasses[0].name}`);
    }
    
    updateClassSelector();
    updateUI();
    
    if (currentClassCode) {
        await loadClassData();
        await loadMilestoneSettingsForClass();
    }
    
    if (!isDemoMode) {
        setupRealtimeListeners();
    }
    
    loadSidebarState();
    updateSidebarToggleVisibility();
    
    console.log(`âœ… Teacher dashboard initialized with ${teacherClasses.length} classes`);
    showNotification("Dashboard loaded successfully! âœ…", "success");
    
    const savedTheme = localStorage.getItem('teacherTheme') || 'light';
    changeTheme(savedTheme);
    updateMobileTitle();
    
    setTimeout(() => {
        initializeChallenges();
    }, 1000);
    
    setTimeout(() => {
        initializeChallenges();
    }, 1000);
}

// Add debug button function
function addDebugButton() {
    const challengesHeader = document.querySelector('#challenges .content-header');
    if (challengesHeader && !document.getElementById('challengeDebugBtn')) {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'challengeDebugBtn';
        debugBtn.className = 'btn btn-warning';
        debugBtn.innerHTML = 'ğŸ› Debug';
        debugBtn.onclick = function() {
            console.log("=== DEBUG CHALLENGES ===");
            console.log("Current class:", currentClassCode);
            console.log("All challenges:", allChallenges.length);
            console.log("Active:", activeChallenges.length);
            console.log("Pending:", pendingChallenges.length);
            console.log("Students:", students.length);
            
            alert(`Debug Info:\nClass: ${currentClassCode}\nChallenges: ${allChallenges.length}\nStudents: ${students.length}\nCheck console for details.`);
        };
        debugBtn.style.marginLeft = '10px';
        challengesHeader.appendChild(debugBtn);
    }
}

// Add confetti test button
function addConfettiTestButton() {
    const settingsSection = document.getElementById('settings');
    if (settingsSection && !document.getElementById('confettiTestBtn')) {
        const testBtn = document.createElement('button');
        testBtn.id = 'confettiTestBtn';
        testBtn.className = 'btn btn-success';
        testBtn.innerHTML = 'ğŸ‰ Test Confetti';
        testBtn.onclick = function() {
            console.log("Testing confetti...");
            launchConfetti();
            showNotification("Confetti test! ğŸ‰", "success");
        };
        testBtn.style.marginTop = '10px';
        testBtn.style.width = '100%';
        
        const milestoneDiv = settingsSection.querySelector('.form-group:has(#milestoneTotalStreak)');
        if (milestoneDiv) {
            milestoneDiv.appendChild(testBtn);
        }
    }
}

// Initialize confetti context safely
let confettiContext = null;

// Fixed resize function that checks initialization
function resizeConfettiCanvas() {
    const canvas = document.getElementById('confettiCanvas');
    if (!canvas) {
        console.log("Confetti canvas not found, creating...");
        const newCanvas = document.createElement('canvas');
        newCanvas.id = 'confettiCanvas';
        newCanvas.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            display: none;
        `;
        document.body.appendChild(canvas);
        return;
    }
    
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = '100vw';
    canvas.style.height = '100vh';
    
    // Only initialize context if we're going to use it
    if (!confettiContext) {
        confettiContext = canvas.getContext('2d');
        if (confettiContext) {
            confettiContext.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
    }
}

// Simple confetti function that works
function launchConfetti() {
    console.log("ğŸ‰ Launching confetti...");
    
    const canvas = document.getElementById('confettiCanvas');
    if (!canvas) {
        console.error("âŒ Confetti canvas not found!");
        return;
    }
    
    const ctx = canvas.getContext('2d');
    canvas.style.display = 'block';
    canvas.style.zIndex = '99999';
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Create simple confetti
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'];
    
    for (let i = 0; i < 100; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const size = Math.random() * 10 + 5;
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, size, size);
    }
    
    // Hide after 3 seconds
    setTimeout(() => {
        canvas.style.display = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }, 3000);
}

// Show create challenge modal
function showCreateChallengeModal() {
    if (!currentClassCode) {
        showNotification("Please select a class first", "error");
        return;
    }
    
    showSection('create-challenge');
    resetChallengeForm();
}

// ========== INITIALIZE MISSING ELEMENTS ON LOAD ==========

document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ‘©â€ğŸ« Teacher Mode fixing initialization...");
    
    // Initialize confetti canvas
    setTimeout(() => {
        resizeConfettiCanvas();
        addConfettiTestButton();
    }, 2000);
    
    // Add debug button
    setTimeout(() => {
        addDebugButton();
    }, 3000);
    
    // Fix the login error by setting the original function
    window.originalInitializeTeacher = originalInitializeTeacher;
    
    console.log("âœ… Fixed functions initialized");
});
</script>



</body>
</html>
