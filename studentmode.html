<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grindly | Student Mode</title>
<meta name="viewport">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<!-- Chart.js for Statistics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700;800&family=Poppins:wght@400;500;600;700&family=Sora:wght@400;500;600;700&family=Cinzel:wght@500;600;700&display=swap');
/* ===== CSS VARIABLES ===== */
:root {
  /* Light theme (default) */
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --accent: #4f46e5;
  --accent-dark: #4338ca;
  --accent-light: #e0e7ff;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  
  /* Spacing */
  --spacing-xs: 0.5rem;
  --spacing-sm: 0.75rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;
  
  /* Border Radius */
  --radius-sm: 0.5rem;
  --radius: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.25rem;
  --radius-2xl: 1.5rem;
  
  /* Shadows */
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
  
  /* Transitions */
  --transition-fast: 0.18s cubic-bezier(0.22, 1, 0.36, 1);
  --transition: 0.32s cubic-bezier(0.22, 1, 0.36, 1);
  --transition-slow: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
  
  /* Gradients */
  --gradient-primary: linear-gradient(135deg, var(--accent), var(--accent-dark));
  --gradient-success: linear-gradient(135deg, var(--success), #059669);
  --gradient-warning: linear-gradient(135deg, var(--warning), #d97706);
  --gradient-danger: linear-gradient(135deg, var(--danger), #dc2626);
  --gradient-info: linear-gradient(135deg, var(--info), #2563eb);
  --gradient-purple: linear-gradient(135deg, var(--purple), #7c3aed);

  /* Poll (theme-adaptive) */
  --poll-bg: #ffffff;
  --poll-text: #202124;
  --poll-muted: #5f6368;
  --poll-border: #dadce0;
  --poll-divider: #e0e0e0;
  --poll-input-bg: #ffffff;
  --poll-button-bg: #f1f3f4;
  --poll-button-hover: #e8eaed;
  --poll-radio: #5f6368;

  /* Aggregate heatmap */
  --heat-0: rgba(148, 163, 184, 0.2);
  --heat-1: rgba(79, 70, 229, 0.2);
  --heat-2: rgba(79, 70, 229, 0.4);
  --heat-3: rgba(79, 70, 229, 0.65);
  --heat-4: rgba(79, 70, 229, 0.9);
}

/* ===== THEMES ===== */
body.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #334155;
  --accent-light: rgba(79, 70, 229, 0.2);
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
  --poll-bg: #111827;
  --poll-text: #e5e7eb;
  --poll-muted: #9ca3af;
  --poll-border: #374151;
  --poll-divider: #1f2937;
  --poll-input-bg: #0b1220;
  --poll-button-bg: #1f2937;
  --poll-button-hover: #374151;
  --poll-radio: #9ca3af;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(99, 102, 241, 0.25);
  --heat-2: rgba(99, 102, 241, 0.45);
  --heat-3: rgba(99, 102, 241, 0.7);
  --heat-4: rgba(99, 102, 241, 0.95);
}

body.ocean {
  --bg: #0c4a6e;
  --card: #075985;
  --text: #e0f2fe;
  --text-muted: #7dd3fc;
  --border: #0369a1;
  --accent: #0891b2;
  --accent-dark: #0e7490;
  --accent-light: rgba(8, 145, 178, 0.2);
  --poll-bg: #0b4a6a;
  --poll-text: #e0f2fe;
  --poll-muted: #bae6fd;
  --poll-border: rgba(125, 211, 252, 0.35);
  --poll-divider: rgba(125, 211, 252, 0.2);
  --poll-input-bg: rgba(3, 105, 161, 0.25);
  --poll-button-bg: rgba(125, 211, 252, 0.2);
  --poll-button-hover: rgba(125, 211, 252, 0.3);
  --poll-radio: #7dd3fc;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(8, 145, 178, 0.25);
  --heat-2: rgba(8, 145, 178, 0.5);
  --heat-3: rgba(8, 145, 178, 0.75);
  --heat-4: rgba(8, 145, 178, 0.95);
}

body.ocean .pro-tip {
  background: linear-gradient(135deg, rgba(8, 145, 178, 0.25), rgba(14, 116, 144, 0.2));
  border-color: rgba(125, 211, 252, 0.35);
}

body.ocean .pro-tip strong {
  color: #e0f2fe;
}

body.forest {
  --bg: #064e3b;
  --card: #047857;
  --text: #d1fae5;
  --text-muted: #a7f3d0;
  --border: #059669;
  --accent: #059669;
  --accent-dark: #047857;
  --accent-light: rgba(5, 150, 105, 0.2);
  --poll-bg: #065f46;
  --poll-text: #ecfdf5;
  --poll-muted: #a7f3d0;
  --poll-border: rgba(110, 231, 183, 0.35);
  --poll-divider: rgba(110, 231, 183, 0.2);
  --poll-input-bg: rgba(6, 95, 70, 0.35);
  --poll-button-bg: rgba(110, 231, 183, 0.2);
  --poll-button-hover: rgba(110, 231, 183, 0.3);
  --poll-radio: #6ee7b7;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(16, 185, 129, 0.25);
  --heat-2: rgba(16, 185, 129, 0.5);
  --heat-3: rgba(16, 185, 129, 0.75);
  --heat-4: rgba(16, 185, 129, 0.95);
}

body.forest .pro-tip {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.22), rgba(5, 150, 105, 0.18));
  border-color: rgba(110, 231, 183, 0.4);
}

body.forest .pro-tip strong {
  color: #ecfdf5;
}

body.sunset {
  --bg: #7c2d12;
  --card: #c2410c;
  --text: #ffedd5;
  --text-muted: #fed7aa;
  --border: #ea580c;
  --accent: #ea580c;
  --accent-dark: #c2410c;
  --accent-light: rgba(234, 88, 12, 0.2);
  --poll-bg: #7c2d12;
  --poll-text: #ffedd5;
  --poll-muted: #fed7aa;
  --poll-border: rgba(253, 186, 116, 0.4);
  --poll-divider: rgba(253, 186, 116, 0.25);
  --poll-input-bg: rgba(124, 45, 18, 0.4);
  --poll-button-bg: rgba(253, 186, 116, 0.2);
  --poll-button-hover: rgba(253, 186, 116, 0.3);
  --poll-radio: #fdba74;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(234, 88, 12, 0.25);
  --heat-2: rgba(234, 88, 12, 0.5);
  --heat-3: rgba(234, 88, 12, 0.75);
  --heat-4: rgba(234, 88, 12, 0.95);
}

body.sunset .pro-tip {
  background: linear-gradient(135deg, rgba(251, 146, 60, 0.25), rgba(234, 88, 12, 0.18));
  border-color: rgba(253, 186, 116, 0.45);
}

body.sunset .pro-tip strong {
  color: #fff7ed;
}

body.purple {
  --bg: #1e1b4b;
  --card: #312e81;
  --text: #e0e7ff;
  --text-muted: #a5b4fc;
  --border: #4f46e5;
  --accent: #8b5cf6;
  --accent-dark: #7c3aed;
  --accent-light: rgba(139, 92, 246, 0.2);
  --poll-bg: #1f1b5c;
  --poll-text: #ede9fe;
  --poll-muted: #c7d2fe;
  --poll-border: rgba(167, 139, 250, 0.4);
  --poll-divider: rgba(167, 139, 250, 0.25);
  --poll-input-bg: rgba(30, 27, 75, 0.55);
  --poll-button-bg: rgba(167, 139, 250, 0.2);
  --poll-button-hover: rgba(167, 139, 250, 0.3);
  --poll-radio: #c4b5fd;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(139, 92, 246, 0.25);
  --heat-2: rgba(139, 92, 246, 0.5);
  --heat-3: rgba(139, 92, 246, 0.75);
  --heat-4: rgba(139, 92, 246, 0.95);
}

body.purple .pro-tip {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.22), rgba(76, 29, 149, 0.2));
  border-color: rgba(167, 139, 250, 0.4);
}

body.purple .pro-tip strong {
  color: #ede9fe;
}

body.rainbow {
  --bg: #0b1020;
  --card: rgba(255, 255, 255, 0.08);
  --text: #ffffff;
  --text-muted: #e5e7ff;
  --border: rgba(255, 255, 255, 0.2);
  --accent: #ff7ad9;
  --accent-dark: #c026d3;
  --accent-light: rgba(255, 122, 217, 0.2);
  --success: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  --gradient-primary: linear-gradient(135deg, #ff7ad9, #7c3aed, #3b82f6, #22c55e, #f59e0b, #ef4444);
  --gradient-success: linear-gradient(135deg, #22c55e, #16a34a);
  --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
  --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
  --gradient-info: linear-gradient(135deg, #3b82f6, #2563eb);
  --gradient-purple: linear-gradient(135deg, #8b5cf6, #7c3aed);
  --poll-bg: rgba(15, 23, 42, 0.75);
  --poll-text: #ffffff;
  --poll-muted: #e5e7ff;
  --poll-border: rgba(255, 255, 255, 0.25);
  --poll-divider: rgba(255, 255, 255, 0.15);
  --poll-input-bg: rgba(17, 24, 39, 0.6);
  --poll-button-bg: rgba(255, 255, 255, 0.12);
  --poll-button-hover: rgba(255, 255, 255, 0.2);
  --poll-radio: #e5e7ff;
  --heat-0: rgba(148, 163, 184, 0.18);
  --heat-1: rgba(255, 122, 217, 0.25);
  --heat-2: rgba(59, 130, 246, 0.5);
  --heat-3: rgba(34, 197, 94, 0.75);
  --heat-4: rgba(245, 158, 11, 0.95);
}

body.rainbow {
  background:
    radial-gradient(800px 420px at 10% -5%, rgba(255, 122, 217, 0.25), transparent 60%),
    radial-gradient(900px 420px at 90% 0%, rgba(59, 130, 246, 0.22), transparent 60%),
    radial-gradient(700px 380px at 50% 10%, rgba(34, 197, 94, 0.2), transparent 70%),
    linear-gradient(135deg, #0b1020 0%, #111b3a 55%, #0b1020 100%);
}

body.rainbow .pro-tip {
  background: linear-gradient(135deg, rgba(255, 122, 217, 0.2), rgba(59, 130, 246, 0.18));
  border-color: rgba(255, 255, 255, 0.25);
}

/* ===== PREMIUM THEME - ULTRA ENHANCED ===== */
body.premium {
  --bg: #0a1219;
  --card: rgba(18, 28, 40, 0.98);
  --text: #f0f8ff;
  --text-muted: #a6c1e0;
  --border: rgba(64, 156, 255, 0.3);
  --accent: #40c9ff;
  --accent-dark: #2d9cdb;
  --accent-light: rgba(64, 201, 255, 0.15);
  --success: #00e6a9;
  --warning: #ffb347;
  --danger: #ff6b8b;
  --info: #6a93ff;
  --purple: #c084fc;
  
  /* Premium gradients */
  --gradient-primary: linear-gradient(135deg, #40c9ff 0%, #497fff 50%, #c084fc 100%);
  --gradient-success: linear-gradient(135deg, #00e6a9, #00b894);
  --gradient-warning: linear-gradient(135deg, #ffb347, #ff8c00);
  --gradient-danger: linear-gradient(135deg, #ff6b8b, #ff416c);
  --gradient-info: linear-gradient(135deg, #6a93ff, #4d7cff);
  --gradient-purple: linear-gradient(135deg, #c084fc, #a855f7);
  
  /* Enhanced shadows */
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.5);
  --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.6);
  --shadow-xl: 0 25px 60px rgba(0, 0, 0, 0.7);
  
  /* Heatmap */
  --heat-0: rgba(96, 165, 250, 0.1);
  --heat-1: rgba(64, 201, 255, 0.25);
  --heat-2: rgba(64, 201, 255, 0.45);
  --heat-3: rgba(108, 92, 231, 0.7);
  --heat-4: rgba(192, 132, 252, 0.95);
  
  /* Poll */
  --poll-bg: rgba(18, 28, 40, 0.95);
  --poll-text: #f0f8ff;
  --poll-muted: #a6c1e0;
  --poll-border: rgba(64, 156, 255, 0.4);
  --poll-divider: rgba(96, 165, 250, 0.2);
  --poll-input-bg: rgba(30, 41, 59, 0.7);
  --poll-button-bg: rgba(64, 156, 255, 0.15);
  --poll-button-hover: rgba(64, 156, 255, 0.25);
  --poll-radio: #6a93ff;
}

/* Premium background with depth */
body.premium {
  background:
    radial-gradient(ellipse at 20% 20%, rgba(64, 201, 255, 0.15) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(192, 132, 252, 0.12) 0%, transparent 60%),
    radial-gradient(ellipse at 40% 80%, rgba(0, 230, 169, 0.1) 0%, transparent 60%),
    linear-gradient(135deg, #0a1219 0%, #0f1a2a 50%, #0a1219 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

/* Premium glowing particles */
body.premium::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    radial-gradient(circle at 15% 25%, rgba(64, 201, 255, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 85% 30%, rgba(192, 132, 252, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 50% 70%, rgba(0, 230, 169, 0.15) 0%, transparent 50%);
  opacity: 0.4;
  z-index: 0;
  pointer-events: none;
  animation: premiumGlow 20s ease-in-out infinite alternate;
}

@keyframes premiumGlow {
  0% { opacity: 0.3; filter: hue-rotate(0deg); }
  50% { opacity: 0.6; }
  100% { opacity: 0.3; filter: hue-rotate(20deg); }
}

/* Premium typography */
body.premium {
  font-family: 'Sora', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  letter-spacing: 0.01em;
  line-height: 1.7;
}

body.premium h1,
body.premium h2,
body.premium h3,
body.premium h4,
body.premium h5,
body.premium h6 {
  font-family: 'Sora', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 700;
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, #40c9ff, #6a93ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  background-size: 200% auto;
  animation: textShimmer 8s ease-in-out infinite;
}

@keyframes textShimmer {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* Premium cards with glass effect */
body.premium .content-card,
body.premium .form-card,
body.premium .stats-overview-card,
body.premium .metric-card,
body.premium .class-card,
body.premium .leaderboard-item,
body.premium .study-partner-card,
body.premium .badges-card,
body.premium .chart-card,
body.premium .tool-item,
body.premium .assignment-item,
body.premium .classroom-item,
body.premium .task-item,
body.premium .pro-tip {
  background: linear-gradient(
    145deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.03) 100%
  );
  backdrop-filter: none;
  border: 1px solid rgba(64, 156, 255, 0.2);
  border-radius: 16px;
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
}

body.premium .content-card:hover,
body.premium .form-card:hover,
body.premium .stats-overview-card:hover,
body.premium .metric-card:hover,
body.premium .class-card:hover,
body.premium .leaderboard-item:hover,
body.premium .study-partner-card:hover,
body.premium .badges-card:hover,
body.premium .chart-card:hover,
body.premium .tool-item:hover,
body.premium .assignment-item:hover,
body.premium .classroom-item:hover,
body.premium .task-item:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: var(--shadow-xl);
  border-color: rgba(64, 201, 255, 0.5);
}

/* Premium card glow effect */
body.premium .content-card::before,
body.premium .form-card::before,
body.premium .stats-overview-card::before,
body.premium .metric-card::before,
body.premium .class-card::before,
body.premium .leaderboard-item::before,
body.premium .badges-card::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 16px;
  padding: 1px;
  background: linear-gradient(
    135deg,
    rgba(64, 201, 255, 0.4),
    rgba(106, 147, 255, 0.4),
    rgba(192, 132, 252, 0.4)
  );
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

body.premium .content-card:hover::before,
body.premium .form-card:hover::before,
body.premium .stats-overview-card:hover::before,
body.premium .metric-card:hover::before,
body.premium .class-card:hover::before,
body.premium .leaderboard-item:hover::before,
body.premium .badges-card:hover::before {
  opacity: 1;
}

/* Premium sidebar */
body.premium .sidebar {
  background: linear-gradient(
    180deg,
    rgba(18, 28, 40, 0.95) 0%,
    rgba(10, 18, 30, 0.98) 100%
  );
  border-right: 1px solid rgba(64, 156, 255, 0.3);
  box-shadow: 20px 0 60px rgba(0, 0, 0, 0.5);
}

body.premium .sidebar-stats,
body.premium .class-switcher,
body.premium .stories-section,
body.premium .heatmap-section {
  background: rgba(30, 41, 59, 0.7);
  border: 1px solid rgba(64, 156, 255, 0.25);
  border-radius: 12px;
}

/* Premium buttons */
body.premium .btn {
  font-weight: 600;
  letter-spacing: 0.02em;
  border-radius: 12px;
  padding: 12px 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

body.premium .btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

body.premium .btn:hover::before {
  width: 300px;
  height: 300px;
}

body.premium .btn-primary {
  background: var(--gradient-primary);
  border: none;
  box-shadow: 0 8px 32px rgba(64, 201, 255, 0.3);
}

body.premium .btn-primary:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(64, 201, 255, 0.5);
}

body.premium .btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(64, 156, 255, 0.3);
  color: var(--text);
}

body.premium .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(64, 201, 255, 0.5);
  transform: translateY(-4px);
}

/* Premium form elements */
body.premium input,
body.premium textarea,
body.premium select {
  background: rgba(30, 41, 59, 0.7);
  border: 1px solid rgba(64, 156, 255, 0.3);
  border-radius: 12px;
  padding: 14px 16px;
  color: var(--text);
  transition: all 0.3s ease;
}

body.premium input:focus,
body.premium textarea:focus,
body.premium select:focus {
  outline: none;
  border-color: #40c9ff;
  box-shadow: 0 0 0 3px rgba(64, 201, 255, 0.2);
  background: rgba(30, 41, 59, 0.9);
}

/* Premium stats and metrics */
body.premium .stat-card,
body.premium .stats-overview-card,
body.premium .metric-card {
  background: linear-gradient(
    145deg,
    rgba(64, 201, 255, 0.1) 0%,
    rgba(106, 147, 255, 0.05) 100%
  );
}

body.premium .stat-icon {
  background: var(--gradient-primary);
  box-shadow: 0 8px 24px rgba(64, 201, 255, 0.3);
}

body.premium .stat-number,
body.premium .stats-overview-number,
body.premium .metric-value {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 800;
}

/* Premium streak card */
body.premium .streak-card {
  background: linear-gradient(135deg, #40c9ff, #6a93ff, #c084fc);
  box-shadow: 0 15px 40px rgba(64, 201, 255, 0.3);
}

/* Premium motivation card */
body.premium .motivation-card {
  background: linear-gradient(135deg, #c084fc, #ff6b8b, #ffb347);
  box-shadow: 0 15px 40px rgba(192, 132, 252, 0.3);
}

/* Premium leaderboard */
body.premium .leaderboard-item.you {
  background: linear-gradient(135deg, rgba(64, 201, 255, 0.2), rgba(192, 132, 252, 0.2));
  border: 1px solid rgba(64, 201, 255, 0.4);
}

body.premium .leaderboard-rank {
  color: #40c9ff;
  font-weight: 900;
}

body.premium .rank-1 .leaderboard-rank { color: #ffb347; }
body.premium .rank-2 .leaderboard-rank { color: #a6c1e0; }
body.premium .rank-3 .leaderboard-rank { color: #c084fc; }

/* Premium badges */
body.premium .badge-item {
  background: linear-gradient(
    145deg,
    rgba(64, 201, 255, 0.1) 0%,
    rgba(192, 132, 252, 0.05) 100%
  );
  border: 1px solid rgba(64, 156, 255, 0.2);
}

body.premium .badge-icon {
  background: var(--gradient-primary);
  color: white;
  box-shadow: 0 6px 20px rgba(64, 201, 255, 0.3);
}

/* Premium heatmap */
body.premium .heatmap-cell.level-0 { background: rgba(64, 156, 255, 0.1); }
body.premium .heatmap-cell.level-1 { background: rgba(64, 156, 255, 0.3); }
body.premium .heatmap-cell.level-2 { background: rgba(64, 156, 255, 0.5); }
body.premium .heatmap-cell.level-3 { background: rgba(64, 156, 255, 0.7); }
body.premium .heatmap-cell.level-4 { background: rgba(64, 156, 255, 0.9); }

/* Premium pro tip */
body.premium .pro-tip {
  background: linear-gradient(135deg, rgba(64, 201, 255, 0.15), rgba(106, 147, 255, 0.1));
  border-left: 4px solid #40c9ff;
  border-color: rgba(64, 156, 255, 0.3);
}

body.premium .pro-tip strong {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Premium toast */
body.premium .toast {
  background: linear-gradient(
    145deg,
    rgba(18, 28, 40, 0.95) 0%,
    rgba(10, 18, 30, 0.98) 100%
  );
  border-left: 4px solid #40c9ff;
  border: 1px solid rgba(64, 156, 255, 0.3);
  box-shadow: var(--shadow-xl);
}

/* Premium navigation */
body.premium .nav-item {
  border-radius: 12px;
  border: 1px solid transparent;
}

body.premium .nav-item:hover {
  background: rgba(64, 201, 255, 0.1);
  border-color: rgba(64, 201, 255, 0.3);
}

body.premium .nav-item.active {
  background: var(--gradient-primary);
  border-color: transparent;
  box-shadow: 0 8px 24px rgba(64, 201, 255, 0.4);
}

/* Premium chatbot */
body.premium .chatbot-btn {
  background: var(--gradient-primary);
  box-shadow: 0 15px 40px rgba(64, 201, 255, 0.4);
}

/* Premium modal */
body.premium .referral-modal,
body.premium .rainbow-modal,
body.premium .forest-modal,
body.premium .story-modal {
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: none;
}

body.premium .referral-modal-card,
body.premium .rainbow-modal-card,
body.premium .forest-modal-card,
body.premium .story-modal-content {
  background: linear-gradient(
    145deg,
    rgba(18, 28, 40, 0.98) 0%,
    rgba(10, 18, 30, 0.98) 100%
  );
  border: 1px solid rgba(64, 156, 255, 0.3);
  box-shadow: var(--shadow-xl);
}

/* Premium whiteboard */
body.premium .memory-whiteboard,
body.premium #studentMemoryWhiteboard {
  background: linear-gradient(45deg, rgba(18, 28, 40, 0.9) 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, rgba(18, 28, 40, 0.9) 75%);
  background-size: 40px 40px;
  background-color: #0a1219;
  border: 2px solid rgba(64, 156, 255, 0.3);
}

body.premium .sticky-note,
body.premium .student-sticky-note {
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(64, 156, 255, 0.2);
}

/* Premium scrollbar */
body.premium ::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

body.premium ::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.5);
  border-radius: 10px;
}

body.premium ::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  border-radius: 10px;
  border: 2px solid rgba(30, 41, 59, 0.5);
}

body.premium ::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #6a93ff, #c084fc);
}

/* Premium animations */
@keyframes premiumFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

@keyframes premiumPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

body.premium .student-emoji {
  animation: premiumFloat 3s ease-in-out infinite;
}

/* Premium loading */
body.premium .loading::after {
  border: 3px solid rgba(64, 156, 255, 0.3);
  border-top-color: #40c9ff;
}

/* Premium empty state */
body.premium .empty-state-icon {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  opacity: 0.8;
}

/* Premium class code display */
body.premium .class-code-display {
  background: var(--gradient-primary);
  box-shadow: 0 15px 40px rgba(64, 201, 255, 0.3);
}

/* Premium tools grid */
body.premium .tools-grid .tool-item:hover {
  background: linear-gradient(
    145deg,
    rgba(64, 201, 255, 0.15) 0%,
    rgba(192, 132, 252, 0.1) 100%
  );
}

/* Premium feedback button */
body.premium .feedback-btn {
  background: var(--gradient-info);
  box-shadow: 0 8px 32px rgba(106, 147, 255, 0.4);
}

/* Premium celebrate button */
body.premium .celebrate-btn {
  background: var(--gradient-success);
  box-shadow: 0 8px 32px rgba(0, 230, 169, 0.4);
}

/* ===== BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Poppins', 'Inter', 'Segoe UI', sans-serif;
  line-height: 1.6;
  min-height: 100vh;
  transition: background-color var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition);
  overflow-x: hidden;
}

/* ===== NEW RESPONSIVE LAYOUT STRUCTURE ===== */
.app-layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: var(--card);
  border-right: 1px solid var(--border);
  padding: var(--spacing-xl);
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  z-index: 100;
}

.sidebar-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
}

.student-emoji {
  font-size: 3.5rem;
  margin-bottom: var(--spacing-md);
  display: block;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(2deg); }
}

.sidebar h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
}

.sidebar-subtitle {
  color: var(--text-muted);
  font-size: 0.875rem;
  margin-bottom: var(--spacing-lg);
}

/* Class switcher */
.class-switcher {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.class-switcher select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--card);
  color: var(--text);
  font-size: 0.875rem;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-xl);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--radius);
  color: var(--text);
  text-decoration: none;
  font-weight: 500;
  transition: all var(--transition);
  border: 1px solid transparent;
  cursor: pointer;
}

.nav-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateX(5px);
}

.nav-item.active {
  background: var(--gradient-primary);
  color: white;
}

.nav-item.active:hover {
  background: var(--gradient-primary);
  border-color: transparent;
}

.sidebar-stats {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.sidebar-stats h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-value {
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--accent);
}

/* Inspiring Stories Section */
.stories-section {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-top: var(--spacing-xl);
  max-height: 300px;
  overflow-y: auto;
}

.heatmap-section {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.heatmap-section h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.heatmap-cell {
  width: 100%;
  padding-top: 100%;
  border-radius: 4px;
  background: var(--border);
  position: relative;
  overflow: hidden;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.heatmap-cell .heatmap-value {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-size: 0.65rem;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.9);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
}

.heatmap-cell::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: inherit;
}

.heatmap-cell.level-0 { background: rgba(148, 163, 184, 0.25); }
.heatmap-cell.level-1 { background: rgba(16, 185, 129, 0.25); }
.heatmap-cell.level-2 { background: rgba(16, 185, 129, 0.5); }
.heatmap-cell.level-3 { background: rgba(16, 185, 129, 0.75); }
.heatmap-cell.level-4 { background: rgba(16, 185, 129, 0.95); }

.heatmap-legend {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: var(--spacing-sm);
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* ===== AGGREGATE ENGAGEMENT HEATMAP ===== */
.aggregate-heatmap {
  display: grid;
  gap: 8px;
}

.aggregate-heatmap-grid {
  display: grid;
  grid-template-columns: 80px repeat(4, 1fr);
  gap: 6px;
  align-items: center;
}

.aggregate-heatmap-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-align: right;
  padding-right: 6px;
  white-space: nowrap;
}

.aggregate-heatmap-time {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.aggregate-heatmap-cell {
  height: 26px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--heat-0);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.aggregate-heatmap-cell.level-1 { background: var(--heat-1); }
.aggregate-heatmap-cell.level-2 { background: var(--heat-2); }
.aggregate-heatmap-cell.level-3 { background: var(--heat-3); }
.aggregate-heatmap-cell.level-4 { background: var(--heat-4); }

.aggregate-heatmap-cell:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.aggregate-heatmap-insight {
  margin-top: var(--spacing-md);
  font-size: 0.9rem;
  color: var(--text-muted);
}
.stories-section h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.story-item {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  cursor: pointer;
  transition: all var(--transition);
}

.story-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
}

.story-name {
  font-weight: 600;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.story-quote {
  font-size: 0.875rem;
  color: var(--text-muted);
  font-style: italic;
  line-height: 1.4;
}

/* Story Modal */
.story-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1001;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl);
}

.story-modal-content {
  background: var(--card);
  border-radius: var(--radius-lg);
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  border: 2px solid var(--accent);
}

.story-modal-header {
  padding: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
  background: var(--gradient-primary);
  color: white;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.story-modal-body {
  padding: var(--spacing-xl);
}

.story-modal-close {
  position: absolute;
  top: var(--spacing-lg);
  right: var(--spacing-lg);
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  z-index: 1002;
}

.story-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* ===== MAIN CONTENT ===== */
.main-content {
  padding: var(--spacing-xl);
  overflow-y: auto;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
}

/* ===== DASHBOARD HEADER ===== */
.dashboard-header {
  margin-bottom: var(--spacing-2xl);
}

.dashboard-header h1 {
  font-size: 2.5rem;
  font-weight: 800;
  margin-bottom: var(--spacing-sm);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.time-greeting {
  font-size: 1rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-sm);
  letter-spacing: 0.3px;
}

.dashboard-subtitle {
  color: var(--text-muted);
  font-size: 1.125rem;
  margin-bottom: var(--spacing-xl);
}

/* UPDATED: Controls Bar - Compact and Inline */
.controls-bar {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
  flex-wrap: nowrap;
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-xl);
  overflow-x: auto;
  min-width: 0;
}

.controls-bar .btn {
  flex-shrink: 0;
  white-space: nowrap;
  min-width: fit-content;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}

/* ===== TOP NAVIGATION FOR MOBILE ===== */
.top-nav {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  z-index: 1000;
  padding: var(--spacing-sm) var(--spacing-lg);
  box-shadow: var(--shadow);
}

.top-nav-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.mobile-menu-toggle {
  display: none;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  width: 44px;
  height: 44px;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  cursor: pointer;
  flex-shrink: 0;
}

.mobile-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99;
}

/* ===== PRO TIPS - MATCHING TEACHER MODE ===== */
.pro-tip {
  background:
    linear-gradient(135deg, rgba(79, 70, 229, 0.14), rgba(59, 130, 246, 0.1));
  border: 1px solid rgba(79, 70, 229, 0.28);
  border-left: 4px solid var(--accent);
  padding: var(--spacing-md);
  border-radius: var(--radius);
  margin: var(--spacing-md) 0;
  font-size: 0.875rem;
  position: relative;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
}

.pro-tip strong {
  color: var(--accent-dark);
  display: block;
  margin-bottom: var(--spacing-xs);
  font-size: 0.9375rem;
}

.pro-tip::before {
  content: 'ðŸ’¡';
  position: absolute;
  left: -12px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--accent);
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  box-shadow: var(--shadow);
}

.dark .pro-tip {
  background:
    linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(14, 116, 144, 0.18));
  border-color: rgba(148, 163, 184, 0.25);
  border-left-color: var(--accent);
  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
}

.dark .pro-tip strong {
  color: #e2e8f0;
}

/* ===== AI CHATBOT ===== */
.chatbot-fab {
  position: fixed;
  right: 18px;
  bottom: 96px;
  z-index: 900;
  display: flex;
  align-items: flex-end;
  gap: 10px;
  flex-direction: column;
}

.chatbot-bubble {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 10px 14px;
  max-width: 260px;
  font-size: 0.9rem;
  opacity: 0;
  transform: translateY(10px);
  transition: all var(--transition);
  pointer-events: none;
  position: absolute;
  right: 0;
  bottom: calc(100% + 12px);
  box-shadow: var(--shadow-md);
}

.chatbot-bubble.show {
  opacity: 1;
  transform: translateY(0);
}

.chatbot-bubble.challenge {
  background: rgba(239, 68, 68, 0.12);
  border-color: rgba(239, 68, 68, 0.4);
  color: #ef4444;
  font-weight: 700;
}

.clap-overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2400;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.25s ease;
}

.clap-overlay.show {
  opacity: 1;
}

.clap-video {
  display: none;
}

.clap-canvas {
  width: 50vw;
  height: 50vh;
  object-fit: contain;
  background: transparent;
  opacity: 0.65;
}

.chatbot-btn {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  border: none;
  background: transparent;
  cursor: pointer;
  display: grid;
  place-items: center;
  box-shadow: none;
  transition: transform var(--transition);
  animation: botFloat 3s ease-in-out infinite;
}

.chatbot-btn:hover {
  transform: translateY(-6px) scale(1.02);
}

.chatbot-img {
  width: 150px;
  height: 150px;
  border-radius: 0;
  object-fit: cover;
  background: transparent;
  box-shadow: none;
  animation: botLook 5.5s ease-in-out infinite, botNod 4.2s ease-in-out infinite;
}

@keyframes botFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

@keyframes botLook {
  0% { transform: translate(0, 0) rotate(0deg); }
  20% { transform: translate(-3px, -1px) rotate(-1deg); }
  40% { transform: translate(3px, -2px) rotate(1deg); }
  60% { transform: translate(2px, 2px) rotate(0.5deg); }
  80% { transform: translate(-2px, 1px) rotate(-0.5deg); }
  100% { transform: translate(0, 0) rotate(0deg); }
}

@keyframes botNod {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(2px); }
}

@media (max-width: 767px) {
  .chatbot-fab {
    right: 12px;
    bottom: 120px;
  }
  .chatbot-btn,
  .chatbot-img {
    width: 120px;
    height: 120px;
  }
  .chatbot-bubble {
    max-width: 220px;
    font-size: 0.85rem;
  }
}

/* ===== DASHBOARD GRID ===== */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--spacing-xl);
}

/* UPDATED: Quick Stats - Smaller and Inline */
.quick-stats {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-md);
}

.stat-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  border: 1px solid var(--border);
  transition: all var(--transition);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  max-width: 100%;
  overflow: hidden;
  height: auto;
  min-height: 80px;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow);
}

.stat-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  background: var(--gradient-primary);
  color: white;
  flex-shrink: 0;
}

.stat-card:nth-child(2) .stat-icon {
  background: var(--gradient-success);
}

.stat-card:nth-child(3) .stat-icon {
  background: var(--gradient-warning);
}

.stat-card:nth-child(4) .stat-icon {
  background: var(--gradient-info);
}

.stat-content {
  flex: 1;
  min-width: 0;
}

.stat-number {
  font-size: 1.5rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: var(--spacing-xs);
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
}

.stat-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Forms Section */
.forms-section {
  grid-column: span 6;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

.form-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
  max-width: 100%;
  overflow: hidden;
}

.form-card:hover {
  box-shadow: var(--shadow-md);
}

.form-card h2 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Form Elements */
.form-group {
  margin-bottom: var(--spacing-lg);
}

.form-group label {
  display: block;
  margin-bottom: var(--spacing-xs);
  font-weight: 600;
  color: var(--text);
  font-size: 0.875rem;
  white-space: nowrap;
}

input, textarea, select {
  width: 100%;
  padding: 0.875rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  font-size: 0.9375rem;
  font-family: inherit;
  transition: all var(--transition-fast);
  max-width: 100%;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
  background: var(--card);
}

textarea {
  min-height: 120px;
  resize: vertical;
  line-height: 1.6;
}

.btn-submit {
  width: 100%;
  padding: 1rem;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

/* Task Priority Badges */
.priority-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  white-space: nowrap;
}

.priority-urgent {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
  border: 1px solid var(--danger);
}

.priority-not-urgent {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
  border: 1px solid var(--warning);
}

.priority-optional {
  background: rgba(156, 163, 175, 0.1);
  color: var(--text-muted);
  border: 1px solid var(--text-muted);
}

.priority-selector {
  display: flex;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.priority-option {
  flex: 1;
  padding: 0.5rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
  font-size: 0.875rem;
  font-weight: 500;
  white-space: nowrap;
}

.priority-option:hover {
  transform: translateY(-2px);
}

.priority-option.active {
  border-color: var(--accent);
  background: var(--accent-light);
}

.priority-option[data-priority="urgent"]:hover,
.priority-option[data-priority="urgent"].active {
  border-color: var(--danger);
  background: rgba(239, 68, 68, 0.1);
}

.priority-option[data-priority="not-urgent"]:hover,
.priority-option[data-priority="not-urgent"].active {
  border-color: var(--warning);
  background: rgba(245, 158, 11, 0.1);
}

.priority-option[data-priority="optional"]:hover,
.priority-option[data-priority="optional"].active {
  border-color: var(--text-muted);
  background: rgba(156, 163, 175, 0.1);
}

/* Content Section */
.content-section {
  grid-column: span 6;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

.content-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  overflow: hidden;
  max-width: 100%;
}

.content-header {
  padding: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: nowrap;
  gap: var(--spacing-md);
  min-width: 0;
}

.content-header h2 {
  font-size: 1.25rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.content-body {
  padding: var(--spacing-xl);
  max-height: 400px;
  overflow-y: auto;
}

/* Profile section should not clip content */
.profile-content-body {
  max-height: none;
  overflow: visible;
}

/* ===== REFERRAL MODAL ===== */
.referral-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1500;
  padding: var(--spacing-lg);
  backdrop-filter: blur(6px);
}

.referral-modal.show {
  display: flex;
}

.referral-modal-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 520px;
  box-shadow: var(--shadow-xl);
  padding: var(--spacing-xl);
  text-align: center;
}

.rainbow-modal {
  position: fixed;
  inset: 0;
  background: rgba(5, 8, 20, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1600;
  padding: var(--spacing-lg);
  backdrop-filter: blur(4px);
}

.rainbow-modal.show {
  display: flex;
}

.rainbow-modal-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(15, 18, 35, 0.9));
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 520px;
  box-shadow: var(--shadow-xl);
  padding: var(--spacing-xl);
  text-align: center;
  color: #ffffff;
}

.forest-modal {
  position: fixed;
  inset: 0;
  background: rgba(6, 20, 12, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1600;
  padding: var(--spacing-lg);
  backdrop-filter: blur(4px);
}

.forest-modal.show {
  display: flex;
}

.forest-modal-card {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.18), rgba(4, 54, 35, 0.9));
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 520px;
  box-shadow: var(--shadow-xl);
  padding: var(--spacing-xl);
  text-align: center;
  color: #ecfdf5;
}

.referral-modal-title {
  font-size: 1.5rem;
  font-weight: 800;
  margin-bottom: var(--spacing-sm);
}

.referral-modal-text {
  color: var(--text-muted);
  margin-bottom: var(--spacing-lg);
}

.referral-modal-actions {
  display: flex;
  gap: var(--spacing-sm);
  justify-content: center;
  flex-wrap: wrap;
}

/* Task List */
.task-list {
  list-style: none;
  padding: 0;
  animation: fadeIn 0.8s ease-out;
}

.task-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: nowrap;
  gap: var(--spacing-md);
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
  max-width: 100%;
}

.task-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--gradient-primary);
  opacity: 0;
  transition: var(--transition);
}

.task-item:hover {
  border-color: var(--accent);
  transform: translateX(10px);
  box-shadow: var(--shadow);
  background: var(--accent-light);
}

.task-item:hover::before {
  opacity: 1;
}

.task-item.completed {
  opacity: 0.7;
  border-left: 4px solid var(--success);
}

.task-item.completed .task-text {
  text-decoration: line-through;
  color: var(--text-muted);
}

.task-item.urgent {
  border-left: 4px solid var(--danger);
}

.task-item.not-urgent {
  border-left: 4px solid var(--warning);
}

.task-item.optional {
  border-left: 4px solid var(--text-muted);
}

.task-text {
  flex: 1;
  min-width: 0;
  font-size: 1.1rem;
  font-weight: 500;
  cursor: pointer;
  padding: 0.5rem 0;
  transition: var(--transition);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.task-text:hover {
  color: var(--accent);
}

.task-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: nowrap;
  align-items: center;
  flex-shrink: 0;
}

/* Assignment List */
.assignment-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.assignment-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  transition: all var(--transition);
  max-width: 100%;
  overflow: hidden;
}

.assignment-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.assignment-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  min-width: 0;
}

.assignment-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.assignment-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
  white-space: nowrap;
  flex-shrink: 0;
}

.assignment-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
  padding: 0.5rem 0;
  overflow: hidden;
}

.assignment-actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-sm);
  flex-wrap: nowrap;
}

/* Classroom Announcements & Resources */
.classroom-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  transition: all var(--transition);
  max-width: 100%;
  overflow: hidden;
}

.classroom-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.classroom-item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  min-width: 0;
}

.classroom-item-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.classroom-item-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
  white-space: nowrap;
  flex-shrink: 0;
}

.classroom-item-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
  overflow: hidden;
}

.classroom-item-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.classroom-item-link:hover {
  text-decoration: underline;
}

/* Poll Styles (Classic Form Look) */
.classroom-item.poll-card {
  background: var(--poll-bg) !important;
  border: 1px solid var(--poll-border) !important;
  border-radius: 6px !important;
  padding: 0.9rem 1.1rem !important;
  box-shadow: none !important;
  color: var(--poll-text) !important;
  font-family: 'Arial', 'Helvetica', sans-serif !important;
  transform: none !important;
}

.classroom-item.poll-card:hover {
  transform: none !important;
  background: var(--poll-bg) !important;
  border-color: var(--poll-border) !important;
  box-shadow: none !important;
}

.classroom-item.poll-card .classroom-item-header {
  align-items: flex-start;
  gap: 0.75rem;
}

.classroom-item.poll-card .classroom-item-title {
  font-size: 1rem;
  font-weight: 500;
  color: var(--poll-text) !important;
  white-space: normal;
}

.classroom-item.poll-card .classroom-item-date {
  display: none !important;
}

.classroom-item.poll-card .poll-divider {
  height: 1px;
  background: var(--poll-divider);
  margin: 0.6rem 0 0.8rem 0;
}

.classroom-item.poll-card .poll-options {
  display: grid;
  gap: 0.5rem;
}

.classroom-item.poll-card .poll-option {
  display: grid;
  grid-template-columns: 18px 1fr;
  gap: 0.5rem;
  align-items: center;
  font-size: 0.9rem;
  color: var(--poll-text) !important;
}

.classroom-item.poll-card .poll-radio {
  width: 16px;
  height: 16px;
  accent-color: var(--poll-radio);
}

.classroom-item.poll-card .poll-other-input {
  width: 100%;
  border: 1px solid var(--poll-border);
  border-radius: 4px;
  padding: 0.25rem 0.4rem;
  font-size: 0.85rem;
  color: var(--poll-text);
  background: var(--poll-input-bg);
  margin-left: 6px;
}

.classroom-item.poll-card .poll-other-input:disabled {
  background: var(--poll-button-bg);
  color: var(--poll-muted);
}

.classroom-item.poll-card .poll-submit {
  margin-top: 0.75rem;
  background: var(--poll-button-bg) !important;
  color: var(--poll-text) !important;
  border: 1px solid var(--poll-border) !important;
  border-radius: 999px;
  padding: 0.25rem 1rem;
  font-weight: 600;
  font-size: 0.85rem;
  min-width: 64px;
}

.classroom-item.poll-card .poll-submit:hover {
  background: var(--poll-button-hover) !important;
}

.classroom-item.poll-card .poll-actions {
  display: flex;
  gap: 1.25rem;
  margin-top: 0.75rem;
  font-size: 0.8rem;
  color: var(--poll-muted);
  justify-content: center;
}

.classroom-item.poll-card .poll-action-link {
  cursor: pointer;
  text-decoration: underline;
  color: var(--poll-muted) !important;
}

.classroom-item.poll-card .poll-results {
  margin-top: 0.75rem;
}

.classroom-item.poll-card .poll-result-row {
  margin-bottom: 0.5rem;
}

.classroom-item.poll-card .poll-result-head {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  color: var(--poll-muted);
  margin-bottom: 0.2rem;
}

.classroom-item.poll-card .poll-bar {
  height: 6px;
  background: var(--poll-button-bg);
  border-radius: 999px;
  overflow: hidden;
}

.classroom-item.poll-card .poll-bar-fill {
  height: 100%;
  background: var(--poll-text);
  width: 0%;
}

.classroom-item.poll-card .poll-status {
  margin-top: 0.5rem;
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--poll-text);
}

.classroom-item.poll-card .poll-status.closed {
  color: #b45309;
}

.classroom-item.poll-card .poll-status.voted {
  color: #065f46;
}

.classroom-item.poll-card .classroom-item-content {
  color: var(--poll-text) !important;
}

.classroom-item.poll-card .poll-option span,
.classroom-item.poll-card .poll-result-head span,
.classroom-item.poll-card .poll-status {
  color: var(--poll-text) !important;
}

/* Tools Grid */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

.tool-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  text-align: center;
  transition: all var(--transition);
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  display: block;
  max-width: 100%;
  overflow: hidden;
}

.tool-item:hover {
  border-color: var(--accent);
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  background: var(--accent-light);
}

.tool-icon {
  font-size: 3rem;
  margin-bottom: var(--spacing-md);
  display: inline-block;
  animation: iconBounce 2s ease-in-out infinite;
}

@keyframes iconBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.tool-name {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-xs);
  color: var(--accent);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tool-desc {
  font-size: 0.875rem;
  color: var(--text-muted);
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/* ===== BUTTONS ===== */
.btn {
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius);
  border: none;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  white-space: nowrap;
  flex-shrink: 0;
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.btn-warning {
  background: var(--gradient-warning);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
}

.btn-danger {
  background: var(--gradient-danger);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.btn-secondary {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  min-width: 300px;
  padding: 1.125rem 1.5rem;
  border-radius: var(--radius);
  background: var(--card);
  color: var(--text);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 0.875rem;
  animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 4px solid var(--accent);
  border: 1px solid var(--border);
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: var(--info); }

/* ===== IMPROVED STREAK CARD ===== */
.streak-card {
  background: var(--gradient-warning);
  color: white;
  text-align: center;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  position: relative;
  overflow: hidden;
}

.streak-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.streak-number {
  font-size: 4rem;
  font-weight: 900;
  line-height: 1;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.streak-label {
  font-size: 1.25rem;
  opacity: 0.9;
  margin-bottom: var(--spacing-lg);
  position: relative;
  z-index: 1;
  white-space: nowrap;
}

.streak-milestones {
  display: flex;
  justify-content: center;
  gap: var(--spacing-sm);
  margin: var(--spacing-md) 0;
  position: relative;
  z-index: 1;
  flex-wrap: wrap;
}

.milestone {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
}

.milestone.active {
  background: white;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.streak-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 1rem 2rem;
  border-radius: var(--radius);
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  width: 100%;
  justify-content: center;
  position: relative;
  z-index: 1;
  white-space: nowrap;
}

.streak-btn:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.streak-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.streak-progress {
  height: 6px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  margin: var(--spacing-md) 0;
  position: relative;
  z-index: 1;
  overflow: hidden;
}

.streak-progress-fill {
  height: 100%;
  background: white;
  border-radius: 3px;
  transition: width 0.5s ease;
  position: relative;
}

.streak-progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ===== MOTIVATION CARD ===== */
.motivation-card {
  background: var(--gradient-purple);
  color: white;
  position: relative;
  overflow: hidden;
}

.motivation-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
}

.quote-text {
  font-size: 1.5rem;
  font-style: italic;
  line-height: 1.6;
  margin-bottom: var(--spacing-md);
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.quote-author {
  font-size: 1.1rem;
  opacity: 0.9;
  position: relative;
  z-index: 1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ===== CLASS CODE DISPLAY ===== */
.class-code-display {
  background: var(--gradient-primary);
  color: white;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  margin: var(--spacing-xl) 0;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.class-code-display::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%);
  background-size: 20px 20px;
}

.class-code-display .code {
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.5rem;
  font-family: 'Courier New', monospace;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
  word-break: break-all;
}

/* ===== MULTIPLE CLASSES VIEW ===== */
.classes-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

.class-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  transition: all var(--transition);
  position:relative;
  overflow: hidden;
  max-width: 100%;
}

.class-card:hover {
  border-color: var(--accent);
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.class-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  min-width: 0;
}

.class-card-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.class-card-code {
  background: var(--accent);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
}

.class-card-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.class-card-stat {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
}

.class-card-stat .value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--accent);
  overflow: hidden;
  text-overflow: ellipsis;
}

.class-card-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.class-card-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
  flex-wrap: nowrap;
}

.class-card-actions .btn {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== LEADERBOARD STYLES ===== */
.leaderboard-container {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.leaderboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--border);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
}

.leaderboard-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.leaderboard-stat {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
}

.leaderboard-stat .value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.25rem;
  overflow: hidden;
  text-overflow: ellipsis;
}

.leaderboard-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.leaderboard-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.leaderboard-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  transition: all var(--transition);
  flex-wrap: nowrap;
  max-width: 100%;
  overflow: hidden;
}

.leaderboard-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  background: var(--accent-light);
}

.leaderboard-item.you {
  background: var(--gradient-primary);
  color: white;
  border-color: var(--accent-dark);
}

.leaderboard-item.you .rank,
.leaderboard-item.you .score,
.leaderboard-item.you .name {
  color: white;
}

.leaderboard-rank {
  font-size: 1.5rem;
  font-weight: 900;
  width: 40px;
  text-align: center;
  color: var(--accent);
  flex-shrink: 0;
}

.rank-1 .leaderboard-rank { color: #ff8a7a; }
.rank-2 .leaderboard-rank { color: #C0C0C0; }
.rank-3 .leaderboard-rank { color: #CD7F32; }

.leaderboard-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 1.25rem;
  flex-shrink: 0;
}

.leaderboard-info {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

.leaderboard-name {
  font-weight: 700;
  font-size: 1.125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.leaderboard-subtitle {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.leaderboard-item.you .leaderboard-subtitle {
  color: rgba(255, 255, 255, 0.8);
}

.leaderboard-score {
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--accent);
  text-align: right;
  min-width: 80px;
  flex-shrink: 0;
}

.leaderboard-stats-row {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-sm);
  flex-wrap: nowrap;
}

.stats-badge {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 0.25rem;
  white-space: nowrap;
  flex-shrink: 0;
}

.stats-badge.fire { color: var(--warning); }
.stats-badge.time { color: var(--info); }
.stats-badge.points { color: var(--success); }

.leaderboard-empty {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
}

/* ===== ACHIEVEMENT BADGES ===== */
.badges-card .content-body {
  max-height: none;
}

.badges-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
}

.badge-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  display: grid;
  grid-template-columns: 44px 1fr;
  gap: var(--spacing-md);
  align-items: center;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.badge-item::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, transparent 20%, rgba(255,255,255,0.2), transparent 80%);
  opacity: 0;
  transition: opacity var(--transition);
}

.badge-item:hover::after {
  opacity: 1;
}

.badge-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: rgba(255,255,255,0.2);
  flex-shrink: 0;
}

.badge-info {
  min-width: 0;
}

.badge-title {
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
  white-space: normal;
}

.badge-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.4;
}

.badge-tag {
  margin-top: 6px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 0.2rem 0.5rem;
  border-radius: 999px;
  background: rgba(255,255,255,0.35);
  color: #0f172a;
}

.badge-item[data-tone="sunrise"] {
  background: linear-gradient(135deg, rgba(251,146,60,0.15), rgba(253,186,116,0.35));
  border-color: rgba(251,146,60,0.5);
}
.badge-item[data-tone="weekend"] {
  background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(147,197,253,0.35));
  border-color: rgba(59,130,246,0.5);
}
.badge-item[data-tone="focus"] {
  background: linear-gradient(135deg, rgba(16,185,129,0.12), rgba(110,231,183,0.35));
  border-color: rgba(16,185,129,0.5);
}
.badge-item[data-tone="time"] {
  background: linear-gradient(135deg, rgba(234,88,12,0.12), rgba(253,186,116,0.35));
  border-color: rgba(234,88,12,0.5);
}
.badge-item[data-tone="streak"] {
  background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(216,180,254,0.35));
  border-color: rgba(139,92,246,0.5);
}
.badge-item[data-tone="tasks"] {
  background: linear-gradient(135deg, rgba(244,63,94,0.12), rgba(251,113,133,0.35));
  border-color: rgba(244,63,94,0.5);
}
.badge-item[data-tone="assign"] {
  background: linear-gradient(135deg, rgba(20,184,166,0.12), rgba(125,211,252,0.35));
  border-color: rgba(20,184,166,0.5);
}
.badge-item[data-tone="consistency"] {
  background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(253,230,138,0.35));
  border-color: rgba(245,158,11,0.5);
}
.badge-item[data-tone="goal"] {
  background: linear-gradient(135deg, rgba(14,165,233,0.12), rgba(186,230,253,0.35));
  border-color: rgba(14,165,233,0.5);
}

@media (max-width: 767px) {
  .badges-grid {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
  .badge-item {
    grid-template-columns: 40px 1fr;
    padding: 0.65rem;
  }
  .badge-icon {
    width: 40px;
    height: 40px;
    font-size: 1.1rem;
  }
  .badge-title {
    font-size: 0.85rem;
  }
  .badge-desc {
    font-size: 0.75rem;
  }

  .toast {
    min-width: 220px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 479px) {
  .badges-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--spacing-sm);
  }
  .badge-item {
    grid-template-columns: 34px 1fr;
    padding: 0.55rem;
  }
  .badge-icon {
    width: 34px;
    height: 34px;
    font-size: 1rem;
  }
  .badge-title {
    font-size: 0.8rem;
  }
  .badge-desc {
    font-size: 0.7rem;
  }
}

/* ===== UPDATED STATISTICS SECTION ===== */
.statistics-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.statistics-header {
  grid-column: span 12;
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-lg);
}

.statistics-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: var(--spacing-sm);
  color: var(--text);
}

.statistics-subtitle {
  color: var(--text-muted);
  font-size: 1rem;
  margin-bottom: var(--spacing-lg);
}

.stats-overview-cards {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.stats-overview-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  border: 1px solid var(--border);
  transition: var(--transition);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.stats-overview-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow);
  border-color: var(--accent);
}

.stats-overview-icon {
  font-size: 2rem;
  margin-bottom: var(--spacing-sm);
  display: block;
}

.stats-overview-number {
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: var(--spacing-xs);
  line-height: 1;
}

.stats-overview-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--spacing-sm);
}

.stats-overview-trend {
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-sm);
}

.stats-overview-trend.up {
  color: var(--success);
}

.stats-overview-trend.down {
  color: var(--danger);
}

.stats-overview-trend.neutral {
  color: var(--text-muted);
}

/* Charts Container - Improved for Mobile */
.charts-container {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.chart-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.chart-card:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--accent);
}

.chart-header {
  margin-bottom: var(--spacing-lg);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.chart-header h3 {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.chart-description {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: var(--spacing-xs);
  line-height: 1.4;
}

.chart-wrapper {
  position: relative;
  height: 250px;
  width: 100%;
  flex: 1;
  min-height: 200px;
}

/* Detailed Statistics */
.stats-detailed-container {
  grid-column: span 12;
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  margin-top: var(--spacing-lg);
}

.stats-detailed-container h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  color: var(--text);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.stats-detailed-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.stats-detailed-section {
  padding: var(--spacing-lg);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.stats-detailed-section h4 {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stats-detailed-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid rgba(var(--border-rgb), 0.2);
}

.stats-detailed-row:last-child {
  border-bottom: none;
}

.stats-detailed-label {
  font-size: 0.875rem;
  color: var(--text);
}

.stats-detailed-value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--accent);
}

/* Chart Legends - Theme Adaptive */
.chart-legend {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
  padding-top: var(--spacing-md);
  border-top: 1px solid var(--border);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.75rem;
  color: var(--text-muted);
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

/* Statistics Controls */
.stats-controls {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--border);
}

.stats-controls .btn {
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
}

/* Performance Metrics */
.performance-metrics {
  grid-column: span 12;
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  margin-top: var(--spacing-lg);
}

.performance-metrics h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  color: var(--text);
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-lg);
}

.metric-card {
  background: var(--bg);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  border: 1px solid var(--border);
  text-align: center;
  transition: var(--transition);
}

.metric-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-icon {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  display: block;
}

.metric-value {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: var(--spacing-xs);
  line-height: 1;
}

.metric-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-xs);
}

.metric-details {
  font-size: 0.75rem;
  color: var(--text);
  opacity: 0.8;
}

/* Study Session Button */
.study-session-btn {
  margin-top: var(--spacing-lg);
  width: 100%;
}

/* ===== FOOTER WITH COPYRIGHT ===== */
.footer {
  grid-column: span 12;
  text-align: center;
  padding: var(--spacing-xl);
  margin-top: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 0.875rem;
  border-top: 1px solid var(--border);
}

.footer a {
  color: var(--accent);
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { 
  width: 8px; 
  height: 8px;
}

::-webkit-scrollbar-track { 
  background: var(--bg); 
  border-radius: 4px;
}

::-webkit-scrollbar-thumb { 
  background: var(--accent); 
  border-radius: 4px;
  border: 2px solid var(--bg);
}

::-webkit-scrollbar-thumb:hover { 
  background: var(--accent-dark); 
}

/* ===== LOADING STATES ===== */
.loading {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 1.125rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.loading::after {
  content: '';
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== EMPTY STATES ===== */
.empty-state {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: var(--spacing-lg);
  opacity: 0.5;
}

.empty-state-title {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  color: var(--text);
}

.empty-state-description {
  font-size: 1rem;
  line-height: 1.6;
}

/* ===== SYNC STATUS ===== */
.sync-status {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  z-index: 999;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  backdrop-filter: blur(10px);
  animation: fadeIn 0.5s ease-out;
  white-space: nowrap;
}

/* ===== EXTREME RESPONSIVENESS ===== */

/* Desktop (1200px and above) */
@media (min-width: 1200px) {
  .app-layout {
    grid-template-columns: 280px 1fr;
  }
  
  .forms-section,
  .content-section {
    grid-column: span 6;
  }
  
  .quick-stats {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .charts-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Tablet (768px to 1199px) */
@media (max-width: 1199px) and (min-width: 768px) {
  .app-layout {
    grid-template-columns: 240px 1fr;
  }
  
  .forms-section,
  .content-section {
    grid-column: span 6;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .charts-container {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-overview-cards {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-detailed-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .classes-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Mobile (below 768px) */
@media (max-width: 767px) {
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .top-nav {
    display: block;
  }
  
  .sidebar {
    position: fixed;
    top: 60px;
    left: -280px;
    width: 280px;
    height: calc(100vh - 60px);
    transition: left 0.3s ease;
    z-index: 100;
    padding: var(--spacing-lg);
  }
  
  .sidebar.active {
    left: 0;
  }
  
  .mobile-menu-toggle {
    display: flex;
  }
  
  .mobile-overlay.active {
    display: block;
  }
  
  .main-content {
    margin-top: 60px;
    padding: var(--spacing-md);
  }
  
  .forms-section,
  .content-section {
    grid-column: span 12;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
  }
  
  .dashboard-header h1 {
    font-size: 1.75rem;
    text-align: center;
  }
  
  .dashboard-subtitle {
    text-align: center;
  }
  
  .controls-bar {
    flex-wrap: wrap;
    padding: var(--spacing-sm);
    gap: var(--spacing-sm);
    justify-content: center;
  }
  
  .controls-bar .btn {
    font-size: 0.75rem;
    padding: 0.375rem 0.625rem;
    flex: 1;
    min-width: calc(50% - 0.375rem);
  }
  
  /* UPDATED: Statistics Section for Mobile */
  .statistics-grid {
    gap: var(--spacing-md);
  }
  
  .statistics-header {
    padding: var(--spacing-lg);
    text-align: center;
  }
  
  .statistics-header h2 {
    font-size: 1.25rem;
  }
  
  .stats-overview-cards {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
  }
  
  .stats-overview-card {
    padding: var(--spacing-md);
  }
  
  .stats-overview-number {
    font-size: 1.5rem;
  }
  
  .stats-overview-icon {
    font-size: 1.5rem;
  }
  
  .charts-container {
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }
  
  .chart-card {
    padding: var(--spacing-lg);
  }
  
  .chart-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }
  
  .chart-header h3 {
    font-size: 1rem;
  }
  
  .chart-wrapper {
    height: 200px;
    min-height: 150px;
  }
  
  .chart-description {
    font-size: 0.8125rem;
  }
  
  .stats-detailed-container {
    padding: var(--spacing-lg);
  }
  
  .stats-detailed-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }
  
  .stats-detailed-section {
    padding: var(--spacing-md);
  }
  
  .stats-detailed-row {
    padding: var(--spacing-xs) 0;
  }
  
  .performance-metrics {
    padding: var(--spacing-lg);
  }
  
  .metrics-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
  }
  
  .metric-card {
    padding: var(--spacing-md);
  }
  
  .metric-value {
    font-size: 1.5rem;
  }
  
  .stats-controls {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .stats-controls .btn {
    width: 100%;
    justify-content: center;
  }
  
  .content-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .content-header h2 {
    font-size: 1.125rem;
  }
  
  .stat-card {
    flex-direction: column;
    text-align: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
  }
  
  .stat-icon {
    width: 32px;
    height: 32px;
    font-size: 1rem;
  }
  
  .stat-number {
    font-size: 1.25rem;
  }
  
  .stat-label {
    font-size: 0.65rem;
  }
  
  .task-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-md);
  }
  
  .task-actions {
    width: 100%;
    justify-content: flex-end;
  }
  
  .assignment-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .class-card-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .leaderboard-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .leaderboard-score {
    align-self: flex-end;
    margin-top: var(--spacing-sm);
  }
}

/* Small Mobile (below 480px) */
@media (max-width: 479px) {
  .quick-stats {
    grid-template-columns: 1fr;
  }
  
  .stats-overview-cards {
    grid-template-columns: 1fr;
  }
  
  .charts-container {
    grid-template-columns: 1fr;
  }
  
  .stats-detailed-grid {
    grid-template-columns: 1fr;
  }
  
  .metrics-grid {
    grid-template-columns: 1fr;
  }
  
  .controls-bar .btn {
    font-size: 0.7rem;
    padding: 0.375rem 0.5rem;
    min-width: 100%;
  }
  
  .priority-selector {
    flex-direction: column;
  }
  
  .class-code-display .code {
    font-size: 2rem;
    letter-spacing: 0.25rem;
  }
  
  .streak-number {
    font-size: 3rem;
  }
  
  .dashboard-header h1 {
    font-size: 1.5rem;
  }
  
  .toast {
    min-width: 250px;
    padding: 1rem;
  }
  
  .stat-card {
    padding: 0.75rem;
    min-height: 70px;
  }
  
  .stat-number {
    font-size: 1.1rem;
  }
  
  .chart-wrapper {
    height: 180px;
  }
}

/* Orientation-specific adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .sidebar {
    padding-top: var(--spacing-lg);
    height: 100vh;
    overflow-y: auto;
  }
  
  .main-content {
    padding: var(--spacing-md);
  }
  
  .chart-wrapper {
    height: 150px;
  }
}

/* Print Styles */
@media print {
  .sidebar,
  .mobile-menu-toggle,
  .controls-bar,
  .btn,
  .task-actions,
  .assignment-actions,
  .class-card-actions {
    display: none !important;
  }
  
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .main-content {
    padding: 0;
    margin: 0;
  }
  
  .content-card {
    border: 1px solid #000;
    box-shadow: none;
  }
  
  .task-item,
  .assignment-item,
  .classroom-item {
    break-inside: avoid;
  }
  
  .chart-wrapper {
    height: 200px !important;
  }
}

/* ===== FLOATING FEEDBACK BUTTON ===== */
.feedback-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--gradient-info);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    padding: var(--spacing-md) var(--spacing-lg);
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-xl);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    transition: all var(--transition);
    animation: pulse 2s infinite;
}

.feedback-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-2xl);
    background: var(--gradient-info-dark);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

/* Add this to your CSS variables if needed */
:root {
    --gradient-info-dark: linear-gradient(135deg, #2563eb, #1d4ed8);
}

/* Mobile adjustments */
@media (max-width: 767px) {
    .feedback-btn {
        bottom: 70px;
        right: 15px;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.875rem;
    }
}
/* ===== MOBILE NAVIGATION WITH CONTROLS BAR ===== */
@media (max-width: 767px) {
  /* Move controls bar to mobile nav */
  .controls-bar {
    display: none !important; /* Hide from main content on mobile */
  }
  
  /* New container for controls in mobile nav */
  .mobile-nav-controls {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
    padding: 8px 12px;
    background: var(--card);
    border-top: 1px solid var(--border);
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--shadow);
    max-width: 100vw;
    overflow: hidden;
  }
  
  /* Style the mobile controls buttons */
  .mobile-nav-controls .btn {
    padding: 6px 4px;
    font-size: 11px;
    border-radius: var(--radius-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 40px;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  
  /* Add mobile nav controls to existing top nav structure */
  .top-nav {
    flex-direction: column;
    padding: 0;
    min-height: 60px;
    align-items: stretch;
  }
  
  .top-nav-header {
    padding: 8px 12px;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  /* Adjust main content margin to account for the combined nav height */
  .main-content {
    margin-top: 100px !important; /* 60px (top nav) + 40px (controls) */
  }
  
  /* Adjust sidebar position for the taller nav */
  .sidebar {
    top: 100px !important;
    height: calc(100vh - 100px) !important;
  }
  
  /* Floating feedback button adjustment */
  .feedback-btn {
    bottom: 80px;
    right: 12px;
  }
}

/* Small Mobile (below 480px) */
@media (max-width: 479px) {
  .mobile-nav-controls .btn {
    font-size: 10px;
    padding: 5px 3px;
    min-height: 36px;
  }
  
  .main-content {
    margin-top: 96px !important; /* Adjusted for smaller controls */
  }
  
  .sidebar {
    top: 96px !important;
    height: calc(100vh - 96px) !important;
  }
}

/* Landscape mode adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .mobile-nav-controls {
    position: sticky;
    top: 60px;
  }
  
  .mobile-nav-controls .btn {
    min-height: 32px;
    font-size: 9px;
    padding: 4px 2px;
  }
  
  .main-content {
    margin-top: 92px !important; /* Smaller in landscape */
  }
  
  .sidebar {
    top: 92px !important;
    height: calc(100vh - 92px) !important;
  }
}

/* Ensure the mobile controls don't appear on desktop */
@media (min-width: 768px) {
  .mobile-nav-controls {
    display: none !important;
  }
}

/* ===== MOBILE TOP NAV WITH INLINE CONTROLS ===== */
@media (max-width: 767px) {
  /* Hide the original controls bar in main content on mobile */
  .controls-bar {
    display: none !important;
  }
  
  /* Update top nav structure */
  .top-nav {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    z-index: 1000;
    padding: 0;
    height: 52px;
  }
  
  .top-nav-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px;
    gap: 6px;
    height: 52px;
    width: 100%;
  }
  
  .top-nav-header h2 {
    font-size: 1rem;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
    flex-shrink: 0;
  }
  
  /* Mobile controls container - inline with title */
  .mobile-nav-controls {
    display: flex;
    flex: 1;
    justify-content: space-between;
    gap: 4px;
    overflow-x: visible;
    padding: 0;
    margin: 0 6px;
    min-width: 0;
  }
  
  /* Style the inline control buttons - all visible */
  .mobile-nav-controls .btn {
    padding: 5px 6px;
    font-size: 11px;
    border-radius: var(--radius-sm);
    white-space: nowrap;
    flex: 1;
    min-width: 0;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  
  /* Button text styling */
  .mobile-nav-controls .btn span {
    display: inline;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Mobile menu toggle */
  .mobile-menu-toggle {
    width: 36px;
    height: 36px;
    font-size: 1rem;
    flex-shrink: 0;
    margin: 0;
  }
  
  /* Adjust main content position */
  .main-content {
    margin-top: 52px !important;
    padding-top: var(--spacing-sm) !important;
  }
  
  /* Adjust sidebar position */
  .sidebar {
    top: 52px !important;
    height: calc(100vh - 52px) !important;
  }
  
  /* Adjust floating feedback button */
  .feedback-btn {
    bottom: 70px;
    right: 10px;
    padding: 8px 12px;
    font-size: 0.75rem;
  }
}

/* Tablet adjustments (480px - 767px) */
@media (min-width: 480px) and (max-width: 767px) {
  .top-nav-header h2 {
    max-width: 150px;
  }
  
  .mobile-nav-controls .btn {
    font-size: 12px;
    padding: 6px 8px;
  }
}

/* Small Mobile (below 480px) */
@media (max-width: 479px) {
  .top-nav-header {
    padding: 4px 6px;
    height: 48px;
  }
  
  .top-nav-header h2 {
    font-size: 0.875rem;
    max-width: 100px;
  }
  
  .mobile-nav-controls {
    gap: 3px;
    margin: 0 4px;
  }
  
  .mobile-nav-controls .btn {
    padding: 4px 5px;
    font-size: 10px;
    height: 30px;
  }
  
  .mobile-menu-toggle {
    width: 32px;
    height: 32px;
  }
  
  .main-content {
    margin-top: 48px !important;
  }
  
  .sidebar {
    top: 48px !important;
    height: calc(100vh - 48px) !important;
  }
}

/* Extra small screens (below 360px) */
@media (max-width: 359px) {
  .top-nav-header {
    height: 46px;
    padding: 3px 4px;
  }
  
  .top-nav-header h2 {
    font-size: 0.75rem;
    max-width: 80px;
  }
  
  .mobile-nav-controls {
    gap: 2px;
    margin: 0 3px;
  }
  
  .mobile-nav-controls .btn {
    padding: 3px 4px;
    font-size: 9px;
    height: 28px;
  }
  
  /* Show only icons on very small screens */
  .mobile-nav-controls .btn span {
    display: none;
  }
  
  .mobile-nav-controls .btn::before {
    font-size: 12px;
  }
  
  .mobile-nav-controls .btn:nth-child(1)::before {
    content: "ðŸ ";
  }
  
  .mobile-nav-controls .btn:nth-child(2)::before {
    content: "ðŸŽ“";
  }
  
  .mobile-nav-controls .btn:nth-child(3)::before {
    content: "ðŸ”„";
  }
  
  .mobile-nav-controls .btn:nth-child(4)::before {
    content: "ðŸ“¤";
  }
  
  .mobile-menu-toggle {
    width: 30px;
    height: 30px;
    font-size: 0.875rem;
  }
  
  .main-content {
    margin-top: 46px !important;
  }
  
  .sidebar {
    top: 46px !important;
    height: calc(100vh - 46px) !important;
  }
}

/* Landscape mode adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .top-nav-header {
    height: 44px;
    padding: 3px 5px;
  }
  
  .mobile-nav-controls .btn {
    height: 28px;
    padding: 3px 5px;
    font-size: 10px;
  }
  
  .mobile-menu-toggle {
    width: 30px;
    height: 30px;
  }
  
  .main-content {
    margin-top: 44px !important;
  }
  
  .sidebar {
    top: 44px !important;
    height: calc(100vh - 44px) !important;
  }
}

/* Hide mobile controls on desktop */
@media (min-width: 768px) {
  .mobile-nav-controls {
    display: none !important;
  }
}

/* Ensure no horizontal scroll on mobile */
@media (max-width: 767px) {
  html, body {
    overflow-x: hidden;
    max-width: 100vw;
  }
  
  .app-layout {
    overflow-x: hidden;
  }
}

/* ===== DAILY GOAL TRACKER ===== */
.goal-card {
  background: var(--card);
  border: 1px solid var(--border);
}

.goal-text {
  font-weight: 700;
  margin-bottom: var(--spacing-md);
  color: var(--text);
  font-size: 1rem;
}

.goal-progress {
  height: 12px;
  background: var(--accent-light);
  border-radius: 999px;
  overflow: hidden;
  margin-bottom: var(--spacing-sm);
}

.goal-progress-fill {
  height: 100%;
  background: var(--gradient-success);
  width: 0%;
  transition: width 0.4s ease;
}

.goal-stats {
  font-size: 0.9rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-sm);
}

.goal-message {
  font-weight: 600;
  color: var(--success);
}

.goal-input {
  margin-top: var(--spacing-sm);
}

.goal-input label {
  display: block;
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

/* ===== CONFETTI LAYER ===== */
#confettiLayer {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2000; /* Above everything */
  overflow: hidden;
}

.confetti {
  position: absolute;
  top: -10px;
  width: 10px;
  height: 14px;
  opacity: 0.95;
  border-radius: 2px;
  animation: confettiFall 5.5s linear forwards;
}

.confetti.burst {
  top: 50%;
  left: 50%;
  animation: confettiBurst 1.8s ease-out forwards;
}

@keyframes confettiFall {
  0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
  80%  { transform: translateY(95vh) rotate(620deg); opacity: 1; }
  95%  { transform: translateY(105vh) rotate(700deg); opacity: 1; }
  100% { transform: translateY(105vh) rotate(720deg); opacity: 0; }
}

@keyframes confettiBurst {
  0% {
    transform: translate(-50%, -50%) translate(0, 0) rotate(0deg) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) translate(var(--x), var(--y)) rotate(720deg) scale(0.9);
    opacity: 0;
  }
}

/* ===== CELEBRATE BUTTON ===== */
.celebrate-btn {
  margin-top: var(--spacing-md);
  width: 100%;
  background: var(--gradient-success);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 0.75rem 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  letter-spacing: 0.3px;
}

.celebrate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(16, 185, 129, 0.35);
}

.celebrate-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, transparent 20%, rgba(255,255,255,0.35), transparent 80%);
  transform: translateX(-120%);
  transition: transform 0.8s ease;
}

.celebrate-btn:hover::after {
  transform: translateX(120%);
}

.celebrate-btn.pulse {
  animation: celebratePulse 1.6s ease-in-out infinite;
}

@keyframes celebratePulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); }
  50% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
}

.confetti.sparkle {
  border-radius: 50%;
}

/* Add to your CSS file */
.memory-whiteboard {
    position: relative;
    width: 100%;
    height: 600px;
    background: linear-gradient(45deg, var(--card) 25%, transparent 25%, transparent 75%, var(--card) 75%, var(--card) 100%),
                linear-gradient(45deg, var(--card) 25%, var(--bg) 25%, var(--bg) 75%, var(--card) 75%, var(--card) 100%);
    background-size: 40px 40px;
    background-position: 0 0, 20px 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: var(--spacing-md) 0;
}

.sticky-notes-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.sticky-note {
    position: absolute;
    width: 250px;
    min-height: 200px;
    padding: var(--spacing-md);
    border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: move;
    pointer-events: auto;
    transition: box-shadow 0.2s, transform 0.2s;
    overflow: hidden;
    z-index: 2;
}

.sticky-note:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px) rotate(0deg) !important;
}

.sticky-note.dragging {
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    transform: scale(1.05) rotate(0deg) !important;
    z-index: 1000 !important;
}

.sticky-note.welcome {
    width: 300px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white;
    text-align: center;
}

.whiteboard-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px),
        linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
    background-size: 20px 20px;
}

.whiteboard-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

/* Student Whiteboard CSS */
#studentMemoryWhiteboard {
    position: relative;
    width: 100%;
    height: 600px;
    background: linear-gradient(45deg, var(--card) 25%, transparent 25%, transparent 75%, var(--card) 75%, var(--card) 100%),
                linear-gradient(45deg, var(--card) 25%, var(--bg) 25%, var(--bg) 75%, var(--card) 75%, var(--card) 100%);
    background-size: 40px 40px;
    background-position: 0 0, 20px 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: var(--spacing-md) 0;
}

#studentStickyNotesContainer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

/* Student Sticky Note */
.student-sticky-note {
    position: absolute;
    width: 250px;
    min-height: 200px;
    padding: var(--spacing-md);
    border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: move;
    pointer-events: auto;
    transition: box-shadow 0.2s, transform 0.2s;
    overflow: hidden;
    z-index: 2;
}

.student-sticky-note:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px) rotate(0deg) !important;
}

.student-sticky-note.dragging {
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    transform: scale(1.05) rotate(0deg) !important;
    z-index: 1000 !important;
}

.student-note-content {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.student-note-text {
    flex: 1;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
    font-size: 16px;
    line-height: 1.5;
    overflow-wrap: break-word;
    margin-bottom: var(--spacing-md);
}

.student-note-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
    color: rgba(0, 0, 0, 0.7);
    margin-top: auto;
}

.student-note-author {
    font-weight: 600;
}

.student-note-date {
    opacity: 0.7;
}

.student-note-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--spacing-sm);
}

.student-note-likes {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
}

.btn-student-note {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.btn-student-note:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

.btn-like {
    color: #e63946;
}

.btn-delete {
    color: #666;
}

.student-welcome-note {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-1deg);
    width: 300px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: var(--spacing-lg);
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    z-index: 1;
}

/* Add to your CSS */
.dashboard-content {
    display: none;
}

.dashboard-content[style*="display: block"] {
    display: block !important;
}

/* Force proper text color inheritance */
body, #studentMemoryWhiteboard, #studentStickyNotesContainer {
    color: var(--text) !important;
}

/* Reset sticky note text colors */
.student-sticky-note,
.student-sticky-note .student-note-text,
.student-sticky-note .student-note-meta,
.student-sticky-note .student-note-author,
.student-sticky-note .student-note-date,
.student-sticky-note .student-note-likes {
    color: #333 !important;
}

/* Except for buttons */
.student-sticky-note .btn-student-note {
    color: inherit;
}

.student-sticky-note .btn-like {
    color: #e63946 !important;
}

/* Dark text for light backgrounds, white text for dark backgrounds */
.student-sticky-note {
    --text-dark: #333;
    --text-light: white;
    
    color: var(--text-dark) !important;
}

/* For really dark colored notes */
.student-sticky-note[style*="background: #000"],
.student-sticky-note[style*="background: #111"],
.student-sticky-note[style*="background: #222"],
.student-sticky-note[style*="background: #333"],
.student-sticky-note[style*="background: #444"],
.student-sticky-note[style*="background: #555"] {
    color: var(--text-light) !important;
}
</style>





</head>

<body>

    
  <!-- Top Navigation for Mobile -->
<nav class="top-nav" id="topNav">
  <div class="top-nav-header">
    <h2>Student Dashboard</h2>
    
    <!-- Mobile controls - all buttons in one line -->
    <div class="mobile-nav-controls" id="mobileNavControls">
      <button class="btn btn-success" onclick="window.location.href='index.html'">
        <span>ðŸ  Home</span>
      </button>
      <button class="btn btn-success" onclick="showSection('myclasses')">
        <span>ðŸŽ“ Classes</span>
      </button>
      <button class="btn btn-secondary" onclick="refreshData()">
        <span>ðŸ”„ Refresh</span>
      </button>
      <button class="btn btn-warning" onclick="exportData()">
        <span>ðŸ“¤ Export</span>
      </button>
    </div>
    
    <button class="mobile-menu-toggle" id="mobileMenuToggle">â˜°</button>
  </div>
</nav>
<div class="mobile-overlay" id="mobileOverlay"></div>

<div class="app-layout">
  
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="student-emoji">ðŸ‘¨â€ðŸŽ“</div>
      <h2>Student Dashboard</h2>
      <span class="premium-badge">ðŸ‘‘ Premium</span>
      <p class="sidebar-subtitle">Track Your Learning Journey</p>
    </div>
    
    <!-- Class Switcher -->
    <div class="class-switcher">
      <select id="classSelector" onchange="switchClass(this.value)">
        <option value="">Select a Class</option>
      </select>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showSection('dashboard'); closeMobileMenu();">
        ðŸ“Š Dashboard
      </div>

   <div class="nav-item" onclick="showStudentMemoryWall(); closeMobileMenu();">
    ðŸ“ Memory Wall
</div>
      <div class="nav-item" onclick="showSection('tasks'); closeMobileMenu();">
        ðŸ“ Tasks
      </div>
      <div class="nav-item" onclick="showSection('assignments'); closeMobileMenu();">
        ðŸ“š Assignments
      </div>
      <div class="nav-item" onclick="showSection('classroom'); closeMobileMenu();">
        ðŸ« Classroom
      </div>
      <div class="nav-item" onclick="showSection('myclasses'); closeMobileMenu();">
        ðŸŽ“ My Classes
      </div>
      <div class="nav-item" onclick="showSection('statistics'); closeMobileMenu();">
        ðŸ“ˆ Statistics
      </div>
      <div class="nav-item" onclick="showSection('tools'); closeMobileMenu();">
        ðŸ› ï¸ Study Tools
      </div>
      <div class="nav-item" onclick="showSection('ai'); closeMobileMenu();">
        ðŸ¤– AI Help
      </div>
      <div class="nav-item" onclick="showSection('profile'); closeMobileMenu();">
        ðŸ‘¤ Profile
      </div>
      <!-- New Study Group Button -->
      <div class="nav-item" onclick="window.location.href='studygroup.html'; closeMobileMenu();">
        ðŸ‘¥ Study Group
      </div>
    </nav>
    
    <div class="sidebar-stats">
      <h3>Today's Stats</h3>
      <div class="stat-row">
        <span>Study Streak</span>
        <span class="stat-value" id="sidebarStreak">0</span>
      </div>
      <div class="stat-row">
        <span>Total Hours</span>
        <span class="stat-value" id="sidebarHours">0</span>
      </div>
      <div class="stat-row">
        <span>Tasks Done</span>
        <span class="stat-value" id="sidebarTasks">0</span>
      </div>
      <div class="stat-row">
        <span>Focus Score</span>
        <span class="stat-value" id="sidebarFocus">0%</span>
      </div>
    </div>
    
    <!-- Inspiring Stories Section -->
    <div class="stories-section">
      <h3>ðŸŒŸ Inspiring Stories</h3>
      <div id="storiesList">
        <!-- Stories will be loaded here -->
      </div>
    </div>

    <!-- Study Heatmap -->
    <div class="heatmap-section">
      <h3>ðŸ—“ï¸ Study Heatmap</h3>
      <div class="pro-tip" style="margin: 0 0 var(--spacing-md) 0;">
        <strong>ðŸ’¡ Heatmap Tip</strong>
        Each square represents a day. Higher numbers and brighter squares mean more study sessions.
      </div>
      <div class="heatmap-grid" id="studyHeatmap"></div>
      <div class="heatmap-legend">
        <span>Less</span>
        <span>More</span>
      </div>
    </div>
    
    <div style="margin-top: var(--spacing-xl);">
      <select class="theme-selector" onchange="changeTheme(this.value)" style="width: 100%; padding: 0.875rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text);">
        <option value="light">â˜€ï¸ Light Theme</option>
        <option value="dark">ðŸŒ™ Dark Theme</option>
        <option value="ocean">ðŸŒŠ Ocean Theme</option>
        <option value="forest">ðŸŒ² Forest Theme</option>
        <option value="sunset">ðŸŒ… Sunset Theme</option>
        <option value="purple">ðŸ’œ Purple Theme</option>
        <option value="rainbow">ðŸŒˆ Rainbow Theme</option>
        <option value="premium">ðŸ‘‘ Premium Theme</option>
      </select>
    </div>
  </aside>
  
  <!-- Story Modal -->
  <div id="storyModal" class="story-modal">
    <div class="story-modal-content">
      <button class="story-modal-close" onclick="closeStoryModal()">Ã—</button>
      <div class="story-modal-header">
        <h2 id="storyModalTitle"></h2>
      </div>
      <div class="story-modal-body">
        <div id="storyModalContent"></div>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Dashboard Header -->
    <div class="dashboard-header" id="dashboardHeader">
      <h1>Welcome to Your Learning Dashboard</h1>
      <p class="time-greeting" id="timeGreeting"></p>
      <p class="dashboard-subtitle" id="dashboardSubtitle">Track your progress, manage tasks, and achieve your study goals</p>
      
      <!-- UPDATED: Compact Controls Bar -->
      <div class="controls-bar">
        <button class="btn btn-success" onclick="window.location.href='index.html'">
          Home
        </button>
        <button class="btn btn-success" onclick="showSection('myclasses')">ðŸŽ“ Manage Classes</button>
        <button class="btn btn-secondary" onclick="refreshData()">ðŸ”„ Refresh</button>
        <button class="btn btn-warning" onclick="exportData()">ðŸ“¤ Export Data</button>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Sync Status -->
    <div id="syncStatus" class="sync-status" style="display: none;">
      <span class="sync-icon"></span>
      <span class="sync-text"></span>
    </div>
    
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      
      <!-- Dashboard Section -->
      <div id="dashboard" class="dashboard-content" style="grid-column: span 12; display: block;">
        
        <!-- Pro Tip - Matching Teacher Mode Style -->
        <div class="pro-tip">
          <strong>ðŸ’¡ Daily Habit Building</strong>
          Mark your study streak daily! Consistency beats intensity. Even 15 minutes of focused study each day builds a strong habit and improves retention by 60% compared to cramming.
        </div>

        <!-- UPDATED: Compact Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">ðŸ”¥</div>
            <div class="stat-content">
              <div class="stat-number" id="streakDisplay">0</div>
              <div class="stat-label">Study Streak</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">â°</div>
            <div class="stat-content">
              <div class="stat-number" id="totalHoursDisplay">0</div>
              <div class="stat-label">Study Hours</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
              <div class="stat-number" id="tasksCompletedDisplay">0</div>
              <div class="stat-label">Tasks Done</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ðŸŽ¯</div>
            <div class="stat-content">
              <div class="stat-number" id="focusScoreDisplay">0%</div>
              <div class="stat-label">Focus Score</div>
            </div>
          </div>
        </div>

        <!-- Study Stats Compare -->
        <div class="content-card" style="margin-top: var(--spacing-xl);">
          <div class="content-header">
            <h2>Study Stats Compare</h2>
          </div>
          <div class="content-body profile-content-body">
            <div class="pro-tip" id="compareMsg1">You studied 20% more than average.</div>
            <div class="pro-tip" id="compareMsg2">Top 10% of users this week.</div>
          </div>
        </div>

        <!-- Daily Challenge -->
        <div class="content-card" id="dailyChallengeCard" style="margin-top: var(--spacing-xl); display: none;">
          <div class="content-header">
            <h2>ðŸ… Daily Challenge</h2>
          </div>
          <div class="content-body">
            <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
              <strong>Tip:</strong> Complete one small challenge each day to build momentum.
            </div>
            <div id="dailyChallengeText" style="font-weight: 700; margin-bottom: var(--spacing-md);"></div>
            <button class="btn btn-success" id="dailyChallengeDoneBtn" onclick="completeDailyChallenge()">âœ… I am done</button>
          </div>
        </div>
        
        <!-- Achievement Badges -->
        <div class="content-card badges-card" style="margin-top: var(--spacing-xl);">
          <div class="content-header">
            <h2>Achievement Badges</h2>
            <span class="badge" id="badgeCount" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0/6</span>
          </div>
          <div class="content-body">
            <div class="badges-grid" id="badgesGrid"></div>
            <div id="badgesEmpty" class="empty-state" style="display: none;">
              <div class="empty-state-icon">â˜…</div>
              <div class="empty-state-title">No badges yet</div>
              <div class="empty-state-description">Start studying to unlock your first badge.</div>
            </div>
          </div>
        </div>

        <!-- Main Content Area -->
        <div class="dashboard-grid" style="margin-top: var(--spacing-xl);">
          
          <!-- Left Column: Forms & Motivation -->
          <div class="forms-section">
            <!-- Profile Form -->
            <div class="form-card">
              <h2>ðŸ‘¤ My Profile</h2>
              <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                <strong>Tip:</strong> Complete your profile to personalize your learning experience and track progress accurately.
              </div>
              <div class="form-group">
                <label for="studentName">Your Name</label>
                <input type="text" id="studentName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="studentEmail">Email (Optional)</label>
                <input type="email" id="studentEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="studentBio">Bio</label>
                <textarea id="studentBio" placeholder="Tell us about yourself..." rows="3"></textarea>
              </div>
              <button class="btn-submit" onclick="saveProfile()">
                ðŸ’¾ Save Profile
              </button>
            </div>
            
            <!-- IMPROVED Streak Card -->
            <div class="form-card streak-card">
              <h2 style="color: white; position: relative; z-index: 1;">ðŸ”¥ Daily Study Streak</h2>
              <div class="streak-number" id="streakNumber">0</div>
              <div class="streak-label" id="streakLabel">DAY STREAK</div>
              
              <!-- Streak Milestones -->
              <div class="streak-milestones" id="streakMilestones">
                <!-- Milestones will be added by JavaScript -->
              </div>
              
              <!-- Streak Progress -->
              <div class="streak-progress">
                <div class="streak-progress-fill" id="streakProgressFill" style="width: 0%"></div>
              </div>
              
              <button class="streak-btn" id="streakButton" onclick="markStudyToday()">
                <span>ðŸ”¥ Mark Study Today</span>
              </button>
              <div id="streakMessage" style="margin-top: var(--spacing-md); font-weight: 600; min-height: 24px; position: relative; z-index: 1;"></div>
              <div id="streakInfo" style="margin-top: var(--spacing-sm); font-size: 0.875rem; opacity: 0.8; position: relative; z-index: 1;">
                Last studied: <span id="lastStudyDate">Never</span>
              </div>
              <div id="streakReward" style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7; position: relative; z-index: 1;">
                Next milestone: <span id="nextMilestone">7 days</span>
              </div>
             <!-- Streak Share (no file chooser) -->
<div id="streakShare" class="streak-share">
  <button id="shareStreakBtn" class="streak-btn">ðŸ“¤ Share Streak</button>
  <div id="streakShareMsg" class="streak-share-msg"></div>
 
</div>

            </div>
           <!-- Daily Goal Tracker Card -->
<div class="form-card goal-card">
  <h2>ðŸŽ¯ Daily Goal Tracker</h2>
  <div class="goal-text">Today's goal: <span id="dailyGoalText">3</span> study sessions</div>

  <div class="goal-progress">
    <div class="goal-progress-fill" id="dailyGoalFill" style="width: 0%"></div>
  </div>

  <div class="goal-stats">
    <span id="dailyGoalCount">0</span> / <span id="dailyGoalTarget">3</span> sessions
  </div>

  <div id="dailyGoalMessage" class="goal-message"></div>
  <button id="celebrateGoalBtn" class="celebrate-btn" style="display: none;" onclick="triggerConfettiBurst()">
    ðŸŽ‰ Celebrate
  </button>
  <div class="goal-input">
  <label for="dailyGoalInput">Set daily goal</label>
  <input type="number" id="dailyGoalInput" min="1" max="20" step="1" value="3">
</div>

</div>
            <!-- Motivation Card -->
            <div class="form-card motivation-card">
              <h2 style="color: white; position: relative; z-index: 1;">ðŸ’« Daily Inspiration</h2>
              <div class="quote-text" id="dailyQuote">"The only way to do great work is to love what you do."</div>
              <div class="quote-author" id="quoteAuthor">â€” Steve Jobs</div>
              <button class="btn" onclick="newQuote()" style="margin-top: var(--spacing-lg); background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; width: 100%; position: relative; z-index: 1;">
                ðŸ”„ New Inspiration
              </button>
            </div>
          </div>
          
          <!-- Right Column: Tasks & Assignments -->
          <div class="content-section">
            <!-- Tasks Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>ðŸ“ My Tasks</h2>
                <button class="btn btn-primary" onclick="showSection('tasks')">View All</button>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Break large tasks into smaller, manageable chunks. This reduces overwhelm and increases completion rates by 40%.
                </div>

                <div class="task-input-container" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                  <input type="text" id="taskInput" placeholder="Add a new task..." style="flex: 1; min-width: 0;">
                  <button class="btn btn-success" onclick="addTask()">âž• Add</button>
                </div>
                <!-- Add this AFTER the task input container in the Dashboard section -->
<div class="priority-selector" style="margin-bottom: var(--spacing-md);">
    <div class="priority-option active" data-priority="urgent" onclick="selectPriority('urgent')">
        ðŸ”´ Urgent
    </div>
    <div class="priority-option" data-priority="not-urgent" onclick="selectPriority('not-urgent')">
        ðŸŸ¡ Not Urgent
    </div>
    <div class="priority-option" data-priority="optional" onclick="selectPriority('optional')">
        âšª Optional
    </div>
</div>
                <ul class="task-list" id="taskList">
                  <!-- Tasks will appear here -->
                </ul>
              </div>
            </div>
            
            <!-- Assignments Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>ðŸ“š My Assignments</h2>
                <button class="btn btn-primary" onclick="showSection('assignments')">View All</button>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Start assignments early! Students who begin assignments 3 days before the due date score 15% higher on average.
                </div>
                <div class="assignment-list" id="assignmentList">
                  <!-- Assignments will appear here -->
                </div>
              </div>
            </div>
            
            <!-- Study Hours Input -->
            <div class="content-card">
              <div class="content-header">
                <h2>â° Add Study Hours</h2>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Use the Pomodoro Technique: 25 minutes of focused study followed by a 5-minute break improves concentration and retention.
                </div>
                <div class="form-group">
                  <label for="hoursInput">Study Hours (e.g., 2.5)</label>
                  <input type="number" id="hoursInput" placeholder="Enter study hours" step="0.25" min="0.25" max="12">
                </div>
                <button class="btn-submit" onclick="addStudyHours()">
                  â° Add Hours
                </button>
                <div style="font-size: 0.875rem; color: var(--text-muted); text-align: center; margin-top: var(--spacing-md);">
                  Track your study sessions to see your progress!
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Footer with Copyright -->
        <div class="footer">
          <p>Â© 2024 Student Learning Dashboard. All rights reserved. Made with â¤ï¸ for students everywhere.</p>
          <p style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7;">
            Education is the most powerful weapon which you can use to change the world. â€” Nelson Mandela
          </p>
        </div>
      </div>
      
      <!-- Tasks Section -->
      <div id="tasks" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ“ Task Manager</h2>
            <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
              <button class="btn btn-secondary" onclick="filterTasks('all')">All</button>
              <button class="btn btn-secondary" onclick="filterTasks('urgent')">Urgent</button>
              <button class="btn btn-secondary" onclick="filterTasks('not-urgent')">Not Urgent</button>
              <button class="btn btn-secondary" onclick="filterTasks('optional')">Optional</button>
              <button class="btn btn-secondary" onclick="filterTasks('active')">Active</button>
              <button class="btn btn-secondary" onclick="filterTasks('completed')">Completed</button>
            </div>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ðŸ’¡ Task Management Strategy</strong>
              Prioritize tasks using the Eisenhower Matrix: Urgent & Important (do first), Important but Not Urgent (schedule), Urgent but Not Important (delegate if possible), Neither (eliminate).
            </div>
            
            <!-- Simplified - tasks are already added from dashboard -->
<div style="text-align: center; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
    <p style="margin-bottom: var(--spacing-md);">Tasks are added from the Dashboard section above.</p>
    <button class="btn btn-primary" onclick="showSection('dashboard')">
        â† Back to Dashboard to Add Tasks
    </button>
</div>
            
            <div class="task-filters" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xl); flex-wrap: wrap;">
              <button class="btn btn-warning" onclick="clearCompletedTasks()">Clear Completed</button>
              <button class="btn btn-secondary" onclick="exportTasks()">Export Tasks</button>
            </div>
            
            <ul class="task-list" id="fullTaskList">
              <!-- Full task list will appear here -->
            </ul>
            
            <div class="task-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <div class="stat-display">
                <div class="number" id="totalTasks">0</div>
                <div class="label">Total Tasks</div>
              </div>
              <div class="stat-display">
                <div class="number" id="pendingTasks">0</div>
                <div class="label">Pending</div>
              </div>
              <div class="stat-display">
                <div class="number" id="completedTasks">0</div>
                <div class="label">Completed</div>
              </div>
              <div class="stat-display">
                <div class="number" id="completionRate">0%</div>
                <div class="label">Completion Rate</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Assignments Section -->
      <div id="assignments" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ“š Assignment Tracker</h2>
            <button class="btn btn-primary" onclick="showAssignmentForm()">âž• Add Assignment</button>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ Assignment Strategy</strong>
              Use backward planning: Start from the due date and work backwards, scheduling research, drafting, editing, and final review stages. This prevents last-minute rushing and improves quality.
            </div>
            
            <!-- Assignment Form -->
            <div id="assignmentForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <div class="form-group">
                  <label for="assignmentName">Assignment Name</label>
                  <input type="text" id="assignmentName" placeholder="Math Chapter 5">
                </div>
                <div class="form-group">
                  <label for="assignmentSubject">Subject</label>
                  <input type="text" id="assignmentSubject" placeholder="Mathematics">
                </div>
                <div class="form-group">
                  <label for="assignmentDueDate">Due Date</label>
                  <input type="date" id="assignmentDueDate">
                </div>
              </div>
              <div class="form-group">
                <label for="assignmentDescription">Description (Optional)</label>
                <textarea id="assignmentDescription" placeholder="Assignment details, requirements, notes..." rows="3"></textarea>
              </div>
              <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <button class="btn btn-success" onclick="addAssignment()" style="flex: 1;">âž• Add Assignment</button>
                <button class="btn btn-secondary" onclick="hideAssignmentForm()">Cancel</button>
              </div>
            </div>
            
            <div class="assignment-list" id="fullAssignmentList">
              <!-- Full assignment list will appear here -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- Classroom Section -->



      <!-- Student Memory Wall Section -->
<div id="studentMemoryWall" class="dashboard-content" style="grid-column: span 12; display: none;">
    <div class="content-card" style="padding: 0; overflow: hidden;">
        <div class="content-header" style="border-bottom: 1px solid var(--border);">
            <h2>ðŸ“ Class Memory Wall</h2>
            <button class="btn btn-primary" onclick="showStudentAddMemoryPage()">
                âœ¨ Add Memory
            </button>
        </div>
        
        <div class="content-body" style="padding: 0;">
            <div class="pro-tip" style="margin: var(--spacing-md);">
                <strong>ðŸŽ¨ Interactive Memory Wall</strong>
                See what your classmates have shared! Add your own memories, achievements, or encouraging words.
            </div>
            
            <!-- Whiteboard Container -->
            <div id="studentMemoryWhiteboard" class="memory-whiteboard">
                <!-- Background grid pattern -->
                <div class="whiteboard-background"></div>
                
                <!-- Sticky notes container -->
                <div id="studentStickyNotesContainer" class="sticky-notes-container"></div>
            </div>
            
            <!-- Memory Wall Stats -->
            <div style="padding: var(--spacing-lg); background: var(--card); border-top: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4>ðŸ“Š Wall Stats</h4>
                        <div style="display: flex; gap: var(--spacing-lg); margin-top: var(--spacing-sm);">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="studentTotalNotesCount">0</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Total Notes</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="studentTotalLikesCount">0</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Total Likes</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="studentNotesCount">0</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Your Notes</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshStudentMemoryWall()">
                            âŸ³ Refresh Wall
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



      <div id="classroom" class="dashboard-content" style="grid-column: span 12; display: none;">
        <!-- Not in Class View -->
        <div id="notInClassView" class="content-card" style="text-align: center; padding: var(--spacing-2xl);">
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ«</div>
            <div class="empty-state-title">Not in a Classroom</div>
            <div class="empty-state-description" style="margin-bottom: var(--spacing-lg);">
              Join your teacher's classroom to access announcements, resources, and track your progress together.
            </div>
            <div class="pro-tip" style="margin: var(--spacing-lg) 0; max-width: 500px;">
              <strong>ðŸ’¡ Why Join a Classroom?</strong>
              Classrooms provide structure, access to teacher resources, peer motivation through leaderboards, and organized announcements. Students in classrooms show 30% higher engagement.
            </div>
            <button class="btn btn-primary" onclick="showSection('myclasses')" style="padding: 1rem 2rem; font-size: 1.125rem;">
              ðŸŽ“ Join a Classroom
            </button>
            <p style="margin-top: var(--spacing-lg); color: var(--text-muted);">
              Ask your teacher for the class code!
            </p>
          </div>
        </div>
        
        <!-- In Class View -->
        <div id="inClassView" style="display: none;">
          <!-- Class Header -->
          <div class="content-card">
            <div class="class-code-display">
              <div style="font-size: 1rem; opacity: 0.9; letter-spacing: 1px; position: relative; z-index: 1;">CLASS CODE</div>
              <div class="code" id="currentClassCode">LOADING...</div>
              <div style="display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-lg); flex-wrap: wrap; position: relative; z-index: 1;">
                <button class="btn btn-secondary" onclick="copyClassCode()">ðŸ“‹ Copy Code</button>
                <button class="btn btn-danger" onclick="leaveClass()">ðŸšª Leave Class</button>
                <button class="btn btn-success" onclick="refreshClassroom()">ðŸ”„ Refresh</button>
              </div>
            </div>
          </div>
          
          <!-- Pro Tip -->
          <div class="pro-tip">
            <strong>ðŸ’¡ Active Classroom Participation</strong>
            Regularly check announcements and resources. Engage with the leaderboard - healthy competition increases motivation. Students who actively participate in classrooms complete 40% more assignments.
          </div>
          
          <!-- Announcements -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ“¢ Teacher's Announcements</h2>
              <span class="badge" id="announcementCount" style="background: var(--accent); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherAnnouncements" style="min-height: 200px;">
                <div class="loading">Loading announcements...</div>
              </div>
            </div>
          </div>
          
          <!-- Resources -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ“š Learning Resources</h2>
              <span class="badge" id="resourceCount" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherResources" style="min-height: 200px;">
                <div class="loading">Loading resources...</div>
              </div>
            </div>
          </div>
          
          <!-- Class Polls -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ—³ï¸ Class Polls</h2>
              <span class="badge" id="pollCount" style="background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherPolls" style="min-height: 200px;">
                <div class="loading">Loading polls...</div>
              </div>
            </div>
          </div>





         





          


          <!-- Engagement Heatmap (Aggregate) -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ“Š Engagement Heatmap</h2>
            </div>
            <div class="content-body">
              <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                <strong>ðŸ’¡ Aggregate Insight</strong>
                Shows when the class studies most (no individual data).
              </div>
              <div id="aggregateHeatmap" class="aggregate-heatmap"></div>
              <div id="aggregateInsight" class="aggregate-heatmap-insight"></div>
            </div>
          </div>
          
          <!-- Leaderboard -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ† Class Leaderboard</h2>
              <button class="btn btn-secondary" onclick="refreshLeaderboard()">ðŸ”„ Refresh</button>
            </div>
            <div class="content-body">
              <div class="leaderboard-container" id="classLeaderboard">
                <div class="loading">Loading leaderboard...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      

       <!-- Student Mode: Add Memory Page -->
<div id="studentAddMemoryPage" class="dashboard-content" style="display: none;">
    <div class="content-card">
        <div class="content-header" style="border-bottom: 1px solid var(--border);">
            <h2>âœ¨ Add to Memory Wall</h2>
            <button class="btn btn-secondary" onclick="studentBackToMemoryWall()">
                â† Back to Memory Wall
            </button>
        </div>
        
        <div class="content-body">
            <div class="pro-tip" style="margin-bottom: var(--spacing-xl);">
                <strong>ðŸŽ¨ Share with Your Class</strong>
                Add a memory, achievement, or encouraging word. Your note will appear on the class wall for everyone to see!
            </div>
            
            <div style="max-width: 600px; margin: 0 auto;">
                <!-- Message Input -->
                <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                    <label for="studentAddMemoryText" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                        Your Message
                    </label>
                    <textarea id="studentAddMemoryText" 
                              placeholder="What I learned this week...&#10;Something I'm proud of...&#10;Encouraging word for classmates..."
                              rows="5"
                              maxlength="300"
                              style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); resize: vertical; font-family: 'Comic Sans MS', 'Chalkboard SE', cursive; font-size: 16px;"></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: var(--spacing-xs);">
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            ðŸ’¡ Be positive and encouraging!
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            <span id="studentAddMemoryCharCount">0</span>/300 characters
                        </div>
                    </div>
                </div>
                
                <!-- Name and Color -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentAddMemoryAuthor" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Your Name
                        </label>
                        <input type="text" id="studentAddMemoryAuthor" 
                               placeholder="Your name"
                               style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-size: 16px;"
                               value="Student">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Note Color
                        </label>
                        <div class="color-picker">
                            <div class="color-option selected" data-color="#FFEB3B" onclick="studentSelectAddMemoryColor('#FFEB3B')" style="background: #FFEB3B;"></div>
                            <div class="color-option" data-color="#C8E6C9" onclick="studentSelectAddMemoryColor('#C8E6C9')" style="background: #C8E6C9;"></div>
                            <div class="color-option" data-color="#BBDEFB" onclick="studentSelectAddMemoryColor('#BBDEFB')" style="background: #BBDEFB;"></div>
                            <div class="color-option" data-color="#E1BEE7" onclick="studentSelectAddMemoryColor('#E1BEE7')" style="background: #E1BEE7;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Preview -->
                <div class="form-group" style="margin-bottom: var(--spacing-xl);">
                    <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                        Preview
                    </label>
                    <div id="studentAddMemoryPreview" class="sticky-note-preview" style="background: #FFEB3B; min-height: 120px;">
                        <div class="preview-content">
                            <div class="preview-text" id="studentAddMemoryPreviewText">
                                Your memory will appear here...
                            </div>
                            <div class="preview-meta">
                                <span class="preview-author" id="studentAddMemoryPreviewAuthor">Student</span>
                                <span style="margin-left: 8px;">ðŸ‘¨â€ðŸŽ“</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--spacing-md);">
                    <button class="btn btn-secondary" onclick="studentBackToMemoryWall()" style="flex: 1;">
                        â† Cancel
                    </button>
                    <button class="btn btn-success" onclick="studentSubmitMemory()" style="flex: 2; padding: var(--spacing-lg);">
                        ðŸ“Œ Add to Memory Wall
                    </button>
                </div>
                
                <!-- Examples -->
                <div style="margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--accent-light); border-radius: var(--radius);">
                    <h4 style="margin-bottom: var(--spacing-md); color: var(--accent);">ðŸ’¡ Need ideas?</h4>
                    <ul style="margin-left: var(--spacing-lg); line-height: 1.8;">
                        <li>"I finally understand how to solve equations!"</li>
                        <li>"Great work everyone on the group project!"</li>
                        <li>"The science experiment today was amazing!"</li>
                        <li>"You can do it! Keep studying!"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
      <!-- My Classes Section -->
      <div id="myclasses" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸŽ“ My Classes</h2>
            <button class="btn btn-primary" onclick="showJoinClassForm()">âž• Join Class</button>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ Multiple Classes Strategy</strong>
              Join relevant classes for different subjects. Organize your study time by dedicating specific days to each class. Students in 2-3 balanced classes show the best performance outcomes.
            </div>
            
            <!-- Join Class Form -->
            <div id="joinClassForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <h3 style="margin-bottom: var(--spacing-lg);">Join a New Class</h3>
              <div class="form-group">
                <label for="joinClassCode">Class Code</label>
                <input type="text" id="joinClassCode" placeholder="Enter 6-digit class code" maxlength="6" style="text-transform: uppercase; font-family: 'Courier New', monospace; letter-spacing: 0.5rem; font-size: 1.5rem; text-align: center;">
              </div>
              <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <button class="btn btn-success" onclick="joinClass()" style="flex: 1;">ðŸŽ“ Join Class</button>
                <button class="btn btn-secondary" onclick="hideJoinClassForm()">Cancel</button>
              </div>
            </div>
            
            <div class="classes-grid" id="classesList">
              <!-- Classes will appear here -->
            </div>
            
            <div id="noClassesMessage" class="empty-state" style="display: none;">
              <div class="empty-state-icon">ðŸ«</div>
              <div class="empty-state-title">No Classes Yet</div>
              <div class="empty-state-description">
                Join your first classroom to start tracking your progress with classmates!
              </div>
              <button class="btn btn-primary" onclick="showJoinClassForm()" style="margin-top: var(--spacing-lg);">
                ðŸŽ“ Join Your First Class
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- UPDATED: Enhanced Statistics Section -->
      <div id="statistics" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="statistics-grid">
          <!-- Statistics Header -->
          <div class="statistics-header">
            <h2>ðŸ“ˆ Learning Statistics</h2>
            <div class="statistics-subtitle">Visualize your progress with detailed charts and insights</div>
            <div class="stats-controls">
              <button class="btn btn-primary" onclick="refreshCharts()">
                ðŸ”„ Refresh Charts
              </button>
              <button class="btn btn-secondary" onclick="exportStatistics()">
                ðŸ“¥ Export Stats
              </button>
              <button class="btn btn-success" onclick="markStudySession()">
                ðŸ“ Mark Study Session
              </button>
            </div>
          </div>
          
          <!-- Pro Tip -->
          <div class="pro-tip" style="grid-column: span 12;">
            <strong>ðŸ’¡ Data-Driven Learning</strong>
            Review your statistics weekly to identify patterns. Track what study methods work best for you and adjust accordingly. Students who review their data improve 25% faster than those who don't.
          </div>
          
          <!-- Overview Cards -->
          <div class="stats-overview-cards">
            <div class="stats-overview-card">
              <div class="stats-overview-icon">ðŸ”¥</div>
              <div class="stats-overview-number" id="overviewStreak">0</div>
              <div class="stats-overview-label">Study Streak</div>
              <div class="stats-overview-trend neutral" id="streakTrend">
                <span>âž¡ï¸</span>
                <span>Maintain daily study</span>
              </div>
            </div>
            <div class="stats-overview-card">
              <div class="stats-overview-icon">â°</div>
              <div class="stats-overview-number" id="overviewHours">0</div>
              <div class="stats-overview-label">Study Hours</div>
              <div class="stats-overview-trend neutral" id="hoursTrend">
                <span>âž¡ï¸</span>
                <span>Track your sessions</span>
              </div>
            </div>
            <div class="stats-overview-card">
              <div class="stats-overview-icon">âœ…</div>
              <div class="stats-overview-number" id="overviewTasks">0</div>
              <div class="stats-overview-label">Tasks Completed</div>
              <div class="stats-overview-trend neutral" id="tasksTrend">
                <span>âž¡ï¸</span>
                <span>Complete more tasks</span>
              </div>
            </div>
            <div class="stats-overview-card">
              <div class="stats-overview-icon">ðŸŽ¯</div>
              <div class="stats-overview-number" id="overviewFocus">0%</div>
              <div class="stats-overview-label">Focus Score</div>
              <div class="stats-overview-trend neutral" id="focusTrend">
                <span>âž¡ï¸</span>
                <span>Improve consistency</span>
              </div>
            </div>
          </div>
          
          <!-- Performance Metrics -->
          <div class="performance-metrics">
            <h3>ðŸ“Š Performance Metrics</h3>
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-icon">ðŸ“…</div>
                <div class="metric-value" id="metricSessions">0</div>
                <div class="metric-label">Study Sessions</div>
                <div class="metric-details">This week</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">âš¡</div>
                <div class="metric-value" id="metricAvgHours">0h</div>
                <div class="metric-label">Avg. Daily Hours</div>
                <div class="metric-details">Based on last 7 days</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ðŸ†</div>
                <div class="metric-value" id="metricLongestStreak">0</div>
                <div class="metric-label">Longest Streak</div>
                <div class="metric-details">All-time record</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ðŸ“ˆ</div>
                <div class="metric-value" id="metricConsistency">0%</div>
                <div class="metric-label">Consistency</div>
                <div class="metric-details">Study regularity</div>
              </div>
            </div>
          </div>
          
          <!-- Charts Section -->
          <div class="charts-container">
            <!-- Study Hours Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>â° Study Hours Distribution</h3>
                <div class="chart-description">Daily study hours over the past week</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="hoursChart"></canvas>
              </div>
              <div class="chart-legend" id="hoursLegend"></div>
            </div>
            
            <!-- Focus Score Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸŽ¯ Daily Focus Score</h3>
                <div class="chart-description">Daily focus scores based on consistency</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="focusChart"></canvas>
              </div>
              <div class="chart-legend" id="focusLegend"></div>
            </div>
            
            <!-- Task Completion Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>âœ… Task Completion</h3>
                <div class="chart-description">Task completion rate and progress</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="tasksChart"></canvas>
              </div>
              <div class="chart-legend" id="tasksLegend"></div>
            </div>
            
            <!-- Weekly Pattern Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸ“… Weekly Study Pattern</h3>
                <div class="chart-description">Study distribution across days of the week</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="weeklyChart"></canvas>
              </div>
              <div class="chart-legend" id="weeklyLegend"></div>
            </div>
            
            <!-- Assignment Status Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸ“š Assignment Status</h3>
                <div class="chart-description">Current assignment completion status</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="assignmentsChart"></canvas>
              </div>
              <div class="chart-legend" id="assignmentsLegend"></div>
            </div>
            
            <!-- Streak History Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸ”¥ Streak History</h3>
                <div class="chart-description">Daily streak progression over time</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="streakChart"></canvas>
              </div>
              <div class="chart-legend" id="streakLegend"></div>
            </div>
          </div>
          
          <!-- Detailed Statistics -->
          <div class="stats-detailed-container">
            <h3>ðŸ“‹ Detailed Performance Analysis</h3>
            <div class="stats-detailed-grid">
              <div class="stats-detailed-section">
                <h4>Productivity Metrics</h4>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Total Study Hours</span>
                  <span class="stats-detailed-value" id="detailTotalHours">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Study Sessions</span>
                  <span class="stats-detailed-value" id="detailTotalSessions">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Avg. Session Length</span>
                  <span class="stats-detailed-value" id="detailAvgSession">0h</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Longest Session</span>
                  <span class="stats-detailed-value" id="detailLongestSession">0h</span>
                </div>
              </div>
              
              <div class="stats-detailed-section">
                <h4>Task Metrics</h4>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Total Tasks</span>
                  <span class="stats-detailed-value" id="detailTotalTasks">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Completed Tasks</span>
                  <span class="stats-detailed-value" id="detailCompletedTasks">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Completion Rate</span>
                  <span class="stats-detailed-value" id="detailCompletionRate">0%</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Active Tasks</span>
                  <span class="stats-detailed-value" id="detailActiveTasks">0</span>
                </div>
              </div>
              
              <div class="stats-detailed-section">
                <h4>Achievement Metrics</h4>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Current Streak</span>
                  <span class="stats-detailed-value" id="detailCurrentStreak">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Longest Streak</span>
                  <span class="stats-detailed-value" id="detailLongestStreak">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Focus Score</span>
                  <span class="stats-detailed-value" id="detailFocusScore">0%</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Consistency Score</span>
                  <span class="stats-detailed-value" id="detailConsistencyScore">0%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tools Section -->
      <div id="tools" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ› ï¸ Study Tools</h2>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ Tool Integration</strong>
              Combine different tools for maximum effectiveness. Use Pomodoro timer for focus, flashcards for memorization, and habit tracker for consistency. Integrated tool users show 35% better results.
            </div>
            
            <div class="tools-grid">
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/ai-tic-tac-toe.html', '_blank')">
                <div class="tool-icon">ðŸŽ®</div>
                <div class="tool-name">AI Tic Tac Toe</div>
                <div class="tool-desc">Challenge AI in this classic game</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/countdown-timer.html', '_blank')">
                <div class="tool-icon">â³</div>
                <div class="tool-name">Countdown Timer</div>
                <div class="tool-desc">Track study sessions and breaks</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/habit-tracker.html', '_blank')">
                <div class="tool-icon">ðŸ“Š</div>
                <div class="tool-name">Habit Tracker</div>
                <div class="tool-desc">Build and maintain good habits</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/todolist.html', '_blank')">
                <div class="tool-icon">ðŸ“</div>
                <div class="tool-name">To-Do List</div>
                <div class="tool-desc">Advanced task management</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/notesapp.html', '_blank')">
                <div class="tool-icon">ðŸ“’</div>
                <div class="tool-name">Notes App</div>
                <div class="tool-desc">Take organized notes</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/numberguess.html', '_blank')">
                <div class="tool-icon">ðŸŽ¯</div>
                <div class="tool-name">Number Guess</div>
                <div class="tool-desc">Brain training game</div>
              </div>
              
              <div class="tool-item" onclick="window.open('pomodoro.html', '_blank')">
                <div class="tool-icon">ðŸ…</div>
                <div class="tool-name">Pomodoro Timer</div>
                <div class="tool-desc">Boost productivity with intervals</div>
              </div>
              
              <div class="tool-item" onclick="window.open('flashcard-generator.html', '_blank')">
                <div class="tool-icon">ðŸ“‡</div>
                <div class="tool-name">Flashcards</div>
                <div class="tool-desc">Create and study flashcards</div>
              </div>
            </div>
          </div>
        </div>
      </div>




      <!-- Student Memory Wall Section -->
<div id="studentMemoryWall" class="dashboard-content" style="grid-column: span 12; display: none;">
    <div class="content-card">
        <div class="content-header">
            <h2>ðŸ“ Class Memory Wall</h2>
            <button class="btn btn-primary" onclick="showStudentAddMemoryPage()">
                âœ¨ Add Memory
            </button>
        </div>
        <div class="content-body">
            <div class="pro-tip">
                <strong>ðŸŽ¨ Share Memories with Your Class</strong>
                See what your classmates have shared! Add your own achievements, encouraging words, or fun memories.
            </div>
            
            <!-- Memory Wall Container -->
            <div id="studentMemoryWallContainer" style="min-height: 400px; padding: var(--spacing-lg);">
                <div class="loading">Loading memories...</div>
            </div>
        </div>
    </div>
</div>



      <!-- AI Help Section -->
      <div id="ai" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ¤– AI Learning Resources</h2>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ AI Learning Strategy</strong>
              Use AI to explain difficult concepts, generate practice questions, or get writing feedback. Combine AI explanations with traditional resources for comprehensive understanding.
            </div>
            
            <div class="tools-grid">
              <div class="tool-item" onclick="window.open('https://chat.openai.com', '_blank')">
                <div class="tool-icon">ðŸ’¬</div>
                <div class="tool-name">ChatGPT</div>
                <div class="tool-desc">AI assistant for learning and research</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://gemini.google.com', '_blank')">
                <div class="tool-icon">ðŸ”®</div>
                <div class="tool-name">Google Gemini</div>
                <div class="tool-desc">AI-powered research and answers</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.perplexity.ai', '_blank')">
                <div class="tool-icon">ðŸ”</div>
                <div class="tool-name">Perplexity AI</div>
                <div class="tool-desc">Answer engine with citations</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.khanacademy.org', '_blank')">
                <div class="tool-icon">ðŸŽ“</div>
                <div class="tool-name">Khan Academy</div>
                <div class="tool-desc">Free online courses and lessons</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.coursera.org', '_blank')">
                <div class="tool-icon">ðŸ›ï¸</div>
                <div class="tool-name">Coursera</div>
                <div class="tool-desc">University courses and certificates</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.youtube.com', '_blank')">
                <div class="tool-icon">ðŸ“º</div>
                <div class="tool-name">YouTube</div>
                <div class="tool-desc">Educational videos and tutorials</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://quizlet.com', '_blank')">
                <div class="tool-icon">ðŸ§ </div>
                <div class="tool-name">Quizlet</div>
                <div class="tool-desc">Study tools and flashcards</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://duolingo.com', '_blank')">
                <div class="tool-icon">ðŸ¦‰</div>
                <div class="tool-name">Duolingo</div>
                <div class="tool-desc">Language learning made fun</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Profile Section -->
      <div id="profile" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ‘¤ Profile Settings</h2>
          </div>
          <div class="content-body">
            <div style="max-width: 600px; margin: 0 auto;">
              <!-- Pro Tip -->
              <div class="pro-tip">
                <strong>ðŸ’¡ Personalized Learning</strong>
                Customize your preferences based on your learning style. Morning person? Schedule study then. Visual learner? Use more diagrams and charts in your notes.
              </div>
              
              <div class="form-group">
                <label for="profileName">Your Name</label>
                <input type="text" id="profileName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="profileEmail">Email (Optional)</label>
                <input type="email" id="profileEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="profileBio">Bio</label>
                <textarea id="profileBio" placeholder="Tell us about yourself..." rows="4"></textarea>
              </div>
      <div class="form-group">
        <label>Study Preferences</label>
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; margin-top: var(--spacing-sm);">
          <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
            <input type="checkbox" id="prefPomodoro"> Pomodoro Timer
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
            <input type="checkbox" id="prefReminders"> Study Reminders
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
            <input type="checkbox" id="prefLeaderboard"> Show Leaderboard
          </label>
        </div>
      </div>
      <div class="content-card" style="margin-top: var(--spacing-lg);">
        <div class="content-header">
          <h2>ðŸ‘‘ Premium Theme</h2>
          <span class="premium-badge">Premium</span>
        </div>
        <div class="content-body">
          <div class="pro-tip">
            <strong>ðŸ’¡ How To Unlock</strong>
            Refer Grindly Learn to 3 friends and the Premium Theme unlocks automatically.
          </div>
          <div class="pro-tip" id="premiumStatusMsg">
            Refer Grindly Learn to 3 friends to unlock the Premium Theme.
          </div>
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="copyReferralLink()">ðŸ“¤ Copy Referral Link</button>
            <button class="btn btn-success" onclick="markReferral()">âœ… I Referred a Friend</button>
            <button class="btn btn-warning" onclick="previewPremiumTheme()">ðŸ‘ï¸ Preview Premium</button>
          </div>
          <div style="margin-top: var(--spacing-md); font-weight: 600;">
            Referrals: <span id="referralCount">0</span>/3
          </div>
        </div>
      </div>
      <div class="content-card" style="margin-top: var(--spacing-lg);">
        <div class="content-header">
          <h2>ðŸŒˆ Rainbow Theme</h2>
          <span class="premium-badge" id="rainbowBadge">ðŸ”’ Locked</span>
        </div>
        <div class="content-body">
          <div class="pro-tip">
            <strong>ðŸ’¡ How To Unlock</strong>
            Hit a 30â€‘day streak to unlock the Rainbow Theme.
          </div>
          <div class="pro-tip" id="rainbowStatusMsg">
            Reach a 30â€‘day streak to unlock the Rainbow Theme.
          </div>
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="previewRainbowTheme()">ðŸ‘ï¸ Preview Rainbow</button>
          </div>
          <div style="margin-top: var(--spacing-md); font-weight: 600;">
            Streak: <span id="rainbowStreakCount">0</span>/30
          </div>
        </div>
      </div>
              <button class="btn-submit" onclick="saveProfileSettings()" style="margin-top: var(--spacing-lg);">
                ðŸ’¾ Save Profile Settings
              </button>
              
              <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
                <h3>ðŸ“Š Data Management</h3>
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); flex-wrap: wrap;">
                  <button class="btn btn-warning" onclick="exportData()">ðŸ“¤ Export All Data</button>
                  <button class="btn btn-danger" onclick="clearAllData()">ðŸ—‘ï¸ Clear All Data</button>
                </div>
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-sm);">
                  Export your data for backup or clear all data to start fresh.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </main>
</div>
<!-- Floating Feedback Button -->
<button class="feedback-btn" onclick="openFeedbackForm()">
    ðŸ’¬ Give Feedback
</button>
<!-- AI Chatbot -->
<div class="chatbot-fab" aria-live="polite">
    <div class="chatbot-bubble" id="chatbotBubble">Youâ€™ve got this.</div>
    <button class="chatbot-btn" id="chatbotBtn" aria-label="Encouragement bot">
        <img class="chatbot-img" src="ai-chatbot-transparent.png" alt="Chatbot">
    </button>
</div>
<audio id="applauseAudio" src="applause.mp3" preload="auto"></audio>
<div class="clap-overlay" id="clapOverlay" aria-hidden="true">
  <video class="clap-video" id="clapVideo" src="clapping.mp4" playsinline muted></video>
  <canvas class="clap-canvas" id="clapCanvas"></canvas>
</div>
<!-- Referral Modal -->
<div class="referral-modal" id="referralModal">
  <div class="referral-modal-card">
    <div class="referral-modal-title">Unlock Premium Theme</div>
    <div class="referral-modal-text">
      Refer Grindly Learn to 3 friends. The theme unlocks when they log their first study session.
    </div>
    <div style="margin-bottom: var(--spacing-md); font-weight: 700;">
      Referrals: <span id="referralCountModal">0</span>/3
    </div>
    <div class="referral-modal-actions">
      <button class="btn btn-secondary" onclick="copyReferralLink()">ðŸ“¤ Copy Referral Link</button>
      <button class="btn btn-success" onclick="markReferral()">âœ… I Referred a Friend</button>
      <button class="btn btn-warning" onclick="closeReferralModal()">Close</button>
    </div>
  </div>
</div>
<!-- Rainbow Preview Modal -->
<div class="rainbow-modal" id="rainbowModal">
  <div class="rainbow-modal-card">
    <div class="referral-modal-title">ðŸŒˆ Rainbow Theme</div>
    <div class="referral-modal-text" id="rainbowModalText" style="color: #e5e7ff;">
      Hit a 30â€‘day streak to unlock the Rainbow Theme.
    </div>
    <div style="margin-bottom: var(--spacing-md); font-weight: 700;">
      Streak: <span id="rainbowModalCount">0</span>/30
    </div>
    <div class="referral-modal-actions">
      <button class="btn btn-warning" onclick="closeRainbowModal()">Close</button>
    </div>
  </div>
</div>
<!-- Forest Preview Modal -->
<div class="forest-modal" id="forestModal">
  <div class="forest-modal-card">
    <div class="referral-modal-title">ðŸŒ² Forest Theme</div>
    <div class="referral-modal-text" id="forestModalText" style="color: #d1fae5;">
      Hit a 7â€‘day streak to unlock the Forest Theme.
    </div>
    <div style="margin-bottom: var(--spacing-md); font-weight: 700;">
      Streak: <span id="forestModalCount">0</span>/7
    </div>
    <div class="referral-modal-actions">
      <button class="btn btn-warning" onclick="closeForestModal()">Close</button>
    </div>
  </div>
</div>
<script>
// ========== MOBILE MENU FUNCTIONALITY ==========
function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
}

// Add mobile menu toggle listener
document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileMenu);
document.getElementById('mobileOverlay').addEventListener('click', closeMobileMenu);

// Close menu when clicking outside on mobile
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('mobileMenuToggle');
    const overlay = document.getElementById('mobileOverlay');
    
    if (window.innerWidth <= 991 && 
        !sidebar.contains(event.target) && 
        !toggleBtn.contains(event.target) && 
        sidebar.classList.contains('active')) {
        closeMobileMenu();
    }
});

// Close menu on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMobileMenu();
    }
});

// ========== FIREBASE CONFIGURATION ==========
const firebaseConfig = {
    apiKey: "AIzaSyBAIPxgXPZmGdPvB98TLFRfTAClgXWEIM0",
    authDomain: "student-teacher-app-4e7c9.firebaseapp.com",
    databaseURL: "https://student-teacher-app-4e7c9-default-rtdb.firebaseio.com",
    projectId: "student-teacher-app-4e7c9",
    storageBucket: "student-teacher-app-4e7c9.firebasestorage.app",
    messagingSenderId: "737621420458",
    appId: "1:737621420458:web:74c873869a1a47c2ce23d3"
};
const IMGBB_API_KEY = "PASTE_YOUR_IMGBB_KEY_HERE";



async function uploadImageToImgBB(blob) {
    const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const result = reader.result;
            resolve(result.split(',')[1]); // base64 only
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });

    const form = new FormData();
    form.append('image', base64);

    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: 'POST',
        body: form
    });

    const data = await res.json();
    if (!data || !data.success) {
        throw new Error('ImgBB upload failed');
    }

    return data.data.url; // direct image URL
}

async function shortenUrl(longUrl) {
    const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
    const shortUrl = await res.text();
    return shortUrl;
}

// ========== GLOBAL VARIABLES ==========
let currentUser = null;
let currentUserId = null;
let currentUserName = "Student";
let database = null;
let auth = null;
let userClasses = [];
let currentClassCode = null;
let selectedClassIndex = 0;

// Initialize with proper default values to prevent undefined errors
let studyData = {
    streak: 0,
    lastStudyDate: "",
    totalMinutes: 0,
    totalStudyDays: 0,
    totalStudyHours: 0,
    studySessions: [],
    weeklyPattern: [0, 0, 0, 0, 0, 0, 0],
    streakHistory: [],
    streakMilestones: [3, 7, 14, 30, 60, 90],
    currentMilestone: 0,
    dailyStats: [],
    focusScores: [],
    consistencyScores: []
};

let tasks = [];
let assignments = [];
let currentTaskFilter = 'all';
let currentSection = 'dashboard';
let selectedPriority = 'urgent';

// Chart instances
let hoursChart = null;
let tasksChart = null;
let weeklyChart = null;
let assignmentsChart = null;
let streakChart = null;
let focusChart = null;

// Chart auto-refresh interval
let chartRefreshInterval = null;

// ========== INSPIRING QUOTES DATABASE ==========
const inspiringQuotes = [
    { text: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
    { text: "The beautiful thing about learning is that no one can take it away from you.", author: "B.B. King" },
    { text: "Don't let what you cannot do interfere with what you can do.", author: "John Wooden" },
    { text: "The more that you read, the more things you will know. The more that you learn, the more places you'll go.", author: "Dr. Seuss" },
    { text: "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice.", author: "Brian Herbert" },
    { text: "Knowledge is power. Information is liberating. Education is the premise of progress, in every society, in every family.", author: "Kofi Annan" },
    { text: "The roots of education are bitter, but the fruit is sweet.", author: "Aristotle" },
    { text: "Education is not preparation for life; education is life itself.", author: "John Dewey" },
    { text: "The mind is not a vessel to be filled, but a fire to be kindled.", author: "Plutarch" },
    { text: "Live as if you were to die tomorrow. Learn as if you were to live forever.", author: "Mahatma Gandhi" },
    { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
    { text: "The only person who is educated is the one who has learned how to learn and change.", author: "Carl Rogers" },
    { text: "Education is the key to unlocking the world, a passport to freedom.", author: "Oprah Winfrey" },
    { text: "Learning is a treasure that will follow its owner everywhere.", author: "Chinese Proverb" },
    { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
    { text: "Success is not the key to happiness. Happiness is the key to success. If you love what you are doing, you will be successful.", author: "Albert Schweitzer" },
    { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
    { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" },
    { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
    { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
    { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
    { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
    { text: "The future depends on what you do today.", author: "Mahatma Gandhi" },
    { text: "You miss 100% of the shots you don't take.", author: "Wayne Gretzky" },
    { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
    { text: "Optimism is the faith that leads to achievement. Nothing can be done without hope and confidence.", author: "Helen Keller" },
    { text: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
    { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
    { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
    { text: "I can't change the direction of the wind, but I can adjust my sails to always reach my destination.", author: "Jimmy Dean" },
    { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
    { text: "The difference between a successful person and others is not a lack of strength, not a lack of knowledge, but rather a lack in will.", author: "Vince Lombardi" },
    { text: "The harder I work, the more luck I seem to have.", author: "Thomas Jefferson" },
    { text: "Don't be pushed around by the fears in your mind. Be led by the dreams in your heart.", author: "Roy T. Bennett" },
    { text: "Strength doesn't come from what you can do. It comes from overcoming the things you once thought you couldn't.", author: "Rikki Rogers" },
    { text: "Every accomplishment starts with the decision to try.", author: "John F. Kennedy" },
    { text: "You don't have to see the whole staircase, just take the first step.", author: "Martin Luther King Jr." },
    { text: "The only thing standing between you and your goal is the story you keep telling yourself as to why you can't achieve it.", author: "Jordan Belfort" },
    { text: "Small daily improvements are the key to staggering long-term results.", author: "Darren Hardy" },
    { text: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
    { text: "What you get by achieving your goals is not as important as what you become by achieving your goals.", author: "Zig Ziglar" },
    { text: "Your potential is endless. Go do what you were created to do.", author: "Unknown" },
    { text: "The moment you give up is the moment you let someone else win.", author: "Kobe Bryant" },
    { text: "Challenges are what make life interesting and overcoming them is what makes life meaningful.", author: "Joshua J. Marine" },
    { text: "Don't limit your challenges. Challenge your limits.", author: "Unknown" },
    { text: "The pain of discipline weighs ounces, the pain of regret weighs tons.", author: "Jim Rohn" },
    { text: "Success is stumbling from failure to failure with no loss of enthusiasm.", author: "Winston Churchill" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" }
];

// ========== AI CHATBOT ==========
const chatbotMessages = [
    "Youâ€™ve got this. One step at a time.",
    "Small progress is still progress.",
    "Focus for five minutes â€” start now.",
    "Youâ€™re building a powerful habit.",
    "Be proud of showing up today.",
    "Keep going. Future you will thank you.",
    "Youâ€™re not alone â€” keep pushing.",
    "Just one more task, you can do it.",
    "Your effort matters more than perfection.",
    "Deep breath. You are capable.",
    "Consistency beats intensity.",
    "Start messy. Finish strong.",
    "Do the next small thing.",
    "Youâ€™re making it happen.",
    "Keep the streak alive.",
    "Show up for yourself today.",
    "Make today count.",
    "Momentum starts now.",
    "Youâ€™re stronger than distractions.",
    "One focused hour can change a day.",
    "Tiny steps, big results.",
    "This is your time. Use it.",
    "Stay steady. You are doing great.",
    "Progress is a victory.",
    "Youâ€™re learning fast.",
    "Your focus is your superpower.",
    "Donâ€™t wait for perfect. Start.",
    "You are in control.",
    "Finish one task. Then another.",
    "Keep the pace.",
    "Youâ€™re closer than you think.",
    "Todayâ€™s effort shapes tomorrow.",
    "Keep your eyes on the goal.",
    "Youâ€™re building mastery.",
    "You can do hard things.",
    "Stay with it.",
    "One page at a time.",
    "One problem at a time.",
    "Keep calm and study on.",
    "Breathe. Focus. Execute.",
    "Your future self is cheering.",
    "This is a good moment to start.",
    "Every session counts.",
    "Youâ€™re on the right track.",
    "Your discipline is growing.",
    "Youâ€™re doing better than you think.",
    "Itâ€™s okay to go slow.",
    "Choose progress today.",
    "Youâ€™ve already begun â€” keep going.",
    "The work will pay off.",
    "Stay locked in.",
    "You are capable of more.",
    "Make it happen today.",
    "Focus now, relax later.",
    "Small wins matter.",
    "Do it for your goals.",
    "Keep your head up.",
    "Youâ€™ve got momentum.",
    "Trust the process.",
    "Youâ€™re building something great."
];

const dailyChallenges = [
    "Finish one focused 25â€‘minute study session.",
    "Review notes for 10 minutes without distractions.",
    "Complete one pending task from your list.",
    "Summarize one lesson in 3 bullet points.",
    "Do 10 practice questions in a row.",
    "Study for 20 minutes and take a 5â€‘minute break.",
    "Organize your tasks for tomorrow.",
    "Rewrite a concept in your own words.",
    "Teach a concept out loud for 3 minutes.",
    "Clear one small assignment step today."
];

const DAILY_CHALLENGE_KEY = 'studentDailyChallenge';
const DAILY_CHALLENGE_DATE_KEY = 'studentDailyChallengeDate';
const DAILY_CHALLENGE_DONE_KEY = 'studentDailyChallengeDone';
const DAILY_CHALLENGE_SHOWN_KEY = 'studentDailyChallengeShown';

function getTodayKeySimple() {
    return new Date().toDateString();
}

function getDailyChallenge() {
    const today = getTodayKeySimple();
    const savedDate = localStorage.getItem(DAILY_CHALLENGE_DATE_KEY);
    if (savedDate === today) {
        return localStorage.getItem(DAILY_CHALLENGE_KEY);
    }
    const challenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
    localStorage.setItem(DAILY_CHALLENGE_DATE_KEY, today);
    localStorage.setItem(DAILY_CHALLENGE_KEY, challenge);
    localStorage.setItem(DAILY_CHALLENGE_DONE_KEY, 'false');
    localStorage.setItem(DAILY_CHALLENGE_SHOWN_KEY, '');
    return challenge;
}

function renderDailyChallenge() {
    const card = document.getElementById('dailyChallengeCard');
    const textEl = document.getElementById('dailyChallengeText');
    const btn = document.getElementById('dailyChallengeDoneBtn');
    if (!card || !textEl || !btn) return;
    const challenge = getDailyChallenge() || "Complete todayâ€™s focus block.";
    textEl.textContent = challenge;
    const done = localStorage.getItem(DAILY_CHALLENGE_DONE_KEY) === 'true';
    btn.disabled = done;
    btn.textContent = done ? "âœ… Completed today" : "âœ… I am done";
    card.style.display = done ? 'none' : 'block';
}

function playApplauseSound() {
    try {
        const audio = document.getElementById('applauseAudio') || new Audio('applause.mp3');
        audio.currentTime = 0;
        audio.volume = 0.9;
        audio.play().catch((e) => console.warn("Audio playback blocked:", e));
        return audio;
    } catch (e) {
        console.warn("Audio playback blocked or unavailable:", e);
        return null;
    }
}

function playClappingVideo() {
    const overlay = document.getElementById('clapOverlay');
    const video = document.getElementById('clapVideo');
    const canvas = document.getElementById('clapCanvas');
    if (!overlay || !video) return;
    overlay.style.display = 'flex';
    requestAnimationFrame(() => overlay.classList.add('show'));
    video.currentTime = 0;
    const ctx = canvas ? canvas.getContext('2d') : null;
    const drawFrame = () => {
        if (!ctx || video.paused || video.ended) return;
        const vw = video.videoWidth || 0;
        const vh = video.videoHeight || 0;
        if (vw && vh) {
            canvas.width = vw;
            canvas.height = vh;
            ctx.drawImage(video, 0, 0, vw, vh);
            const frame = ctx.getImageData(0, 0, vw, vh);
            const data = frame.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                if (g > 100 && g > r * 1.2 && g > b * 1.2) {
                    data[i + 3] = 0;
                }
            }
            ctx.putImageData(frame, 0, 0);
        }
        requestAnimationFrame(drawFrame);
    };
    video.play().then(() => {
        requestAnimationFrame(drawFrame);
    }).catch((e) => console.warn("Video playback blocked:", e));
    video.onended = () => {
        stopClappingVideo();
    };
}

function stopClappingVideo() {
    const overlay = document.getElementById('clapOverlay');
    const video = document.getElementById('clapVideo');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 250);
    }
}

function completeDailyChallenge() {
    localStorage.setItem(DAILY_CHALLENGE_DONE_KEY, 'true');
    renderDailyChallenge();
    const audio = playApplauseSound();
    playClappingVideo();
    if (audio) {
        audio.onended = () => stopClappingVideo();
    }
    showNotification("Challenge completed! ðŸŽ‰", "success");
}

function showDailyChallengeFromChatbot() {
    renderDailyChallenge();
    const card = document.getElementById('dailyChallengeCard');
    if (card) card.style.display = 'block';
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

const statsCompareMessages = [
    "You studied 20% more than average.",
    "Top 10% of users this week.",
    "Your streak is ahead of 70% of students.",
    "Youâ€™re in the top 25% for weekly focus.",
    "You completed more sessions than most this week.",
    "Youâ€™re above average for consistency.",
    "Youâ€™re trending upward â€” keep it going.",
    "Your study time beat last week by 15%.",
    "Youâ€™re keeping a strong pace this week.",
    "Youâ€™re ahead of your weekly goal."
];

function updateStatsCompare() {
    const msg1 = document.getElementById('compareMsg1');
    const msg2 = document.getElementById('compareMsg2');
    if (!msg1 || !msg2) return;

    const idx1 = Math.floor(Math.random() * statsCompareMessages.length);
    let idx2 = Math.floor(Math.random() * statsCompareMessages.length);
    if (idx2 === idx1) idx2 = (idx2 + 1) % statsCompareMessages.length;

    msg1.textContent = statsCompareMessages[idx1];
    msg2.textContent = statsCompareMessages[idx2];
}

let chatbotTimeoutId = null;

function showChatbotGreetingThenChallenge() {
    const bubble = document.getElementById('chatbotBubble');
    if (!bubble) return;
    bubble.classList.remove('challenge');
    bubble.textContent = "Hi! Ready to grind?";
    bubble.classList.add('show');
    setTimeout(() => {
        bubble.classList.remove('show');
        setTimeout(showChallengeBubble, 600);
    }, 2000);
}

function showChallengeBubble() {
    const bubble = document.getElementById('chatbotBubble');
    if (!bubble) return;
    const today = getTodayKeySimple();
    const shownDate = localStorage.getItem(DAILY_CHALLENGE_SHOWN_KEY);
    if (shownDate !== today && localStorage.getItem(DAILY_CHALLENGE_DONE_KEY) !== 'true') {
        const challenge = getDailyChallenge();
        bubble.textContent = `Today's challenge: ${challenge}`;
        bubble.classList.add('challenge');
        localStorage.setItem(DAILY_CHALLENGE_SHOWN_KEY, today);
        showDailyChallengeFromChatbot();
        bubble.classList.add('show');
        setTimeout(() => bubble.classList.remove('show'), 12000);
    }
}

function showChatbotMessage() {
    const bubble = document.getElementById('chatbotBubble');
    if (!bubble) return;
    const today = getTodayKeySimple();
    const shownDate = localStorage.getItem(DAILY_CHALLENGE_SHOWN_KEY);
    let msg = "";
    if (shownDate !== today && localStorage.getItem(DAILY_CHALLENGE_DONE_KEY) !== 'true') {
        const challenge = getDailyChallenge();
        msg = `Today's challenge: ${challenge}`;
        bubble.classList.add('challenge');
        localStorage.setItem(DAILY_CHALLENGE_SHOWN_KEY, today);
        showDailyChallengeFromChatbot();
    } else {
        msg = chatbotMessages[Math.floor(Math.random() * chatbotMessages.length)];
        bubble.classList.remove('challenge');
    }
    bubble.textContent = msg;
    bubble.classList.add('show');
    setTimeout(() => bubble.classList.remove('show'), 12000);
}

function scheduleChatbotMessage() {
    if (chatbotTimeoutId) clearTimeout(chatbotTimeoutId);
    const delay = Math.floor(Math.random() * 8000) + 7000; // 7-15s
    chatbotTimeoutId = setTimeout(() => {
        showChatbotMessage();
        scheduleChatbotMessage();
    }, delay);
}







// ========== PREMIUM THEME REFERRALS ==========
const REFERRAL_KEY = 'studentPremiumReferrals';
const REFERRAL_REFERRER_KEY = 'studentReferralReferrer';
const REFERRAL_CREDITED_KEY_PREFIX = 'studentReferralCredited_';
const REFERRAL_PENDING_KEY = 'studentReferralPending';
const REFERRAL_TARGET = 3;
const REFERRAL_NOTIFS_SEEN_KEY = 'studentReferralNotifsSeen';
const REFERRAL_UNLOCKED_KEY = 'studentReferralUnlocked';
const RAINBOW_UNLOCKED_KEY = 'studentRainbowUnlocked';
const FOREST_UNLOCKED_KEY = 'studentForestUnlocked';

function getReferralCount() {
    return parseInt(localStorage.getItem(REFERRAL_KEY) || '0', 10);
}

function setReferralCount(val) {
    localStorage.setItem(REFERRAL_KEY, String(val));
}

function updateReferralUI() {
    const count = Math.min(getReferralCount(), REFERRAL_TARGET);
    const countEl = document.getElementById('referralCount');
    const countModalEl = document.getElementById('referralCountModal');
    const statusEl = document.getElementById('premiumStatusMsg');
    if (countEl) countEl.textContent = count;
    if (countModalEl) countModalEl.textContent = count;
    if (statusEl) {
        statusEl.textContent = count >= REFERRAL_TARGET
            ? "Premium Theme unlocked! Select it in the theme menu."
            : `Refer Grindly Learn to ${REFERRAL_TARGET} friends to unlock the Premium Theme.`;
    }

    if (count >= REFERRAL_TARGET) {
        const unlocked = localStorage.getItem(REFERRAL_UNLOCKED_KEY) === 'true';
        localStorage.setItem('studentTheme', 'premium');
        document.body.className = 'premium';
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = 'premium';
        if (!unlocked) {
            localStorage.setItem(REFERRAL_UNLOCKED_KEY, 'true');
            showNotification("Premium unlocked! Enjoy the new look âœ¨", "success");
            triggerPremiumSparkles();
        }
    }
}

function copyReferralLink() {
    const link = `https://grindlylearn.netlify.app/studentmode.html?ref=${encodeURIComponent(currentUserId || '')}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification("Referral link copied!", "success");
    }).catch(() => {
        showNotification("Could not copy link. Please copy manually.", "warning");
    });
}

async function markReferral() {
    copyReferralLink();

    if (!currentUserId) {
        showNotification("Referral not available yet. Try again in a moment.", "warning");
        return;
    }

    try {
        const serverCountRaw = await firebaseGet(`users/${currentUserId}/referralCount`);
        const serverCount = Math.min(parseInt(serverCountRaw || 0, 10) || 0, REFERRAL_TARGET);
        const localCount = getReferralCount();

        if (serverCount > localCount) {
            setReferralCount(serverCount);
            updateReferralUI();
            showNotification("Referral counted!", "success");
        } else {
            showNotification("Referral not verified yet. Your friend must open your link and log a study session.", "warning");
        }
    } catch (e) {
        console.warn("Failed to verify referral count:", e);
        showNotification("Could not verify referral yet. Please try again soon.", "warning");
    }
}

function previewPremiumTheme() {
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.dataset.previewTheme = current;
    document.body.className = 'premium';
    showNotification("Previewing Premium Themeâ€¦", "info");
    openReferralModal();
}

function updateRainbowUI() {
    const streak = studyData.streak || 0;
    const unlocked = streak >= 30 || localStorage.getItem(RAINBOW_UNLOCKED_KEY) === 'true';
    const statusEl = document.getElementById('rainbowStatusMsg');
    const countEl = document.getElementById('rainbowStreakCount');
    const badgeEl = document.getElementById('rainbowBadge');
    if (countEl) countEl.textContent = Math.min(streak, 30);
    if (badgeEl) badgeEl.textContent = unlocked ? 'ðŸŒˆ Unlocked' : 'ðŸ”’ Locked';
    if (statusEl) {
        statusEl.textContent = unlocked
            ? "Rainbow Theme unlocked! Select it in the theme menu."
            : "Reach a 30â€‘day streak to unlock the Rainbow Theme.";
    }
}

function openRainbowModal() {
    const modal = document.getElementById('rainbowModal');
    if (modal) modal.classList.add('show');
    const countEl = document.getElementById('rainbowModalCount');
    if (countEl) countEl.textContent = Math.min(studyData.streak || 0, 30);
    const textEl = document.getElementById('rainbowModalText');
    if (textEl) {
        textEl.textContent = (studyData.streak || 0) >= 30
            ? "Rainbow Theme unlocked! Select it in the theme menu."
            : "Hit a 30â€‘day streak to unlock the Rainbow Theme.";
    }
}

function closeRainbowModal() {
    const modal = document.getElementById('rainbowModal');
    if (modal) modal.classList.remove('show');
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = current;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = current;
}

function previewRainbowTheme() {
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = 'rainbow';
    openRainbowModal();
}

function openForestModal() {
    const modal = document.getElementById('forestModal');
    if (modal) modal.classList.add('show');
    const countEl = document.getElementById('forestModalCount');
    if (countEl) countEl.textContent = Math.min(studyData.streak || 0, 7);
    const textEl = document.getElementById('forestModalText');
    if (textEl) {
        textEl.textContent = (studyData.streak || 0) >= 7
            ? "Forest Theme unlocked! Select it in the theme menu."
            : "Hit a 7â€‘day streak to unlock the Forest Theme.";
    }
}

function closeForestModal() {
    const modal = document.getElementById('forestModal');
    if (modal) modal.classList.remove('show');
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = current;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = current;
}

function previewForestTheme() {
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = 'forest';
    openForestModal();
}

function openReferralModal() {
    const modal = document.getElementById('referralModal');
    if (modal) modal.classList.add('show');
    updateReferralUI();
}

function closeReferralModal() {
    const modal = document.getElementById('referralModal');
    if (modal) modal.classList.remove('show');
    const referrals = getReferralCount();
    const previewTheme = document.body.dataset.previewTheme;
    if (previewTheme) {
        document.body.className = previewTheme;
        localStorage.setItem('studentTheme', previewTheme);
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = previewTheme;
        delete document.body.dataset.previewTheme;
        return;
    }
    if (referrals < REFERRAL_TARGET) {
        localStorage.setItem('studentTheme', 'dark');
        document.body.className = 'dark';
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = 'dark';
    }
}

function captureReferralFromUrl() {
    try {
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        if (ref && ref.startsWith('student_') && ref !== currentUserId) {
            localStorage.setItem(REFERRAL_REFERRER_KEY, ref);
            localStorage.setItem(REFERRAL_PENDING_KEY, 'true');
        }
    } catch (e) {
        console.warn("Failed to parse referral URL:", e);
    }
}

function getReferralCreditedKey(referrerId) {
    return `${REFERRAL_CREDITED_KEY_PREFIX}${referrerId}`;
}

function hasStudyActivity() {
    return ((studyData?.studySessions || []).length > 0) ||
        ((studyData?.totalMinutes || 0) > 0) ||
        !!studyData?.lastStudyDate;
}

async function maybeCreditReferral() {
    const referrerId = localStorage.getItem(REFERRAL_REFERRER_KEY);
    if (!referrerId || referrerId === currentUserId) return;

    const creditedKey = getReferralCreditedKey(referrerId);
    const credited = localStorage.getItem(creditedKey);
    if (credited === 'true') return;

    if (!hasStudyActivity()) return;

    if (!database || !currentUser) {
        localStorage.setItem(REFERRAL_PENDING_KEY, 'true');
        return;
    }

    try {
        const path = `users/${referrerId}/referralCount`;
        const next = await firebaseIncrement(path, REFERRAL_TARGET);
        if (next === null || next === undefined) return;
        await firebaseSet(`users/${referrerId}/referralNotifications/${currentUserId}`, {
            name: currentUserName || 'A friend',
            joinedAt: new Date().toISOString()
        });
        localStorage.setItem(creditedKey, 'true');
        localStorage.removeItem(REFERRAL_PENDING_KEY);
    } catch (e) {
        console.warn("Failed to credit referral:", e);
    }
}

function retryPendingReferralCredit() {
    if (localStorage.getItem(REFERRAL_PENDING_KEY) !== 'true') return;
    maybeCreditReferral();
}

function triggerPremiumSparkles() {
    const layer = document.getElementById('premiumSparkleLayer');
    if (!layer) return;

    const sparkleCount = 80;
    for (let i = 0; i < sparkleCount; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'premium-sparkle';
        sparkle.style.left = `${Math.random() * 100}vw`;
        sparkle.style.top = `${50 + Math.random() * 40}vh`;
        sparkle.style.animationDelay = `${Math.random() * 0.4}s`;
        sparkle.style.width = `${4 + Math.random() * 6}px`;
        sparkle.style.height = sparkle.style.width;
        layer.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 3000);
    }
}

async function syncReferralCountFromFirebase() {
    if (!currentUserId) return;
    try {
        const count = await firebaseGet(`users/${currentUserId}/referralCount`);
        if (count !== null && count !== undefined) {
            setReferralCount(parseInt(count, 10) || 0);
        }
    } catch (e) {
        console.warn("Failed to sync referral count:", e);
    }
}

function loadSeenReferralNotifs() {
    try {
        const raw = localStorage.getItem(REFERRAL_NOTIFS_SEEN_KEY);
        return raw ? JSON.parse(raw) : [];
    } catch {
        return [];
    }
}

function saveSeenReferralNotifs(list) {
    try {
        localStorage.setItem(REFERRAL_NOTIFS_SEEN_KEY, JSON.stringify(list));
    } catch (e) {
        console.warn("Failed to save seen referral notifications:", e);
    }
}

function setupReferralNotifications() {
    if (!database || !currentUser) return;
    if (!currentUserId) return;

    const seen = new Set(loadSeenReferralNotifs());
    const ref = database.ref(`users/${currentUserId}/referralNotifications`);
    const countRef = database.ref(`users/${currentUserId}/referralCount`);

    countRef.on('value', (snap) => {
        const val = Math.min(parseInt(snap.val() || 0, 10) || 0, REFERRAL_TARGET);
        setReferralCount(val);
        updateReferralUI();
    });

    ref.on('child_added', (snap) => {
        if (!snap || !snap.key) return;
        if (seen.has(snap.key)) return;

        const data = snap.val() || {};
        const name = data.name || 'A friend';

        showNotification(`${name} is studying because of you!`, "success");
        seen.add(snap.key);
        saveSeenReferralNotifs(Array.from(seen));

        // Keep local count in sync as soon as a referral is detected
        syncReferralCountFromFirebase().then(updateReferralUI);
    });
}

// ========== INSPIRING STORIES DATABASE ==========
const inspiringStories = [
    {
        id: 1,
        name: "Albert Einstein",
        icon: "ðŸ§ ",
        quote: "Imagination is more important than knowledge.",
        story: "Albert Einstein, one of the greatest physicists of all time, faced numerous struggles in his early life. He didn't speak until he was four years old and was considered a slow learner by his teachers. He failed his first entrance exam to the Swiss Federal Polytechnic School. Despite these early challenges, Einstein's curiosity and persistence led him to develop the theory of relativity, which revolutionized our understanding of space, time, and gravity. He was awarded the Nobel Prize in Physics in 1921.",
        struggles: [
            "Late development in speech and learning",
            "Failed university entrance exam",
            "Worked as a patent clerk while developing groundbreaking theories",
            "Faced skepticism from the scientific community"
        ],
        lessons: "Never give up on your curiosity. What others see as weaknesses might be your greatest strengths."
    },
    {
        id: 2,
        name: "Oprah Winfrey",
        icon: "ðŸŽ¤",
        quote: "Turn your wounds into wisdom.",
        story: "Oprah Winfrey overcame a childhood of poverty and abuse to become one of the most influential media personalities in the world. Born into poverty in rural Mississippi, she was molested by relatives and became pregnant at 14 (the child died in infancy). Despite these traumatic experiences, she excelled in school and won a scholarship to Tennessee State University. Her breakthrough came when she moved to Chicago to host a morning talk show, which eventually became 'The Oprah Winfrey Show' - the highest-rated talk show in American history.",
        struggles: [
            "Poverty and childhood abuse",
            "Teen pregnancy and loss of child",
            "Racial and gender discrimination",
            "Battled with weight and self-esteem issues"
        ],
        lessons: "Your past doesn't define your future. Use your experiences to empower yourself and others."
    },
    {
        id: 3,
        name: "Stephen Hawking",
        icon: "ðŸŒŒ",
        quote: "However difficult life may seem, there is always something you can do and succeed at.",
        story: "Stephen Hawking was diagnosed with ALS (amyotrophic lateral sclerosis) at age 21 and given just two years to live. Despite being confined to a wheelchair and losing his ability to speak, he became one of the most brilliant theoretical physicists of our time. Using a speech-generating device, he continued his research on black holes and the origins of the universe. His book 'A Brief History of Time' sold over 25 million copies worldwide, making complex scientific concepts accessible to the general public.",
        struggles: [
            "Diagnosed with ALS at 21",
            "Gradual loss of mobility and speech",
            "Confined to wheelchair for most of his life",
            "Medical complications including pneumonia"
        ],
        lessons: "Physical limitations cannot constrain the human mind. Focus on what you can do, not what you can't."
    },
    {
        id: 4,
        name: "J.K. Rowling",
        icon: "âœï¸",
        quote: "Rock bottom became the solid foundation on which I rebuilt my life.",
        story: "Before publishing Harry Potter, J.K. Rowling was a single mother living on welfare in Edinburgh, Scotland. She wrote the first Harry Potter book in cafes while her baby daughter slept. The manuscript was rejected by 12 publishers before Bloomsbury accepted it. Today, the Harry Potter series has sold over 500 million copies worldwide, making Rowling one of the most successful authors in history. She went from being on government assistance to becoming a billionaire (though she has since donated much of her wealth to charity).",
        struggles: [
            "Single mother living on welfare",
            "Clinical depression and suicidal thoughts",
            "12 publishers rejected Harry Potter",
            "Struggled with poverty for years"
        ],
        lessons: "Failure is not permanent. Persistence can turn your biggest dreams into reality."
    },
    {
        id: 5,
        name: "Thomas Edison",
        icon: "ðŸ’¡",
        quote: "I have not failed. I've just found 10,000 ways that won't work.",
        story: "Thomas Edison, one of America's greatest inventors, was told by his teachers that he was 'too stupid to learn anything.' He was fired from his first two jobs for being 'non-productive.' Despite these setbacks, he went on to hold 1,093 patents, including the phonograph, the motion picture camera, and perhaps most famously, the practical electric light bulb. His invention of the light bulb required thousands of experiments with different materials before finding one that worked.",
        struggles: [
            "Teachers said he was 'too stupid to learn'",
            "Fired from early jobs",
            "Thousands of failed experiments",
            "Lost his hearing as a child"
        ],
        lessons: "Persistence and learning from failure are keys to innovation and success."
    },
    {
        id: 6,
        name: "Malala Yousafzai",
        icon: "ðŸ“š",
        quote: "One child, one teacher, one book, one pen can change the world.",
        story: "Malala Yousafzai was shot in the head by the Taliban at age 15 for advocating for girls' education in Pakistan. She survived the attack and continued her activism, becoming the youngest-ever Nobel Prize laurete at age 17. Her recovery involved multiple surgeries and rehabilitation in the UK. Today, she continues to fight for education rights through the Malala Fund, which supports education programs around the world.",
        struggles: [
            "Shot by Taliban at age 15",
            "Faced death threats for advocating education",
            "Multiple surgeries and long recovery",
            "Forced to leave her home country"
        ],
        lessons: "Courage means standing up for what you believe in, even in the face of extreme danger."
    },
    {
        id: 7,
        name: "Walt Disney",
        icon: "ðŸ°",
        quote: "All our dreams can come true if we have the courage to pursue them.",
        story: "Walt Disney was fired from a newspaper for 'lacking imagination' and 'having no good ideas.' His first animation company went bankrupt. He was turned down 302 times before getting financing for Disney World. Despite these failures, he created Mickey Mouse and built the Disney empire, which has brought joy to millions of people worldwide. His theme parks and films continue to be beloved by generations.",
        struggles: [
            "Fired from newspaper for 'no imagination'",
            "First animation company bankrupt",
            "302 rejections for Disney World financing",
            "Struggled with financial problems"
        ],
        lessons: "Believe in your vision even when others don't. Persistence can create magic."
    },
    {
        id: 8,
        name: "Bethany Hamilton",
        icon: "ðŸ„â€â™€ï¸",
        quote: "Courage doesn't mean you don't get afraid. Courage means you don't let fear stop you.",
        story: "At age 13, professional surfer Bethany Hamilton lost her left arm to a shark attack. Just one month after the attack, she returned to surfing. She went on to win her first national surfing title two years later and became a professional surfer. Her story was made into the movie 'Soul Surfer.' She continues to surf competitively and inspires people worldwide with her determination.",
        struggles: [
            "Lost arm in shark attack at 13",
            "Learned to surf with one arm",
            "Faced physical and emotional challenges",
            "Overcame fear of returning to ocean"
        ],
        lessons: "Life's challenges can become opportunities for growth and inspiration."
    }
];

// ========== DATA PERSISTENCE HELPER ==========
function persistData() {
    try {
        const dataToSave = {
            version: "2.5", // Updated version
            lastSaved: new Date().toISOString(),
            userId: currentUserId,
            userName: currentUserName,
            studyData: studyData,
            tasks: tasks,
            assignments: assignments,
            userClasses: userClasses,
            currentClassCode: currentClassCode,
            selectedClassIndex: selectedClassIndex,
            currentSection: currentSection
        };
        
        // Clean up any undefined arrays before saving
        if (!studyData.studySessions) studyData.studySessions = [];
        if (!studyData.dailyStats) studyData.dailyStats = [];
        if (!studyData.focusScores) studyData.focusScores = [];
        if (!studyData.consistencyScores) studyData.consistencyScores = [];
        
        localStorage.setItem('studentPersistentData', JSON.stringify(dataToSave));
        console.log("ðŸ’¾ Data persisted to localStorage");
    } catch (e) {
        console.error("Error persisting data:", e);
    }
}

function loadPersistedData() {
    try {
        const savedData = localStorage.getItem('studentPersistentData');
        if (savedData) {
            const data = JSON.parse(savedData);
            
            // Check version compatibility
            if (data.version && (data.version === "2.5" || data.version === "2.4" || data.version === "2.3" || data.version === "2.2" || data.version === "2.1" || data.version === "2.0")) {
                console.log("ðŸ“‚ Loading persisted data version:", data.version);
                
                // Load study data with safety checks
                if (data.studyData) {
                    studyData = data.studyData;
                    // Initialize arrays if they don't exist
                    if (!studyData.studySessions) studyData.studySessions = [];
                    if (!studyData.dailyStats) studyData.dailyStats = [];
                    if (!studyData.focusScores) studyData.focusScores = [];
                    if (!studyData.consistencyScores) studyData.consistencyScores = [];
                    if (!studyData.streakHistory) studyData.streakHistory = [];
                    if (!studyData.weeklyPattern) studyData.weeklyPattern = [0, 0, 0, 0, 0, 0, 0];
                    if (!studyData.streakMilestones) studyData.streakMilestones = [3, 7, 14, 30, 60, 90];
                    
                    console.log("ðŸ“Š Loaded study data:", {
                        streak: studyData.streak,
                        hours: studyData.totalStudyHours,
                        sessions: studyData.studySessions?.length || 0,
                        dailyStats: studyData.dailyStats?.length || 0
                    });
                }
                
                // Load tasks with safety check
                if (data.tasks && Array.isArray(data.tasks)) {
                    tasks = data.tasks;
                    console.log("ðŸ“ Loaded tasks:", tasks.length);
                } else {
                    tasks = [];
                }
                
                // Load assignments with safety check
                if (data.assignments && Array.isArray(data.assignments)) {
                    assignments = data.assignments;
                    console.log("ðŸ“š Loaded assignments:", assignments.length);
                } else {
                    assignments = [];
                }
                
                // Load classes with safety check
                if (data.userClasses && Array.isArray(data.userClasses)) {
                    userClasses = data.userClasses;
                    console.log("ðŸ« Loaded classes:", userClasses.length);
                } else {
                    userClasses = [];
                }
                
                // Load current class
                if (data.currentClassCode) {
                    currentClassCode = data.currentClassCode;
                }
                
                if (data.selectedClassIndex !== undefined) {
                    selectedClassIndex = data.selectedClassIndex;
                }
                
                // Load current section
                if (data.currentSection) {
                    currentSection = data.currentSection;
                }
                
                // Load user info
                if (data.userName) {
                    currentUserName = data.userName;
                }
                
                if (data.userId && data.userId.startsWith('student_')) {
                    currentUserId = data.userId;
                    localStorage.setItem('studentUserId', currentUserId);
                    console.log("ðŸ‘¤ Loaded user ID from persisted data:", currentUserId);
                }
                
                console.log("âœ… Persisted data loaded successfully");
                return true;
            } else {
                console.log("âš ï¸ No compatible version found in persisted data");
            }
        }
    } catch (e) {
        console.error("âŒ Error loading persisted data:", e);
    }
    
    console.log("âš ï¸ No persisted data found, using defaults");
    return false;
}

// ========== FIREBASE DATABASE HELPERS ==========
function getDatabaseRef(path) {
    if (!database) return null;
    return database.ref(path);
}

async function firebaseGet(refPath) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated, using localStorage");
        return null;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        const snapshot = await ref.once('value');
        return snapshot.exists() ? snapshot.val() : null;
    } catch (error) {
        console.error(`âŒ Firebase get error at ${refPath}:`, error);
        return null;
    }
}

async function firebaseSet(refPath, data) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated, data saved locally only");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.set(data);
        return true;
    } catch (error) {
        console.error(`âŒ Firebase set error at ${refPath}:`, error);
        return false;
    }
}

async function firebaseUpdate(refPath, data) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated, data saved locally only");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.update(data);
        return true;
    } catch (error) {
        console.error(`âŒ Firebase update error at ${refPath}:`, error);
        return false;
    }
}

async function firebaseIncrement(refPath, maxVal = null) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated");
        return null;
    }

    return new Promise((resolve, reject) => {
        const ref = getDatabaseRef(refPath);
        ref.transaction((current) => {
            const base = parseInt(current || 0, 10) || 0;
            let next = base + 1;
            if (maxVal !== null) next = Math.min(next, maxVal);
            return next;
        }, (error, committed, snapshot) => {
            if (error) return reject(error);
            if (!committed) return resolve(snapshot ? snapshot.val() : null);
            return resolve(snapshot ? snapshot.val() : null);
        });
    });
}

async function firebaseRemove(refPath) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.remove();
        return true;
    } catch (error) {
        console.error(`âŒ Firebase remove error at ${refPath}:`, error);
        return false;
    }
}

// ========== LIVE ACTIVITY FEED (STUDENT -> TEACHER) ==========
async function logLiveActivity(type, payload = {}) {
    if (!database || !currentUser || !currentUserId) return;

    const classCodes = [];
    if (currentClassCode) {
        classCodes.push(currentClassCode);
    } else if (userClasses && userClasses.length > 0) {
        userClasses.forEach(c => c.code && classCodes.push(c.code));
    }

    if (classCodes.length === 0) return;

    const activity = {
        type: type || 'activity',
        studentId: currentUserId,
        studentName: currentUserName || 'Student',
        firebaseUid: currentUser.uid || null,
        createdAt: new Date().toISOString(),
        ...payload
    };

    try {
        await Promise.all(classCodes.map(code => {
            const ref = database.ref(`classActivity/${code}`).push();
            return ref.set(activity);
        }));
    } catch (e) {
        console.warn("Live activity write failed:", e);
    }
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', async function() {
    console.log("ðŸŽ“ Student Mode initializing...");
    
    // FIRST: Load persisted data BEFORE Firebase initialization
    const dataLoaded = loadPersistedData();
    console.log("ðŸ“‚ Data loaded from localStorage:", dataLoaded);
    
    try {
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        auth = firebase.auth();
        
        console.log("âœ… Firebase initialized successfully");
        
        // Check if we have a user ID from persisted data
        if (!currentUserId) {
            const savedUserId = localStorage.getItem('studentUserId');
            if (savedUserId && savedUserId.startsWith('student_')) {
                currentUserId = savedUserId;
                console.log("ðŸ†” Loaded user ID from localStorage:", currentUserId);
            } else {
                currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('studentUserId', currentUserId);
                console.log("ðŸ†• Generated new persistent user ID:", currentUserId);
            }
        }
        
        // Set user name from persisted data or localStorage
        const savedName = localStorage.getItem('studentName');
        if (savedName) {
            currentUserName = savedName;
        }
        
        console.log("ðŸ‘¤ Current user info:", {
            id: currentUserId,
            name: currentUserName,
            streak: studyData.streak,
            hours: studyData.totalStudyHours
        });

        captureReferralFromUrl();
        
        try {
            // Try anonymous authentication
            console.log("ðŸ” Attempting anonymous sign-in...");
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            
            console.log("âœ… Anonymous authentication successful");
            console.log("ðŸ“ Firebase UID:", currentUser.uid);
            console.log("ðŸ“ Our Student ID:", currentUserId);
            
            localStorage.setItem('studentFirebaseUid', currentUser.uid);
            retryPendingReferralCredit();
            
        } catch (authError) {
            console.error("âŒ Anonymous sign-in failed:", authError);
            console.log("âš ï¸ Using offline mode only");
            showNotification("âš ï¸ Working in offline mode. Data saved locally.", "warning");
        }

        await syncReferralCountFromFirebase();
        setupReferralNotifications();
        
        // Initialize the app
        initUI();
        loadAllData();
        setupEventListeners();
        setupAutoSave();
        setupChartAutoRefresh();
        



      


        // Update UI with loaded data
        updateUI();
        updateStreakUI();
        updateAllStatistics();
        
        console.log("ðŸŽ“ Student Mode ready!");
        console.log("ðŸ“Š Loaded data:", {
            streak: studyData.streak,
            hours: studyData.totalStudyHours,
            tasks: tasks.length,
            assignments: assignments.length,
            classes: userClasses.length
        });
        
        setTimeout(() => {
            showNotification(`Welcome back, ${currentUserName}! ðŸ“š Streak: ${studyData.streak} days`, "success");
        }, 1000);
        
    } catch (error) {
        console.error("âŒ Initialization error:", error);
        
        // Fallback: Ensure we have a user ID even if everything fails
        if (!currentUserId) {
            const savedUserId = localStorage.getItem('studentUserId');
            if (savedUserId && savedUserId.startsWith('student_')) {
                currentUserId = savedUserId;
            } else {
                currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('studentUserId', currentUserId);
            }
        }
        
        // Initialize in offline mode
        initUI();
        loadAllData();
        setupEventListeners();
        setupAutoSave();
        setupChartAutoRefresh();
        
        updateUI();
        updateStreakUI();
        updateAllStatistics();
        
        showNotification("âš ï¸ Working in offline mode. Data saved locally.", "warning");
    }
      // Initialize memory wall functions
    console.log("Initializing memory wall system...");
    
    // Check if student memory wall exists
    const studentMemoryWall = document.getElementById('studentMemoryWall');
    if (studentMemoryWall) {
        console.log("Student memory wall system ready");
    }
});

// ========== AUTO-SAVE SYSTEM ==========
function setupAutoSave() {
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            persistData();
        }
    });
    
    window.addEventListener('beforeunload', function() {
        persistData();
    });
    
    setInterval(persistData, 30000);
    
    console.log("ðŸ’¾ Auto-save system initialized");
}

// ========== CHART AUTO-REFRESH ==========
function setupChartAutoRefresh() {
    if (chartRefreshInterval) {
        clearInterval(chartRefreshInterval);
    }
    
    chartRefreshInterval = setInterval(() => {
        if (currentSection === 'statistics') {
            console.log("ðŸ”„ Auto-refreshing charts...");
            refreshChartsSilently();
        }
    }, 300000);
    
    console.log("ðŸ“ˆ Chart auto-refresh system initialized");
}

function refreshChartsSilently() {
    if (currentSection === 'statistics') {
        updateCharts();
        updateSyncStatus("Charts updated", "success");
    }
}

// ========== USER DATA MANAGEMENT ==========
function loadUserData() {
    const savedUserId = localStorage.getItem('studentUserId');
    if (savedUserId && savedUserId.startsWith('student_')) {
        currentUserId = savedUserId;
    } else if (!currentUserId) {
        currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('studentUserId', currentUserId);
    }
    
    currentUserName = localStorage.getItem('studentName') || 'Student';
    
    const savedClasses = localStorage.getItem('studentUserClasses');
    if (savedClasses) {
        try {
            userClasses = JSON.parse(savedClasses);
            console.log(`ðŸ“š Loaded ${userClasses.length} classes from localStorage`);
            
            if (userClasses.length > 0 && !currentClassCode) {
                currentClassCode = userClasses[0].code;
                selectedClassIndex = 0;
            }
        } catch (e) {
            console.error("Error parsing user classes:", e);
            userClasses = [];
        }
    }
    
    const nameField = document.getElementById('studentName');
    if (nameField) nameField.value = currentUserName;
    
    const profileNameField = document.getElementById('profileName');
    if (profileNameField) profileNameField.value = currentUserName;
}

function saveUserData() {
    if (currentUserId) {
        localStorage.setItem('studentUserId', currentUserId);
    }
    
    if (currentUserName) {
        localStorage.setItem('studentName', currentUserName);
    }
    
    if (userClasses.length > 0) {
        localStorage.setItem('studentUserClasses', JSON.stringify(userClasses));
    }
    
    persistData();
    
    console.log("ðŸ’¾ User data saved:", {
        userId: currentUserId,
        name: currentUserName,
        classesCount: userClasses.length
    });
}

// ========== IMPROVED STREAK SYSTEM ==========
function updateStreakUI() {
    const streakNumber = document.getElementById('streakNumber');
    const streakLabel = document.getElementById('streakLabel');
    const streakProgressFill = document.getElementById('streakProgressFill');
    const streakMilestones = document.getElementById('streakMilestones');
    const nextMilestone = document.getElementById('nextMilestone');
    
    if (!streakNumber) return;
    
    streakNumber.textContent = studyData.streak || 0;
    
    let streakEmoji = "ðŸ“ˆ";
    if (studyData.streak >= 30) streakEmoji = "ðŸ†";
    else if (studyData.streak >= 14) streakEmoji = "ðŸ”¥";
    else if (studyData.streak >= 7) streakEmoji = "âœ¨";
    else if (studyData.streak >= 3) streakEmoji = "â­";
    
    streakLabel.textContent = `${streakEmoji} ${studyData.streak || 0} DAY STREAK`;
    
    let nextMilestoneDay = studyData.streakMilestones.find(milestone => milestone > studyData.streak) || studyData.streakMilestones[studyData.streakMilestones.length - 1];
    let currentMilestoneIndex = studyData.streakMilestones.findIndex(milestone => milestone > studyData.streak) - 1;
    
    if (currentMilestoneIndex < 0) {
        currentMilestoneIndex = studyData.streakMilestones.length - 1;
    }
    
    let progressPercentage = 0;
    if (nextMilestoneDay) {
        progressPercentage = ((studyData.streak || 0) / nextMilestoneDay) * 100;
        if (progressPercentage > 100) progressPercentage = 100;
    }
    streakProgressFill.style.width = `${progressPercentage}%`;
    
    let milestonesHTML = '';
    studyData.streakMilestones.forEach((milestone, index) => {
        const isActive = studyData.streak >= milestone;
        const isCurrent = index === currentMilestoneIndex;
        milestonesHTML += `<div class="milestone ${isActive ? 'active' : ''} ${isCurrent ? 'current' : ''}" title="${milestone} days"></div>`;
    });
    streakMilestones.innerHTML = milestonesHTML;
    
    if (nextMilestoneDay) {
        const daysLeft = nextMilestoneDay - (studyData.streak || 0);
        nextMilestone.textContent = `${nextMilestoneDay} days (${daysLeft} to go)`;
    } else {
        nextMilestone.textContent = "Maximum milestone reached! ðŸŽ‰";
    }
    
    updateStreakButton();

    if ((studyData.streak || 0) >= 30) {
        const unlocked = localStorage.getItem(RAINBOW_UNLOCKED_KEY) === 'true';
        if (!unlocked) {
            localStorage.setItem(RAINBOW_UNLOCKED_KEY, 'true');
            showNotification("ðŸŒˆ Rainbow theme unlocked for your 30â€‘day streak!", "success");
        }
    }

    if ((studyData.streak || 0) >= 7) {
        const forestUnlocked = localStorage.getItem(FOREST_UNLOCKED_KEY) === 'true';
        if (!forestUnlocked) {
            localStorage.setItem(FOREST_UNLOCKED_KEY, 'true');
            showNotification("ðŸŒ² Forest theme unlocked for your 7â€‘day streak!", "success");
        }
    }

    updateRainbowUI();
}

function getTodayKey() {
    const today = new Date();
    return today.toDateString();
}

function isConsecutiveDay(lastDateString, currentDateString) {
    if (!lastDateString) return false;
    
    const lastDate = new Date(lastDateString);
    const currentDate = new Date(currentDateString);
    
    const diffTime = Math.abs(currentDate - lastDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays === 1;
}

async function markStudyToday() {
    console.log("ðŸ”¥ markStudyToday() called");
    
    const todayKey = getTodayKey();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayKey = yesterday.toDateString();
    
    if (studyData.lastStudyDate === todayKey) {
        showNotification("You've already marked study for today! Come back tomorrow.", "info");
        updateStreakButton();
        return;
    }
    
    let message = "";
    let messageType = "success";
    
    if (!studyData.lastStudyDate) {
        studyData.streak = 1;
        message = "ðŸŽ‰ First study day! Starting your streak!";
    } else if (studyData.lastStudyDate === yesterdayKey || isConsecutiveDay(studyData.lastStudyDate, todayKey)) {
        studyData.streak = (studyData.streak || 0) + 1;
        message = `ðŸ”¥ Streak continued! Now at ${studyData.streak} days!`;
        
        const milestoneAchieved = studyData.streakMilestones.find(milestone => milestone === studyData.streak);
        if (milestoneAchieved) {
            message = `ðŸ† MILESTONE ACHIEVED! ${milestoneAchieved}-day streak! Keep going!`;
            messageType = "warning";
        }
    } else {
        const lastDate = new Date(studyData.lastStudyDate);
        const today = new Date();
        const diffTime = Math.abs(today - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays > 1) {
            message = `â° You missed ${diffDays - 1} day(s). Starting new streak.`;
            messageType = "warning";
        } else {
            message = "ðŸ”„ Starting new streak today!";
        }
        studyData.streak = 1;
    }
    
    studyData.lastStudyDate = todayKey;
    studyData.totalStudyDays = (studyData.totalStudyDays || 0) + 1;
    
    if (!studyData.streakHistory) studyData.streakHistory = [];
    studyData.streakHistory.push({
        date: todayKey,
        streak: studyData.streak
    });
    
    const dayOfWeek = new Date().getDay();
    if (!studyData.weeklyPattern) studyData.weeklyPattern = [0, 0, 0, 0, 0, 0, 0];
    studyData.weeklyPattern[dayOfWeek] = (studyData.weeklyPattern[dayOfWeek] || 0) + 1;
    
    // Add a study session
    const sessionHours = 1.0; // Default 1 hour for daily streak
    const focusScore = calculateFocusScore();
    const consistencyScore = calculateConsistencyScore();
    
    if (!studyData.studySessions) studyData.studySessions = [];
    studyData.studySessions.push({
        date: new Date().toISOString(),
        hours: sessionHours,
        baseHours: sessionHours,
        bonusHours: 0,
        streak: studyData.streak
    });
    
    // Update daily stats
    if (!studyData.dailyStats) studyData.dailyStats = [];
    const todayStats = studyData.dailyStats.find(s => s.date === todayKey);
    if (todayStats) {
        todayStats.sessions = (todayStats.sessions || 0) + 1;
        todayStats.hours = (todayStats.hours || 0) + sessionHours;
        todayStats.focusScore = focusScore;
        todayStats.consistencyScore = consistencyScore;
    } else {
        studyData.dailyStats.unshift({
            date: todayKey,
            sessions: 1,
            hours: sessionHours,
            focusScore: focusScore,
            consistencyScore: consistencyScore
        });
        
        if (!studyData.focusScores) studyData.focusScores = [];
        studyData.focusScores.unshift({
            date: todayKey,
            score: focusScore
        });
        
        if (!studyData.consistencyScores) studyData.consistencyScores = [];
        studyData.consistencyScores.unshift({
            date: todayKey,
            score: consistencyScore
        });
        updateDailyGoalUI();

        // Keep only last 30 days
        if (studyData.dailyStats.length > 30) {
            studyData.dailyStats = studyData.dailyStats.slice(0, 30);
        }
        if (studyData.focusScores.length > 30) {
            studyData.focusScores = studyData.focusScores.slice(0, 30);
        }
        if (studyData.consistencyScores.length > 30) {
            studyData.consistencyScores = studyData.consistencyScores.slice(0, 30);
        }
        updateDailyGoalUI();

    }
    
    // Update total hours
    studyData.totalMinutes = (studyData.totalMinutes || 0) + sessionHours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);

    await logLiveActivity('streak_reached', {
        streak: studyData.streak || 0
    });
    
    persistData();
    await maybeCreditReferral();
    updateUI();
    updateSidebarStats();
    updateStreakUI();
    updateAllStatistics();
    
    updateSyncStatus("Saving to all classes...", "syncing");
    await saveStudyDataToFirebase();
    
    showNotification(message, messageType);
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        updateSyncStatus("Saved successfully!", "success");
    }, 1500);
}

function updateStreakButton() {
    const streakBtn = document.getElementById('streakButton');
    const streakMessage = document.getElementById('streakMessage');
    const lastStudyDate = document.getElementById('lastStudyDate');
    
    if (!streakBtn) return;
    
    const todayKey = getTodayKey();
    
    if (studyData.lastStudyDate === todayKey) {
        streakBtn.disabled = true;
        streakBtn.innerHTML = '<span>âœ… Already Marked Today</span>';
        streakBtn.style.background = 'var(--success)';
        streakBtn.style.opacity = '0.8';
        
        if (streakMessage) {
            streakMessage.textContent = `Come back tomorrow to continue your ${studyData.streak || 0}-day streak!`;
            streakMessage.style.color = 'white';
        }
        
        if (lastStudyDate) {
            lastStudyDate.textContent = studyData.lastStudyDate || 'Never';
        }
    } else {
        streakBtn.disabled = false;
        streakBtn.innerHTML = '<span>ðŸ”¥ Mark Study Today</span>';
        streakBtn.style.background = '';
        streakBtn.style.opacity = '1';
        
        if (streakMessage) {
            if (studyData.streak > 0) {
                streakMessage.textContent = `Current streak: ${studyData.streak} days. Keep it going!`;
            } else {
                streakMessage.textContent = `Start a new study streak today!`;
            }
            streakMessage.style.color = 'white';
        }
        
        if (lastStudyDate) {
            if (studyData.lastStudyDate) {
                lastStudyDate.textContent = studyData.lastStudyDate;
            } else {
                lastStudyDate.textContent = 'Never';
            }
        }
    }
}


// ========== DAILY GOAL TRACKER ==========

function getTodaySessionsCount() {
    const todayKey = new Date().toDateString();
    if (!studyData.dailyStats) return 0;
    const todayStats = studyData.dailyStats.find(s => s.date === todayKey);
    return todayStats ? (todayStats.sessions || 0) : 0;
}

function updateDailyGoalUI() {
    const count = getTodaySessionsCount();

    const goalText = document.getElementById('dailyGoalText');
    const goalTarget = document.getElementById('dailyGoalTarget');
    const goalCount = document.getElementById('dailyGoalCount');
    const goalFill = document.getElementById('dailyGoalFill');
    const goalMsg = document.getElementById('dailyGoalMessage');
    const celebrateBtn = document.getElementById('celebrateGoalBtn');

    if (!goalText || !goalTarget || !goalCount || !goalFill || !goalMsg || !celebrateBtn) return;

    const target = getDailyGoalTarget();
    goalText.textContent = target;
    goalTarget.textContent = target;
    goalCount.textContent = count;

    const progress = Math.min(100, (count / target) * 100);
    goalFill.style.width = `${progress}%`;

    if (count >= target) {
        goalMsg.textContent = "ðŸŽ‰ Goal achieved! Amazing work!";
        celebrateBtn.style.display = 'block';
        celebrateBtn.classList.add('pulse');
    } else {
goalMsg.textContent = `You're doing great! ${target - count} to go ðŸš€`;

        celebrateBtn.style.display = 'none';
        celebrateBtn.classList.remove('pulse');
            }
}


function maybeCelebrateGoal() {
    const todayKey = new Date().toDateString();
    const storageKey = `dailyGoalCelebrated_${todayKey}`;

    if (localStorage.getItem(storageKey)) return;

    localStorage.setItem(storageKey, "true");
    triggerConfetti();
}

function triggerConfetti() {
    const layer = document.getElementById('confettiLayer');
    if (!layer) return;

    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#22c55e'];

    for (let i = 0; i < 120; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.5) + 's';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.width = (6 + Math.random() * 6) + 'px';
        confetti.style.height = (10 + Math.random() * 8) + 'px';
        confetti.style.animationDuration = (5.5 + Math.random() * 1.5) + 's';

        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 8000);
    }
}

function triggerConfettiBurst() {
    const layer = document.getElementById('confettiLayer');
    if (!layer) return;

    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#22c55e'];

    playCelebrateSound();

    // Big center burst
    for (let i = 0; i < 160; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti burst';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.05) + 's';
        confetti.style.width = (6 + Math.random() * 8) + 'px';
        confetti.style.height = (10 + Math.random() * 10) + 'px';
        confetti.style.animationDuration = (1.6 + Math.random() * 0.8) + 's';
        confetti.style.setProperty('--x', `${(Math.random() * 2 - 1) * 420}px`);
        confetti.style.setProperty('--y', `${(Math.random() * 2 - 1) * 380}px`);
        if (Math.random() < 0.25) confetti.classList.add('sparkle');
        layer.appendChild(confetti);

        setTimeout(() => confetti.remove(), 2500);
    }

    // Side bursts for extra impact
    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti burst';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.1) + 's';
        confetti.style.width = (5 + Math.random() * 7) + 'px';
        confetti.style.height = (8 + Math.random() * 9) + 'px';
        confetti.style.animationDuration = (1.4 + Math.random() * 0.8) + 's';
        confetti.style.left = '15%';
        confetti.style.top = '55%';
        confetti.style.setProperty('--x', `${(Math.random() * 2 - 1) * 260}px`);
        confetti.style.setProperty('--y', `${(Math.random() * 2 - 1) * 260}px`);
        if (Math.random() < 0.3) confetti.classList.add('sparkle');
        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2200);
    }

    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti burst';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.1) + 's';
        confetti.style.width = (5 + Math.random() * 7) + 'px';
        confetti.style.height = (8 + Math.random() * 9) + 'px';
        confetti.style.animationDuration = (1.4 + Math.random() * 0.8) + 's';
        confetti.style.left = '85%';
        confetti.style.top = '55%';
        confetti.style.setProperty('--x', `${(Math.random() * 2 - 1) * 260}px`);
        confetti.style.setProperty('--y', `${(Math.random() * 2 - 1) * 260}px`);
        if (Math.random() < 0.3) confetti.classList.add('sparkle');
        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2200);
    }

    // Light rain after burst
    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (0.1 + Math.random() * 0.4) + 's';
        confetti.style.width = (4 + Math.random() * 6) + 'px';
        confetti.style.height = (7 + Math.random() * 8) + 'px';
        confetti.style.animationDuration = (6 + Math.random() * 2) + 's';
        if (Math.random() < 0.2) confetti.classList.add('sparkle');
        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 8500);
    }
}

function playCelebrateSound() {
    try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const now = ctx.currentTime;

        const master = ctx.createGain();
        master.gain.value = 0.25;
        master.connect(ctx.destination);

        // Burst noise (confetti pop)
        const noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * 0.25, ctx.sampleRate);
        const data = noiseBuffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) {
            data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
        }
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        const noiseGain = ctx.createGain();
        noiseGain.gain.setValueAtTime(0.0, now);
        noiseGain.gain.linearRampToValueAtTime(1.0, now + 0.01);
        noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
        noise.connect(noiseGain);
        noiseGain.connect(master);
        noise.start(now);

        // Low boom
        const boom = ctx.createOscillator();
        const boomGain = ctx.createGain();
        boom.type = 'sine';
        boom.frequency.value = 90;
        boomGain.gain.setValueAtTime(0.0, now);
        boomGain.gain.linearRampToValueAtTime(0.9, now + 0.02);
        boomGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.4);
        boom.connect(boomGain);
        boomGain.connect(master);
        boom.start(now);
        boom.stop(now + 0.45);

        const tones = [
            { freq: 523.25, time: 0.0 },  // C5
            { freq: 659.25, time: 0.08 }, // E5
            { freq: 783.99, time: 0.16 }, // G5
            { freq: 1046.5, time: 0.24 }  // C6
        ];

        tones.forEach(t => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = t.freq;
            gain.gain.setValueAtTime(0, now + t.time);
            gain.gain.linearRampToValueAtTime(0.4, now + t.time + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + t.time + 0.22);
            osc.connect(gain);
            gain.connect(master);
            osc.start(now + t.time);
            osc.stop(now + t.time + 0.26);
        });

        setTimeout(() => ctx.close(), 1200);
    } catch (e) {
        console.warn("Audio playback blocked or unavailable:", e);
    }
}


const DAILY_GOAL_KEY = 'dailyGoalTarget';

function getDailyGoalTarget() {
    return parseInt(localStorage.getItem(DAILY_GOAL_KEY) || '3', 10);
}

function setDailyGoalTarget(value) {
    localStorage.setItem(DAILY_GOAL_KEY, String(value));
}

function initDailyGoalInput() {
    const input = document.getElementById('dailyGoalInput');
    if (!input) return;

    input.value = getDailyGoalTarget();

    input.addEventListener('change', () => {
        let val = parseInt(input.value, 10);
        if (!val || val < 1) val = 1;
        if (val > 20) val = 20;

        input.value = val;
        setDailyGoalTarget(val);
        updateDailyGoalUI();
        showNotification(`Daily goal set to ${val} sessions`, "success");
    });
}

// ========== STUDY DATA MANAGEMENT ==========
function loadStudyData() {
    updateUI();
    updateStreakUI();
}

async function saveStudyDataToFirebase() {
    if (!currentUserId || !currentUser) return;
    
    const studentData = {
        name: currentUserName,
        userId: currentUserId,
        firebaseUid: currentUser.uid,
        streak: studyData.streak || 0,
        totalMinutes: studyData.totalMinutes || 0,
        totalStudyHours: (studyData.totalMinutes / 60).toFixed(1),
        points: Math.floor(studyData.totalMinutes / 60) * 100 || 0,
        lastActive: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        isStudentEntry: true,
        isTeacherAccount: false,
        isSameBrowserIssue: false
    };
    
    console.log(`ðŸ’¾ Saving student data. Student ID: ${currentUserId}, Firebase UID: ${currentUser.uid}`);
    
    for (const classInfo of userClasses) {
        try {
            await firebaseSet(`classes/${classInfo.code}/students/${currentUserId}`, studentData);
            console.log(`âœ… Updated data in class: ${classInfo.code} with student ID: ${currentUserId}`);
            
        } catch (error) {
            console.error(`Error updating class ${classInfo.code}:`, error);
            
            try {
                await firebaseSet(`classStudents/${classInfo.code}/${currentUserId}`, studentData);
                console.log(`âœ… Updated data in classStudents: ${classInfo.code}`);
            } catch (altError) {
                console.error(`Both paths failed for ${classInfo.code}:`, altError);
            }
        }
    }
}

async function addStudyHours() {
    const input = document.getElementById('hoursInput');
    if (!input) {
        showNotification("Study hours input not found", "error");
        return;
    }
    
    const hours = parseFloat(input.value);
    
    if (!hours || hours <= 0) {
        showNotification("Please enter valid study hours (minimum 0.25)", "error");
        return;
    }
    
    const addButton = event.target;
    const originalText = addButton.innerHTML;
    
    addButton.innerHTML = 'â³ Saving...';
    addButton.disabled = true;
    
    const baseHours = hours;
    const streakBonus = (studyData.streak || 0) > 7 ? 0.2 : (studyData.streak || 0) > 3 ? 0.1 : 0;
    const bonusHours = baseHours * streakBonus;
    const totalHours = baseHours + bonusHours;
    
    studyData.totalMinutes = (studyData.totalMinutes || 0) + totalHours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);

    await logLiveActivity('timer_started', {
        duration: Math.round(totalHours * 60)
    });
    
    if (!studyData.studySessions) studyData.studySessions = [];
    studyData.studySessions.push({
        date: new Date().toISOString(),
        hours: totalHours,
        baseHours: baseHours,
        bonusHours: bonusHours,
        streak: studyData.streak || 0
    });
    
    // Update daily stats
    const todayKey = getTodayKey();
    if (!studyData.dailyStats) studyData.dailyStats = [];
    const todayStats = studyData.dailyStats.find(s => s.date === todayKey);
    const focusScore = calculateFocusScore();
    const consistencyScore = calculateConsistencyScore();
    
    if (todayStats) {
        todayStats.sessions = (todayStats.sessions || 0) + 1;
        todayStats.hours = (todayStats.hours || 0) + totalHours;
        todayStats.focusScore = focusScore;
        todayStats.consistencyScore = consistencyScore;
    } else {
        studyData.dailyStats.unshift({
            date: todayKey,
            sessions: 1,
            hours: totalHours,
            focusScore: focusScore,
            consistencyScore: consistencyScore
        });
        
        if (!studyData.focusScores) studyData.focusScores = [];
        studyData.focusScores.unshift({
            date: todayKey,
            score: focusScore
        });
        
        if (!studyData.consistencyScores) studyData.consistencyScores = [];
        studyData.consistencyScores.unshift({
            date: todayKey,
            score: consistencyScore
        });
        
        // Keep only last 30 days
        if (studyData.dailyStats.length > 30) {
            studyData.dailyStats = studyData.dailyStats.slice(0, 30);
        }
        if (studyData.focusScores.length > 30) {
            studyData.focusScores = studyData.focusScores.slice(0, 30);
        }
        if (studyData.consistencyScores.length > 30) {
            studyData.consistencyScores = studyData.consistencyScores.slice(0, 30);
        }
    }
    
    persistData();
    await maybeCreditReferral();
    updateUI();
    updateSidebarStats();
    updateAllStatistics();
    input.value = "";
    
    updateSyncStatus("Syncing to all classes...", "syncing");
    await saveStudyDataToFirebase();
    
    setTimeout(() => {
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    }, 1000);
    
    let message = `â° Added ${baseHours.toFixed(1)} study hours!`;
    if (bonusHours > 0) {
        message += ` (+${bonusHours.toFixed(1)} streak bonus)`;
    }
    message += ` Total: ${studyData.totalStudyHours} hours`;
    message += ` | Streak: ${studyData.streak || 0} days ðŸ”¥`;
    
    showNotification(message, "success");
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        updateSyncStatus("Saved to all classes!", "success");
    }, 1500);
    updateDailyGoalUI();

}

// ========== TASK MANAGEMENT WITH PRIORITIES ==========
function addTask() {
    let taskInput = document.getElementById('taskInput');
    if (!taskInput) taskInput = document.getElementById('taskInputFull');
    
    const text = taskInput.value.trim();
    
    if (!text) {
        showNotification("Please enter a task", "error");
        return;
    }
    
    const task = {
        id: Date.now().toString(),
        text: text,
        completed: false,
        createdAt: new Date().toISOString(),
        priority: selectedPriority,
        completedAt: null
    };
    
    tasks.unshift(task);
    taskInput.value = '';
    
    saveTasks();
    renderTasks();
    renderDashboardTasks();
    updateAllStatistics();
    
    const priorityText = {
        'urgent': 'ðŸ”´ Urgent',
        'not-urgent': 'ðŸŸ¡ Not Urgent',
        'optional': 'âšª Optional'
    }[selectedPriority];
    
    showNotification(`Task added as ${priorityText}!`, "success");
}

function selectPriority(priority) {
    selectedPriority = priority;
    
    document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.priority === priority) {
            option.classList.add('active');
        }
    });
}

function getPriorityClass(priority) {
    switch(priority) {
        case 'urgent': return 'urgent';
        case 'not-urgent': return 'not-urgent';
        case 'optional': return 'optional';
        default: return '';
    }
}

function getPriorityBadge(priority) {
    switch(priority) {
        case 'urgent': return '<span class="priority-badge priority-urgent">ðŸ”´ Urgent</span>';
        case 'not-urgent': return '<span class="priority-badge priority-not-urgent">ðŸŸ¡ Not Urgent</span>';
        case 'optional': return '<span class="priority-badge priority-optional">âšª Optional</span>';
        default: return '';
    }
}

function toggleTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;
        saveTasks();
        renderTasks();
        renderDashboardTasks();
        updateAllStatistics();
        
        if (task.completed) {
            showNotification("Task completed! âœ…", "success");
        }
    }
}

function deleteTask(taskId) {
    tasks = tasks.filter(t => t.id !== taskId);
    saveTasks();
    renderTasks();
    renderDashboardTasks();
    updateAllStatistics();
    showNotification("Task deleted", "info");
}

function saveTasks() {
    persistData();
}

function renderTasks() {
    const fullTaskList = document.getElementById('fullTaskList');
    if (!fullTaskList) return;
    
    let filteredTasks = tasks;
    
    switch(currentTaskFilter) {
        case 'urgent':
            filteredTasks = tasks.filter(t => t.priority === 'urgent');
            break;
        case 'not-urgent':
            filteredTasks = tasks.filter(t => t.priority === 'not-urgent');
            break;
        case 'optional':
            filteredTasks = tasks.filter(t => t.priority === 'optional');
            break;
        case 'active':
            filteredTasks = tasks.filter(t => !t.completed);
            break;
        case 'completed':
            filteredTasks = tasks.filter(t => t.completed);
            break;
        case 'all':
        default:
            filteredTasks = tasks;
    }
    
    if (filteredTasks.length === 0) {
        fullTaskList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“</div>
                <div class="empty-state-title">No tasks found</div>
                <div class="empty-state-description">
                    ${currentTaskFilter === 'all' ? 'Add your first task above!' : 
                      currentTaskFilter === 'active' ? 'All tasks are completed! ðŸŽ‰' : 
                      currentTaskFilter === 'completed' ? 'No completed tasks yet' :
                      `No ${currentTaskFilter.replace('-', ' ')} tasks`}
                </div>
            </div>
        `;
    } else {
        fullTaskList.innerHTML = filteredTasks.map((task, index) => `
            <li class="task-item ${task.completed ? 'completed' : ''} ${getPriorityClass(task.priority)}">
                <div class="task-text" onclick="toggleTask('${task.id}')">
                    ${task.text}
                    <div style="margin-top: var(--spacing-xs);">
                        ${getPriorityBadge(task.priority)}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn ${task.completed ? 'btn-success' : 'btn-warning'}" 
                            onclick="toggleTask('${task.id}')">
                        ${task.completed ? 'âœ… Completed' : 'â¬œ Mark Done'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteTask('${task.id}')">ðŸ—‘ï¸ Delete</button>
                </div>
            </li>
        `).join('');
    }
    
    updateTaskStats();
}

function renderDashboardTasks() {
    const taskList = document.getElementById('taskList');
    if (!taskList) return;
    
    const urgentTasks = tasks.filter(t => t.priority === 'urgent' && !t.completed);
    const notUrgentTasks = tasks.filter(t => t.priority === 'not-urgent' && !t.completed);
    const optionalTasks = tasks.filter(t => t.priority === 'optional' && !t.completed);
    
    const recentTasks = [...urgentTasks, ...notUrgentTasks, ...optionalTasks].slice(0, 5);
    
    if (recentTasks.length === 0) {
        taskList.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">ðŸ“</div>
                <div class="empty-state-description">No tasks yet. Add your first task!</div>
            </div>
        `;
    } else {
        taskList.innerHTML = recentTasks.map(task => `
            <li class="task-item ${getPriorityClass(task.priority)}" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                <div class="task-text" onclick="toggleTask('${task.id}')" style="font-size: 1rem;">
                    ${task.text}
                    <div style="margin-top: var(--spacing-xs); font-size: 0.75rem;">
                        ${getPriorityBadge(task.priority)}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn ${task.completed ? 'btn-success' : 'btn-secondary'}" 
                            onclick="toggleTask('${task.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        ${task.completed ? 'âœ…' : 'â¬œ'}
                    </button>
                </div>
            </li>
        `).join('');
    }
}

function filterTasks(filter) {
    currentTaskFilter = filter;
    renderTasks();
}

function updateTaskStats() {
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.completed).length;
    const pendingTasks = totalTasks - completedTasks;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    const totalTasksEl = document.getElementById('totalTasks');
    const pendingTasksEl = document.getElementById('pendingTasks');
    const completedTasksEl = document.getElementById('completedTasks');
    const completionRateEl = document.getElementById('completionRate');
    
    if (totalTasksEl) totalTasksEl.textContent = totalTasks;
    if (pendingTasksEl) pendingTasksEl.textContent = pendingTasks;
    if (completedTasksEl) completedTasksEl.textContent = completedTasks;
    if (completionRateEl) completionRateEl.textContent = `${completionRate}%`;
}

function clearCompletedTasks() {
    if (tasks.length === 0) {
        showNotification("No tasks to clear", "info");
        return;
    }
    
    const completedCount = tasks.filter(t => t.completed).length;
    if (completedCount === 0) {
        showNotification("No completed tasks to clear", "info");
        return;
    }
    
    if (confirm(`Clear ${completedCount} completed task${completedCount === 1 ? '' : 's'}?`)) {
        tasks = tasks.filter(t => !t.completed);
        saveTasks();
        renderTasks();
        renderDashboardTasks();
        updateAllStatistics();
        showNotification(`Cleared ${completedCount} completed task${completedCount === 1 ? '' : 's'}`, "success");
    }
}

// ========== ASSIGNMENT MANAGEMENT ==========
function loadAssignments() {
    renderAssignments();
    renderDashboardAssignments();
}

function addAssignment() {
    const name = document.getElementById('assignmentName').value.trim();
    const subject = document.getElementById('assignmentSubject').value.trim();
    const dueDate = document.getElementById('assignmentDueDate').value;
    const description = document.getElementById('assignmentDescription').value.trim();
    
    if (!name || !subject || !dueDate) {
        showNotification("Please fill all required fields", "error");
        return;
    }
    
    const assignment = {
        id: Date.now().toString(),
        name,
        subject,
        dueDate,
        description,
        createdAt: new Date().toISOString(),
        completed: false
    };
    
    assignments.unshift(assignment);
    saveAssignments();
    renderAssignments();
    renderDashboardAssignments();
    
    showNotification("Assignment added!", "success");
    hideAssignmentForm();
}

function renderAssignments() {
    const fullAssignmentList = document.getElementById('fullAssignmentList');
    if (!fullAssignmentList) return;
    
    if (assignments.length === 0) {
        fullAssignmentList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“š</div>
                <div class="empty-state-title">No assignments yet</div>
                <div class="empty-state-description">Add your first assignment!</div>
            </div>
        `;
    } else {
        fullAssignmentList.innerHTML = assignments.map((assignment, index) => {
            const dueDate = new Date(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'normal';
            if (diffDays < 0) urgencyClass = 'overdue';
            else if (diffDays === 0) urgencyClass = 'today';
            else if (diffDays <= 3) urgencyClass = 'due-soon';
            
            return `
                <div class="assignment-item ${assignment.completed ? 'completed' : ''}">
                    <div class="assignment-header">
                        <div class="assignment-title">${assignment.name}</div>
                        <div class="assignment-date ${urgencyClass}">
                            ${urgencyClass === 'overdue' ? 'âš ï¸ Overdue' : 
                              urgencyClass === 'today' ? 'ðŸ”¥ Due Today' : 
                              urgencyClass === 'due-soon' ? 'â° Due Soon' : `ðŸ“… ${dueDate.toLocaleDateString()}`}
                        </div>
                    </div>
                    <div class="assignment-content">
                        <div style="color: var(--text-muted); margin-bottom: var(--spacing-sm);">
                            ðŸ“š ${assignment.subject}
                        </div>
                        ${assignment.description ? `<p>${assignment.description}</p>` : ''}
                    </div>
                    <div class="assignment-actions">
                        <button class="btn ${assignment.completed ? 'btn-success' : 'btn-secondary'}" onclick="toggleAssignment('${assignment.id}')">
                            ${assignment.completed ? 'âœ… Completed' : 'â¬œ Mark Complete'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteAssignment('${assignment.id}')">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function renderDashboardAssignments() {
    const assignmentList = document.getElementById('assignmentList');
    if (!assignmentList) return;
    
    const recentAssignments = assignments.slice(0, 3);
    
    if (recentAssignments.length === 0) {
        assignmentList.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">ðŸ“š</div>
                <div class="empty-state-description">No assignments yet</div>
            </div>
        `;
    } else {
        assignmentList.innerHTML = recentAssignments.map(assignment => {
            const dueDate = new Date(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'normal';
            if (diffDays < 0) urgencyClass = 'overdue';
            else if (diffDays === 0) urgencyClass = 'today';
            else if (diffDays <= 3) urgencyClass = 'due-soon';
            
            return `
                <div class="assignment-item" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                    <div class="assignment-header">
                        <div class="assignment-title" style="font-size: 1rem;">${assignment.name}</div>
                        <div class="assignment-date" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                            ${urgencyClass === 'overdue' ? 'âš ï¸' : 
                              urgencyClass === 'today' ? 'ðŸ”¥' : 
                              urgencyClass === 'due-soon' ? 'â°' : 'ðŸ“…'}
                        </div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                        ðŸ“š ${assignment.subject}
                    </div>
                    <div style="margin-top: var(--spacing-sm);">
                        <button class="btn ${assignment.completed ? 'btn-success' : 'btn-secondary'}" 
                                onclick="toggleAssignment('${assignment.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ${assignment.completed ? 'âœ…' : 'â¬œ'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function toggleAssignment(assignmentId) {
    const assignment = assignments.find(a => a.id === assignmentId);
    if (assignment) {
        assignment.completed = !assignment.completed;
        saveAssignments();
        renderAssignments();
        renderDashboardAssignments();
        if (assignment.completed) {
            logLiveActivity('assignment_completed', {
                assignmentTitle: assignment.name || 'Assignment'
            });
        }
        showNotification(assignment.completed ? "Assignment marked as completed!" : "Assignment marked as incomplete", "success");
    }
}

function deleteAssignment(assignmentId) {
    assignments = assignments.filter(a => a.id !== assignmentId);
    saveAssignments();
    renderAssignments();
    renderDashboardAssignments();
    showNotification("Assignment deleted", "info");
}

function saveAssignments() {
    persistData();
}

function showAssignmentForm() {
    const form = document.getElementById('assignmentForm');
    if (form) form.style.display = 'block';
}

function hideAssignmentForm() {
    const form = document.getElementById('assignmentForm');
    if (form) form.style.display = 'none';
}

// ========== UPDATED STATISTICS SECTION ==========
async function markStudySession() {
    const today = new Date().toDateString();
    
    const hours = parseFloat(prompt("How many hours did you study? (e.g., 2.5)", "1"));
    
    if (isNaN(hours) || hours <= 0) {
        showNotification("Please enter a valid number of hours", "error");
        return;
    }
    
    const focusScore = Math.min(100, Math.floor(Math.random() * 30) + 70);
    const consistencyScore = calculateConsistencyScore();
    
    // Initialize arrays if they don't exist
    if (!studyData.studySessions) studyData.studySessions = [];
    if (!studyData.dailyStats) studyData.dailyStats = [];
    
    // Update study sessions
    studyData.studySessions.unshift({
        date: new Date().toISOString(),
        hours: hours,
        baseHours: hours,
        bonusHours: 0,
        streak: studyData.streak || 0
    });
    
    // Update daily stats
    const todayStats = studyData.dailyStats.find(s => s.date === today);
    if (todayStats) {
        todayStats.sessions = (todayStats.sessions || 0) + 1;
        todayStats.hours = (todayStats.hours || 0) + hours;
        todayStats.focusScore = focusScore;
        todayStats.consistencyScore = consistencyScore;
    } else {
        studyData.dailyStats.unshift({
            date: today,
            sessions: 1,
            hours: hours,
            focusScore: focusScore,
            consistencyScore: consistencyScore
        });
        
        if (studyData.dailyStats.length > 30) {
            studyData.dailyStats = studyData.dailyStats.slice(0, 30);
        }
    }
    
    // Update total hours
    studyData.totalMinutes = (studyData.totalMinutes || 0) + hours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);

    await logLiveActivity('timer_started', {
        duration: Math.round(hours * 60)
    });
    
    persistData();
    await maybeCreditReferral();
    updateCharts();
    updateAllStatistics();
    updateDailyGoalUI();

    showNotification(`Study session recorded! ${hours} hours studied.`, "success");
}

function calculateConsistencyScore() {
    if (!studyData.dailyStats || studyData.dailyStats.length === 0) return 100;
    
    const last7Days = studyData.dailyStats.slice(0, 7);
    const daysStudied = last7Days.length;
    const totalDays = Math.min(7, studyData.dailyStats.length);
    
    return Math.min(100, Math.floor((daysStudied / totalDays) * 100));
}

function updateCharts() {
    // Destroy existing charts
    if (hoursChart) hoursChart.destroy();
    if (tasksChart) tasksChart.destroy();
    if (weeklyChart) weeklyChart.destroy();
    if (assignmentsChart) assignmentsChart.destroy();
    if (streakChart) streakChart.destroy();
    if (focusChart) focusChart.destroy();
    
    updateOverviewCards();
    updatePerformanceMetrics();
    updateDetailedStats();
    createHoursChart();
    createTasksChart();
    createWeeklyChart();
    createAssignmentsChart();
    createStreakChart();
    createFocusChart();
}

function updateOverviewCards() {
    document.getElementById('overviewStreak').textContent = studyData.streak || 0;
    document.getElementById('overviewHours').textContent = parseFloat(studyData.totalStudyHours || 0).toFixed(1);
    document.getElementById('overviewTasks').textContent = tasks.filter(t => t.completed).length;
    document.getElementById('overviewFocus').textContent = `${calculateFocusScore()}%`;
    
    updateTrends();
}

function updateTrends() {
    if (!studyData.dailyStats || studyData.dailyStats.length < 2) return;
    
    const today = studyData.dailyStats[0] || {};
    const yesterday = studyData.dailyStats[1] || {};
    
    // Update streak trend
    const streakTrend = document.getElementById('streakTrend');
    const streakDiff = (studyData.streak || 0) - (yesterday.streak || 0);
    updateTrendElement(streakTrend, streakDiff, "days streak");
    
    // Update hours trend
    const hoursTrend = document.getElementById('hoursTrend');
    const hoursDiff = (today.hours || 0) - (yesterday.hours || 0);
    updateTrendElement(hoursTrend, hoursDiff, "hours");
    
    // Update tasks trend
    const tasksTrend = document.getElementById('tasksTrend');
    const todayCompleted = tasks.filter(t => {
        if (!t.completedAt) return false;
        const completedDate = new Date(t.completedAt).toDateString();
        return completedDate === new Date().toDateString();
    }).length;
    const yesterdayCompleted = tasks.filter(t => {
        if (!t.completedAt) return false;
        const completedDate = new Date(t.completedAt).toDateString();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        return completedDate === yesterday.toDateString();
    }).length;
    const tasksDiff = todayCompleted - yesterdayCompleted;
    updateTrendElement(tasksTrend, tasksDiff, "tasks");
    
    // Update focus trend
    const focusTrend = document.getElementById('focusTrend');
    const focusDiff = (today.focusScore || calculateFocusScore()) - (yesterday.focusScore || calculateFocusScore());
    updateTrendElement(focusTrend, focusDiff, "% focus");
}

function updateTrendElement(element, diff, label) {
    if (!element) return;
    
    let trendClass = 'neutral';
    let icon = 'âž¡ï¸';
    let text = 'No change';
    
    if (diff > 0) {
        trendClass = 'up';
        icon = 'ðŸ“ˆ';
        text = `+${diff} ${label}`;
    } else if (diff < 0) {
        trendClass = 'down';
        icon = 'ðŸ“‰';
        text = `${diff} ${label}`;
    }
    
    element.className = `stats-overview-trend ${trendClass}`;
    element.innerHTML = `<span>${icon}</span><span>${text}</span>`;
}

function updatePerformanceMetrics() {
    // Study sessions this week
    const thisWeekSessions = studyData.dailyStats ? 
        studyData.dailyStats.slice(0, 7).reduce((sum, day) => sum + (day.sessions || 0), 0) : 0;
    document.getElementById('metricSessions').textContent = thisWeekSessions;
    
    // Average daily hours
    const avgDailyHours = studyData.totalStudyDays > 0 ? 
        (parseFloat(studyData.totalStudyHours || 0) / studyData.totalStudyDays).toFixed(1) : 0;
    document.getElementById('metricAvgHours').textContent = `${avgDailyHours}h`;
    
    // Longest streak
    const longestStreak = studyData.streakHistory ? 
        Math.max(...studyData.streakHistory.map(s => s.streak || 0), studyData.streak || 0) : studyData.streak || 0;
    document.getElementById('metricLongestStreak').textContent = longestStreak;
    
    // Consistency score
    const consistencyScore = calculateConsistencyScore();
    document.getElementById('metricConsistency').textContent = `${consistencyScore}%`;
}

function updateDetailedStats() {
    // Productivity Metrics
    document.getElementById('detailTotalHours').textContent = parseFloat(studyData.totalStudyHours || 0).toFixed(1);
    document.getElementById('detailTotalSessions').textContent = studyData.studySessions ? studyData.studySessions.length : 0;
    
    const avgSessionLength = studyData.studySessions && studyData.studySessions.length > 0 ? 
        (parseFloat(studyData.totalStudyHours || 0) / studyData.studySessions.length).toFixed(1) : 0;
    document.getElementById('detailAvgSession').textContent = `${avgSessionLength}h`;
    
    const longestSession = studyData.studySessions && studyData.studySessions.length > 0 ? 
        Math.max(...studyData.studySessions.map(s => s.hours || 0)) : 0;
    document.getElementById('detailLongestSession').textContent = `${longestSession.toFixed(1)}h`;
    
    // Task Metrics
    document.getElementById('detailTotalTasks').textContent = tasks.length;
    document.getElementById('detailCompletedTasks').textContent = tasks.filter(t => t.completed).length;
    
    const completionRate = tasks.length > 0 ? 
        Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0;
    document.getElementById('detailCompletionRate').textContent = `${completionRate}%`;
    
    document.getElementById('detailActiveTasks').textContent = tasks.filter(t => !t.completed).length;
    
    // Achievement Metrics
    document.getElementById('detailCurrentStreak').textContent = studyData.streak || 0;
    
    const longestStreak = studyData.streakHistory ? 
        Math.max(...studyData.streakHistory.map(s => s.streak || 0), studyData.streak || 0) : studyData.streak || 0;
    document.getElementById('detailLongestStreak').textContent = longestStreak;
    
    document.getElementById('detailFocusScore').textContent = `${calculateFocusScore()}%`;
    document.getElementById('detailConsistencyScore').textContent = `${calculateConsistencyScore()}%`;
}

function createHoursChart() {
    const ctx = document.getElementById('hoursChart');
    if (!ctx) return;
    
    const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    if (!studyData.studySessions) studyData.studySessions = [];
    
    const dailyHours = last7Days.map(day => {
        const daySessions = studyData.studySessions.filter(s => {
            const sessionDate = new Date(s.date).toDateString();
            return sessionDate === day;
        });
        return daySessions.reduce((sum, session) => sum + (session.hours || 0), 0);
    });
    
    // Theme-adaptive colors
    const barColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
    const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-dark');
    
    hoursChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            }),
            datasets: [{
                label: 'Study Hours',
                data: dailyHours,
                backgroundColor: barColor + '80', // 50% opacity
                borderColor: borderColor,
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Hours',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('hoursLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${barColor};"></div>
                <span>Daily Study Hours</span>
            </div>
        `;
    }
}

function createTasksChart() {
    const ctx = document.getElementById('tasksChart');
    if (!ctx) return;
    
    const completedTasks = tasks.filter(t => t.completed).length;
    const pendingTasks = tasks.filter(t => !t.completed).length;
    
    // Theme-adaptive colors
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success');
    const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning');
    
    tasksChart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending'],
            datasets: [{
                data: [completedTasks, pendingTasks],
                backgroundColor: [
                    successColor + '80',
                    warningColor + '80'
                ],
                borderColor: [
                    successColor,
                    warningColor
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 11
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('tasksLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${successColor};"></div>
                <span>Completed Tasks</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: ${warningColor};"></div>
                <span>Pending Tasks</span>
            </div>
        `;
    }
}

function createWeeklyChart() {
    const ctx = document.getElementById('weeklyChart');
    if (!ctx) return;
    
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    if (!studyData.weeklyPattern) studyData.weeklyPattern = [0, 0, 0, 0, 0, 0, 0];
    
    // Theme-adaptive colors
    const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--purple');
    const fillColor = lineColor + '20';
    
    weeklyChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: daysOfWeek,
            datasets: [{
                label: 'Study Sessions',
                data: studyData.weeklyPattern,
                backgroundColor: fillColor,
                borderColor: lineColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Sessions',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('weeklyLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${lineColor};"></div>
                <span>Weekly Study Pattern</span>
            </div>
        `;
    }
}

function createAssignmentsChart() {
    const ctx = document.getElementById('assignmentsChart');
    if (!ctx) return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const overdue = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        return dueDate < today && !a.completed;
    }).length;
    
    const dueToday = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return dueDate.getTime() === today.getTime() && !a.completed;
    }).length;
    
    const dueSoon = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 0 && diffDays <= 3 && !a.completed;
    }).length;
    
    const completed = assignments.filter(a => a.completed).length;
    const future = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 3 && !a.completed;
    }).length;
    
    // Theme-adaptive colors
    const colors = [
        getComputedStyle(document.documentElement).getPropertyValue('--danger'),
        getComputedStyle(document.documentElement).getPropertyValue('--warning'),
        getComputedStyle(document.documentElement).getPropertyValue('--info'),
        getComputedStyle(document.documentElement).getPropertyValue('--success'),
        getComputedStyle(document.documentElement).getPropertyValue('--text-muted')
    ];
    
    assignmentsChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Overdue', 'Due Today', 'Due Soon', 'Completed', 'Future'],
            datasets: [{
                data: [overdue, dueToday, dueSoon, completed, future],
                backgroundColor: colors.map(color => color + '80'),
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 11
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('assignmentsLegend');
    if (legend) {
        legend.innerHTML = colors.map((color, index) => {
            const labels = ['Overdue', 'Due Today', 'Due Soon', 'Completed', 'Future'];
            return `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${color};"></div>
                    <span>${labels[index]}</span>
                </div>
            `;
        }).join('');
    }
}

function createStreakChart() {
    const ctx = document.getElementById('streakChart');
    if (!ctx) return;
    
    const last14Days = Array.from({length: 14}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    if (!studyData.streakHistory) studyData.streakHistory = [];
    
    const streakData = last14Days.map(day => {
        const streakEntry = studyData.streakHistory.find(s => s.date === day);
        return streakEntry ? streakEntry.streak : 0;
    });
    
    // Theme-adaptive colors
    const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--warning');
    const fillColor = lineColor + '20';
    
    streakChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: last14Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Streak Days',
                data: streakData,
                backgroundColor: fillColor,
                borderColor: lineColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: lineColor,
                pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Days',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('streakLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${lineColor};"></div>
                <span>Daily Streak</span>
            </div>
        `;
    }
}

function createFocusChart() {
    const ctx = document.getElementById('focusChart');
    if (!ctx) return;
    
    const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    if (!studyData.focusScores) studyData.focusScores = [];
    
    const focusData = last7Days.map(day => {
        const focusEntry = studyData.focusScores.find(s => s.date === day);
        return focusEntry ? focusEntry.score : 0;
    });
    
    // Theme-adaptive colors
    const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
    const fillColor = lineColor + '20';
    
    focusChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            }),
            datasets: [{
                label: 'Focus Score (%)',
                data: focusData,
                backgroundColor: fillColor,
                borderColor: lineColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: lineColor,
                pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Score (%)',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('focusLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${lineColor};"></div>
                <span>Daily Focus Score</span>
            </div>
        `;
    }
}

function refreshCharts() {
    updateCharts();
    showNotification("Charts refreshed successfully!", "success");
}

function calculateFocusScore() {
    let score = 50;
    
    const streakBonus = Math.min((studyData.streak || 0) * 5, 30);
    score += streakBonus;
    
    if ((studyData.totalStudyDays || 0) > 7) score += 10;
    if ((studyData.totalStudyDays || 0) > 30) score += 10;
    
    const completionRate = tasks.length > 0 ? 
        (tasks.filter(t => t.completed).length / tasks.length) * 100 : 0;
    score += Math.min(completionRate * 0.2, 10);
    
    return Math.min(Math.max(Math.round(score), 0), 100);
}

function exportStatistics() {
    const statsData = {
        exportDate: new Date().toISOString(),
        summary: {
            totalHours: parseFloat(studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1) || 0),
            currentStreak: studyData.streak || 0,
            taskCompletionRate: tasks.length > 0 ? Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0,
            focusScore: calculateFocusScore()
        },
        detailed: {
            totalSessions: studyData.studySessions ? studyData.studySessions.length : 0,
            avgDailyHours: (studyData.totalStudyDays || 0) > 0 ? (parseFloat(studyData.totalStudyHours || 0) / (studyData.totalStudyDays || 1)).toFixed(1) : 0,
            totalTasks: tasks.length,
            completedTasks: tasks.filter(t => t.completed).length,
            totalAssignments: assignments.length,
            completedAssignments: assignments.filter(a => a.completed).length,
            weeklyPattern: studyData.weeklyPattern || [0, 0, 0, 0, 0, 0, 0],
            streakHistory: studyData.streakHistory || [],
            dailyStats: studyData.dailyStats || []
        }
    };
    
    const dataStr = JSON.stringify(statsData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `student-stats-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("Statistics exported successfully!", "success");
}

// ========== INSPIRING STORIES ==========
function loadInspiringStories() {
    const storiesList = document.getElementById('storiesList');
    if (!storiesList) return;
    
    const shuffledStories = [...inspiringStories].sort(() => 0.5 - Math.random()).slice(0, 3);
    
    storiesList.innerHTML = shuffledStories.map(story => `
        <div class="story-item" onclick="showStoryModal(${story.id})">
            <div class="story-name">
                ${story.icon} ${story.name}
            </div>
            <div class="story-quote">"${story.quote}"</div>
        </div>
    `).join('');
}

function showStoryModal(storyId) {
    const story = inspiringStories.find(s => s.id === storyId);
    if (!story) return;
    
    const modal = document.getElementById('storyModal');
    const title = document.getElementById('storyModalTitle');
    const content = document.getElementById('storyModalContent');
    
    title.textContent = `${story.icon} ${story.name}'s Story`;
    
    content.innerHTML = `
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Their Famous Quote:</h3>
            <div style="font-style: italic; font-size: 1.25rem; color: var(--text); padding: var(--spacing-md); background: var(--bg); border-radius: var(--radius); border-left: 4px solid var(--accent);">
                "${story.quote}"
            </div>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Their Journey:</h3>
            <p style="line-height: 1.6;">${story.story}</p>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Challenges They Overcame:</h3>
            <ul style="padding-left: var(--spacing-lg); line-height: 1.6;">
                ${story.struggles.map(s => `<li style="margin-bottom: var(--spacing-xs);">${s}</li>`).join('')}
        </ul>
        </div>
        
        <div style="padding: var(--spacing-lg); background: var(--accent-light); border-radius: var(--radius); border-left: 4px solid var(--accent);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">ðŸ’¡ Key Lesson:</h3>
            <p style="font-weight: 600; color: var(--text);">${story.lessons}</p>
        </div>
    `;
    
    modal.style.display = 'flex';
}

function closeStoryModal() {
    document.getElementById('storyModal').style.display = 'none';
}

// ========== CLASS MANAGEMENT ==========
function updateClassSelector() {
    const selector = document.getElementById('classSelector');
    if (!selector) return;
    
    selector.innerHTML = '<option value="">Select a Class</option>';
    
    userClasses.forEach((classInfo, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${classInfo.name || 'Class'} (${classInfo.code})`;
        if (index === selectedClassIndex) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
}

async function switchClass(classIndex) {
    if (classIndex === "") return;
    
    classIndex = parseInt(classIndex);
    if (classIndex >= 0 && classIndex < userClasses.length) {
        selectedClassIndex = classIndex;
        currentClassCode = userClasses[classIndex].code;
        
        console.log(`ðŸ”„ Switched to class: ${currentClassCode}`);
        
        persistData();
        loadClassroomData();
        if (currentSection === 'classroom') {
            await loadTeacherContent();
            await loadClassLeaderboard();
        }
        
        showNotification(`Switched to ${userClasses[classIndex].name || 'Class'}`, "success");
    }
}

function showJoinClassForm() {
    const form = document.getElementById('joinClassForm');
    if (form) {
        form.style.display = 'block';
        document.getElementById('joinClassCode').focus();
    }
}

function hideJoinClassForm() {
    const form = document.getElementById('joinClassForm');
    if (form) form.style.display = 'none';
}

async function joinClass() {
    const classCodeInput = document.getElementById('joinClassCode');
    const classCode = classCodeInput.value.toUpperCase().trim();
    
    if (!classCode || classCode.length !== 6) {
        showNotification("Please enter a valid 6-digit class code", "error");
        return;
    }
    
    const joinBtn = event.target;
    const originalText = joinBtn.innerHTML;
    joinBtn.innerHTML = 'ðŸ”„ Joining...';
    joinBtn.disabled = true;
    
    try {
        console.log(`ðŸŽ“ Attempting to join class: ${classCode}`);
        
        if (userClasses.some(c => c.code === classCode)) {
            showNotification("You've already joined this class", "info");
            hideJoinClassForm();
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        let classData = null;
        try {
            classData = await firebaseGet('classCodes/' + classCode);
        } catch (error) {
            console.log("Trying alternative path...");
            classData = await firebaseGet('classes/' + classCode);
        }
        
        if (!classData) {
            showNotification("Class not found. Check the code and try again.", "error");
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        console.log("âœ… Class found:", classData);
        
        const studentData = {
            name: currentUserName || 'Student',
            userId: currentUserId,
            firebaseUid: currentUser ? currentUser.uid : null,
            streak: studyData.streak || 0,
            totalMinutes: studyData.totalMinutes || 0,
            totalStudyHours: (studyData.totalMinutes / 60).toFixed(1),
            points: Math.floor(studyData.totalMinutes / 60) * 100 || 0,
            lastActive: new Date().toISOString(),
            joinedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            isStudentEntry: true,
            isTeacherAccount: false
        };
        
        console.log(`ðŸ“¤ Writing student data to class ${classCode}...`);
        
        let success = false;
        let errorMessages = [];
        
        try {
            await firebaseSet(`classes/${classCode}/students/${currentUserId}`, studentData);
            console.log(`âœ… Path 1 successful: classes/${classCode}/students/${currentUserId}`);
            success = true;
        } catch (error1) {
            errorMessages.push(`Path 1: ${error1.message}`);
            console.error(`âŒ Path 1 failed: ${error1.message}`);
        }
        
        if (!success) {
            try {
                await firebaseSet(`classStudents/${classCode}/${currentUserId}`, studentData);
                console.log(`âœ… Path 2 successful: classStudents/${classCode}/${currentUserId}`);
                success = true;
            } catch (error2) {
                errorMessages.push(`Path 2: ${error2.message}`);
                console.error(`âŒ Path 2 failed: ${error2.message}`);
            }
        }
        
        if (!success) {
            try {
                const simpleData = {
                    name: currentUserName || 'Student',
                    streak: studyData.streak || 0,
                    totalHours: (studyData.totalMinutes / 60).toFixed(1),
                    joined: new Date().toISOString()
                };
                
                await firebaseSet(`studentList/${classCode}/${currentUserId}`, simpleData);
                console.log(`âœ… Path 3 successful: studentList/${classCode}/${currentUserId}`);
                success = true;
            } catch (error3) {
                errorMessages.push(`Path 3: ${error3.message}`);
                console.error(`âŒ Path 3 failed: ${error3.message}`);
            }
        }
        
        if (!success) {
            console.error("All paths failed:", errorMessages);
            showNotification("Could not join class due to permissions. Try using incognito mode.", "error");
            
            console.log("Full error details:", {
                classCode,
                teacherId: classData.teacherId,
                currentUserId,
                currentUserUid: currentUser?.uid,
                errorMessages
            });
            
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        const newClass = {
            code: classCode,
            name: classData.name || 'Class ' + classCode,
            teacherId: classData.teacherId,
            joinedAt: new Date().toISOString()
        };
        
        userClasses.push(newClass);
        currentClassCode = classCode;
        selectedClassIndex = userClasses.length - 1;
        
        saveUserData();
        persistData();
        
        updateClassSelector();
        renderClassesList();
        loadClassroomData();
        
        classCodeInput.value = '';
        hideJoinClassForm();
        
        await saveStudyDataToFirebase();
        
        showNotification(`Successfully joined ${classData.name || 'the class'}!`, "success");
        
        if (currentSection === 'classroom') {
            await loadTeacherContent();
            await loadClassLeaderboard();
        }
        
    } catch (error) {
        console.error("âŒ Join class error:", error);
        console.error("Error stack:", error.stack);
        
        showNotification("Failed to join class: " + (error.message || "Unknown error"), "error");
    } finally {
        joinBtn.innerHTML = originalText;
        joinBtn.disabled = false;
    }
}

function renderClassesList() {
    const classesList = document.getElementById('classesList');
    const noClassesMessage = document.getElementById('noClassesMessage');
    
    if (!classesList) return;
    
    if (userClasses.length === 0) {
        classesList.innerHTML = '';
        if (noClassesMessage) noClassesMessage.style.display = 'block';
        return;
    }
    
    if (noClassesMessage) noClassesMessage.style.display = 'none';
    
    classesList.innerHTML = userClasses.map((classInfo, index) => {
        const isActive = index === selectedClassIndex;
        
        return `
            <div class="class-card ${isActive ? 'active' : ''}">
                <div class="class-card-header">
                    <div class="class-card-title">${classInfo.name || 'Class'}</div>
                    <div class="class-card-code">${classInfo.code}</div>
                </div>
                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-sm);">
                    Joined: ${new Date(classInfo.joinedAt).toLocaleDateString()}
                </div>
                <div class="class-card-stats">
                    <div class="class-card-stat">
                        <div class="value">${studyData.streak || 0}</div>
                        <div class="label">Streak</div>
                    </div>
                    <div class="class-card-stat">
                        <div class="value">${(studyData.totalMinutes / 60).toFixed(1)}</div>
                        <div class="label">Hours</div>
                    </div>
                </div>
                <div class="class-card-actions">
                    <button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="switchClass(${index})" style="flex: 1;">
                        ${isActive ? 'âœ“ Active' : 'Switch'}
                    </button>
                    <button class="btn btn-danger" onclick="leaveClassConfirm('${classInfo.code}')">
                        ðŸšª Leave
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function leaveClassConfirm(classCode) {
    if (confirm(`Are you sure you want to leave this class?`)) {
        leaveClass(classCode);
    }
}

async function leaveClass(classCodeToLeave = null) {
    const classCode = classCodeToLeave || currentClassCode;
    
    if (!classCode) {
        showNotification("No class to leave", "error");
        return;
    }
    
    const classIndex = userClasses.findIndex(c => c.code === classCode);
    if (classIndex === -1) {
        showNotification("Class not found in your list", "error");
        return;
    }
    
    const className = userClasses[classIndex].name || 'Class';
    
    try {
        await firebaseRemove(`classes/${classCode}/students/${currentUserId}`);
        console.log(`âœ… Student removed from class: ${classCode}`);
    } catch (error) {
        console.error("Error removing student from Firebase:", error);
    }
    
    userClasses.splice(classIndex, 1);
    
    if (classCode === currentClassCode) {
        if (userClasses.length > 0) {
            selectedClassIndex = 0;
            currentClassCode = userClasses[0].code;
        } else {
            currentClassCode = null;
            selectedClassIndex = -1;
        }
    }
    
    saveUserData();
    persistData();
    
    updateClassSelector();
    renderClassesList();
    loadClassroomData();
    
    if (currentSection === 'classroom') {
        await loadTeacherContent();
        await loadClassLeaderboard();
    }
    
    showNotification(`You have left ${className}`, "success");
}

// ========== CLASSROOM MANAGEMENT ==========
function loadClassroomData() {
    const notInClassView = document.getElementById('notInClassView');
    const inClassView = document.getElementById('inClassView');
    
    if (currentClassCode && userClasses.length > 0) {
        notInClassView.style.display = 'none';
        inClassView.style.display = 'block';
        
        const codeElement = document.getElementById('currentClassCode');
        if (codeElement) codeElement.textContent = currentClassCode;
        
        loadTeacherContent();
        loadClassLeaderboard();
    } else {
        if (notInClassView) notInClassView.style.display = 'block';
        if (inClassView) inClassView.style.display = 'none';
    }
}

async function loadTeacherContent() {
    if (!currentClassCode) {
        console.log("âŒ Cannot load teacher content: No class selected");
        return;
    }
    
    console.log(`ðŸ“¢ Loading teacher content for class: ${currentClassCode}`);
    
    try {
        const announcements = await firebaseGet(`announcements/${currentClassCode}`);
        const announcementsDiv = document.getElementById('teacherAnnouncements');
        
        if (announcements && announcementsDiv) {
            const announcementList = Object.entries(announcements).map(([id, ann]) => ({
                id,
                ...ann
            }));
            
            announcementList.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date || 0);
                const dateB = new Date(b.createdAt || b.date || 0);
                return dateB - dateA;
            });
            
            if (announcementList.length === 0) {
                announcementsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¢</div>
                        <div class="empty-state-title">No announcements yet</div>
                        <div class="empty-state-description">Check back later for updates from your teacher</div>
                    </div>
                `;
            } else {
                announcementsDiv.innerHTML = announcementList.map((ann, index) => `
                    <div class="classroom-item">
                        <div class="classroom-item-header">
                            <div class="classroom-item-title">${ann.title || 'Announcement'}</div>
                            <div class="classroom-item-date">
                                ðŸ“… ${new Date(ann.createdAt || ann.date || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="classroom-item-content">
                            <p>${ann.content || ''}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            const countElement = document.getElementById('announcementCount');
            if (countElement) countElement.textContent = announcementList.length;
        } else {
            if (announcementsDiv) {
                announcementsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¢</div>
                        <div class="empty-state-title">No announcements yet</div>
                        <div class="empty-state-description">Check back later for updates from your teacher</div>
                    </div>
                `;
                const countElement = document.getElementById('announcementCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("âŒ Error loading announcements:", error);
        const announcementsDiv = document.getElementById('teacherAnnouncements');
        if (announcementsDiv) {
            announcementsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">Error loading announcements</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    
    try {
        const resources = await firebaseGet(`resources/${currentClassCode}`);
        const resourcesDiv = document.getElementById('teacherResources');
        
        if (resources && resourcesDiv) {
            const resourceList = Object.entries(resources).map(([id, res]) => ({
                id,
                ...res
            }));
            
            if (resourceList.length === 0) {
                resourcesDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <div class="empty-state-title">No resources yet</div>
                        <div class="empty-state-description">Your teacher will add resources here</div>
                    </div>
                `;
            } else {
                resourcesDiv.innerHTML = resourceList.map((res, index) => `
                    <div class="classroom-item">
                        <div class="classroom-item-header">
                            <div class="classroom-item-title">${res.title || 'Resource'}</div>
                            <div class="classroom-item-date">
                                ðŸ“… ${new Date(res.createdAt || res.date || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="classroom-item-content">
                            ${res.description ? `<p>${res.description}</p>` : ''}
                            ${res.url ? `
                                <a href="${res.url}" target="_blank" class="classroom-item-link">
                                    ðŸ“Ž ${res.url}
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            const countElement = document.getElementById('resourceCount');
            if (countElement) countElement.textContent = resourceList.length;
        } else {
            if (resourcesDiv) {
                resourcesDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <div class="empty-state-title">No resources yet</div>
                        <div class="empty-state-description">Your teacher will add resources here</div>
                    </div>
                `;
                const countElement = document.getElementById('resourceCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("âŒ Error loading resources:", error);
        const resourcesDiv = document.getElementById('teacherResources');
        if (resourcesDiv) {
            resourcesDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">Error loading resources</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    
    try {
        const polls = await firebaseGet(`polls/${currentClassCode}`);
        const pollsDiv = document.getElementById('teacherPolls');
        
        if (polls && pollsDiv) {
            const pollList = Object.entries(polls).map(([id, pol]) => ({
                id,
                ...pol
            }));
            
            pollList.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date || 0);
                const dateB = new Date(b.createdAt || b.date || 0);
                return dateB - dateA;
            });
            
            if (pollList.length === 0) {
                pollsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ—³ï¸</div>
                        <div class="empty-state-title">No polls yet</div>
                        <div class="empty-state-description">Your teacher will share polls here</div>
                    </div>
                `;
            } else {
                pollsDiv.innerHTML = pollList.filter(p => !p.isArchived).map(pol => {
                    const votedIndex = pol.responses && currentUserId ? pol.responses[currentUserId] : null;
                    const options = pol.options || [];
                    const isClosed = pol.isActive === false;
                    const canVote = votedIndex === null || votedIndex === undefined;
                    
                    const optionsHtml = options.map((opt, idx) => {
                        const isOther = String(opt || '').trim().toLowerCase() === 'other';
                        return `
                        <label class="poll-option">
                            <input class="poll-radio" type="radio" name="poll_${pol.id}" value="${idx}" ${(!canVote || isClosed) ? 'disabled' : ''}>
                            ${isOther
                                ? `<span>Other:</span><input class="poll-other-input" type="text" id="poll_${pol.id}_other_${idx}" ${(!canVote || isClosed) ? 'disabled' : ''}>`
                                : `<span>${opt}</span>`
                            }
                        </label>
                        `;
                    }).join('');
                    
                    const results = pol.results || {};
                    const totalVotes = Object.values(results).reduce((sum, v) => sum + (Number(v) || 0), 0);
                    const resultsHtml = options.map((opt, idx) => {
                        const count = Number(results[idx] || 0);
                        const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                        return `
                            <div class="poll-result-row">
                                <div class="poll-result-head">
                                    <span>${opt}</span>
                                    <span>${count} (${percent}%)</span>
                                </div>
                                <div class="poll-bar">
                                    <div class="poll-bar-fill" style="width: ${percent}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    const votedText = votedIndex !== null && votedIndex !== undefined
                        ? `<div class="poll-status voted">You voted: ${options[votedIndex] || 'Option'}</div>`
                        : '';
                    
                    return `
                        <div class="classroom-item poll-card" data-poll-id="${pol.id}">
                            <div class="classroom-item-header">
                                <div class="classroom-item-title">${pol.question || 'Class Poll'}</div>
                                <div class="classroom-item-date">
                                    ðŸ—“ ${new Date(pol.createdAt || Date.now()).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="poll-divider"></div>
                            <div class="classroom-item-content">
                                ${(!isClosed && canVote) ? `<div class="poll-options">${optionsHtml}</div>` : ''}
                                ${(!isClosed && canVote) ? `<button class="poll-submit" onclick="submitPollResponse('${pol.id}')">Vote</button>` : ''}
                                ${(!isClosed && canVote) ? `<div class="poll-actions"><span class="poll-action-link" onclick="togglePollResults('${pol.id}')">View Results</span><span class="poll-action-link" onclick="copyPollLink('${pol.id}')">Share This</span></div>` : ''}
                                ${(isClosed || !canVote) ? `
                                    <div class="poll-results" style="display: block;">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Results</div>
                                        ${resultsHtml}
                                        <div style="margin-top: 0.25rem; color: var(--text-muted); font-size: 0.875rem;">Total votes: ${totalVotes}</div>
                                    </div>
                                ` : ''}
                                ${(isClosed || !canVote) ? `<div class="poll-actions"><span class="poll-action-link" onclick="togglePollResults('${pol.id}')">View Results</span><span class="poll-action-link" onclick="copyPollLink('${pol.id}')">Share This</span></div>` : ''}
                                ${votedText}
                                ${isClosed ? `<div class="poll-status closed">Poll closed</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            const countElement = document.getElementById('pollCount');
            if (countElement) countElement.textContent = pollList.filter(p => !p.isArchived).length;
        } else {
            if (pollsDiv) {
                pollsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ—³ï¸</div>
                        <div class="empty-state-title">No polls yet</div>
                        <div class="empty-state-description">Your teacher will share polls here</div>
                    </div>
                `;
                const countElement = document.getElementById('pollCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("âŒ Error loading polls:", error);
        const pollsDiv = document.getElementById('teacherPolls');
        if (pollsDiv) {
            pollsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">Error loading polls</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    await renderAggregateHeatmap();
}

async function submitPollResponse(pollId) {
    if (!currentClassCode || !currentUserId) {
        showNotification("Please join a class first", "error");
        return;
    }
    
    const selected = document.querySelector(`input[name="poll_${pollId}"]:checked`);
    if (!selected) {
        showNotification("Please select an option", "error");
        return;
    }
    
    const optionIndex = selected.value;
    
    try {
        const responsePath = `polls/${currentClassCode}/${pollId}/responses/${currentUserId}`;
        const existing = await firebaseGet(responsePath);
        if (existing !== null && existing !== undefined) {
            showNotification("You have already voted in this poll", "warning");
            return;
        }
        
        await firebaseSet(responsePath, optionIndex);
        
        if (database && currentUser) {
            const resultRef = database.ref(`polls/${currentClassCode}/${pollId}/results/${optionIndex}`);
            resultRef.transaction((current) => {
                const base = parseInt(current || 0, 10) || 0;
                return base + 1;
            });
        }
        
        showNotification("Vote submitted!", "success");
        loadTeacherContent();
    } catch (error) {
        console.error("âŒ Error submitting poll response:", error);
        showNotification("Failed to submit vote. Try again.", "error");
    }
}

function togglePollResults(pollId) {
    const pollNode = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollNode) return;
    const results = pollNode.querySelector('.poll-results');
    if (!results) return;
    results.style.display = results.style.display === 'none' ? 'block' : 'none';
}

function copyPollLink(pollId) {
    if (!currentClassCode) return;
    const url = `${window.location.origin}${window.location.pathname}?class=${encodeURIComponent(currentClassCode)}&poll=${encodeURIComponent(pollId)}`;
    navigator.clipboard.writeText(url).then(() => {
        showNotification("Poll link copied!", "success");
    }).catch(() => {
        showNotification("Unable to copy poll link", "warning");
    });
}

async function loadClassLeaderboard() {
    if (!currentClassCode) {
        console.log("âŒ Cannot load leaderboard: No class selected");
        showLeaderboardError("Not connected to a class");
        return;
    }
    
    console.log(`ðŸ“Š Loading leaderboard for class: ${currentClassCode}`);
    
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="loading">
                <div>Loading leaderboard...</div>
            </div>
        `;
    }
    
    try {
        const students = await firebaseGet(`classes/${currentClassCode}/students`);
        
        if (!students) {
            showLeaderboardEmpty();
            return;
        }
        
        const studentList = Object.entries(students).map(([id, studentData]) => {
            const totalStudyHours = studentData.totalStudyHours || (studentData.totalMinutes / 60).toFixed(1) || 0;
            
            return {
                id,
                name: studentData.name || 'Student ' + id.substr(0, 6),
                totalStudyHours: parseFloat(totalStudyHours),
                streak: studentData.streak || 0,
                points: studentData.points || Math.floor(totalStudyHours * 100) || 0,
                lastActive: studentData.lastActive || 'Unknown',
                isTeacherAccount: id.includes('teacher') || studentData.name?.includes('Teacher')
            };
        });
        
        const filteredStudents = studentList.filter(s => !s.isTeacherAccount);
        filteredStudents.sort((a, b) => b.totalStudyHours - a.totalStudyHours);
        
        renderLeaderboard(filteredStudents);
        
    } catch (error) {
        console.error("âŒ Error loading leaderboard:", error);
        showLeaderboardError("Failed to load leaderboard. Please try again.");
    }
}

function renderLeaderboard(students) {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (!leaderboardDiv) return;
    
    if (students.length === 0) {
        showLeaderboardEmpty();
        return;
    }
    
    const totalStudents = students.length;
    const totalHours = students.reduce((sum, student) => sum + student.totalStudyHours, 0);
    const avgHours = totalStudents > 0 ? totalHours / totalStudents : 0;
    const topStudent = students.length > 0 ? students[0] : null;
    
    leaderboardDiv.innerHTML = `
        <div class="leaderboard-stats">
            <div class="leaderboard-stat">
                <div class="value">${totalStudents}</div>
                <div class="label">Students</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${totalHours.toFixed(1)}</div>
                <div class="label">Total Hours</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${avgHours.toFixed(1)}</div>
                <div class="label">Avg/Student</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${topStudent ? topStudent.totalStudyHours.toFixed(1) : '0.0'}</div>
                <div class="label">Top Score</div>
            </div>
        </div>
        
        <div class="leaderboard-list">
            ${students.map((student, index) => {
                const isCurrentUser = student.id === currentUserId;
                const rankClass = `rank-${index + 1}`;
                const isTopThree = index < 3;
                
                const initials = student.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                let lastActiveText = 'Never';
                if (student.lastActive && student.lastActive !== 'Unknown') {
                    const lastActive = new Date(student.lastActive);
                    const now = new Date();
                    const diffDays = Math.floor((now - lastActive) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) lastActiveText = 'Today';
                    else if (diffDays === 1) lastActiveText = 'Yesterday';
                    else if (diffDays < 7) lastActiveText = `${diffDays}d ago`;
                    else if (diffDays < 30) lastActiveText = `${Math.floor(diffDays/7)}w ago`;
                    else lastActiveText = lastActive.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                return `
                    <div class="leaderboard-item ${rankClass} ${isCurrentUser ? 'you' : ''}">
                        <div class="leaderboard-rank">
                            ${isTopThree ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] : `#${index + 1}`}
                        </div>
                        <div class="leaderboard-avatar">
                            ${initials}
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${student.name} ${isCurrentUser ? '(You)' : ''}
                            </div>
                            <div class="leaderboard-subtitle">
                                Last active: ${lastActiveText}
                            </div>
                            <div class="leaderboard-stats-row">
                                <span class="stats-badge fire">ðŸ”¥ ${student.streak || 0}</span>
                                <span class="stats-badge time">â° ${student.totalStudyHours.toFixed(1)}h</span>
                                <span class="stats-badge points">â­ ${student.points || 0}</span>
                            </div>
                        </div>
                        <div class="leaderboard-score">
                            ${student.totalStudyHours.toFixed(1)}h
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function showLeaderboardEmpty() {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="leaderboard-empty">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">ðŸ†</div>
                <h3>No Students Yet</h3>
                <p>Be the first to join and start studying!</p>
            </div>
        `;
    }
}

function showLeaderboardError(message) {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="leaderboard-empty">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">âŒ</div>
                <h3>Error Loading Leaderboard</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="loadClassLeaderboard()" style="margin-top: var(--spacing-md);">
                    ðŸ”„ Retry
                </button>
            </div>
        `;
    }
}

function refreshLeaderboard() {
    updateSyncStatus("Refreshing leaderboard...", "syncing");
    loadClassLeaderboard();
    setTimeout(() => {
        updateSyncStatus("Leaderboard refreshed", "success");
    }, 500);
}

function copyClassCode() {
    if (!currentClassCode) return;
    
    navigator.clipboard.writeText(currentClassCode).then(() => {
        showNotification("Class code copied to clipboard!", "success");
    });
}

async function refreshClassroom() {
    updateSyncStatus("Refreshing...", "syncing");
    await loadTeacherContent();
    await loadClassLeaderboard();
    setTimeout(() => {
        showNotification("Classroom data refreshed", "success");
        updateSyncStatus("Refreshed", "success");
    }, 500);
}

// ========== ACHIEVEMENT BADGES ==========
const BADGES_STORAGE_KEY = 'studentEarnedBadges';

function loadEarnedBadges() {
    try {
        const raw = localStorage.getItem(BADGES_STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
    } catch (e) {
        console.warn("Failed to load earned badges:", e);
        return [];
    }
}

function saveEarnedBadges(badges) {
    try {
        localStorage.setItem(BADGES_STORAGE_KEY, JSON.stringify(badges));
    } catch (e) {
        console.warn("Failed to save earned badges:", e);
    }
}

function getAchievementBadges() {
    const sessions = studyData.studySessions || [];
    const totalMinutes = studyData.totalMinutes || (parseFloat(studyData.totalStudyHours || 0) * 60) || 0;
    const todayKey = new Date().toDateString();
    const todayStats = (studyData.dailyStats || []).find(s => s.date === todayKey);
    const todaySessions = todayStats ? (todayStats.sessions || 0) : 0;
    const goalTarget = getDailyGoalTarget();
    const completedTimers = sessions.length;
    const totalHours = totalMinutes / 60;
    const completedTasks = tasks.filter(t => t.completed).length;
    const completedAssignments = assignments.filter(a => a.completed).length;
    const last7Days = (studyData.dailyStats || []).slice(0, 7);
    const daysStudiedLast7 = last7Days.filter(d => (d.sessions || 0) > 0).length;

    const hasEarlyBird = sessions.some(s => {
        const d = new Date(s.date);
        return !isNaN(d) && d.getHours() < 8;
    });

    const hasWeekendWarrior = sessions.some(s => {
        const d = new Date(s.date);
        if (isNaN(d)) return false;
        const day = d.getDay();
        return day === 0 || day === 6;
    });

    const hasFocusMaster = completedTimers >= 10;
    const hasTwoHours = totalMinutes >= 120;
    const hasGoalGetter = todaySessions >= goalTarget;
    const hasStreakStarter = (studyData.streak || 0) >= 3;
    const hasStreakBuilder = (studyData.streak || 0) >= 7;
    const hasStreakChampion = (studyData.streak || 0) >= 14;
    const hasTaskCrusher = completedTasks >= 10;
    const hasAssignmentAce = completedAssignments >= 5;
    const hasConsistencyKing = daysStudiedLast7 >= 5;
    const hasStudyMarathon = totalHours >= 10;

    return [
        {
            id: "early-bird",
            title: "Early Bird",
            desc: "Study before 8 AM",
            icon: "&#9728;",
            tone: "sunrise",
            earned: hasEarlyBird
        },
        {
            id: "weekend-warrior",
            title: "Weekend Warrior",
            desc: "Study on Saturday or Sunday",
            icon: "&#128197;",
            tone: "weekend",
            earned: hasWeekendWarrior
        },
        {
            id: "focus-master",
            title: "Focus Master",
            desc: "Complete 10 timers",
            icon: "&#127919;",
            tone: "focus",
            earned: hasFocusMaster
        },
        {
            id: "two-hour-club",
            title: "2-Hour Club",
            desc: "Time: 2 hours",
            icon: "&#9201;",
            tone: "time",
            earned: hasTwoHours
        },
        {
            id: "goal-getter",
            title: "Goal Getter",
            desc: "Hit today's daily goal",
            icon: "&#127881;",
            tone: "goal",
            earned: hasGoalGetter
        },
        {
            id: "streak-starter",
            title: "Streak Starter",
            desc: "Reach a 3-day streak",
            icon: "&#128293;",
            tone: "streak",
            earned: hasStreakStarter
        },
        {
            id: "streak-builder",
            title: "Streak Builder",
            desc: "Reach a 7-day streak",
            icon: "&#128293;",
            tone: "streak",
            earned: hasStreakBuilder
        },
        {
            id: "streak-champion",
            title: "Streak Champion",
            desc: "Reach a 14-day streak",
            icon: "&#127942;",
            tone: "streak",
            earned: hasStreakChampion
        },
        {
            id: "task-crusher",
            title: "Task Crusher",
            desc: "Complete 10 tasks",
            icon: "&#9989;",
            tone: "tasks",
            earned: hasTaskCrusher
        },
        {
            id: "assignment-ace",
            title: "Assignment Ace",
            desc: "Complete 5 assignments",
            icon: "&#128218;",
            tone: "assign",
            earned: hasAssignmentAce
        },
        {
            id: "consistency-king",
            title: "Consistency",
            desc: "Study 5 of the last 7 days",
            icon: "&#128200;",
            tone: "consistency",
            earned: hasConsistencyKing
        },
        {
            id: "study-marathon",
            title: "Study Marathon",
            desc: "Reach 10 total study hours",
            icon: "&#9200;",
            tone: "time",
            earned: hasStudyMarathon
        }
    ];
}

function renderBadges() {
    const grid = document.getElementById('badgesGrid');
    const empty = document.getElementById('badgesEmpty');
    const countEl = document.getElementById('badgeCount');
    if (!grid || !empty || !countEl) return;

    const stored = loadEarnedBadges();
    const badges = getAchievementBadges().map(b => ({
        ...b,
        earned: b.earned || stored.includes(b.id)
    }));
    const earnedIds = badges.filter(b => b.earned).map(b => b.id);
    saveEarnedBadges(Array.from(new Set(earnedIds)));

    const earnedBadges = badges.filter(b => b.earned);
    countEl.textContent = `${earnedBadges.length} earned`;

    if (earnedBadges.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'flex';
        return;
    }

    empty.style.display = 'none';
    grid.innerHTML = earnedBadges.map(b => `
        <div class="badge-item" data-tone="${b.tone || 'goal'}">
            <div class="badge-icon">${b.icon}</div>
            <div class="badge-info">
                <div class="badge-title">${b.title}</div>
                <div class="badge-desc">${b.desc}</div>
                <div class="badge-tag">Achieved</div>
            </div>
        </div>
    `).join('');
}

// ========== STUDY HEATMAP ==========
function renderStudyHeatmap() {
    const grid = document.getElementById('studyHeatmap');
    if (!grid) return;

    const daysToShow = 84; // 12 weeks
    const today = new Date();
    const dayStats = new Map();
    const daily = studyData.dailyStats || [];
    if (daily.length > 0) {
        daily.forEach(stat => {
            if (stat?.date) {
                dayStats.set(stat.date, stat.sessions || 0);
            }
        });
    } else {
        // Fallback: aggregate from studySessions if dailyStats is empty
        (studyData.studySessions || []).forEach(session => {
            if (!session?.date) return;
            const key = new Date(session.date).toDateString();
            dayStats.set(key, (dayStats.get(key) || 0) + 1);
        });
    }

    const cells = [];
    for (let i = daysToShow - 1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = d.toDateString();
        const sessions = dayStats.get(key) || 0;
        const level =
            sessions >= 4 ? 4 :
            sessions === 3 ? 3 :
            sessions === 2 ? 2 :
            sessions === 1 ? 1 : 0;
        const title = `${d.toLocaleDateString()}: ${sessions} session${sessions === 1 ? '' : 's'}`;
        cells.push(
            `<div class="heatmap-cell level-${level}" title="${title}">` +
            `<span class="heatmap-value">${sessions}</span>` +
            `</div>`
        );
    }

    grid.innerHTML = cells.join('');
}

// ========== ENGAGEMENT HEATMAP (AGGREGATE) ==========
async function getAggregateHeatmap() {
    if (!currentClassCode) return null;
    const activity = await firebaseGet(`classActivity/${currentClassCode}`);
    const buckets = Array.from({ length: 7 }, () => Array(4).fill(0));

    if (!activity) {
        return { buckets, total: 0 };
    }

    const events = Object.values(activity);
    let total = 0;

    events.forEach(evt => {
        const ts = evt?.createdAt || evt?.date || evt?.timestamp;
        if (!ts) return;
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return;
        const day = d.getDay();
        const hour = d.getHours();

        let slot = 0; // Night (0-6)
        if (hour >= 6 && hour < 12) slot = 1; // Morning
        else if (hour >= 12 && hour < 17) slot = 2; // Afternoon
        else slot = 3; // Evening (17-24)

        buckets[day][slot] += 1;
        total += 1;
    });

    return { buckets, total };
}

async function renderAggregateHeatmap() {
    const container = document.getElementById('aggregateHeatmap');
    const insightEl = document.getElementById('aggregateInsight');
    if (!container || !insightEl) return;

    const data = await getAggregateHeatmap();
    if (!data || data.total === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">ðŸ“Š</div>
                <div class="empty-state-description">No class activity yet.</div>
            </div>
        `;
        insightEl.textContent = "Free insights: Class activity will appear once study sessions begin.";
        return;
    }

    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const timeNames = ['Night', 'Morning', 'Afternoon', 'Evening'];
    const flat = data.buckets.flat();
    const max = Math.max(...flat, 1);

    const levelFor = (count) => {
        const ratio = count / max;
        if (ratio >= 0.8) return 4;
        if (ratio >= 0.6) return 3;
        if (ratio >= 0.4) return 2;
        if (ratio >= 0.2) return 1;
        return 0;
    };

    const headerRow = `
        <div class="aggregate-heatmap-grid">
            <div></div>
            ${timeNames.map(t => `<div class="aggregate-heatmap-time">${t}</div>`).join('')}
        </div>
    `;

    const rows = data.buckets.map((row, dayIdx) => {
        const cells = row.map((count, tIdx) => {
            const level = levelFor(count);
            return `<div class="aggregate-heatmap-cell level-${level}" title="${dayNames[dayIdx]} ${timeNames[tIdx]}: ${count} activities"></div>`;
        }).join('');
        return `
            <div class="aggregate-heatmap-grid">
                <div class="aggregate-heatmap-label">${dayNames[dayIdx]}</div>
                ${cells}
            </div>
        `;
    }).join('');

    container.innerHTML = headerRow + rows;

    let bestDay = 0;
    let bestSlot = 0;
    let bestCount = -1;
    data.buckets.forEach((row, dIdx) => {
        row.forEach((count, tIdx) => {
            if (count > bestCount) {
                bestCount = count;
                bestDay = dIdx;
                bestSlot = tIdx;
            }
        });
    });

    const insight = `Free insights: Class studies most on ${dayNames[bestDay]} ${timeNames[bestSlot].toLowerCase()}s.`;
    insightEl.textContent = insight;
}

// ========== STATISTICS & UI UPDATES ==========
function updateAllStatistics() {
    updateUI();
    updateTaskStats();
    updateSidebarStats();
    renderBadges();
    renderStudyHeatmap();
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    persistData();
}

function updateUI() {
    const streakDisplay = document.getElementById('streakDisplay');
    const streakNumber = document.getElementById('streakNumber');
    if (streakDisplay) streakDisplay.textContent = studyData.streak || 0;
    if (streakNumber) streakNumber.textContent = studyData.streak || 0;
    
    const totalHoursDisplay = document.getElementById('totalHoursDisplay');
    const hours = studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1) || 0;
    if (totalHoursDisplay) totalHoursDisplay.textContent = parseFloat(hours).toFixed(1);
    
    const tasksCompleted = tasks.filter(t => t.completed).length;
    const tasksCompletedDisplay = document.getElementById('tasksCompletedDisplay');
    if (tasksCompletedDisplay) tasksCompletedDisplay.textContent = tasksCompleted;
    
    const focusScore = calculateFocusScore();
    const focusScoreDisplay = document.getElementById('focusScoreDisplay');
    if (focusScoreDisplay) focusScoreDisplay.textContent = `${focusScore}%`;
    
    updateSidebarStats();
    updateStreakUI();
    updateDailyGoalUI();

}

function updateSidebarStats() {
    const sidebarStreak = document.getElementById('sidebarStreak');
    const sidebarHours = document.getElementById('sidebarHours');
    const sidebarTasks = document.getElementById('sidebarTasks');
    const sidebarFocus = document.getElementById('sidebarFocus');
    
    if (sidebarStreak) sidebarStreak.textContent = studyData.streak || 0;
    if (sidebarHours) {
        const hours = studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1) || 0;
        sidebarHours.textContent = parseFloat(hours).toFixed(1);
    }
    if (sidebarTasks) {
        const completedTasks = tasks.filter(t => t.completed).length;
        sidebarTasks.textContent = completedTasks;
    }
    if (sidebarFocus) {
        const focusScore = calculateFocusScore();
        sidebarFocus.textContent = `${focusScore}%`;
    }
}

// ========== PROFILE MANAGEMENT ==========
async function saveProfile() {
    const name = document.getElementById('studentName').value.trim();
    const email = document.getElementById('studentEmail').value.trim();
    const bio = document.getElementById('studentBio').value.trim();
    
    if (!name) {
        showNotification("Please enter your name", "error");
        return;
    }
    
    currentUserName = name;
    saveUserData();
    
    if (currentUserId) {
        try {
            await firebaseUpdate(`users/${currentUserId}`, {
                name: currentUserName,
                email: email,
                bio: bio,
                updatedAt: new Date().toISOString()
            });
            
            await saveStudyDataToFirebase();
            
        } catch (error) {
            console.error("âŒ Error saving profile to Firebase:", error);
        }
    }
    
    showNotification("Profile saved successfully!", "success");
}

async function saveProfileSettings() {
    const name = document.getElementById('profileName').value.trim();
    const email = document.getElementById('profileEmail').value.trim();
    const bio = document.getElementById('profileBio').value.trim();
    
    if (!name) {
        showNotification("Please enter your name", "error");
        return;
    }
    
    currentUserName = name;
    saveUserData();
    
    document.getElementById('studentName').value = name;
    document.getElementById('studentEmail').value = email;
    document.getElementById('studentBio').value = bio;
    
    if (currentUserId) {
        try {
            await firebaseUpdate(`users/${currentUserId}`, {
                name: currentUserName,
                email: email,
                bio: bio,
                updatedAt: new Date().toISOString()
            });
            
            await saveStudyDataToFirebase();
            
        } catch (error) {
            console.error("âŒ Error saving profile to Firebase:", error);
        }
    }
    
    showNotification("Profile settings saved successfully!", "success");
}

// ========== NAVIGATION ==========
function showSection(sectionId) {
    console.log("ðŸ“± Switching to section:", sectionId);
    
    // Hide all sections first
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Update active nav items - MORE SPECIFIC MATCHING
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        const itemText = item.textContent.trim();
        
        // EXACT MATCHING based on expected text
        const expectedTexts = {
            'dashboard': 'ðŸ“Š Dashboard',
            'tasks': 'ðŸ“ Tasks',
            'assignments': 'ðŸ“š Assignments',
            'classroom': 'ðŸ« Classroom',
            'myclasses': 'ðŸŽ“ My Classes',
            'statistics': 'ðŸ“ˆ Statistics',
            'tools': 'ðŸ› ï¸ Study Tools',
            'ai': 'ðŸ¤– AI Help',
            'profile': 'ðŸ‘¤ Profile'
        };
        
        if (expectedTexts[sectionId] && itemText === expectedTexts[sectionId]) {
            item.classList.add('active');
        }
    });
    
    // Show the requested section
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
        sectionElement.style.display = 'block';
        currentSection = sectionId;
        persistData();
        
        // Load section-specific data
        loadSectionData(sectionId);
    } else {
        console.error("âŒ Section not found:", sectionId);
        showNotification("Section not available", "error");
        
        // Fallback to dashboard
        showSection('dashboard');
    }
}

// Load section-specific data
function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'dashboard':
            renderDashboardTasks();
            renderDashboardAssignments();
            updateStreakUI();
            updateUI();
            updateDailyGoalUI();
            break;
            
        case 'tasks':
            renderTasks();
            break;
            
        case 'assignments':
            renderAssignments();
            break;
            
        case 'classroom':
            loadClassroomData();
            break;
            
        case 'myclasses':
            renderClassesList();
            break;
            
        case 'statistics':
            setTimeout(updateCharts, 100);
            break;
            
        case 'tools':
            // Nothing special needed
            break;
            
        case 'ai':
            // Nothing special needed
            break;
            
        case 'profile':
            // Load profile data
            document.getElementById('profileName').value = currentUserName || '';
            document.getElementById('profileEmail').value = localStorage.getItem('studentEmail') || '';
            document.getElementById('profileBio').value = localStorage.getItem('studentBio') || '';
            updateReferralUI();
            updateRainbowUI();
            break;
    }
}
    


   // Fixed showStudentMemoryWall function
function showStudentMemoryWall() {
    // Hide other sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show student memory wall
    const memoryWallSection = document.getElementById('studentMemoryWall');
    if (memoryWallSection) {
        memoryWallSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent.includes('ðŸ“ Memory Wall')) {
                item.classList.add('active');
            }
        });
        
        // Update header
        const header = document.getElementById('dashboardHeader');
        if (header) {
            header.querySelector('h1').textContent = 'Class Memory Wall';
            header.querySelector('.dashboard-subtitle').textContent = 'Share memories and encouragement with classmates';
        }
        
        // Load memory wall data
        setTimeout(() => {
            loadStudentMemoryWall();
        }, 100);
    } else {
        console.error("Student memory wall section not found!");
        showNotification("Memory wall feature not available", "error");
    }
}


function getNavItemText(sectionId) {
    const navTexts = {
        'dashboard': 'ðŸ“Š',
        'tasks': 'ðŸ“',
        'assignments': 'ðŸ“š',
        'classroom': 'ðŸ«',
        'myclasses': 'ðŸŽ“',
        'statistics': 'ðŸ“ˆ',
        'tools': 'ðŸ› ï¸',
        'ai': 'ðŸ¤–',
        'profile': 'ðŸ‘¤'
    };
    return navTexts[sectionId] || '';
}

function updateDashboardHeader(sectionId) {
    const header = document.getElementById('dashboardHeader');
    const subtitle = document.getElementById('dashboardSubtitle');
    
    if (!header || !subtitle) return;
    
    switch(sectionId) {
        case 'dashboard':
            header.querySelector('h1').textContent = 'Welcome to Your Learning Dashboard';
            subtitle.textContent = 'Track your progress, manage tasks, and achieve your study goals';
            break;
        case 'tasks':
            header.querySelector('h1').textContent = 'Task Manager';
            subtitle.textContent = 'Organize and track your daily tasks';
            renderTasks();
            break;
        case 'assignments':
            header.querySelector('h1').textContent = 'Assignment Tracker';
            subtitle.textContent = 'Manage your school assignments and deadlines';
            renderAssignments();
            break;
        case 'classroom':
            header.querySelector('h1').textContent = 'Classroom';
            subtitle.textContent = 'Connect with your teacher and classmates';
            loadClassroomData();
            break;
        case 'myclasses':
            header.querySelector('h1').textContent = 'My Classes';
            subtitle.textContent = 'Manage your classrooms and join new ones';
            renderClassesList();
            break;
        case 'statistics':
            header.querySelector('h1').textContent = 'Learning Statistics';
            subtitle.textContent = 'Visualize your progress with charts and insights';
            break;
        case 'tools':
            header.querySelector('h1').textContent = 'Study Tools';
            subtitle.textContent = 'Tools and resources to enhance your learning';
            break;
        case 'ai':
            header.querySelector('h1').textContent = 'AI Learning Resources';
            subtitle.textContent = 'AI-powered tools and educational resources';
            break;
        case 'profile':
            header.querySelector('h1').textContent = 'Profile Settings';
            subtitle.textContent = 'Manage your profile and preferences';
            break;
    }
}

// ========== UTILITY FUNCTIONS ==========
function initUI() {
    const savedTheme = localStorage.getItem('studentTheme') || 'light';
    const isPremiumUnlocked = getReferralCount() >= REFERRAL_TARGET;
    const isRainbowUnlocked = (studyData.streak || 0) >= 30 || localStorage.getItem(RAINBOW_UNLOCKED_KEY) === 'true';
    const isForestUnlocked = (studyData.streak || 0) >= 7 || localStorage.getItem(FOREST_UNLOCKED_KEY) === 'true';
    let appliedTheme = savedTheme;
    if (savedTheme === 'premium' && !isPremiumUnlocked) {
        appliedTheme = 'light';
    }
    if (savedTheme === 'rainbow' && !isRainbowUnlocked) {
        appliedTheme = 'light';
    }
    if (savedTheme === 'forest' && !isForestUnlocked) {
        appliedTheme = 'light';
    }
    document.body.className = appliedTheme;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = appliedTheme;
    localStorage.setItem('studentTheme', appliedTheme);
    
    loadMotivationalQuote();
    loadInspiringStories();
    renderStudyHeatmap();
    
    const nameField = document.getElementById('studentName');
    if (nameField && currentUserName) nameField.value = currentUserName;
    
    const profileNameField = document.getElementById('profileName');
    if (profileNameField && currentUserName) profileNameField.value = currentUserName;
    
    showSection(currentSection);
    
    updateReferralUI();
    updateRainbowUI();
    renderDailyChallenge();
    setInterval(syncReferralCountFromFirebase, 30000);

    updateTimeGreeting();
    applyTimeTheme();
    setInterval(updateTimeGreeting, 600000);

    const chatbotBtn = document.getElementById('chatbotBtn');
    if (chatbotBtn) {
        chatbotBtn.addEventListener('click', showChatbotMessage);
    }
    showChatbotGreetingThenChallenge();
    scheduleChatbotMessage();
    updateStatsCompare();

    console.log("ðŸŽ¨ UI initialized with theme:", savedTheme);
}

function setupEventListeners() {
    const taskInput = document.getElementById('taskInput');
    if (taskInput) {
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
    }
    
    const taskInputFull = document.getElementById('taskInputFull');
    if (taskInputFull) {
        taskInputFull.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
    }
    
    const hoursInput = document.getElementById('hoursInput');
    if (hoursInput) {
        hoursInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addStudyHours();
        });
    }
    
    document.getElementById('storyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeStoryModal();
        }
    });

    const rainbowModal = document.getElementById('rainbowModal');
    if (rainbowModal) {
        rainbowModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRainbowModal();
            }
        });
    }
    const forestModal = document.getElementById('forestModal');
    if (forestModal) {
        forestModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeForestModal();
            }
        });
    }
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeStoryModal();
            closeRainbowModal();
            closeForestModal();
        }
    });
}

function loadAllData() {
    renderTasks();
    renderDashboardTasks();
    renderAssignments();
    renderDashboardAssignments();
    loadClassroomData();
    loadMotivationalQuote();
    loadInspiringStories();
    updateClassSelector();
    renderClassesList();
    
    const savedProfile = localStorage.getItem('studentProfile');
    if (savedProfile) {
        const profile = JSON.parse(savedProfile);
        document.getElementById('studentName').value = profile.name || '';
        document.getElementById('studentEmail').value = profile.email || '';
        document.getElementById('studentBio').value = profile.bio || '';
        document.getElementById('profileName').value = profile.name || '';
        document.getElementById('profileEmail').value = profile.email || '';
        document.getElementById('profileBio').value = profile.bio || '';
        currentUserName = profile.name || 'Student';
    }
    initDailyGoalInput();

}

// ========== MOTIVATIONAL QUOTES ==========
function loadMotivationalQuote() {
    const randomQuote = inspiringQuotes[Math.floor(Math.random() * inspiringQuotes.length)];
    document.getElementById('dailyQuote').textContent = `"${randomQuote.text}"`;
    document.getElementById('quoteAuthor').textContent = `â€” ${randomQuote.author}`;
}

// ========== TIME OF DAY THEMING + GREETING ==========
function getTimeGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return "Good morning! Ready to grind?";
    if (hour >= 12 && hour < 18) return "Good afternoon! Keep the momentum going.";
    if (hour >= 18 && hour < 22) return "Good evening! Time to make progress.";
    return "Late night study session?";
}

function isDaytime() {
    const hour = new Date().getHours();
    return hour >= 6 && hour < 18;
}

function updateTimeGreeting() {
    const el = document.getElementById('timeGreeting');
    if (el) el.textContent = getTimeGreeting();
}

function applyTimeTheme() {
    const savedTheme = localStorage.getItem('studentTheme') || 'light';
    if (savedTheme !== 'light' && savedTheme !== 'dark') return;
    const nextTheme = isDaytime() ? 'light' : 'dark';
    if (savedTheme !== nextTheme) {
        document.body.className = nextTheme;
        localStorage.setItem('studentTheme', nextTheme);
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = nextTheme;
    }
}

function newQuote() {
    loadMotivationalQuote();
    showNotification("New inspiration loaded! ðŸ’«", "info");
}

// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'ðŸ’¡';
    if (type === 'success') icon = 'âœ…';
    if (type === 'error') icon = 'âŒ';
    if (type === 'warning') icon = 'âš ï¸';
    if (type === 'info') icon = 'â„¹ï¸';
    
    toast.innerHTML = `
        <span style="font-size: 1.5rem;">${icon}</span>
        <div style="flex: 1;">
            <div style="font-weight: 700;">${message}</div>
            <div style="font-size: 0.875rem; opacity: 0.8;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

function updateSyncStatus(text, type = "info") {
    const syncStatus = document.getElementById('syncStatus');
    const syncIcon = syncStatus.querySelector('.sync-icon');
    const syncText = syncStatus.querySelector('.sync-text');
    
    if (!syncStatus) return;
    
    syncStatus.style.display = 'flex';
    syncStatus.className = `sync-status ${type}`;
    syncText.textContent = text;
    
    let icon = 'â³';
    if (type === 'success') icon = 'âœ…';
    if (type === 'error') icon = 'âŒ';
    if (type === 'warning') icon = 'âš ï¸';
    if (type === 'info') icon = 'â„¹ï¸';
    
    syncIcon.textContent = icon;
    
    if (type === 'success') {
        setTimeout(() => {
            syncStatus.style.opacity = '0';
            setTimeout(() => {
                syncStatus.style.display = 'none';
                syncStatus.style.opacity = '1';
            }, 300);
        }, 2000);
    }
}

// ========== THEME MANAGEMENT ==========
function changeTheme(theme) {
    const current = localStorage.getItem('studentTheme') || 'light';
    const referrals = getReferralCount();
    if (theme === 'premium' && referrals < REFERRAL_TARGET) {
        document.body.className = 'premium';
        openReferralModal();
        return;
    }
    if (theme === 'forest' && (studyData.streak || 0) < 7 && localStorage.getItem(FOREST_UNLOCKED_KEY) !== 'true') {
        previewForestTheme();
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = current;
        return;
    }
    if (theme === 'rainbow' && (studyData.streak || 0) < 30) {
        previewRainbowTheme();
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = current;
        return;
    } else {
        document.body.className = theme;
    }
    localStorage.setItem('studentTheme', theme);
    
    // Recreate charts with new theme colors
    if (currentSection === 'statistics') {
        setTimeout(updateCharts, 100);
    }
    
    showNotification(`Switched to ${theme} theme`, "success");
}

// ========== DATA IMPORT/EXPORT ==========
function exportData() {
    const allData = {
        exportDate: new Date().toISOString(),
        version: "2.5",
        user: {
            id: currentUserId,
            name: currentUserName,
            classes: userClasses
        },
        studyData: studyData,
        tasks: tasks,
        assignments: assignments,
        profile: JSON.parse(localStorage.getItem('studentProfile') || '{}')
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `student-data-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("All data exported successfully", "success");
}

function clearAllData() {
    if (confirm("âš ï¸ This will delete ALL your data including tasks, assignments, study history, and profile. This cannot be undone! Continue?")) {
        localStorage.removeItem('studentPersistentData');
        localStorage.removeItem('studentTasks');
        localStorage.removeItem('studentAssignments');
        localStorage.removeItem('studentStudyData');
        localStorage.removeItem('studentProfile');
        localStorage.removeItem('studentUserClasses');
        localStorage.removeItem('studentUserId');
        localStorage.removeItem('studentName');
        localStorage.removeItem('studentTheme');
        
        tasks = [];
        assignments = [];
        studyData = {
            streak: 0,
            lastStudyDate: "",
            totalMinutes: 0,
            totalStudyDays: 0,
            totalStudyHours: 0,
            studySessions: [],
            weeklyPattern: [0, 0, 0, 0, 0, 0, 0],
            streakHistory: [],
            streakMilestones: [3, 7, 14, 30, 60, 90],
            currentMilestone: 0,
            dailyStats: [],
            focusScores: [],
            consistencyScores: []
        };
        userClasses = [];
        currentClassCode = null;
        selectedClassIndex = -1;
        currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        currentUserName = 'Student';
        
        document.getElementById('studentName').value = '';
        document.getElementById('studentEmail').value = '';
        document.getElementById('studentBio').value = '';
        document.getElementById('profileName').value = '';
        document.getElementById('profileEmail').value = '';
        document.getElementById('profileBio').value = '';
        document.getElementById('hoursInput').value = '';
        
        localStorage.setItem('studentUserId', currentUserId);
        
        loadAllData();
        updateAllStatistics();
        
        showNotification("All data cleared", "info");
    }
}

// ========== AUTOSAVE AND REFRESH ==========
function refreshData() {
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = 'ðŸ”„ Refreshing...';
    refreshBtn.disabled = true;
    
    loadAllData();
    updateAllStatistics();
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showNotification("All data refreshed", "success");
    }, 1000);
}
// ========== FEEDBACK FORM ==========
function openFeedbackForm() {
    window.open('https://docs.google.com/forms/d/e/1FAIpQLScJMM1dwIx3HvSu9mxyZm3HgZ7UO7QwLX673JKellaKLSM7EQ/viewform?usp=publish-editor', '_blank');
}

// ========== STREAK SHARE (capture full streak card) ==========
async function captureStreakCard() {
    const card = document.querySelector('.streak-card');
    if (!card) throw new Error('Streak card not found');

    const canvas = await html2canvas(card, {
        backgroundColor: null,
        scale: 2
    });

    return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), 'image/png', 1.0);
    });
}

// Placeholder: replace with work.ink shortener once you provide endpoint/token
async function shortenUrl(longUrl) {
    return longUrl;
}

async function shareStreak() {
    const msg = document.getElementById('streakShareMsg');
    const shareBtn = document.getElementById('shareStreakBtn');

    if (!msg || !shareBtn) return;

    showNotification("Generating your streak imageâ€¦ please wait", "info");
    msg.textContent = 'Generating your streak image...';
    shareBtn.disabled = true;

    try {
        const card = document.querySelector('.streak-card');
        if (!card) throw new Error('Streak card not found');

        const canvas = await html2canvas(card, { backgroundColor: null, scale: 2 });
        const dataUrl = canvas.toDataURL('image/png');

        await navigator.clipboard.writeText(dataUrl);

        showNotification("URL copied! Paste it into a browser or chat to share.", "success");
        msg.textContent = 'URL copied! Paste into a browser or message.';
    } catch (err) {
        console.error(err);
        showNotification("Could not generate URL. Try again.", "error");
        msg.textContent = 'Could not generate the URL. Try again.';
    } finally {
        shareBtn.disabled = false;
    }
}



document.addEventListener('DOMContentLoaded', () => {
    const shareBtn = document.getElementById('shareStreakBtn');
    if (shareBtn) shareBtn.addEventListener('click', shareStreak);
});


// ========== INITIALIZATION COMPLETE ==========
console.log("âœ… Student Mode initialized successfully!");
// Add to all pages (guard analytics when SDK isn't loaded)
if (firebase.analytics) {
  firebase.analytics().logEvent('page_view', { page_location: window.location.href });
}



// Function to load memory wall for students
function loadStudentMemoryWall() {
    if (!currentClassCode) return;
    
    try {
        database.ref(`memoryWall/${currentClassCode}`).on('value', (snapshot) => {
            const memoriesContainer = document.getElementById('studentMemoryWall');
            if (!memoriesContainer) return;
            
            if (snapshot.exists()) {
                const memories = [];
                snapshot.forEach(child => {
                    memories.push(child.val());
                });
                
                // Sort by date (newest first)
                memories.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render memories
                memoriesContainer.innerHTML = memories.map(memory => `
                    <div class="memory-card">
                        <div class="memory-text">${memory.text}</div>
                        <div class="memory-footer">
                            <span class="memory-author">ðŸ‘¤ ${memory.author}</span>
                            <span class="memory-date">${getTimeAgo(memory.createdAt)}</span>
                        </div>
                        <button class="btn-like" onclick="likeMemoryAsStudent('${memory.id}')">
                            ðŸ‘ ${memory.likes || 0}
                        </button>
                    </div>
                `).join('');
            }
        });
    } catch (error) {
        console.error("Error loading memory wall for students:", error);
    }
}





// Student Mode Memory Wall Functions
let studentSelectedNoteColor = '#FFEB3B';
let studentMemoryWallNotes = [];

// Load memory wall for students
function loadStudentMemoryWall() {
    if (!currentClassCode) return;
    
    try {
        database.ref(`memoryWall/${currentClassCode}/notes`).on('value', (snapshot) => {
            if (snapshot.exists()) {
                studentMemoryWallNotes = [];
                snapshot.forEach(child => {
                    studentMemoryWallNotes.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                renderStudentStickyNotes();
            } else {
                studentMemoryWallNotes = [];
                renderStudentStickyNotes();
            }
        });
    } catch (error) {
        console.error("Error loading memory wall for student:", error);
        studentMemoryWallNotes = [];
        renderStudentStickyNotes();
    }
}

// Toggle add memory form for students
function studentToggleAddMemoryForm() {
    const form = document.getElementById('studentAddMemoryForm');
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        document.getElementById('studentMemoryText').focus();
        
        // Set up character count
        const textarea = document.getElementById('studentMemoryText');
        const charCount = document.getElementById('studentMemoryCharCount');
        
        textarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            
            if (length > 300) {
                this.value = this.value.substring(0, 300);
                charCount.textContent = '300';
                charCount.style.color = 'var(--danger)';
            } else {
                charCount.style.color = 'var(--text-muted)';
            }
        });
        
        // Set student name if available
        const studentName = localStorage.getItem('studentName') || 'Student';
        document.getElementById('studentMemoryAuthor').value = studentName;
    } else {
        form.style.display = 'none';
    }
}

// Student select note color
function studentSelectNoteColor(color) {
    studentSelectedNoteColor = color;
    
    // Update selected state
    document.querySelectorAll('#studentAddMemoryForm .color-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.color === color) {
            option.classList.add('selected');
        }
    });
}

// Student add memory
function studentAddMemoryFromForm() {
    const text = document.getElementById('studentMemoryText').value.trim();
    const author = document.getElementById('studentMemoryAuthor').value.trim() || 'Student';
    
    if (!text) {
        showNotification("Please write something for your memory note!", "error");
        return;
    }
    
    // Get student ID
    const studentId = localStorage.getItem('studentUserId') || 'student_' + Date.now();
    
    // Create new note
    const note = {
        id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        text: text,
        author: author,
        color: studentSelectedNoteColor,
        x: Math.random() * 70 + 10,
        y: Math.random() * 70 + 10,
        rotation: (Math.random() * 8) - 4,
        likes: 0,
        likedBy: [],
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        studentId: studentId,
        isStudentNote: true
    };
    
    try {
        const noteRef = database.ref(`memoryWall/${currentClassCode}/notes`).push();
        note.id = noteRef.key;
        
        noteRef.set(note)
            .then(() => {
                showNotification("Your memory has been added to the wall! ðŸ“", "success");
                
                // Clear form
                document.getElementById('studentMemoryText').value = '';
                document.getElementById('studentMemoryCharCount').textContent = '0';
                studentToggleAddMemoryForm();
            })
            .catch(error => {
                console.error("Error saving student note:", error);
                showNotification("Failed to save note: " + error.message, "error");
            });
    } catch (error) {
        console.error("Error saving student note:", error);
        showNotification("Error saving note", "error");
    }
}

// Render student sticky notes
function renderStudentStickyNotes() {
    const container = document.getElementById('studentStickyNotesContainer');
    if (!container) return;
    
    // Clear container
    container.innerHTML = '';
    
    if (studentMemoryWallNotes.length === 0) {
        // Show welcome message
        const welcomeNote = document.createElement('div');
        welcomeNote.className = 'sticky-note welcome';
        welcomeNote.style.position = 'absolute';
        welcomeNote.style.top = '50%';
        welcomeNote.style.left = '50%';
        welcomeNote.style.transform = 'translate(-50%, -50%) rotate(-1deg)';
        welcomeNote.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        welcomeNote.style.color = 'white';
        welcomeNote.style.width = '300px';
        welcomeNote.style.textAlign = 'center';
        
        welcomeNote.innerHTML = `
            <div class="note-content">
                <div class="note-text">Welcome to our Class Memory Wall! ðŸŽ‰<br><br>Share memories, achievements, or encouraging words!</div>
                <div class="note-meta">
                    <span class="note-author">ðŸ‘¨â€ðŸ« Teacher</span>
                </div>
            </div>
        `;
        
        container.appendChild(welcomeNote);
        return;
    }
    
    // Create each sticky note
    studentMemoryWallNotes.forEach(note => {
        const noteElement = createStudentStickyNoteElement(note);
        container.appendChild(noteElement);
    });
}

// Create student sticky note element
// In your createStudentStickyNoteElement() function
function createStudentStickyNoteElement(note) {
    try {
        const noteElement = document.createElement('div');
        noteElement.className = 'student-sticky-note';
        noteElement.id = `student-note-${note.id}`;
        
        // Apply note properties
        noteElement.style.background = note.color || '#FFEB3B';
        noteElement.style.left = `${note.x || 20}%`;
        noteElement.style.top = `${note.y || 20}%`;
        noteElement.style.transform = `rotate(${note.rotation || 0}deg)`;
        noteElement.style.zIndex = '2';
        
        // ADD THIS: Force dark text on light backgrounds
        const isLightColor = [
            '#FFEB3B', '#FFF9C4', '#C8E6C9', '#BBDEFB', 
            '#E1BEE7', '#FFCCBC', '#FFFFFF'
        ].some(color => (note.color || '').toUpperCase().includes(color));
        
        if (isLightColor) {
            noteElement.style.color = '#333';
        }
        
        // Format date
        const date = new Date(note.createdAt || Date.now());
        const timeAgo = getTimeAgo(note.createdAt);
        
        // Create note content
        noteElement.innerHTML = `
            <div class="student-note-content">
                <div class="student-note-text" style="color: inherit;">
                    ${escapeHtml(note.text || '')}
                </div>
                <div class="student-note-meta" style="color: inherit;">
                    <div class="student-note-author" style="color: inherit;">
                        ðŸ‘¤ ${escapeHtml(note.author || 'Anonymous')}
                        ${note.isStudentNote ? ' ðŸ‘¨â€ðŸŽ“' : ''}
                    </div>
                    <div class="student-note-date" style="color: inherit;" title="${date.toLocaleString()}">
                        ${timeAgo}
                    </div>
                </div>
                <div class="student-note-actions">
                    <div class="student-note-likes" style="color: inherit;">
                        <span>ðŸ‘</span>
                        <span>${note.likes || 0}</span>
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn-student-note btn-like" onclick="studentLikeNote('${note.id}', event)" style="color: #e63946;">
                        ðŸ‘
                    </button>
                </div>
            </div>
        `;
        
        // Add drag functionality
        setupStudentNoteDragging(noteElement, note);
        
        return noteElement;
    } catch (error) {
        console.error("Error creating student sticky note:", error, note);
        return null;
    }
}
// Setup student note dragging (temporary drag, doesn't save)
function setupStudentNoteDragging(noteElement) {
    let isDragging = false;
    let startX, startY;
    
    noteElement.addEventListener('mousedown', startDrag);
    noteElement.addEventListener('touchstart', startDragTouch);
    
    function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        startX = e.clientX - noteElement.offsetLeft;
        startY = e.clientY - noteElement.offsetTop;
        
        noteElement.classList.add('dragging');
        noteElement.style.zIndex = '1000';
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
    }
    
    function startDragTouch(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (e.touches.length === 1) {
            isDragging = true;
            const touch = e.touches[0];
            startX = touch.clientX - noteElement.offsetLeft;
            startY = touch.clientY - noteElement.offsetTop;
            
            noteElement.classList.add('dragging');
            noteElement.style.zIndex = '1000';
            
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', stopDragTouch);
        }
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        let newX = e.clientX - startX - whiteboardRect.left;
        let newY = e.clientY - startY - whiteboardRect.top;
        
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
    }
    
    function dragTouch(e) {
        if (!isDragging || e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        let newX = touch.clientX - startX - whiteboardRect.left;
        let newY = touch.clientY - startY - whiteboardRect.top;
        
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        noteElement.classList.remove('dragging');
        noteElement.style.zIndex = '2';
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
    }
    
    function stopDragTouch() {
        if (!isDragging) return;
        
        isDragging = false;
        noteElement.classList.remove('dragging');
        noteElement.style.zIndex = '2';
        
        document.removeEventListener('touchmove', dragTouch);
        document.removeEventListener('touchend', stopDragTouch);
    }
}

// Student like note
function studentLikeNote(noteId, event) {
    if (event) event.stopPropagation();
    
    const note = studentMemoryWallNotes.find(n => n.id === noteId);
    if (!note) return;
    
    // Get student ID
    const studentId = localStorage.getItem('studentUserId');
    if (!studentId) {
        showNotification("Please log in to like notes", "error");
        return;
    }
    
    // Check if already liked
    if (note.likedBy && note.likedBy.includes(studentId)) {
        showNotification("You already liked this note!", "info");
        return;
    }
    
    // Update in Firebase
    const newLikes = (note.likes || 0) + 1;
    const newLikedBy = [...(note.likedBy || []), studentId];
    
    database.ref(`memoryWall/${currentClassCode}/notes/${noteId}`).update({
        likes: newLikes,
        likedBy: newLikedBy
    })
    .then(() => {
        // Update UI
        note.likes = newLikes;
        note.likedBy = newLikedBy;
        
        const noteElement = document.getElementById(`student-note-${noteId}`);
        if (noteElement) {
            const likesSpan = noteElement.querySelector('.note-likes span:last-child');
            if (likesSpan) {
                likesSpan.textContent = newLikes;
            }
        }
        
        showNotification("Liked! ðŸ‘", "success");
    })
    .catch(error => {
        console.error("Error liking note:", error);
        showNotification("Failed to like note", "error");
    });
}





// Add this to your student mode navigation
// Memory Wall Navigation - Fixed
function showStudentMemoryWall() {
    console.log("ðŸ“ Showing student memory wall");
    
    // Hide all sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show memory wall
    const memoryWallSection = document.getElementById('studentMemoryWall');
    if (memoryWallSection) {
        memoryWallSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent.includes('ðŸ“ Memory Wall')) {
                item.classList.add('active');
            }
        });
        
        // Load memory wall data
        loadStudentMemoryWall();
    } else {
        console.error("Memory wall section not found!");
        showNotification("Memory wall feature not available", "error");
        showSection('dashboard'); // Fallback
    }
}








// Student Mode Memory Wall Navigation
let studentSelectedAddMemoryColor = '#FFEB3B';

// Show student memory wall
function showStudentMemoryWall() {
    // Hide other sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show student memory wall
    document.getElementById('studentMemoryWall').style.display = 'block';
    
    // Load memory wall data
    loadStudentMemoryWall();
}

// Show student add memory page
function showStudentAddMemoryPage() {
    document.getElementById('studentMemoryWall').style.display = 'none';
    document.getElementById('studentAddMemoryPage').style.display = 'block';
    
    // Reset form
    document.getElementById('studentAddMemoryText').value = '';
    document.getElementById('studentAddMemoryCharCount').textContent = '0';
    document.getElementById('studentAddMemoryPreviewText').textContent = 'Your memory will appear here...';
    
    // Set student name
    const studentName = localStorage.getItem('studentName') || 'Student';
    document.getElementById('studentAddMemoryAuthor').value = studentName;
    document.getElementById('studentAddMemoryPreviewAuthor').textContent = studentName;
    
    // Reset color
    studentSelectAddMemoryColor('#FFEB3B');
    
    // Setup preview
    setupStudentMemoryPreview();
}

// Go back to student memory wall
function studentBackToMemoryWall() {
    document.getElementById('studentAddMemoryPage').style.display = 'none';
    document.getElementById('studentMemoryWall').style.display = 'block';
}

// Student select color
function studentSelectAddMemoryColor(color) {
    studentSelectedAddMemoryColor = color;
    
    document.querySelectorAll('#studentAddMemoryPage .color-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.color === color) {
            option.classList.add('selected');
        }
    });
    
    document.getElementById('studentAddMemoryPreview').style.background = color;
}

// Setup student memory preview
function setupStudentMemoryPreview() {
    const textInput = document.getElementById('studentAddMemoryText');
    const authorInput = document.getElementById('studentAddMemoryAuthor');
    const charCount = document.getElementById('studentAddMemoryCharCount');
    
    textInput.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = length;
        
        document.getElementById('studentAddMemoryPreviewText').textContent = 
            this.value || 'Your memory will appear here...';
        
        if (length > 300) {
            this.value = this.value.substring(0, 300);
            charCount.textContent = '300';
            charCount.style.color = 'var(--danger)';
        } else {
            charCount.style.color = 'var(--text-muted)';
        }
    });
    
    authorInput.addEventListener('input', function() {
        const author = this.value.trim() || 'Student';
        document.getElementById('studentAddMemoryPreviewAuthor').textContent = author;
    });
}

// Student submit memory
function studentSubmitMemory() {
    const text = document.getElementById('studentAddMemoryText').value.trim();
    const author = document.getElementById('studentAddMemoryAuthor').value.trim() || 'Student';
    const studentId = localStorage.getItem('studentUserId') || 'student_' + Date.now();
    
    if (!text) {
        showNotification("Please write something for your memory note!", "error");
        return;
    }
    
    if (text.length < 10) {
        showNotification("Please write a bit more (at least 10 characters)", "warning");
        return;
    }
    
    const note = {
        id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        text: text,
        author: author,
        color: studentSelectedAddMemoryColor,
        x: Math.random() * 70 + 10,
        y: Math.random() * 70 + 10,
        rotation: (Math.random() * 8) - 4,
        likes: 0,
        likedBy: [],
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        isTeacherNote: false,
        studentId: studentId,
        isStudentNote: true
    };
    
    try {
        const noteRef = database.ref(`memoryWall/${currentClassCode}/notes`).push();
        note.id = noteRef.key;
        
        noteRef.set(note)
            .then(() => {
                showNotification("Your memory has been added to the wall! ðŸ“", "success");
                studentBackToMemoryWall();
            })
            .catch(error => {
                console.error("Error saving student note:", error);
                showNotification("Failed to save note: " + error.message, "error");
            });
    } catch (error) {
        console.error("Error saving student note:", error);
        showNotification("Error saving note", "error");
    }
}








// Replace the existing showStudentMemoryWall function with this:
function showStudentMemoryWall() {
    // Hide other sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show student memory wall
    const memoryWallSection = document.getElementById('studentMemoryWall');
    if (memoryWallSection) {
        memoryWallSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent.includes('ðŸ“ Memory Wall')) {
                item.classList.add('active');
            }
        });
        
        // Load memory wall data
        loadStudentMemoryWall();
    } else {
        console.error("Student memory wall section not found!");
    }
}

// Add student memory wall loading function
function loadStudentMemoryWall() {
    if (!currentClassCode) {
        showNotification("Please join a class first", "error");
        return;
    }
    
    try {
        database.ref(`memoryWall/${currentClassCode}/notes`).on('value', (snapshot) => {
            if (snapshot.exists()) {
                studentMemoryWallNotes = [];
                snapshot.forEach(child => {
                    studentMemoryWallNotes.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                renderStudentStickyNotes();
                updateStudentMemoryWallStats();
            } else {
                studentMemoryWallNotes = [];
                renderStudentStickyNotes();
            }
        });
    } catch (error) {
        console.error("Error loading memory wall for student:", error);
    }
}

// Student render sticky notes

// Student memory wall stats
function updateStudentMemoryWallStats() {
    const totalNotes = studentMemoryWallNotes.length;
    const totalLikes = studentMemoryWallNotes.reduce((sum, note) => sum + (note.likes || 0), 0);
    const studentNotes = studentMemoryWallNotes.filter(note => note.isStudentNote).length;
    
    const totalEl = document.getElementById('studentTotalNotesCount');
    const likesEl = document.getElementById('studentTotalLikesCount');
    const studentEl = document.getElementById('studentNotesCount');
    
    if (totalEl) totalEl.textContent = totalNotes;
    if (likesEl) likesEl.textContent = totalLikes;
    if (studentEl) studentEl.textContent = studentNotes;
}





// COMPLETE Student Sticky Notes Renderer
function renderStudentStickyNotes() {
    const container = document.getElementById('studentStickyNotesContainer');
    if (!container) {
        console.error("Student sticky notes container not found!");
        return;
    }
    
    // Clear container
    container.innerHTML = '';
    
    if (!studentMemoryWallNotes || studentMemoryWallNotes.length === 0) {
        // Show welcome message for student
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (whiteboard) {
            const welcomeNote = document.createElement('div');
            welcomeNote.className = 'student-welcome-note';
            
            welcomeNote.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ðŸŽ‰</div>
                <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: var(--spacing-sm);">
                    Welcome to the Class Memory Wall!
                </div>
                <div style="line-height: 1.5; opacity: 0.9;">
                    Be the first to share a memory, achievement, or encouraging word!
                </div>
            `;
            
            whiteboard.appendChild(welcomeNote);
        }
        updateStudentMemoryWallStats();
        return;
    }
    
    // Remove any existing welcome note
    const welcomeNote = document.querySelector('.student-welcome-note');
    if (welcomeNote) {
        welcomeNote.remove();
    }
    
    // Create each sticky note
    studentMemoryWallNotes.forEach(note => {
        const noteElement = createStudentStickyNoteElement(note);
        if (noteElement) {
            container.appendChild(noteElement);
        }
    });
    
    updateStudentMemoryWallStats();
}

// Create individual student sticky note element
function createStudentStickyNoteElement(note) {
    try {
        const noteElement = document.createElement('div');
        noteElement.className = 'student-sticky-note';
        noteElement.id = `student-note-${note.id}`;
        
        // Apply note properties
        noteElement.style.background = note.color || '#FFEB3B';
        noteElement.style.left = `${note.x || 20}%`;
        noteElement.style.top = `${note.y || 20}%`;
        noteElement.style.transform = `rotate(${note.rotation || 0}deg)`;
        noteElement.style.zIndex = '2';
        
        // Format date
        const date = new Date(note.createdAt || Date.now());
        const timeAgo = getTimeAgo(note.createdAt);
        
        // Create note content
        noteElement.innerHTML = `
            <div class="student-note-content">
                <div class="student-note-text">
                    ${escapeHtml(note.text || '')}
                </div>
                <div class="student-note-meta">
                    <div class="student-note-author">
                        ðŸ‘¤ ${escapeHtml(note.author || 'Anonymous')}
                        ${note.isStudentNote ? ' ðŸ‘¨â€ðŸŽ“' : ''}
                    </div>
                    <div class="student-note-date" title="${date.toLocaleString()}">
                        ${timeAgo}
                    </div>
                </div>
                <div class="student-note-actions">
                    <div class="student-note-likes">
                        <span>ðŸ‘</span>
                        <span>${note.likes || 0}</span>
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn-student-note btn-like" onclick="studentLikeNote('${note.id}', event)">
                        ðŸ‘
                    </button>
                </div>
            </div>
        `;
        
        // Add drag functionality for students
        setupStudentNoteDragging(noteElement, note);
        
        return noteElement;
    } catch (error) {
        console.error("Error creating student sticky note:", error, note);
        return null;
    }
}

// Setup dragging for student notes
function setupStudentNoteDragging(noteElement, note) {
    let isDragging = false;
    let startX, startY, initialX, initialY;
    
    const startDrag = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
        } else {
            startX = e.clientX;
            startY = e.clientY;
        }
        
        // Get current position
        const rect = noteElement.getBoundingClientRect();
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (!whiteboard) return;
        
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        initialX = rect.left - whiteboardRect.left;
        initialY = rect.top - whiteboardRect.top;
        
        noteElement.classList.add('dragging');
        noteElement.style.zIndex = '1000';
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', dragTouch);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDragTouch);
    };
    
    const drag = (e) => {
        if (!isDragging) return;
        
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (!whiteboard) return;
        
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        const currentX = e.clientX;
        const currentY = e.clientY;
        
        const deltaX = currentX - startX;
        const deltaY = currentY - startY;
        
        let newX = initialX + deltaX;
        let newY = initialY + deltaY;
        
        // Convert to percentages
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        // Keep within bounds
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
        
        // Update note data
        note.x = boundedX;
        note.y = boundedY;
    };
    
    const dragTouch = (e) => {
        if (!isDragging || e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (!whiteboard) return;
        
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        const currentX = touch.clientX;
        const currentY = touch.clientY;
        
        const deltaX = currentX - startX;
        const deltaY = currentY - startY;
        
        let newX = initialX + deltaX;
        let newY = initialY + deltaY;
        
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
        
        note.x = boundedX;
        note.y = boundedY;
    };
    
    const stopDrag = () => {
        if (!isDragging) return;
        
        isDragging = false;
        noteElement.classList.remove('dragging');
        noteElement.style.zIndex = '2';
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', dragTouch);
        document.removeEventListener('touchend', stopDragTouch);
        
        // Save position (students can only drag temporarily, not save)
        // Note: Student dragging is temporary, positions aren't saved to Firebase
    };
    
    const stopDragTouch = () => {
        stopDrag();
    };
    
    // Add event listeners
    noteElement.addEventListener('mousedown', startDrag);
    noteElement.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrag(e);
    }, { passive: false });
}

// Helper function for time ago
function getTimeAgo(dateString) {
    if (!dateString) return 'Recently';
    
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Recently';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    if (diffMinutes < 1) return 'Just now';
    if (diffMinutes < 60) return `${diffMinutes}m ago`;
    
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Escape HTML helper
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

// Update student memory wall stats
function updateStudentMemoryWallStats() {
    if (!studentMemoryWallNotes) {
        studentMemoryWallNotes = [];
    }
    
    const totalNotes = studentMemoryWallNotes.length;
    const totalLikes = studentMemoryWallNotes.reduce((sum, note) => sum + (note.likes || 0), 0);
    
    // Count student's own notes
    const studentId = localStorage.getItem('studentUserId');
    const studentNotes = studentId ? 
        studentMemoryWallNotes.filter(note => note.studentId === studentId).length : 
        0;
    
    const totalEl = document.getElementById('studentTotalNotesCount');
    const likesEl = document.getElementById('studentTotalLikesCount');
    const studentEl = document.getElementById('studentNotesCount');
    
    if (totalEl) totalEl.textContent = totalNotes;
    if (likesEl) likesEl.textContent = totalLikes;
    if (studentEl) studentEl.textContent = studentNotes;
}

// Refresh student memory wall
function refreshStudentMemoryWall() {
    loadStudentMemoryWall();
    showNotification("Memory wall refreshed", "info");
}

// Load student memory wall data
function loadStudentMemoryWall() {
    if (!currentClassCode) {
        showNotification("Please join a class first", "error");
        return;
    }
    
    console.log("Loading memory wall for class:", currentClassCode);
    
    try {
        // First clear existing data
        studentMemoryWallNotes = [];
        
        // Listen for memory wall changes
        const memoryWallRef = database.ref(`memoryWall/${currentClassCode}/notes`);
        
        memoryWallRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                const notes = [];
                snapshot.forEach(child => {
                    const noteData = child.val();
                    notes.push({
                        id: child.key,
                        ...noteData
                    });
                });
                
                studentMemoryWallNotes = notes;
                console.log("Loaded", studentMemoryWallNotes.length, "notes");
                renderStudentStickyNotes();
            } else {
                studentMemoryWallNotes = [];
                renderStudentStickyNotes();
                console.log("No memory wall notes found");
            }
        }, (error) => {
            console.error("Error loading memory wall:", error);
            showNotification("Error loading memory wall", "error");
        });
        
    } catch (error) {
        console.error("Error setting up memory wall listener:", error);
        showNotification("Error connecting to memory wall", "error");
    }
}
</script>
<div id="confettiLayer" aria-hidden="true"></div>
<div id="premiumSparkleLayer" class="premium-sparkle-layer" aria-hidden="true"></div>

</body>
</html>

