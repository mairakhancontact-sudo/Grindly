<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grindly | Quest System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ===== QUEST SYSTEM STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0f1f;
            --card: #151e2f;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #2a3548;
            --accent: #4f46e5;
            --rpg-gold: #fbbf24;
            --rpg-silver: #94a3b8;
            --rpg-health: #ef4444;
            --rpg-mana: #3b82f6;
            --rpg-xp: #f59e0b;
            --rpg-legendary: #f97316;
            --rpg-epic: #a855f7;
            --rpg-rare: #3b82f6;
            --rpg-uncommon: #22c55e;
            --rpg-common: #64748b;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .quest-header {
            background: linear-gradient(135deg, var(--card), #0f172a);
            border: 3px solid var(--rpg-gold);
            border-radius: 30px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .quest-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--rpg-gold);
            text-shadow: 2px 2px 0 #000;
        }

        .back-btn {
            background: var(--rpg-gold);
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(251,191,36,0.3);
        }

        /* Game Master Panel */
        .game-master-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
            z-index: 1000;
            pointer-events: none;
            max-width: 350px;
        }

        .gm-bubble {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 3px solid var(--rpg-gold);
            border-radius: 20px 20px 5px 20px;
            padding: 1.2rem 1.8rem;
            color: var(--text);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: bubbleAppear 0.3s ease-out;
            position: relative;
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            width: 100%;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .gm-bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            right: 20px;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-right: 3px solid var(--rpg-gold);
            border-bottom: 3px solid var(--rpg-gold);
            transform: rotate(45deg);
            border-radius: 0 0 5px 0;
        }

        .gm-character {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 30px 30px 30px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(251,191,36,0.3);
            border: 3px solid var(--rpg-gold);
            pointer-events: auto;
            animation: gmFloat 3s ease-in-out infinite;
            margin-left: auto;
        }

        @keyframes gmFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); }
        }

        .gm-character:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 15px 40px rgba(251,191,36,0.5);
        }

        @keyframes bubbleAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hero Section */
        .hero-section {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            background: rgba(0,0,0,0.4);
            border-radius: 30px;
            padding: 30px;
            border: 2px solid var(--rpg-gold);
            margin-bottom: 30px;
        }

        .player-card {
            text-align: center;
            background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(0,0,0,0.5));
            border-radius: 20px;
            padding: 20px;
            border: 2px solid var(--rpg-gold);
        }

        .player-avatar {
            font-size: 5rem;
            background: linear-gradient(135deg, var(--rpg-gold), var(--rpg-legendary));
            width: 120px;
            height: 120px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            transform: rotate(5deg);
            box-shadow: 0 0 30px rgba(251,191,36,0.3);
        }

        .player-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--rpg-gold);
            margin-bottom: 5px;
        }

        .player-title {
            font-size: 0.9rem;
            color: var(--rpg-silver);
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border-radius: 30px;
        }

        /* Resource Bars */
        .resource-bars {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .resource-item {
            width: 100%;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .resource-track {
            height: 20px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .resource-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }

        .resource-fill.xp { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .resource-fill.health { background: linear-gradient(90deg, #ef4444, #f87171); }
        .resource-fill.mana { background: linear-gradient(90deg, #3b82f6, #60a5fa); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8));
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--rpg-gold);
        }

        .stat-icon { font-size: 2.5rem; min-width: 60px; text-align: center; }
        .stat-label { font-size: 0.8rem; color: var(--rpg-silver); text-transform: uppercase; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--text); line-height: 1; }
        .stat-bonus { font-size: 0.7rem; color: var(--rpg-gold); }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, var(--rpg-gold), #f59e0b);
            color: black;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Quest Categories */
        .quest-category {
            margin-bottom: 40px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--rpg-gold);
        }

        .category-icon { font-size: 2rem; animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .category-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--rpg-gold);
        }

        .category-badge {
            margin-left: auto;
            background: var(--rpg-gold);
            color: black;
            padding: 5px 20px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Quest Cards */
        .quest-card {
            background: linear-gradient(135deg, rgba(30,40,60,0.9), rgba(20,30,50,0.95));
            border: 2px solid;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .quest-card:hover { transform: translateX(10px); }

        .quest-card.common { border-color: var(--rpg-common); }
        .quest-card.uncommon { border-color: var(--rpg-uncommon); }
        .quest-card.rare { border-color: var(--rpg-rare); }
        .quest-card.epic { border-color: var(--rpg-epic); }
        .quest-card.legendary { border-color: var(--rpg-legendary); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px var(--rpg-legendary); }
            50% { box-shadow: 0 0 40px var(--rpg-legendary); }
        }

        .quest-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .quest-icon {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
        }

        .quest-info { flex: 1; }
        .quest-name { font-size: 1.3rem; font-weight: 700; color: var(--text); }
        .quest-meta { display: flex; gap: 15px; align-items: center; }

        .quest-rarity {
            padding: 3px 15px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .quest-rarity.common { background: var(--rpg-common); color: black; }
        .quest-rarity.uncommon { background: var(--rpg-uncommon); color: black; }
        .quest-rarity.rare { background: var(--rpg-rare); color: white; }
        .quest-rarity.epic { background: var(--rpg-epic); color: white; }
        .quest-rarity.legendary { background: var(--rpg-legendary); color: white; }

        .quest-xp { color: var(--rpg-xp); font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .quest-description { color: var(--rpg-silver); margin-bottom: 15px; padding-left: 80px; }

        .quest-rewards {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            padding-left: 80px;
            flex-wrap: wrap;
        }

        .reward-chip {
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--rpg-gold);
            border-radius: 30px;
            padding: 5px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--rpg-gold);
        }

        .quest-progress {
            margin: 15px 0;
            padding-left: 80px;
        }

        .progress-track {
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--rpg-gold), var(--rpg-legendary));
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .quest-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding-left: 80px;
        }

        .quest-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quest-btn.claim {
            background: linear-gradient(135deg, var(--rpg-gold), #f59e0b);
            color: black;
        }

        .quest-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--card), #0f172a);
            border: 2px solid var(--rpg-gold);
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
            background: rgba(0,0,0,0.3);
            border-radius: 30px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quest-description,
            .quest-rewards,
            .quest-progress,
            .quest-actions {
                padding-left: 0;
            }
            
            .game-master-panel {
                bottom: 20px;
                right: 20px;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="quest-header">
            <div class="quest-title">üéÆ RPG QUEST SYSTEM</div>
            <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>
        </div>
        
        <div id="questContent">
            <div class="loading">Loading quest data...</div>
        </div>
    </div>

    <!-- Game Master Panel -->
    <div class="game-master-panel" id="gameMasterPanel">
        <div class="gm-bubble" id="gmBubble">
            üßô‚Äç‚ôÇÔ∏è Greetings, Adventurer! I track your REAL study data. Click me for tips!
        </div>
        <div class="gm-character" id="gmCharacter" onclick="gmClick()">
            üßô‚Äç‚ôÇÔ∏è
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script>
        // ===== QUEST SYSTEM WITH GAME MASTER =====
        (function() {
            console.log("üéÆ Quest System loaded with Game Master");

            // Game Master Messages
            const GM_MESSAGES = {
                welcome: "üßô‚Äç‚ôÇÔ∏è I track your REAL study data! Every task, hour, and streak is recorded!",
                xp: "‚ú® You have {{xp}} XP. Need {{xpNeeded}} more for level {{nextLevel}}!",
                health: "‚ù§Ô∏è Health based on your consistency. Currently {{health}}/{{maxHealth}}!",
                mana: "üíô Mana = {{mana}}/{{maxMana}}. Earned from focus sessions!",
                stats: "üìä STR:{{str}} ({{tasks}} tasks), INT:{{int}} ({{hours}} hrs), WIS:{{wis}} ({{streak}} streak), LUK:{{luk}}",
                daily: "üìÖ {{dailyDone}}/{{dailyTotal}} daily quests done. {{dailyLeft}} left today!",
                weekly: "üìÜ {{weeklyDone}}/{{weeklyTotal}} weekly quests. {{weeklyLeft}} remain this week!",
                legendary: "üåü Completed {{legendaryDone}} legendary quests. {{legendaryLeft}} to go!",
                streak: "üî• Current streak: {{streak}} days. Keep it going!",
                level: "üåü Level {{level}}. {{xp}}/{{xpToNext}} XP to next level!",
                mana_tip: "üíô Mana regenerates over time. Use it for dice rolls!",
                health_tip: "‚ù§Ô∏è Health = {{health}}%. Stay consistent to keep it high!"
            };

            // Constants
            const RPG_STORAGE_KEY = 'studentRpgData';
            const ACHIEVEMENTS_KEY = 'studentEarnedBadges';
            const NOTIFIED_KEY = 'studentNotifiedAchievements';

            const GAME_TITLES = [
                { level: 1, title: 'Novice Adventurer', icon: 'üå±' },
                { level: 3, title: 'Apprentice Scholar', icon: 'üìö' },
                { level: 5, title: 'Skilled Warrior', icon: '‚öîÔ∏è' },
                { level: 7, title: 'Wise Sage', icon: 'üîÆ' },
                { level: 9, title: 'Lucky Rogue', icon: 'üçÄ' },
                { level: 11, title: 'Elite Guardian', icon: 'üõ°Ô∏è' },
                { level: 13, title: 'Mystic Mage', icon: 'üîÆ' },
                { level: 15, title: 'Legendary Hero', icon: 'üåü' },
                { level: 20, title: 'Dragon Slayer', icon: 'üêâ' },
                { level: 25, title: 'Arcane Master', icon: '‚ú®' },
                { level: 30, title: 'Immortal Champion', icon: 'üèÜ' }
            ];

            const DAILY_QUESTS = [
                { id: 'daily_focus', name: 'üßò Focus Warrior', description: 'Complete a focused study session', icon: 'üéØ', xp: 50, requirement: 1, rarity: 'common', stats: { wisdom: 1 } },
                { id: 'daily_tasks', name: '‚öîÔ∏è Task Slayer', description: 'Complete 3 tasks', icon: '‚úì', xp: 60, requirement: 3, rarity: 'uncommon', stats: { strength: 1 } },
                { id: 'daily_streak', name: 'üî• Streak Keeper', description: 'Maintain your study streak', icon: 'üî•', xp: 75, requirement: 1, rarity: 'rare', stats: { luck: 1 } },
                { id: 'daily_hours', name: '‚åõ Time Mage', description: 'Study for 2 hours', icon: '‚åõ', xp: 100, requirement: 2, rarity: 'epic', stats: { intelligence: 1 } }
            ];

            const WEEKLY_QUESTS = [
                { id: 'weekly_streak', name: 'üèÜ Streak Legend', description: 'Maintain a 7-day streak', icon: 'üî•', xp: 500, requirement: 7, rarity: 'epic', stats: { luck: 3, wisdom: 2 } },
                { id: 'weekly_tasks', name: '‚öîÔ∏è Quest Master', description: 'Complete 20 tasks', icon: 'üìú', xp: 400, requirement: 20, rarity: 'epic', stats: { strength: 3, intelligence: 2 } },
                { id: 'weekly_hours', name: '‚è∞ Time Lord', description: 'Study 12 hours', icon: '‚åõ', xp: 600, requirement: 12, rarity: 'legendary', stats: { intelligence: 3, wisdom: 2 } }
            ];

            const LEGENDARY_QUESTS = [
                { id: 'legend_first', name: 'üåü First Steps', description: 'Complete your first quest', icon: 'üå±', xp: 100, requirement: 1, rarity: 'common', stats: { luck: 2 } },
                { id: 'legend_10', name: '‚öîÔ∏è Quest Apprentice', description: 'Complete 10 quests', icon: '‚öîÔ∏è', xp: 250, requirement: 10, rarity: 'uncommon', stats: { strength: 2, intelligence: 2 } },
                { id: 'legend_50', name: 'üëë Quest Warrior', description: 'Complete 50 quests', icon: 'üëë', xp: 600, requirement: 50, rarity: 'rare', stats: { wisdom: 3, luck: 3 } },
                { id: 'legend_100', name: '‚ú® Quest Legend', description: 'Complete 100 quests', icon: '‚ú®', xp: 1200, requirement: 100, rarity: 'epic', stats: { all: 4 } },
                { id: 'legend_streak_30', name: 'üåã Inferno Master', description: 'Achieve a 30-day streak', icon: 'üî•', xp: 2000, requirement: 30, rarity: 'legendary', stats: { all: 5 } }
            ];

            // Load data from localStorage (shared with main app)
            function loadStudyData() {
                try {
                    const data = localStorage.getItem('studentPersistentData');
                    if (data) {
                        return JSON.parse(data);
                    }
                } catch (e) {}
                return { studyData: { streak: 0, totalStudyHours: 0, studySessions: [], dailyStats: [] }, tasks: [] };
            }

            function loadRpgData() {
                try {
                    const saved = localStorage.getItem(RPG_STORAGE_KEY);
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) {}
                
                return {
                    level: 1, xp: 0, xpToNextLevel: 100, totalXP: 0,
                    strength: 5, intelligence: 5, wisdom: 5, luck: 5,
                    health: 100, maxHealth: 100, mana: 50, maxMana: 100,
                    questsCompleted: 0, perfectDays: 0, achievements: [],
                    titles: ['Novice Adventurer'], currentTitle: 'Novice Adventurer',
                    dailyQuests: DAILY_QUESTS.map(q => ({ ...q, progress: 0, completed: false, claimed: false })),
                    weeklyQuests: WEEKLY_QUESTS.map(q => ({ ...q, progress: 0, completed: false, claimed: false })),
                    legendaryQuests: LEGENDARY_QUESTS.map(q => ({ ...q, progress: 0, completed: false, claimed: false })),
                    dailyStreak: 0, lastDailyComplete: null,
                    lastDailyReset: new Date().toDateString(),
                    lastWeeklyReset: getWeekStart()
                };
            }

            function saveRpgData(data) {
                localStorage.setItem(RPG_STORAGE_KEY, JSON.stringify(data));
            }

            function getWeekStart() {
                const d = new Date();
                d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1));
                return d.toDateString();
            }

            function getTodayKey() {
                return new Date().toDateString();
            }

            function collectProgress() {
                const mainData = loadStudyData();
                const studyData = mainData.studyData || {};
                const tasks = mainData.tasks || [];
                
                const today = getTodayKey();
                const todayStats = studyData.dailyStats?.find(s => s?.date === today);
                
                const focusSessions = studyData.studySessions?.filter(s => {
                    if (!s?.date) return false;
                    return new Date(s.date).toDateString() === today && (s.hours || 0) >= 0.4;
                }).length || 0;
                
                const todayTasks = tasks.filter(t => {
                    if (!t?.completed || !t?.completedAt) return false;
                    return new Date(t.completedAt).toDateString() === today;
                }).length || 0;
                
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                
                const weeklyTasks = tasks.filter(t => {
                    if (!t?.completed || !t?.completedAt) return false;
                    return new Date(t.completedAt) >= weekAgo;
                }).length || 0;
                
                const weeklyHours = studyData.dailyStats?.reduce((sum, day) => {
                    if (!day?.date) return sum;
                    if (new Date(day.date) >= weekAgo) {
                        return sum + (day.hours || 0);
                    }
                    return sum;
                }, 0) || 0;
                
                const completedTasks = tasks.filter(t => t?.completed).length || 0;
                const totalHours = parseFloat(studyData.totalStudyHours || 0);
                const streak = studyData.streak || 0;
                
                const rpgData = loadRpgData();
                const questsCompleted = rpgData.questsCompleted || 0;
                
                return {
                    focusSessions, todayTasks,
                    streakMaintained: studyData.lastStudyDate === today ? 1 : 0,
                    todayHours: todayStats?.hours || 0,
                    streak, weeklyTasks, weeklyHours,
                    completedTasks, totalHours, questsCompleted
                };
            }

            function updateQuests() {
                const data = loadRpgData();
                const progress = collectProgress();
                
                // Reset daily if needed
                const today = getTodayKey();
                if (data.lastDailyReset !== today) {
                    data.dailyQuests = DAILY_QUESTS.map(q => ({ ...q, progress: 0, completed: false, claimed: false }));
                    data.lastDailyReset = today;
                }
                
                // Reset weekly if needed
                const weekStart = getWeekStart();
                if (data.lastWeeklyReset !== weekStart) {
                    data.weeklyQuests = WEEKLY_QUESTS.map(q => ({ ...q, progress: 0, completed: false, claimed: false }));
                    data.lastWeeklyReset = weekStart;
                }
                
                // Update daily quests
                data.dailyQuests.forEach(quest => {
                    if (!quest.completed && !quest.claimed) {
                        if (quest.id === 'daily_focus') quest.progress = progress.focusSessions;
                        else if (quest.id === 'daily_tasks') quest.progress = progress.todayTasks;
                        else if (quest.id === 'daily_streak') quest.progress = progress.streakMaintained;
                        else if (quest.id === 'daily_hours') quest.progress = Math.floor(progress.todayHours);
                        
                        if (quest.progress >= quest.requirement && !quest.completed) {
                            quest.completed = true;
                        }
                    }
                });
                
                // Update weekly quests
                data.weeklyQuests.forEach(quest => {
                    if (!quest.completed && !quest.claimed) {
                        if (quest.id === 'weekly_streak') quest.progress = progress.streak;
                        else if (quest.id === 'weekly_tasks') quest.progress = progress.weeklyTasks;
                        else if (quest.id === 'weekly_hours') quest.progress = Math.floor(progress.weeklyHours);
                        
                        if (quest.progress >= quest.requirement && !quest.completed) {
                            quest.completed = true;
                        }
                    }
                });
                
                // Update legendary quests
                data.legendaryQuests.forEach(quest => {
                    if (!quest.completed && !quest.claimed) {
                        if (quest.id === 'legend_first') quest.progress = progress.questsCompleted >= 1 ? 1 : 0;
                        else if (quest.id === 'legend_10') quest.progress = progress.questsCompleted >= 10 ? 1 : 0;
                        else if (quest.id === 'legend_50') quest.progress = progress.questsCompleted >= 50 ? 1 : 0;
                        else if (quest.id === 'legend_100') quest.progress = progress.questsCompleted >= 100 ? 1 : 0;
                        else if (quest.id === 'legend_streak_30') quest.progress = progress.streak >= 30 ? 1 : 0;
                        
                        if (quest.progress >= quest.requirement && !quest.completed) {
                            quest.completed = true;
                        }
                    }
                });
                
                // Update stats
                data.strength = 5 + Math.floor(progress.completedTasks / 10);
                data.intelligence = 5 + Math.floor(progress.totalHours / 5);
                data.wisdom = 5 + Math.floor(progress.streak / 3);
                data.mana = Math.min(data.maxMana, 50 + (progress.focusSessions * 10));
                data.health = Math.min(data.maxHealth, 70 + (progress.streak * 2));
                
                saveRpgData(data);
                return data;
            }

            function addXP(amount) {
                const data = loadRpgData();
                data.xp += amount;
                data.totalXP += amount;
                
                while (data.xp >= data.xpToNextLevel) {
                    data.xp -= data.xpToNextLevel;
                    data.level++;
                    data.xpToNextLevel = Math.floor(data.xpToNextLevel * 1.3);
                    
                    data.strength++;
                    data.intelligence++;
                    data.wisdom++;
                    data.luck++;
                    
                    showNotification(`‚≠ê LEVEL UP! Now level ${data.level}!`, "success");
                }
                
                saveRpgData(data);
                render();
                return data;
            }

            function claimQuest(questId, category) {
                const data = loadRpgData();
                let quests = [];
                
                if (category === 'daily') quests = data.dailyQuests;
                else if (category === 'weekly') quests = data.weeklyQuests;
                else if (category === 'legendary') quests = data.legendaryQuests;
                
                const quest = quests.find(q => q.id === questId);
                
                if (!quest || !quest.completed || quest.claimed) {
                    showNotification("Cannot claim - already completed", "error");
                    return;
                }
                
                quest.claimed = true;
                data.questsCompleted++;
                
                // Apply stat rewards
                if (quest.stats) {
                    Object.entries(quest.stats).forEach(([stat, value]) => {
                        if (stat === 'all') {
                            data.strength += value;
                            data.intelligence += value;
                            data.wisdom += value;
                            data.luck += value;
                        } else {
                            data[stat] += value;
                        }
                    });
                }
                
                saveRpgData(data);
                addXP(quest.xp);
                showNotification(`‚ú® Quest Complete! +${quest.xp} XP`, "success");
                render();
            }

            function rollDice() {
                const data = loadRpgData();
                
                if (data.mana < 5) {
                    showNotification("Not enough mana! Need 5 mana.", "error");
                    return;
                }
                
                data.mana -= 5;
                
                const roll1 = Math.floor(Math.random() * 6) + 1;
                const roll2 = Math.floor(Math.random() * 6) + 1;
                const total = roll1 + roll2;
                
                let xpGain = 10;
                let message = 'üé≤ +10 XP';
                
                if (total === 12) {
                    xpGain = 100;
                    message = 'üåü PERFECT ROLL! +100 XP!';
                } else if (total >= 10) {
                    xpGain = 50;
                    message = '‚ú® Great roll! +50 XP!';
                } else if (total >= 7) {
                    xpGain = 25;
                    message = 'üëç Good roll! +25 XP!';
                }
                
                saveRpgData(data);
                addXP(xpGain);
                showNotification(message, "success");
                render();
            }

            // Game Master click handler
            function gmClick() {
                const bubble = document.getElementById('gmBubble');
                const data = loadRpgData();
                const progress = collectProgress();
                
                // Get random message
                const messages = Object.values(GM_MESSAGES);
                let message = messages[Math.floor(Math.random() * messages.length)];
                
                // Replace placeholders
                message = message
                    .replace('{{xp}}', data.xp)
                    .replace('{{xpNeeded}}', data.xpToNextLevel - data.xp)
                    .replace('{{nextLevel}}', data.level + 1)
                    .replace('{{health}}', Math.round(data.health))
                    .replace('{{maxHealth}}', data.maxHealth)
                    .replace('{{mana}}', Math.round(data.mana))
                    .replace('{{maxMana}}', data.maxMana)
                    .replace('{{str}}', data.strength)
                    .replace('{{int}}', data.intelligence)
                    .replace('{{wis}}', data.wisdom)
                    .replace('{{luk}}', data.luck)
                    .replace('{{tasks}}', progress.completedTasks)
                    .replace('{{hours}}', Math.round(progress.totalHours))
                    .replace('{{streak}}', progress.streak)
                    .replace('{{dailyDone}}', data.dailyQuests.filter(q => q.completed).length)
                    .replace('{{dailyTotal}}', data.dailyQuests.length)
                    .replace('{{dailyLeft}}', data.dailyQuests.length - data.dailyQuests.filter(q => q.completed).length)
                    .replace('{{weeklyDone}}', data.weeklyQuests.filter(q => q.completed).length)
                    .replace('{{weeklyTotal}}', data.weeklyQuests.length)
                    .replace('{{weeklyLeft}}', data.weeklyQuests.length - data.weeklyQuests.filter(q => q.completed).length)
                    .replace('{{legendaryDone}}', data.legendaryQuests.filter(q => q.completed).length)
                    .replace('{{legendaryTotal}}', data.legendaryQuests.length)
                    .replace('{{legendaryLeft}}', data.legendaryQuests.length - data.legendaryQuests.filter(q => q.completed).length)
                    .replace('{{level}}', data.level)
                    .replace('{{xpToNext}}', data.xpToNextLevel);
                
                bubble.textContent = 'üßô‚Äç‚ôÇÔ∏è ' + message;
                
                // Animate
                bubble.style.animation = 'none';
                bubble.offsetHeight;
                bubble.style.animation = 'bubbleAppear 0.3s ease-out';
            }

            function render() {
                const data = updateQuests();
                const progress = collectProgress();
                const content = document.getElementById('questContent');
                
                const xpPercent = (data.xp / data.xpToNextLevel) * 100;
                const healthPercent = (data.health / data.maxHealth) * 100;
                const manaPercent = (data.mana / data.maxMana) * 100;
                
                const currentTitle = GAME_TITLES.find(t => t.level <= data.level) || GAME_TITLES[0];
                
                content.innerHTML = `
                    <!-- Hero Section -->
                    <div class="hero-section">
                        <div class="player-card">
                            <div class="player-avatar">${currentTitle.icon}</div>
                            <div class="player-name">${localStorage.getItem('studentName') || 'Adventurer'}</div>
                            <div class="player-title">${currentTitle.icon} ${data.currentTitle} (Lv.${data.level})</div>
                        </div>
                        
                        <div class="resource-bars">
                            <div class="resource-item">
                                <div class="resource-header">
                                    <span>‚ú® XP to Level ${data.level + 1}</span>
                                    <span>${data.xp}/${data.xpToNextLevel}</span>
                                </div>
                                <div class="resource-track">
                                    <div class="resource-fill xp" style="width: ${xpPercent}%;"></div>
                                </div>
                            </div>
                            
                            <div class="resource-item">
                                <div class="resource-header">
                                    <span>‚ù§Ô∏è Health</span>
                                    <span>${Math.round(data.health)}/${Math.round(data.maxHealth)}</span>
                                </div>
                                <div class="resource-track">
                                    <div class="resource-fill health" style="width: ${healthPercent}%;"></div>
                                </div>
                            </div>
                            
                            <div class="resource-item">
                                <div class="resource-header">
                                    <span>üíô Mana</span>
                                    <span>${Math.round(data.mana)}/${Math.round(data.maxMana)}</span>
                                </div>
                                <div class="resource-track">
                                    <div class="resource-fill mana" style="width: ${manaPercent}%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí™</div>
                            <div class="stat-content">
                                <div class="stat-label">Strength</div>
                                <div class="stat-value">${data.strength}</div>
                                <div class="stat-bonus">${progress.completedTasks} tasks</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üß†</div>
                            <div class="stat-content">
                                <div class="stat-label">Intelligence</div>
                                <div class="stat-value">${data.intelligence}</div>
                                <div class="stat-bonus">${Math.round(progress.totalHours)} hrs</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üìö</div>
                            <div class="stat-content">
                                <div class="stat-label">Wisdom</div>
                                <div class="stat-value">${data.wisdom}</div>
                                <div class="stat-bonus">${progress.streak} day streak</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üçÄ</div>
                            <div class="stat-content">
                                <div class="stat-label">Luck</div>
                                <div class="stat-value">${data.luck}</div>
                                <div class="stat-bonus">${data.perfectDays} perfect days</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button class="action-btn" onclick="window.rollDice()" ${data.mana < 5 ? 'disabled' : ''}>
                            üé≤ Roll Dice (5 Mana)
                        </button>
                        <button class="action-btn" onclick="window.gmClick()">
                            üßô Ask Game Master
                        </button>
                        <button class="action-btn" onclick="window.location.reload()">
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <!-- Daily Quests -->
                    <div class="quest-category">
                        <div class="category-header">
                            <div class="category-icon">üìÖ</div>
                            <div class="category-title">Daily Quests</div>
                            <div class="category-badge">üî• ${data.dailyStreak} Day Streak</div>
                        </div>
                        ${renderQuests(data.dailyQuests, 'daily')}
                    </div>
                    
                    <!-- Weekly Quests -->
                    <div class="quest-category">
                        <div class="category-header">
                            <div class="category-icon">üìÜ</div>
                            <div class="category-title">Weekly Quests</div>
                            <div class="category-badge">‚öîÔ∏è Epic Rewards</div>
                        </div>
                        ${renderQuests(data.weeklyQuests, 'weekly')}
                    </div>
                    
                    <!-- Legendary Quests -->
                    <div class="quest-category">
                        <div class="category-header">
                            <div class="category-icon">üåü</div>
                            <div class="category-title">Legendary Quests</div>
                            <div class="category-badge">${data.legendaryQuests.filter(q => q.completed).length}/${data.legendaryQuests.length}</div>
                        </div>
                        ${renderQuests(data.legendaryQuests, 'legendary')}
                    </div>
                `;
            }

            function renderQuests(quests, category) {
                if (!quests || quests.length === 0) {
                    return '<div class="empty-state">No quests available</div>';
                }
                
                return quests.map(quest => {
                    const progressPercent = (quest.progress / quest.requirement) * 100;
                    const canClaim = quest.completed && !quest.claimed;
                    
                    let statRewards = '';
                    if (quest.stats) {
                        statRewards = Object.entries(quest.stats).map(([stat, value]) => {
                            const icons = { strength: 'üí™', intelligence: 'üß†', wisdom: 'üìö', luck: 'üçÄ', all: 'üìä' };
                            return `<span class="reward-chip">${icons[stat] || '‚ú®'} +${value}</span>`;
                        }).join('');
                    }
                    
                    return `
                        <div class="quest-card ${quest.rarity}">
                            <div class="quest-header">
                                <div class="quest-icon">${quest.icon}</div>
                                <div class="quest-info">
                                    <div class="quest-name">${quest.name}</div>
                                    <div class="quest-meta">
                                        <span class="quest-rarity ${quest.rarity}">${quest.rarity}</span>
                                        <span class="quest-xp">‚ú® ${quest.xp} XP</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="quest-description">${quest.description}</div>
                            
                            <div class="quest-rewards">
                                ${statRewards}
                            </div>
                            
                            <div class="quest-progress">
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Progress: ${quest.progress}/${quest.requirement}</span>
                                    <span>${Math.round(progressPercent)}%</span>
                                </div>
                            </div>
                            
                            <div class="quest-actions">
                                ${canClaim ? 
                                    `<button class="quest-btn claim" onclick="window.claimQuest('${quest.id}', '${category}')">
                                        ‚ú® CLAIM REWARDS
                                    </button>` : 
                                    quest.claimed ?
                                    `<button class="quest-btn" disabled>‚úì COMPLETED</button>` :
                                    `<button class="quest-btn" disabled>IN PROGRESS</button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function showNotification(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // Make functions globally available
            window.claimQuest = claimQuest;
            window.rollDice = rollDice;
            window.gmClick = gmClick;
            window.goBack = function() {
                window.location.href = 'studentmode.html';
            };

            // Initialize
            render();
            
            // Auto-refresh every 30 seconds
            setInterval(render, 30000);
            
            // Show initial GM message after 2 seconds
            setTimeout(() => {
                gmClick();
            }, 2000);
        })();
    </script>
</body>
</html>
