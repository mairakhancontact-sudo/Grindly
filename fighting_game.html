<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‚ö° KENJI VS SAKURA ‚Äì CHARACTERS SEPARATED ‚ö°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }
        
        body {
            background: linear-gradient(135deg, #0a0b1a, #1a0033);
            font-family: 'Orbitron', sans-serif;
        }
        
        /* ---------- CHARACTER SELECTION (original cards) ---------- */
        .character-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a0033 0%, #000 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
            padding: 20px;
            overflow-y: auto;
        }
        
        .character-modal.hidden {
            display: none !important;
        }
        
        .character-select-card {
            background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(15,23,42,0.98));
            border: 4px solid #fbbf24;
            border-radius: 50px;
            padding: clamp(20px, 5vh, 50px);
            max-width: 1200px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 100px rgba(251,191,36,0.3);
        }
        
        .character-select-title {
            font-size: clamp(2rem, 6vw, 4rem);
            color: #fbbf24;
            margin-bottom: 30px;
            text-shadow: 0 0 30px #fbbf24;
            font-family: 'Bangers', cursive;
        }
        
       /* REPLACE YOUR EXISTING .character-options STYLES with this: */

.character-options {
    display: flex;
    flex-direction: row; /* Force row layout */
    gap: clamp(15px, 3vw, 30px);
    justify-content: center;
    align-items: center;
    margin: 20px 0;
    flex-wrap: wrap; /* Allow wrap only if absolutely necessary */
    width: 100%;
}

/* Update character cards to be side-by-side */
.character-option {
    cursor: pointer;
    padding: clamp(15px, 3vh, 30px);
    border-radius: 25px;
    background: rgba(0,0,0,0.6);
    border: 3px solid transparent;
    width: min(280px, 45%); /* Max 45% width so two fit side by side */
    min-width: 200px; /* Minimum width for readability */
    transition: all 0.3s;
    backdrop-filter: blur(5px);
}

/* Make the preview images smaller in landscape */
.character-preview {
    width: min(150px, 70%);
    height: auto;
    aspect-ratio: 200/240;
    margin: 0 auto 15px;
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(3rem, 8vw, 5rem);
    border: 3px solid #fbbf24;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}

/* Make stats more compact in landscape */
.character-stats {
    display: flex;
    justify-content: center;
    gap: 15px;
    color: #fbbf24;
    font-size: clamp(0.9rem, 2.5vw, 1rem);
    flex-wrap: wrap;
    background: rgba(0,0,0,0.4);
    padding: 8px;
    border-radius: 25px;
}

/* Landscape-specific adjustments */
@media (orientation: landscape) and (max-height: 500px) {
    .character-modal {
        padding: 10px;
        align-items: flex-start; /* Align to top */
        overflow-y: auto;
    }
    
    .character-select-card {
        padding: 15px;
        margin: 10px auto;
    }
    
    .character-select-title {
        font-size: clamp(1.8rem, 5vh, 2.5rem);
        margin-bottom: 15px;
    }
    
    .character-options {
        gap: 15px;
        margin: 10px 0;
    }
    
    .character-option {
        padding: 15px;
        min-width: 180px;
    }
    
    .character-preview {
        width: min(120px, 60%);
        margin-bottom: 10px;
    }
    
    .character-name {
        font-size: clamp(1.3rem, 4vh, 1.8rem);
        margin-bottom: 5px;
    }
    
    .character-desc {
        font-size: clamp(0.8rem, 2vh, 0.9rem);
        margin-bottom: 8px;
    }
    
    .character-stats {
        padding: 6px;
        gap: 10px;
    }
    
    .character-stats span {
        font-size: 0.9rem;
    }
    
    .confirm-btn {
        padding: 12px 40px;
        font-size: clamp(1.1rem, 4vh, 1.5rem);
        margin-top: 15px;
    }
}

/* For very small landscape screens */
@media (orientation: landscape) and (max-height: 400px) {
    .character-select-card {
        padding: 10px;
    }
    
    .character-option {
        padding: 10px;
        min-width: 160px;
    }
    
    .character-preview {
        width: min(100px, 50%);
        margin-bottom: 5px;
    }
    
    .character-name {
        font-size: 1.2rem;
    }
    
    .character-desc {
        display: none; /* Hide description on very small screens */
    }
    
    .character-stats span {
        font-size: 0.8rem;
    }
    
    .confirm-btn {
        padding: 8px 30px;
    }
}
        
       
        
        
        /* ---------- MAIN GAME LAYOUT (canvas right, controls left) ---------- */
        .game-container {
            display: flex;
            flex-direction: row;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        /* LEFT PANEL ‚Äì canvas (60%) */
        .left-panel {
            width: 60%;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: linear-gradient(180deg, #0a1a2a 0%, #1a2a3a 100%);
            cursor: none;
        }
        
        /* RIGHT PANEL ‚Äì controls (38%) */
        .right-panel {
            width: 38%;
            height: 100vh;
            background: linear-gradient(135deg, #0a0b1a, #1a0033);
            border-left: 2px solid #fbbf24;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 8px;
            overflow-y: auto;
            z-index: 10;
        }
        
        /* ---------- CONTROLS INSIDE RIGHT PANEL ---------- */
        .top-info {
            background: rgba(0,0,0,0.8);
            border: 2px solid #fbbf24;
            border-radius: 15px;
            padding: 8px;
            text-align: center;
            color: #fbbf24;
            font-size: 14px;
            font-family: 'Bangers', cursive;
        }
        
        .player-huds {
            display: flex;
            gap: 8px;
        }
        
        .player-hud {
            flex: 1;
            background: rgba(0,0,0,0.9);
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 8px;
        }
        
        .player-hud.left {
            border-color: #ef4444;
        }
        .player-hud.right {
            border-color: #ff69b4;
        }
        
        .player-name-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .player-name {
            font-size: 14px;
            font-weight: 900;
            font-family: 'Bangers', cursive;
        }
        .left .player-name { color: #ef4444; }
        .right .player-name { color: #ff69b4; }
        
        .player-level {
            background: #fbbf24;
            color: black;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
        }
        
        .health-bar {
            height: 12px;
            background: #000;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        .health-fill {
            height: 100%;
            width: 100%;
            transition: width 0.1s;
        }
        .left .health-fill { background: linear-gradient(90deg, #ef4444, #ff8a8a); }
        .right .health-fill { background: linear-gradient(90deg, #ff69b4, #ffb6c1); }
        
        .special-bar, .rage-bar {
            height: 6px;
            background: #000;
            border: 1px solid #fbbf24;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 3px;
        }
        .special-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #fbbf24, #ffd700);
            transition: width 0.2s;
        }
        .rage-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff0000, #8b0000);
            transition: width 0.2s;
        }
        
        .timer {
            background: rgba(0,0,0,0.9);
            border: 2px solid #fbbf24;
            border-radius: 30px;
            padding: 5px 15px;
            font-size: 28px;
            color: #fbbf24;
            font-family: 'Bangers', cursive;
            text-align: center;
            margin: 5px 0;
        }
        
        .indicators {
            display: flex;
            gap: 8px;
        }
        .rage-indicator, .combo-indicator {
            flex: 1;
            background: rgba(0,0,0,0.9);
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            font-family: 'Bangers', cursive;
            display: none;
        }
        .rage-indicator { color: #ff0000; }
        .combo-indicator { color: #ffd700; }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin: 8px 0;
        }
        .action-btn {
            background: linear-gradient(135deg, #333, #222);
            color: white;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 10px 5px;
            font-size: 12px;
            font-weight: 900;
            font-family: 'Bangers', cursive;
            cursor: pointer;
            box-shadow: 0 3px 0 #000;
            text-transform: uppercase;
        }
        .action-btn:active {
            transform: translateY(3px);
            box-shadow: none;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: black;
        }
        .ultimate-btn {
            grid-column: span 3;
            background: linear-gradient(135deg, #ff0000, #8b0000);
            color: white;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 10px;
            font-size: 16px;
            font-family: 'Bangers', cursive;
            cursor: pointer;
            box-shadow: 0 3px 0 #000, 0 0 20px #ff0000;
            animation: pulse 1s infinite;
        }
        .ultimate-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        @keyframes pulse {
            0%,100% { box-shadow: 0 3px 0 #000, 0 0 20px #ff0000; }
            50% { box-shadow: 0 3px 0 #000, 0 0 40px #ff0000; }
        }
        
        /* ========== SPECIAL MOVES ‚Äì FIXED FOR MOBILE (NO SCROLL) ========== */
.special-moves {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
    margin: 6px 0 4px;
    padding: 8px 6px;
    background: rgba(0,0,0,0.95);
    border: 2px solid #fbbf24;
    border-radius: 16px;
    /* NO MAX-HEIGHT, NO OVERFLOW, NO SCROLLING */
    flex: 0 1 auto;
    width: 100%;
}

.special-move-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 8px 5px;
    font-size: 12px;
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 65px;
    flex: 0 1 auto;
    cursor: pointer;
    box-shadow: 0 3px 0 #000;
    touch-action: manipulation;
    transition: transform 0.05s, background 0.1s;
    font-weight: bold;
}

.special-move-btn:active {
    transform: translateY(3px);
    box-shadow: none;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: black;
    border-color: #000;
}

.special-move-btn .icon {
    font-size: 20px;
    line-height: 1;
    margin-bottom: 2px;
}

.special-move-btn span:not(.icon) {
    font-size: 9px;
    font-family: 'Bangers', cursive;
    letter-spacing: 0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60px;
    padding: 0 2px;
}

.special-move-btn .cost {
    background: #000000aa;
    border-radius: 20px;
    padding: 2px 6px;
    margin-top: 2px;
    font-size: 8px;
    color: #fbbf24;
    border: 1px solid #fbbf24;
}

/* Rarity colors */
.special-move-btn.rare { background: linear-gradient(135deg, #a855f7, #7e22ce); }
.special-move-btn.epic { background: linear-gradient(135deg, #ec4899, #be185d); }
.special-move-btn.legendary { 
    background: linear-gradient(135deg, #f97316, #c2410c); 
    animation: legendaryGlow 2s infinite;
    border-color: gold;
}
@keyframes legendaryGlow { 
    50% { border-color: #ffd700; box-shadow: 0 0 10px gold; } 
}
        .special-move-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 4px 6px;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 50px;
            cursor: pointer;
            box-shadow: 0 2px 0 #000;
        }
        .special-move-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .special-move-btn .icon { font-size: 14px; }
        
        .restart-hint {
            color: #fbbf24;
            font-size: 10px;
            text-align: center;
            opacity: 0.8;
        }
        
        /* back / sound buttons (fixed) */
        .back-btn, .sound-toggle {
            position: fixed;
            z-index: 100;
            background: #ef4444;
            color: white;
            border: 2px solid #fbbf24;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-family: 'Bangers', cursive;
            cursor: pointer;
            box-shadow: 0 3px 0 #b91c1c;
            text-decoration: none;
        }
        .back-btn:active, .sound-toggle:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        .sound-toggle {
            right: 10px;
            top: 10px;
            background: rgba(0,0,0,0.8);
        }
        .back-btn {
            left: 10px;
            top: 10px;
        }
        
        /* game overlay */
        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10000;
            border: 4px solid #fbbf24;
        }
        .game-overlay.show { display: flex; }
        .victory-text {
            font-size: clamp(48px, 12vw, 96px);
            color: #fbbf24;
            font-family: 'Bangers', cursive;
            margin-bottom: 20px;
        }
        .xp-gained {
            font-size: 24px;
            color: #f59e0b;
            margin-bottom: 20px;
        }
        .restart-btn {
            background: linear-gradient(135deg, #ef4444, #ff69b4);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            border-radius: 60px;
            border: 4px solid #fbbf24;
            cursor: pointer;
            font-family: 'Bangers', cursive;
            box-shadow: 0 8px 0 #b91c1c;
        }
        .restart-btn:active {
            transform: translateY(8px);
            box-shadow: none;
        }
        
        .battle-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.98);
            color: #fbbf24;
            padding: 15px 30px;
            border-radius: 40px;
            border: 3px solid #fbbf24;
            font-size: 20px;
            z-index: 1000;
            animation: msgAppear 0.5s forwards;
            font-family: 'Bangers', cursive;
            pointer-events: none;
        }
        @keyframes msgAppear {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        
        /* desktop override: keep same layout (left canvas, right controls) */
        @media (min-width: 1024px) {
            .left-panel { width: 65%; }
            .right-panel { width: 33%; }
        }

        /* REPLACE ONLY THIS ENTIRE SPECIAL MOVES SECTION in your CSS */
/* Find .special-moves and everything under it, replace with this: */

.special-moves {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
    margin: 6px 0 4px;
    padding: 8px 6px;
    background: rgba(0,0,0,0.95);
    border: 2px solid #fbbf24;
    border-radius: 16px;
    /* CRITICAL: No height restrictions, no overflow */
    max-height: none;
    overflow: visible;
    flex: 0 1 auto;
    width: 100%;
}

.special-move-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: 2px solid #fbbf24;
    border-radius: 12px;
    padding: 8px 5px;
    font-size: 12px;
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 65px;
    cursor: pointer;
    box-shadow: 0 3px 0 #000;
    touch-action: manipulation;
    transition: transform 0.05s, background 0.1s;
    font-weight: bold;
}

.special-move-btn:active {
    transform: translateY(3px);
    box-shadow: none;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: black;
    border-color: #000;
}

.special-move-btn .icon {
    font-size: 20px;
    line-height: 1;
    margin-bottom: 2px;
}

.special-move-btn span:not(.icon) {
    font-size: 9px;
    font-family: 'Bangers', cursive;
    letter-spacing: 0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60px;
    padding: 0 2px;
}

.special-move-btn .cost {
    background: #000000aa;
    border-radius: 20px;
    padding: 2px 6px;
    margin-top: 2px;
    font-size: 8px;
    color: #fbbf24;
    border: 1px solid #fbbf24;
}

.special-move-btn.rare { background: linear-gradient(135deg, #a855f7, #7e22ce); }
.special-move-btn.epic { background: linear-gradient(135deg, #ec4899, #be185d); }
.special-move-btn.legendary { 
    background: linear-gradient(135deg, #f97316, #c2410c); 
    animation: legendaryGlow 2s infinite;
    border-color: gold;
}
@keyframes legendaryGlow { 
    50% { border-color: #ffd700; box-shadow: 0 0 10px gold; } 
}

/* ADD THIS AT THE VERY END OF YOUR STYLES */
/* LANDSCAPE FIX FOR CHARACTER SELECTION ONLY - DOES NOT AFFECT GAME */

@media (orientation: landscape) and (max-height: 500px) {
    /* Target only the character modal - NOT the game */
    .character-modal {
        padding: 5px !important;
        align-items: center !important;
    }
    
    .character-modal .character-select-card {
        padding: 15px !important;
        max-width: 95% !important;
        margin: 0 auto !important;
    }
    
    .character-modal .character-options {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 15px !important;
        margin: 10px 0 !important;
    }
    
    .character-modal .character-option {
        width: 45% !important;
        min-width: 180px !important;
        padding: 15px !important;
    }
    
    .character-modal .character-preview {
        width: 100px !important;
        height: 120px !important;
        font-size: 3rem !important;
        margin-bottom: 8px !important;
    }
    
    .character-modal .character-name {
        font-size: 1.3rem !important;
        margin-bottom: 3px !important;
    }
    
    .character-modal .character-desc {
        font-size: 0.8rem !important;
        margin-bottom: 5px !important;
    }
    
    .character-modal .character-stats {
        padding: 5px !important;
        gap: 8px !important;
    }
    
    .character-modal .character-stats span {
        font-size: 0.8rem !important;
    }
    
    .character-modal .confirm-btn {
        padding: 10px 30px !important;
        font-size: 1.2rem !important;
        margin-top: 10px !important;
    }
}

/* Even smaller screens */
@media (orientation: landscape) and (max-height: 400px) {
    .character-modal .character-option {
        min-width: 160px !important;
        padding: 10px !important;
    }
    
    .character-modal .character-preview {
        width: 80px !important;
        height: 100px !important;
        font-size: 2.5rem !important;
    }
    
    .character-modal .character-name {
        font-size: 1.1rem !important;
    }
    
    .character-modal .character-desc {
        display: none !important; /* Hide description on very small screens */
    }
    
    .character-modal .character-stats span {
        font-size: 0.7rem !important;
    }
}
    </style>
</head>
<body>
    <!-- CHARACTER SELECTION MODAL (original cards) -->
    <div class="character-modal" id="characterModal">
        <div class="character-select-card">
            <div class="character-select-title">‚öîÔ∏è CHOOSE YOUR WARRIOR ‚öîÔ∏è</div>
            <div id="characterTakenMessage" style="color: #fbbf24; margin-bottom:20px; font-size:16px;"></div>
            <div class="character-options">
                <!-- Kenji card -->
                <div class="character-option" id="chooseKenji" onclick="selectCharacter('kenji')">
                    <div class="character-preview">‚öîÔ∏è</div>
                    <div class="character-name">KENJI</div>
                    <div class="character-desc">The Shadow Warrior</div>
                    <div class="character-stats">
                        <span>üí™ 9</span> <span>‚ö° 7</span> <span>üõ°Ô∏è 8</span>
                    </div>
                    <div id="kenjiTaken" style="display:none; color:#ef4444;">üîí TAKEN</div>
                </div>
                <!-- Sakura card -->
                <div class="character-option" id="chooseSakura" onclick="selectCharacter('sakura')">
                    <div class="character-preview">üå∏</div>
                    <div class="character-name">SAKURA</div>
                    <div class="character-desc">The Cherry Blossom</div>
                    <div class="character-stats">
                        <span>üí™ 7</span> <span>‚ö° 9</span> <span>üõ°Ô∏è 7</span>
                    </div>
                    <div id="sakuraTaken" style="display:none; color:#ef4444;">üîí TAKEN</div>
                </div>
            </div>
            <button class="confirm-btn" id="confirmCharacterBtn" onclick="confirmCharacter()" disabled>‚ö° SELECT FIGHTER ‚ö°</button>
        </div>
    </div>

    <!-- MAIN GAME LAYOUT -->
    <div class="game-container">
        <!-- LEFT PANEL (canvas) -->
        <div class="left-panel" id="leftPanel">
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- RIGHT PANEL (controls) -->
        <div class="right-panel" id="rightPanel" style="display: none;">
            <div class="top-info" id="battleInfoMobile">
                <span>‚öîÔ∏è ARENA ¬∑ ROUND 1</span>
            </div>
            <div class="top-info" id="playerIndicatorMobile">CHOOSE YOUR FIGHTER</div>

            <!-- Player HUDs -->
            <div class="player-huds">
                <div class="player-hud left">
                    <div class="player-name-row">
                        <span class="player-name" id="p1Name">KENJI</span>
                        <span class="player-level" id="p1Level">Lv.1</span>
                    </div>
                    <div class="health-bar"><div class="health-fill" id="p1HealthFill" style="width:100%"></div></div>
                    <div class="special-bar"><div class="special-fill" id="p1SpecialFill" style="width:0%"></div></div>
                    <div class="rage-bar"><div class="rage-fill" id="p1RageFill" style="width:0%"></div></div>
                </div>
                <div class="player-hud right">
                    <div class="player-name-row">
                        <span class="player-name" id="p2Name">SAKURA</span>
                        <span class="player-level" id="p2Level">Lv.1</span>
                    </div>
                    <div class="health-bar"><div class="health-fill" id="p2HealthFill" style="width:100%"></div></div>
                    <div class="special-bar"><div class="special-fill" id="p2SpecialFill" style="width:0%"></div></div>
                    <div class="rage-bar"><div class="rage-fill" id="p2RageFill" style="width:0%"></div></div>
                </div>
            </div>

            <!-- Timer -->
            <div class="timer" id="timerDisplay">99</div>

            <!-- Indicators -->
            <div class="indicators">
                <div class="rage-indicator" id="rageIndicator">‚ö° RAGE MODE</div>
                <div class="combo-indicator" id="comboIndicator">üî• COMBO</div>
            </div>

            <!-- Action Buttons -->
            <div class="button-grid">
                <button class="action-btn" id="btnLeft" onmousedown="if(window.game) window.game.press('left')" ontouchstart="if(window.game) window.game.press('left')" onmouseup="if(window.game) window.game.release('left')" ontouchend="if(window.game) window.game.release('left')">‚Üê LEFT</button>
                <button class="action-btn" id="btnRight" onmousedown="if(window.game) window.game.press('right')" ontouchstart="if(window.game) window.game.press('right')" onmouseup="if(window.game) window.game.release('right')" ontouchend="if(window.game) window.game.release('right')">‚Üí RIGHT</button>
                <button class="action-btn" id="btnPunch" onmousedown="if(window.game) window.game.press('punch')" ontouchstart="if(window.game) window.game.press('punch')" onmouseup="if(window.game) window.game.release('punch')">üëä PUNCH</button>
                <button class="action-btn" id="btnKick" onmousedown="if(window.game) window.game.press('kick')" ontouchstart="if(window.game) window.game.press('kick')" onmouseup="if(window.game) window.game.release('kick')">ü¶µ KICK</button>
                <button class="action-btn" id="btnBlock" onmousedown="if(window.game) window.game.press('block')" ontouchstart="if(window.game) window.game.press('block')" onmouseup="if(window.game) window.game.release('block')" ontouchend="if(window.game) window.game.release('block')">üõ°Ô∏è BLOCK</button>
                <button class="ultimate-btn" id="btnUltimate" onmousedown="if(window.game) window.game.press('ultimate')" ontouchstart="if(window.game) window.game.press('ultimate')">üî• ULTIMATE</button>
            </div>

            <!-- Special Moves -->
            <div class="special-moves" id="specialMoves"></div>
            <div class="restart-hint" id="restartHint">R = RESTART ¬∑ U = ULTIMATE</div>
        </div>

        <!-- GAME OVERLAY -->
        <div class="game-overlay" id="gameOverlay">
            <div class="victory-text" id="victoryText"></div>
            <div class="xp-gained" id="xpGained">+0 XP</div>
            <button class="restart-btn" onclick="restartGame()">‚ö° FIGHT AGAIN ‚ö°</button>
        </div>
    </div>

    <!-- fixed buttons -->
    <a href="javascript:history.back()" class="back-btn" id="backBtn" style="display: none;">‚Üê BACK</a>
    <div class="sound-toggle" id="soundToggle" onclick="toggleSound()" style="display: none;">üîä ON</div>

    <!-- Firebase scripts (loaded dynamically) -->
    <script>
        // ========== MOVE DATABASE ==========
        const MOVE_DATABASE = {
            punch: { id: 'punch', name: 'PUNCH', icon: 'üëä', damage: 3, manaCost: 0, rarity: 'common' },
            kick: { id: 'kick', name: 'KICK', icon: 'ü¶µ', damage: 4, manaCost: 5, rarity: 'common' },
            heavy_punch: { id: 'heavy_punch', name: 'HEAVY', icon: 'üí™', damage: 6, manaCost: 10, rarity: 'common' },
            power_kick: { id: 'power_kick', name: 'POWER', icon: 'ü¶∂', damage: 7, manaCost: 15, rarity: 'common' },
            fire_punch: { id: 'fire_punch', name: 'FIRE', icon: 'üî•', damage: 9, manaCost: 20, rarity: 'rare' },
            thunder_kick: { id: 'thunder_kick', name: 'THUNDER', icon: '‚ö°', damage: 10, manaCost: 25, rarity: 'rare' },
            ice_blast: { id: 'ice_blast', name: 'ICE', icon: '‚ùÑÔ∏è', damage: 8, manaCost: 30, rarity: 'epic' },
            dragon_fury: { id: 'dragon_fury', name: 'DRAGON', icon: 'üêâ', damage: 14, manaCost: 40, rarity: 'legendary' },
            healing_light: { id: 'healing_light', name: 'HEAL', icon: '‚ú®', heal: 15, manaCost: 25, rarity: 'rare' },
            ultimate: { id: 'ultimate', name: 'ULTIMATE', icon: 'üíÄ', damage: 999, manaCost: 100, rarity: 'legendary' }
        };

        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyBAIPxgXPZmGdPvB98TLFRfTAClgXWEIM0",
            authDomain: "student-teacher-app-4e7c9.firebaseapp.com",
            databaseURL: "https://student-teacher-app-4e7c9-default-rtdb.firebaseio.com",
            projectId: "student-teacher-app-4e7c9"
        };

        // ========== SOUND SYSTEM (enhanced) ==========
        let soundEnabled = true;
        let audioContext = null;
        function initAudio() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSound(type, volume = 0.3) {
            if (!soundEnabled) return;
            initAudio();
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                osc.connect(filter); filter.connect(gain); gain.connect(audioContext.destination);
                gain.gain.value = volume;
                switch(type) {
                    case 'punch':
                        osc.frequency.setValueAtTime(200, audioContext.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime+0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.2);
                        osc.type = 'sawtooth'; filter.type='lowpass'; filter.frequency.value=800; break;
                    case 'kick':
                        osc.frequency.setValueAtTime(150, audioContext.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime+0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.25);
                        osc.type='triangle'; filter.type='lowpass'; filter.frequency.value=600; break;
                    case 'block':
                        osc.frequency.setValueAtTime(100, audioContext.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime+0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.1);
                        osc.type='square'; filter.type='lowpass'; filter.frequency.value=400; break;
                    case 'hit':
                        osc.frequency.setValueAtTime(300, audioContext.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime+0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.15);
                        osc.type='sawtooth'; filter.type='bandpass'; filter.frequency.value=500; break;
                    case 'critical':
                        for(let i=0;i<2;i++){ let o=audioContext.createOscillator(), g=audioContext.createGain();
                            o.type='sawtooth'; o.frequency.setValueAtTime(600+i*200, audioContext.currentTime);
                            o.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime+0.2);
                            o.connect(g); g.connect(audioContext.destination);
                            g.gain.setValueAtTime(0.2, audioContext.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.3);
                            o.start(); o.stop(audioContext.currentTime+0.3);
                        } return;
                    case 'ko':
                        for(let i=0;i<2;i++){ let o=audioContext.createOscillator(), g=audioContext.createGain();
                            o.type='sawtooth'; o.frequency.setValueAtTime(200-i*50, audioContext.currentTime);
                            o.frequency.linearRampToValueAtTime(50, audioContext.currentTime+1);
                            o.connect(g); g.connect(audioContext.destination);
                            g.gain.setValueAtTime(0.4, audioContext.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+1);
                            o.start(); o.stop(audioContext.currentTime+1);
                        } return;
                    case 'victory':
                        for(let i=0;i<3;i++){ let o=audioContext.createOscillator(), g=audioContext.createGain();
                            o.type='sine'; o.frequency.setValueAtTime(440+i*110, audioContext.currentTime);
                            o.frequency.linearRampToValueAtTime(880, audioContext.currentTime+0.3);
                            o.connect(g); g.connect(audioContext.destination);
                            g.gain.setValueAtTime(0.2, audioContext.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.8);
                            o.start(); o.stop(audioContext.currentTime+0.8);
                        } return;
                    case 'select':
                        osc.frequency.setValueAtTime(523.25, audioContext.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(783.99, audioContext.currentTime+0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.2);
                        osc.type='sine'; filter.type='lowpass'; filter.frequency.value=2000; break;
                    case 'rage':
                        for(let i=0;i<2;i++){ let o=audioContext.createOscillator(), g=audioContext.createGain();
                            o.type='sawtooth'; o.frequency.setValueAtTime(200+i*100, audioContext.currentTime);
                            o.frequency.linearRampToValueAtTime(400+i*200, audioContext.currentTime+0.3);
                            o.connect(g); g.connect(audioContext.destination);
                            g.gain.setValueAtTime(0.4, audioContext.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.5);
                            o.start(); o.stop(audioContext.currentTime+0.5);
                        } return;
                    case 'ultimate':
                        for(let i=0;i<5;i++){ let o=audioContext.createOscillator(), g=audioContext.createGain();
                            o.type='sawtooth'; o.frequency.setValueAtTime(200+i*100, audioContext.currentTime);
                            o.frequency.linearRampToValueAtTime(800+i*200, audioContext.currentTime+0.5);
                            o.connect(g); g.connect(audioContext.destination);
                            g.gain.setValueAtTime(0.2, audioContext.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime+0.6);
                            o.start(); o.stop(audioContext.currentTime+0.6);
                        } return;
                }
                osc.start(); osc.stop(audioContext.currentTime+0.2);
            } catch(e){}
        }
        window.toggleSound = function(){ soundEnabled=!soundEnabled;
            document.getElementById('soundToggle').textContent=soundEnabled?'üîä ON':'üîá OFF'; playSound('select'); };

        // ========== GLOBAL VARIABLES ==========
        let selectedCharacter = null;
        let playerRole = null;
        let playerId = null;
        let playerName = "Player";
        let battleCode = null;
        let battleRef = null;
        let database = null;
        let positionUpdateInterval = null;
        window.game = null;  // make it global

        const urlParams = new URLSearchParams(window.location.search);
        battleCode = urlParams.get('code');
        playerRole = urlParams.get('role');
        playerName = urlParams.get('name') || 'Player';
        playerId = urlParams.get('id');

        // ========== CHARACTER SELECTION ==========
        window.selectCharacter = function(character) {
            const option = document.getElementById(`choose${character.charAt(0).toUpperCase()+character.slice(1)}`);
            if (option.classList.contains('locked')) {
                playSound('locked');
                document.getElementById('characterTakenMessage').textContent = `‚ùå ${character.toUpperCase()} is already taken!`;
                return;
            }
            playSound('select');
            selectedCharacter = character;
            document.querySelectorAll('.character-option').forEach(opt=>opt.classList.remove('selected'));
            option.classList.add('selected');
            document.getElementById('confirmCharacterBtn').disabled = false;
            document.getElementById('confirmCharacterBtn').textContent = `‚ö° FIGHT AS ${character.toUpperCase()} ‚ö°`;
        };

        window.confirmCharacter = async function() {
            if (!selectedCharacter) return;
            playSound('select');
            await initFirebaseAndStart();
            const snapshot = await battleRef.child('characters').once('value');
            const characters = snapshot.val() || {};
            if (characters.player1 === selectedCharacter || characters.player2 === selectedCharacter) {
                playSound('locked');
                document.getElementById('characterTakenMessage').textContent = `‚ùå ${selectedCharacter.toUpperCase()} already taken!`;
                return;
            }
            if (playerRole === 'player1') {
                await battleRef.child('characters/player1').set(selectedCharacter);
            } else if (playerRole === 'player2') {
                await battleRef.child('characters/player2').set(selectedCharacter);
            } else {
                if (!characters.player1) {
                    await battleRef.child('characters/player1').set(selectedCharacter);
                    playerRole = 'player1';
                } else if (!characters.player2) {
                    await battleRef.child('characters/player2').set(selectedCharacter);
                    playerRole = 'player2';
                } else {
                    alert('Game full!'); return;
                }
            }
            proceedToGame();
        };

        async function initFirebaseAndStart() {
            try {
                if (typeof firebase === 'undefined') await loadFirebaseScripts();
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                battleRef = database.ref('battles/' + battleCode);
                battleRef.child('characters').on('value', (snap) => updateCharacterSelectionUI(snap.val() || {}));
            } catch(e){ console.error(e); }
        }

        function updateCharacterSelectionUI(chars) {
            const kTaken = document.getElementById('kenjiTaken');
            const sTaken = document.getElementById('sakuraTaken');
            const kOpt = document.getElementById('chooseKenji');
            const sOpt = document.getElementById('chooseSakura');
            const msg = document.getElementById('characterTakenMessage');
            if (chars.player1==='kenji'||chars.player2==='kenji') {
                kTaken.style.display='block'; kOpt.classList.add('locked');
                if (!chars.player1||!chars.player2) msg.textContent='‚öîÔ∏è Kenji taken! Sakura free.';
            } else { kTaken.style.display='none'; kOpt.classList.remove('locked'); }
            if (chars.player1==='sakura'||chars.player2==='sakura') {
                sTaken.style.display='block'; sOpt.classList.add('locked');
                if (!chars.player1||!chars.player2) msg.textContent='üå∏ Sakura taken! Kenji free.';
            } else { sTaken.style.display='none'; sOpt.classList.remove('locked'); }
            if (chars.player1 && chars.player2) { msg.textContent='‚ö†Ô∏è BOTH TAKEN'; document.getElementById('confirmCharacterBtn').disabled=true; }
            if (!chars.player1 && !chars.player2) msg.textContent='‚ö° Choose your warrior';
        }

        function proceedToGame() {
            playSound('victory');
            document.getElementById('characterModal').classList.add('hidden');
            document.getElementById('rightPanel').style.display = 'flex';
            document.getElementById('backBtn').style.display = 'block';
            document.getElementById('soundToggle').style.display = 'block';
            document.getElementById('battleInfoMobile').innerHTML = `‚öîÔ∏è ${battleCode || 'ARENA'} ¬∑ ROUND 1`;
            if (playerRole === 'player1') {
                if (selectedCharacter === 'kenji') {
                    document.getElementById('p1Name').textContent = 'KENJI (YOU)';
                    document.getElementById('p2Name').textContent = '???';
                } else {
                    document.getElementById('p1Name').textContent = 'SAKURA (YOU)';
                    document.getElementById('p2Name').textContent = '???';
                }
            } else {
                if (selectedCharacter === 'kenji') {
                    document.getElementById('p2Name').textContent = 'KENJI (YOU)';
                    document.getElementById('p1Name').textContent = '???';
                } else {
                    document.getElementById('p2Name').textContent = 'SAKURA (YOU)';
                    document.getElementById('p1Name').textContent = '???';
                }
            }
            window.gamePlayerRole = playerRole;
            window.gamePlayerId = playerId;
            window.gameBattleCode = battleCode;
            const equippedMoves = loadEquippedMoves();
            if (battleRef) {
                battleRef.child(playerRole==='player1'?'player1/moves':'player2/moves').set(equippedMoves);
            }
            startGameInstance();
        }

        function loadFirebaseScripts() {
            return new Promise((resolve,reject)=>{
                const s=document.createElement('script'); s.src='https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js';
                s.onload=()=>{ const d=document.createElement('script'); d.src='https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js'; d.onload=resolve; d.onerror=reject; document.head.appendChild(d); };
                s.onerror=reject; document.head.appendChild(s);
            });
        }

        function loadEquippedMoves() {
            try {
                const equippedIds = JSON.parse(localStorage.getItem('battleEquippedMoves')||'["punch","kick"]');
                const owned = JSON.parse(localStorage.getItem('battleOwnedMoves')||'[]');
                return [MOVE_DATABASE.punch, MOVE_DATABASE.kick, ...owned.filter(m=>equippedIds.includes(m.id))];
            } catch(e){ return [MOVE_DATABASE.punch, MOVE_DATABASE.kick]; }
        }

        function startGameInstance() { window.game = new FightingGame(window.gamePlayerRole||playerRole); }
        window.restartGame = function() { location.reload(); };

        // ========== FIGHTING GAME CLASS (with proper position sync) ==========
        class FightingGame {
            constructor(role) {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resizeCanvas();
                this.playerRole = role;
                this.playerId = window.gamePlayerId || playerId;
                this.battleRef = battleRef;
                this.gameOver = false;
                this.myMoves = loadEquippedMoves();
                this.frame = 0;
                this.timer = 99;
                this.comboChain = { count:0, timer:0, maxTimer:120, multiplier:1 };
                this.combo = { count:0, timer:0 };
                this.shakeIntensity = 0;
                this.moveSpeed = 5;
                this.buttonStates = { left:false, right:false, punch:false, kick:false, block:false };
                this.rageMode = false;
                this.rageTimer = 0;
                this.maxRageTimer = 300;
                this.rageGainPerHit = 25;
                this.bloodParticles = [];
                this.specialEffects = [];
                this.blockEffects = [];
                this.shockwaves = [];

                // Original character images (using working placeholder URLs ‚Äì replace with your actual image URLs)
                this.images = {
                    kenji: {
                        idle: this.loadImage('adventurer_idle.png'),
                        punch: this.loadImage('adventurer_action2.png'),
                        kick: this.loadImage('adventurer_kick.png'),
                        hurt: this.loadImage('adventurer_hurt.png'),
                        win: this.loadImage('adventurer_slide.png')
                    },
                    sakura: {
                        idle: this.loadImage('female_idle.png'),
                        punch: this.loadImage('female_action2.png'),
                        kick: this.loadImage('female_kick.png'),
                        hurt: this.loadImage('female_hurt.png'),
                        win: this.loadImage('female_hang.png')
                    }
                };

                // Players start far apart
                this.players = [
                    { id:null, x:250, y:400, health:100, maxHealth:100, special:100, maxSpecial:100, rage:0, maxRage:100,
                      state:'idle', stateTimer:0, facing:1, speed:this.moveSpeed, images:null, attackTimer:0, isBlocking:false,
                      controlledBy:'player1', hitLocked:false },
                    { id:null, x:950, y:400, health:100, maxHealth:100, special:100, maxSpecial:100, rage:0, maxRage:100,
                      state:'idle', stateTimer:0, facing:-1, speed:this.moveSpeed, images:null, attackTimer:0, isBlocking:false,
                      controlledBy:'player2', hitLocked:false }
                ];

                window.game = this;
                this.loadedImages = 0;
                this.totalImages = 10;
                this.setupButtonListeners();
                this.setupKeyboardControls();
                this.loadCharacterAssignments();
                this.checkImagesLoaded();
                window.addEventListener('resize', ()=>this.resizeCanvas());
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }

            loadImage(src) {
                const img = new Image();
                img.onload = () => { this.loadedImages++; if(this.loadedImages===this.totalImages) this.startGame(); };
                img.onerror = () => {
                    this.loadedImages++;
                    // fallback: coloured rectangle with emoji
                    const canvas = document.createElement('canvas'); canvas.width=100; canvas.height=120;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = src.includes('kenji')||src.includes('8iF')?'#ef4444':'#ff69b4';
                    ctx.fillRect(20,20,60,80);
                    ctx.fillStyle='#ffffff'; ctx.font='bold 40px Arial';
                    ctx.fillText(src.includes('kenji')||src.includes('8iF')?'‚öîÔ∏è':'üå∏', 35, 70);
                    const fallback = new Image(); fallback.src = canvas.toDataURL();
                    if(src.includes('kenji')||src.includes('8iF')) this.images.kenji[src.split('_')[0]?.split('/').pop()?.split('.')[0]||'idle'] = fallback;
                    else this.images.sakura[src.split('_')[0]?.split('/').pop()?.split('.')[0]||'idle'] = fallback;
                    if(this.loadedImages===this.totalImages) this.startGame();
                };
                img.src = src;
                return img;
            }

            checkImagesLoaded() { setTimeout(()=>{ if(this.loadedImages<this.totalImages) this.startGame(); },2000); }

            loadCharacterAssignments() {
                if (!this.battleRef) return;
                this.battleRef.child('characters').on('value', (snap) => {
                    const chars = snap.val() || {};
                    let both = true;
                    if (chars.player1 === 'kenji') { this.players[0].id='kenji'; this.players[0].images=this.images.kenji; }
                    else if (chars.player1 === 'sakura') { this.players[0].id='sakura'; this.players[0].images=this.images.sakura; }
                    else both = false;
                    if (chars.player2 === 'kenji') { this.players[1].id='kenji'; this.players[1].images=this.images.kenji; }
                    else if (chars.player2 === 'sakura') { this.players[1].id='sakura'; this.players[1].images=this.images.sakura; }
                    else both = false;
                    if (both) {
                        if (this.playerRole==='player1') {
                            if(this.players[0].id==='kenji') { document.getElementById('p1Name').textContent='KENJI (YOU)'; document.getElementById('p2Name').textContent=this.players[1].id==='kenji'?'KENJI':'SAKURA'; }
                            else { document.getElementById('p1Name').textContent='SAKURA (YOU)'; document.getElementById('p2Name').textContent=this.players[1].id==='kenji'?'KENJI':'SAKURA'; }
                        } else {
                            if(this.players[1].id==='kenji') { document.getElementById('p2Name').textContent='KENJI (YOU)'; document.getElementById('p1Name').textContent=this.players[0].id==='kenji'?'KENJI':'SAKURA'; }
                            else { document.getElementById('p2Name').textContent='SAKURA (YOU)'; document.getElementById('p1Name').textContent=this.players[0].id==='kenji'?'KENJI':'SAKURA'; }
                        }
                    } else {
                        if(!chars.player1||!chars.player2) this.showBattleMessage('‚è≥ Waiting for opponent...','#fbbf24');
                    }
                });
            }

            setupKeyboardControls() {
                document.addEventListener('keydown', (e)=>{
                    if(this.gameOver) return;
                    const k=e.key.toLowerCase();
                    if(k==='a'||k==='arrowleft'){ e.preventDefault(); this.buttonStates.left=true; }
                    if(k==='d'||k==='arrowright'){ e.preventDefault(); this.buttonStates.right=true; }
                    if(k==='j'){ e.preventDefault(); this.performAttack(3,'punch'); }
                    if(k==='k'){ e.preventDefault(); this.performAttack(4,'kick'); }
                    if(k==='l'){ e.preventDefault(); this.buttonStates.block=true; }
                    if(k==='u'){ e.preventDefault(); this.useUltimate(); }
                    if(k==='r' && this.gameOver) restartGame();
                });
                document.addEventListener('keyup', (e)=>{
                    const k=e.key.toLowerCase();
                    if(k==='a'||k==='arrowleft') this.buttonStates.left=false;
                    if(k==='d'||k==='arrowright') this.buttonStates.right=false;
                    if(k==='l') this.buttonStates.block=false;
                });
            }

            setupButtonListeners() { }

            press(action) {
                if(this.gameOver) return;
                const my=this.players.find(p=>p.controlledBy===this.playerRole);
                const opp=this.players.find(p=>p.controlledBy!==this.playerRole);
                if(!my||!opp) return;
                switch(action){
                    case'left': this.buttonStates.left=true; break;
                    case'right': this.buttonStates.right=true; break;
                    case'punch': this.performAttack(3,'punch'); break;
                    case'kick': this.performAttack(4,'kick'); break;
                    case'block': this.buttonStates.block=true; break;
                    case'ultimate': this.useUltimate(); break;
                }
            }
            release(action) {
                if(action==='left') this.buttonStates.left=false;
                if(action==='right') this.buttonStates.right=false;
                if(action==='block') this.buttonStates.block=false;
            }

            useUltimate() {
                const my=this.players.find(p=>p.controlledBy===this.playerRole);
                const opp=this.players.find(p=>p.controlledBy!==this.playerRole);
                if(!my||!opp||this.gameOver) return;
                if(!this.rageMode){ this.showBattleMessage('‚ùå NEED RAGE MODE!','#ff0000'); return; }
                opp.health=0;
                this.showBattleMessage('üíÄ ULTIMATE!','#ff0000'); playSound('ultimate',0.8);
                for(let i=0;i<100;i++) this.bloodParticles.push({ x:opp.x, y:opp.y-50, vx:(Math.random()-0.5)*30, vy:(Math.random()-0.5)*30-10, life:2, size:5+Math.random()*10, color:'#8B0000' });
                if(opp.id==='kenji') document.getElementById('p1HealthFill').style.width='0%';
                else document.getElementById('p2HealthFill').style.width='0%';
                this.checkGameOver();
            }

            startGame() {
                document.getElementById('gameCanvas').style.display='block';
                this.createSpecialMovesUI();
                this.startPositionSync();
                this.listenForUpdates();
                this.gameLoop();
                playSound('select');
            }

            startPositionSync() {
                if(positionUpdateInterval) clearInterval(positionUpdateInterval);
                positionUpdateInterval = setInterval(()=>{
                    if(this.gameOver||!this.battleRef) return;
                    const my=this.players.find(p=>p.controlledBy===this.playerRole);
                    if(!my||my.hitLocked||!my.id) return;
                    const pos={}; pos[my.id]={ x: my.x };
                    this.battleRef.child('positions').update(pos).catch(()=>{});
                }, 50);
            }

            listenForUpdates() {
                if(!this.battleRef) return;
                this.battleRef.child('player1/health').on('value',(s)=>{
                    const h=s.val(); if(h!==null && this.players[0].health!==h){ this.players[0].health=h; document.getElementById('p1HealthFill').style.width=h+'%'; this.checkGameOver(); }
                });
                this.battleRef.child('player2/health').on('value',(s)=>{
                    const h=s.val(); if(h!==null && this.players[1].health!==h){ this.players[1].health=h; document.getElementById('p2HealthFill').style.width=h+'%'; this.checkGameOver(); }
                });
                this.battleRef.child('player1/mana').on('value',(s)=>{
                    const m=s.val(); if(m!==null && this.players[0].special!==m){ this.players[0].special=m; document.getElementById('p1SpecialFill').style.width=m+'%'; }
                });
                this.battleRef.child('player2/mana').on('value',(s)=>{
                    const m=s.val(); if(m!==null && this.players[1].special!==m){ this.players[1].special=m; document.getElementById('p2SpecialFill').style.width=m+'%'; }
                });
                this.battleRef.child('positions').on('value',(s)=>{
                    const pos=s.val();
                    if(pos && !this.gameOver){
                        // Only update the opponent's position ‚Äì never overwrite our own
                        if(this.playerRole==='player1' && pos.sakura && this.players[1]) {
                            this.players[1].x = pos.sakura.x;
                        }
                        else if(this.playerRole==='player2' && pos.kenji && this.players[0]) {
                            this.players[0].x = pos.kenji.x;
                        }
                    }
                });
            }

           createSpecialMovesUI() {
    const container = document.getElementById('specialMoves'); 
    if(!container) return;
    
    container.innerHTML = '';
    
    // Filter out basic punches/kicks, keep only special moves
    const special = this.myMoves.filter(m => m.id !== 'punch' && m.id !== 'kick');
    
    if(special.length === 0) { 
        container.innerHTML = '<div style="color:#fbbf24; text-align:center; padding:10px; font-size:14px; width:100%;">‚ö° NO SPECIAL MOVES</div>'; 
        return; 
    }
    
    // Create a button for each special move
    special.forEach(move => {
        const btn = document.createElement('button');
        btn.className = `special-move-btn ${move.rarity || 'common'}`;
        btn.innerHTML = `<span class="icon">${move.icon}</span><span>${move.name}</span><span class="cost">${move.manaCost}</span>`;
        
        // Add event listeners
        btn.onmousedown = (e) => { 
            e.preventDefault(); 
            this.useSpecialMove(move); 
        };
        btn.ontouchstart = (e) => { 
            e.preventDefault(); 
            this.useSpecialMove(move); 
        };
        
        container.appendChild(btn);
    });
}
            useSpecialMove(move) {
                const my=this.players.find(p=>p.controlledBy===this.playerRole);
                const opp=this.players.find(p=>p.controlledBy!==this.playerRole);
                if(!my||!opp||this.gameOver) return;
                if(my.hitLocked||my.state==='hurt'||my.attackTimer>0){ this.showBattleMessage('‚ùå CANNOT ACT!','#ef4444'); return; }
                if(Math.abs(my.x-opp.x)>250){ this.showBattleMessage('‚ùå TOO FAR!','#ef4444'); return; }
                if(my.special < move.manaCost){ this.showBattleMessage(`‚ùå NEED ${move.manaCost} MP`,'#ef4444'); return; }
                my.special -= move.manaCost;
                if(move.heal){
                    my.health = Math.min(100, my.health+move.heal);
                    this.showBattleMessage(`üíö +${move.heal} HP`,'#10b981'); playSound('special');
                    if(my.id==='kenji') document.getElementById('p1HealthFill').style.width=my.health+'%';
                    else document.getElementById('p2HealthFill').style.width=my.health+'%';
                } else {
                    const chainBonus = this.comboChain.multiplier;
                    const dmgBoost = this.rageMode?1.5:1;
                    const crit = Math.random()<0.2;
                    let finalDmg = Math.floor(move.damage * dmgBoost * chainBonus);
                    if(crit){ finalDmg+=Math.floor(move.damage*0.5); this.showBattleMessage(`‚ú® CRITICAL! ${finalDmg}`,'#ffd700'); playSound('critical'); }
                    else this.showBattleMessage(`üí• -${finalDmg}`,'#ef4444');
                    opp.health = Math.max(0, opp.health - finalDmg);
                    if(opp.id==='kenji') document.getElementById('p1HealthFill').style.width=opp.health+'%';
                    else document.getElementById('p2HealthFill').style.width=opp.health+'%';
                    opp.hitLocked=true; opp.state='hurt'; opp.stateTimer=15;
                    opp.x += (my.facing>0?120:-120); opp.x = Math.max(200, Math.min(1000, opp.x));
                    this.shakeIntensity = 35;
                    for(let i=0;i<(this.rageMode?40:20);i++) this.bloodParticles.push({ x:opp.x, y:opp.y-50, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, life:1.2, size:3+Math.random()*6, color:crit?'#8B0000':'#B22222' });
                    my.rage = Math.min(my.maxRage, my.rage + this.rageGainPerHit);
                    if(my.rage>=my.maxRage && !this.rageMode) this.activateRageMode();
                }
                my.attackTimer=20; my.state='punch'; my.stateTimer=15;
                document.getElementById('p1SpecialFill').style.width=this.players[0].special+'%';
                document.getElementById('p2SpecialFill').style.width=this.players[1].special+'%';
                document.getElementById('p1RageFill').style.width=this.players[0].rage+'%';
                document.getElementById('p2RageFill').style.width=this.players[1].rage+'%';
                if(this.battleRef){
                    const hpPath = opp.id==='kenji'?'player1/health':'player2/health';
                    const mpPath = my.id==='kenji'?'player1/mana':'player2/mana';
                    const posPath = opp.id==='kenji'?'positions/kenji':'positions/sakura';
                    this.battleRef.child(hpPath).set(opp.health);
                    this.battleRef.child(mpPath).set(my.special);
                    this.battleRef.child(posPath).set({ x: opp.x });
                }
                this.checkGameOver();
            }

            activateRageMode() {
                this.rageMode=true; this.rageTimer=this.maxRageTimer; playSound('rage',0.7);
                document.getElementById('rageIndicator').style.display='block';
                document.querySelector('canvas').classList.add('rage-mode');
                this.showBattleMessage('‚ö° RAGE MODE!','#ff0000'); this.shakeIntensity=30;
                const my=this.players.find(p=>p.controlledBy===this.playerRole); if(my) my.rage=0;
            }

            updateRageMode() {
                if(this.rageMode){
                    this.rageTimer--;
                    document.getElementById('rageIndicator').innerHTML = `‚ö° ${Math.ceil(this.rageTimer/60)}s ‚ö°`;
                    if(this.rageTimer<=0){ this.rageMode=false; document.getElementById('rageIndicator').style.display='none'; document.querySelector('canvas').classList.remove('rage-mode'); this.showBattleMessage('üí§ RAGE EXPIRED','#888'); }
                }
            }

            updateComboChain() {
                if(this.comboChain.count>0){
                    this.comboChain.timer--;
                    let mult = 1;
                    if(this.comboChain.count>=10) mult=3.0;
                    else if(this.comboChain.count>=7) mult=2.5;
                    else if(this.comboChain.count>=5) mult=2.0;
                    else if(this.comboChain.count>=3) mult=1.5;
                    this.comboChain.multiplier = mult;
                    document.getElementById('comboIndicator').style.display='block';
                    document.getElementById('comboIndicator').innerHTML = `üî• ${this.comboChain.count}x (${mult.toFixed(1)}x)`;
                    if(this.comboChain.timer<=0){ this.comboChain.count=0; this.comboChain.multiplier=1; document.getElementById('comboIndicator').style.display='none'; }
                } else document.getElementById('comboIndicator').style.display='none';
            }

            checkGameOver() {
                if(this.gameOver) return;
                if(this.players[0].health<=0 || this.players[1].health<=0){
                    this.gameOver=true;
                    const winner = this.players[0].health<=0 ? 'player2' : 'player1';
                    const playerWon = (this.playerRole === winner);
                    document.getElementById('victoryText').textContent = playerWon ? 'VICTORY!' : 'DEFEAT!';
                    document.getElementById('gameOverlay').classList.add('show');
                    const xp = playerWon ? 100 : 25;
                    document.getElementById('xpGained').textContent = `+${xp} XP`;
                    playSound('ko',0.8);
                    for(let i=0;i<100;i++) this.bloodParticles.push({ x:this.players[0].x, y:this.players[0].y-50, vx:(Math.random()-0.5)*25, vy:(Math.random()-0.5)*25-15, life:2, size:4+Math.random()*10, color:'#8B0000' });
                    if(positionUpdateInterval) clearInterval(positionUpdateInterval);
                    return true;
                }
                return false;
            }

            showBattleMessage(msg,color) {
                const d=document.createElement('div'); d.className='battle-message'; d.style.color=color; d.textContent=msg;
                document.body.appendChild(d); setTimeout(()=>d.remove(),1500);
            }

            performAttack(damage, type) {
                const attacker = this.players.find(p=>p.controlledBy===this.playerRole);
                const defender = this.players.find(p=>p.controlledBy!==this.playerRole);
                if(!attacker||!defender) return;
                const dist = Math.abs(attacker.x - defender.x);
                if(dist < 200){
                    const blocking = defender.isBlocking;
                    let finalDmg = Math.floor(damage * (this.rageMode?1.5:1) * this.comboChain.multiplier);
                    if(blocking) finalDmg = Math.floor(finalDmg*0.2);
                    defender.health = Math.max(0, defender.health - finalDmg);
                    defender.hitLocked=true; defender.state='hurt'; defender.stateTimer=15;
                    attacker.state=type; attacker.stateTimer=15; attacker.attackTimer=20;
                    if(!blocking){
                        attacker.special = Math.min(attacker.maxSpecial, attacker.special+8);
                        this.comboChain.count++; this.comboChain.timer=this.comboChain.maxTimer; playSound('chain',0.3);
                        this.combo.count++; this.combo.timer=30;
                        document.getElementById('comboIndicator').style.display='block';
                        document.getElementById('comboIndicator').innerHTML = `üî• ${this.combo.count} HIT!`;
                        if(this.combo.count%5===0){
                            playSound('critical');
                            this.shockwaves.push({ x:defender.x, y:defender.y-50, radius:30, life:1 });
                            attacker.rage = Math.min(attacker.maxRage, attacker.rage+40);
                        }
                        playSound('crowd',0.1); playSound('blood',0.3);
                        for(let i=0;i<(this.rageMode?20:10);i++) this.bloodParticles.push({ x:defender.x, y:defender.y-50, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12-5, life:1, size:2+Math.random()*5, color:'#B22222' });
                        attacker.rage = Math.min(attacker.maxRage, attacker.rage+this.rageGainPerHit);
                        if(attacker.rage>=attacker.maxRage && !this.rageMode) this.activateRageMode();
                    } else {
                        for(let i=0;i<8;i++) this.blockEffects.push({ x:defender.x, y:defender.y-50, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, life:0.5, color:'#22c55e' });
                        this.comboChain.count=0; this.comboChain.multiplier=1;
                    }
                    document.getElementById('p1HealthFill').style.width = this.players[0].health+'%';
                    document.getElementById('p2HealthFill').style.width = this.players[1].health+'%';
                    document.getElementById('p1RageFill').style.width = this.players[0].rage+'%';
                    document.getElementById('p2RageFill').style.width = this.players[1].rage+'%';
                    if(this.battleRef){
                        const hpPath = defender.id==='kenji'?'player1/health':'player2/health';
                        const mpPath = attacker.id==='kenji'?'player1/mana':'player2/mana';
                        const posPath = defender.id==='kenji'?'positions/kenji':'positions/sakura';
                        this.battleRef.child(hpPath).set(defender.health);
                        this.battleRef.child(mpPath).set(attacker.special);
                        this.battleRef.child(posPath).set({ x: defender.x });
                    }
                    this.checkGameOver();
                }
            }

            update() {
                if(this.gameOver) return;
                this.frame++;
                this.updateRageMode();
                this.updateComboChain();
                if(this.shakeIntensity>0) this.shakeIntensity*=0.9;
                if(this.frame%60===0 && this.timer>0){ this.timer--; document.getElementById('timerDisplay').textContent=this.timer; if(this.timer<=10) playSound('warning',0.2); }
                if(this.timer<=0){
                    if(this.players[0].health > this.players[1].health) this.players[1].health=0;
                    else if(this.players[1].health > this.players[0].health) this.players[0].health=0;
                    else Math.random()<0.5 ? this.players[0].health=0 : this.players[1].health=0;
                    this.checkGameOver();
                }
                this.players.forEach(p=>{ if(p.stateTimer>0 && --p.stateTimer<=0){ p.state='idle'; p.hitLocked=false; } });
                this.players.forEach(p=>{ if(p.attackTimer>0) p.attackTimer--; });
                if(this.combo.timer>0 && --this.combo.timer<=0){ this.combo.count=0; document.getElementById('comboIndicator').style.display='none'; }
                this.bloodParticles = this.bloodParticles.filter(p=>p.life>0);
                this.bloodParticles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.2; p.life-=0.01; });
                this.specialEffects = this.specialEffects.filter(e=>e.life>0);
                this.specialEffects.forEach(e=>{ e.x+=e.vx; e.y+=e.vy; e.life-=0.02; });
                this.blockEffects = this.blockEffects.filter(e=>e.life>0);
                this.blockEffects.forEach(e=>{ e.x+=e.vx; e.y+=e.vy; e.life-=0.02; });
                this.shockwaves = this.shockwaves.filter(s=>s.life>0);
                this.shockwaves.forEach(s=>{ s.radius+=8; s.life-=0.02; });
                const my=this.players.find(p=>p.controlledBy===this.playerRole);
                const opp=this.players.find(p=>p.controlledBy!==this.playerRole);
                if(my && opp) this.updatePlayer(my,opp);
                document.getElementById('p1HealthFill').style.width=this.players[0].health+'%';
                document.getElementById('p2HealthFill').style.width=this.players[1].health+'%';
                document.getElementById('p1SpecialFill').style.width=this.players[0].special+'%';
                document.getElementById('p2SpecialFill').style.width=this.players[1].special+'%';
                document.getElementById('p1RageFill').style.width=this.players[0].rage+'%';
                document.getElementById('p2RageFill').style.width=this.players[1].rage+'%';
            }

            updatePlayer(player, opponent) {
                player.isBlocking = this.buttonStates.block;
                let move=0;
                if(player.state!=='hurt' && player.stateTimer<=0 && !player.hitLocked){
                    if(this.buttonStates.left) move = -player.speed;
                    if(this.buttonStates.right) move = player.speed;
                }
                if(move!==0){ player.x += move; player.x = Math.max(200, Math.min(1000, player.x)); }
                player.facing = opponent.x > player.x ? 1 : -1;
                player.y = 400 + Math.sin(this.frame*0.1)*5;
                if(player.special < player.maxSpecial) player.special = Math.min(player.maxSpecial, player.special+0.2);
                if(player.rage > 0 && !this.rageMode) player.rage = Math.max(0, player.rage-0.1);
            }

            draw() {
                this.ctx.save();
                if(this.shakeIntensity>0) this.ctx.translate((Math.random()-0.5)*this.shakeIntensity*2, (Math.random()-0.5)*this.shakeIntensity);
                this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                
                const scaleX = this.canvas.width/1200;
                const scaleY = this.canvas.height/700;
                const scale = Math.min(scaleX, scaleY);
                const offsetX = (this.canvas.width-1200*scale)/2;
                const offsetY = (this.canvas.height-700*scale)/2;
                
                this.ctx.save();
                this.ctx.translate(offsetX, offsetY);
                this.ctx.scale(scale, scale);
                
                // Background
                const grad = this.ctx.createLinearGradient(0,0,0,700);
                grad.addColorStop(0,'#0a1a2a'); grad.addColorStop(0.5,'#1a2a3a'); grad.addColorStop(1,'#2a1a1a');
                this.ctx.fillStyle=grad; this.ctx.fillRect(0,0,1200,700);
                this.ctx.fillStyle='#2a3a2a'; this.ctx.fillRect(0,400,1200,300);
                this.ctx.strokeStyle='#fbbf24'; this.ctx.lineWidth=2; this.ctx.setLineDash([15,15]);
                this.ctx.beginPath(); this.ctx.moveTo(0,420); this.ctx.lineTo(1200,420); this.ctx.stroke(); this.ctx.setLineDash([]);
                if(this.rageMode) { this.ctx.fillStyle='rgba(255,0,0,0.1)'; this.ctx.fillRect(0,0,1200,700); }
                
                this.shockwaves.forEach(s=>{
                    this.ctx.save(); this.ctx.globalAlpha=s.life*0.7; this.ctx.strokeStyle='#fff'; this.ctx.lineWidth=4; this.ctx.shadowColor='#fbbf24'; this.ctx.shadowBlur=20;
                    this.ctx.beginPath(); this.ctx.arc(s.x,s.y,s.radius,0,Math.PI*2); this.ctx.stroke(); this.ctx.restore();
                });
                
                this.players.forEach(p=>this.drawPlayer(p));
                
                this.bloodParticles.forEach(p=>{
                    this.ctx.save(); this.ctx.globalAlpha=p.life*0.8; this.ctx.fillStyle=p.color; this.ctx.shadowColor='#8B0000'; this.ctx.shadowBlur=10;
                    this.ctx.beginPath(); this.ctx.arc(p.x,p.y,p.size||4,0,Math.PI*2); this.ctx.fill(); this.ctx.restore();
                });
                
                this.specialEffects.forEach(e=>{
                    this.ctx.save(); this.ctx.globalAlpha=e.life; this.ctx.fillStyle=e.color; this.ctx.shadowColor='#ffd700'; this.ctx.shadowBlur=15;
                    this.ctx.beginPath(); this.ctx.arc(e.x,e.y,8,0,Math.PI*2); this.ctx.fill(); this.ctx.restore();
                });
                this.blockEffects.forEach(e=>{
                    this.ctx.save(); this.ctx.globalAlpha=e.life; this.ctx.fillStyle=e.color; this.ctx.shadowColor='#22c55e'; this.ctx.shadowBlur=15;
                    this.ctx.beginPath(); this.ctx.arc(e.x,e.y,6,0,Math.PI*2); this.ctx.fill(); this.ctx.restore();
                });
                
                this.ctx.restore();
                this.ctx.restore();
            }

            drawPlayer(p) {
                if(!p.id||!p.images){
                    this.ctx.save();
                    this.ctx.fillStyle='rgba(100,100,100,0.5)'; this.ctx.fillRect(p.x-50, p.y-120, 100, 120);
                    this.ctx.fillStyle='#fbbf24'; this.ctx.font='bold 60px Arial'; this.ctx.textAlign='center'; this.ctx.textBaseline='middle';
                    this.ctx.fillText('?',p.x, p.y-40);
                    this.ctx.restore(); return;
                }
                const img = p.images[p.state] || p.images.idle;
                const x = p.x-50, y = p.y-120, w=100, h=120;
                this.ctx.save();
                if(p.facing===-1){ this.ctx.translate(p.x, p.y-60); this.ctx.scale(-1,1); this.ctx.translate(-p.x, -(p.y-60)); }
                if(this.rageMode && p.controlledBy===this.playerRole){ this.ctx.shadowColor='#ff0000'; this.ctx.shadowBlur=40; }
                if(this.comboChain.multiplier>1 && p.controlledBy===this.playerRole){ this.ctx.shadowColor='#ffd700'; this.ctx.shadowBlur=30+(this.comboChain.multiplier*10); }
                
                if(img && img.complete && img.naturalHeight!==0){
                    this.ctx.drawImage(img, x, y, w, h);
                } else {
                    this.ctx.fillStyle = p.id==='kenji'?'#ef4444':'#ff69b4';
                    this.ctx.fillRect(x, y, w, h);
                    this.ctx.fillStyle='#ffffff'; this.ctx.font='bold 40px Arial';
                    this.ctx.fillText(p.id==='kenji'?'‚öîÔ∏è':'üå∏', x+30, y+70);
                }
                
                if(p.controlledBy===this.playerRole){
                    this.ctx.shadowColor='#fbbf24'; this.ctx.shadowBlur=30; this.ctx.strokeStyle='#fbbf24'; this.ctx.lineWidth=4; this.ctx.setLineDash([8,8]);
                    this.ctx.beginPath(); this.ctx.ellipse(p.x, p.y-60, 45, 60, 0, 0, Math.PI*2); this.ctx.stroke(); this.ctx.setLineDash([]);
                }
                if(p.isBlocking){
                    this.ctx.shadowColor='#22c55e'; this.ctx.shadowBlur=40; this.ctx.strokeStyle='#22c55e'; this.ctx.lineWidth=5;
                    this.ctx.beginPath(); this.ctx.ellipse(p.x, p.y-60, 50, 70, 0, 0, Math.PI*2); this.ctx.stroke();
                    this.ctx.fillStyle='rgba(34,197,94,0.2)'; this.ctx.fill();
                }
                if((this.buttonStates.left||this.buttonStates.right) && p.state!=='hurt' && !p.hitLocked && p.controlledBy===this.playerRole){
                    for(let i=0;i<4;i++){
                        this.ctx.strokeStyle = `rgba(255,255,255,${0.2-i*0.04})`; this.ctx.lineWidth=2; this.ctx.beginPath();
                        const dir = this.buttonStates.left?-1:1;
                        this.ctx.moveTo(p.x-(dir*30), p.y-60+i*10); this.ctx.lineTo(p.x-(dir*100), p.y-60+i*10+(i-2)*5); this.ctx.stroke();
                    }
                }
                this.ctx.restore();
            }

            gameLoop() { this.update(); this.draw(); requestAnimationFrame(()=>this.gameLoop()); }
        }
    </script>
</body>
</html>
