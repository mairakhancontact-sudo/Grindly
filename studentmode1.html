<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grindly | Student Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#4f46e5">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="dns-prefetch" href="https://www.gstatic.com">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<!-- Chart.js for Statistics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>


<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Inter:wght@400;500;600;700&family=Sora:wght@400;500;600;700&display=swap');
/* ===== CSS VARIABLES ===== */
:root {
  /* Light theme (default) - optimized for contrast */
  --bg: #f1f5f9;
  --card: #ffffff;
  --text: #0f172a;
  --text-muted: #475569;
  --border: #e2e8f0;
  --accent: #4f46e5;
  --accent-dark: #4338ca;
  --accent-light: #e0e7ff;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  
  /* Spacing */
  --spacing-xs: 0.5rem;
  --spacing-sm: 0.75rem;
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --spacing-2xl: 3rem;
  
  /* Border Radius */
  --radius-sm: 0.5rem;
  --radius: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.25rem;
  --radius-2xl: 1.5rem;
  
  /* Shadows */
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
  --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
  
  /* Transitions */
  --transition-fast: 0.18s cubic-bezier(0.22, 1, 0.36, 1);
  --transition: 0.32s cubic-bezier(0.22, 1, 0.36, 1);
  --transition-slow: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
  
  /* Gradients */
  --gradient-primary: linear-gradient(135deg, var(--accent), var(--accent-dark));
  --gradient-success: linear-gradient(135deg, var(--success), #059669);
  --gradient-warning: linear-gradient(135deg, var(--warning), #d97706);
  --gradient-danger: linear-gradient(135deg, var(--danger), #dc2626);
  --gradient-info: linear-gradient(135deg, var(--info), #2563eb);
  --gradient-purple: linear-gradient(135deg, var(--purple), #7c3aed);

  /* Poll (theme-adaptive) */
  --poll-bg: #ffffff;
  --poll-text: #202124;
  --poll-muted: #5f6368;
  --poll-border: #dadce0;
  --poll-divider: #e0e0e0;
  --poll-input-bg: #ffffff;
  --poll-button-bg: #f1f3f4;
  --poll-button-hover: #e8eaed;
  --poll-radio: #5f6368;

  /* Aggregate heatmap */
  --heat-0: rgba(148, 163, 184, 0.2);
  --heat-1: rgba(79, 70, 229, 0.2);
  --heat-2: rgba(79, 70, 229, 0.4);
  --heat-3: rgba(79, 70, 229, 0.65);
  --heat-4: rgba(79, 70, 229, 0.9);

  /* Fluid typography */
  --text-xs: clamp(0.6875rem, 0.65rem + 0.15vw, 0.75rem);
  --text-sm: clamp(0.8125rem, 0.75rem + 0.2vw, 0.875rem);
  --text-base: clamp(0.875rem, 0.8rem + 0.25vw, 1rem);
  --text-lg: clamp(1rem, 0.9rem + 0.35vw, 1.125rem);
  --text-xl: clamp(1.125rem, 1rem + 0.5vw, 1.25rem);
  --text-2xl: clamp(1.25rem, 1.1rem + 0.75vw, 1.5rem);
  --text-3xl: clamp(1.5rem, 1.25rem + 1.25vw, 2rem);
  --text-4xl: clamp(1.75rem, 1.5rem + 1.5vw, 2.5rem);

  /* Touch target minimum */
  --touch-target: 44px;
}

/* ===== THEMES ===== */
body.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #334155;
  --accent-light: rgba(79, 70, 229, 0.2);
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
  --poll-bg: #111827;
  --poll-text: #e5e7eb;
  --poll-muted: #9ca3af;
  --poll-border: #374151;
  --poll-divider: #1f2937;
  --poll-input-bg: #0b1220;
  --poll-button-bg: #1f2937;
  --poll-button-hover: #374151;
  --poll-radio: #9ca3af;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(99, 102, 241, 0.25);
  --heat-2: rgba(99, 102, 241, 0.45);
  --heat-3: rgba(99, 102, 241, 0.7);
  --heat-4: rgba(99, 102, 241, 0.95);
}

body.ocean {
  --bg: #0c4a6e;
  --card: #075985;
  --text: #e0f2fe;
  --text-muted: #7dd3fc;
  --border: #0369a1;
  --accent: #0891b2;
  --accent-dark: #0e7490;
  --accent-light: rgba(8, 145, 178, 0.2);
  --poll-bg: #0b4a6a;
  --poll-text: #e0f2fe;
  --poll-muted: #bae6fd;
  --poll-border: rgba(125, 211, 252, 0.35);
  --poll-divider: rgba(125, 211, 252, 0.2);
  --poll-input-bg: rgba(3, 105, 161, 0.25);
  --poll-button-bg: rgba(125, 211, 252, 0.2);
  --poll-button-hover: rgba(125, 211, 252, 0.3);
  --poll-radio: #7dd3fc;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(8, 145, 178, 0.25);
  --heat-2: rgba(8, 145, 178, 0.5);
  --heat-3: rgba(8, 145, 178, 0.75);
  --heat-4: rgba(8, 145, 178, 0.95);
}

body.ocean .pro-tip {
  background: linear-gradient(135deg, rgba(8, 145, 178, 0.25), rgba(14, 116, 144, 0.2));
  border-color: rgba(125, 211, 252, 0.35);
}

body.ocean .pro-tip strong {
  color: #e0f2fe;
}

body.forest {
  --bg: #064e3b;
  --card: #047857;
  --text: #d1fae5;
  --text-muted: #a7f3d0;
  --border: #059669;
  --accent: #059669;
  --accent-dark: #047857;
  --accent-light: rgba(5, 150, 105, 0.2);
  --poll-bg: #065f46;
  --poll-text: #ecfdf5;
  --poll-muted: #a7f3d0;
  --poll-border: rgba(110, 231, 183, 0.35);
  --poll-divider: rgba(110, 231, 183, 0.2);
  --poll-input-bg: rgba(6, 95, 70, 0.35);
  --poll-button-bg: rgba(110, 231, 183, 0.2);
  --poll-button-hover: rgba(110, 231, 183, 0.3);
  --poll-radio: #6ee7b7;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(16, 185, 129, 0.25);
  --heat-2: rgba(16, 185, 129, 0.5);
  --heat-3: rgba(16, 185, 129, 0.75);
  --heat-4: rgba(16, 185, 129, 0.95);
}

body.forest .pro-tip {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.22), rgba(5, 150, 105, 0.18));
  border-color: rgba(110, 231, 183, 0.4);
}

body.forest .pro-tip strong {
  color: #ecfdf5;
}

body.sunset {
  --bg: #7c2d12;
  --card: #c2410c;
  --text: #ffedd5;
  --text-muted: #fed7aa;
  --border: #ea580c;
  --accent: #ea580c;
  --accent-dark: #c2410c;
  --accent-light: rgba(234, 88, 12, 0.2);
  --poll-bg: #7c2d12;
  --poll-text: #ffedd5;
  --poll-muted: #fed7aa;
  --poll-border: rgba(253, 186, 116, 0.4);
  --poll-divider: rgba(253, 186, 116, 0.25);
  --poll-input-bg: rgba(124, 45, 18, 0.4);
  --poll-button-bg: rgba(253, 186, 116, 0.2);
  --poll-button-hover: rgba(253, 186, 116, 0.3);
  --poll-radio: #fdba74;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(234, 88, 12, 0.25);
  --heat-2: rgba(234, 88, 12, 0.5);
  --heat-3: rgba(234, 88, 12, 0.75);
  --heat-4: rgba(234, 88, 12, 0.95);
}

body.sunset .pro-tip {
  background: linear-gradient(135deg, rgba(251, 146, 60, 0.25), rgba(234, 88, 12, 0.18));
  border-color: rgba(253, 186, 116, 0.45);
}

body.sunset .pro-tip strong {
  color: #fff7ed;
}

body.purple {
  --bg: #1e1b4b;
  --card: #312e81;
  --text: #e0e7ff;
  --text-muted: #a5b4fc;
  --border: #4f46e5;
  --accent: #8b5cf6;
  --accent-dark: #7c3aed;
  --accent-light: rgba(139, 92, 246, 0.2);
  --poll-bg: #1f1b5c;
  --poll-text: #ede9fe;
  --poll-muted: #c7d2fe;
  --poll-border: rgba(167, 139, 250, 0.4);
  --poll-divider: rgba(167, 139, 250, 0.25);
  --poll-input-bg: rgba(30, 27, 75, 0.55);
  --poll-button-bg: rgba(167, 139, 250, 0.2);
  --poll-button-hover: rgba(167, 139, 250, 0.3);
  --poll-radio: #c4b5fd;
  --heat-0: rgba(148, 163, 184, 0.15);
  --heat-1: rgba(139, 92, 246, 0.25);
  --heat-2: rgba(139, 92, 246, 0.5);
  --heat-3: rgba(139, 92, 246, 0.75);
  --heat-4: rgba(139, 92, 246, 0.95);
}

body.purple .pro-tip {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.22), rgba(76, 29, 149, 0.2));
  border-color: rgba(167, 139, 250, 0.4);
}

body.purple .pro-tip strong {
  color: #ede9fe;
}

body.rainbow {
  --bg: #0b1020;
  --card: rgba(255, 255, 255, 0.08);
  --text: #ffffff;
  --text-muted: #e5e7ff;
  --border: rgba(255, 255, 255, 0.2);
  --accent: #ff7ad9;
  --accent-dark: #c026d3;
  --accent-light: rgba(255, 122, 217, 0.2);
  --success: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --purple: #8b5cf6;
  --gradient-primary: linear-gradient(135deg, #ff7ad9, #7c3aed, #3b82f6, #22c55e, #f59e0b, #ef4444);
  --gradient-success: linear-gradient(135deg, #22c55e, #16a34a);
  --gradient-warning: linear-gradient(135deg, #f59e0b, #d97706);
  --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
  --gradient-info: linear-gradient(135deg, #3b82f6, #2563eb);
  --gradient-purple: linear-gradient(135deg, #8b5cf6, #7c3aed);
  --poll-bg: rgba(15, 23, 42, 0.75);
  --poll-text: #ffffff;
  --poll-muted: #e5e7ff;
  --poll-border: rgba(255, 255, 255, 0.25);
  --poll-divider: rgba(255, 255, 255, 0.15);
  --poll-input-bg: rgba(17, 24, 39, 0.6);
  --poll-button-bg: rgba(255, 255, 255, 0.12);
  --poll-button-hover: rgba(255, 255, 255, 0.2);
  --poll-radio: #e5e7ff;
  --heat-0: rgba(148, 163, 184, 0.18);
  --heat-1: rgba(255, 122, 217, 0.25);
  --heat-2: rgba(59, 130, 246, 0.5);
  --heat-3: rgba(34, 197, 94, 0.75);
  --heat-4: rgba(245, 158, 11, 0.95);
}

body.rainbow {
  background:
    radial-gradient(800px 420px at 10% -5%, rgba(255, 122, 217, 0.25), transparent 60%),
    radial-gradient(900px 420px at 90% 0%, rgba(59, 130, 246, 0.22), transparent 60%),
    radial-gradient(700px 380px at 50% 10%, rgba(34, 197, 94, 0.2), transparent 70%),
    linear-gradient(135deg, #0b1020 0%, #111b3a 55%, #0b1020 100%);
}

body.rainbow .pro-tip {
  background: linear-gradient(135deg, rgba(255, 122, 217, 0.2), rgba(59, 130, 246, 0.18));
  border-color: rgba(255, 255, 255, 0.25);
}

/* ===== PREMIUM THEME - ULTRA ENHANCED ===== */
body.premium {
  --bg: #0a1219;
  --card: rgba(18, 28, 40, 0.98);
  --text: #f0f8ff;
  --text-muted: #a6c1e0;
  --border: rgba(64, 156, 255, 0.3);
  --accent: #40c9ff;
  --accent-dark: #2d9cdb;
  --accent-light: rgba(64, 201, 255, 0.15);
  --success: #00e6a9;
  --warning: #ffb347;
  --danger: #ff6b8b;
  --info: #6a93ff;
  --purple: #c084fc;
  
  /* Premium gradients */
  --gradient-primary: linear-gradient(135deg, #40c9ff 0%, #497fff 50%, #c084fc 100%);
  --gradient-success: linear-gradient(135deg, #00e6a9, #00b894);
  --gradient-warning: linear-gradient(135deg, #ffb347, #ff8c00);
  --gradient-danger: linear-gradient(135deg, #ff6b8b, #ff416c);
  --gradient-info: linear-gradient(135deg, #6a93ff, #4d7cff);
  --gradient-purple: linear-gradient(135deg, #c084fc, #a855f7);
  
  /* Enhanced shadows */
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.5);
  --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.6);
  --shadow-xl: 0 25px 60px rgba(0, 0, 0, 0.7);
  
  /* Heatmap */
  --heat-0: rgba(96, 165, 250, 0.1);
  --heat-1: rgba(64, 201, 255, 0.25);
  --heat-2: rgba(64, 201, 255, 0.45);
  --heat-3: rgba(108, 92, 231, 0.7);
  --heat-4: rgba(192, 132, 252, 0.95);
  
  /* Poll */
  --poll-bg: rgba(18, 28, 40, 0.95);
  --poll-text: #f0f8ff;
  --poll-muted: #a6c1e0;
  --poll-border: rgba(64, 156, 255, 0.4);
  --poll-divider: rgba(96, 165, 250, 0.2);
  --poll-input-bg: rgba(30, 41, 59, 0.7);
  --poll-button-bg: rgba(64, 156, 255, 0.15);
  --poll-button-hover: rgba(64, 156, 255, 0.25);
  --poll-radio: #6a93ff;
}

/* Premium background with depth */
body.premium {
  background:
    radial-gradient(ellipse at 20% 20%, rgba(64, 201, 255, 0.15) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(192, 132, 252, 0.12) 0%, transparent 60%),
    radial-gradient(ellipse at 40% 80%, rgba(0, 230, 169, 0.1) 0%, transparent 60%),
    linear-gradient(135deg, #0a1219 0%, #0f1a2a 50%, #0a1219 100%);
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

/* Premium glowing particles */
body.premium::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    radial-gradient(circle at 15% 25%, rgba(64, 201, 255, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 85% 30%, rgba(192, 132, 252, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 50% 70%, rgba(0, 230, 169, 0.15) 0%, transparent 50%);
  opacity: 0.4;
  z-index: 0;
  pointer-events: none;
  animation: premiumGlow 20s ease-in-out infinite alternate;
}

@keyframes premiumGlow {
  0% { opacity: 0.3; filter: hue-rotate(0deg); }
  50% { opacity: 0.6; }
  100% { opacity: 0.3; filter: hue-rotate(20deg); }
}

/* Premium typography */
body.premium {
  font-family: 'Sora', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  letter-spacing: 0.01em;
  line-height: 1.7;
}

body.premium h1,
body.premium h2,
body.premium h3,
body.premium h4,
body.premium h5,
body.premium h6 {
  font-family: 'Sora', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 700;
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, #40c9ff, #6a93ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  background-size: 200% auto;
  animation: textShimmer 8s ease-in-out infinite;
}

@keyframes textShimmer {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

/* Premium cards with glass effect */
body.premium .content-card,
body.premium .form-card,
body.premium .stats-overview-card,
body.premium .metric-card,
body.premium .class-card,
body.premium .leaderboard-item,
body.premium .study-partner-card,
body.premium .badges-card,
body.premium .chart-card,
body.premium .tool-item,
body.premium .assignment-item,
body.premium .classroom-item,
body.premium .task-item,
body.premium .pro-tip {
  background: linear-gradient(
    145deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.03) 100%
  );
  backdrop-filter: none;
  border: 1px solid rgba(64, 156, 255, 0.2);
  border-radius: 16px;
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
}

body.premium .content-card:hover,
body.premium .form-card:hover,
body.premium .stats-overview-card:hover,
body.premium .metric-card:hover,
body.premium .class-card:hover,
body.premium .leaderboard-item:hover,
body.premium .study-partner-card:hover,
body.premium .badges-card:hover,
body.premium .chart-card:hover,
body.premium .tool-item:hover,
body.premium .assignment-item:hover,
body.premium .classroom-item:hover,
body.premium .task-item:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: var(--shadow-xl);
  border-color: rgba(64, 201, 255, 0.5);
}

/* Premium card glow effect */
body.premium .content-card::before,
body.premium .form-card::before,
body.premium .stats-overview-card::before,
body.premium .metric-card::before,
body.premium .class-card::before,
body.premium .leaderboard-item::before,
body.premium .badges-card::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 16px;
  padding: 1px;
  background: linear-gradient(
    135deg,
    rgba(64, 201, 255, 0.4),
    rgba(106, 147, 255, 0.4),
    rgba(192, 132, 252, 0.4)
  );
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

body.premium .content-card:hover::before,
body.premium .form-card:hover::before,
body.premium .stats-overview-card:hover::before,
body.premium .metric-card:hover::before,
body.premium .class-card:hover::before,
body.premium .leaderboard-item:hover::before,
body.premium .badges-card:hover::before {
  opacity: 1;
}

/* Premium sidebar */
body.premium .sidebar {
  background: linear-gradient(
    180deg,
    rgba(18, 28, 40, 0.95) 0%,
    rgba(10, 18, 30, 0.98) 100%
  );
  border-right: 1px solid rgba(64, 156, 255, 0.3);
  box-shadow: 20px 0 60px rgba(0, 0, 0, 0.5);
}

body.premium .sidebar-stats,
body.premium .class-switcher,
body.premium .stories-section,
body.premium .heatmap-section {
  background: rgba(30, 41, 59, 0.7);
  border: 1px solid rgba(64, 156, 255, 0.25);
  border-radius: 12px;
}

/* Premium buttons */
body.premium .btn {
  font-weight: 600;
  letter-spacing: 0.02em;
  border-radius: 12px;
  padding: 12px 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

body.premium .btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

body.premium .btn:hover::before {
  width: 300px;
  height: 300px;
}

body.premium .btn-primary {
  background: var(--gradient-primary);
  border: none;
  box-shadow: 0 8px 32px rgba(64, 201, 255, 0.3);
}

body.premium .btn-primary:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(64, 201, 255, 0.5);
}

body.premium .btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(64, 156, 255, 0.3);
  color: var(--text);
}

body.premium .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(64, 201, 255, 0.5);
  transform: translateY(-4px);
}

/* Premium form elements */
body.premium input,
body.premium textarea,
body.premium select {
  background: rgba(30, 41, 59, 0.7);
  border: 1px solid rgba(64, 156, 255, 0.3);
  border-radius: 12px;
  padding: 14px 16px;
  color: var(--text);
  transition: all 0.3s ease;
}

body.premium input:focus,
body.premium textarea:focus,
body.premium select:focus {
  outline: none;
  border-color: #40c9ff;
  box-shadow: 0 0 0 3px rgba(64, 201, 255, 0.2);
  background: rgba(30, 41, 59, 0.9);
}

/* Premium stats and metrics */
body.premium .stat-card,
body.premium .stats-overview-card,
body.premium .metric-card {
  background: linear-gradient(
    145deg,
    rgba(64, 201, 255, 0.1) 0%,
    rgba(106, 147, 255, 0.05) 100%
  );
}

body.premium .stat-icon {
  background: var(--gradient-primary);
  box-shadow: 0 8px 24px rgba(64, 201, 255, 0.3);
}

body.premium .stat-number,
body.premium .stats-overview-number,
body.premium .metric-value {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 800;
}

/* Premium streak card */
body.premium .streak-card {
  background: linear-gradient(135deg, #40c9ff, #6a93ff, #c084fc);
  box-shadow: 0 15px 40px rgba(64, 201, 255, 0.3);
}

/* Premium motivation card */
body.premium .motivation-card {
  background: linear-gradient(135deg, #c084fc, #ff6b8b, #ffb347);
  box-shadow: 0 15px 40px rgba(192, 132, 252, 0.3);
}

/* Premium leaderboard */
body.premium .leaderboard-item.you {
  background: linear-gradient(135deg, rgba(64, 201, 255, 0.2), rgba(192, 132, 252, 0.2));
  border: 1px solid rgba(64, 201, 255, 0.4);
}

body.premium .leaderboard-rank {
  color: #40c9ff;
  font-weight: 900;
}

body.premium .rank-1 .leaderboard-rank { color: #ffb347; }
body.premium .rank-2 .leaderboard-rank { color: #a6c1e0; }
body.premium .rank-3 .leaderboard-rank { color: #c084fc; }

/* Premium badges */
body.premium .badge-item {
  background: linear-gradient(
    145deg,
    rgba(64, 201, 255, 0.1) 0%,
    rgba(192, 132, 252, 0.05) 100%
  );
  border: 1px solid rgba(64, 156, 255, 0.2);
}

body.premium .badge-icon {
  background: var(--gradient-primary);
  color: white;
  box-shadow: 0 6px 20px rgba(64, 201, 255, 0.3);
}

/* Premium heatmap */
body.premium .heatmap-cell.level-0 { background: rgba(64, 156, 255, 0.1); }
body.premium .heatmap-cell.level-1 { background: rgba(64, 156, 255, 0.3); }
body.premium .heatmap-cell.level-2 { background: rgba(64, 156, 255, 0.5); }
body.premium .heatmap-cell.level-3 { background: rgba(64, 156, 255, 0.7); }
body.premium .heatmap-cell.level-4 { background: rgba(64, 156, 255, 0.9); }

/* Premium pro tip */
body.premium .pro-tip {
  background: linear-gradient(135deg, rgba(64, 201, 255, 0.15), rgba(106, 147, 255, 0.1));
  border-left: 4px solid #40c9ff;
  border-color: rgba(64, 156, 255, 0.3);
}

body.premium .pro-tip strong {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Premium toast */
body.premium .toast {
  background: linear-gradient(
    145deg,
    rgba(18, 28, 40, 0.95) 0%,
    rgba(10, 18, 30, 0.98) 100%
  );
  border-left: 4px solid #40c9ff;
  border: 1px solid rgba(64, 156, 255, 0.3);
  box-shadow: var(--shadow-xl);
}

/* Premium navigation */
body.premium .nav-item {
  border-radius: 12px;
  border: 1px solid transparent;
}

body.premium .nav-item:hover {
  background: rgba(64, 201, 255, 0.1);
  border-color: rgba(64, 201, 255, 0.3);
}

body.premium .nav-item.active {
  background: var(--gradient-primary);
  border-color: transparent;
  box-shadow: 0 8px 24px rgba(64, 201, 255, 0.4);
}

/* Premium chatbot */
body.premium .chatbot-btn {
  background: var(--gradient-primary);
  box-shadow: 0 15px 40px rgba(64, 201, 255, 0.4);
}

/* Premium modal */
body.premium .referral-modal,
body.premium .rainbow-modal,
body.premium .forest-modal,
body.premium .story-modal {
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: none;
}

body.premium .referral-modal-card,
body.premium .rainbow-modal-card,
body.premium .forest-modal-card,
body.premium .story-modal-content {
  background: linear-gradient(
    145deg,
    rgba(18, 28, 40, 0.98) 0%,
    rgba(10, 18, 30, 0.98) 100%
  );
  border: 1px solid rgba(64, 156, 255, 0.3);
  box-shadow: var(--shadow-xl);
}

/* Premium whiteboard */
body.premium .memory-whiteboard,
body.premium #studentMemoryWhiteboard {
  background: linear-gradient(45deg, rgba(18, 28, 40, 0.9) 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, rgba(18, 28, 40, 0.9) 75%);
  background-size: 40px 40px;
  background-color: #0a1219;
  border: 2px solid rgba(64, 156, 255, 0.3);
}

body.premium .sticky-note,
body.premium .student-sticky-note {
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(64, 156, 255, 0.2);
}

/* Premium scrollbar */
body.premium ::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

body.premium ::-webkit-scrollbar-track {
  background: rgba(30, 41, 59, 0.5);
  border-radius: 10px;
}

body.premium ::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  border-radius: 10px;
  border: 2px solid rgba(30, 41, 59, 0.5);
}

body.premium ::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #6a93ff, #c084fc);
}

/* Premium animations */
@keyframes premiumFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

@keyframes premiumPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

body.premium .student-emoji {
  animation: premiumFloat 3s ease-in-out infinite;
}

/* Premium loading */
body.premium .loading::after {
  border: 3px solid rgba(64, 156, 255, 0.3);
  border-top-color: #40c9ff;
}

/* Premium empty state */
body.premium .empty-state-icon {
  background: linear-gradient(135deg, #40c9ff, #c084fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  opacity: 0.8;
}

/* Premium class code display */
body.premium .class-code-display {
  background: var(--gradient-primary);
  box-shadow: 0 15px 40px rgba(64, 201, 255, 0.3);
}

/* Premium tools grid */
body.premium .tools-grid .tool-item:hover {
  background: linear-gradient(
    145deg,
    rgba(64, 201, 255, 0.15) 0%,
    rgba(192, 132, 252, 0.1) 100%
  );
}

/* Premium feedback button */
body.premium .feedback-btn {
  background: var(--gradient-info);
  box-shadow: 0 8px 32px rgba(106, 147, 255, 0.4);
}

/* Premium celebrate button */
body.premium .celebrate-btn {
  background: var(--gradient-success);
  box-shadow: 0 8px 32px rgba(0, 230, 169, 0.4);
}

/* ===== BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
  -webkit-text-size-adjust: 100%;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: var(--text-base);
  line-height: 1.6;
  min-height: 100vh;
  min-height: 100dvh;
  transition: background-color var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ===== NEW RESPONSIVE LAYOUT STRUCTURE ===== */
.app-layout {
  display: grid;
  grid-template-columns: minmax(260px, 280px) 1fr;
  min-height: 100vh;
  min-height: 100dvh;
  transition: grid-template-columns var(--transition);
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: var(--card);
  border-right: 1px solid var(--border);
  padding: clamp(var(--spacing-md), 3vw, var(--spacing-xl));
  position: sticky;
  top: 0;
  height: 100vh;
  height: 100dvh;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 100;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

.sidebar-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
}

.student-emoji {
  font-size: 3.5rem;
  margin-bottom: var(--spacing-md);
  display: block;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(2deg); }
}

.sidebar h2 {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
}

.sidebar-subtitle {
  color: var(--text-muted);
  font-size: 0.875rem;
  margin-bottom: var(--spacing-lg);
}

/* Class switcher */
.class-switcher {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-xl);
}

.class-switcher select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--card);
  color: var(--text);
  font-size: 0.875rem;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin-bottom: var(--spacing-xl);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md) var(--spacing-lg);
  min-height: var(--touch-target);
  border-radius: var(--radius);
  color: var(--text);
  text-decoration: none;
  font-weight: 500;
  font-size: var(--text-sm);
  transition: all var(--transition);
  border: 1px solid transparent;
  cursor: pointer;
  touch-action: manipulation;
}

.nav-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateX(5px);
}

.nav-item.active {
  background: var(--gradient-primary);
  color: white;
}

.nav-item.active:hover {
  background: var(--gradient-primary);
  border-color: transparent;
}

.sidebar-stats {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.sidebar-stats h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-value {
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--accent);
}

/* Inspiring Stories Section */
.stories-section {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-top: var(--spacing-xl);
  max-height: 300px;
  overflow-y: auto;
}

.heatmap-section {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.heatmap-section h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.heatmap-cell {
  width: 100%;
  padding-top: 100%;
  border-radius: 4px;
  background: var(--border);
  position: relative;
  overflow: hidden;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.heatmap-cell .heatmap-value {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  font-size: 0.65rem;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.9);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
}

.heatmap-cell::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: inherit;
}

.heatmap-cell.level-0 { background: rgba(148, 163, 184, 0.25); }
.heatmap-cell.level-1 { background: rgba(16, 185, 129, 0.25); }
.heatmap-cell.level-2 { background: rgba(16, 185, 129, 0.5); }
.heatmap-cell.level-3 { background: rgba(16, 185, 129, 0.75); }
.heatmap-cell.level-4 { background: rgba(16, 185, 129, 0.95); }

.heatmap-legend {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: var(--spacing-sm);
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* ===== AGGREGATE ENGAGEMENT HEATMAP ===== */
.aggregate-heatmap {
  display: grid;
  gap: 8px;
}

.aggregate-heatmap-grid {
  display: grid;
  grid-template-columns: 80px repeat(4, 1fr);
  gap: 6px;
  align-items: center;
}

.aggregate-heatmap-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-align: right;
  padding-right: 6px;
  white-space: nowrap;
}

.aggregate-heatmap-time {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.aggregate-heatmap-cell {
  height: 26px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--heat-0);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.aggregate-heatmap-cell.level-1 { background: var(--heat-1); }
.aggregate-heatmap-cell.level-2 { background: var(--heat-2); }
.aggregate-heatmap-cell.level-3 { background: var(--heat-3); }
.aggregate-heatmap-cell.level-4 { background: var(--heat-4); }

.aggregate-heatmap-cell:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.aggregate-heatmap-insight {
  margin-top: var(--spacing-md);
  font-size: 0.9rem;
  color: var(--text-muted);
}
.stories-section h3 {
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.story-item {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  cursor: pointer;
  transition: all var(--transition);
}

.story-item:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
}

.story-name {
  font-weight: 600;
  color: var(--text);
  margin-bottom: var(--spacing-xs);
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.story-quote {
  font-size: 0.875rem;
  color: var(--text-muted);
  font-style: italic;
  line-height: 1.4;
}

/* Story Modal */
.story-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1001;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xl);
}

.story-modal-content {
  background: var(--card);
  border-radius: var(--radius-lg);
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  border: 2px solid var(--accent);
}

.story-modal-header {
  padding: var(--spacing-xl);
  border-bottom: 1px solid var(--border);
  background: var(--gradient-primary);
  color: white;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.story-modal-body {
  padding: var(--spacing-xl);
}

.story-modal-close {
  position: absolute;
  top: var(--spacing-lg);
  right: var(--spacing-lg);
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  z-index: 1002;
}

.story-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* ===== MAIN CONTENT ===== */
.main-content {
  padding: clamp(var(--spacing-md), 4vw, var(--spacing-xl));
  overflow-y: auto;
  overflow-x: hidden;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
}

/* ===== FOCUS MODE ===== */
body.focus-mode .sidebar,
body.focus-mode .top-nav {
  display: none;
}

body.focus-mode .app-layout {
  grid-template-columns: 1fr;
}

body.focus-mode .main-content {
  max-width: 1100px;
}

body.focus-mode .controls-bar .focus-toggle {
  background: var(--gradient-success);
  color: #ffffff;
}

body.focus-fullscreen {
  height: 100vh;
  overflow: hidden;
}

/* ===== QUICK NOTES ===== */
.quick-notes-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

.quick-notes-card textarea {
  width: 100%;
  min-height: 160px;
  padding: var(--spacing-md);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  color: var(--text);
  resize: vertical;
  font-size: 0.95rem;
}

.quick-notes-card textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
}

.quick-notes-meta {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: var(--spacing-sm);
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

/* ===== FOCUS TOOLKIT ===== */
.focus-mode-panel {
  display: none;
}

body.focus-mode .focus-mode-panel {
  display: block;
}

.focus-mode-panel {
  padding-bottom: 6rem;
}

body.focus-mode .main-content {
  overflow-y: auto;
  max-height: 100vh;
  height: 100vh;
  -webkit-overflow-scrolling: touch;
}

body.focus-fullscreen .main-content {
  overflow-y: auto;
  height: 100vh;
  -webkit-overflow-scrolling: touch;
}

body.focus-fullscreen {
  overflow: hidden;
}

body.focus-blocker-enabled,
body.focus-blocker-enabled html {
  overflow: hidden !important;
}

.focus-mode-panel {
  min-height: 120vh;
}

.main-content {
  position: relative;
  z-index: 2;
}

.focus-portal-video {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
  opacity: 0.18;
  pointer-events: none;
}

.focus-mode-panel {
  position: relative;
  z-index: 1;
}

.portal-overlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 3;
  pointer-events: none;
}

.portal-overlay.active {
  display: block;
  animation: portalFade 1.8s ease forwards;
}

.portal-ring {
  position: fixed;
  width: 140vmax;
  height: 140vmax;
  border-radius: 50%;
  border: 6px solid rgba(255, 255, 255, 0.45);
  box-shadow:
    0 0 40px rgba(99, 102, 241, 0.6),
    0 0 120px rgba(59, 130, 246, 0.35),
    inset 0 0 40px rgba(255, 255, 255, 0.35);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 3;
  animation: portalPulse 6s ease-in-out infinite;
}

.portal-vortex {
  position: fixed;
  width: 110vmax;
  height: 110vmax;
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.6), rgba(99,102,241,0.2) 40%, rgba(15,23,42,0.9) 70%);
  filter: blur(0.5px);
  opacity: 0.9;
  pointer-events: none;
  z-index: 2;
  animation: portalSpin 10s linear infinite;
}

body.focus-mode .focus-portal-video {
  animation: portalDrift 12s ease-in-out infinite;
}

body.focus-mode .focus-mode-panel {
  animation: portalZoom 1.6s ease forwards;
}

body.focus-mode .portal-overlay .portal-ring {
  animation: portalCover 1.6s ease forwards;
}

body.focus-mode .portal-overlay .portal-vortex {
  animation: portalCoverVortex 1.6s ease forwards;
}

@keyframes portalPulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
  50% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
}

@keyframes portalSpin {
  0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
  100% { transform: translate(-50%, -50%) rotate(360deg) scale(1.02); }
}

@keyframes portalDrift {
  0%, 100% { transform: scale(1) rotate(0deg); }
  50% { transform: scale(1.06) rotate(1deg); }
}

@keyframes portalZoom {
  0% { transform: translateY(10px) scale(0.98); opacity: 0.2; }
  100% { transform: translateY(0) scale(1); opacity: 1; }
}

@keyframes portalCover {
  0% { transform: translate(-50%, -50%) scale(0.15); opacity: 0; }
  40% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(2.6); opacity: 0; }
}

@keyframes portalCoverVortex {
  0% { transform: translate(-50%, -50%) scale(0.2) rotate(0deg); opacity: 0.3; }
  100% { transform: translate(-50%, -50%) scale(2.4) rotate(360deg); opacity: 0; }
}

@keyframes portalFade {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

body.focus-mode .dashboard-header,
body.focus-mode .dashboard-grid,
body.focus-mode .footer {
  display: none;
}

.focus-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: var(--spacing-lg);
}

.focus-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  box-shadow: var(--shadow);
}

.focus-card h3 {
  margin-bottom: var(--spacing-sm);
  font-size: 1.05rem;
}

.focus-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-md);
}

.focus-tree {
  font-size: 2.8rem;
  line-height: 1;
}

.ritual-list {
  display: grid;
  gap: var(--spacing-sm);
}

.ritual-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
}

.energy-scale {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

.energy-scale button {
  min-width: 44px;
}

.teach-bullets {
  display: grid;
  gap: var(--spacing-sm);
}

.teach-bullets input {
  width: 100%;
}

.focus-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
  margin-top: var(--spacing-sm);
}

.focus-timer-display {
  font-size: 2.4rem;
  font-weight: 800;
  letter-spacing: 0.04em;
  margin: var(--spacing-sm) 0;
}

.focus-metrics {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: var(--spacing-sm);
  font-size: 0.85rem;
  color: var(--text-muted);
}

.focus-lock-banner {
  background: var(--accent-light);
  border: 1px dashed var(--accent);
  border-radius: var(--radius);
  padding: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
  font-size: 0.9rem;
}

.brain-dump-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
  max-height: 220px;
  overflow-y: auto;
}

.brain-dump-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm);
  border-radius: var(--radius);
  background: var(--bg);
  border: 1px solid var(--border);
  font-size: 0.9rem;
}

.sound-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: var(--spacing-sm);
}

.sound-chip {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.6rem 0.75rem;
  font-size: 0.85rem;
  cursor: pointer;
  background: var(--bg);
  transition: var(--transition-fast);
}

.sound-chip.active {
  border-color: var(--accent);
  background: var(--accent-light);
  color: var(--accent-dark);
}

.focus-plan-item {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.focus-plan-item input[type="text"] {
  flex: 1;
}

.blocker-list {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* ===== DASHBOARD HEADER ===== */
.dashboard-header {
  margin-bottom: var(--spacing-2xl);
}

.dashboard-header h1 {
  font-size: var(--text-4xl);
  font-weight: 800;
  margin-bottom: var(--spacing-sm);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
  line-height: 1.2;
}

.time-greeting {
  font-size: 1rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-sm);
  letter-spacing: 0.3px;
}

.dashboard-subtitle {
  color: var(--text-muted);
  font-size: 1.125rem;
  margin-bottom: var(--spacing-xl);
}

/* UPDATED: Controls Bar - Compact and Inline */
.controls-bar {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
  flex-wrap: nowrap;
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-xl);
  overflow-x: auto;
  min-width: 0;
}

.controls-bar .btn {
  flex-shrink: 0;
  white-space: nowrap;
  min-width: fit-content;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
}

/* ===== TOP NAVIGATION FOR MOBILE ===== */
.top-nav {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--card);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  z-index: 1000;
  padding: var(--spacing-sm) max(var(--spacing-lg), env(safe-area-inset-left));
  padding-top: max(var(--spacing-sm), env(safe-area-inset-top));
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.top-nav-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.mobile-menu-toggle {
  display: none;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  width: 44px;
  height: 44px;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  cursor: pointer;
  flex-shrink: 0;
}

.mobile-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99;
}

/* ===== PRO TIPS - MATCHING TEACHER MODE ===== */
.pro-tip {
  background:
    linear-gradient(135deg, rgba(79, 70, 229, 0.14), rgba(59, 130, 246, 0.1));
  border: 1px solid rgba(79, 70, 229, 0.28);
  border-left: 4px solid var(--accent);
  padding: var(--spacing-md);
  border-radius: var(--radius);
  margin: var(--spacing-md) 0;
  font-size: 0.875rem;
  position: relative;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
}

.pro-tip strong {
  color: var(--accent-dark);
  display: block;
  margin-bottom: var(--spacing-xs);
  font-size: 0.9375rem;
}

.pro-tip::before {
  content: 'ðŸ’¡';
  position: absolute;
  left: -12px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--accent);
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  box-shadow: var(--shadow);
}

.dark .pro-tip {
  background:
    linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(14, 116, 144, 0.18));
  border-color: rgba(148, 163, 184, 0.25);
  border-left-color: var(--accent);
  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
}

.dark .pro-tip strong {
  color: #e2e8f0;
}

/* ===== AI CHATBOT ===== */
.chatbot-fab {
  position: fixed;
  right: 18px;
  bottom: 96px;
  z-index: 900;
  display: flex;
  align-items: flex-end;
  gap: 10px;
  flex-direction: column;
}

.chatbot-bubble {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 10px 14px;
  max-width: 260px;
  font-size: 0.9rem;
  opacity: 0;
  transform: translateY(10px);
  transition: all var(--transition);
  pointer-events: none;
  position: absolute;
  right: 0;
  bottom: calc(100% + 12px);
  box-shadow: var(--shadow-md);
}

.chatbot-bubble.show {
  opacity: 1;
  transform: translateY(0);
}

.chatbot-bubble.challenge {
  background: rgba(239, 68, 68, 0.12);
  border-color: rgba(239, 68, 68, 0.4);
  color: #ef4444;
  font-weight: 700;
}

.clap-overlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2400;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.25s ease;
}

.clap-overlay.show {
  opacity: 1;
}

.clap-video {
  display: none;
}

.clap-canvas {
  width: 50vw;
  height: 50vh;
  object-fit: contain;
  background: transparent;
  opacity: 0.65;
}

.chatbot-btn {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  border: none;
  background: transparent;
  cursor: pointer;
  display: grid;
  place-items: center;
  box-shadow: none;
  transition: transform var(--transition);
  animation: botFloat 3s ease-in-out infinite;
}

.chatbot-btn:hover {
  transform: translateY(-6px) scale(1.02);
}

.chatbot-img {
  width: 150px;
  height: 150px;
  border-radius: 0;
  object-fit: cover;
  background: transparent;
  box-shadow: none;
  animation: botLook 5.5s ease-in-out infinite, botNod 4.2s ease-in-out infinite;
}

@keyframes botFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

@keyframes botLook {
  0% { transform: translate(0, 0) rotate(0deg); }
  20% { transform: translate(-3px, -1px) rotate(-1deg); }
  40% { transform: translate(3px, -2px) rotate(1deg); }
  60% { transform: translate(2px, 2px) rotate(0.5deg); }
  80% { transform: translate(-2px, 1px) rotate(-0.5deg); }
  100% { transform: translate(0, 0) rotate(0deg); }
}

@keyframes botNod {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(2px); }
}

@media (max-width: 767px) {
  .chatbot-fab {
    right: 12px;
    bottom: 120px;
  }
  .chatbot-btn,
  .chatbot-img {
    width: 120px;
    height: 120px;
  }
  .chatbot-bubble {
    max-width: 220px;
    font-size: 0.85rem;
  }
}

/* ===== DASHBOARD GRID ===== */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--spacing-xl);
}

/* UPDATED: Quick Stats - Smaller and Inline */
.quick-stats {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--spacing-md);
}

.stat-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: clamp(var(--spacing-md), 2vw, var(--spacing-lg));
  border: 1px solid var(--border);
  transition: transform var(--transition), box-shadow var(--transition);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  max-width: 100%;
  overflow: hidden;
  height: auto;
  min-height: 80px;
  box-shadow: var(--shadow);
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.stat-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  background: var(--gradient-primary);
  color: white;
  flex-shrink: 0;
}

.stat-card:nth-child(2) .stat-icon {
  background: var(--gradient-success);
}

.stat-card:nth-child(3) .stat-icon {
  background: var(--gradient-warning);
}

.stat-card:nth-child(4) .stat-icon {
  background: var(--gradient-info);
}

.stat-content {
  flex: 1;
  min-width: 0;
}

.stat-number {
  font-size: 1.5rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: var(--spacing-xs);
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
}

.stat-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Forms Section */
.forms-section {
  grid-column: span 6;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

.form-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: clamp(var(--spacing-lg), 3vw, var(--spacing-xl));
  border: 1px solid var(--border);
  transition: box-shadow var(--transition);
  max-width: 100%;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.form-card:hover {
  box-shadow: var(--shadow-md);
}

.form-card h2 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Form Elements */
.form-group {
  margin-bottom: var(--spacing-lg);
}

.form-group label {
  display: block;
  margin-bottom: var(--spacing-xs);
  font-weight: 600;
  color: var(--text);
  font-size: 0.875rem;
  white-space: nowrap;
}

input, textarea, select {
  width: 100%;
  padding: 0.75rem 1rem;
  min-height: var(--touch-target);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--card);
  color: var(--text);
  font-size: var(--text-base);
  font-family: inherit;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  max-width: 100%;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

textarea {
  min-height: 120px;
  resize: vertical;
  line-height: 1.6;
}

.btn-submit {
  width: 100%;
  padding: 1rem;
  background: var(--gradient-primary);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

/* Task Priority Badges */
.priority-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  white-space: nowrap;
}

.priority-urgent {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
  border: 1px solid var(--danger);
}

.priority-not-urgent {
  background: rgba(245, 158, 11, 0.1);
  color: var(--warning);
  border: 1px solid var(--warning);
}

.priority-optional {
  background: rgba(156, 163, 175, 0.1);
  color: var(--text-muted);
  border: 1px solid var(--text-muted);
}

.priority-selector {
  display: flex;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.priority-option {
  flex: 1;
  padding: 0.5rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  text-align: center;
  cursor: pointer;
  transition: all var(--transition);
  font-size: 0.875rem;
  font-weight: 500;
  white-space: nowrap;
}

.priority-option:hover {
  transform: translateY(-2px);
}

.priority-option.active {
  border-color: var(--accent);
  background: var(--accent-light);
}

.priority-option[data-priority="urgent"]:hover,
.priority-option[data-priority="urgent"].active {
  border-color: var(--danger);
  background: rgba(239, 68, 68, 0.1);
}

.priority-option[data-priority="not-urgent"]:hover,
.priority-option[data-priority="not-urgent"].active {
  border-color: var(--warning);
  background: rgba(245, 158, 11, 0.1);
}

.priority-option[data-priority="optional"]:hover,
.priority-option[data-priority="optional"].active {
  border-color: var(--text-muted);
  background: rgba(156, 163, 175, 0.1);
}

/* Content Section */
.content-section {
  grid-column: span 6;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xl);
}

.content-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  overflow: hidden;
  max-width: 100%;
  box-shadow: var(--shadow);
  transition: box-shadow var(--transition);
}

.content-card:hover {
  box-shadow: var(--shadow-md);
}

.content-header {
  padding: clamp(var(--spacing-lg), 3vw, var(--spacing-xl));
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: nowrap;
  gap: var(--spacing-md);
  min-width: 0;
}

.content-header h2 {
  font-size: var(--text-lg);
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.content-body {
  padding: var(--spacing-xl);
  max-height: 400px;
  overflow-y: auto;
}

/* Profile section should not clip content */
.profile-content-body {
  max-height: none;
  overflow: visible;
}

/* ===== REFERRAL MODAL ===== */
.referral-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1500;
  padding: var(--spacing-lg);
  backdrop-filter: blur(6px);
}

.referral-modal.show {
  display: flex;
}

.referral-modal-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 520px;
  box-shadow: var(--shadow-xl);
  padding: var(--spacing-xl);
  text-align: center;
}

.rainbow-modal {
  position: fixed;
  inset: 0;
  background: rgba(5, 8, 20, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1600;
  padding: var(--spacing-lg);
  backdrop-filter: blur(4px);
}

.rainbow-modal.show {
  display: flex;
}

.rainbow-modal-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(15, 18, 35, 0.9));
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 520px;
  box-shadow: var(--shadow-xl);
  padding: var(--spacing-xl);
  text-align: center;
  color: #ffffff;
}

.forest-modal {
  position: fixed;
  inset: 0;
  background: rgba(6, 20, 12, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1600;
  padding: var(--spacing-lg);
  backdrop-filter: blur(4px);
}

.forest-modal.show {
  display: flex;
}

.forest-modal-card {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.18), rgba(4, 54, 35, 0.9));
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 520px;
  box-shadow: var(--shadow-xl);
  padding: var(--spacing-xl);
  text-align: center;
  color: #ecfdf5;
}

.referral-modal-title {
  font-size: 1.5rem;
  font-weight: 800;
  margin-bottom: var(--spacing-sm);
}

.referral-modal-text {
  color: var(--text-muted);
  margin-bottom: var(--spacing-lg);
}

.referral-modal-actions {
  display: flex;
  gap: var(--spacing-sm);
  justify-content: center;
  flex-wrap: wrap;
}

/* Task List */
.task-list {
  list-style: none;
  padding: 0;
  animation: fadeIn 0.8s ease-out;
}

.task-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: nowrap;
  gap: var(--spacing-md);
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
  max-width: 100%;
}

.task-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--gradient-primary);
  opacity: 0;
  transition: var(--transition);
}

.task-item:hover {
  border-color: var(--accent);
  transform: translateX(10px);
  box-shadow: var(--shadow);
  background: var(--accent-light);
}

.task-item:hover::before {
  opacity: 1;
}

.task-item.completed {
  opacity: 0.7;
  border-left: 4px solid var(--success);
}

.task-item.completed .task-text {
  text-decoration: line-through;
  color: var(--text-muted);
}

.task-item.urgent {
  border-left: 4px solid var(--danger);
}

.task-item.not-urgent {
  border-left: 4px solid var(--warning);
}

.task-item.optional {
  border-left: 4px solid var(--text-muted);
}

.task-text {
  flex: 1;
  min-width: 0;
  font-size: 1.1rem;
  font-weight: 500;
  cursor: pointer;
  padding: 0.5rem 0;
  transition: var(--transition);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.task-text:hover {
  color: var(--accent);
}

.task-actions {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: nowrap;
  align-items: center;
  flex-shrink: 0;
}

/* Assignment List */
.assignment-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.assignment-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  transition: all var(--transition);
  max-width: 100%;
  overflow: hidden;
}

.assignment-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.assignment-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  min-width: 0;
}

.assignment-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.assignment-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
  white-space: nowrap;
  flex-shrink: 0;
}

.assignment-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
  padding: 0.5rem 0;
  overflow: hidden;
}

.assignment-actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-sm);
  flex-wrap: nowrap;
}

/* Classroom Announcements & Resources */
.classroom-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  transition: all var(--transition);
  max-width: 100%;
  overflow: hidden;
}

.classroom-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  box-shadow: var(--shadow);
}

.classroom-item-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  min-width: 0;
}

.classroom-item-title {
  font-weight: 600;
  color: var(--text);
  font-size: 1.125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.classroom-item-date {
  color: var(--text-muted);
  font-size: 0.8125rem;
  font-weight: 500;
  background: var(--card);
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  border: 1px solid var(--border);
  white-space: nowrap;
  flex-shrink: 0;
}

.classroom-item-content {
  color: var(--text);
  margin-bottom: var(--spacing-md);
  line-height: 1.7;
  overflow: hidden;
}

.classroom-item-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.classroom-item-link:hover {
  text-decoration: underline;
}

/* Poll Styles (Classic Form Look) */
.classroom-item.poll-card {
  background: var(--poll-bg) !important;
  border: 1px solid var(--poll-border) !important;
  border-radius: 6px !important;
  padding: 0.9rem 1.1rem !important;
  box-shadow: none !important;
  color: var(--poll-text) !important;
  font-family: 'Arial', 'Helvetica', sans-serif !important;
  transform: none !important;
}

.classroom-item.poll-card:hover {
  transform: none !important;
  background: var(--poll-bg) !important;
  border-color: var(--poll-border) !important;
  box-shadow: none !important;
}

.classroom-item.poll-card .classroom-item-header {
  align-items: flex-start;
  gap: 0.75rem;
}

.classroom-item.poll-card .classroom-item-title {
  font-size: 1rem;
  font-weight: 500;
  color: var(--poll-text) !important;
  white-space: normal;
}

.classroom-item.poll-card .classroom-item-date {
  display: none !important;
}

.classroom-item.poll-card .poll-divider {
  height: 1px;
  background: var(--poll-divider);
  margin: 0.6rem 0 0.8rem 0;
}

.classroom-item.poll-card .poll-options {
  display: grid;
  gap: 0.5rem;
}

.classroom-item.poll-card .poll-option {
  display: grid;
  grid-template-columns: 18px 1fr;
  gap: 0.5rem;
  align-items: center;
  font-size: 0.9rem;
  color: var(--poll-text) !important;
}

.classroom-item.poll-card .poll-radio {
  width: 16px;
  height: 16px;
  accent-color: var(--poll-radio);
}

.classroom-item.poll-card .poll-other-input {
  width: 100%;
  border: 1px solid var(--poll-border);
  border-radius: 4px;
  padding: 0.25rem 0.4rem;
  font-size: 0.85rem;
  color: var(--poll-text);
  background: var(--poll-input-bg);
  margin-left: 6px;
}

.classroom-item.poll-card .poll-other-input:disabled {
  background: var(--poll-button-bg);
  color: var(--poll-muted);
}

.classroom-item.poll-card .poll-submit {
  margin-top: 0.75rem;
  background: var(--poll-button-bg) !important;
  color: var(--poll-text) !important;
  border: 1px solid var(--poll-border) !important;
  border-radius: 999px;
  padding: 0.25rem 1rem;
  font-weight: 600;
  font-size: 0.85rem;
  min-width: 64px;
}

.classroom-item.poll-card .poll-submit:hover {
  background: var(--poll-button-hover) !important;
}

.classroom-item.poll-card .poll-actions {
  display: flex;
  gap: 1.25rem;
  margin-top: 0.75rem;
  font-size: 0.8rem;
  color: var(--poll-muted);
  justify-content: center;
}

.classroom-item.poll-card .poll-action-link {
  cursor: pointer;
  text-decoration: underline;
  color: var(--poll-muted) !important;
}

.classroom-item.poll-card .poll-results {
  margin-top: 0.75rem;
}

.classroom-item.poll-card .poll-result-row {
  margin-bottom: 0.5rem;
}

.classroom-item.poll-card .poll-result-head {
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
  color: var(--poll-muted);
  margin-bottom: 0.2rem;
}

.classroom-item.poll-card .poll-bar {
  height: 6px;
  background: var(--poll-button-bg);
  border-radius: 999px;
  overflow: hidden;
}

.classroom-item.poll-card .poll-bar-fill {
  height: 100%;
  background: var(--poll-text);
  width: 0%;
}

.classroom-item.poll-card .poll-status {
  margin-top: 0.5rem;
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--poll-text);
}

.classroom-item.poll-card .poll-status.closed {
  color: #b45309;
}

.classroom-item.poll-card .poll-status.voted {
  color: #065f46;
}

.classroom-item.poll-card .classroom-item-content {
  color: var(--poll-text) !important;
}

.classroom-item.poll-card .poll-option span,
.classroom-item.poll-card .poll-result-head span,
.classroom-item.poll-card .poll-status {
  color: var(--poll-text) !important;
}

/* Tools Grid */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

.tool-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  text-align: center;
  transition: all var(--transition);
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  display: block;
  max-width: 100%;
  overflow: hidden;
}

.tool-item:hover {
  border-color: var(--accent);
  transform: translateY(-8px);
  box-shadow: var(--shadow-xl);
  background: var(--accent-light);
}

.tool-icon {
  font-size: 3rem;
  margin-bottom: var(--spacing-md);
  display: inline-block;
  animation: iconBounce 2s ease-in-out infinite;
}

@keyframes iconBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.tool-name {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-xs);
  color: var(--accent);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tool-desc {
  font-size: 0.875rem;
  color: var(--text-muted);
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

/* ===== BUTTONS ===== */
.btn {
  padding: 0.6rem 1rem;
  min-height: var(--touch-target);
  border-radius: var(--radius);
  border: none;
  font-weight: 600;
  font-size: var(--text-sm);
  cursor: pointer;
  transition: transform var(--transition), box-shadow var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  white-space: nowrap;
  flex-shrink: 0;
  touch-action: manipulation;
}

.btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
}

.btn-success {
  background: var(--gradient-success);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

.btn-warning {
  background: var(--gradient-warning);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
}

.btn-danger {
  background: var(--gradient-danger);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.btn-secondary {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--accent-light);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-icon {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.toast {
  min-width: 300px;
  padding: 1.125rem 1.5rem;
  border-radius: var(--radius);
  background: var(--card);
  color: var(--text);
  box-shadow: var(--shadow-xl);
  display: flex;
  align-items: center;
  gap: 0.875rem;
  animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 4px solid var(--accent);
  border: 1px solid var(--border);
}

@keyframes slideIn {
  from { 
    opacity: 0; 
    transform: translateY(20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--danger); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: var(--info); }

/* ===== IMPROVED STREAK CARD ===== */
.streak-card {
  background: var(--gradient-warning);
  color: white;
  text-align: center;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  position: relative;
  overflow: hidden;
}

.streak-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.streak-number {
  font-size: 4rem;
  font-weight: 900;
  line-height: 1;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.streak-label {
  font-size: 1.25rem;
  opacity: 0.9;
  margin-bottom: var(--spacing-lg);
  position: relative;
  z-index: 1;
  white-space: nowrap;
}

.streak-milestones {
  display: flex;
  justify-content: center;
  gap: var(--spacing-sm);
  margin: var(--spacing-md) 0;
  position: relative;
  z-index: 1;
  flex-wrap: wrap;
}

.milestone {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
}

.milestone.active {
  background: white;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
}

.streak-btn {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 1rem 2rem;
  border-radius: var(--radius);
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  width: 100%;
  justify-content: center;
  position: relative;
  z-index: 1;
  white-space: nowrap;
}

.streak-btn:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.streak-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.streak-progress {
  height: 6px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  margin: var(--spacing-md) 0;
  position: relative;
  z-index: 1;
  overflow: hidden;
}

.streak-progress-fill {
  height: 100%;
  background: white;
  border-radius: 3px;
  transition: width 0.5s ease;
  position: relative;
}

.streak-progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* ===== MOTIVATION CARD ===== */
.motivation-card {
  background: var(--gradient-purple);
  color: white;
  position: relative;
  overflow: hidden;
}

.motivation-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
}

.quote-text {
  font-size: 1.5rem;
  font-style: italic;
  line-height: 1.6;
  margin-bottom: var(--spacing-md);
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.quote-author {
  font-size: 1.1rem;
  opacity: 0.9;
  position: relative;
  z-index: 1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* ===== CLASS CODE DISPLAY ===== */
.class-code-display {
  background: var(--gradient-primary);
  color: white;
  padding: var(--spacing-xl);
  border-radius: var(--radius-lg);
  margin: var(--spacing-xl) 0;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.class-code-display::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%);
  background-size: 20px 20px;
}

.class-code-display .code {
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.5rem;
  font-family: 'Courier New', monospace;
  margin: var(--spacing-md) 0;
  text-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
  word-break: break-all;
}

/* ===== MULTIPLE CLASSES VIEW ===== */
.classes-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-lg);
}

.class-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  transition: all var(--transition);
  position:relative;
  overflow: hidden;
  max-width: 100%;
}

.class-card:hover {
  border-color: var(--accent);
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
}

.class-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-md);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
  min-width: 0;
}

.class-card-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.class-card-code {
  background: var(--accent);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  font-weight: 700;
  white-space: nowrap;
  flex-shrink: 0;
}

.class-card-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
}

.class-card-stat {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
}

.class-card-stat .value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--accent);
  overflow: hidden;
  text-overflow: ellipsis;
}

.class-card-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.class-card-actions {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
  flex-wrap: nowrap;
}

.class-card-actions .btn {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ===== LEADERBOARD STYLES ===== */
.leaderboard-container {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.leaderboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid var(--border);
  flex-wrap: nowrap;
  gap: var(--spacing-sm);
}

.leaderboard-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
}

.leaderboard-stat {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
}

.leaderboard-stat .value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.25rem;
  overflow: hidden;
  text-overflow: ellipsis;
}

.leaderboard-stat .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.leaderboard-list {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.leaderboard-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  padding: var(--spacing-md);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  transition: all var(--transition);
  flex-wrap: nowrap;
  max-width: 100%;
  overflow: hidden;
}

.leaderboard-item:hover {
  transform: translateX(5px);
  border-color: var(--accent);
  background: var(--accent-light);
}

.leaderboard-item.you {
  background: var(--gradient-primary);
  color: white;
  border-color: var(--accent-dark);
}

.leaderboard-item.you .rank,
.leaderboard-item.you .score,
.leaderboard-item.you .name {
  color: white;
}

.leaderboard-rank {
  font-size: 1.5rem;
  font-weight: 900;
  width: 40px;
  text-align: center;
  color: var(--accent);
  flex-shrink: 0;
}

.rank-1 .leaderboard-rank { color: #ff8a7a; }
.rank-2 .leaderboard-rank { color: #C0C0C0; }
.rank-3 .leaderboard-rank { color: #CD7F32; }

.leaderboard-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 1.25rem;
  flex-shrink: 0;
}

.leaderboard-info {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

.leaderboard-name {
  font-weight: 700;
  font-size: 1.125rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.leaderboard-subtitle {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.leaderboard-item.you .leaderboard-subtitle {
  color: rgba(255, 255, 255, 0.8);
}

.leaderboard-score {
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--accent);
  text-align: right;
  min-width: 80px;
  flex-shrink: 0;
}

.leaderboard-stats-row {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-sm);
  flex-wrap: nowrap;
}

.stats-badge {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 0.25rem;
  white-space: nowrap;
  flex-shrink: 0;
}

.stats-badge.fire { color: var(--warning); }
.stats-badge.time { color: var(--info); }
.stats-badge.points { color: var(--success); }

.leaderboard-empty {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
}

/* ===== ACHIEVEMENT BADGES ===== */
.badges-card .content-body {
  max-height: none;
}

.badges-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-md);
}

.badge-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  display: grid;
  grid-template-columns: 44px 1fr;
  gap: var(--spacing-md);
  align-items: center;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.badge-item::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, transparent 20%, rgba(255,255,255,0.2), transparent 80%);
  opacity: 0;
  transition: opacity var(--transition);
}

.badge-item:hover::after {
  opacity: 1;
}

.badge-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: rgba(255,255,255,0.2);
  flex-shrink: 0;
}

.badge-info {
  min-width: 0;
}

.badge-title {
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
  white-space: normal;
}

.badge-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  line-height: 1.4;
}

.badge-tag {
  margin-top: 6px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 0.2rem 0.5rem;
  border-radius: 999px;
  background: rgba(255,255,255,0.35);
  color: #0f172a;
}

.badge-item[data-tone="sunrise"] {
  background: linear-gradient(135deg, rgba(251,146,60,0.15), rgba(253,186,116,0.35));
  border-color: rgba(251,146,60,0.5);
}
.badge-item[data-tone="weekend"] {
  background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(147,197,253,0.35));
  border-color: rgba(59,130,246,0.5);
}
.badge-item[data-tone="focus"] {
  background: linear-gradient(135deg, rgba(16,185,129,0.12), rgba(110,231,183,0.35));
  border-color: rgba(16,185,129,0.5);
}
.badge-item[data-tone="time"] {
  background: linear-gradient(135deg, rgba(234,88,12,0.12), rgba(253,186,116,0.35));
  border-color: rgba(234,88,12,0.5);
}
.badge-item[data-tone="streak"] {
  background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(216,180,254,0.35));
  border-color: rgba(139,92,246,0.5);
}
.badge-item[data-tone="tasks"] {
  background: linear-gradient(135deg, rgba(244,63,94,0.12), rgba(251,113,133,0.35));
  border-color: rgba(244,63,94,0.5);
}
.badge-item[data-tone="assign"] {
  background: linear-gradient(135deg, rgba(20,184,166,0.12), rgba(125,211,252,0.35));
  border-color: rgba(20,184,166,0.5);
}
.badge-item[data-tone="consistency"] {
  background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(253,230,138,0.35));
  border-color: rgba(245,158,11,0.5);
}
.badge-item[data-tone="goal"] {
  background: linear-gradient(135deg, rgba(14,165,233,0.12), rgba(186,230,253,0.35));
  border-color: rgba(14,165,233,0.5);
}

@media (max-width: 767px) {
  .badges-grid {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
  .badge-item {
    grid-template-columns: 40px 1fr;
    padding: 0.65rem;
  }
  .badge-icon {
    width: 40px;
    height: 40px;
    font-size: 1.1rem;
  }
  .badge-title {
    font-size: 0.85rem;
  }
  .badge-desc {
    font-size: 0.75rem;
  }

  .toast {
    min-width: 220px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 479px) {
  .badges-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--spacing-sm);
  }
  .badge-item {
    grid-template-columns: 34px 1fr;
    padding: 0.55rem;
  }
  .badge-icon {
    width: 34px;
    height: 34px;
    font-size: 1rem;
  }
  .badge-title {
    font-size: 0.8rem;
  }
  .badge-desc {
    font-size: 0.7rem;
  }
}

/* ===== UPDATED STATISTICS SECTION ===== */
.statistics-grid {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.statistics-header {
  grid-column: span 12;
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  margin-bottom: var(--spacing-lg);
}

.statistics-header h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: var(--spacing-sm);
  color: var(--text);
}

.statistics-subtitle {
  color: var(--text-muted);
  font-size: 1rem;
  margin-bottom: var(--spacing-lg);
}

.stats-overview-cards {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.stats-overview-card {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  border: 1px solid var(--border);
  transition: var(--transition);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.stats-overview-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow);
  border-color: var(--accent);
}

.stats-overview-icon {
  font-size: 2rem;
  margin-bottom: var(--spacing-sm);
  display: block;
}

.stats-overview-number {
  font-size: 2rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: var(--spacing-xs);
  line-height: 1;
}

.stats-overview-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: var(--spacing-sm);
}

.stats-overview-trend {
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-sm);
}

.stats-overview-trend.up {
  color: var(--success);
}

.stats-overview-trend.down {
  color: var(--danger);
}

.stats-overview-trend.neutral {
  color: var(--text-muted);
}

/* Charts Container - Improved for Mobile */
.charts-container {
  grid-column: span 12;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.chart-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  transition: all var(--transition);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.chart-card:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--accent);
}

.chart-header {
  margin-bottom: var(--spacing-lg);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
}

.chart-header h3 {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.chart-description {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-top: var(--spacing-xs);
  line-height: 1.4;
}

.chart-wrapper {
  position: relative;
  height: 250px;
  width: 100%;
  flex: 1;
  min-height: 200px;
}

/* Detailed Statistics */
.stats-detailed-container {
  grid-column: span 12;
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  margin-top: var(--spacing-lg);
}

.stats-detailed-container h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  color: var(--text);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.stats-detailed-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--spacing-lg);
  margin-bottom: var(--spacing-xl);
}

.stats-detailed-section {
  padding: var(--spacing-lg);
  background: var(--bg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.stats-detailed-section h4 {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: var(--spacing-md);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stats-detailed-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-sm) 0;
  border-bottom: 1px solid rgba(var(--border-rgb), 0.2);
}

.stats-detailed-row:last-child {
  border-bottom: none;
}

.stats-detailed-label {
  font-size: 0.875rem;
  color: var(--text);
}

.stats-detailed-value {
  font-size: 1rem;
  font-weight: 700;
  color: var(--accent);
}

/* Chart Legends - Theme Adaptive */
.chart-legend {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
  padding-top: var(--spacing-md);
  border-top: 1px solid var(--border);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  font-size: 0.75rem;
  color: var(--text-muted);
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

/* Statistics Controls */
.stats-controls {
  display: flex;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--border);
}

.stats-controls .btn {
  font-size: 0.875rem;
  padding: 0.5rem 1rem;
}

/* Performance Metrics */
.performance-metrics {
  grid-column: span 12;
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: var(--spacing-xl);
  border: 1px solid var(--border);
  margin-top: var(--spacing-lg);
}

.performance-metrics h3 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: var(--spacing-lg);
  color: var(--text);
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--spacing-lg);
}

.metric-card {
  background: var(--bg);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  border: 1px solid var(--border);
  text-align: center;
  transition: var(--transition);
}

.metric-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.metric-icon {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  display: block;
}

.metric-value {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--accent);
  margin-bottom: var(--spacing-xs);
  line-height: 1;
}

.metric-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-xs);
}

.metric-details {
  font-size: 0.75rem;
  color: var(--text);
  opacity: 0.8;
}

/* Study Session Button */
.study-session-btn {
  margin-top: var(--spacing-lg);
  width: 100%;
}

/* ===== FOOTER WITH COPYRIGHT ===== */
.footer {
  grid-column: span 12;
  text-align: center;
  padding: var(--spacing-xl);
  margin-top: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 0.875rem;
  border-top: 1px solid var(--border);
}

.footer a {
  color: var(--accent);
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { 
  width: 8px; 
  height: 8px;
}

::-webkit-scrollbar-track { 
  background: var(--bg); 
  border-radius: 4px;
}

::-webkit-scrollbar-thumb { 
  background: var(--accent); 
  border-radius: 4px;
  border: 2px solid var(--bg);
}

::-webkit-scrollbar-thumb:hover { 
  background: var(--accent-dark); 
}

/* ===== LOADING STATES ===== */
.loading {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  font-size: 1.125rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.loading::after {
  content: '';
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== EMPTY STATES ===== */
.empty-state {
  text-align: center;
  padding: var(--spacing-2xl);
  color: var(--text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-md);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: var(--spacing-lg);
  opacity: 0.5;
}

.empty-state-title {
  font-size: 1.5rem;
  margin-bottom: var(--spacing-sm);
  color: var(--text);
}

.empty-state-description {
  font-size: 1rem;
  line-height: 1.6;
}

/* ===== SYNC STATUS ===== */
.sync-status {
  position: fixed;
  top: 80px;
  right: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: 0.875rem;
  z-index: 999;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  backdrop-filter: blur(10px);
  animation: fadeIn 0.5s ease-out;
  white-space: nowrap;
}

/* ===== EXTREME RESPONSIVENESS ===== */

/* Switch to single column below 1100px */
@media (max-width: 1100px) {
  .app-layout {
    grid-template-columns: 1fr;
  }
}

/* Desktop (1200px and above) */
@media (min-width: 1200px) {
  .app-layout {
    grid-template-columns: 280px 1fr;
  }
  
  .forms-section,
  .content-section {
    grid-column: span 6;
  }
  
  .quick-stats {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .charts-container {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Tablet (768px to 1199px) */
@media (max-width: 1199px) and (min-width: 768px) {
  .app-layout {
    grid-template-columns: 240px 1fr;
  }
  
  .forms-section,
  .content-section {
    grid-column: span 6;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .charts-container {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-overview-cards {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .stats-detailed-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .classes-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Mobile (below 768px) */
@media (max-width: 767px) {
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .top-nav {
    display: block;
  }
  
  .sidebar {
    position: fixed;
    top: 60px;
    left: -280px;
    width: 280px;
    height: calc(100vh - 60px);
    transition: left 0.3s ease;
    z-index: 100;
    padding: var(--spacing-lg);
  }
  
  .sidebar.active {
    left: 0;
  }
  
  .mobile-menu-toggle {
    display: flex;
  }
  
  .mobile-overlay.active {
    display: block;
  }
  
  .main-content {
    margin-top: 60px;
    padding: var(--spacing-md);
  }
  
  .forms-section,
  .content-section {
    grid-column: span 12;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
  }
  
  .dashboard-header h1 {
    font-size: 1.75rem;
    text-align: center;
  }
  
  .dashboard-subtitle {
    text-align: center;
  }
  
  .controls-bar {
    flex-wrap: wrap;
    padding: var(--spacing-sm);
    gap: var(--spacing-sm);
    justify-content: center;
  }
  
  .controls-bar .btn {
    font-size: 0.75rem;
    padding: 0.375rem 0.625rem;
    flex: 1;
    min-width: calc(50% - 0.375rem);
  }
  
  /* UPDATED: Statistics Section for Mobile */
  .statistics-grid {
    gap: var(--spacing-md);
  }
  
  .statistics-header {
    padding: var(--spacing-lg);
    text-align: center;
  }
  
  .statistics-header h2 {
    font-size: 1.25rem;
  }
  
  .stats-overview-cards {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
  }
  
  .stats-overview-card {
    padding: var(--spacing-md);
  }
  
  .stats-overview-number {
    font-size: 1.5rem;
  }
  
  .stats-overview-icon {
    font-size: 1.5rem;
  }
  
  .charts-container {
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }
  
  .chart-card {
    padding: var(--spacing-lg);
  }
  
  .chart-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }
  
  .chart-header h3 {
    font-size: 1rem;
  }
  
  .chart-wrapper {
    height: 200px;
    min-height: 150px;
  }
  
  .chart-description {
    font-size: 0.8125rem;
  }
  
  .stats-detailed-container {
    padding: var(--spacing-lg);
  }
  
  .stats-detailed-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }
  
  .stats-detailed-section {
    padding: var(--spacing-md);
  }
  
  .stats-detailed-row {
    padding: var(--spacing-xs) 0;
  }
  
  .performance-metrics {
    padding: var(--spacing-lg);
  }
  
  .metrics-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
  }
  
  .metric-card {
    padding: var(--spacing-md);
  }
  
  .metric-value {
    font-size: 1.5rem;
  }
  
  .stats-controls {
    flex-direction: column;
    gap: var(--spacing-sm);
  }
  
  .stats-controls .btn {
    width: 100%;
    justify-content: center;
  }
  
  .content-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .content-header h2 {
    font-size: 1.125rem;
  }
  
  .stat-card {
    flex-direction: column;
    text-align: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
  }
  
  .stat-icon {
    width: 32px;
    height: 32px;
    font-size: 1rem;
  }
  
  .stat-number {
    font-size: 1.25rem;
  }
  
  .stat-label {
    font-size: 0.65rem;
  }
  
  .task-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-md);
  }
  
  .task-actions {
    width: 100%;
    justify-content: flex-end;
  }
  
  .assignment-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .class-card-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .leaderboard-item {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .leaderboard-score {
    align-self: flex-end;
    margin-top: var(--spacing-sm);
  }
}

/* Small Mobile (below 480px) */
@media (max-width: 479px) {
  .quick-stats {
    grid-template-columns: 1fr;
  }
  
  .stats-overview-cards {
    grid-template-columns: 1fr;
  }
  
  .charts-container {
    grid-template-columns: 1fr;
  }
  
  .stats-detailed-grid {
    grid-template-columns: 1fr;
  }
  
  .metrics-grid {
    grid-template-columns: 1fr;
  }
  
  .controls-bar .btn {
    font-size: 0.7rem;
    padding: 0.375rem 0.5rem;
    min-width: 100%;
  }
  
  .priority-selector {
    flex-direction: column;
  }
  
  .class-code-display .code {
    font-size: 2rem;
    letter-spacing: 0.25rem;
  }
  
  .streak-number {
    font-size: 3rem;
  }
  
  .dashboard-header h1 {
    font-size: 1.5rem;
  }
  
  .toast {
    min-width: 250px;
    padding: 1rem;
  }
  
  .stat-card {
    padding: 0.75rem;
    min-height: 70px;
  }
  
  .stat-number {
    font-size: 1.1rem;
  }
  
  .chart-wrapper {
    height: 180px;
  }
}

/* Orientation-specific adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .sidebar {
    padding-top: var(--spacing-lg);
    height: 100vh;
    overflow-y: auto;
  }
  
  .main-content {
    padding: var(--spacing-md);
  }
  
  .chart-wrapper {
    height: 150px;
  }
}

/* Print Styles */
@media print {
  .sidebar,
  .mobile-menu-toggle,
  .controls-bar,
  .btn,
  .task-actions,
  .assignment-actions,
  .class-card-actions {
    display: none !important;
  }
  
  .app-layout {
    grid-template-columns: 1fr;
  }
  
  .main-content {
    padding: 0;
    margin: 0;
  }
  
  .content-card {
    border: 1px solid #000;
    box-shadow: none;
  }
  
  .task-item,
  .assignment-item,
  .classroom-item {
    break-inside: avoid;
  }
  
  .chart-wrapper {
    height: 200px !important;
  }
}

/* ===== FLOATING FEEDBACK BUTTON ===== */
.feedback-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--gradient-info);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    padding: var(--spacing-md) var(--spacing-lg);
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-xl);
    z-index: 999;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    transition: all var(--transition);
    animation: pulse 2s infinite;
}

.feedback-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-2xl);
    background: var(--gradient-info-dark);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

/* Add this to your CSS variables if needed */
:root {
    --gradient-info-dark: linear-gradient(135deg, #2563eb, #1d4ed8);
}

/* Mobile adjustments */
@media (max-width: 767px) {
    .feedback-btn {
        bottom: 70px;
        right: 15px;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.875rem;
    }
}
/* ===== MOBILE NAVIGATION WITH CONTROLS BAR ===== */
@media (max-width: 767px) {
  /* Move controls bar to mobile nav */
  .controls-bar {
    display: none !important; /* Hide from main content on mobile */
  }
  
  /* New container for controls in mobile nav */
  .mobile-nav-controls {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 4px;
    padding: 8px 12px;
    background: var(--card);
    border-top: 1px solid var(--border);
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--shadow);
    max-width: 100vw;
    overflow: hidden;
  }
  
  /* Style the mobile controls buttons */
  .mobile-nav-controls .btn {
    padding: 6px 4px;
    font-size: 11px;
    border-radius: var(--radius-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 40px;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  
  /* Add mobile nav controls to existing top nav structure */
  .top-nav {
    flex-direction: column;
    padding: 0;
    min-height: 60px;
    align-items: stretch;
  }
  
  .top-nav-header {
    padding: 8px 12px;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  /* Adjust main content margin to account for the combined nav height */
  .main-content {
    margin-top: 100px !important; /* 60px (top nav) + 40px (controls) */
  }
  
  /* Adjust sidebar position for the taller nav */
  .sidebar {
    top: 100px !important;
    height: calc(100vh - 100px) !important;
  }
  
  /* Floating feedback button adjustment */
  .feedback-btn {
    bottom: 80px;
    right: 12px;
  }
}

/* Small Mobile (below 480px) */
@media (max-width: 479px) {
  .mobile-nav-controls .btn {
    font-size: 10px;
    padding: 5px 3px;
    min-height: 36px;
  }
  
  .main-content {
    margin-top: 96px !important; /* Adjusted for smaller controls */
  }
  
  .sidebar {
    top: 96px !important;
    height: calc(100vh - 96px) !important;
  }
}

/* Landscape mode adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .mobile-nav-controls {
    position: sticky;
    top: 60px;
  }
  
  .mobile-nav-controls .btn {
    min-height: 32px;
    font-size: 9px;
    padding: 4px 2px;
  }
  
  .main-content {
    margin-top: 92px !important; /* Smaller in landscape */
  }
  
  .sidebar {
    top: 92px !important;
    height: calc(100vh - 92px) !important;
  }
}

/* Ensure the mobile controls don't appear on desktop */
@media (min-width: 768px) {
  .mobile-nav-controls {
    display: none !important;
  }
}

/* ===== MOBILE TOP NAV WITH INLINE CONTROLS ===== */
@media (max-width: 767px) {
  /* Hide the original controls bar in main content on mobile */
  .controls-bar {
    display: none !important;
  }
  
  /* Update top nav structure */
  .top-nav {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    z-index: 1000;
    padding: 0;
    height: 52px;
  }
  
  .top-nav-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px;
    gap: 6px;
    height: 52px;
    width: 100%;
  }
  
  .top-nav-header h2 {
    font-size: 1rem;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
    flex-shrink: 0;
  }
  
  /* Mobile controls container - inline with title */
  .mobile-nav-controls {
    display: flex;
    flex: 1;
    justify-content: space-between;
    gap: 4px;
    overflow-x: visible;
    padding: 0;
    margin: 0 6px;
    min-width: 0;
  }
  
  /* Style the inline control buttons - all visible */
  .mobile-nav-controls .btn {
    padding: 5px 6px;
    font-size: 11px;
    border-radius: var(--radius-sm);
    white-space: nowrap;
    flex: 1;
    min-width: 0;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  
  /* Button text styling */
  .mobile-nav-controls .btn span {
    display: inline;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Mobile menu toggle */
  .mobile-menu-toggle {
    width: 36px;
    height: 36px;
    font-size: 1rem;
    flex-shrink: 0;
    margin: 0;
  }
  
  /* Adjust main content position */
  .main-content {
    margin-top: 52px !important;
    padding-top: var(--spacing-sm) !important;
  }
  
  /* Adjust sidebar position */
  .sidebar {
    top: 52px !important;
    height: calc(100vh - 52px) !important;
  }
  
  /* Adjust floating feedback button */
  .feedback-btn {
    bottom: 70px;
    right: 10px;
    padding: 8px 12px;
    font-size: 0.75rem;
  }
}

/* Tablet adjustments (480px - 767px) */
@media (min-width: 480px) and (max-width: 767px) {
  .top-nav-header h2 {
    max-width: 150px;
  }
  
  .mobile-nav-controls .btn {
    font-size: 12px;
    padding: 6px 8px;
  }
}

/* Small Mobile (below 480px) */
@media (max-width: 479px) {
  .top-nav-header {
    padding: 4px 6px;
    height: 48px;
  }
  
  .top-nav-header h2 {
    font-size: 0.875rem;
    max-width: 100px;
  }
  
  .mobile-nav-controls {
    gap: 3px;
    margin: 0 4px;
  }
  
  .mobile-nav-controls .btn {
    padding: 4px 5px;
    font-size: 10px;
    height: 30px;
  }
  
  .mobile-menu-toggle {
    width: 32px;
    height: 32px;
  }
  
  .main-content {
    margin-top: 48px !important;
  }
  
  .sidebar {
    top: 48px !important;
    height: calc(100vh - 48px) !important;
  }
}

/* Extra small screens (below 360px) */
@media (max-width: 359px) {
  .top-nav-header {
    height: 46px;
    padding: 3px 4px;
  }
  
  .top-nav-header h2 {
    font-size: 0.75rem;
    max-width: 80px;
  }
  
  .mobile-nav-controls {
    gap: 2px;
    margin: 0 3px;
  }
  
  .mobile-nav-controls .btn {
    padding: 3px 4px;
    font-size: 9px;
    height: 28px;
  }
  
  /* Show only icons on very small screens */
  .mobile-nav-controls .btn span {
    display: none;
  }
  
  .mobile-nav-controls .btn::before {
    font-size: 12px;
  }
  
  .mobile-nav-controls .btn:nth-child(1)::before {
    content: "ðŸ ";
  }
  
  .mobile-nav-controls .btn:nth-child(2)::before {
    content: "ðŸŽ“";
  }
  
  .mobile-nav-controls .btn:nth-child(3)::before {
    content: "ðŸ”„";
  }
  
  .mobile-nav-controls .btn:nth-child(4)::before {
    content: "ðŸ“¤";
  }
  
  .mobile-menu-toggle {
    width: 30px;
    height: 30px;
    font-size: 0.875rem;
  }
  
  .main-content {
    margin-top: 46px !important;
  }
  
  .sidebar {
    top: 46px !important;
    height: calc(100vh - 46px) !important;
  }
}

/* Landscape mode adjustments */
@media (max-height: 600px) and (orientation: landscape) {
  .top-nav-header {
    height: 44px;
    padding: 3px 5px;
  }
  
  .mobile-nav-controls .btn {
    height: 28px;
    padding: 3px 5px;
    font-size: 10px;
  }
  
  .mobile-menu-toggle {
    width: 30px;
    height: 30px;
  }
  
  .main-content {
    margin-top: 44px !important;
  }
  
  .sidebar {
    top: 44px !important;
    height: calc(100vh - 44px) !important;
  }
}

/* Hide mobile controls on desktop */
@media (min-width: 768px) {
  .mobile-nav-controls {
    display: none !important;
  }
}

/* Ensure no horizontal scroll on mobile */
@media (max-width: 767px) {
  html, body {
    overflow-x: hidden;
    max-width: 100vw;
  }
  
  .app-layout {
    overflow-x: hidden;
  }
}

/* ===== DAILY GOAL TRACKER ===== */
.goal-card {
  background: var(--card);
  border: 1px solid var(--border);
}

.goal-text {
  font-weight: 700;
  margin-bottom: var(--spacing-md);
  color: var(--text);
  font-size: 1rem;
}

.goal-progress {
  height: 12px;
  background: var(--accent-light);
  border-radius: 999px;
  overflow: hidden;
  margin-bottom: var(--spacing-sm);
}

.goal-progress-fill {
  height: 100%;
  background: var(--gradient-success);
  width: 0%;
  transition: width 0.4s ease;
}

.goal-stats {
  font-size: 0.9rem;
  color: var(--text-muted);
  margin-bottom: var(--spacing-sm);
}

.goal-message {
  font-weight: 600;
  color: var(--success);
}

.goal-input {
  margin-top: var(--spacing-sm);
}

.goal-input label {
  display: block;
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

/* ===== CONFETTI LAYER ===== */
#confettiLayer {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2000; /* Above everything */
  overflow: hidden;
}

.confetti {
  position: absolute;
  top: -10px;
  width: 10px;
  height: 14px;
  opacity: 0.95;
  border-radius: 2px;
  animation: confettiFall 5.5s linear forwards;
}

.confetti.burst {
  top: 50%;
  left: 50%;
  animation: confettiBurst 1.8s ease-out forwards;
}

@keyframes confettiFall {
  0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
  80%  { transform: translateY(95vh) rotate(620deg); opacity: 1; }
  95%  { transform: translateY(105vh) rotate(700deg); opacity: 1; }
  100% { transform: translateY(105vh) rotate(720deg); opacity: 0; }
}

@keyframes confettiBurst {
  0% {
    transform: translate(-50%, -50%) translate(0, 0) rotate(0deg) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) translate(var(--x), var(--y)) rotate(720deg) scale(0.9);
    opacity: 0;
  }
}

/* ===== CELEBRATE BUTTON ===== */
.celebrate-btn {
  margin-top: var(--spacing-md);
  width: 100%;
  background: var(--gradient-success);
  color: white;
  border: none;
  border-radius: var(--radius);
  padding: 0.75rem 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  letter-spacing: 0.3px;
}

.celebrate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(16, 185, 129, 0.35);
}

.celebrate-btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, transparent 20%, rgba(255,255,255,0.35), transparent 80%);
  transform: translateX(-120%);
  transition: transform 0.8s ease;
}

.celebrate-btn:hover::after {
  transform: translateX(120%);
}

.celebrate-btn.pulse {
  animation: celebratePulse 1.6s ease-in-out infinite;
}

@keyframes celebratePulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.5); }
  50% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
}

.confetti.sparkle {
  border-radius: 50%;
}

/* Add to your CSS file */
.memory-whiteboard {
    position: relative;
    width: 100%;
    height: 600px;
    background: linear-gradient(45deg, var(--card) 25%, transparent 25%, transparent 75%, var(--card) 75%, var(--card) 100%),
                linear-gradient(45deg, var(--card) 25%, var(--bg) 25%, var(--bg) 75%, var(--card) 75%, var(--card) 100%);
    background-size: 40px 40px;
    background-position: 0 0, 20px 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: var(--spacing-md) 0;
}

.sticky-notes-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.sticky-note {
    position: absolute;
    width: 250px;
    min-height: 200px;
    padding: var(--spacing-md);
    border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: move;
    pointer-events: auto;
    transition: box-shadow 0.2s, transform 0.2s;
    overflow: hidden;
    z-index: 2;
}

.sticky-note:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px) rotate(0deg) !important;
}

.sticky-note.dragging {
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    transform: scale(1.05) rotate(0deg) !important;
    z-index: 1000 !important;
}

.sticky-note.welcome {
    width: 300px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white;
    text-align: center;
}

.whiteboard-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px),
        linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px);
    background-size: 20px 20px;
}

.whiteboard-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

/* Student Whiteboard CSS */
#studentMemoryWhiteboard {
    position: relative;
    width: 100%;
    height: 600px;
    background: linear-gradient(45deg, var(--card) 25%, transparent 25%, transparent 75%, var(--card) 75%, var(--card) 100%),
                linear-gradient(45deg, var(--card) 25%, var(--bg) 25%, var(--bg) 75%, var(--card) 75%, var(--card) 100%);
    background-size: 40px 40px;
    background-position: 0 0, 20px 20px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin: var(--spacing-md) 0;
}

#studentStickyNotesContainer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

/* Student Sticky Note */
.student-sticky-note {
    position: absolute;
    width: 250px;
    min-height: 200px;
    padding: var(--spacing-md);
    border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    cursor: move;
    pointer-events: auto;
    transition: box-shadow 0.2s, transform 0.2s;
    overflow: hidden;
    z-index: 2;
}

.student-sticky-note:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px) rotate(0deg) !important;
}

.student-sticky-note.dragging {
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    transform: scale(1.05) rotate(0deg) !important;
    z-index: 1000 !important;
}

.student-note-content {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.student-note-text {
    flex: 1;
    font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
    font-size: 16px;
    line-height: 1.5;
    overflow-wrap: break-word;
    margin-bottom: var(--spacing-md);
}

.student-note-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
    color: rgba(0, 0, 0, 0.7);
    margin-top: auto;
}

.student-note-author {
    font-weight: 600;
}

.student-note-date {
    opacity: 0.7;
}

.student-note-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--spacing-sm);
}

.student-note-likes {
    display: flex;
    align-items: center;
    gap: 4px;
    font-weight: 600;
}

.btn-student-note {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.btn-student-note:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

.btn-like {
    color: #e63946;
}

.btn-delete {
    color: #666;
}

.student-welcome-note {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-1deg);
    width: 300px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: var(--spacing-lg);
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    z-index: 1;
}

/* Add to your CSS */
.dashboard-content {
    display: none;
}

.dashboard-content[style*="display: block"] {
    display: block !important;
}

/* Force proper text color inheritance */
body, #studentMemoryWhiteboard, #studentStickyNotesContainer {
    color: var(--text) !important;
}

/* Reset sticky note text colors */
.student-sticky-note,
.student-sticky-note .student-note-text,
.student-sticky-note .student-note-meta,
.student-sticky-note .student-note-author,
.student-sticky-note .student-note-date,
.student-sticky-note .student-note-likes {
    color: #333 !important;
}

/* Except for buttons */
.student-sticky-note .btn-student-note {
    color: inherit;
}

.student-sticky-note .btn-like {
    color: #e63946 !important;
}

/* Dark text for light backgrounds, white text for dark backgrounds */
.student-sticky-note {
    --text-dark: #333;
    --text-light: white;
    
    color: var(--text-dark) !important;
}

/* For really dark colored notes */
.student-sticky-note[style*="background: #000"],
.student-sticky-note[style*="background: #111"],
.student-sticky-note[style*="background: #222"],
.student-sticky-note[style*="background: #333"],
.student-sticky-note[style*="background: #444"],
.student-sticky-note[style*="background: #555"] {
    color: var(--text-light) !important;
}
</style>





</head>

<body>

    
  <!-- Top Navigation for Mobile -->
<nav class="top-nav" id="topNav">
  <div class="top-nav-header">
    <h2>Student Dashboard</h2>
    
    <!-- Mobile controls - all buttons in one line -->
    <div class="mobile-nav-controls" id="mobileNavControls">
      <button class="btn btn-success" onclick="window.location.href='index.html'">
        <span>ðŸ  Home</span>
      </button>
      <button class="btn btn-success" onclick="showSection('myclasses')">
        <span>ðŸŽ“ Classes</span>
      </button>
      <button class="btn btn-secondary" onclick="refreshData()">
        <span>ðŸ”„ Refresh</span>
      </button>
      <button class="btn btn-warning" onclick="exportData()">
        <span>ðŸ“¤ Export</span>
      </button>
    </div>
    
    <button class="mobile-menu-toggle" id="mobileMenuToggle">â˜°</button>
  </div>
</nav>
<div class="mobile-overlay" id="mobileOverlay"></div>

<div class="app-layout">
  
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="student-emoji">ðŸ‘¨â€ðŸŽ“</div>
      <h2>Student Dashboard</h2>
      <span class="premium-badge">ðŸ‘‘ Premium</span>
      <p class="sidebar-subtitle">Track Your Learning Journey</p>
    </div>
    
    <!-- Class Switcher -->
    <div class="class-switcher">
      <select id="classSelector" onchange="switchClass(this.value)">
        <option value="">Select a Class</option>
      </select>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showSection('dashboard'); closeMobileMenu();">
        ðŸ“Š Dashboard
      </div>

   <div class="nav-item" onclick="showStudentMemoryWall(); closeMobileMenu();">
    ðŸ“ Memory Wall
</div>

      <div class="nav-item" onclick="showSection('tasks'); closeMobileMenu();">
        ðŸ“ Tasks
      </div>
      <div class="nav-item" onclick="showSection('assignments'); closeMobileMenu();">
        ðŸ“š Assignments
      </div>
      <div class="nav-item" onclick="showSection('classroom'); closeMobileMenu();">
        ðŸ« Classroom
      </div>
      <div class="nav-item" onclick="showSection('myclasses'); closeMobileMenu();">
        ðŸŽ“ My Classes
      </div>
      <!-- Or if you want a more prominent button, add this: -->
<div class="sidebar-btn nav-item" onclick="window.location.href='student_checkin.html'" >
    ðŸ˜Š Quick Check-in
</div>
      <div class="sidebar-btn nav-item" onclick="showSection('exitTicket'); closeMobileMenu();">
        ðŸ“ Exit Ticket
      </div>
      <div class="nav-item" onclick="showSection('statistics'); closeMobileMenu();">
        ðŸ“ˆ Statistics
      </div>
      <div class="nav-item" onclick="showSection('tools'); closeMobileMenu();">
        ðŸ› ï¸ Study Tools
      </div>
      <div class="nav-item" onclick="showSection('ai'); closeMobileMenu();">
        ðŸ¤– AI Help
      </div>
      <div class="nav-item" onclick="showSection('profile'); closeMobileMenu();">
        ðŸ‘¤ Profile
      </div>
      <!-- New Study Group Button -->
      <div class="nav-item" onclick="window.location.href='studygroup.html'; closeMobileMenu();">
        ðŸ‘¥ Study Group
      </div>
    </nav>
    
    <div class="sidebar-stats">
      <h3>Today's Stats</h3>
      <div class="stat-row">
        <span>Study Streak</span>
        <span class="stat-value" id="sidebarStreak">0</span>
      </div>
      <div class="stat-row">
        <span>Total Hours</span>
        <span class="stat-value" id="sidebarHours">0</span>
      </div>
      <div class="stat-row">
        <span>Tasks Done</span>
        <span class="stat-value" id="sidebarTasks">0</span>
      </div>
      <div class="stat-row">
        <span>Focus Score</span>
        <span class="stat-value" id="sidebarFocus">0%</span>
      </div>
    </div>
    
    <!-- Inspiring Stories Section -->
    <div class="stories-section">
      <h3>ðŸŒŸ Inspiring Stories</h3>
      <div id="storiesList">
        <!-- Stories will be loaded here -->
      </div>
    </div>

    <!-- Study Heatmap -->
    <div class="heatmap-section">
      <h3>ðŸ—“ï¸ Study Heatmap</h3>
      <div class="pro-tip" style="margin: 0 0 var(--spacing-md) 0;">
        <strong>ðŸ’¡ Heatmap Tip</strong>
        Each square represents a day. Higher numbers and brighter squares mean more study sessions.
      </div>
      <div class="heatmap-grid" id="studyHeatmap"></div>
      <div class="heatmap-legend">
        <span>Less</span>
        <span>More</span>
      </div>
    </div>
    
    <div style="margin-top: var(--spacing-xl);">
      <select class="theme-selector" onchange="changeTheme(this.value)" style="width: 100%; padding: 0.875rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text);">
        <option value="light">â˜€ï¸ Light Theme</option>
        <option value="dark">ðŸŒ™ Dark Theme</option>
        <option value="ocean">ðŸŒŠ Ocean Theme</option>
        <option value="forest">ðŸŒ² Forest Theme</option>
        <option value="sunset">ðŸŒ… Sunset Theme</option>
        <option value="purple">ðŸ’œ Purple Theme</option>
        <option value="rainbow">ðŸŒˆ Rainbow Theme</option>
        <option value="premium">ðŸ‘‘ Premium Theme</option>
      </select>
    </div>
  </aside>
  
  <!-- Story Modal -->
  <div id="storyModal" class="story-modal">
    <div class="story-modal-content">
      <button class="story-modal-close" onclick="closeStoryModal()">Ã—</button>
      <div class="story-modal-header">
        <h2 id="storyModalTitle"></h2>
      </div>
      <div class="story-modal-body">
        <div id="storyModalContent"></div>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <main class="main-content">
    <!-- Focus Mode Toolkit -->
    <section class="focus-mode-panel">
      <video class="focus-portal-video" autoplay muted loop playsinline>
        <source src="portal.mp4" type="video/mp4">
      </video>
      <div id="portalOverlay" class="portal-overlay" aria-hidden="true">
        <div class="portal-ring"></div>
        <div class="portal-vortex"></div>
      </div>
      <div class="focus-header">
        <h2>Focus Portal</h2>
        <div class="quick-notes-actions">
          <button class="btn btn-secondary" onclick="toggleFocusMode()">Exit Focus</button>
        </div>
      </div>
      <div id="focusLockBanner" class="focus-lock-banner" style="display: none;"></div>
      <div class="focus-grid">
        <div class="focus-card">
              <h3>Focus Commitment Lock</h3>
              <div class="form-group">
                <label for="focusTopic">What are you studying?</label>
                <input type="text" id="focusTopic" placeholder="e.g., Algebra practice">
              </div>
              <div class="form-group">
                <label for="focusCommitMinutes">Commitment (minutes)</label>
                <input type="number" id="focusCommitMinutes" min="15" max="180" step="5" value="50">
              </div>
              <div class="focus-actions">
                <button class="btn btn-success" onclick="startFocusCommitment()">Lock In</button>
                <button class="btn btn-warning" onclick="requestEmergencyUnlock()">Emergency Unlock</button>
              </div>
              <div class="quick-notes-meta">
                <span id="focusCommitStatus">No active commitment</span>
                <span id="emergencyUnlockTimer"></span>
              </div>
        </div>

        <div class="focus-card">
              <h3>Deep Focus Timer</h3>
              <div class="focus-timer-display" id="focusTimerDisplay">50:00</div>
              <div class="form-group">
                <label>Focus / Break (minutes)</label>
                <div style="display: flex; gap: var(--spacing-sm);">
                  <input type="number" id="focusMinutes" min="25" max="90" step="5" value="50" style="flex: 1;">
                  <input type="number" id="breakMinutes" min="5" max="20" step="1" value="10" style="flex: 1;">
                </div>
              </div>
              <div class="focus-actions">
                <button class="btn btn-primary" onclick="startFocusTimer()">Start</button>
                <button class="btn btn-secondary" onclick="pauseFocusTimer()">Pause</button>
                <button class="btn btn-warning" onclick="resetFocusTimer()">Reset</button>
              </div>
              <div class="focus-metrics">
                <div>Mode: <strong id="focusTimerMode">Focus</strong></div>
                <div>Sessions today: <strong id="focusSessionsToday">0</strong></div>
                <div>Daily streak: <strong id="focusStreak">0</strong></div>
                <div>Next break: <strong id="focusNextBreak">10m</strong></div>
              </div>
        </div>

        <div class="focus-card">
          <h3>Session Goal</h3>
          <div class="form-group">
            <label for="focusGoalInput">Daily deep sessions goal</label>
            <input type="number" id="focusGoalInput" min="1" max="12" step="1" value="3">
          </div>
          <div class="focus-actions">
            <button class="btn btn-primary" onclick="saveFocusGoal()">Set Goal</button>
          </div>
          <div class="quick-notes-meta">
            <span id="focusGoalProgress">0 / 0</span>
            <span id="focusGoalMessage"></span>
          </div>
        </div>

        <div class="focus-card">
          <h3>Future Identity Reminder</h3>
          <p style="font-size: 0.9rem; color: var(--text-muted);">Attach study to identity. You act according to who you believe you are.</p>
          <div class="form-group">
            <label for="futureIdentityInput">Your future identity</label>
            <input type="text" id="futureIdentityInput" placeholder="Future Doctor / AI Engineer / Historian">
          </div>
          <div class="focus-actions">
            <button class="btn btn-primary" onclick="saveFutureIdentity()">Save Identity</button>
          </div>
          <div class="quick-notes-meta">
            <span id="futureIdentityText">Youâ€™re building Future You.</span>
          </div>
        </div>

        <div class="focus-card">
          <h3>Mental Energy Tracker</h3>
          <p style="font-size: 0.9rem; color: var(--text-muted);">Rate your energy before a session. We learn your peak hours.</p>
          <div class="energy-scale" id="energyScale">
            <button class="btn btn-secondary" onclick="logEnergy(1)">1</button>
            <button class="btn btn-secondary" onclick="logEnergy(2)">2</button>
            <button class="btn btn-secondary" onclick="logEnergy(3)">3</button>
            <button class="btn btn-secondary" onclick="logEnergy(4)">4</button>
            <button class="btn btn-secondary" onclick="logEnergy(5)">5</button>
          </div>
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label for="hardestSubjectInput">Hardest subject</label>
            <input type="text" id="hardestSubjectInput" placeholder="e.g., Chemistry">
          </div>
          <div class="quick-notes-meta">
            <span id="energyInsight">Log your energy to see peak hours.</span>
          </div>
        </div>

        <div class="focus-card">
          <h3>Study Ritual Builder</h3>
          <p style="font-size: 0.9rem; color: var(--text-muted);">Build a repeatable focus routine.</p>
          <div class="ritual-list">
            <label class="ritual-item"><input type="checkbox" id="ritualSound"> Play focus sound</label>
            <label class="ritual-item"><input type="checkbox" id="ritualWater"> Drink water</label>
            <label class="ritual-item"><input type="checkbox" id="ritualStretch"> Quick stretch</label>
            <label class="ritual-item"><input type="checkbox" id="ritualDesk"> Clear desk checklist</label>
          </div>
          <div class="focus-actions" style="margin-top: var(--spacing-md);">
            <button class="btn btn-primary" onclick="completeRitual()">Start Ritual</button>
            <button class="btn btn-secondary" onclick="resetRitual()">Reset</button>
          </div>
          <div class="quick-notes-meta">
            <span id="ritualStatus">Ritual not started</span>
          </div>
        </div>

        <div class="focus-card">
          <h3>Visual Growth Tree</h3>
          <div class="focus-tree" id="growthTree">ðŸŒ±</div>
          <div class="quick-notes-meta">
            <span id="growthTreeStatus">Grow your tree by completing Learn By Teaching.</span>
          </div>
        </div>

        <div class="focus-card">
              <h3>Distraction Blocker Mode</h3>
              <p style="font-size: 0.9rem; color: var(--text-muted);">
                Lock the dashboard to focus-only tools. Emergency unlock takes 60 seconds.
              </p>
              <div class="focus-actions">
                <button class="btn btn-success" onclick="toggleDistractionBlocker()" id="blockerToggleBtn">Enable Blocker</button>
              </div>
              <div class="form-group" style="margin-top: var(--spacing-md);">
                <label for="blockedSitesInput">Blocked list (reminder)</label>
                <input type="text" id="blockedSitesInput" placeholder="instagram.com, youtube.com, tiktok.com">
              </div>
              <div class="blocker-list" id="blockedSitesList"></div>
        </div>

        <div class="focus-card">
              <h3>Study Sound Environment</h3>
              <div class="sound-grid">
                <button class="sound-chip" onclick="startFocusSound('brown')">Brown Noise</button>
                <button class="sound-chip" onclick="startFocusSound('rain')">Rain</button>
                <button class="sound-chip" onclick="startFocusSound('library')">Library Ambience</button>
                <button class="sound-chip" onclick="startFocusSound('music')">Instrumental Focus</button>
              </div>
              <div class="form-group" style="margin-top: var(--spacing-md);">
                <label for="soundVolume">Volume</label>
                <input type="range" id="soundVolume" min="0" max="100" value="35">
              </div>
              <button class="btn btn-secondary" onclick="stopFocusSound()">Stop Sound</button>
        </div>

        <div class="focus-card">
              <h3>Brain Dump</h3>
              <div class="form-group">
                <label for="brainDumpInput">Capture distracting thoughts</label>
                <input type="text" id="brainDumpInput" placeholder="Add a thought and press Enter">
              </div>
              <div class="focus-actions">
                <button class="btn btn-primary" onclick="addBrainDumpItem()">Add</button>
                <button class="btn btn-warning" onclick="clearBrainDump()">Clear All</button>
              </div>
              <div class="brain-dump-list" id="brainDumpList"></div>
        </div>
      </div>
    </section>
    
    <!-- Dashboard Header -->
    <div class="dashboard-header" id="dashboardHeader">
      <h1>Welcome to Your Learning Dashboard</h1>
      <p class="time-greeting" id="timeGreeting"></p>
      <p class="dashboard-subtitle" id="dashboardSubtitle">Track your progress, manage tasks, and achieve your study goals</p>
      
      <!-- UPDATED: Compact Controls Bar -->
      <div class="controls-bar">
        <button class="btn btn-success" onclick="window.location.href='index.html'">
          Home
        </button>
        <button class="btn btn-success" onclick="showSection('myclasses')">ðŸŽ“ Manage Classes</button>
        <button class="btn btn-secondary focus-toggle" id="focusModeBtn" onclick="toggleFocusMode()">Focus Portal</button>
        <button class="btn btn-secondary" onclick="refreshData()">ðŸ”„ Refresh</button>
        <button class="btn btn-warning" onclick="exportData()">ðŸ“¤ Export Data</button>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Sync Status -->
    <div id="syncStatus" class="sync-status" style="display: none;">
      <span class="sync-icon"></span>
      <span class="sync-text"></span>
    </div>
    
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      
      <!-- Dashboard Section -->
      <div id="dashboard" class="dashboard-content" style="grid-column: span 12; display: block;">
        
        <!-- Pro Tip - Matching Teacher Mode Style -->
        <div class="pro-tip">
          <strong>ðŸ’¡ Daily Habit Building</strong>
          Mark your study streak daily! Consistency beats intensity. Even 15 minutes of focused study each day builds a strong habit and improves retention by 60% compared to cramming.
        </div>

        <!-- UPDATED: Compact Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">ðŸ”¥</div>
            <div class="stat-content">
              <div class="stat-number" id="streakDisplay">0</div>
              <div class="stat-label">Study Streak</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">â°</div>
            <div class="stat-content">
              <div class="stat-number" id="totalHoursDisplay">0</div>
              <div class="stat-label">Study Hours</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
              <div class="stat-number" id="tasksCompletedDisplay">0</div>
              <div class="stat-label">Tasks Done</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ðŸŽ¯</div>
            <div class="stat-content">
              <div class="stat-number" id="focusScoreDisplay">0%</div>
              <div class="stat-label">Focus Score</div>
            </div>
          </div>
        </div>

        <!-- Quick Notes -->
        <div class="content-card quick-notes-card" style="margin-top: var(--spacing-xl);">
          <div class="content-header">
            <h2>Quick Notes</h2>
            <div class="quick-notes-actions">
              <button class="btn btn-secondary" onclick="copyQuickNotes()">Copy</button>
              <button class="btn btn-warning" onclick="clearQuickNotes()">Clear</button>
            </div>
          </div>
          <div class="content-body">
            <textarea id="quickNotesInput" placeholder="Capture ideas, reminders, or homework steps. Autosaves locally."></textarea>
            <div class="quick-notes-meta">
              <span id="quickNotesStatus">Saved</span>
              <span>Shortcut: Shift+N to focus</span>
            </div>
          </div>
        </div>

        <!-- Study Stats Compare -->
        <div class="content-card" style="margin-top: var(--spacing-xl);">
          <div class="content-header">
            <h2>Study Stats Compare</h2>
          </div>
          <div class="content-body profile-content-body">
            <div class="pro-tip" id="compareMsg1">You studied 20% more than average.</div>
            <div class="pro-tip" id="compareMsg2">Top 10% of users this week.</div>
          </div>
        </div>

        <!-- Learn By Teaching Mode -->
        <div class="content-card" style="margin-top: var(--spacing-xl);">
          <div class="content-header">
            <h2>ðŸ§© Learn By Teaching</h2>
          </div>
          <div class="content-body">
            <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
              Explain the topic in 60 seconds or write 5 bullet points. If you canâ€™t explain it, you donâ€™t understand it.
            </p>
            <div class="form-group">
              <label for="teachTopicInput">Topic</label>
              <input type="text" id="teachTopicInput" placeholder="e.g., Photosynthesis">
            </div>
            <div class="form-group">
              <label>5 Bullet Points</label>
              <div class="teach-bullets">
                <input type="text" id="teachBullet1" placeholder="Bullet 1">
                <input type="text" id="teachBullet2" placeholder="Bullet 2">
                <input type="text" id="teachBullet3" placeholder="Bullet 3">
                <input type="text" id="teachBullet4" placeholder="Bullet 4">
                <input type="text" id="teachBullet5" placeholder="Bullet 5">
              </div>
            </div>
            <div class="form-group">
              <label>60-second Voice Summary (optional)</label>
              <div class="focus-actions">
                <button class="btn btn-secondary" id="teachRecordBtn" onclick="toggleTeachRecording()">Start Recording</button>
                <span id="teachRecordStatus">Not recording</span>
              </div>
              <audio id="teachPlayback" controls style="width: 100%; margin-top: var(--spacing-sm); display: none;"></audio>
            </div>
            <div class="focus-actions">
              <button class="btn btn-success" onclick="completeTeachMode()">I Explained It</button>
            </div>
            <div class="quick-notes-meta">
              <span id="teachModeStatus">Tree grows when you complete this.</span>
            </div>
          </div>
        </div>

        <!-- Daily Challenge -->
        <div class="content-card" id="dailyChallengeCard" style="margin-top: var(--spacing-xl); display: none;">
          <div class="content-header">
            <h2>ðŸ… Daily Challenge</h2>
          </div>
          <div class="content-body">
            <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
              <strong>Tip:</strong> Complete one small challenge each day to build momentum.
            </div>
            <div id="dailyChallengeText" style="font-weight: 700; margin-bottom: var(--spacing-md);"></div>
            <button class="btn btn-success" id="dailyChallengeDoneBtn" onclick="completeDailyChallenge()">âœ… I am done</button>
          </div>
        </div>
        
        <!-- Achievement Badges -->
        <div class="content-card badges-card" style="margin-top: var(--spacing-xl);">
          <div class="content-header">
            <h2>Achievement Badges</h2>
            <span class="badge" id="badgeCount" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0/6</span>
          </div>
          <div class="content-body">
            <div class="badges-grid" id="badgesGrid"></div>
            <div id="badgesEmpty" class="empty-state" style="display: none;">
              <div class="empty-state-icon">â˜…</div>
              <div class="empty-state-title">No badges yet</div>
              <div class="empty-state-description">Start studying to unlock your first badge.</div>
            </div>
          </div>
        </div>

        <!-- Main Content Area -->
        <div class="dashboard-grid" style="margin-top: var(--spacing-xl);">
          
          <!-- Left Column: Forms & Motivation -->
          <div class="forms-section">
            <!-- Profile Form -->
            <div class="form-card">
              <h2>ðŸ‘¤ My Profile</h2>
              <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                <strong>Tip:</strong> Complete your profile to personalize your learning experience and track progress accurately.
              </div>
              <div class="form-group">
                <label for="studentName">Your Name</label>
                <input type="text" id="studentName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="studentEmail">Email (Optional)</label>
                <input type="email" id="studentEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="studentBio">Bio</label>
                <textarea id="studentBio" placeholder="Tell us about yourself..." rows="3"></textarea>
              </div>
              <button class="btn-submit" onclick="saveProfile()">
                ðŸ’¾ Save Profile
              </button>
            </div>
            
            <!-- IMPROVED Streak Card -->
            <div class="form-card streak-card">
              <h2 style="color: white; position: relative; z-index: 1;">ðŸ”¥ Daily Study Streak</h2>
              <div class="streak-number" id="streakNumber">0</div>
              <div class="streak-label" id="streakLabel">DAY STREAK</div>
              
              <!-- Streak Milestones -->
              <div class="streak-milestones" id="streakMilestones">
                <!-- Milestones will be added by JavaScript -->
              </div>
              
              <!-- Streak Progress -->
              <div class="streak-progress">
                <div class="streak-progress-fill" id="streakProgressFill" style="width: 0%"></div>
              </div>
              
              <button class="streak-btn" id="streakButton" onclick="markStudyToday()">
                <span>ðŸ”¥ Mark Study Today</span>
              </button>
              <div id="streakMessage" style="margin-top: var(--spacing-md); font-weight: 600; min-height: 24px; position: relative; z-index: 1;"></div>
              <div id="streakInfo" style="margin-top: var(--spacing-sm); font-size: 0.875rem; opacity: 0.8; position: relative; z-index: 1;">
                Last studied: <span id="lastStudyDate">Never</span>
              </div>
              <div id="streakReward" style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7; position: relative; z-index: 1;">
                Next milestone: <span id="nextMilestone">7 days</span>
              </div>
             <!-- Streak Share (no file chooser) -->
<div id="streakShare" class="streak-share">
  <button id="shareStreakBtn" class="streak-btn">ðŸ“¤ Share Streak</button>
  <div id="streakShareMsg" class="streak-share-msg"></div>
 
</div>

            </div>
           <!-- Daily Goal Tracker Card -->
<div class="form-card goal-card">
  <h2>ðŸŽ¯ Daily Goal Tracker</h2>
  <div class="goal-text">Today's goal: <span id="dailyGoalText">3</span> study sessions</div>

  <div class="goal-progress">
    <div class="goal-progress-fill" id="dailyGoalFill" style="width: 0%"></div>
  </div>

  <div class="goal-stats">
    <span id="dailyGoalCount">0</span> / <span id="dailyGoalTarget">3</span> sessions
  </div>

  <div id="dailyGoalMessage" class="goal-message"></div>
  <button id="celebrateGoalBtn" class="celebrate-btn" style="display: none;" onclick="triggerConfettiBurst()">
    ðŸŽ‰ Celebrate
  </button>
  <div class="goal-input">
  <label for="dailyGoalInput">Set daily goal</label>
  <input type="number" id="dailyGoalInput" min="1" max="20" step="1" value="3">
</div>

</div>
            <!-- Motivation Card -->
            <div class="form-card motivation-card">
              <h2 style="color: white; position: relative; z-index: 1;">ðŸ’« Daily Inspiration</h2>
              <div class="quote-text" id="dailyQuote">"The only way to do great work is to love what you do."</div>
              <div class="quote-author" id="quoteAuthor">â€” Steve Jobs</div>
              <button class="btn" onclick="newQuote()" style="margin-top: var(--spacing-lg); background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; width: 100%; position: relative; z-index: 1;">
                ðŸ”„ New Inspiration
              </button>
            </div>
          </div>
          
          <!-- Right Column: Tasks & Assignments -->
          <div class="content-section">
            <!-- Tasks Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>ðŸ“ My Tasks</h2>
                <button class="btn btn-primary" onclick="showSection('tasks')">View All</button>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Break large tasks into smaller, manageable chunks. This reduces overwhelm and increases completion rates by 40%.
                </div>

                <div class="task-input-container" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                  <input type="text" id="taskInput" placeholder="Add a new task..." style="flex: 1; min-width: 0;">
                  <button class="btn btn-success" onclick="addTask()">âž• Add</button>
                </div>
                <!-- Add this AFTER the task input container in the Dashboard section -->
<div class="priority-selector" style="margin-bottom: var(--spacing-md);">
    <div class="priority-option active" data-priority="urgent" onclick="selectPriority('urgent')">
        ðŸ”´ Urgent
    </div>
    <div class="priority-option" data-priority="not-urgent" onclick="selectPriority('not-urgent')">
        ðŸŸ¡ Not Urgent
    </div>
    <div class="priority-option" data-priority="optional" onclick="selectPriority('optional')">
        âšª Optional
    </div>
</div>
                <ul class="task-list" id="taskList">
                  <!-- Tasks will appear here -->
                </ul>
              </div>
            </div>
            
            <!-- Assignments Card -->
            <div class="content-card">
              <div class="content-header">
                <h2>ðŸ“š My Assignments</h2>
                <button class="btn btn-primary" onclick="showSection('assignments')">View All</button>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Start assignments early! Students who begin assignments 3 days before the due date score 15% higher on average.
                </div>
                <div class="assignment-list" id="assignmentList">
                  <!-- Assignments will appear here -->
                </div>
              </div>
            </div>
            
            <!-- Study Hours Input -->
            <div class="content-card">
              <div class="content-header">
                <h2>â° Add Study Hours</h2>
              </div>
              <div class="content-body">
                <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                  <strong>Tip:</strong> Use the Pomodoro Technique: 25 minutes of focused study followed by a 5-minute break improves concentration and retention.
                </div>
                <div class="form-group">
                  <label for="hoursInput">Study Hours (e.g., 2.5)</label>
                  <input type="number" id="hoursInput" placeholder="Enter study hours" step="0.25" min="0.25" max="12">
                </div>
                <button class="btn-submit" onclick="addStudyHours()">
                  â° Add Hours
                </button>
                <div style="font-size: 0.875rem; color: var(--text-muted); text-align: center; margin-top: var(--spacing-md);">
                  Track your study sessions to see your progress!
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Footer with Copyright -->
        <div class="footer">
          <p>Â© 2024 Student Learning Dashboard. All rights reserved. Made with â¤ï¸ for students everywhere.</p>
          <p style="margin-top: var(--spacing-sm); font-size: 0.75rem; opacity: 0.7;">
            Education is the most powerful weapon which you can use to change the world. â€” Nelson Mandela
          </p>
        </div>
      </div>
      
      <!-- Tasks Section -->
      <div id="tasks" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ“ Task Manager</h2>
            <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
              <button class="btn btn-secondary" onclick="filterTasks('all')">All</button>
              <button class="btn btn-secondary" onclick="filterTasks('urgent')">Urgent</button>
              <button class="btn btn-secondary" onclick="filterTasks('not-urgent')">Not Urgent</button>
              <button class="btn btn-secondary" onclick="filterTasks('optional')">Optional</button>
              <button class="btn btn-secondary" onclick="filterTasks('active')">Active</button>
              <button class="btn btn-secondary" onclick="filterTasks('completed')">Completed</button>
            </div>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>ðŸ’¡ Task Management Strategy</strong>
              Prioritize tasks using the Eisenhower Matrix: Urgent & Important (do first), Important but Not Urgent (schedule), Urgent but Not Important (delegate if possible), Neither (eliminate).
            </div>
            
            <!-- Simplified - tasks are already added from dashboard -->
<div style="text-align: center; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
    <p style="margin-bottom: var(--spacing-md);">Tasks are added from the Dashboard section above.</p>
    <button class="btn btn-primary" onclick="showSection('dashboard')">
        â† Back to Dashboard to Add Tasks
    </button>
</div>
            
            <div class="task-filters" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xl); flex-wrap: wrap;">
              <button class="btn btn-warning" onclick="clearCompletedTasks()">Clear Completed</button>
              <button class="btn btn-secondary" onclick="exportTasks()">Export Tasks</button>
            </div>
            
            <ul class="task-list" id="fullTaskList">
              <!-- Full task list will appear here -->
            </ul>
            
            <div class="task-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-lg); margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <div class="stat-display">
                <div class="number" id="totalTasks">0</div>
                <div class="label">Total Tasks</div>
              </div>
              <div class="stat-display">
                <div class="number" id="pendingTasks">0</div>
                <div class="label">Pending</div>
              </div>
              <div class="stat-display">
                <div class="number" id="completedTasks">0</div>
                <div class="label">Completed</div>
              </div>
              <div class="stat-display">
                <div class="number" id="completionRate">0%</div>
                <div class="label">Completion Rate</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Store Section -->
<div id="moveStore" class="dashboard-content" style="display: none;">
    <div class="store-section">
        <div class="section-header">
            <div class="section-title">
                <span>ðŸª</span>
                <span>MOVE SHOP</span>
            </div>
            <div class="xp-display" id="storeXpDisplay">
                âœ¨ <span id="storeXpAmount">0</span> XP
            </div>
        </div>
        
        <div class="moves-grid" id="storeMovesGrid"></div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="showSection('dashboard')">BACK TO DASHBOARD</button>
        </div>
    </div>
</div>

<!-- My Moves Section -->
<div id="myMoves" class="dashboard-content" style="display: none;">
    <div class="store-section">
        <div class="section-header">
            <div class="section-title">
                <span>ðŸŽ®</span>
                <span>MY MOVES</span>
            </div>
            <div class="xp-display" id="movesXpDisplay">
                âœ¨ <span id="movesXpAmount">0</span> XP
            </div>
        </div>
        
        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 15px;">
            <p style="color: var(--text-muted);">Equip up to 4 moves to use in battle. Click EQUIP to add to your loadout.</p>
        </div>
        
        <div class="moves-grid" id="myMovesGrid"></div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="showSection('dashboard')">BACK TO DASHBOARD</button>
        </div>
    </div>
</div>


<!-- Battle Game View (Will be populated dynamically) -->
<div id="battleGameView" class="dashboard-content" style="display: none;"></div>
<!-- Battle Section -->
<div id="battle" class="dashboard-content" style="display: none;">
    <div class="battle-container">
        <!-- Main Menu -->
        <div id="battleMainMenu">
            <div class="battle-header">
                <div class="battle-title">âš¡ BATTLE ARENA âš¡</div>
                <div class="battle-stats">
                    <div class="battle-stat">
                        <div class="label">MANA</div>
                        <div class="value" id="battleManaDisplay">50</div>
                    </div>
                    <div class="battle-stat">
                        <div class="label">LEVEL</div>
                        <div class="value" id="battleLevelDisplay">1</div>
                    </div>
                    <div class="battle-stat">
                        <div class="label">STREAK</div>
                        <div class="value" id="battleStreakDisplay">0</div>
                    </div>
                </div>
            </div>
            
            <div class="battle-grid">
                <!-- Create Battle Card -->
                <div class="battle-card create" onclick="showBattleCode('create')">
                    <div class="battle-icon">âš”ï¸</div>
                    <div class="battle-card-title">CREATE</div>
                    <div class="battle-card-desc">Generate a code and invite a friend</div>
                    <div class="battle-cost">COST: 20 MANA</div>
                </div>
                
                <!-- Join Battle Card -->
                <div class="battle-card join" onclick="showBattleCode('join')">
                    <div class="battle-icon">ðŸ¤</div>
                    <div class="battle-card-title">JOIN</div>
                    <div class="battle-card-desc">Enter a friend's code</div>
                    <div class="battle-cost">FREE</div>
                </div>
            </div>
            
            <!-- Quick Stats for Battle -->
            <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div style="background: var(--card); border: 2px solid #fbbf24; border-radius: 15px; padding: 15px; text-align: center;">
                    <div style="font-size: 2rem; color: #fbbf24;">âš”ï¸</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">BATTLES WON</div>
                    <div style="font-size: 1.5rem; font-weight: 800; color: #fbbf24;" id="battleWinsDisplay">0</div>
                </div>
                <div style="background: var(--card); border: 2px solid #fbbf24; border-radius: 15px; padding: 15px; text-align: center;">
                    <div style="font-size: 2rem; color: #fbbf24;">ðŸ†</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">ACHIEVEMENTS</div>
                    <div style="font-size: 1.5rem; font-weight: 800; color: #fbbf24;" id="battleAchievementsDisplay">0</div>
                </div>
                <div style="background: var(--card); border: 2px solid #fbbf24; border-radius: 15px; padding: 15px; text-align: center;">
                    <div style="font-size: 2rem; color: #fbbf24;">ðŸŽ²</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">DICE ROLLS</div>
                    <div style="font-size: 1.5rem; font-weight: 800; color: #fbbf24;" id="battleDiceDisplay">0</div>
                </div>
            </div>
        </div>
        
        <!-- Code View (Create/Join) -->
        <div id="battleCodeView" style="display: none;">
            <button class="battle-btn secondary" onclick="backToBattleMenu()" style="margin-bottom: 20px;">â† BACK</button>
            
            <!-- Create Battle -->
            <div id="battleCreateView" style="display: none;">
                <div class="battle-code-section">
                    <h2 style="color: #fbbf24; margin-bottom: 20px;">YOUR BATTLE CODE</h2>
                    <div class="battle-code-display" id="generatedBattleCode">------</div>
                    <button class="battle-btn" onclick="copyBattleCode()">ðŸ“‹ COPY</button>
                    <button class="battle-btn" onclick="waitForOpponent()" id="waitForOpponentBtn">WAIT FOR OPPONENT</button>
                </div>
            </div>
            
            <!-- Join Battle -->
            <div id="battleJoinView" style="display: none;">
                <div class="battle-code-section">
                    <h2 style="color: #fbbf24; margin-bottom: 20px;">ENTER CODE</h2>
                    <input type="text" class="battle-code-input" id="joinBattleCode" placeholder="------" maxlength="6">
                    <button class="battle-btn" onclick="joinBattle()">JOIN BATTLE</button>
                    <div id="battleJoinError" class="battle-error"></div>
                </div>
            </div>
        </div>
        
        <!-- Waiting Room -->
        <div id="battleWaitingRoom" style="display: none;">
            <div class="battle-code-section waiting-room">
                <h2 style="color: #fbbf24; margin-bottom: 30px;">WAITING FOR OPPONENT</h2>
                
                <div class="waiting-players">
                    <div class="waiting-player">
                        <div class="waiting-avatar" id="player1Avatar">ðŸ‘¤</div>
                        <div style="color: white; margin-top: 10px;" id="player1Name">You</div>
                        <div style="color: #10b981; font-size: 0.8rem; margin-top: 5px;">âœ… READY</div>
                    </div>
                    
                    <div class="waiting-vs">VS</div>
                    
                    <div class="waiting-player">
                        <div class="waiting-avatar" id="player2Avatar">â“</div>
                        <div style="color: white; margin-top: 10px;" id="player2Name">Waiting...</div>
                        <div style="color: #fbbf24; font-size: 0.8rem; margin-top: 5px;" id="player2Status">â³ JOINING</div>
                    </div>
                </div>
                
                <div class="waiting-status" id="waitingStatus">Looking for opponent...</div>
                
                <button class="battle-btn danger" onclick="cancelBattle()" style="margin-top: 30px;">CANCEL</button>
            </div>
        </div>
        
        <!-- Battle Active View (Redirect) -->
        <div id="battleActiveView" style="display: none;">
            <div class="battle-code-section">
                <div class="battle-loading" style="margin: 30px auto;"></div>
                <h2 style="color: #fbbf24; margin-bottom: 20px;">OPPONENT FOUND!</h2>
                <p style="color: white; margin-bottom: 20px;">Redirecting to battle arena...</p>
                <div style="font-size: 2rem; color: #fbbf24; animation: vsPulse 1s infinite;">âš”ï¸</div>
            </div>
        </div>
    </div>
</div>

      <!-- Assignments Section -->
      <div id="assignments" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ“š Assignment Tracker</h2>
            <button class="btn btn-primary" onclick="showAssignmentForm()">âž• Add Assignment</button>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ Assignment Strategy</strong>
              Use backward planning: Start from the due date and work backwards, scheduling research, drafting, editing, and final review stages. This prevents last-minute rushing and improves quality.
            </div>
            
            <!-- Assignment Form -->
            <div id="assignmentForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <div class="form-group">
                  <label for="assignmentName">Assignment Name</label>
                  <input type="text" id="assignmentName" placeholder="Math Chapter 5">
                </div>
                <div class="form-group">
                  <label for="assignmentSubject">Subject</label>
                  <input type="text" id="assignmentSubject" placeholder="Mathematics">
                </div>
                <div class="form-group">
                  <label for="assignmentDueDate">Due Date</label>
                  <input type="date" id="assignmentDueDate">
                </div>
              </div>
              <div class="form-group">
                <label for="assignmentDescription">Description (Optional)</label>
                <textarea id="assignmentDescription" placeholder="Assignment details, requirements, notes..." rows="3"></textarea>
              </div>
              <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <button class="btn btn-success" onclick="addAssignment()" style="flex: 1;">âž• Add Assignment</button>
                <button class="btn btn-secondary" onclick="hideAssignmentForm()">Cancel</button>
              </div>
            </div>
            
            <div class="assignment-list" id="fullAssignmentList">
              <!-- Full assignment list will appear here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Exit Ticket Section -->
      <div id="exitTicket" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>Exit Ticket</h2>
            <button class="btn btn-secondary" onclick="renderExitTicketStudentSection()">Refresh</button>
          </div>
          <div class="content-body">
            <div class="pro-tip">
              <strong>Exit Ticket</strong>
              Answer these quick questions to help your teacher see what landed today.
            </div>
            <div class="form-card" style="margin-top: var(--spacing-md);">
              <h3>Questions</h3>
              <div id="exitTicketStudentQuestions">Loading questions...</div>
            </div>
            <div class="form-card" id="exitTicketFormCard" style="margin-top: var(--spacing-md);">
              <h3>Your Responses</h3>
              <div class="form-group">
                <label for="exitTicketAnswer1">Answer 1</label>
                <textarea id="exitTicketAnswer1" rows="3" placeholder="Your response..."></textarea>
              </div>
              <div class="form-group">
                <label for="exitTicketAnswer2">Answer 2</label>
                <textarea id="exitTicketAnswer2" rows="3" placeholder="Your response..."></textarea>
              </div>
              <div class="form-group">
                <label for="exitTicketAnswer3">Answer 3</label>
                <textarea id="exitTicketAnswer3" rows="3" placeholder="Your response..."></textarea>
              </div>
              <button class="btn btn-primary" onclick="submitExitTicketStudent()">Submit Exit Ticket</button>
              <div id="exitTicketStudentStatus" style="margin-top: var(--spacing-sm); font-size: 0.9rem;"></div>
            </div>
            <div id="exitTicketThankYou" class="form-card" style="margin-top: var(--spacing-md); display: none;">
              <h3>Thank You</h3>
              <p>Your response has been submitted.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Classroom Section -->



      <!-- Student Memory Wall Section -->
<div id="studentMemoryWall" class="dashboard-content" style="grid-column: span 12; display: none;">
    <div class="content-card" style="padding: 0; overflow: hidden;">
        <div class="content-header" style="border-bottom: 1px solid var(--border);">
            <h2>ðŸ“ Class Memory Wall</h2>
            <button class="btn btn-primary" onclick="showStudentAddMemoryPage()">
                âœ¨ Add Memory
            </button>
        </div>
        
        <div class="content-body" style="padding: 0;">
            <div class="pro-tip" style="margin: var(--spacing-md);">
                <strong>ðŸŽ¨ Interactive Memory Wall</strong>
                See what your classmates have shared! Add your own memories, achievements, or encouraging words.
            </div>
            
            <!-- Whiteboard Container -->
            <div id="studentMemoryWhiteboard" class="memory-whiteboard">
                <!-- Background grid pattern -->
                <div class="whiteboard-background"></div>
                
                <!-- Sticky notes container -->
                <div id="studentStickyNotesContainer" class="sticky-notes-container"></div>
            </div>
            
            <!-- Memory Wall Stats -->
            <div style="padding: var(--spacing-lg); background: var(--card); border-top: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4>ðŸ“Š Wall Stats</h4>
                        <div style="display: flex; gap: var(--spacing-lg); margin-top: var(--spacing-sm);">
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="studentTotalNotesCount">0</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Total Notes</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="studentTotalLikesCount">0</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Total Likes</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="studentNotesCount">0</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Your Notes</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="refreshStudentMemoryWall()">
                            âŸ³ Refresh Wall
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



      <div id="classroom" class="dashboard-content" style="grid-column: span 12; display: none;">
        <!-- Not in Class View -->
        <div id="notInClassView" class="content-card" style="text-align: center; padding: var(--spacing-2xl);">
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ«</div>
            <div class="empty-state-title">Not in a Classroom</div>
            <div class="empty-state-description" style="margin-bottom: var(--spacing-lg);">
              Join your teacher's classroom to access announcements, resources, and track your progress together.
            </div>
            <div class="pro-tip" style="margin: var(--spacing-lg) 0; max-width: 500px;">
              <strong>ðŸ’¡ Why Join a Classroom?</strong>
              Classrooms provide structure, access to teacher resources, peer motivation through leaderboards, and organized announcements. Students in classrooms show 30% higher engagement.
            </div>
            <button class="btn btn-primary" onclick="showSection('myclasses')" style="padding: 1rem 2rem; font-size: 1.125rem;">
              ðŸŽ“ Join a Classroom
            </button>
            <p style="margin-top: var(--spacing-lg); color: var(--text-muted);">
              Ask your teacher for the class code!
            </p>
          </div>
        </div>
        
        <!-- In Class View -->
        <div id="inClassView" style="display: none;">
          <!-- Class Header -->
          <div class="content-card">
            <div class="class-code-display">
              <div style="font-size: 1rem; opacity: 0.9; letter-spacing: 1px; position: relative; z-index: 1;">CLASS CODE</div>
              <div class="code" id="currentClassCode">LOADING...</div>
              <div style="display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-lg); flex-wrap: wrap; position: relative; z-index: 1;">
                <button class="btn btn-secondary" onclick="copyClassCode()">ðŸ“‹ Copy Code</button>
                <button class="btn btn-danger" onclick="leaveClass()">ðŸšª Leave Class</button>
                <button class="btn btn-success" onclick="refreshClassroom()">ðŸ”„ Refresh</button>
              </div>
            </div>
          </div>
          
          <!-- Pro Tip -->
          <div class="pro-tip">
            <strong>ðŸ’¡ Active Classroom Participation</strong>
            Regularly check announcements and resources. Engage with the leaderboard - healthy competition increases motivation. Students who actively participate in classrooms complete 40% more assignments.
          </div>
          
          <!-- Announcements -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ“¢ Teacher's Announcements</h2>
              <span class="badge" id="announcementCount" style="background: var(--accent); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherAnnouncements" style="min-height: 200px;">
                <div class="loading">Loading announcements...</div>
              </div>
            </div>
          </div>
          
          <!-- Resources -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ“š Learning Resources</h2>
              <span class="badge" id="resourceCount" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherResources" style="min-height: 200px;">
                <div class="loading">Loading resources...</div>
              </div>
            </div>
          </div>
          
          <!-- Class Polls -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ—³ï¸ Class Polls</h2>
              <span class="badge" id="pollCount" style="background: var(--warning); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem;">0</span>
            </div>
            <div class="content-body">
              <div id="teacherPolls" style="min-height: 200px;">
                <div class="loading">Loading polls...</div>
              </div>
            </div>
          </div>





         





          


          <!-- Engagement Heatmap (Aggregate) -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ“Š Engagement Heatmap</h2>
            </div>
            <div class="content-body">
              <div class="pro-tip" style="margin: 0 0 var(--spacing-lg) 0;">
                <strong>ðŸ’¡ Aggregate Insight</strong>
                Shows when the class studies most (no individual data).
              </div>
              <div id="aggregateHeatmap" class="aggregate-heatmap"></div>
              <div id="aggregateInsight" class="aggregate-heatmap-insight"></div>
            </div>
          </div>
          
          <!-- Leaderboard -->
          <div class="content-card">
            <div class="content-header">
              <h2>ðŸ† Class Leaderboard</h2>
              <button class="btn btn-secondary" onclick="refreshLeaderboard()">ðŸ”„ Refresh</button>
            </div>
            <div class="content-body">
              <div class="leaderboard-container" id="classLeaderboard">
                <div class="loading">Loading leaderboard...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      

       <!-- Student Mode: Add Memory Page -->
<div id="studentAddMemoryPage" class="dashboard-content" style="display: none;">
    <div class="content-card">
        <div class="content-header" style="border-bottom: 1px solid var(--border);">
            <h2>âœ¨ Add to Memory Wall</h2>
            <button class="btn btn-secondary" onclick="studentBackToMemoryWall()">
                â† Back to Memory Wall
            </button>
        </div>
        
        <div class="content-body">
            <div class="pro-tip" style="margin-bottom: var(--spacing-xl);">
                <strong>ðŸŽ¨ Share with Your Class</strong>
                Add a memory, achievement, or encouraging word. Your note will appear on the class wall for everyone to see!
            </div>
            
            <div style="max-width: 600px; margin: 0 auto;">
                <!-- Message Input -->
                <div class="form-group" style="margin-bottom: var(--spacing-lg);">
                    <label for="studentAddMemoryText" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                        Your Message
                    </label>
                    <textarea id="studentAddMemoryText" 
                              placeholder="What I learned this week...&#10;Something I'm proud of...&#10;Encouraging word for classmates..."
                              rows="5"
                              maxlength="300"
                              style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); resize: vertical; font-family: 'Comic Sans MS', 'Chalkboard SE', cursive; font-size: 16px;"></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: var(--spacing-xs);">
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            ðŸ’¡ Be positive and encouraging!
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                            <span id="studentAddMemoryCharCount">0</span>/300 characters
                        </div>
                    </div>
                </div>
                
                <!-- Name and Color -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentAddMemoryAuthor" style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Your Name
                        </label>
                        <input type="text" id="studentAddMemoryAuthor" 
                               placeholder="Your name"
                               style="width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text); font-size: 16px;"
                               value="Student">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                            Note Color
                        </label>
                        <div class="color-picker">
                            <div class="color-option selected" data-color="#FFEB3B" onclick="studentSelectAddMemoryColor('#FFEB3B')" style="background: #FFEB3B;"></div>
                            <div class="color-option" data-color="#C8E6C9" onclick="studentSelectAddMemoryColor('#C8E6C9')" style="background: #C8E6C9;"></div>
                            <div class="color-option" data-color="#BBDEFB" onclick="studentSelectAddMemoryColor('#BBDEFB')" style="background: #BBDEFB;"></div>
                            <div class="color-option" data-color="#E1BEE7" onclick="studentSelectAddMemoryColor('#E1BEE7')" style="background: #E1BEE7;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Preview -->
                <div class="form-group" style="margin-bottom: var(--spacing-xl);">
                    <label style="display: block; margin-bottom: var(--spacing-sm); font-weight: 600; color: var(--text);">
                        Preview
                    </label>
                    <div id="studentAddMemoryPreview" class="sticky-note-preview" style="background: #FFEB3B; min-height: 120px;">
                        <div class="preview-content">
                            <div class="preview-text" id="studentAddMemoryPreviewText">
                                Your memory will appear here...
                            </div>
                            <div class="preview-meta">
                                <span class="preview-author" id="studentAddMemoryPreviewAuthor">Student</span>
                                <span style="margin-left: 8px;">ðŸ‘¨â€ðŸŽ“</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--spacing-md);">
                    <button class="btn btn-secondary" onclick="studentBackToMemoryWall()" style="flex: 1;">
                        â† Cancel
                    </button>
                    <button class="btn btn-success" onclick="studentSubmitMemory()" style="flex: 2; padding: var(--spacing-lg);">
                        ðŸ“Œ Add to Memory Wall
                    </button>
                </div>
                
                <!-- Examples -->
                <div style="margin-top: var(--spacing-xl); padding: var(--spacing-lg); background: var(--accent-light); border-radius: var(--radius);">
                    <h4 style="margin-bottom: var(--spacing-md); color: var(--accent);">ðŸ’¡ Need ideas?</h4>
                    <ul style="margin-left: var(--spacing-lg); line-height: 1.8;">
                        <li>"I finally understand how to solve equations!"</li>
                        <li>"Great work everyone on the group project!"</li>
                        <li>"The science experiment today was amazing!"</li>
                        <li>"You can do it! Keep studying!"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
      <!-- My Classes Section -->
      <div id="myclasses" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸŽ“ My Classes</h2>
            <button class="btn btn-primary" onclick="showJoinClassForm()">âž• Join Class</button>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ Multiple Classes Strategy</strong>
              Join relevant classes for different subjects. Organize your study time by dedicating specific days to each class. Students in 2-3 balanced classes show the best performance outcomes.
            </div>
            
            <!-- Join Class Form -->
            <div id="joinClassForm" style="display: none; margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border);">
              <h3 style="margin-bottom: var(--spacing-lg);">Join a New Class</h3>
              <div class="form-group">
                <label for="joinClassCode">Class Code</label>
                <input type="text" id="joinClassCode" placeholder="Enter 6-digit class code" maxlength="6" style="text-transform: uppercase; font-family: 'Courier New', monospace; letter-spacing: 0.5rem; font-size: 1.5rem; text-align: center;">
              </div>
              <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <button class="btn btn-success" onclick="joinClass()" style="flex: 1;">ðŸŽ“ Join Class</button>
                <button class="btn btn-secondary" onclick="hideJoinClassForm()">Cancel</button>
              </div>
            </div>
            
            <div class="classes-grid" id="classesList">
              <!-- Classes will appear here -->
            </div>
            
            <div id="noClassesMessage" class="empty-state" style="display: none;">
              <div class="empty-state-icon">ðŸ«</div>
              <div class="empty-state-title">No Classes Yet</div>
              <div class="empty-state-description">
                Join your first classroom to start tracking your progress with classmates!
              </div>
              <button class="btn btn-primary" onclick="showJoinClassForm()" style="margin-top: var(--spacing-lg);">
                ðŸŽ“ Join Your First Class
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- UPDATED: Enhanced Statistics Section -->
      <div id="statistics" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="statistics-grid">
          <!-- Statistics Header -->
          <div class="statistics-header">
            <h2>ðŸ“ˆ Learning Statistics</h2>
            <div class="statistics-subtitle">Visualize your progress with detailed charts and insights</div>
            <div class="stats-controls">
              <button class="btn btn-primary" onclick="refreshCharts()">
                ðŸ”„ Refresh Charts
              </button>
              <button class="btn btn-secondary" onclick="exportStatistics()">
                ðŸ“¥ Export Stats
              </button>
              <button class="btn btn-success" onclick="markStudySession()">
                ðŸ“ Mark Study Session
              </button>
            </div>
          </div>
          
          <!-- Pro Tip -->
          <div class="pro-tip" style="grid-column: span 12;">
            <strong>ðŸ’¡ Data-Driven Learning</strong>
            Review your statistics weekly to identify patterns. Track what study methods work best for you and adjust accordingly. Students who review their data improve 25% faster than those who don't.
          </div>
          
          <!-- Overview Cards -->
          <div class="stats-overview-cards">
            <div class="stats-overview-card">
              <div class="stats-overview-icon">ðŸ”¥</div>
              <div class="stats-overview-number" id="overviewStreak">0</div>
              <div class="stats-overview-label">Study Streak</div>
              <div class="stats-overview-trend neutral" id="streakTrend">
                <span>âž¡ï¸</span>
                <span>Maintain daily study</span>
              </div>
            </div>
            <div class="stats-overview-card">
              <div class="stats-overview-icon">â°</div>
              <div class="stats-overview-number" id="overviewHours">0</div>
              <div class="stats-overview-label">Study Hours</div>
              <div class="stats-overview-trend neutral" id="hoursTrend">
                <span>âž¡ï¸</span>
                <span>Track your sessions</span>
              </div>
            </div>
            <div class="stats-overview-card">
              <div class="stats-overview-icon">âœ…</div>
              <div class="stats-overview-number" id="overviewTasks">0</div>
              <div class="stats-overview-label">Tasks Completed</div>
              <div class="stats-overview-trend neutral" id="tasksTrend">
                <span>âž¡ï¸</span>
                <span>Complete more tasks</span>
              </div>
            </div>
            <div class="stats-overview-card">
              <div class="stats-overview-icon">ðŸŽ¯</div>
              <div class="stats-overview-number" id="overviewFocus">0%</div>
              <div class="stats-overview-label">Focus Score</div>
              <div class="stats-overview-trend neutral" id="focusTrend">
                <span>âž¡ï¸</span>
                <span>Improve consistency</span>
              </div>
            </div>
          </div>
          
          <!-- Performance Metrics -->
          <div class="performance-metrics">
            <h3>ðŸ“Š Performance Metrics</h3>
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-icon">ðŸ“…</div>
                <div class="metric-value" id="metricSessions">0</div>
                <div class="metric-label">Study Sessions</div>
                <div class="metric-details">This week</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">âš¡</div>
                <div class="metric-value" id="metricAvgHours">0h</div>
                <div class="metric-label">Avg. Daily Hours</div>
                <div class="metric-details">Based on last 7 days</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ðŸ†</div>
                <div class="metric-value" id="metricLongestStreak">0</div>
                <div class="metric-label">Longest Streak</div>
                <div class="metric-details">All-time record</div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ðŸ“ˆ</div>
                <div class="metric-value" id="metricConsistency">0%</div>
                <div class="metric-label">Consistency</div>
                <div class="metric-details">Study regularity</div>
              </div>
            </div>
          </div>
          
          <!-- Charts Section -->
          <div class="charts-container">
            <!-- Study Hours Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>â° Study Hours Distribution</h3>
                <div class="chart-description">Daily study hours over the past week</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="hoursChart"></canvas>
              </div>
              <div class="chart-legend" id="hoursLegend"></div>
            </div>
            
            <!-- Focus Score Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸŽ¯ Daily Focus Score</h3>
                <div class="chart-description">Daily focus scores based on consistency</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="focusChart"></canvas>
              </div>
              <div class="chart-legend" id="focusLegend"></div>
            </div>
            
            <!-- Task Completion Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>âœ… Task Completion</h3>
                <div class="chart-description">Task completion rate and progress</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="tasksChart"></canvas>
              </div>
              <div class="chart-legend" id="tasksLegend"></div>
            </div>
            
            <!-- Weekly Pattern Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸ“… Weekly Study Pattern</h3>
                <div class="chart-description">Study distribution across days of the week</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="weeklyChart"></canvas>
              </div>
              <div class="chart-legend" id="weeklyLegend"></div>
            </div>
            
            <!-- Assignment Status Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸ“š Assignment Status</h3>
                <div class="chart-description">Current assignment completion status</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="assignmentsChart"></canvas>
              </div>
              <div class="chart-legend" id="assignmentsLegend"></div>
            </div>
            
            <!-- Streak History Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3>ðŸ”¥ Streak History</h3>
                <div class="chart-description">Daily streak progression over time</div>
              </div>
              <div class="chart-wrapper">
                <canvas id="streakChart"></canvas>
              </div>
              <div class="chart-legend" id="streakLegend"></div>
            </div>
          </div>
          
          <!-- Detailed Statistics -->
          <div class="stats-detailed-container">
            <h3>ðŸ“‹ Detailed Performance Analysis</h3>
            <div class="stats-detailed-grid">
              <div class="stats-detailed-section">
                <h4>Productivity Metrics</h4>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Total Study Hours</span>
                  <span class="stats-detailed-value" id="detailTotalHours">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Study Sessions</span>
                  <span class="stats-detailed-value" id="detailTotalSessions">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Avg. Session Length</span>
                  <span class="stats-detailed-value" id="detailAvgSession">0h</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Longest Session</span>
                  <span class="stats-detailed-value" id="detailLongestSession">0h</span>
                </div>
              </div>
              
              <div class="stats-detailed-section">
                <h4>Task Metrics</h4>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Total Tasks</span>
                  <span class="stats-detailed-value" id="detailTotalTasks">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Completed Tasks</span>
                  <span class="stats-detailed-value" id="detailCompletedTasks">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Completion Rate</span>
                  <span class="stats-detailed-value" id="detailCompletionRate">0%</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Active Tasks</span>
                  <span class="stats-detailed-value" id="detailActiveTasks">0</span>
                </div>
              </div>
              
              <div class="stats-detailed-section">
                <h4>Achievement Metrics</h4>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Current Streak</span>
                  <span class="stats-detailed-value" id="detailCurrentStreak">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Longest Streak</span>
                  <span class="stats-detailed-value" id="detailLongestStreak">0</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Focus Score</span>
                  <span class="stats-detailed-value" id="detailFocusScore">0%</span>
                </div>
                <div class="stats-detailed-row">
                  <span class="stats-detailed-label">Consistency Score</span>
                  <span class="stats-detailed-value" id="detailConsistencyScore">0%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tools Section -->
      <div id="tools" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ› ï¸ Study Tools</h2>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ Tool Integration</strong>
              Combine different tools for maximum effectiveness. Use Pomodoro timer for focus, flashcards for memorization, and habit tracker for consistency. Integrated tool users show 35% better results.
            </div>
            
            <div class="tools-grid">
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/ai-tic-tac-toe.html', '_blank')">
                <div class="tool-icon">ðŸŽ®</div>
                <div class="tool-name">AI Tic Tac Toe</div>
                <div class="tool-desc">Challenge AI in this classic game</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/countdown-timer.html', '_blank')">
                <div class="tool-icon">â³</div>
                <div class="tool-name">Countdown Timer</div>
                <div class="tool-desc">Track study sessions and breaks</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/habit-tracker.html', '_blank')">
                <div class="tool-icon">ðŸ“Š</div>
                <div class="tool-name">Habit Tracker</div>
                <div class="tool-desc">Build and maintain good habits</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/todolist.html', '_blank')">
                <div class="tool-icon">ðŸ“</div>
                <div class="tool-name">To-Do List</div>
                <div class="tool-desc">Advanced task management</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/notesapp.html', '_blank')">
                <div class="tool-icon">ðŸ“’</div>
                <div class="tool-name">Notes App</div>
                <div class="tool-desc">Take organized notes</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://mairakhancontact-sudo.github.io/javascript-projects/numberguess.html', '_blank')">
                <div class="tool-icon">ðŸŽ¯</div>
                <div class="tool-name">Number Guess</div>
                <div class="tool-desc">Brain training game</div>
              </div>
              
              <div class="tool-item" onclick="window.open('pomodoro.html', '_blank')">
                <div class="tool-icon">ðŸ…</div>
                <div class="tool-name">Pomodoro Timer</div>
                <div class="tool-desc">Boost productivity with intervals</div>
              </div>
              
              <div class="tool-item" onclick="window.open('flashcard-generator.html', '_blank')">
                <div class="tool-icon">ðŸ“‡</div>
                <div class="tool-name">Flashcards</div>
                <div class="tool-desc">Create and study flashcards</div>
              </div>
            </div>
          </div>
        </div>
      </div>




      <!-- Student Memory Wall Section -->
<div id="studentMemoryWall" class="dashboard-content" style="grid-column: span 12; display: none;">
    <div class="content-card">
        <div class="content-header">
            <h2>ðŸ“ Class Memory Wall</h2>
            <button class="btn btn-primary" onclick="showStudentAddMemoryPage()">
                âœ¨ Add Memory
            </button>
        </div>
        <div class="content-body">
            <div class="pro-tip">
                <strong>ðŸŽ¨ Share Memories with Your Class</strong>
                See what your classmates have shared! Add your own achievements, encouraging words, or fun memories.
            </div>
            
            <!-- Memory Wall Container -->
            <div id="studentMemoryWallContainer" style="min-height: 400px; padding: var(--spacing-lg);">
                <div class="loading">Loading memories...</div>
            </div>
        </div>
    </div>
</div>



      <!-- AI Help Section -->
      <div id="ai" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ¤– AI Learning Resources</h2>
          </div>
          <div class="content-body">
            <!-- Pro Tip -->
            <div class="pro-tip">
              <strong>ðŸ’¡ AI Learning Strategy</strong>
              Use AI to explain difficult concepts, generate practice questions, or get writing feedback. Combine AI explanations with traditional resources for comprehensive understanding.
            </div>
            
            <div class="tools-grid">
              <div class="tool-item" onclick="window.open('https://chat.openai.com', '_blank')">
                <div class="tool-icon">ðŸ’¬</div>
                <div class="tool-name">ChatGPT</div>
                <div class="tool-desc">AI assistant for learning and research</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://gemini.google.com', '_blank')">
                <div class="tool-icon">ðŸ”®</div>
                <div class="tool-name">Google Gemini</div>
                <div class="tool-desc">AI-powered research and answers</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.perplexity.ai', '_blank')">
                <div class="tool-icon">ðŸ”</div>
                <div class="tool-name">Perplexity AI</div>
                <div class="tool-desc">Answer engine with citations</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.khanacademy.org', '_blank')">
                <div class="tool-icon">ðŸŽ“</div>
                <div class="tool-name">Khan Academy</div>
                <div class="tool-desc">Free online courses and lessons</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.coursera.org', '_blank')">
                <div class="tool-icon">ðŸ›ï¸</div>
                <div class="tool-name">Coursera</div>
                <div class="tool-desc">University courses and certificates</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://www.youtube.com', '_blank')">
                <div class="tool-icon">ðŸ“º</div>
                <div class="tool-name">YouTube</div>
                <div class="tool-desc">Educational videos and tutorials</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://quizlet.com', '_blank')">
                <div class="tool-icon">ðŸ§ </div>
                <div class="tool-name">Quizlet</div>
                <div class="tool-desc">Study tools and flashcards</div>
              </div>
              
              <div class="tool-item" onclick="window.open('https://duolingo.com', '_blank')">
                <div class="tool-icon">ðŸ¦‰</div>
                <div class="tool-name">Duolingo</div>
                <div class="tool-desc">Language learning made fun</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Profile Section -->
      <div id="profile" class="dashboard-content" style="grid-column: span 12; display: none;">
        <div class="content-card">
          <div class="content-header">
            <h2>ðŸ‘¤ Profile Settings</h2>
          </div>
          <div class="content-body">
            <div style="max-width: 600px; margin: 0 auto;">
              <!-- Pro Tip -->
              <div class="pro-tip">
                <strong>ðŸ’¡ Personalized Learning</strong>
                Customize your preferences based on your learning style. Morning person? Schedule study then. Visual learner? Use more diagrams and charts in your notes.
              </div>
              
              <div class="form-group">
                <label for="profileName">Your Name</label>
                <input type="text" id="profileName" placeholder="Enter your name">
              </div>
              <div class="form-group">
                <label for="profileEmail">Email (Optional)</label>
                <input type="email" id="profileEmail" placeholder="your@email.com">
              </div>
              <div class="form-group">
                <label for="profileBio">Bio</label>
                <textarea id="profileBio" placeholder="Tell us about yourself..." rows="4"></textarea>
              </div>
      <div class="form-group">
        <label>Study Preferences</label>
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; margin-top: var(--spacing-sm);">
          <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
            <input type="checkbox" id="prefPomodoro"> Pomodoro Timer
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
            <input type="checkbox" id="prefReminders"> Study Reminders
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-xs);">
            <input type="checkbox" id="prefLeaderboard"> Show Leaderboard
          </label>
        </div>
      </div>
      <div class="content-card" style="margin-top: var(--spacing-lg);">
        <div class="content-header">
          <h2>ðŸ‘‘ Premium Theme</h2>
          <span class="premium-badge">Premium</span>
        </div>
        <div class="content-body">
          <div class="pro-tip">
            <strong>ðŸ’¡ How To Unlock</strong>
            Refer Grindly Learn to 3 friends and the Premium Theme unlocks automatically.
          </div>
          <div class="pro-tip" id="premiumStatusMsg">
            Refer Grindly Learn to 3 friends to unlock the Premium Theme.
          </div>
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="copyReferralLink()">ðŸ“¤ Copy Referral Link</button>
            <button class="btn btn-success" onclick="markReferral()">âœ… I Referred a Friend</button>
            <button class="btn btn-warning" onclick="previewPremiumTheme()">ðŸ‘ï¸ Preview Premium</button>
          </div>
          <div style="margin-top: var(--spacing-md); font-weight: 600;">
            Referrals: <span id="referralCount">0</span>/3
          </div>
        </div>
      </div>
      <div class="content-card" style="margin-top: var(--spacing-lg);">
        <div class="content-header">
          <h2>ðŸŒˆ Rainbow Theme</h2>
          <span class="premium-badge" id="rainbowBadge">ðŸ”’ Locked</span>
        </div>
        <div class="content-body">
          <div class="pro-tip">
            <strong>ðŸ’¡ How To Unlock</strong>
            Hit a 30â€‘day streak to unlock the Rainbow Theme.
          </div>
          <div class="pro-tip" id="rainbowStatusMsg">
            Reach a 30â€‘day streak to unlock the Rainbow Theme.
          </div>
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="previewRainbowTheme()">ðŸ‘ï¸ Preview Rainbow</button>
          </div>
          <div style="margin-top: var(--spacing-md); font-weight: 600;">
            Streak: <span id="rainbowStreakCount">0</span>/30
          </div>
        </div>
      </div>
              <button class="btn-submit" onclick="saveProfileSettings()" style="margin-top: var(--spacing-lg);">
                ðŸ’¾ Save Profile Settings
              </button>
              
              <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--border);">
                <h3>ðŸ“Š Data Management</h3>
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); flex-wrap: wrap;">
                  <button class="btn btn-warning" onclick="exportData()">ðŸ“¤ Export All Data</button>
                  <button class="btn btn-danger" onclick="clearAllData()">ðŸ—‘ï¸ Clear All Data</button>
                </div>
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: var(--spacing-sm);">
                  Export your data for backup or clear all data to start fresh.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </main>
</div>
<!-- Floating Feedback Button -->
<button class="feedback-btn" onclick="openFeedbackForm()">
    ðŸ’¬ Give Feedback
</button>
<!-- AI Chatbot -->
<div class="chatbot-fab" aria-live="polite">
    <div class="chatbot-bubble" id="chatbotBubble">Youâ€™ve got this.</div>
    <button class="chatbot-btn" id="chatbotBtn" aria-label="Encouragement bot">
        <img class="chatbot-img" src="ai-chatbot-transparent.png" alt="Chatbot" loading="lazy" width="56" height="56">
    </button>
</div>
<audio id="applauseAudio" src="applause.mp3" preload="auto"></audio>
<audio id="portalSwoosh" src="portal-swoosh.mp3" preload="auto"></audio>
<div class="clap-overlay" id="clapOverlay" aria-hidden="true">
  <video class="clap-video" id="clapVideo" src="clapping.mp4" playsinline muted></video>
  <canvas class="clap-canvas" id="clapCanvas"></canvas>
</div>
<!-- Referral Modal -->
<div class="referral-modal" id="referralModal">
  <div class="referral-modal-card">
    <div class="referral-modal-title">Unlock Premium Theme</div>
    <div class="referral-modal-text">
      Refer Grindly Learn to 3 friends. The theme unlocks when they log their first study session.
    </div>
    <div style="margin-bottom: var(--spacing-md); font-weight: 700;">
      Referrals: <span id="referralCountModal">0</span>/3
    </div>
    <div class="referral-modal-actions">
      <button class="btn btn-secondary" onclick="copyReferralLink()">ðŸ“¤ Copy Referral Link</button>
      <button class="btn btn-success" onclick="markReferral()">âœ… I Referred a Friend</button>
      <button class="btn btn-warning" onclick="closeReferralModal()">Close</button>
    </div>
  </div>
</div>
<!-- Rainbow Preview Modal -->
<div class="rainbow-modal" id="rainbowModal">
  <div class="rainbow-modal-card">
    <div class="referral-modal-title">ðŸŒˆ Rainbow Theme</div>
    <div class="referral-modal-text" id="rainbowModalText" style="color: #e5e7ff;">
      Hit a 30â€‘day streak to unlock the Rainbow Theme.
    </div>
    <div style="margin-bottom: var(--spacing-md); font-weight: 700;">
      Streak: <span id="rainbowModalCount">0</span>/30
    </div>
    <div class="referral-modal-actions">
      <button class="btn btn-warning" onclick="closeRainbowModal()">Close</button>
    </div>
  </div>
</div>
<!-- Forest Preview Modal -->
<div class="forest-modal" id="forestModal">
  <div class="forest-modal-card">
    <div class="referral-modal-title">ðŸŒ² Forest Theme</div>
    <div class="referral-modal-text" id="forestModalText" style="color: #d1fae5;">
      Hit a 7â€‘day streak to unlock the Forest Theme.
    </div>
    <div style="margin-bottom: var(--spacing-md); font-weight: 700;">
      Streak: <span id="forestModalCount">0</span>/7
    </div>
    <div class="referral-modal-actions">
      <button class="btn btn-warning" onclick="closeForestModal()">Close</button>
    </div>
  </div>
</div>
<script>
// ========== MOBILE MENU FUNCTIONALITY ==========
function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function closeMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
}

// Add mobile menu toggle listener
document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileMenu);
document.getElementById('mobileOverlay').addEventListener('click', closeMobileMenu);

// Close menu when clicking outside on mobile
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('mobileMenuToggle');
    const overlay = document.getElementById('mobileOverlay');
    
    if (window.innerWidth <= 991 && 
        !sidebar.contains(event.target) && 
        !toggleBtn.contains(event.target) && 
        sidebar.classList.contains('active')) {
        closeMobileMenu();
    }
});

// Close menu on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMobileMenu();
    }
});

// ========== FIREBASE CONFIGURATION ==========
const firebaseConfig = {
    apiKey: "AIzaSyBAIPxgXPZmGdPvB98TLFRfTAClgXWEIM0",
    authDomain: "student-teacher-app-4e7c9.firebaseapp.com",
    databaseURL: "https://student-teacher-app-4e7c9-default-rtdb.firebaseio.com",
    projectId: "student-teacher-app-4e7c9",
    storageBucket: "student-teacher-app-4e7c9.firebasestorage.app",
    messagingSenderId: "737621420458",
    appId: "1:737621420458:web:74c873869a1a47c2ce23d3"
};
const IMGBB_API_KEY = "PASTE_YOUR_IMGBB_KEY_HERE";



async function uploadImageToImgBB(blob) {
    const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const result = reader.result;
            resolve(result.split(',')[1]); // base64 only
        };
        if (sectionId === 'exitTicket' && itemText.includes('Exit Ticket')) {
            item.classList.add('active');
            return;
        }
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });

    const form = new FormData();
    form.append('image', base64);

    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: 'POST',
        body: form
    });

    const data = await res.json();
    if (!data || !data.success) {
        throw new Error('ImgBB upload failed');
    }

    return data.data.url; // direct image URL
}

async function shortenUrl(longUrl) {
    const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
    const shortUrl = await res.text();
    return shortUrl;
}

// ========== GLOBAL VARIABLES ==========
let currentUser = null;
let currentUserId = null;
let currentUserName = "Student";
let database = null;
let auth = null;
let userClasses = [];
let currentClassCode = null;
let selectedClassIndex = 0;

const STORAGE_SCHEMA_VERSION = 2;

function initLocalStorageSchema() {
    try {
        const stored = parseInt(localStorage.getItem('lifeos_schema_version') || '1', 10);
        if (stored >= STORAGE_SCHEMA_VERSION) return;

        if (stored < 2) {
            const legacyName = localStorage.getItem('student_name');
            const newName = localStorage.getItem('studentName');
            if (legacyName && !newName) {
                localStorage.setItem('studentName', legacyName);
            }
            if (newName && !legacyName) {
                localStorage.setItem('student_name', newName);
            }
        }

        localStorage.setItem('lifeos_schema_version', String(STORAGE_SCHEMA_VERSION));
    } catch (error) {
        console.error("Schema migration failed:", error);
    }
}

// Initialize with proper default values to prevent undefined errors
let studyData = {
    streak: 0,
    lastStudyDate: "",
    totalMinutes: 0,
    totalStudyDays: 0,
    totalStudyHours: 0,
    studySessions: [],
    weeklyPattern: [0, 0, 0, 0, 0, 0, 0],
    streakHistory: [],
    streakMilestones: [3, 7, 14, 30, 60, 90],
    currentMilestone: 0,
    dailyStats: [],
    focusScores: [],
    consistencyScores: []
};

let tasks = [];
let assignments = [];
let currentTaskFilter = 'all';
let currentSection = 'dashboard';
let selectedPriority = 'urgent';

// Chart instances
let hoursChart = null;
let tasksChart = null;
let weeklyChart = null;
let assignmentsChart = null;
let streakChart = null;
let focusChart = null;

// Chart auto-refresh interval
let chartRefreshInterval = null;

// ========== INSPIRING QUOTES DATABASE ==========
const inspiringQuotes = [
    { text: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
    { text: "The beautiful thing about learning is that no one can take it away from you.", author: "B.B. King" },
    { text: "Don't let what you cannot do interfere with what you can do.", author: "John Wooden" },
    { text: "The more that you read, the more things you will know. The more that you learn, the more places you'll go.", author: "Dr. Seuss" },
    { text: "The capacity to learn is a gift; the ability to learn is a skill; the willingness to learn is a choice.", author: "Brian Herbert" },
    { text: "Knowledge is power. Information is liberating. Education is the premise of progress, in every society, in every family.", author: "Kofi Annan" },
    { text: "The roots of education are bitter, but the fruit is sweet.", author: "Aristotle" },
    { text: "Education is not preparation for life; education is life itself.", author: "John Dewey" },
    { text: "The mind is not a vessel to be filled, but a fire to be kindled.", author: "Plutarch" },
    { text: "Live as if you were to die tomorrow. Learn as if you were to live forever.", author: "Mahatma Gandhi" },
    { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
    { text: "The only person who is educated is the one who has learned how to learn and change.", author: "Carl Rogers" },
    { text: "Education is the key to unlocking the world, a passport to freedom.", author: "Oprah Winfrey" },
    { text: "Learning is a treasure that will follow its owner everywhere.", author: "Chinese Proverb" },
    { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
    { text: "Success is not the key to happiness. Happiness is the key to success. If you love what you are doing, you will be successful.", author: "Albert Schweitzer" },
    { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
    { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" },
    { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
    { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
    { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
    { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
    { text: "The future depends on what you do today.", author: "Mahatma Gandhi" },
    { text: "You miss 100% of the shots you don't take.", author: "Wayne Gretzky" },
    { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
    { text: "Optimism is the faith that leads to achievement. Nothing can be done without hope and confidence.", author: "Helen Keller" },
    { text: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
    { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
    { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
    { text: "I can't change the direction of the wind, but I can adjust my sails to always reach my destination.", author: "Jimmy Dean" },
    { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
    { text: "The difference between a successful person and others is not a lack of strength, not a lack of knowledge, but rather a lack in will.", author: "Vince Lombardi" },
    { text: "The harder I work, the more luck I seem to have.", author: "Thomas Jefferson" },
    { text: "Don't be pushed around by the fears in your mind. Be led by the dreams in your heart.", author: "Roy T. Bennett" },
    { text: "Strength doesn't come from what you can do. It comes from overcoming the things you once thought you couldn't.", author: "Rikki Rogers" },
    { text: "Every accomplishment starts with the decision to try.", author: "John F. Kennedy" },
    { text: "You don't have to see the whole staircase, just take the first step.", author: "Martin Luther King Jr." },
    { text: "The only thing standing between you and your goal is the story you keep telling yourself as to why you can't achieve it.", author: "Jordan Belfort" },
    { text: "Small daily improvements are the key to staggering long-term results.", author: "Darren Hardy" },
    { text: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
    { text: "What you get by achieving your goals is not as important as what you become by achieving your goals.", author: "Zig Ziglar" },
    { text: "Your potential is endless. Go do what you were created to do.", author: "Unknown" },
    { text: "The moment you give up is the moment you let someone else win.", author: "Kobe Bryant" },
    { text: "Challenges are what make life interesting and overcoming them is what makes life meaningful.", author: "Joshua J. Marine" },
    { text: "Don't limit your challenges. Challenge your limits.", author: "Unknown" },
    { text: "The pain of discipline weighs ounces, the pain of regret weighs tons.", author: "Jim Rohn" },
    { text: "Success is stumbling from failure to failure with no loss of enthusiasm.", author: "Winston Churchill" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" }
];

// ========== AI CHATBOT ==========
const chatbotMessages = [
    "Youâ€™ve got this. One step at a time.",
    "Small progress is still progress.",
    "Focus for five minutes â€” start now.",
    "Youâ€™re building a powerful habit.",
    "Be proud of showing up today.",
    "Keep going. Future you will thank you.",
    "Youâ€™re not alone â€” keep pushing.",
    "Just one more task, you can do it.",
    "Your effort matters more than perfection.",
    "Deep breath. You are capable.",
    "Consistency beats intensity.",
    "Start messy. Finish strong.",
    "Do the next small thing.",
    "Youâ€™re making it happen.",
    "Keep the streak alive.",
    "Show up for yourself today.",
    "Make today count.",
    "Momentum starts now.",
    "Youâ€™re stronger than distractions.",
    "One focused hour can change a day.",
    "Tiny steps, big results.",
    "This is your time. Use it.",
    "Stay steady. You are doing great.",
    "Progress is a victory.",
    "Youâ€™re learning fast.",
    "Your focus is your superpower.",
    "Donâ€™t wait for perfect. Start.",
    "You are in control.",
    "Finish one task. Then another.",
    "Keep the pace.",
    "Youâ€™re closer than you think.",
    "Todayâ€™s effort shapes tomorrow.",
    "Keep your eyes on the goal.",
    "Youâ€™re building mastery.",
    "You can do hard things.",
    "Stay with it.",
    "One page at a time.",
    "One problem at a time.",
    "Keep calm and study on.",
    "Breathe. Focus. Execute.",
    "Your future self is cheering.",
    "This is a good moment to start.",
    "Every session counts.",
    "Youâ€™re on the right track.",
    "Your discipline is growing.",
    "Youâ€™re doing better than you think.",
    "Itâ€™s okay to go slow.",
    "Choose progress today.",
    "Youâ€™ve already begun â€” keep going.",
    "The work will pay off.",
    "Stay locked in.",
    "You are capable of more.",
    "Make it happen today.",
    "Focus now, relax later.",
    "Small wins matter.",
    "Do it for your goals.",
    "Keep your head up.",
    "Youâ€™ve got momentum.",
    "Trust the process.",
    "Youâ€™re building something great."
];

const dailyChallenges = [
    "Finish one focused 25â€‘minute study session.",
    "Review notes for 10 minutes without distractions.",
    "Complete one pending task from your list.",
    "Summarize one lesson in 3 bullet points.",
    "Do 10 practice questions in a row.",
    "Study for 20 minutes and take a 5â€‘minute break.",
    "Organize your tasks for tomorrow.",
    "Rewrite a concept in your own words.",
    "Teach a concept out loud for 3 minutes.",
    "Clear one small assignment step today."
];

const DAILY_CHALLENGE_KEY = 'studentDailyChallenge';
const DAILY_CHALLENGE_DATE_KEY = 'studentDailyChallengeDate';
const DAILY_CHALLENGE_DONE_KEY = 'studentDailyChallengeDone';
const DAILY_CHALLENGE_SHOWN_KEY = 'studentDailyChallengeShown';

function getTodayKeySimple() {
    return new Date().toDateString();
}

function getDailyChallenge() {
    const today = getTodayKeySimple();
    const savedDate = localStorage.getItem(DAILY_CHALLENGE_DATE_KEY);
    if (savedDate === today) {
        return localStorage.getItem(DAILY_CHALLENGE_KEY);
    }
    const challenge = dailyChallenges[Math.floor(Math.random() * dailyChallenges.length)];
    localStorage.setItem(DAILY_CHALLENGE_DATE_KEY, today);
    localStorage.setItem(DAILY_CHALLENGE_KEY, challenge);
    localStorage.setItem(DAILY_CHALLENGE_DONE_KEY, 'false');
    localStorage.setItem(DAILY_CHALLENGE_SHOWN_KEY, '');
    return challenge;
}

function renderDailyChallenge() {
    const card = document.getElementById('dailyChallengeCard');
    const textEl = document.getElementById('dailyChallengeText');
    const btn = document.getElementById('dailyChallengeDoneBtn');
    if (!card || !textEl || !btn) return;
    const challenge = getDailyChallenge() || "Complete todayâ€™s focus block.";
    textEl.textContent = challenge;
    const done = localStorage.getItem(DAILY_CHALLENGE_DONE_KEY) === 'true';
    btn.disabled = done;
    btn.textContent = done ? "âœ… Completed today" : "âœ… I am done";
    card.style.display = done ? 'none' : 'block';
}

function playApplauseSound() {
    try {
        const audio = document.getElementById('applauseAudio') || new Audio('applause.mp3');
        audio.currentTime = 0;
        audio.volume = 0.9;
        audio.play().catch((e) => console.warn("Audio playback blocked:", e));
        return audio;
    } catch (e) {
        console.warn("Audio playback blocked or unavailable:", e);
        return null;
    }
}

function playClappingVideo() {
    const overlay = document.getElementById('clapOverlay');
    const video = document.getElementById('clapVideo');
    const canvas = document.getElementById('clapCanvas');
    if (!overlay || !video) return;
    overlay.style.display = 'flex';
    requestAnimationFrame(() => overlay.classList.add('show'));
    video.currentTime = 0;
    const ctx = canvas ? canvas.getContext('2d') : null;
    const drawFrame = () => {
        if (!ctx || video.paused || video.ended) return;
        const vw = video.videoWidth || 0;
        const vh = video.videoHeight || 0;
        if (vw && vh) {
            canvas.width = vw;
            canvas.height = vh;
            ctx.drawImage(video, 0, 0, vw, vh);
            const frame = ctx.getImageData(0, 0, vw, vh);
            const data = frame.data;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                if (g > 100 && g > r * 1.2 && g > b * 1.2) {
                    data[i + 3] = 0;
                }
            }
            ctx.putImageData(frame, 0, 0);
        }
        requestAnimationFrame(drawFrame);
    };
    video.play().then(() => {
        requestAnimationFrame(drawFrame);
    }).catch((e) => console.warn("Video playback blocked:", e));
    video.onended = () => {
        stopClappingVideo();
    };
}

function stopClappingVideo() {
    const overlay = document.getElementById('clapOverlay');
    const video = document.getElementById('clapVideo');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 250);
    }
}

function completeDailyChallenge() {
    localStorage.setItem(DAILY_CHALLENGE_DONE_KEY, 'true');
    renderDailyChallenge();
    const audio = playApplauseSound();
    playClappingVideo();
    if (audio) {
        audio.onended = () => stopClappingVideo();
    }
    showNotification("Challenge completed! ðŸŽ‰", "success");
}

function showDailyChallengeFromChatbot() {
    renderDailyChallenge();
    const card = document.getElementById('dailyChallengeCard');
    if (card) card.style.display = 'block';
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

const statsCompareMessages = [
    "You studied 20% more than average.",
    "Top 10% of users this week.",
    "Your streak is ahead of 70% of students.",
    "Youâ€™re in the top 25% for weekly focus.",
    "You completed more sessions than most this week.",
    "Youâ€™re above average for consistency.",
    "Youâ€™re trending upward â€” keep it going.",
    "Your study time beat last week by 15%.",
    "Youâ€™re keeping a strong pace this week.",
    "Youâ€™re ahead of your weekly goal."
];

function updateStatsCompare() {
    const msg1 = document.getElementById('compareMsg1');
    const msg2 = document.getElementById('compareMsg2');
    if (!msg1 || !msg2) return;

    const idx1 = Math.floor(Math.random() * statsCompareMessages.length);
    let idx2 = Math.floor(Math.random() * statsCompareMessages.length);
    if (idx2 === idx1) idx2 = (idx2 + 1) % statsCompareMessages.length;

    msg1.textContent = statsCompareMessages[idx1];
    msg2.textContent = statsCompareMessages[idx2];
}

let chatbotTimeoutId = null;

function showChatbotGreetingThenChallenge() {
    const bubble = document.getElementById('chatbotBubble');
    if (!bubble) return;
    bubble.classList.remove('challenge');
    bubble.textContent = "Hi! Ready to grind?";
    bubble.classList.add('show');
    setTimeout(() => {
        bubble.classList.remove('show');
        setTimeout(showChallengeBubble, 600);
    }, 2000);
}

function showChallengeBubble() {
    const bubble = document.getElementById('chatbotBubble');
    if (!bubble) return;
    const today = getTodayKeySimple();
    const shownDate = localStorage.getItem(DAILY_CHALLENGE_SHOWN_KEY);
    if (shownDate !== today && localStorage.getItem(DAILY_CHALLENGE_DONE_KEY) !== 'true') {
        const challenge = getDailyChallenge();
        bubble.textContent = `Today's challenge: ${challenge}`;
        bubble.classList.add('challenge');
        localStorage.setItem(DAILY_CHALLENGE_SHOWN_KEY, today);
        showDailyChallengeFromChatbot();
        bubble.classList.add('show');
        setTimeout(() => bubble.classList.remove('show'), 12000);
    }
}

function showChatbotMessage() {
    const bubble = document.getElementById('chatbotBubble');
    if (!bubble) return;
    const today = getTodayKeySimple();
    const shownDate = localStorage.getItem(DAILY_CHALLENGE_SHOWN_KEY);
    let msg = "";
    if (shownDate !== today && localStorage.getItem(DAILY_CHALLENGE_DONE_KEY) !== 'true') {
        const challenge = getDailyChallenge();
        msg = `Today's challenge: ${challenge}`;
        bubble.classList.add('challenge');
        localStorage.setItem(DAILY_CHALLENGE_SHOWN_KEY, today);
        showDailyChallengeFromChatbot();
    } else {
        msg = chatbotMessages[Math.floor(Math.random() * chatbotMessages.length)];
        bubble.classList.remove('challenge');
    }
    bubble.textContent = msg;
    bubble.classList.add('show');
    setTimeout(() => bubble.classList.remove('show'), 12000);
}

function scheduleChatbotMessage() {
    if (chatbotTimeoutId) clearTimeout(chatbotTimeoutId);
    const delay = Math.floor(Math.random() * 8000) + 7000; // 7-15s
    chatbotTimeoutId = setTimeout(() => {
        showChatbotMessage();
        scheduleChatbotMessage();
    }, delay);
}







// ========== PREMIUM THEME REFERRALS ==========
const REFERRAL_KEY = 'studentPremiumReferrals';
const REFERRAL_REFERRER_KEY = 'studentReferralReferrer';
const REFERRAL_CREDITED_KEY_PREFIX = 'studentReferralCredited_';
const REFERRAL_PENDING_KEY = 'studentReferralPending';
const REFERRAL_TARGET = 3;
const REFERRAL_NOTIFS_SEEN_KEY = 'studentReferralNotifsSeen';
const REFERRAL_UNLOCKED_KEY = 'studentReferralUnlocked';
const RAINBOW_UNLOCKED_KEY = 'studentRainbowUnlocked';
const FOREST_UNLOCKED_KEY = 'studentForestUnlocked';

function getReferralCount() {
    return parseInt(localStorage.getItem(REFERRAL_KEY) || '0', 10);
}

function setReferralCount(val) {
    localStorage.setItem(REFERRAL_KEY, String(val));
}

function updateReferralUI() {
    const count = Math.min(getReferralCount(), REFERRAL_TARGET);
    const countEl = document.getElementById('referralCount');
    const countModalEl = document.getElementById('referralCountModal');
    const statusEl = document.getElementById('premiumStatusMsg');
    if (countEl) countEl.textContent = count;
    if (countModalEl) countModalEl.textContent = count;
    if (statusEl) {
        statusEl.textContent = count >= REFERRAL_TARGET
            ? "Premium Theme unlocked! Select it in the theme menu."
            : `Refer Grindly Learn to ${REFERRAL_TARGET} friends to unlock the Premium Theme.`;
    }

    if (count >= REFERRAL_TARGET) {
        const unlocked = localStorage.getItem(REFERRAL_UNLOCKED_KEY) === 'true';
        localStorage.setItem('studentTheme', 'premium');
        document.body.className = 'premium';
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = 'premium';
        if (!unlocked) {
            localStorage.setItem(REFERRAL_UNLOCKED_KEY, 'true');
            showNotification("Premium unlocked! Enjoy the new look âœ¨", "success");
            triggerPremiumSparkles();
        }
    }
}

function copyReferralLink() {
    const link = `https://grindlylearn.netlify.app/studentmode.html?ref=${encodeURIComponent(currentUserId || '')}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification("Referral link copied!", "success");
    }).catch(() => {
        showNotification("Could not copy link. Please copy manually.", "warning");
    });
}

async function markReferral() {
    copyReferralLink();

    if (!currentUserId) {
        showNotification("Referral not available yet. Try again in a moment.", "warning");
        return;
    }

    try {
        const serverCountRaw = await firebaseGet(`users/${currentUserId}/referralCount`);
        const serverCount = Math.min(parseInt(serverCountRaw || 0, 10) || 0, REFERRAL_TARGET);
        const localCount = getReferralCount();

        if (serverCount > localCount) {
            setReferralCount(serverCount);
            updateReferralUI();
            showNotification("Referral counted!", "success");
        } else {
            showNotification("Referral not verified yet. Your friend must open your link and log a study session.", "warning");
        }
    } catch (e) {
        console.warn("Failed to verify referral count:", e);
        showNotification("Could not verify referral yet. Please try again soon.", "warning");
    }
}

function previewPremiumTheme() {
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.dataset.previewTheme = current;
    document.body.className = 'premium';
    showNotification("Previewing Premium Themeâ€¦", "info");
    openReferralModal();
}

function updateRainbowUI() {
    const streak = studyData.streak || 0;
    const unlocked = streak >= 30 || localStorage.getItem(RAINBOW_UNLOCKED_KEY) === 'true';
    const statusEl = document.getElementById('rainbowStatusMsg');
    const countEl = document.getElementById('rainbowStreakCount');
    const badgeEl = document.getElementById('rainbowBadge');
    if (countEl) countEl.textContent = Math.min(streak, 30);
    if (badgeEl) badgeEl.textContent = unlocked ? 'ðŸŒˆ Unlocked' : 'ðŸ”’ Locked';
    if (statusEl) {
        statusEl.textContent = unlocked
            ? "Rainbow Theme unlocked! Select it in the theme menu."
            : "Reach a 30â€‘day streak to unlock the Rainbow Theme.";
    }
}

function openRainbowModal() {
    const modal = document.getElementById('rainbowModal');
    if (modal) modal.classList.add('show');
    const countEl = document.getElementById('rainbowModalCount');
    if (countEl) countEl.textContent = Math.min(studyData.streak || 0, 30);
    const textEl = document.getElementById('rainbowModalText');
    if (textEl) {
        textEl.textContent = (studyData.streak || 0) >= 30
            ? "Rainbow Theme unlocked! Select it in the theme menu."
            : "Hit a 30â€‘day streak to unlock the Rainbow Theme.";
    }
}

function closeRainbowModal() {
    const modal = document.getElementById('rainbowModal');
    if (modal) modal.classList.remove('show');
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = current;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = current;
}

function previewRainbowTheme() {
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = 'rainbow';
    openRainbowModal();
}

function openForestModal() {
    const modal = document.getElementById('forestModal');
    if (modal) modal.classList.add('show');
    const countEl = document.getElementById('forestModalCount');
    if (countEl) countEl.textContent = Math.min(studyData.streak || 0, 7);
    const textEl = document.getElementById('forestModalText');
    if (textEl) {
        textEl.textContent = (studyData.streak || 0) >= 7
            ? "Forest Theme unlocked! Select it in the theme menu."
            : "Hit a 7â€‘day streak to unlock the Forest Theme.";
    }
}

function closeForestModal() {
    const modal = document.getElementById('forestModal');
    if (modal) modal.classList.remove('show');
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = current;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = current;
}

function previewForestTheme() {
    const current = localStorage.getItem('studentTheme') || 'light';
    document.body.className = 'forest';
    openForestModal();
}

function openReferralModal() {
    const modal = document.getElementById('referralModal');
    if (modal) modal.classList.add('show');
    updateReferralUI();
}

function closeReferralModal() {
    const modal = document.getElementById('referralModal');
    if (modal) modal.classList.remove('show');
    const referrals = getReferralCount();
    const previewTheme = document.body.dataset.previewTheme;
    if (previewTheme) {
        document.body.className = previewTheme;
        localStorage.setItem('studentTheme', previewTheme);
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = previewTheme;
        delete document.body.dataset.previewTheme;
        return;
    }
    if (referrals < REFERRAL_TARGET) {
        localStorage.setItem('studentTheme', 'dark');
        document.body.className = 'dark';
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = 'dark';
    }
}

function captureReferralFromUrl() {
    try {
        const params = new URLSearchParams(window.location.search);
        const ref = params.get('ref');
        if (ref && ref.startsWith('student_') && ref !== currentUserId) {
            localStorage.setItem(REFERRAL_REFERRER_KEY, ref);
            localStorage.setItem(REFERRAL_PENDING_KEY, 'true');
        }
    } catch (e) {
        console.warn("Failed to parse referral URL:", e);
    }
}

function getReferralCreditedKey(referrerId) {
    return `${REFERRAL_CREDITED_KEY_PREFIX}${referrerId}`;
}

function hasStudyActivity() {
    return ((studyData?.studySessions || []).length > 0) ||
        ((studyData?.totalMinutes || 0) > 0) ||
        !!studyData?.lastStudyDate;
}

async function maybeCreditReferral() {
    const referrerId = localStorage.getItem(REFERRAL_REFERRER_KEY);
    if (!referrerId || referrerId === currentUserId) return;

    const creditedKey = getReferralCreditedKey(referrerId);
    const credited = localStorage.getItem(creditedKey);
    if (credited === 'true') return;

    if (!hasStudyActivity()) return;

    if (!database || !currentUser) {
        localStorage.setItem(REFERRAL_PENDING_KEY, 'true');
        return;
    }

    try {
        const path = `users/${referrerId}/referralCount`;
        const next = await firebaseIncrement(path, REFERRAL_TARGET);
        if (next === null || next === undefined) return;
        await firebaseSet(`users/${referrerId}/referralNotifications/${currentUserId}`, {
            name: currentUserName || 'A friend',
            joinedAt: new Date().toISOString()
        });
        localStorage.setItem(creditedKey, 'true');
        localStorage.removeItem(REFERRAL_PENDING_KEY);
    } catch (e) {
        console.warn("Failed to credit referral:", e);
    }
}

function retryPendingReferralCredit() {
    if (localStorage.getItem(REFERRAL_PENDING_KEY) !== 'true') return;
    maybeCreditReferral();
}

function triggerPremiumSparkles() {
    const layer = document.getElementById('premiumSparkleLayer');
    if (!layer) return;

    const sparkleCount = 80;
    for (let i = 0; i < sparkleCount; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'premium-sparkle';
        sparkle.style.left = `${Math.random() * 100}vw`;
        sparkle.style.top = `${50 + Math.random() * 40}vh`;
        sparkle.style.animationDelay = `${Math.random() * 0.4}s`;
        sparkle.style.width = `${4 + Math.random() * 6}px`;
        sparkle.style.height = sparkle.style.width;
        layer.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 3000);
    }
}

async function syncReferralCountFromFirebase() {
    if (!currentUserId) return;
    try {
        const count = await firebaseGet(`users/${currentUserId}/referralCount`);
        if (count !== null && count !== undefined) {
            setReferralCount(parseInt(count, 10) || 0);
        }
    } catch (e) {
        console.warn("Failed to sync referral count:", e);
    }
}

function loadSeenReferralNotifs() {
    try {
        const raw = localStorage.getItem(REFERRAL_NOTIFS_SEEN_KEY);
        return raw ? JSON.parse(raw) : [];
    } catch {
        return [];
    }
}

function saveSeenReferralNotifs(list) {
    try {
        localStorage.setItem(REFERRAL_NOTIFS_SEEN_KEY, JSON.stringify(list));
    } catch (e) {
        console.warn("Failed to save seen referral notifications:", e);
    }
}

function setupReferralNotifications() {
    if (!database || !currentUser) return;
    if (!currentUserId) return;

    const seen = new Set(loadSeenReferralNotifs());
    const ref = database.ref(`users/${currentUserId}/referralNotifications`);
    const countRef = database.ref(`users/${currentUserId}/referralCount`);

    countRef.on('value', (snap) => {
        const val = Math.min(parseInt(snap.val() || 0, 10) || 0, REFERRAL_TARGET);
        setReferralCount(val);
        updateReferralUI();
    });

    ref.on('child_added', (snap) => {
        if (!snap || !snap.key) return;
        if (seen.has(snap.key)) return;

        const data = snap.val() || {};
        const name = data.name || 'A friend';

        showNotification(`${name} is studying because of you!`, "success");
        seen.add(snap.key);
        saveSeenReferralNotifs(Array.from(seen));

        // Keep local count in sync as soon as a referral is detected
        syncReferralCountFromFirebase().then(updateReferralUI);
    });
}

// ========== INSPIRING STORIES DATABASE ==========
const inspiringStories = [
    {
        id: 1,
        name: "Albert Einstein",
        icon: "ðŸ§ ",
        quote: "Imagination is more important than knowledge.",
        story: "Albert Einstein, one of the greatest physicists of all time, faced numerous struggles in his early life. He didn't speak until he was four years old and was considered a slow learner by his teachers. He failed his first entrance exam to the Swiss Federal Polytechnic School. Despite these early challenges, Einstein's curiosity and persistence led him to develop the theory of relativity, which revolutionized our understanding of space, time, and gravity. He was awarded the Nobel Prize in Physics in 1921.",
        struggles: [
            "Late development in speech and learning",
            "Failed university entrance exam",
            "Worked as a patent clerk while developing groundbreaking theories",
            "Faced skepticism from the scientific community"
        ],
        lessons: "Never give up on your curiosity. What others see as weaknesses might be your greatest strengths."
    },
    {
        id: 2,
        name: "Oprah Winfrey",
        icon: "ðŸŽ¤",
        quote: "Turn your wounds into wisdom.",
        story: "Oprah Winfrey overcame a childhood of poverty and abuse to become one of the most influential media personalities in the world. Born into poverty in rural Mississippi, she was molested by relatives and became pregnant at 14 (the child died in infancy). Despite these traumatic experiences, she excelled in school and won a scholarship to Tennessee State University. Her breakthrough came when she moved to Chicago to host a morning talk show, which eventually became 'The Oprah Winfrey Show' - the highest-rated talk show in American history.",
        struggles: [
            "Poverty and childhood abuse",
            "Teen pregnancy and loss of child",
            "Racial and gender discrimination",
            "Battled with weight and self-esteem issues"
        ],
        lessons: "Your past doesn't define your future. Use your experiences to empower yourself and others."
    },
    {
        id: 3,
        name: "Stephen Hawking",
        icon: "ðŸŒŒ",
        quote: "However difficult life may seem, there is always something you can do and succeed at.",
        story: "Stephen Hawking was diagnosed with ALS (amyotrophic lateral sclerosis) at age 21 and given just two years to live. Despite being confined to a wheelchair and losing his ability to speak, he became one of the most brilliant theoretical physicists of our time. Using a speech-generating device, he continued his research on black holes and the origins of the universe. His book 'A Brief History of Time' sold over 25 million copies worldwide, making complex scientific concepts accessible to the general public.",
        struggles: [
            "Diagnosed with ALS at 21",
            "Gradual loss of mobility and speech",
            "Confined to wheelchair for most of his life",
            "Medical complications including pneumonia"
        ],
        lessons: "Physical limitations cannot constrain the human mind. Focus on what you can do, not what you can't."
    },
    {
        id: 4,
        name: "J.K. Rowling",
        icon: "âœï¸",
        quote: "Rock bottom became the solid foundation on which I rebuilt my life.",
        story: "Before publishing Harry Potter, J.K. Rowling was a single mother living on welfare in Edinburgh, Scotland. She wrote the first Harry Potter book in cafes while her baby daughter slept. The manuscript was rejected by 12 publishers before Bloomsbury accepted it. Today, the Harry Potter series has sold over 500 million copies worldwide, making Rowling one of the most successful authors in history. She went from being on government assistance to becoming a billionaire (though she has since donated much of her wealth to charity).",
        struggles: [
            "Single mother living on welfare",
            "Clinical depression and suicidal thoughts",
            "12 publishers rejected Harry Potter",
            "Struggled with poverty for years"
        ],
        lessons: "Failure is not permanent. Persistence can turn your biggest dreams into reality."
    },
    {
        id: 5,
        name: "Thomas Edison",
        icon: "ðŸ’¡",
        quote: "I have not failed. I've just found 10,000 ways that won't work.",
        story: "Thomas Edison, one of America's greatest inventors, was told by his teachers that he was 'too stupid to learn anything.' He was fired from his first two jobs for being 'non-productive.' Despite these setbacks, he went on to hold 1,093 patents, including the phonograph, the motion picture camera, and perhaps most famously, the practical electric light bulb. His invention of the light bulb required thousands of experiments with different materials before finding one that worked.",
        struggles: [
            "Teachers said he was 'too stupid to learn'",
            "Fired from early jobs",
            "Thousands of failed experiments",
            "Lost his hearing as a child"
        ],
        lessons: "Persistence and learning from failure are keys to innovation and success."
    },
    {
        id: 6,
        name: "Malala Yousafzai",
        icon: "ðŸ“š",
        quote: "One child, one teacher, one book, one pen can change the world.",
        story: "Malala Yousafzai was shot in the head by the Taliban at age 15 for advocating for girls' education in Pakistan. She survived the attack and continued her activism, becoming the youngest-ever Nobel Prize laurete at age 17. Her recovery involved multiple surgeries and rehabilitation in the UK. Today, she continues to fight for education rights through the Malala Fund, which supports education programs around the world.",
        struggles: [
            "Shot by Taliban at age 15",
            "Faced death threats for advocating education",
            "Multiple surgeries and long recovery",
            "Forced to leave her home country"
        ],
        lessons: "Courage means standing up for what you believe in, even in the face of extreme danger."
    },
    {
        id: 7,
        name: "Walt Disney",
        icon: "ðŸ°",
        quote: "All our dreams can come true if we have the courage to pursue them.",
        story: "Walt Disney was fired from a newspaper for 'lacking imagination' and 'having no good ideas.' His first animation company went bankrupt. He was turned down 302 times before getting financing for Disney World. Despite these failures, he created Mickey Mouse and built the Disney empire, which has brought joy to millions of people worldwide. His theme parks and films continue to be beloved by generations.",
        struggles: [
            "Fired from newspaper for 'no imagination'",
            "First animation company bankrupt",
            "302 rejections for Disney World financing",
            "Struggled with financial problems"
        ],
        lessons: "Believe in your vision even when others don't. Persistence can create magic."
    },
    {
        id: 8,
        name: "Bethany Hamilton",
        icon: "ðŸ„â€â™€ï¸",
        quote: "Courage doesn't mean you don't get afraid. Courage means you don't let fear stop you.",
        story: "At age 13, professional surfer Bethany Hamilton lost her left arm to a shark attack. Just one month after the attack, she returned to surfing. She went on to win her first national surfing title two years later and became a professional surfer. Her story was made into the movie 'Soul Surfer.' She continues to surf competitively and inspires people worldwide with her determination.",
        struggles: [
            "Lost arm in shark attack at 13",
            "Learned to surf with one arm",
            "Faced physical and emotional challenges",
            "Overcame fear of returning to ocean"
        ],
        lessons: "Life's challenges can become opportunities for growth and inspiration."
    }
];

// ========== DATA PERSISTENCE HELPER ==========
function persistData() {
    try {
        const dataToSave = {
            version: "2.5", // Updated version
            lastSaved: new Date().toISOString(),
            userId: currentUserId,
            userName: currentUserName,
            studyData: studyData,
            tasks: tasks,
            assignments: assignments,
            userClasses: userClasses,
            currentClassCode: currentClassCode,
            selectedClassIndex: selectedClassIndex,
            currentSection: currentSection
        };
        
        // Clean up any undefined arrays before saving
        if (!studyData.studySessions) studyData.studySessions = [];
        if (!studyData.dailyStats) studyData.dailyStats = [];
        if (!studyData.focusScores) studyData.focusScores = [];
        if (!studyData.consistencyScores) studyData.consistencyScores = [];
        
        localStorage.setItem('studentPersistentData', JSON.stringify(dataToSave));
        console.log("ðŸ’¾ Data persisted to localStorage");
    } catch (e) {
        console.error("Error persisting data:", e);
    }
}

function loadPersistedData() {
    try {
        const savedData = localStorage.getItem('studentPersistentData');
        if (savedData) {
            const data = JSON.parse(savedData);
            
            // Check version compatibility
            if (data.version && (data.version === "2.5" || data.version === "2.4" || data.version === "2.3" || data.version === "2.2" || data.version === "2.1" || data.version === "2.0")) {
                console.log("ðŸ“‚ Loading persisted data version:", data.version);
                
                // Load study data with safety checks
                if (data.studyData) {
                    studyData = data.studyData;
                    // Initialize arrays if they don't exist
                    if (!studyData.studySessions) studyData.studySessions = [];
                    if (!studyData.dailyStats) studyData.dailyStats = [];
                    if (!studyData.focusScores) studyData.focusScores = [];
                    if (!studyData.consistencyScores) studyData.consistencyScores = [];
                    if (!studyData.streakHistory) studyData.streakHistory = [];
                    if (!studyData.weeklyPattern) studyData.weeklyPattern = [0, 0, 0, 0, 0, 0, 0];
                    if (!studyData.streakMilestones) studyData.streakMilestones = [3, 7, 14, 30, 60, 90];
                    
                    console.log("ðŸ“Š Loaded study data:", {
                        streak: studyData.streak,
                        hours: studyData.totalStudyHours,
                        sessions: studyData.studySessions?.length || 0,
                        dailyStats: studyData.dailyStats?.length || 0
                    });
                }
                
                // Load tasks with safety check
                if (data.tasks && Array.isArray(data.tasks)) {
                    tasks = data.tasks;
                    console.log("ðŸ“ Loaded tasks:", tasks.length);
                } else {
                    tasks = [];
                }
                
                // Load assignments with safety check
                if (data.assignments && Array.isArray(data.assignments)) {
                    assignments = data.assignments;
                    console.log("ðŸ“š Loaded assignments:", assignments.length);
                } else {
                    assignments = [];
                }
                
                // Load classes with safety check
                if (data.userClasses && Array.isArray(data.userClasses)) {
                    userClasses = data.userClasses;
                    console.log("ðŸ« Loaded classes:", userClasses.length);
                } else {
                    userClasses = [];
                }
                
                // Load current class
                if (data.currentClassCode) {
                    currentClassCode = data.currentClassCode;
                }
                
                if (data.selectedClassIndex !== undefined) {
                    selectedClassIndex = data.selectedClassIndex;
                }
                
                // Load current section
                if (data.currentSection) {
                    currentSection = data.currentSection;
                }
                
                // Load user info
                if (data.userName) {
                    currentUserName = data.userName;
                }
                
                if (data.userId && data.userId.startsWith('student_')) {
                    currentUserId = data.userId;
                    localStorage.setItem('studentUserId', currentUserId);
                    console.log("ðŸ‘¤ Loaded user ID from persisted data:", currentUserId);
                }
                
                console.log("âœ… Persisted data loaded successfully");
                return true;
            } else {
                console.log("âš ï¸ No compatible version found in persisted data");
            }
        }
    } catch (e) {
        console.error("âŒ Error loading persisted data:", e);
    }
    
    console.log("âš ï¸ No persisted data found, using defaults");
    return false;
}

// ========== FIREBASE DATABASE HELPERS ==========
function getDatabaseRef(path) {
    if (!database) return null;
    return database.ref(path);
}

async function firebaseGet(refPath) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated, using localStorage");
        return null;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        const snapshot = await ref.once('value');
        return snapshot.exists() ? snapshot.val() : null;
    } catch (error) {
        console.error(`âŒ Firebase get error at ${refPath}:`, error);
        return null;
    }
}

async function firebaseSet(refPath, data) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated, data saved locally only");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.set(data);
        return true;
    } catch (error) {
        console.error(`âŒ Firebase set error at ${refPath}:`, error);
        return false;
    }
}

async function firebaseUpdate(refPath, data) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated, data saved locally only");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.update(data);
        return true;
    } catch (error) {
        console.error(`âŒ Firebase update error at ${refPath}:`, error);
        return false;
    }
}

async function firebaseIncrement(refPath, maxVal = null) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated");
        return null;
    }

    return new Promise((resolve, reject) => {
        const ref = getDatabaseRef(refPath);
        ref.transaction((current) => {
            const base = parseInt(current || 0, 10) || 0;
            let next = base + 1;
            if (maxVal !== null) next = Math.min(next, maxVal);
            return next;
        }, (error, committed, snapshot) => {
            if (error) return reject(error);
            if (!committed) return resolve(snapshot ? snapshot.val() : null);
            return resolve(snapshot ? snapshot.val() : null);
        });
    });
}

async function firebaseRemove(refPath) {
    if (!database || !currentUser) {
        console.log("âš ï¸ Firebase not available or user not authenticated");
        return false;
    }
    
    try {
        const ref = getDatabaseRef(refPath);
        await ref.remove();
        return true;
    } catch (error) {
        console.error(`âŒ Firebase remove error at ${refPath}:`, error);
        return false;
    }
}

// ========== LIVE ACTIVITY FEED (STUDENT -> TEACHER) ==========
async function logLiveActivity(type, payload = {}) {
    if (!database || !currentUser || !currentUserId) return;

    const classCodes = [];
    if (currentClassCode) {
        classCodes.push(currentClassCode);
    } else if (userClasses && userClasses.length > 0) {
        userClasses.forEach(c => c.code && classCodes.push(c.code));
    }

    if (classCodes.length === 0) return;

    const activity = {
        type: type || 'activity',
        studentId: currentUserId,
        studentName: currentUserName || 'Student',
        firebaseUid: currentUser.uid || null,
        createdAt: new Date().toISOString(),
        ...payload
    };

    try {
        await Promise.all(classCodes.map(code => {
            const ref = database.ref(`classActivity/${code}`).push();
            return ref.set(activity);
        }));
    } catch (e) {
        console.warn("Live activity write failed:", e);
    }
}

// ========== QUICK NOTES + FOCUS MODE ==========
const QUICK_NOTES_KEY = 'studentQuickNotes';
const FOCUS_MODE_KEY = 'studentFocusMode';
let quickNotesSaveTimer = null;

function isTypingTarget(target) {
    return target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);
}

function updateQuickNotesStatus(text) {
    const statusEl = document.getElementById('quickNotesStatus');
    if (statusEl) statusEl.textContent = text;
}

function saveQuickNotes() {
    const input = document.getElementById('quickNotesInput');
    if (!input) return;

    localStorage.setItem(QUICK_NOTES_KEY, input.value);
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    updateQuickNotesStatus(`Saved ${time}`);
}

function initializeQuickNotes() {
    const input = document.getElementById('quickNotesInput');
    if (!input) return;

    input.value = localStorage.getItem(QUICK_NOTES_KEY) || '';
    updateQuickNotesStatus(input.value ? 'Loaded' : 'Saved');

    input.addEventListener('input', () => {
        updateQuickNotesStatus('Saving...');
        if (quickNotesSaveTimer) clearTimeout(quickNotesSaveTimer);
        quickNotesSaveTimer = setTimeout(saveQuickNotes, 400);
    });

    document.addEventListener('keydown', (e) => {
        if (e.shiftKey && e.key.toLowerCase() === 'n') {
            if (isTypingTarget(document.activeElement)) return;
            e.preventDefault();
            input.focus();
        }
    });
}

function copyQuickNotes() {
    const input = document.getElementById('quickNotesInput');
    if (!input) return;

    if (!input.value.trim()) {
        showNotification("Notes are empty.", "info");
        return;
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(input.value).then(() => {
            showNotification("Notes copied to clipboard.", "success");
        }).catch(() => {
            showNotification("Couldn't copy notes. Try again.", "error");
        });
        return;
    }

    const temp = document.createElement('textarea');
    temp.value = input.value;
    document.body.appendChild(temp);
    temp.select();
    try {
        document.execCommand('copy');
        showNotification("Notes copied to clipboard.", "success");
    } catch (err) {
        showNotification("Couldn't copy notes. Try again.", "error");
    } finally {
        document.body.removeChild(temp);
    }
}

function clearQuickNotes() {
    const input = document.getElementById('quickNotesInput');
    if (!input) return;

    if (!input.value.trim()) {
        showNotification("Notes are already empty.", "info");
        return;
    }

    input.value = '';
    saveQuickNotes();
    showNotification("Notes cleared.", "success");
}

function setFocusMode(isOn) {
    document.body.classList.toggle('focus-mode', isOn);
    localStorage.setItem(FOCUS_MODE_KEY, isOn ? 'true' : 'false');

    const btn = document.getElementById('focusModeBtn');
    if (btn) {
        btn.textContent = isOn ? 'Exit Focus' : 'Focus Portal';
        btn.title = 'Shift+F';
    }
    updateCommitmentUI();
}

function toggleFocusMode() {
    const entering = !document.body.classList.contains('focus-mode');
    setFocusMode(entering);
    if (entering) {
        playPortalSwoosh();
        triggerPortalEntry();
    }
}

function initializeFocusMode() {
    const saved = localStorage.getItem(FOCUS_MODE_KEY) === 'true';
    setFocusMode(saved);

    document.addEventListener('keydown', (e) => {
        if (e.shiftKey && e.key.toLowerCase() === 'f') {
            if (isTypingTarget(document.activeElement)) return;
            e.preventDefault();
            toggleFocusMode();
        }
    });
}

// ========== FOCUS TOOLKIT ==========
const FOCUS_STATE_KEY = 'studentFocusTimer';
const FOCUS_SESSIONS_KEY = 'studentFocusSessions';
const BRAIN_DUMP_KEY = 'studentBrainDump';
const BLOCKER_KEY = 'studentDistractionBlocker';
const BLOCKER_ENABLED_KEY = 'studentDistractionBlockerEnabled';
const FOCUS_GOAL_KEY = 'studentFocusGoal';
const IDENTITY_KEY = 'studentFutureIdentity';
const ENERGY_LOG_KEY = 'studentEnergyLog';
const RITUAL_KEY = 'studentRitualState';
const TREE_KEY = 'studentGrowthTreeLevel';
const TREE_LAST_KEY = 'studentGrowthTreeLastDate';
const TEACH_LAST_KEY = 'studentTeachLastDate';
const TEACH_AUDIO_KEY = 'studentTeachAudioDuration';
const FOCUS_COMMITMENT_KEY = 'studentFocusCommitment';
const EMERGENCY_UNLOCK_KEY = 'studentEmergencyUnlockAt';

let focusTimerState = {
    mode: 'focus',
    focusMinutes: 50,
    breakMinutes: 10,
    remainingSeconds: 3000,
    running: false
};
let focusTimerInterval = null;
let focusAudioContext = null;
let focusSoundNodes = [];
let fullscreenGuardActive = false;
let teachRecorder = null;
let teachAudioChunks = [];
let teachRecordingSeconds = 0;
let teachRecordingTimer = null;
let portalOverlayTimer = null;

function loadFocusTimerState() {
    const saved = localStorage.getItem(FOCUS_STATE_KEY);
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            focusTimerState = { ...focusTimerState, ...parsed };
        } catch (e) { /* ignore */ }
    }
}

function saveFocusTimerState() {
    localStorage.setItem(FOCUS_STATE_KEY, JSON.stringify(focusTimerState));
}

function formatTime(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = Math.max(0, seconds % 60);
    return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
}

function updateFocusTimerUI() {
    const display = document.getElementById('focusTimerDisplay');
    const modeEl = document.getElementById('focusTimerMode');
    const nextBreakEl = document.getElementById('focusNextBreak');
    if (display) display.textContent = formatTime(focusTimerState.remainingSeconds);
    if (modeEl) modeEl.textContent = focusTimerState.mode === 'focus' ? 'Focus' : 'Break';
    if (nextBreakEl) nextBreakEl.textContent = `${focusTimerState.breakMinutes}m`;
}

function getSessionsData() {
    const raw = localStorage.getItem(FOCUS_SESSIONS_KEY);
    if (!raw) return { sessionsByDate: {}, streak: 0 };
    try {
        return JSON.parse(raw);
    } catch (e) {
        return { sessionsByDate: {}, streak: 0 };
    }
}

function saveSessionsData(data) {
    localStorage.setItem(FOCUS_SESSIONS_KEY, JSON.stringify(data));
}

function getTodayKey() {
    return new Date().toISOString().slice(0, 10);
}

function updateFocusMetrics() {
    const data = getSessionsData();
    const today = getTodayKey();
    const todayCount = data.sessionsByDate[today] || 0;

    const sessionsEl = document.getElementById('focusSessionsToday');
    const streakEl = document.getElementById('focusStreak');
    if (sessionsEl) sessionsEl.textContent = todayCount;
    if (streakEl) streakEl.textContent = data.streak || 0;
    updateFocusGoalProgress(todayCount);
}

function getFocusGoal() {
    const stored = Number(localStorage.getItem(FOCUS_GOAL_KEY));
    return stored > 0 ? stored : 3;
}

function saveFocusGoal() {
    const input = document.getElementById('focusGoalInput');
    if (!input) return;
    const value = Math.max(1, Math.min(12, Number(input.value) || 3));
    localStorage.setItem(FOCUS_GOAL_KEY, String(value));
    updateFocusGoalProgress();
    showNotification("Focus goal updated.", "success");
}

function updateFocusGoalProgress(forcedCount) {
    const goal = getFocusGoal();
    const data = getSessionsData();
    const today = getTodayKey();
    const count = typeof forcedCount === 'number' ? forcedCount : (data.sessionsByDate[today] || 0);
    const progressEl = document.getElementById('focusGoalProgress');
    const msgEl = document.getElementById('focusGoalMessage');
    if (progressEl) progressEl.textContent = `${count} / ${goal}`;
    if (msgEl) msgEl.textContent = count >= goal ? 'Goal hit. Great work.' : `${goal - count} to go`;
}

function initializeFutureIdentity() {
    const input = document.getElementById('futureIdentityInput');
    const output = document.getElementById('futureIdentityText');
    if (!input || !output) return;
    const saved = localStorage.getItem(IDENTITY_KEY) || '';
    input.value = saved;
    output.textContent = saved ? `Youâ€™re building ${saved}.` : 'Youâ€™re building Future You.';
    input.addEventListener('input', () => {
        const value = input.value.trim();
        localStorage.setItem(IDENTITY_KEY, value);
        output.textContent = value ? `Youâ€™re building ${value}.` : 'Youâ€™re building Future You.';
    });
}

function saveFutureIdentity() {
    const input = document.getElementById('futureIdentityInput');
    const output = document.getElementById('futureIdentityText');
    if (!input || !output) return;
    const value = input.value.trim();
    localStorage.setItem(IDENTITY_KEY, value);
    output.textContent = value ? `Youâ€™re building ${value}.` : 'Youâ€™re building Future You.';
    showNotification("Identity saved.", "success");
}

function completeFocusSession() {
    const data = getSessionsData();
    const today = getTodayKey();
    data.sessionsByDate[today] = (data.sessionsByDate[today] || 0) + 1;

    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
    if (data.sessionsByDate[yesterday]) {
        data.streak = (data.streak || 0) + 1;
    } else if (!data.sessionsByDate[today] || data.sessionsByDate[today] === 1) {
        data.streak = 1;
    }

    saveSessionsData(data);
    updateFocusMetrics();
}

function tickFocusTimer() {
    if (!focusTimerState.running) return;
    focusTimerState.remainingSeconds -= 1;
    if (focusTimerState.remainingSeconds <= 0) {
        if (focusTimerState.mode === 'focus') {
            completeFocusSession();
            focusTimerState.mode = 'break';
            focusTimerState.remainingSeconds = focusTimerState.breakMinutes * 60;
            showNotification("Break time. Recharge quickly.", "info");
        } else {
            focusTimerState.mode = 'focus';
            focusTimerState.remainingSeconds = focusTimerState.focusMinutes * 60;
            showNotification("Back to focus. You got this.", "success");
        }
    }
    updateFocusTimerUI();
    saveFocusTimerState();
}

function startFocusTimer() {
    const focusInput = document.getElementById('focusMinutes');
    const breakInput = document.getElementById('breakMinutes');
    if (focusInput && breakInput) {
        focusTimerState.focusMinutes = Math.max(25, Number(focusInput.value) || 50);
        focusTimerState.breakMinutes = Math.max(5, Number(breakInput.value) || 10);
    }
    if (!focusTimerState.running) {
        focusTimerState.running = true;
        focusTimerInterval = setInterval(tickFocusTimer, 1000);
    }
    if (focusTimerState.remainingSeconds <= 0) {
        focusTimerState.remainingSeconds = focusTimerState.focusMinutes * 60;
    }
    saveFocusTimerState();
    updateFocusTimerUI();
}

function pauseFocusTimer() {
    focusTimerState.running = false;
    if (focusTimerInterval) {
        clearInterval(focusTimerInterval);
        focusTimerInterval = null;
    }
    saveFocusTimerState();
}

function resetFocusTimer() {
    pauseFocusTimer();
    focusTimerState.mode = 'focus';
    focusTimerState.remainingSeconds = focusTimerState.focusMinutes * 60;
    saveFocusTimerState();
    updateFocusTimerUI();
}

function renderBlockedSites() {
    const listEl = document.getElementById('blockedSitesList');
    if (!listEl) return;
    const raw = localStorage.getItem(BLOCKER_KEY);
    const items = raw ? raw.split(',').map(s => s.trim()).filter(Boolean) : [];
    listEl.innerHTML = items.length ? items.map(item => `<span>${item}</span>`).join('') : '<span>No sites listed yet.</span>';
}

function toggleDistractionBlocker() {
    const current = localStorage.getItem(BLOCKER_KEY) || '';
    const input = document.getElementById('blockedSitesInput');
    if (input && input.value.trim()) {
        localStorage.setItem(BLOCKER_KEY, input.value.trim());
    }
    const enabled = document.body.classList.toggle('focus-blocker-enabled');
    localStorage.setItem(BLOCKER_ENABLED_KEY, enabled ? 'true' : 'false');
    const btn = document.getElementById('blockerToggleBtn');
    if (btn) btn.textContent = enabled ? 'Disable Blocker' : 'Enable Blocker';
    if (enabled) {
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        enterFocusFullscreen();
    }
    if (!enabled) {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
        exitFocusFullscreen();
    }
    showNotification(enabled ? "Distraction blocker enabled." : "Distraction blocker disabled.", "info");
    renderBlockedSites();
}

function loadBlockerState() {
    const input = document.getElementById('blockedSitesInput');
    const saved = localStorage.getItem(BLOCKER_KEY);
    if (input && saved) input.value = saved;
    const enabled = localStorage.getItem(BLOCKER_ENABLED_KEY) === 'true';
    document.body.classList.toggle('focus-blocker-enabled', enabled);
    const btn = document.getElementById('blockerToggleBtn');
    if (btn) btn.textContent = enabled ? 'Disable Blocker' : 'Enable Blocker';
    if (enabled) {
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        enterFocusFullscreen();
    }
    renderBlockedSites();
}

function getCommitment() {
    const raw = localStorage.getItem(FOCUS_COMMITMENT_KEY);
    if (!raw) return null;
    try {
        return JSON.parse(raw);
    } catch (e) {
        return null;
    }
}

function setCommitment(commitment) {
    if (commitment) {
        localStorage.setItem(FOCUS_COMMITMENT_KEY, JSON.stringify(commitment));
    } else {
        localStorage.removeItem(FOCUS_COMMITMENT_KEY);
    }
    updateCommitmentUI();
}

function updateCommitmentUI() {
    const banner = document.getElementById('focusLockBanner');
    const status = document.getElementById('focusCommitStatus');
    const commitment = getCommitment();
    if (!commitment || Date.now() > commitment.endAt) {
        if (commitment && Date.now() > commitment.endAt) {
            setCommitment(null);
        }
        if (banner) banner.style.display = 'none';
        if (status) status.textContent = 'No active commitment';
        return;
    }
    const minutesLeft = Math.ceil((commitment.endAt - Date.now()) / 60000);
    if (banner) {
        banner.style.display = 'block';
        banner.textContent = `Locked in: ${commitment.topic} Â· ${minutesLeft} min remaining`;
    }
    if (status) status.textContent = `Active: ${commitment.topic}`;
}

function startFocusCommitment() {
    const topicInput = document.getElementById('focusTopic');
    const minutesInput = document.getElementById('focusCommitMinutes');
    const topic = topicInput ? topicInput.value.trim() : '';
    const minutes = minutesInput ? Number(minutesInput.value) : 0;
    if (!topic) {
        showNotification("Enter what you're studying first.", "error");
        return;
    }
    if (!minutes || minutes < 15) {
        showNotification("Commitment must be at least 15 minutes.", "error");
        return;
    }
    const commitment = {
        topic,
        startAt: Date.now(),
        endAt: Date.now() + minutes * 60000
    };
    setCommitment(commitment);
    setFocusMode(true);
    startFocusTimer();
    showNotification("Commitment locked in. Stay focused.", "success");
}

function requestEmergencyUnlock() {
    const unlockAt = Date.now() + 60000;
    localStorage.setItem(EMERGENCY_UNLOCK_KEY, String(unlockAt));
    updateEmergencyUnlockTimer();
    showNotification("Emergency unlock available in 60 seconds.", "warning");
}

function canExitFocusMode() {
    const commitment = getCommitment();
    const blockerEnabled = document.body.classList.contains('focus-blocker-enabled');
    const commitmentActive = commitment && Date.now() <= commitment.endAt;
    if (!commitmentActive && !blockerEnabled) {
        return true;
    }
    const unlockAt = Number(localStorage.getItem(EMERGENCY_UNLOCK_KEY)) || 0;
    if (unlockAt && Date.now() >= unlockAt) {
        return true;
    }
    if (!unlockAt) requestEmergencyUnlock();
    return false;
}

function updateEmergencyUnlockTimer() {
    const timerEl = document.getElementById('emergencyUnlockTimer');
    const unlockAt = Number(localStorage.getItem(EMERGENCY_UNLOCK_KEY)) || 0;
    if (!timerEl) return;
    if (!unlockAt) {
        timerEl.textContent = '';
        return;
    }
    const secondsLeft = Math.max(0, Math.ceil((unlockAt - Date.now()) / 1000));
    timerEl.textContent = secondsLeft > 0 ? `Unlock in ${secondsLeft}s` : 'Unlock ready';
}

function initializeEmergencyUnlockTicker() {
    setInterval(updateEmergencyUnlockTimer, 1000);
}

function toggleFocusMode() {
    if (document.body.classList.contains('focus-mode')) {
        if (!canExitFocusMode()) {
            showNotification("Commitment active. Emergency unlock required.", "warning");
            return;
        }
        localStorage.removeItem(EMERGENCY_UNLOCK_KEY);
        if (document.body.classList.contains('focus-blocker-enabled')) {
            showNotification("Disable the distraction blocker before exiting focus mode.", "warning");
            return;
        }
    }
    setFocusMode(!document.body.classList.contains('focus-mode'));
}

function createNoiseBuffer(context) {
    const bufferSize = 2 * context.sampleRate;
    const buffer = context.createBuffer(1, bufferSize, context.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i += 1) {
        data[i] = Math.random() * 2 - 1;
    }
    return buffer;
}

function stopFocusSound() {
    focusSoundNodes.forEach(node => {
        try { node.stop && node.stop(); } catch (e) { /* ignore */ }
        try { node.disconnect && node.disconnect(); } catch (e) { /* ignore */ }
    });
    focusSoundNodes = [];
    if (focusAudioContext) {
        focusAudioContext.close().catch(() => {});
        focusAudioContext = null;
    }
    document.querySelectorAll('.sound-chip').forEach(btn => btn.classList.remove('active'));
}

function startFocusSound(type) {
    stopFocusSound();
    focusAudioContext = new (window.AudioContext || window.webkitAudioContext)();
    const gain = focusAudioContext.createGain();
    const volume = document.getElementById('soundVolume');
    gain.gain.value = volume ? Number(volume.value) / 100 : 0.35;
    gain.connect(focusAudioContext.destination);

    if (type === 'music') {
        const osc1 = focusAudioContext.createOscillator();
        const osc2 = focusAudioContext.createOscillator();
        osc1.type = 'sine';
        osc2.type = 'triangle';
        osc1.frequency.value = 220;
        osc2.frequency.value = 330;
        osc1.connect(gain);
        osc2.connect(gain);
        osc1.start();
        osc2.start();
        focusSoundNodes.push(osc1, osc2, gain);
    } else {
        const noise = focusAudioContext.createBufferSource();
        noise.buffer = createNoiseBuffer(focusAudioContext);
        noise.loop = true;
        const filter = focusAudioContext.createBiquadFilter();
        filter.type = type === 'brown' ? 'lowpass' : 'bandpass';
        filter.frequency.value = type === 'rain' ? 800 : 1200;
        noise.connect(filter);
        filter.connect(gain);
        noise.start();
        focusSoundNodes.push(noise, filter, gain);
    }

    document.querySelectorAll('.sound-chip').forEach(btn => {
        const label = btn.textContent.toLowerCase();
        if ((type === 'music' && label.includes('instrumental')) || (type !== 'music' && label.includes(type))) {
            btn.classList.add('active');
        }
    });
}

function updateSoundVolume() {
    const volume = document.getElementById('soundVolume');
    if (!volume || !focusAudioContext) return;
    focusSoundNodes.forEach(node => {
        if (node.gain) node.gain.value = Number(volume.value) / 100;
    });
}

function loadBrainDump() {
    const raw = localStorage.getItem(BRAIN_DUMP_KEY);
    if (!raw) return [];
    try {
        return JSON.parse(raw);
    } catch (e) {
        return [];
    }
}

function saveBrainDump(items) {
    localStorage.setItem(BRAIN_DUMP_KEY, JSON.stringify(items));
}

function renderBrainDump() {
    const list = document.getElementById('brainDumpList');
    if (!list) return;
    const items = loadBrainDump();
    list.innerHTML = items.length ? items.map((item, index) => `
        <div class="brain-dump-item">
          <span>${escapeHtml(item)}</span>
          <button class="btn btn-secondary" onclick="removeBrainDumpItem(${index})">Done</button>
        </div>
    `).join('') : '<div style="color: var(--text-muted); font-size: 0.85rem;">Nothing dumped yet.</div>';
}

function addBrainDumpItem() {
    const input = document.getElementById('brainDumpInput');
    if (!input) return;
    const text = input.value.trim();
    if (!text) return;
    const items = loadBrainDump();
    items.unshift(text);
    saveBrainDump(items);
    input.value = '';
    renderBrainDump();
}

function removeBrainDumpItem(index) {
    const items = loadBrainDump();
    items.splice(index, 1);
    saveBrainDump(items);
    renderBrainDump();
}

function clearBrainDump() {
    saveBrainDump([]);
    renderBrainDump();
}

function initializeFocusToolkit() {
    loadFocusTimerState();
    if (!focusTimerState.running) {
        focusTimerState.remainingSeconds = (focusTimerState.mode === 'break' ? focusTimerState.breakMinutes : focusTimerState.focusMinutes) * 60;
        saveFocusTimerState();
    }
    const focusInput = document.getElementById('focusMinutes');
    const breakInput = document.getElementById('breakMinutes');
    if (focusInput) focusInput.value = focusTimerState.focusMinutes;
    if (breakInput) breakInput.value = focusTimerState.breakMinutes;
    updateFocusTimerUI();
    updateFocusMetrics();
    updateCommitmentUI();
    loadBlockerState();
    renderBrainDump();
    initializeEmergencyUnlockTicker();

    const goalInput = document.getElementById('focusGoalInput');
    if (goalInput) {
        goalInput.value = getFocusGoal();
        updateFocusGoalProgress();
    }

    initializeFutureIdentity();

    if (focusTimerState.running && !focusTimerInterval) {
        focusTimerInterval = setInterval(tickFocusTimer, 1000);
    }

    const soundVolume = document.getElementById('soundVolume');
    if (soundVolume) soundVolume.addEventListener('input', updateSoundVolume);

    const brainInput = document.getElementById('brainDumpInput');
    if (brainInput) {
        brainInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBrainDumpItem();
            }
        });
    }

    const blockedInput = document.getElementById('blockedSitesInput');
    if (blockedInput) {
        blockedInput.addEventListener('change', () => {
            if (blockedInput.value.trim()) {
                localStorage.setItem(BLOCKER_KEY, blockedInput.value.trim());
            }
            renderBlockedSites();
        });
    }

    initializeEnergyTracker();
    initializeRitualBuilder();
    updateGrowthTreeUI();

    document.addEventListener('fullscreenchange', () => {
        if (document.body.classList.contains('focus-blocker-enabled') && !document.fullscreenElement) {
            enterFocusFullscreen();
        }
    });

    window.addEventListener('beforeunload', (e) => {
        if (document.body.classList.contains('focus-blocker-enabled')) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
}

function playPortalSwoosh() {
    const audio = document.getElementById('portalSwoosh');
    const tryPlay = (el) => {
        if (!el) return false;
        el.currentTime = 0;
        el.volume = 0.7;
        el.play().catch(() => {});
        return true;
    };
    if (tryPlay(audio)) return;
    const fallback = new Audio('portal.mp3');
    fallback.volume = 0.7;
    fallback.play().catch(() => {});
}

function triggerPortalEntry() {
    const overlay = document.getElementById('portalOverlay');
    if (!overlay) return;
    overlay.classList.remove('active');
    void overlay.offsetWidth;
    overlay.classList.add('active');
    if (portalOverlayTimer) clearTimeout(portalOverlayTimer);
    portalOverlayTimer = setTimeout(() => {
        overlay.classList.remove('active');
    }, 1800);
}

// ===== Mental Energy Tracker =====
function getEnergyLog() {
    const raw = localStorage.getItem(ENERGY_LOG_KEY);
    if (!raw) return [];
    try {
        return JSON.parse(raw);
    } catch (e) {
        return [];
    }
}

function saveEnergyLog(entries) {
    localStorage.setItem(ENERGY_LOG_KEY, JSON.stringify(entries));
}

function logEnergy(score) {
    const entries = getEnergyLog();
    entries.push({ score, hour: new Date().getHours(), ts: Date.now() });
    saveEnergyLog(entries);
    updateEnergyInsight();
    showNotification("Energy logged.", "success");
}

function getPeakHour(entries) {
    const buckets = {};
    entries.forEach(entry => {
        if (!buckets[entry.hour]) buckets[entry.hour] = { total: 0, count: 0 };
        buckets[entry.hour].total += entry.score;
        buckets[entry.hour].count += 1;
    });
    let bestHour = null;
    let bestAvg = -1;
    Object.keys(buckets).forEach(hourKey => {
        const avg = buckets[hourKey].total / buckets[hourKey].count;
        if (avg > bestAvg) {
            bestAvg = avg;
            bestHour = Number(hourKey);
        }
    });
    return { hour: bestHour, avg: bestAvg };
}

function updateEnergyInsight() {
    const insightEl = document.getElementById('energyInsight');
    const hardestInput = document.getElementById('hardestSubjectInput');
    if (!insightEl) return;
    const entries = getEnergyLog();
    if (entries.length < 3) {
        insightEl.textContent = 'Log a few sessions to find your peak hour.';
        return;
    }
    const peak = getPeakHour(entries);
    if (peak.hour === null) return;
    const nowHour = new Date().getHours();
    const subject = hardestInput ? hardestInput.value.trim() : '';
    if (nowHour === peak.hour && subject) {
        insightEl.textContent = `Peak hour now. Tackle: ${subject}.`;
    } else {
        insightEl.textContent = `Peak hour: ${peak.hour}:00 (${peak.avg.toFixed(1)}/5). Schedule hard work then.`;
    }
}

function initializeEnergyTracker() {
    const hardestInput = document.getElementById('hardestSubjectInput');
    if (hardestInput) {
        const saved = localStorage.getItem('studentHardestSubject') || '';
        hardestInput.value = saved;
        hardestInput.addEventListener('input', () => {
            localStorage.setItem('studentHardestSubject', hardestInput.value.trim());
            updateEnergyInsight();
        });
    }
    updateEnergyInsight();
}

// ===== Study Ritual Builder =====
function loadRitualState() {
    const raw = localStorage.getItem(RITUAL_KEY);
    if (!raw) return { sound: false, water: false, stretch: false, desk: false };
    try {
        return JSON.parse(raw);
    } catch (e) {
        return { sound: false, water: false, stretch: false, desk: false };
    }
}

function saveRitualState(state) {
    localStorage.setItem(RITUAL_KEY, JSON.stringify(state));
}

function initializeRitualBuilder() {
    const state = loadRitualState();
    const map = [
        { key: 'sound', id: 'ritualSound' },
        { key: 'water', id: 'ritualWater' },
        { key: 'stretch', id: 'ritualStretch' },
        { key: 'desk', id: 'ritualDesk' }
    ];
    map.forEach(item => {
        const el = document.getElementById(item.id);
        if (!el) return;
        el.checked = Boolean(state[item.key]);
        el.addEventListener('change', () => {
            const updated = loadRitualState();
            updated[item.key] = el.checked;
            saveRitualState(updated);
        });
    });
}

function completeRitual() {
    const status = document.getElementById('ritualStatus');
    if (status) status.textContent = 'Ritual complete. Ready to focus.';
    showNotification("Ritual complete. Start your session.", "success");
}

function resetRitual() {
    saveRitualState({ sound: false, water: false, stretch: false, desk: false });
    initializeRitualBuilder();
    const status = document.getElementById('ritualStatus');
    if (status) status.textContent = 'Ritual not started';
}

// ===== Growth Tree (shared) =====
function getTreeLevel() {
    return Number(localStorage.getItem(TREE_KEY)) || 0;
}

function setTreeLevel(level) {
    localStorage.setItem(TREE_KEY, String(Math.max(0, level)));
}

function applyTreeDecay() {
    const last = localStorage.getItem(TREE_LAST_KEY);
    if (!last) return;
    const lastDate = new Date(last);
    const today = new Date();
    const diffDays = Math.floor((today - lastDate) / 86400000);
    if (diffDays >= 1) {
        const newLevel = Math.max(0, getTreeLevel() - diffDays);
        setTreeLevel(newLevel);
        localStorage.setItem(TREE_LAST_KEY, today.toISOString().slice(0, 10));
    }
}

function getTreeEmoji(level) {
    if (level <= 0) return 'ðŸŒ±';
    if (level <= 2) return 'ðŸŒ¿';
    if (level <= 4) return 'ðŸŒ³';
    if (level <= 7) return 'ðŸŒ²';
    return 'ðŸŒ´';
}

function updateGrowthTreeUI() {
    applyTreeDecay();
    const level = getTreeLevel();
    const treeEl = document.getElementById('growthTree');
    const statusEl = document.getElementById('growthTreeStatus');
    if (treeEl) treeEl.textContent = getTreeEmoji(level);
    if (statusEl) statusEl.textContent = `Tree level: ${level}. Complete Learn By Teaching to grow.`;
}

function growTree() {
    const level = getTreeLevel() + 1;
    setTreeLevel(level);
    localStorage.setItem(TREE_LAST_KEY, new Date().toISOString().slice(0, 10));
    updateGrowthTreeUI();
}

// ===== Learn By Teaching =====
function countTeachBullets() {
    let count = 0;
    for (let i = 1; i <= 5; i += 1) {
        const el = document.getElementById(`teachBullet${i}`);
        if (el && el.value.trim()) count += 1;
    }
    return count;
}

async function toggleTeachRecording() {
    const btn = document.getElementById('teachRecordBtn');
    const status = document.getElementById('teachRecordStatus');
    if (!btn || !status) return;
    if (teachRecorder && teachRecorder.state === 'recording') {
        teachRecorder.stop();
        return;
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        teachRecorder = new MediaRecorder(stream);
        teachAudioChunks = [];
        teachRecordingSeconds = 0;
        status.textContent = 'Recording...';
        btn.textContent = 'Stop Recording';
        teachRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) teachAudioChunks.push(e.data);
        };
        teachRecorder.onstop = () => {
            stream.getTracks().forEach(track => track.stop());
            const blob = new Blob(teachAudioChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            const audioEl = document.getElementById('teachPlayback');
            if (audioEl) {
                audioEl.src = url;
                audioEl.style.display = 'block';
            }
            localStorage.setItem(TEACH_AUDIO_KEY, String(teachRecordingSeconds));
            status.textContent = `Recorded ${teachRecordingSeconds}s`;
            btn.textContent = 'Start Recording';
            if (teachRecordingTimer) clearInterval(teachRecordingTimer);
            teachRecordingTimer = null;
        };
        teachRecorder.start();
        teachRecordingTimer = setInterval(() => {
            teachRecordingSeconds += 1;
            status.textContent = `Recording... ${teachRecordingSeconds}s`;
        }, 1000);
    } catch (err) {
        showNotification("Microphone permission needed for recording.", "error");
    }
}

function completeTeachMode() {
    const bullets = countTeachBullets();
    const recordingSeconds = Number(localStorage.getItem(TEACH_AUDIO_KEY)) || 0;
    if (bullets < 5 && recordingSeconds < 60) {
        showNotification("Add 5 bullets or record 60 seconds.", "warning");
        return;
    }
    localStorage.setItem(TEACH_LAST_KEY, new Date().toISOString().slice(0, 10));
    growTree();
    const status = document.getElementById('teachModeStatus');
    if (status) status.textContent = 'Great explanation. Tree grew.';
    showNotification("Teach mode complete. Tree grew.", "success");
}

function enterFocusFullscreen() {
    if (fullscreenGuardActive) return;
    fullscreenGuardActive = true;
    document.body.classList.add('focus-fullscreen');
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(() => {});
    }
    setTimeout(() => { fullscreenGuardActive = false; }, 500);
}

function exitFocusFullscreen() {
    document.body.classList.remove('focus-fullscreen');
    if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen().catch(() => {});
    }
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', async function() {
    console.log("ðŸŽ“ Student Mode initializing...");
    
    // FIRST: Load persisted data BEFORE Firebase initialization
    initLocalStorageSchema();
    const dataLoaded = loadPersistedData();
    console.log("ðŸ“‚ Data loaded from localStorage:", dataLoaded);
    
    try {
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        auth = firebase.auth();
        
        console.log("âœ… Firebase initialized successfully");
        
        // Check if we have a user ID from persisted data
        if (!currentUserId) {
            const savedUserId = localStorage.getItem('studentUserId');
            if (savedUserId && savedUserId.startsWith('student_')) {
                currentUserId = savedUserId;
                console.log("ðŸ†” Loaded user ID from localStorage:", currentUserId);
            } else {
                currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('studentUserId', currentUserId);
                console.log("ðŸ†• Generated new persistent user ID:", currentUserId);
            }
        }
        
        // Set user name from persisted data or localStorage
        const savedName = localStorage.getItem('studentName');
        if (savedName) {
            currentUserName = savedName;
        }
        
        console.log("ðŸ‘¤ Current user info:", {
            id: currentUserId,
            name: currentUserName,
            streak: studyData.streak,
            hours: studyData.totalStudyHours
        });

        captureReferralFromUrl();
        
        try {
            // Try anonymous authentication
            console.log("ðŸ” Attempting anonymous sign-in...");
            const userCredential = await auth.signInAnonymously();
            currentUser = userCredential.user;
            
            console.log("âœ… Anonymous authentication successful");
            console.log("ðŸ“ Firebase UID:", currentUser.uid);
            console.log("ðŸ“ Our Student ID:", currentUserId);
            
            localStorage.setItem('studentFirebaseUid', currentUser.uid);
            retryPendingReferralCredit();
            
        } catch (authError) {
            console.error("âŒ Anonymous sign-in failed:", authError);
            console.log("âš ï¸ Using offline mode only");
            showNotification("âš ï¸ Working in offline mode. Data saved locally.", "warning");
        }

        await syncReferralCountFromFirebase();
        setupReferralNotifications();
        
        // Initialize the app
        initUI();
        loadAllData();
        setupEventListeners();
        initializeQuickNotes();
        initializeFocusMode();
        initializeFocusToolkit();
        setupAutoSave();
        setupChartAutoRefresh();
        



      


        // Update UI with loaded data
        updateUI();
        updateStreakUI();
        updateAllStatistics();
        
        console.log("ðŸŽ“ Student Mode ready!");
        console.log("ðŸ“Š Loaded data:", {
            streak: studyData.streak,
            hours: studyData.totalStudyHours,
            tasks: tasks.length,
            assignments: assignments.length,
            classes: userClasses.length
        });
        
        setTimeout(() => {
            showNotification(`Welcome back, ${currentUserName}! ðŸ“š Streak: ${studyData.streak} days`, "success");
        }, 1000);
        
    } catch (error) {
        console.error("âŒ Initialization error:", error);
        
        // Fallback: Ensure we have a user ID even if everything fails
        if (!currentUserId) {
            const savedUserId = localStorage.getItem('studentUserId');
            if (savedUserId && savedUserId.startsWith('student_')) {
                currentUserId = savedUserId;
            } else {
                currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('studentUserId', currentUserId);
            }
        }
        
        // Initialize in offline mode
        initUI();
        loadAllData();
        setupEventListeners();
        setupAutoSave();
        setupChartAutoRefresh();
        
        updateUI();
        updateStreakUI();
        updateAllStatistics();
        
        showNotification("âš ï¸ Working in offline mode. Data saved locally.", "warning");
    }
      // Initialize memory wall functions
    console.log("Initializing memory wall system...");
    
    // Check if student memory wall exists
    const studentMemoryWall = document.getElementById('studentMemoryWall');
    if (studentMemoryWall) {
        console.log("Student memory wall system ready");
    }
});

// ========== AUTO-SAVE SYSTEM ==========
function setupAutoSave() {
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            persistData();
        }
    });
    
    window.addEventListener('beforeunload', function() {
        persistData();
    });
    
    setInterval(persistData, 30000);
    
    console.log("ðŸ’¾ Auto-save system initialized");
}

// ========== CHART AUTO-REFRESH ==========
function setupChartAutoRefresh() {
    if (chartRefreshInterval) {
        clearInterval(chartRefreshInterval);
    }
    
    chartRefreshInterval = setInterval(() => {
        if (currentSection === 'statistics') {
            console.log("ðŸ”„ Auto-refreshing charts...");
            refreshChartsSilently();
        }
    }, 300000);
    
    console.log("ðŸ“ˆ Chart auto-refresh system initialized");
}

function refreshChartsSilently() {
    if (currentSection === 'statistics') {
        updateCharts();
        updateSyncStatus("Charts updated", "success");
    }
}

// ========== USER DATA MANAGEMENT ==========
function loadUserData() {
    const savedUserId = localStorage.getItem('studentUserId');
    if (savedUserId && savedUserId.startsWith('student_')) {
        currentUserId = savedUserId;
    } else if (!currentUserId) {
        currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('studentUserId', currentUserId);
    }
    
    currentUserName = localStorage.getItem('studentName') || 'Student';
    
    const savedClasses = localStorage.getItem('studentUserClasses');
    if (savedClasses) {
        try {
            userClasses = JSON.parse(savedClasses);
            console.log(`ðŸ“š Loaded ${userClasses.length} classes from localStorage`);
            
            if (userClasses.length > 0 && !currentClassCode) {
                currentClassCode = userClasses[0].code;
                selectedClassIndex = 0;
            }
        } catch (e) {
            console.error("Error parsing user classes:", e);
            userClasses = [];
        }
    }
    
    const nameField = document.getElementById('studentName');
    if (nameField) nameField.value = currentUserName;
    
    const profileNameField = document.getElementById('profileName');
    if (profileNameField) profileNameField.value = currentUserName;
}

function saveUserData() {
    if (currentUserId) {
        localStorage.setItem('studentUserId', currentUserId);
    }
    
    if (currentUserName) {
        localStorage.setItem('studentName', currentUserName);
    }
    
    if (userClasses.length > 0) {
        localStorage.setItem('studentUserClasses', JSON.stringify(userClasses));
    }
    
    persistData();
    
    console.log("ðŸ’¾ User data saved:", {
        userId: currentUserId,
        name: currentUserName,
        classesCount: userClasses.length
    });
}

// ========== IMPROVED STREAK SYSTEM ==========
function updateStreakUI() {
    const streakNumber = document.getElementById('streakNumber');
    const streakLabel = document.getElementById('streakLabel');
    const streakProgressFill = document.getElementById('streakProgressFill');
    const streakMilestones = document.getElementById('streakMilestones');
    const nextMilestone = document.getElementById('nextMilestone');
    
    if (!streakNumber) return;
    
    streakNumber.textContent = studyData.streak || 0;
    
    let streakEmoji = "ðŸ“ˆ";
    if (studyData.streak >= 30) streakEmoji = "ðŸ†";
    else if (studyData.streak >= 14) streakEmoji = "ðŸ”¥";
    else if (studyData.streak >= 7) streakEmoji = "âœ¨";
    else if (studyData.streak >= 3) streakEmoji = "â­";
    
    streakLabel.textContent = `${streakEmoji} ${studyData.streak || 0} DAY STREAK`;
    
    let nextMilestoneDay = studyData.streakMilestones.find(milestone => milestone > studyData.streak) || studyData.streakMilestones[studyData.streakMilestones.length - 1];
    let currentMilestoneIndex = studyData.streakMilestones.findIndex(milestone => milestone > studyData.streak) - 1;
    
    if (currentMilestoneIndex < 0) {
        currentMilestoneIndex = studyData.streakMilestones.length - 1;
    }
    
    let progressPercentage = 0;
    if (nextMilestoneDay) {
        progressPercentage = ((studyData.streak || 0) / nextMilestoneDay) * 100;
        if (progressPercentage > 100) progressPercentage = 100;
    }
    streakProgressFill.style.width = `${progressPercentage}%`;
    
    let milestonesHTML = '';
    studyData.streakMilestones.forEach((milestone, index) => {
        const isActive = studyData.streak >= milestone;
        const isCurrent = index === currentMilestoneIndex;
        milestonesHTML += `<div class="milestone ${isActive ? 'active' : ''} ${isCurrent ? 'current' : ''}" title="${milestone} days"></div>`;
    });
    streakMilestones.innerHTML = milestonesHTML;
    
    if (nextMilestoneDay) {
        const daysLeft = nextMilestoneDay - (studyData.streak || 0);
        nextMilestone.textContent = `${nextMilestoneDay} days (${daysLeft} to go)`;
    } else {
        nextMilestone.textContent = "Maximum milestone reached! ðŸŽ‰";
    }
    
    updateStreakButton();

    if ((studyData.streak || 0) >= 30) {
        const unlocked = localStorage.getItem(RAINBOW_UNLOCKED_KEY) === 'true';
        if (!unlocked) {
            localStorage.setItem(RAINBOW_UNLOCKED_KEY, 'true');
            showNotification("ðŸŒˆ Rainbow theme unlocked for your 30â€‘day streak!", "success");
        }
    }

    if ((studyData.streak || 0) >= 7) {
        const forestUnlocked = localStorage.getItem(FOREST_UNLOCKED_KEY) === 'true';
        if (!forestUnlocked) {
            localStorage.setItem(FOREST_UNLOCKED_KEY, 'true');
            showNotification("ðŸŒ² Forest theme unlocked for your 7â€‘day streak!", "success");
        }
    }

    updateRainbowUI();
}

function getTodayKey() {
    const today = new Date();
    return today.toDateString();
}

function isConsecutiveDay(lastDateString, currentDateString) {
    if (!lastDateString) return false;
    
    const lastDate = new Date(lastDateString);
    const currentDate = new Date(currentDateString);
    
    const diffTime = Math.abs(currentDate - lastDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays === 1;
}

async function markStudyToday() {
    console.log("ðŸ”¥ markStudyToday() called");
    
    const todayKey = getTodayKey();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayKey = yesterday.toDateString();
    
    if (studyData.lastStudyDate === todayKey) {
        showNotification("You've already marked study for today! Come back tomorrow.", "info");
        updateStreakButton();
        return;
    }
    
    let message = "";
    let messageType = "success";
    
    if (!studyData.lastStudyDate) {
        studyData.streak = 1;
        message = "ðŸŽ‰ First study day! Starting your streak!";
    } else if (studyData.lastStudyDate === yesterdayKey || isConsecutiveDay(studyData.lastStudyDate, todayKey)) {
        studyData.streak = (studyData.streak || 0) + 1;
        message = `ðŸ”¥ Streak continued! Now at ${studyData.streak} days!`;
        
        const milestoneAchieved = studyData.streakMilestones.find(milestone => milestone === studyData.streak);
        if (milestoneAchieved) {
            message = `ðŸ† MILESTONE ACHIEVED! ${milestoneAchieved}-day streak! Keep going!`;
            messageType = "warning";
        }
    } else {
        const lastDate = new Date(studyData.lastStudyDate);
        const today = new Date();
        const diffTime = Math.abs(today - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays > 1) {
            message = `â° You missed ${diffDays - 1} day(s). Starting new streak.`;
            messageType = "warning";
        } else {
            message = "ðŸ”„ Starting new streak today!";
        }
        studyData.streak = 1;
    }
    
    studyData.lastStudyDate = todayKey;
    studyData.totalStudyDays = (studyData.totalStudyDays || 0) + 1;
    
    if (!studyData.streakHistory) studyData.streakHistory = [];
    studyData.streakHistory.push({
        date: todayKey,
        streak: studyData.streak
    });
    
    const dayOfWeek = new Date().getDay();
    if (!studyData.weeklyPattern) studyData.weeklyPattern = [0, 0, 0, 0, 0, 0, 0];
    studyData.weeklyPattern[dayOfWeek] = (studyData.weeklyPattern[dayOfWeek] || 0) + 1;
    
    // Add a study session
    const sessionHours = 1.0; // Default 1 hour for daily streak
    const focusScore = calculateFocusScore();
    const consistencyScore = calculateConsistencyScore();
    
    if (!studyData.studySessions) studyData.studySessions = [];
    studyData.studySessions.push({
        date: new Date().toISOString(),
        hours: sessionHours,
        baseHours: sessionHours,
        bonusHours: 0,
        streak: studyData.streak
    });
    
    // Update daily stats
    if (!studyData.dailyStats) studyData.dailyStats = [];
    const todayStats = studyData.dailyStats.find(s => s.date === todayKey);
    if (todayStats) {
        todayStats.sessions = (todayStats.sessions || 0) + 1;
        todayStats.hours = (todayStats.hours || 0) + sessionHours;
        todayStats.focusScore = focusScore;
        todayStats.consistencyScore = consistencyScore;
    } else {
        studyData.dailyStats.unshift({
            date: todayKey,
            sessions: 1,
            hours: sessionHours,
            focusScore: focusScore,
            consistencyScore: consistencyScore
        });
        
        if (!studyData.focusScores) studyData.focusScores = [];
        studyData.focusScores.unshift({
            date: todayKey,
            score: focusScore
        });
        
        if (!studyData.consistencyScores) studyData.consistencyScores = [];
        studyData.consistencyScores.unshift({
            date: todayKey,
            score: consistencyScore
        });
        updateDailyGoalUI();

        // Keep only last 30 days
        if (studyData.dailyStats.length > 30) {
            studyData.dailyStats = studyData.dailyStats.slice(0, 30);
        }
        if (studyData.focusScores.length > 30) {
            studyData.focusScores = studyData.focusScores.slice(0, 30);
        }
        if (studyData.consistencyScores.length > 30) {
            studyData.consistencyScores = studyData.consistencyScores.slice(0, 30);
        }
        updateDailyGoalUI();

    }
    
    // Update total hours
    studyData.totalMinutes = (studyData.totalMinutes || 0) + sessionHours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);

    await logLiveActivity('streak_reached', {
        streak: studyData.streak || 0
    });
    
    persistData();
    await maybeCreditReferral();
    updateUI();
    updateSidebarStats();
    updateStreakUI();
    updateAllStatistics();
    
    updateSyncStatus("Saving to all classes...", "syncing");
    await saveStudyDataToFirebase();
    
    showNotification(message, messageType);
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        updateSyncStatus("Saved successfully!", "success");
    }, 1500);
}

function updateStreakButton() {
    const streakBtn = document.getElementById('streakButton');
    const streakMessage = document.getElementById('streakMessage');
    const lastStudyDate = document.getElementById('lastStudyDate');
    
    if (!streakBtn) return;
    
    const todayKey = getTodayKey();
    
    if (studyData.lastStudyDate === todayKey) {
        streakBtn.disabled = true;
        streakBtn.innerHTML = '<span>âœ… Already Marked Today</span>';
        streakBtn.style.background = 'var(--success)';
        streakBtn.style.opacity = '0.8';
        
        if (streakMessage) {
            streakMessage.textContent = `Come back tomorrow to continue your ${studyData.streak || 0}-day streak!`;
            streakMessage.style.color = 'white';
        }
        
        if (lastStudyDate) {
            lastStudyDate.textContent = studyData.lastStudyDate || 'Never';
        }
    } else {
        streakBtn.disabled = false;
        streakBtn.innerHTML = '<span>ðŸ”¥ Mark Study Today</span>';
        streakBtn.style.background = '';
        streakBtn.style.opacity = '1';
        
        if (streakMessage) {
            if (studyData.streak > 0) {
                streakMessage.textContent = `Current streak: ${studyData.streak} days. Keep it going!`;
            } else {
                streakMessage.textContent = `Start a new study streak today!`;
            }
            streakMessage.style.color = 'white';
        }
        
        if (lastStudyDate) {
            if (studyData.lastStudyDate) {
                lastStudyDate.textContent = studyData.lastStudyDate;
            } else {
                lastStudyDate.textContent = 'Never';
            }
        }
    }
}


// ========== DAILY GOAL TRACKER ==========

function getTodaySessionsCount() {
    const todayKey = new Date().toDateString();
    if (!studyData.dailyStats) return 0;
    const todayStats = studyData.dailyStats.find(s => s.date === todayKey);
    return todayStats ? (todayStats.sessions || 0) : 0;
}

function updateDailyGoalUI() {
    const count = getTodaySessionsCount();

    const goalText = document.getElementById('dailyGoalText');
    const goalTarget = document.getElementById('dailyGoalTarget');
    const goalCount = document.getElementById('dailyGoalCount');
    const goalFill = document.getElementById('dailyGoalFill');
    const goalMsg = document.getElementById('dailyGoalMessage');
    const celebrateBtn = document.getElementById('celebrateGoalBtn');

    if (!goalText || !goalTarget || !goalCount || !goalFill || !goalMsg || !celebrateBtn) return;

    const target = getDailyGoalTarget();
    goalText.textContent = target;
    goalTarget.textContent = target;
    goalCount.textContent = count;

    const progress = Math.min(100, (count / target) * 100);
    goalFill.style.width = `${progress}%`;

    if (count >= target) {
        goalMsg.textContent = "ðŸŽ‰ Goal achieved! Amazing work!";
        celebrateBtn.style.display = 'block';
        celebrateBtn.classList.add('pulse');
    } else {
goalMsg.textContent = `You're doing great! ${target - count} to go ðŸš€`;

        celebrateBtn.style.display = 'none';
        celebrateBtn.classList.remove('pulse');
            }
}


function maybeCelebrateGoal() {
    const todayKey = new Date().toDateString();
    const storageKey = `dailyGoalCelebrated_${todayKey}`;

    if (localStorage.getItem(storageKey)) return;

    localStorage.setItem(storageKey, "true");
    triggerConfetti();
}

function triggerConfetti() {
    const layer = document.getElementById('confettiLayer');
    if (!layer) return;

    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#22c55e'];

    for (let i = 0; i < 120; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.5) + 's';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.width = (6 + Math.random() * 6) + 'px';
        confetti.style.height = (10 + Math.random() * 8) + 'px';
        confetti.style.animationDuration = (5.5 + Math.random() * 1.5) + 's';

        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 8000);
    }
}

function triggerConfettiBurst() {
    const layer = document.getElementById('confettiLayer');
    if (!layer) return;

    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#22c55e'];

    playCelebrateSound();

    // Big center burst
    for (let i = 0; i < 160; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti burst';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.05) + 's';
        confetti.style.width = (6 + Math.random() * 8) + 'px';
        confetti.style.height = (10 + Math.random() * 10) + 'px';
        confetti.style.animationDuration = (1.6 + Math.random() * 0.8) + 's';
        confetti.style.setProperty('--x', `${(Math.random() * 2 - 1) * 420}px`);
        confetti.style.setProperty('--y', `${(Math.random() * 2 - 1) * 380}px`);
        if (Math.random() < 0.25) confetti.classList.add('sparkle');
        layer.appendChild(confetti);

        setTimeout(() => confetti.remove(), 2500);
    }

    // Side bursts for extra impact
    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti burst';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.1) + 's';
        confetti.style.width = (5 + Math.random() * 7) + 'px';
        confetti.style.height = (8 + Math.random() * 9) + 'px';
        confetti.style.animationDuration = (1.4 + Math.random() * 0.8) + 's';
        confetti.style.left = '15%';
        confetti.style.top = '55%';
        confetti.style.setProperty('--x', `${(Math.random() * 2 - 1) * 260}px`);
        confetti.style.setProperty('--y', `${(Math.random() * 2 - 1) * 260}px`);
        if (Math.random() < 0.3) confetti.classList.add('sparkle');
        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2200);
    }

    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti burst';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (Math.random() * 0.1) + 's';
        confetti.style.width = (5 + Math.random() * 7) + 'px';
        confetti.style.height = (8 + Math.random() * 9) + 'px';
        confetti.style.animationDuration = (1.4 + Math.random() * 0.8) + 's';
        confetti.style.left = '85%';
        confetti.style.top = '55%';
        confetti.style.setProperty('--x', `${(Math.random() * 2 - 1) * 260}px`);
        confetti.style.setProperty('--y', `${(Math.random() * 2 - 1) * 260}px`);
        if (Math.random() < 0.3) confetti.classList.add('sparkle');
        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2200);
    }

    // Light rain after burst
    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = (0.1 + Math.random() * 0.4) + 's';
        confetti.style.width = (4 + Math.random() * 6) + 'px';
        confetti.style.height = (7 + Math.random() * 8) + 'px';
        confetti.style.animationDuration = (6 + Math.random() * 2) + 's';
        if (Math.random() < 0.2) confetti.classList.add('sparkle');
        layer.appendChild(confetti);
        setTimeout(() => confetti.remove(), 8500);
    }
}

function playCelebrateSound() {
    try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const now = ctx.currentTime;

        const master = ctx.createGain();
        master.gain.value = 0.25;
        master.connect(ctx.destination);

        // Burst noise (confetti pop)
        const noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * 0.25, ctx.sampleRate);
        const data = noiseBuffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) {
            data[i] = (Math.random() * 2 - 1) * (1 - i / data.length);
        }
        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        const noiseGain = ctx.createGain();
        noiseGain.gain.setValueAtTime(0.0, now);
        noiseGain.gain.linearRampToValueAtTime(1.0, now + 0.01);
        noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
        noise.connect(noiseGain);
        noiseGain.connect(master);
        noise.start(now);

        // Low boom
        const boom = ctx.createOscillator();
        const boomGain = ctx.createGain();
        boom.type = 'sine';
        boom.frequency.value = 90;
        boomGain.gain.setValueAtTime(0.0, now);
        boomGain.gain.linearRampToValueAtTime(0.9, now + 0.02);
        boomGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.4);
        boom.connect(boomGain);
        boomGain.connect(master);
        boom.start(now);
        boom.stop(now + 0.45);

        const tones = [
            { freq: 523.25, time: 0.0 },  // C5
            { freq: 659.25, time: 0.08 }, // E5
            { freq: 783.99, time: 0.16 }, // G5
            { freq: 1046.5, time: 0.24 }  // C6
        ];

        tones.forEach(t => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = t.freq;
            gain.gain.setValueAtTime(0, now + t.time);
            gain.gain.linearRampToValueAtTime(0.4, now + t.time + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + t.time + 0.22);
            osc.connect(gain);
            gain.connect(master);
            osc.start(now + t.time);
            osc.stop(now + t.time + 0.26);
        });

        setTimeout(() => ctx.close(), 1200);
    } catch (e) {
        console.warn("Audio playback blocked or unavailable:", e);
    }
}


const DAILY_GOAL_KEY = 'dailyGoalTarget';

function getDailyGoalTarget() {
    return parseInt(localStorage.getItem(DAILY_GOAL_KEY) || '3', 10);
}

function setDailyGoalTarget(value) {
    localStorage.setItem(DAILY_GOAL_KEY, String(value));
}

function initDailyGoalInput() {
    const input = document.getElementById('dailyGoalInput');
    if (!input) return;

    input.value = getDailyGoalTarget();

    input.addEventListener('change', () => {
        let val = parseInt(input.value, 10);
        if (!val || val < 1) val = 1;
        if (val > 20) val = 20;

        input.value = val;
        setDailyGoalTarget(val);
        updateDailyGoalUI();
        showNotification(`Daily goal set to ${val} sessions`, "success");
    });
}

// ========== STUDY DATA MANAGEMENT ==========
function loadStudyData() {
    updateUI();
    updateStreakUI();
}

async function saveStudyDataToFirebase() {
    if (!currentUserId || !currentUser) return;
    
    const studentData = {
        name: currentUserName,
        userId: currentUserId,
        firebaseUid: currentUser.uid,
        streak: studyData.streak || 0,
        totalMinutes: studyData.totalMinutes || 0,
        totalStudyHours: (studyData.totalMinutes / 60).toFixed(1),
        points: Math.floor(studyData.totalMinutes / 60) * 100 || 0,
        lastActive: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        isStudentEntry: true,
        isTeacherAccount: false,
        isSameBrowserIssue: false
    };
    
    console.log(`ðŸ’¾ Saving student data. Student ID: ${currentUserId}, Firebase UID: ${currentUser.uid}`);
    
    for (const classInfo of userClasses) {
        try {
            await firebaseSet(`classes/${classInfo.code}/students/${currentUserId}`, studentData);
            console.log(`âœ… Updated data in class: ${classInfo.code} with student ID: ${currentUserId}`);
            
        } catch (error) {
            console.error(`Error updating class ${classInfo.code}:`, error);
            
            try {
                await firebaseSet(`classStudents/${classInfo.code}/${currentUserId}`, studentData);
                console.log(`âœ… Updated data in classStudents: ${classInfo.code}`);
            } catch (altError) {
                console.error(`Both paths failed for ${classInfo.code}:`, altError);
            }
        }
    }
}

async function addStudyHours() {
    const input = document.getElementById('hoursInput');
    if (!input) {
        showNotification("Study hours input not found", "error");
        return;
    }
    
    const hours = parseFloat(input.value);
    
    if (!hours || hours <= 0) {
        showNotification("Please enter valid study hours (minimum 0.25)", "error");
        return;
    }
    
    const addButton = event.target;
    const originalText = addButton.innerHTML;
    
    addButton.innerHTML = 'â³ Saving...';
    addButton.disabled = true;
    
    const baseHours = hours;
    const streakBonus = (studyData.streak || 0) > 7 ? 0.2 : (studyData.streak || 0) > 3 ? 0.1 : 0;
    const bonusHours = baseHours * streakBonus;
    const totalHours = baseHours + bonusHours;
    
    studyData.totalMinutes = (studyData.totalMinutes || 0) + totalHours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);

    await logLiveActivity('timer_started', {
        duration: Math.round(totalHours * 60)
    });
    
    if (!studyData.studySessions) studyData.studySessions = [];
    studyData.studySessions.push({
        date: new Date().toISOString(),
        hours: totalHours,
        baseHours: baseHours,
        bonusHours: bonusHours,
        streak: studyData.streak || 0
    });
    
    // Update daily stats
    const todayKey = getTodayKey();
    if (!studyData.dailyStats) studyData.dailyStats = [];
    const todayStats = studyData.dailyStats.find(s => s.date === todayKey);
    const focusScore = calculateFocusScore();
    const consistencyScore = calculateConsistencyScore();
    
    if (todayStats) {
        todayStats.sessions = (todayStats.sessions || 0) + 1;
        todayStats.hours = (todayStats.hours || 0) + totalHours;
        todayStats.focusScore = focusScore;
        todayStats.consistencyScore = consistencyScore;
    } else {
        studyData.dailyStats.unshift({
            date: todayKey,
            sessions: 1,
            hours: totalHours,
            focusScore: focusScore,
            consistencyScore: consistencyScore
        });
        
        if (!studyData.focusScores) studyData.focusScores = [];
        studyData.focusScores.unshift({
            date: todayKey,
            score: focusScore
        });
        
        if (!studyData.consistencyScores) studyData.consistencyScores = [];
        studyData.consistencyScores.unshift({
            date: todayKey,
            score: consistencyScore
        });
        
        // Keep only last 30 days
        if (studyData.dailyStats.length > 30) {
            studyData.dailyStats = studyData.dailyStats.slice(0, 30);
        }
        if (studyData.focusScores.length > 30) {
            studyData.focusScores = studyData.focusScores.slice(0, 30);
        }
        if (studyData.consistencyScores.length > 30) {
            studyData.consistencyScores = studyData.consistencyScores.slice(0, 30);
        }
    }
    
    persistData();
    await maybeCreditReferral();
    updateUI();
    updateSidebarStats();
    updateAllStatistics();
    input.value = "";
    
    updateSyncStatus("Syncing to all classes...", "syncing");
    await saveStudyDataToFirebase();
    
    setTimeout(() => {
        addButton.innerHTML = originalText;
        addButton.disabled = false;
    }, 1000);
    
    let message = `â° Added ${baseHours.toFixed(1)} study hours!`;
    if (bonusHours > 0) {
        message += ` (+${bonusHours.toFixed(1)} streak bonus)`;
    }
    message += ` Total: ${studyData.totalStudyHours} hours`;
    message += ` | Streak: ${studyData.streak || 0} days ðŸ”¥`;
    
    showNotification(message, "success");
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        updateSyncStatus("Saved to all classes!", "success");
    }, 1500);
    updateDailyGoalUI();

}

// ========== TASK MANAGEMENT WITH PRIORITIES ==========
function addTask() {
    let taskInput = document.getElementById('taskInput');
    if (!taskInput) taskInput = document.getElementById('taskInputFull');
    
    const text = taskInput.value.trim();
    
    if (!text) {
        showNotification("Please enter a task", "error");
        return;
    }
    
    const task = {
        id: Date.now().toString(),
        text: text,
        completed: false,
        createdAt: new Date().toISOString(),
        priority: selectedPriority,
        completedAt: null
    };
    
    tasks.unshift(task);
    taskInput.value = '';
    
    saveTasks();
    renderTasks();
    renderDashboardTasks();
    updateAllStatistics();
    
    const priorityText = {
        'urgent': 'ðŸ”´ Urgent',
        'not-urgent': 'ðŸŸ¡ Not Urgent',
        'optional': 'âšª Optional'
    }[selectedPriority];
    
    showNotification(`Task added as ${priorityText}!`, "success");
}

function selectPriority(priority) {
    selectedPriority = priority;
    
    document.querySelectorAll('.priority-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.priority === priority) {
            option.classList.add('active');
        }
    });
}

function getPriorityClass(priority) {
    switch(priority) {
        case 'urgent': return 'urgent';
        case 'not-urgent': return 'not-urgent';
        case 'optional': return 'optional';
        default: return '';
    }
}

function getPriorityBadge(priority) {
    switch(priority) {
        case 'urgent': return '<span class="priority-badge priority-urgent">ðŸ”´ Urgent</span>';
        case 'not-urgent': return '<span class="priority-badge priority-not-urgent">ðŸŸ¡ Not Urgent</span>';
        case 'optional': return '<span class="priority-badge priority-optional">âšª Optional</span>';
        default: return '';
    }
}

function toggleTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (task) {
        task.completed = !task.completed;
        task.completedAt = task.completed ? new Date().toISOString() : null;
        saveTasks();
        renderTasks();
        renderDashboardTasks();
        updateAllStatistics();
        
        if (task.completed) {
            showNotification("Task completed! âœ…", "success");
        }
    }
}

function deleteTask(taskId) {
    tasks = tasks.filter(t => t.id !== taskId);
    saveTasks();
    renderTasks();
    renderDashboardTasks();
    updateAllStatistics();
    showNotification("Task deleted", "info");
}

function saveTasks() {
    persistData();
}

function renderTasks() {
    const fullTaskList = document.getElementById('fullTaskList');
    if (!fullTaskList) return;
    
    let filteredTasks = tasks;
    
    switch(currentTaskFilter) {
        case 'urgent':
            filteredTasks = tasks.filter(t => t.priority === 'urgent');
            break;
        case 'not-urgent':
            filteredTasks = tasks.filter(t => t.priority === 'not-urgent');
            break;
        case 'optional':
            filteredTasks = tasks.filter(t => t.priority === 'optional');
            break;
        case 'active':
            filteredTasks = tasks.filter(t => !t.completed);
            break;
        case 'completed':
            filteredTasks = tasks.filter(t => t.completed);
            break;
        case 'all':
        default:
            filteredTasks = tasks;
    }
    
    if (filteredTasks.length === 0) {
        fullTaskList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“</div>
                <div class="empty-state-title">No tasks found</div>
                <div class="empty-state-description">
                    ${currentTaskFilter === 'all' ? 'Add your first task above!' : 
                      currentTaskFilter === 'active' ? 'All tasks are completed! ðŸŽ‰' : 
                      currentTaskFilter === 'completed' ? 'No completed tasks yet' :
                      `No ${currentTaskFilter.replace('-', ' ')} tasks`}
                </div>
            </div>
        `;
    } else {
        fullTaskList.innerHTML = filteredTasks.map((task, index) => `
            <li class="task-item ${task.completed ? 'completed' : ''} ${getPriorityClass(task.priority)}">
                <div class="task-text" onclick="toggleTask('${task.id}')">
                    ${task.text}
                    <div style="margin-top: var(--spacing-xs);">
                        ${getPriorityBadge(task.priority)}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn ${task.completed ? 'btn-success' : 'btn-warning'}" 
                            onclick="toggleTask('${task.id}')">
                        ${task.completed ? 'âœ… Completed' : 'â¬œ Mark Done'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteTask('${task.id}')">ðŸ—‘ï¸ Delete</button>
                </div>
            </li>
        `).join('');
    }
    
    updateTaskStats();
}

function renderDashboardTasks() {
    const taskList = document.getElementById('taskList');
    if (!taskList) return;
    
    const urgentTasks = tasks.filter(t => t.priority === 'urgent' && !t.completed);
    const notUrgentTasks = tasks.filter(t => t.priority === 'not-urgent' && !t.completed);
    const optionalTasks = tasks.filter(t => t.priority === 'optional' && !t.completed);
    
    const recentTasks = [...urgentTasks, ...notUrgentTasks, ...optionalTasks].slice(0, 5);
    
    if (recentTasks.length === 0) {
        taskList.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">ðŸ“</div>
                <div class="empty-state-description">No tasks yet. Add your first task!</div>
            </div>
        `;
    } else {
        taskList.innerHTML = recentTasks.map(task => `
            <li class="task-item ${getPriorityClass(task.priority)}" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                <div class="task-text" onclick="toggleTask('${task.id}')" style="font-size: 1rem;">
                    ${task.text}
                    <div style="margin-top: var(--spacing-xs); font-size: 0.75rem;">
                        ${getPriorityBadge(task.priority)}
                    </div>
                </div>
                <div class="task-actions">
                    <button class="btn ${task.completed ? 'btn-success' : 'btn-secondary'}" 
                            onclick="toggleTask('${task.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        ${task.completed ? 'âœ…' : 'â¬œ'}
                    </button>
                </div>
            </li>
        `).join('');
    }
}

function filterTasks(filter) {
    currentTaskFilter = filter;
    renderTasks();
}

function updateTaskStats() {
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.completed).length;
    const pendingTasks = totalTasks - completedTasks;
    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
    
    const totalTasksEl = document.getElementById('totalTasks');
    const pendingTasksEl = document.getElementById('pendingTasks');
    const completedTasksEl = document.getElementById('completedTasks');
    const completionRateEl = document.getElementById('completionRate');
    
    if (totalTasksEl) totalTasksEl.textContent = totalTasks;
    if (pendingTasksEl) pendingTasksEl.textContent = pendingTasks;
    if (completedTasksEl) completedTasksEl.textContent = completedTasks;
    if (completionRateEl) completionRateEl.textContent = `${completionRate}%`;
}

function clearCompletedTasks() {
    if (tasks.length === 0) {
        showNotification("No tasks to clear", "info");
        return;
    }
    
    const completedCount = tasks.filter(t => t.completed).length;
    if (completedCount === 0) {
        showNotification("No completed tasks to clear", "info");
        return;
    }
    
    if (confirm(`Clear ${completedCount} completed task${completedCount === 1 ? '' : 's'}?`)) {
        tasks = tasks.filter(t => !t.completed);
        saveTasks();
        renderTasks();
        renderDashboardTasks();
        updateAllStatistics();
        showNotification(`Cleared ${completedCount} completed task${completedCount === 1 ? '' : 's'}`, "success");
    }
}

// ========== ASSIGNMENT MANAGEMENT ==========
function loadAssignments() {
    renderAssignments();
    renderDashboardAssignments();
}

function addAssignment() {
    const name = document.getElementById('assignmentName').value.trim();
    const subject = document.getElementById('assignmentSubject').value.trim();
    const dueDate = document.getElementById('assignmentDueDate').value;
    const description = document.getElementById('assignmentDescription').value.trim();
    
    if (!name || !subject || !dueDate) {
        showNotification("Please fill all required fields", "error");
        return;
    }
    
    const assignment = {
        id: Date.now().toString(),
        name,
        subject,
        dueDate,
        description,
        createdAt: new Date().toISOString(),
        completed: false
    };
    
    assignments.unshift(assignment);
    saveAssignments();
    renderAssignments();
    renderDashboardAssignments();
    
    showNotification("Assignment added!", "success");
    hideAssignmentForm();
}

function renderAssignments() {
    const fullAssignmentList = document.getElementById('fullAssignmentList');
    if (!fullAssignmentList) return;
    
    if (assignments.length === 0) {
        fullAssignmentList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“š</div>
                <div class="empty-state-title">No assignments yet</div>
                <div class="empty-state-description">Add your first assignment!</div>
            </div>
        `;
    } else {
        fullAssignmentList.innerHTML = assignments.map((assignment, index) => {
            const dueDate = new Date(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'normal';
            if (diffDays < 0) urgencyClass = 'overdue';
            else if (diffDays === 0) urgencyClass = 'today';
            else if (diffDays <= 3) urgencyClass = 'due-soon';
            
            return `
                <div class="assignment-item ${assignment.completed ? 'completed' : ''}">
                    <div class="assignment-header">
                        <div class="assignment-title">${assignment.name}</div>
                        <div class="assignment-date ${urgencyClass}">
                            ${urgencyClass === 'overdue' ? 'âš ï¸ Overdue' : 
                              urgencyClass === 'today' ? 'ðŸ”¥ Due Today' : 
                              urgencyClass === 'due-soon' ? 'â° Due Soon' : `ðŸ“… ${dueDate.toLocaleDateString()}`}
                        </div>
                    </div>
                    <div class="assignment-content">
                        <div style="color: var(--text-muted); margin-bottom: var(--spacing-sm);">
                            ðŸ“š ${assignment.subject}
                        </div>
                        ${assignment.description ? `<p>${assignment.description}</p>` : ''}
                    </div>
                    <div class="assignment-actions">
                        <button class="btn ${assignment.completed ? 'btn-success' : 'btn-secondary'}" onclick="toggleAssignment('${assignment.id}')">
                            ${assignment.completed ? 'âœ… Completed' : 'â¬œ Mark Complete'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteAssignment('${assignment.id}')">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function renderDashboardAssignments() {
    const assignmentList = document.getElementById('assignmentList');
    if (!assignmentList) return;
    
    const recentAssignments = assignments.slice(0, 3);
    
    if (recentAssignments.length === 0) {
        assignmentList.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">ðŸ“š</div>
                <div class="empty-state-description">No assignments yet</div>
            </div>
        `;
    } else {
        assignmentList.innerHTML = recentAssignments.map(assignment => {
            const dueDate = new Date(assignment.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let urgencyClass = 'normal';
            if (diffDays < 0) urgencyClass = 'overdue';
            else if (diffDays === 0) urgencyClass = 'today';
            else if (diffDays <= 3) urgencyClass = 'due-soon';
            
            return `
                <div class="assignment-item" style="padding: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                    <div class="assignment-header">
                        <div class="assignment-title" style="font-size: 1rem;">${assignment.name}</div>
                        <div class="assignment-date" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                            ${urgencyClass === 'overdue' ? 'âš ï¸' : 
                              urgencyClass === 'today' ? 'ðŸ”¥' : 
                              urgencyClass === 'due-soon' ? 'â°' : 'ðŸ“…'}
                        </div>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                        ðŸ“š ${assignment.subject}
                    </div>
                    <div style="margin-top: var(--spacing-sm);">
                        <button class="btn ${assignment.completed ? 'btn-success' : 'btn-secondary'}" 
                                onclick="toggleAssignment('${assignment.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            ${assignment.completed ? 'âœ…' : 'â¬œ'}
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function toggleAssignment(assignmentId) {
    const assignment = assignments.find(a => a.id === assignmentId);
    if (assignment) {
        assignment.completed = !assignment.completed;
        saveAssignments();
        renderAssignments();
        renderDashboardAssignments();
        if (assignment.completed) {
            logLiveActivity('assignment_completed', {
                assignmentTitle: assignment.name || 'Assignment'
            });
        }
        showNotification(assignment.completed ? "Assignment marked as completed!" : "Assignment marked as incomplete", "success");
    }
}

function deleteAssignment(assignmentId) {
    assignments = assignments.filter(a => a.id !== assignmentId);
    saveAssignments();
    renderAssignments();
    renderDashboardAssignments();
    showNotification("Assignment deleted", "info");
}

function saveAssignments() {
    persistData();
}

function showAssignmentForm() {
    const form = document.getElementById('assignmentForm');
    if (form) form.style.display = 'block';
}

function hideAssignmentForm() {
    const form = document.getElementById('assignmentForm');
    if (form) form.style.display = 'none';
}

// ========== UPDATED STATISTICS SECTION ==========
async function markStudySession() {
    const today = new Date().toDateString();
    
    const hours = parseFloat(prompt("How many hours did you study? (e.g., 2.5)", "1"));
    
    if (isNaN(hours) || hours <= 0) {
        showNotification("Please enter a valid number of hours", "error");
        return;
    }
    
    const focusScore = Math.min(100, Math.floor(Math.random() * 30) + 70);
    const consistencyScore = calculateConsistencyScore();
    
    // Initialize arrays if they don't exist
    if (!studyData.studySessions) studyData.studySessions = [];
    if (!studyData.dailyStats) studyData.dailyStats = [];
    
    // Update study sessions
    studyData.studySessions.unshift({
        date: new Date().toISOString(),
        hours: hours,
        baseHours: hours,
        bonusHours: 0,
        streak: studyData.streak || 0
    });
    
    // Update daily stats
    const todayStats = studyData.dailyStats.find(s => s.date === today);
    if (todayStats) {
        todayStats.sessions = (todayStats.sessions || 0) + 1;
        todayStats.hours = (todayStats.hours || 0) + hours;
        todayStats.focusScore = focusScore;
        todayStats.consistencyScore = consistencyScore;
    } else {
        studyData.dailyStats.unshift({
            date: today,
            sessions: 1,
            hours: hours,
            focusScore: focusScore,
            consistencyScore: consistencyScore
        });
        
        if (studyData.dailyStats.length > 30) {
            studyData.dailyStats = studyData.dailyStats.slice(0, 30);
        }
    }
    
    // Update total hours
    studyData.totalMinutes = (studyData.totalMinutes || 0) + hours * 60;
    studyData.totalStudyHours = (studyData.totalMinutes / 60).toFixed(1);

    await logLiveActivity('timer_started', {
        duration: Math.round(hours * 60)
    });
    
    persistData();
    await maybeCreditReferral();
    updateCharts();
    updateAllStatistics();
    updateDailyGoalUI();

    showNotification(`Study session recorded! ${hours} hours studied.`, "success");
}

function calculateConsistencyScore() {
    if (!studyData.dailyStats || studyData.dailyStats.length === 0) return 100;
    
    const last7Days = studyData.dailyStats.slice(0, 7);
    const daysStudied = last7Days.length;
    const totalDays = Math.min(7, studyData.dailyStats.length);
    
    return Math.min(100, Math.floor((daysStudied / totalDays) * 100));
}

function updateCharts() {
    // Destroy existing charts
    if (hoursChart) hoursChart.destroy();
    if (tasksChart) tasksChart.destroy();
    if (weeklyChart) weeklyChart.destroy();
    if (assignmentsChart) assignmentsChart.destroy();
    if (streakChart) streakChart.destroy();
    if (focusChart) focusChart.destroy();
    
    updateOverviewCards();
    updatePerformanceMetrics();
    updateDetailedStats();
    createHoursChart();
    createTasksChart();
    createWeeklyChart();
    createAssignmentsChart();
    createStreakChart();
    createFocusChart();
}

function updateOverviewCards() {
    document.getElementById('overviewStreak').textContent = studyData.streak || 0;
    document.getElementById('overviewHours').textContent = parseFloat(studyData.totalStudyHours || 0).toFixed(1);
    document.getElementById('overviewTasks').textContent = tasks.filter(t => t.completed).length;
    document.getElementById('overviewFocus').textContent = `${calculateFocusScore()}%`;
    
    updateTrends();
}

function updateTrends() {
    if (!studyData.dailyStats || studyData.dailyStats.length < 2) return;
    
    const today = studyData.dailyStats[0] || {};
    const yesterday = studyData.dailyStats[1] || {};
    
    // Update streak trend
    const streakTrend = document.getElementById('streakTrend');
    const streakDiff = (studyData.streak || 0) - (yesterday.streak || 0);
    updateTrendElement(streakTrend, streakDiff, "days streak");
    
    // Update hours trend
    const hoursTrend = document.getElementById('hoursTrend');
    const hoursDiff = (today.hours || 0) - (yesterday.hours || 0);
    updateTrendElement(hoursTrend, hoursDiff, "hours");
    
    // Update tasks trend
    const tasksTrend = document.getElementById('tasksTrend');
    const todayCompleted = tasks.filter(t => {
        if (!t.completedAt) return false;
        const completedDate = new Date(t.completedAt).toDateString();
        return completedDate === new Date().toDateString();
    }).length;
    const yesterdayCompleted = tasks.filter(t => {
        if (!t.completedAt) return false;
        const completedDate = new Date(t.completedAt).toDateString();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        return completedDate === yesterday.toDateString();
    }).length;
    const tasksDiff = todayCompleted - yesterdayCompleted;
    updateTrendElement(tasksTrend, tasksDiff, "tasks");
    
    // Update focus trend
    const focusTrend = document.getElementById('focusTrend');
    const focusDiff = (today.focusScore || calculateFocusScore()) - (yesterday.focusScore || calculateFocusScore());
    updateTrendElement(focusTrend, focusDiff, "% focus");
}

function updateTrendElement(element, diff, label) {
    if (!element) return;
    
    let trendClass = 'neutral';
    let icon = 'âž¡ï¸';
    let text = 'No change';
    
    if (diff > 0) {
        trendClass = 'up';
        icon = 'ðŸ“ˆ';
        text = `+${diff} ${label}`;
    } else if (diff < 0) {
        trendClass = 'down';
        icon = 'ðŸ“‰';
        text = `${diff} ${label}`;
    }
    
    element.className = `stats-overview-trend ${trendClass}`;
    element.innerHTML = `<span>${icon}</span><span>${text}</span>`;
}

function updatePerformanceMetrics() {
    // Study sessions this week
    const thisWeekSessions = studyData.dailyStats ? 
        studyData.dailyStats.slice(0, 7).reduce((sum, day) => sum + (day.sessions || 0), 0) : 0;
    document.getElementById('metricSessions').textContent = thisWeekSessions;
    
    // Average daily hours
    const avgDailyHours = studyData.totalStudyDays > 0 ? 
        (parseFloat(studyData.totalStudyHours || 0) / studyData.totalStudyDays).toFixed(1) : 0;
    document.getElementById('metricAvgHours').textContent = `${avgDailyHours}h`;
    
    // Longest streak
    const longestStreak = studyData.streakHistory ? 
        Math.max(...studyData.streakHistory.map(s => s.streak || 0), studyData.streak || 0) : studyData.streak || 0;
    document.getElementById('metricLongestStreak').textContent = longestStreak;
    
    // Consistency score
    const consistencyScore = calculateConsistencyScore();
    document.getElementById('metricConsistency').textContent = `${consistencyScore}%`;
}

function updateDetailedStats() {
    // Productivity Metrics
    document.getElementById('detailTotalHours').textContent = parseFloat(studyData.totalStudyHours || 0).toFixed(1);
    document.getElementById('detailTotalSessions').textContent = studyData.studySessions ? studyData.studySessions.length : 0;
    
    const avgSessionLength = studyData.studySessions && studyData.studySessions.length > 0 ? 
        (parseFloat(studyData.totalStudyHours || 0) / studyData.studySessions.length).toFixed(1) : 0;
    document.getElementById('detailAvgSession').textContent = `${avgSessionLength}h`;
    
    const longestSession = studyData.studySessions && studyData.studySessions.length > 0 ? 
        Math.max(...studyData.studySessions.map(s => s.hours || 0)) : 0;
    document.getElementById('detailLongestSession').textContent = `${longestSession.toFixed(1)}h`;
    
    // Task Metrics
    document.getElementById('detailTotalTasks').textContent = tasks.length;
    document.getElementById('detailCompletedTasks').textContent = tasks.filter(t => t.completed).length;
    
    const completionRate = tasks.length > 0 ? 
        Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0;
    document.getElementById('detailCompletionRate').textContent = `${completionRate}%`;
    
    document.getElementById('detailActiveTasks').textContent = tasks.filter(t => !t.completed).length;
    
    // Achievement Metrics
    document.getElementById('detailCurrentStreak').textContent = studyData.streak || 0;
    
    const longestStreak = studyData.streakHistory ? 
        Math.max(...studyData.streakHistory.map(s => s.streak || 0), studyData.streak || 0) : studyData.streak || 0;
    document.getElementById('detailLongestStreak').textContent = longestStreak;
    
    document.getElementById('detailFocusScore').textContent = `${calculateFocusScore()}%`;
    document.getElementById('detailConsistencyScore').textContent = `${calculateConsistencyScore()}%`;
}

function createHoursChart() {
    const ctx = document.getElementById('hoursChart');
    if (!ctx) return;
    
    const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    if (!studyData.studySessions) studyData.studySessions = [];
    
    const dailyHours = last7Days.map(day => {
        const daySessions = studyData.studySessions.filter(s => {
            const sessionDate = new Date(s.date).toDateString();
            return sessionDate === day;
        });
        return daySessions.reduce((sum, session) => sum + (session.hours || 0), 0);
    });
    
    // Theme-adaptive colors
    const barColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
    const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-dark');
    
    hoursChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            }),
            datasets: [{
                label: 'Study Hours',
                data: dailyHours,
                backgroundColor: barColor + '80', // 50% opacity
                borderColor: borderColor,
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Hours',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('hoursLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${barColor};"></div>
                <span>Daily Study Hours</span>
            </div>
        `;
    }
}

function createTasksChart() {
    const ctx = document.getElementById('tasksChart');
    if (!ctx) return;
    
    const completedTasks = tasks.filter(t => t.completed).length;
    const pendingTasks = tasks.filter(t => !t.completed).length;
    
    // Theme-adaptive colors
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success');
    const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning');
    
    tasksChart = new Chart(ctx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending'],
            datasets: [{
                data: [completedTasks, pendingTasks],
                backgroundColor: [
                    successColor + '80',
                    warningColor + '80'
                ],
                borderColor: [
                    successColor,
                    warningColor
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 11
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('tasksLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${successColor};"></div>
                <span>Completed Tasks</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: ${warningColor};"></div>
                <span>Pending Tasks</span>
            </div>
        `;
    }
}

function createWeeklyChart() {
    const ctx = document.getElementById('weeklyChart');
    if (!ctx) return;
    
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    if (!studyData.weeklyPattern) studyData.weeklyPattern = [0, 0, 0, 0, 0, 0, 0];
    
    // Theme-adaptive colors
    const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--purple');
    const fillColor = lineColor + '20';
    
    weeklyChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: daysOfWeek,
            datasets: [{
                label: 'Study Sessions',
                data: studyData.weeklyPattern,
                backgroundColor: fillColor,
                borderColor: lineColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Sessions',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('weeklyLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${lineColor};"></div>
                <span>Weekly Study Pattern</span>
            </div>
        `;
    }
}

function createAssignmentsChart() {
    const ctx = document.getElementById('assignmentsChart');
    if (!ctx) return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const overdue = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        return dueDate < today && !a.completed;
    }).length;
    
    const dueToday = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return dueDate.getTime() === today.getTime() && !a.completed;
    }).length;
    
    const dueSoon = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 0 && diffDays <= 3 && !a.completed;
    }).length;
    
    const completed = assignments.filter(a => a.completed).length;
    const future = assignments.filter(a => {
        const dueDate = new Date(a.dueDate);
        const diffTime = dueDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays > 3 && !a.completed;
    }).length;
    
    // Theme-adaptive colors
    const colors = [
        getComputedStyle(document.documentElement).getPropertyValue('--danger'),
        getComputedStyle(document.documentElement).getPropertyValue('--warning'),
        getComputedStyle(document.documentElement).getPropertyValue('--info'),
        getComputedStyle(document.documentElement).getPropertyValue('--success'),
        getComputedStyle(document.documentElement).getPropertyValue('--text-muted')
    ];
    
    assignmentsChart = new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Overdue', 'Due Today', 'Due Soon', 'Completed', 'Future'],
            datasets: [{
                data: [overdue, dueToday, dueSoon, completed, future],
                backgroundColor: colors.map(color => color + '80'),
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 11
                        },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('assignmentsLegend');
    if (legend) {
        legend.innerHTML = colors.map((color, index) => {
            const labels = ['Overdue', 'Due Today', 'Due Soon', 'Completed', 'Future'];
            return `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${color};"></div>
                    <span>${labels[index]}</span>
                </div>
            `;
        }).join('');
    }
}

function createStreakChart() {
    const ctx = document.getElementById('streakChart');
    if (!ctx) return;
    
    const last14Days = Array.from({length: 14}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    if (!studyData.streakHistory) studyData.streakHistory = [];
    
    const streakData = last14Days.map(day => {
        const streakEntry = studyData.streakHistory.find(s => s.date === day);
        return streakEntry ? streakEntry.streak : 0;
    });
    
    // Theme-adaptive colors
    const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--warning');
    const fillColor = lineColor + '20';
    
    streakChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: last14Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Streak Days',
                data: streakData,
                backgroundColor: fillColor,
                borderColor: lineColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: lineColor,
                pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Days',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('streakLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${lineColor};"></div>
                <span>Daily Streak</span>
            </div>
        `;
    }
}

function createFocusChart() {
    const ctx = document.getElementById('focusChart');
    if (!ctx) return;
    
    const last7Days = Array.from({length: 7}, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - i);
        return date.toDateString();
    }).reverse();
    
    if (!studyData.focusScores) studyData.focusScores = [];
    
    const focusData = last7Days.map(day => {
        const focusEntry = studyData.focusScores.find(s => s.date === day);
        return focusEntry ? focusEntry.score : 0;
    });
    
    // Theme-adaptive colors
    const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
    const fillColor = lineColor + '20';
    
    focusChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-US', { weekday: 'short' });
            }),
            datasets: [{
                label: 'Focus Score (%)',
                data: focusData,
                backgroundColor: fillColor,
                borderColor: lineColor,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: lineColor,
                pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card'),
                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text'),
                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border'),
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Score (%)',
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border') + '40'
                    },
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
    
    // Update legend
    const legend = document.getElementById('focusLegend');
    if (legend) {
        legend.innerHTML = `
            <div class="legend-item">
                <div class="legend-color" style="background: ${lineColor};"></div>
                <span>Daily Focus Score</span>
            </div>
        `;
    }
}

function refreshCharts() {
    updateCharts();
    showNotification("Charts refreshed successfully!", "success");
}

function calculateFocusScore() {
    let score = 50;
    
    const streakBonus = Math.min((studyData.streak || 0) * 5, 30);
    score += streakBonus;
    
    if ((studyData.totalStudyDays || 0) > 7) score += 10;
    if ((studyData.totalStudyDays || 0) > 30) score += 10;
    
    const completionRate = tasks.length > 0 ? 
        (tasks.filter(t => t.completed).length / tasks.length) * 100 : 0;
    score += Math.min(completionRate * 0.2, 10);
    
    return Math.min(Math.max(Math.round(score), 0), 100);
}

function exportStatistics() {
    const statsData = {
        exportDate: new Date().toISOString(),
        summary: {
            totalHours: parseFloat(studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1) || 0),
            currentStreak: studyData.streak || 0,
            taskCompletionRate: tasks.length > 0 ? Math.round((tasks.filter(t => t.completed).length / tasks.length) * 100) : 0,
            focusScore: calculateFocusScore()
        },
        detailed: {
            totalSessions: studyData.studySessions ? studyData.studySessions.length : 0,
            avgDailyHours: (studyData.totalStudyDays || 0) > 0 ? (parseFloat(studyData.totalStudyHours || 0) / (studyData.totalStudyDays || 1)).toFixed(1) : 0,
            totalTasks: tasks.length,
            completedTasks: tasks.filter(t => t.completed).length,
            totalAssignments: assignments.length,
            completedAssignments: assignments.filter(a => a.completed).length,
            weeklyPattern: studyData.weeklyPattern || [0, 0, 0, 0, 0, 0, 0],
            streakHistory: studyData.streakHistory || [],
            dailyStats: studyData.dailyStats || []
        }
    };
    
    const dataStr = JSON.stringify(statsData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `student-stats-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("Statistics exported successfully!", "success");
}

// ========== INSPIRING STORIES ==========
function loadInspiringStories() {
    const storiesList = document.getElementById('storiesList');
    if (!storiesList) return;
    
    const shuffledStories = [...inspiringStories].sort(() => 0.5 - Math.random()).slice(0, 3);
    
    storiesList.innerHTML = shuffledStories.map(story => `
        <div class="story-item" onclick="showStoryModal(${story.id})">
            <div class="story-name">
                ${story.icon} ${story.name}
            </div>
            <div class="story-quote">"${story.quote}"</div>
        </div>
    `).join('');
}

function showStoryModal(storyId) {
    const story = inspiringStories.find(s => s.id === storyId);
    if (!story) return;
    
    const modal = document.getElementById('storyModal');
    const title = document.getElementById('storyModalTitle');
    const content = document.getElementById('storyModalContent');
    
    title.textContent = `${story.icon} ${story.name}'s Story`;
    
    content.innerHTML = `
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Their Famous Quote:</h3>
            <div style="font-style: italic; font-size: 1.25rem; color: var(--text); padding: var(--spacing-md); background: var(--bg); border-radius: var(--radius); border-left: 4px solid var(--accent);">
                "${story.quote}"
            </div>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Their Journey:</h3>
            <p style="line-height: 1.6;">${story.story}</p>
        </div>
        
        <div style="margin-bottom: var(--spacing-lg);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">Challenges They Overcame:</h3>
            <ul style="padding-left: var(--spacing-lg); line-height: 1.6;">
                ${story.struggles.map(s => `<li style="margin-bottom: var(--spacing-xs);">${s}</li>`).join('')}
        </ul>
        </div>
        
        <div style="padding: var(--spacing-lg); background: var(--accent-light); border-radius: var(--radius); border-left: 4px solid var(--accent);">
            <h3 style="color: var(--accent); margin-bottom: var(--spacing-sm);">ðŸ’¡ Key Lesson:</h3>
            <p style="font-weight: 600; color: var(--text);">${story.lessons}</p>
        </div>
    `;
    
    modal.style.display = 'flex';
}

function closeStoryModal() {
    document.getElementById('storyModal').style.display = 'none';
}

// ========== CLASS MANAGEMENT ==========
function updateClassSelector() {
    const selector = document.getElementById('classSelector');
    if (!selector) return;
    
    selector.innerHTML = '<option value="">Select a Class</option>';
    
    userClasses.forEach((classInfo, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${classInfo.name || 'Class'} (${classInfo.code})`;
        if (index === selectedClassIndex) {
            option.selected = true;
        }
        selector.appendChild(option);
    });
}

async function switchClass(classIndex) {
    if (classIndex === "") return;
    
    classIndex = parseInt(classIndex);
    if (classIndex >= 0 && classIndex < userClasses.length) {
        selectedClassIndex = classIndex;
        currentClassCode = userClasses[classIndex].code;
        
        console.log(`ðŸ”„ Switched to class: ${currentClassCode}`);
        
        persistData();
        loadClassroomData();
        if (currentSection === 'classroom') {
            await loadTeacherContent();
            await loadClassLeaderboard();
        }
        
        showNotification(`Switched to ${userClasses[classIndex].name || 'Class'}`, "success");
    }
}

function showJoinClassForm() {
    const form = document.getElementById('joinClassForm');
    if (form) {
        form.style.display = 'block';
        document.getElementById('joinClassCode').focus();
    }
}

function hideJoinClassForm() {
    const form = document.getElementById('joinClassForm');
    if (form) form.style.display = 'none';
}

async function joinClass() {
    const classCodeInput = document.getElementById('joinClassCode');
    const classCode = classCodeInput.value.toUpperCase().trim();
    
    if (!classCode || classCode.length !== 6) {
        showNotification("Please enter a valid 6-digit class code", "error");
        return;
    }
    
    const joinBtn = event.target;
    const originalText = joinBtn.innerHTML;
    joinBtn.innerHTML = 'ðŸ”„ Joining...';
    joinBtn.disabled = true;
    
    try {
        console.log(`ðŸŽ“ Attempting to join class: ${classCode}`);
        
        if (userClasses.some(c => c.code === classCode)) {
            showNotification("You've already joined this class", "info");
            hideJoinClassForm();
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        let classData = null;
        try {
            classData = await firebaseGet('classCodes/' + classCode);
        } catch (error) {
            console.log("Trying alternative path...");
            classData = await firebaseGet('classes/' + classCode);
        }
        
        if (!classData) {
            showNotification("Class not found. Check the code and try again.", "error");
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        console.log("âœ… Class found:", classData);
        
        const studentData = {
            name: currentUserName || 'Student',
            userId: currentUserId,
            firebaseUid: currentUser ? currentUser.uid : null,
            streak: studyData.streak || 0,
            totalMinutes: studyData.totalMinutes || 0,
            totalStudyHours: (studyData.totalMinutes / 60).toFixed(1),
            points: Math.floor(studyData.totalMinutes / 60) * 100 || 0,
            lastActive: new Date().toISOString(),
            joinedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            isStudentEntry: true,
            isTeacherAccount: false
        };
        
        console.log(`ðŸ“¤ Writing student data to class ${classCode}...`);
        
        let success = false;
        let errorMessages = [];
        
        try {
            await firebaseSet(`classes/${classCode}/students/${currentUserId}`, studentData);
            console.log(`âœ… Path 1 successful: classes/${classCode}/students/${currentUserId}`);
            success = true;
        } catch (error1) {
            errorMessages.push(`Path 1: ${error1.message}`);
            console.error(`âŒ Path 1 failed: ${error1.message}`);
        }
        
        if (!success) {
            try {
                await firebaseSet(`classStudents/${classCode}/${currentUserId}`, studentData);
                console.log(`âœ… Path 2 successful: classStudents/${classCode}/${currentUserId}`);
                success = true;
            } catch (error2) {
                errorMessages.push(`Path 2: ${error2.message}`);
                console.error(`âŒ Path 2 failed: ${error2.message}`);
            }
        }
        
        if (!success) {
            try {
                const simpleData = {
                    name: currentUserName || 'Student',
                    streak: studyData.streak || 0,
                    totalHours: (studyData.totalMinutes / 60).toFixed(1),
                    joined: new Date().toISOString()
                };
                
                await firebaseSet(`studentList/${classCode}/${currentUserId}`, simpleData);
                console.log(`âœ… Path 3 successful: studentList/${classCode}/${currentUserId}`);
                success = true;
            } catch (error3) {
                errorMessages.push(`Path 3: ${error3.message}`);
                console.error(`âŒ Path 3 failed: ${error3.message}`);
            }
        }
        
        if (!success) {
            console.error("All paths failed:", errorMessages);
            showNotification("Could not join class due to permissions. Try using incognito mode.", "error");
            
            console.log("Full error details:", {
                classCode,
                teacherId: classData.teacherId,
                currentUserId,
                currentUserUid: currentUser?.uid,
                errorMessages
            });
            
            joinBtn.innerHTML = originalText;
            joinBtn.disabled = false;
            return;
        }
        
        const newClass = {
            code: classCode,
            name: classData.name || 'Class ' + classCode,
            teacherId: classData.teacherId,
            joinedAt: new Date().toISOString()
        };
        
        userClasses.push(newClass);
        currentClassCode = classCode;
        selectedClassIndex = userClasses.length - 1;
        
        saveUserData();
        persistData();
        
        updateClassSelector();
        renderClassesList();
        loadClassroomData();
        
        classCodeInput.value = '';
        hideJoinClassForm();
        
        await saveStudyDataToFirebase();
        
        showNotification(`Successfully joined ${classData.name || 'the class'}!`, "success");
        
        if (currentSection === 'classroom') {
            await loadTeacherContent();
            await loadClassLeaderboard();
        }
        
    } catch (error) {
        console.error("âŒ Join class error:", error);
        console.error("Error stack:", error.stack);
        
        showNotification("Failed to join class: " + (error.message || "Unknown error"), "error");
    } finally {
        joinBtn.innerHTML = originalText;
        joinBtn.disabled = false;
    }
}

function renderClassesList() {
    const classesList = document.getElementById('classesList');
    const noClassesMessage = document.getElementById('noClassesMessage');
    
    if (!classesList) return;
    
    if (userClasses.length === 0) {
        classesList.innerHTML = '';
        if (noClassesMessage) noClassesMessage.style.display = 'block';
        return;
    }
    
    if (noClassesMessage) noClassesMessage.style.display = 'none';
    
    classesList.innerHTML = userClasses.map((classInfo, index) => {
        const isActive = index === selectedClassIndex;
        
        return `
            <div class="class-card ${isActive ? 'active' : ''}">
                <div class="class-card-header">
                    <div class="class-card-title">${classInfo.name || 'Class'}</div>
                    <div class="class-card-code">${classInfo.code}</div>
                </div>
                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-sm);">
                    Joined: ${new Date(classInfo.joinedAt).toLocaleDateString()}
                </div>
                <div class="class-card-stats">
                    <div class="class-card-stat">
                        <div class="value">${studyData.streak || 0}</div>
                        <div class="label">Streak</div>
                    </div>
                    <div class="class-card-stat">
                        <div class="value">${(studyData.totalMinutes / 60).toFixed(1)}</div>
                        <div class="label">Hours</div>
                    </div>
                </div>
                <div class="class-card-actions">
                    <button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="switchClass(${index})" style="flex: 1;">
                        ${isActive ? 'âœ“ Active' : 'Switch'}
                    </button>
                    <button class="btn btn-danger" onclick="leaveClassConfirm('${classInfo.code}')">
                        ðŸšª Leave
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function leaveClassConfirm(classCode) {
    if (confirm(`Are you sure you want to leave this class?`)) {
        leaveClass(classCode);
    }
}

async function leaveClass(classCodeToLeave = null) {
    const classCode = classCodeToLeave || currentClassCode;
    
    if (!classCode) {
        showNotification("No class to leave", "error");
        return;
    }
    
    const classIndex = userClasses.findIndex(c => c.code === classCode);
    if (classIndex === -1) {
        showNotification("Class not found in your list", "error");
        return;
    }
    
    const className = userClasses[classIndex].name || 'Class';
    
    try {
        await firebaseRemove(`classes/${classCode}/students/${currentUserId}`);
        console.log(`âœ… Student removed from class: ${classCode}`);
    } catch (error) {
        console.error("Error removing student from Firebase:", error);
    }
    
    userClasses.splice(classIndex, 1);
    
    if (classCode === currentClassCode) {
        if (userClasses.length > 0) {
            selectedClassIndex = 0;
            currentClassCode = userClasses[0].code;
        } else {
            currentClassCode = null;
            selectedClassIndex = -1;
        }
    }
    
    saveUserData();
    persistData();
    
    updateClassSelector();
    renderClassesList();
    loadClassroomData();
    
    if (currentSection === 'classroom') {
        await loadTeacherContent();
        await loadClassLeaderboard();
    }
    
    showNotification(`You have left ${className}`, "success");
}

// ========== CLASSROOM MANAGEMENT ==========
function loadClassroomData() {
    const notInClassView = document.getElementById('notInClassView');
    const inClassView = document.getElementById('inClassView');
    
    if (currentClassCode && userClasses.length > 0) {
        notInClassView.style.display = 'none';
        inClassView.style.display = 'block';
        
        const codeElement = document.getElementById('currentClassCode');
        if (codeElement) codeElement.textContent = currentClassCode;
        
        loadTeacherContent();
        loadClassLeaderboard();
    } else {
        if (notInClassView) notInClassView.style.display = 'block';
        if (inClassView) inClassView.style.display = 'none';
    }
}

async function loadTeacherContent() {
    if (!currentClassCode) {
        console.log("âŒ Cannot load teacher content: No class selected");
        return;
    }
    
    console.log(`ðŸ“¢ Loading teacher content for class: ${currentClassCode}`);
    
    try {
        const announcements = await firebaseGet(`announcements/${currentClassCode}`);
        const announcementsDiv = document.getElementById('teacherAnnouncements');
        
        if (announcements && announcementsDiv) {
            const announcementList = Object.entries(announcements).map(([id, ann]) => ({
                id,
                ...ann
            }));
            
            announcementList.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date || 0);
                const dateB = new Date(b.createdAt || b.date || 0);
                return dateB - dateA;
            });
            
            if (announcementList.length === 0) {
                announcementsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¢</div>
                        <div class="empty-state-title">No announcements yet</div>
                        <div class="empty-state-description">Check back later for updates from your teacher</div>
                    </div>
                `;
            } else {
                announcementsDiv.innerHTML = announcementList.map((ann, index) => `
                    <div class="classroom-item">
                        <div class="classroom-item-header">
                            <div class="classroom-item-title">${ann.title || 'Announcement'}</div>
                            <div class="classroom-item-date">
                                ðŸ“… ${new Date(ann.createdAt || ann.date || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="classroom-item-content">
                            <p>${ann.content || ''}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            const countElement = document.getElementById('announcementCount');
            if (countElement) countElement.textContent = announcementList.length;
        } else {
            if (announcementsDiv) {
                announcementsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“¢</div>
                        <div class="empty-state-title">No announcements yet</div>
                        <div class="empty-state-description">Check back later for updates from your teacher</div>
                    </div>
                `;
                const countElement = document.getElementById('announcementCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("âŒ Error loading announcements:", error);
        const announcementsDiv = document.getElementById('teacherAnnouncements');
        if (announcementsDiv) {
            announcementsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">Error loading announcements</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    
    try {
        const resources = await firebaseGet(`resources/${currentClassCode}`);
        const resourcesDiv = document.getElementById('teacherResources');
        
        if (resources && resourcesDiv) {
            const resourceList = Object.entries(resources).map(([id, res]) => ({
                id,
                ...res
            }));
            
            if (resourceList.length === 0) {
                resourcesDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <div class="empty-state-title">No resources yet</div>
                        <div class="empty-state-description">Your teacher will add resources here</div>
                    </div>
                `;
            } else {
                resourcesDiv.innerHTML = resourceList.map((res, index) => `
                    <div class="classroom-item">
                        <div class="classroom-item-header">
                            <div class="classroom-item-title">${res.title || 'Resource'}</div>
                            <div class="classroom-item-date">
                                ðŸ“… ${new Date(res.createdAt || res.date || Date.now()).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="classroom-item-content">
                            ${res.description ? `<p>${res.description}</p>` : ''}
                            ${res.url ? `
                                <a href="${res.url}" target="_blank" class="classroom-item-link">
                                    ðŸ“Ž ${res.url}
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            const countElement = document.getElementById('resourceCount');
            if (countElement) countElement.textContent = resourceList.length;
        } else {
            if (resourcesDiv) {
                resourcesDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“š</div>
                        <div class="empty-state-title">No resources yet</div>
                        <div class="empty-state-description">Your teacher will add resources here</div>
                    </div>
                `;
                const countElement = document.getElementById('resourceCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("âŒ Error loading resources:", error);
        const resourcesDiv = document.getElementById('teacherResources');
        if (resourcesDiv) {
            resourcesDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">Error loading resources</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    
    try {
        const polls = await firebaseGet(`polls/${currentClassCode}`);
        const pollsDiv = document.getElementById('teacherPolls');
        
        if (polls && pollsDiv) {
            const pollList = Object.entries(polls).map(([id, pol]) => ({
                id,
                ...pol
            }));
            
            pollList.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.date || 0);
                const dateB = new Date(b.createdAt || b.date || 0);
                return dateB - dateA;
            });
            
            if (pollList.length === 0) {
                pollsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ—³ï¸</div>
                        <div class="empty-state-title">No polls yet</div>
                        <div class="empty-state-description">Your teacher will share polls here</div>
                    </div>
                `;
            } else {
                pollsDiv.innerHTML = pollList.filter(p => !p.isArchived).map(pol => {
                    const votedIndex = pol.responses && currentUserId ? pol.responses[currentUserId] : null;
                    const options = pol.options || [];
                    const isClosed = pol.isActive === false;
                    const canVote = votedIndex === null || votedIndex === undefined;
                    
                    const optionsHtml = options.map((opt, idx) => {
                        const isOther = String(opt || '').trim().toLowerCase() === 'other';
                        return `
                        <label class="poll-option">
                            <input class="poll-radio" type="radio" name="poll_${pol.id}" value="${idx}" ${(!canVote || isClosed) ? 'disabled' : ''}>
                            ${isOther
                                ? `<span>Other:</span><input class="poll-other-input" type="text" id="poll_${pol.id}_other_${idx}" ${(!canVote || isClosed) ? 'disabled' : ''}>`
                                : `<span>${opt}</span>`
                            }
                        </label>
                        `;
                    }).join('');
                    
                    const results = pol.results || {};
                    const totalVotes = Object.values(results).reduce((sum, v) => sum + (Number(v) || 0), 0);
                    const resultsHtml = options.map((opt, idx) => {
                        const count = Number(results[idx] || 0);
                        const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                        return `
                            <div class="poll-result-row">
                                <div class="poll-result-head">
                                    <span>${opt}</span>
                                    <span>${count} (${percent}%)</span>
                                </div>
                                <div class="poll-bar">
                                    <div class="poll-bar-fill" style="width: ${percent}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    const votedText = votedIndex !== null && votedIndex !== undefined
                        ? `<div class="poll-status voted">You voted: ${options[votedIndex] || 'Option'}</div>`
                        : '';
                    
                    return `
                        <div class="classroom-item poll-card" data-poll-id="${pol.id}">
                            <div class="classroom-item-header">
                                <div class="classroom-item-title">${pol.question || 'Class Poll'}</div>
                                <div class="classroom-item-date">
                                    ðŸ—“ ${new Date(pol.createdAt || Date.now()).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="poll-divider"></div>
                            <div class="classroom-item-content">
                                ${(!isClosed && canVote) ? `<div class="poll-options">${optionsHtml}</div>` : ''}
                                ${(!isClosed && canVote) ? `<button class="poll-submit" onclick="submitPollResponse('${pol.id}')">Vote</button>` : ''}
                                ${(!isClosed && canVote) ? `<div class="poll-actions"><span class="poll-action-link" onclick="togglePollResults('${pol.id}')">View Results</span><span class="poll-action-link" onclick="copyPollLink('${pol.id}')">Share This</span></div>` : ''}
                                ${(isClosed || !canVote) ? `
                                    <div class="poll-results" style="display: block;">
                                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Results</div>
                                        ${resultsHtml}
                                        <div style="margin-top: 0.25rem; color: var(--text-muted); font-size: 0.875rem;">Total votes: ${totalVotes}</div>
                                    </div>
                                ` : ''}
                                ${(isClosed || !canVote) ? `<div class="poll-actions"><span class="poll-action-link" onclick="togglePollResults('${pol.id}')">View Results</span><span class="poll-action-link" onclick="copyPollLink('${pol.id}')">Share This</span></div>` : ''}
                                ${votedText}
                                ${isClosed ? `<div class="poll-status closed">Poll closed</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            const countElement = document.getElementById('pollCount');
            if (countElement) countElement.textContent = pollList.filter(p => !p.isArchived).length;
        } else {
            if (pollsDiv) {
                pollsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ—³ï¸</div>
                        <div class="empty-state-title">No polls yet</div>
                        <div class="empty-state-description">Your teacher will share polls here</div>
                    </div>
                `;
                const countElement = document.getElementById('pollCount');
                if (countElement) countElement.textContent = '0';
            }
        }
    } catch (error) {
        console.error("âŒ Error loading polls:", error);
        const pollsDiv = document.getElementById('teacherPolls');
        if (pollsDiv) {
            pollsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âŒ</div>
                    <div class="empty-state-title">Error loading polls</div>
                    <div class="empty-state-description">You may need to refresh or check your connection</div>
                </div>
            `;
        }
    }
    await renderAggregateHeatmap();
}

async function submitPollResponse(pollId) {
    if (!currentClassCode || !currentUserId) {
        showNotification("Please join a class first", "error");
        return;
    }
    
    const selected = document.querySelector(`input[name="poll_${pollId}"]:checked`);
    if (!selected) {
        showNotification("Please select an option", "error");
        return;
    }
    
    const optionIndex = selected.value;
    
    try {
        const responsePath = `polls/${currentClassCode}/${pollId}/responses/${currentUserId}`;
        const existing = await firebaseGet(responsePath);
        if (existing !== null && existing !== undefined) {
            showNotification("You have already voted in this poll", "warning");
            return;
        }
        
        await firebaseSet(responsePath, optionIndex);
        
        if (database && currentUser) {
            const resultRef = database.ref(`polls/${currentClassCode}/${pollId}/results/${optionIndex}`);
            resultRef.transaction((current) => {
                const base = parseInt(current || 0, 10) || 0;
                return base + 1;
            });
        }
        
        showNotification("Vote submitted!", "success");
        loadTeacherContent();
    } catch (error) {
        console.error("âŒ Error submitting poll response:", error);
        showNotification("Failed to submit vote. Try again.", "error");
    }
}

function togglePollResults(pollId) {
    const pollNode = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollNode) return;
    const results = pollNode.querySelector('.poll-results');
    if (!results) return;
    results.style.display = results.style.display === 'none' ? 'block' : 'none';
}

function copyPollLink(pollId) {
    if (!currentClassCode) return;
    const url = `${window.location.origin}${window.location.pathname}?class=${encodeURIComponent(currentClassCode)}&poll=${encodeURIComponent(pollId)}`;
    navigator.clipboard.writeText(url).then(() => {
        showNotification("Poll link copied!", "success");
    }).catch(() => {
        showNotification("Unable to copy poll link", "warning");
    });
}

async function loadClassLeaderboard() {
    if (!currentClassCode) {
        console.log("âŒ Cannot load leaderboard: No class selected");
        showLeaderboardError("Not connected to a class");
        return;
    }
    
    console.log(`ðŸ“Š Loading leaderboard for class: ${currentClassCode}`);
    
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="loading">
                <div>Loading leaderboard...</div>
            </div>
        `;
    }
    
    try {
        const students = await firebaseGet(`classes/${currentClassCode}/students`);
        
        if (!students) {
            showLeaderboardEmpty();
            return;
        }
        
        const studentList = Object.entries(students).map(([id, studentData]) => {
            const totalStudyHours = studentData.totalStudyHours || (studentData.totalMinutes / 60).toFixed(1) || 0;
            
            return {
                id,
                name: studentData.name || 'Student ' + id.substr(0, 6),
                totalStudyHours: parseFloat(totalStudyHours),
                streak: studentData.streak || 0,
                points: studentData.points || Math.floor(totalStudyHours * 100) || 0,
                lastActive: studentData.lastActive || 'Unknown',
                isTeacherAccount: id.includes('teacher') || studentData.name?.includes('Teacher')
            };
        });
        
        const filteredStudents = studentList.filter(s => !s.isTeacherAccount);
        filteredStudents.sort((a, b) => b.totalStudyHours - a.totalStudyHours);
        
        renderLeaderboard(filteredStudents);
        
    } catch (error) {
        console.error("âŒ Error loading leaderboard:", error);
        showLeaderboardError("Failed to load leaderboard. Please try again.");
    }
}

function renderLeaderboard(students) {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (!leaderboardDiv) return;
    
    if (students.length === 0) {
        showLeaderboardEmpty();
        return;
    }
    
    const totalStudents = students.length;
    const totalHours = students.reduce((sum, student) => sum + student.totalStudyHours, 0);
    const avgHours = totalStudents > 0 ? totalHours / totalStudents : 0;
    const topStudent = students.length > 0 ? students[0] : null;
    
    leaderboardDiv.innerHTML = `
        <div class="leaderboard-stats">
            <div class="leaderboard-stat">
                <div class="value">${totalStudents}</div>
                <div class="label">Students</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${totalHours.toFixed(1)}</div>
                <div class="label">Total Hours</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${avgHours.toFixed(1)}</div>
                <div class="label">Avg/Student</div>
            </div>
            <div class="leaderboard-stat">
                <div class="value">${topStudent ? topStudent.totalStudyHours.toFixed(1) : '0.0'}</div>
                <div class="label">Top Score</div>
            </div>
        </div>
        
        <div class="leaderboard-list">
            ${students.map((student, index) => {
                const isCurrentUser = student.id === currentUserId;
                const rankClass = `rank-${index + 1}`;
                const isTopThree = index < 3;
                
                const initials = student.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                let lastActiveText = 'Never';
                if (student.lastActive && student.lastActive !== 'Unknown') {
                    const lastActive = new Date(student.lastActive);
                    const now = new Date();
                    const diffDays = Math.floor((now - lastActive) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) lastActiveText = 'Today';
                    else if (diffDays === 1) lastActiveText = 'Yesterday';
                    else if (diffDays < 7) lastActiveText = `${diffDays}d ago`;
                    else if (diffDays < 30) lastActiveText = `${Math.floor(diffDays/7)}w ago`;
                    else lastActiveText = lastActive.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                return `
                    <div class="leaderboard-item ${rankClass} ${isCurrentUser ? 'you' : ''}">
                        <div class="leaderboard-rank">
                            ${isTopThree ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] : `#${index + 1}`}
                        </div>
                        <div class="leaderboard-avatar">
                            ${initials}
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${student.name} ${isCurrentUser ? '(You)' : ''}
                            </div>
                            <div class="leaderboard-subtitle">
                                Last active: ${lastActiveText}
                            </div>
                            <div class="leaderboard-stats-row">
                                <span class="stats-badge fire">ðŸ”¥ ${student.streak || 0}</span>
                                <span class="stats-badge time">â° ${student.totalStudyHours.toFixed(1)}h</span>
                                <span class="stats-badge points">â­ ${student.points || 0}</span>
                            </div>
                        </div>
                        <div class="leaderboard-score">
                            ${student.totalStudyHours.toFixed(1)}h
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function showLeaderboardEmpty() {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="leaderboard-empty">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">ðŸ†</div>
                <h3>No Students Yet</h3>
                <p>Be the first to join and start studying!</p>
            </div>
        `;
    }
}

function showLeaderboardError(message) {
    const leaderboardDiv = document.getElementById('classLeaderboard');
    if (leaderboardDiv) {
        leaderboardDiv.innerHTML = `
            <div class="leaderboard-empty">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">âŒ</div>
                <h3>Error Loading Leaderboard</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="loadClassLeaderboard()" style="margin-top: var(--spacing-md);">
                    ðŸ”„ Retry
                </button>
            </div>
        `;
    }
}

function refreshLeaderboard() {
    updateSyncStatus("Refreshing leaderboard...", "syncing");
    loadClassLeaderboard();
    setTimeout(() => {
        updateSyncStatus("Leaderboard refreshed", "success");
    }, 500);
}

function copyClassCode() {
    if (!currentClassCode) return;
    
    navigator.clipboard.writeText(currentClassCode).then(() => {
        showNotification("Class code copied to clipboard!", "success");
    });
}

async function refreshClassroom() {
    updateSyncStatus("Refreshing...", "syncing");
    await loadTeacherContent();
    await loadClassLeaderboard();
    setTimeout(() => {
        showNotification("Classroom data refreshed", "success");
        updateSyncStatus("Refreshed", "success");
    }, 500);
}

// ========== ACHIEVEMENT BADGES ==========
const BADGES_STORAGE_KEY = 'studentEarnedBadges';

function loadEarnedBadges() {
    try {
        const raw = localStorage.getItem(BADGES_STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
    } catch (e) {
        console.warn("Failed to load earned badges:", e);
        return [];
    }
}

function saveEarnedBadges(badges) {
    try {
        localStorage.setItem(BADGES_STORAGE_KEY, JSON.stringify(badges));
    } catch (e) {
        console.warn("Failed to save earned badges:", e);
    }
}

function getAchievementBadges() {
    const sessions = studyData.studySessions || [];
    const totalMinutes = studyData.totalMinutes || (parseFloat(studyData.totalStudyHours || 0) * 60) || 0;
    const todayKey = new Date().toDateString();
    const todayStats = (studyData.dailyStats || []).find(s => s.date === todayKey);
    const todaySessions = todayStats ? (todayStats.sessions || 0) : 0;
    const goalTarget = getDailyGoalTarget();
    const completedTimers = sessions.length;
    const totalHours = totalMinutes / 60;
    const completedTasks = tasks.filter(t => t.completed).length;
    const completedAssignments = assignments.filter(a => a.completed).length;
    const last7Days = (studyData.dailyStats || []).slice(0, 7);
    const daysStudiedLast7 = last7Days.filter(d => (d.sessions || 0) > 0).length;

    const hasEarlyBird = sessions.some(s => {
        const d = new Date(s.date);
        return !isNaN(d) && d.getHours() < 8;
    });

    const hasWeekendWarrior = sessions.some(s => {
        const d = new Date(s.date);
        if (isNaN(d)) return false;
        const day = d.getDay();
        return day === 0 || day === 6;
    });

    const hasFocusMaster = completedTimers >= 10;
    const hasTwoHours = totalMinutes >= 120;
    const hasGoalGetter = todaySessions >= goalTarget;
    const hasStreakStarter = (studyData.streak || 0) >= 3;
    const hasStreakBuilder = (studyData.streak || 0) >= 7;
    const hasStreakChampion = (studyData.streak || 0) >= 14;
    const hasTaskCrusher = completedTasks >= 10;
    const hasAssignmentAce = completedAssignments >= 5;
    const hasConsistencyKing = daysStudiedLast7 >= 5;
    const hasStudyMarathon = totalHours >= 10;

    return [
        {
            id: "early-bird",
            title: "Early Bird",
            desc: "Study before 8 AM",
            icon: "&#9728;",
            tone: "sunrise",
            earned: hasEarlyBird
        },
        {
            id: "weekend-warrior",
            title: "Weekend Warrior",
            desc: "Study on Saturday or Sunday",
            icon: "&#128197;",
            tone: "weekend",
            earned: hasWeekendWarrior
        },
        {
            id: "focus-master",
            title: "Focus Master",
            desc: "Complete 10 timers",
            icon: "&#127919;",
            tone: "focus",
            earned: hasFocusMaster
        },
        {
            id: "two-hour-club",
            title: "2-Hour Club",
            desc: "Time: 2 hours",
            icon: "&#9201;",
            tone: "time",
            earned: hasTwoHours
        },
        {
            id: "goal-getter",
            title: "Goal Getter",
            desc: "Hit today's daily goal",
            icon: "&#127881;",
            tone: "goal",
            earned: hasGoalGetter
        },
        {
            id: "streak-starter",
            title: "Streak Starter",
            desc: "Reach a 3-day streak",
            icon: "&#128293;",
            tone: "streak",
            earned: hasStreakStarter
        },
        {
            id: "streak-builder",
            title: "Streak Builder",
            desc: "Reach a 7-day streak",
            icon: "&#128293;",
            tone: "streak",
            earned: hasStreakBuilder
        },
        {
            id: "streak-champion",
            title: "Streak Champion",
            desc: "Reach a 14-day streak",
            icon: "&#127942;",
            tone: "streak",
            earned: hasStreakChampion
        },
        {
            id: "task-crusher",
            title: "Task Crusher",
            desc: "Complete 10 tasks",
            icon: "&#9989;",
            tone: "tasks",
            earned: hasTaskCrusher
        },
        {
            id: "assignment-ace",
            title: "Assignment Ace",
            desc: "Complete 5 assignments",
            icon: "&#128218;",
            tone: "assign",
            earned: hasAssignmentAce
        },
        {
            id: "consistency-king",
            title: "Consistency",
            desc: "Study 5 of the last 7 days",
            icon: "&#128200;",
            tone: "consistency",
            earned: hasConsistencyKing
        },
        {
            id: "study-marathon",
            title: "Study Marathon",
            desc: "Reach 10 total study hours",
            icon: "&#9200;",
            tone: "time",
            earned: hasStudyMarathon
        }
    ];
}

function renderBadges() {
    const grid = document.getElementById('badgesGrid');
    const empty = document.getElementById('badgesEmpty');
    const countEl = document.getElementById('badgeCount');
    if (!grid || !empty || !countEl) return;

    const stored = loadEarnedBadges();
    const badges = getAchievementBadges().map(b => ({
        ...b,
        earned: b.earned || stored.includes(b.id)
    }));
    const earnedIds = badges.filter(b => b.earned).map(b => b.id);
    saveEarnedBadges(Array.from(new Set(earnedIds)));

    const earnedBadges = badges.filter(b => b.earned);
    countEl.textContent = `${earnedBadges.length} earned`;

    if (earnedBadges.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'flex';
        return;
    }

    empty.style.display = 'none';
    grid.innerHTML = earnedBadges.map(b => `
        <div class="badge-item" data-tone="${b.tone || 'goal'}">
            <div class="badge-icon">${b.icon}</div>
            <div class="badge-info">
                <div class="badge-title">${b.title}</div>
                <div class="badge-desc">${b.desc}</div>
                <div class="badge-tag">Achieved</div>
            </div>
        </div>
    `).join('');
}

// ========== STUDY HEATMAP ==========
function renderStudyHeatmap() {
    const grid = document.getElementById('studyHeatmap');
    if (!grid) return;

    const daysToShow = 84; // 12 weeks
    const today = new Date();
    const dayStats = new Map();
    const daily = studyData.dailyStats || [];
    if (daily.length > 0) {
        daily.forEach(stat => {
            if (stat?.date) {
                dayStats.set(stat.date, stat.sessions || 0);
            }
        });
    } else {
        // Fallback: aggregate from studySessions if dailyStats is empty
        (studyData.studySessions || []).forEach(session => {
            if (!session?.date) return;
            const key = new Date(session.date).toDateString();
            dayStats.set(key, (dayStats.get(key) || 0) + 1);
        });
    }

    const cells = [];
    for (let i = daysToShow - 1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = d.toDateString();
        const sessions = dayStats.get(key) || 0;
        const level =
            sessions >= 4 ? 4 :
            sessions === 3 ? 3 :
            sessions === 2 ? 2 :
            sessions === 1 ? 1 : 0;
        const title = `${d.toLocaleDateString()}: ${sessions} session${sessions === 1 ? '' : 's'}`;
        cells.push(
            `<div class="heatmap-cell level-${level}" title="${title}">` +
            `<span class="heatmap-value">${sessions}</span>` +
            `</div>`
        );
    }

    grid.innerHTML = cells.join('');
}

// ========== ENGAGEMENT HEATMAP (AGGREGATE) ==========
async function getAggregateHeatmap() {
    if (!currentClassCode) return null;
    const activity = await firebaseGet(`classActivity/${currentClassCode}`);
    const buckets = Array.from({ length: 7 }, () => Array(4).fill(0));

    if (!activity) {
        return { buckets, total: 0 };
    }

    const events = Object.values(activity);
    let total = 0;

    events.forEach(evt => {
        const ts = evt?.createdAt || evt?.date || evt?.timestamp;
        if (!ts) return;
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return;
        const day = d.getDay();
        const hour = d.getHours();

        let slot = 0; // Night (0-6)
        if (hour >= 6 && hour < 12) slot = 1; // Morning
        else if (hour >= 12 && hour < 17) slot = 2; // Afternoon
        else slot = 3; // Evening (17-24)

        buckets[day][slot] += 1;
        total += 1;
    });

    return { buckets, total };
}

async function renderAggregateHeatmap() {
    const container = document.getElementById('aggregateHeatmap');
    const insightEl = document.getElementById('aggregateInsight');
    if (!container || !insightEl) return;

    const data = await getAggregateHeatmap();
    if (!data || data.total === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--spacing-lg);">
                <div class="empty-state-icon" style="font-size: 2rem;">ðŸ“Š</div>
                <div class="empty-state-description">No class activity yet.</div>
            </div>
        `;
        insightEl.textContent = "Free insights: Class activity will appear once study sessions begin.";
        return;
    }

    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const timeNames = ['Night', 'Morning', 'Afternoon', 'Evening'];
    const flat = data.buckets.flat();
    const max = Math.max(...flat, 1);

    const levelFor = (count) => {
        const ratio = count / max;
        if (ratio >= 0.8) return 4;
        if (ratio >= 0.6) return 3;
        if (ratio >= 0.4) return 2;
        if (ratio >= 0.2) return 1;
        return 0;
    };

    const headerRow = `
        <div class="aggregate-heatmap-grid">
            <div></div>
            ${timeNames.map(t => `<div class="aggregate-heatmap-time">${t}</div>`).join('')}
        </div>
    `;

    const rows = data.buckets.map((row, dayIdx) => {
        const cells = row.map((count, tIdx) => {
            const level = levelFor(count);
            return `<div class="aggregate-heatmap-cell level-${level}" title="${dayNames[dayIdx]} ${timeNames[tIdx]}: ${count} activities"></div>`;
        }).join('');
        return `
            <div class="aggregate-heatmap-grid">
                <div class="aggregate-heatmap-label">${dayNames[dayIdx]}</div>
                ${cells}
            </div>
        `;
    }).join('');

    container.innerHTML = headerRow + rows;

    let bestDay = 0;
    let bestSlot = 0;
    let bestCount = -1;
    data.buckets.forEach((row, dIdx) => {
        row.forEach((count, tIdx) => {
            if (count > bestCount) {
                bestCount = count;
                bestDay = dIdx;
                bestSlot = tIdx;
            }
        });
    });

    const insight = `Free insights: Class studies most on ${dayNames[bestDay]} ${timeNames[bestSlot].toLowerCase()}s.`;
    insightEl.textContent = insight;
}

// ========== STATISTICS & UI UPDATES ==========
function updateAllStatistics() {
    updateUI();
    updateTaskStats();
    updateSidebarStats();
    renderBadges();
    renderStudyHeatmap();
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    persistData();
}

function updateUI() {
    const streakDisplay = document.getElementById('streakDisplay');
    const streakNumber = document.getElementById('streakNumber');
    if (streakDisplay) streakDisplay.textContent = studyData.streak || 0;
    if (streakNumber) streakNumber.textContent = studyData.streak || 0;
    
    const totalHoursDisplay = document.getElementById('totalHoursDisplay');
    const hours = studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1) || 0;
    if (totalHoursDisplay) totalHoursDisplay.textContent = parseFloat(hours).toFixed(1);
    
    const tasksCompleted = tasks.filter(t => t.completed).length;
    const tasksCompletedDisplay = document.getElementById('tasksCompletedDisplay');
    if (tasksCompletedDisplay) tasksCompletedDisplay.textContent = tasksCompleted;
    
    const focusScore = calculateFocusScore();
    const focusScoreDisplay = document.getElementById('focusScoreDisplay');
    if (focusScoreDisplay) focusScoreDisplay.textContent = `${focusScore}%`;
    
    updateSidebarStats();
    updateStreakUI();
    updateDailyGoalUI();

}

function updateSidebarStats() {
    const sidebarStreak = document.getElementById('sidebarStreak');
    const sidebarHours = document.getElementById('sidebarHours');
    const sidebarTasks = document.getElementById('sidebarTasks');
    const sidebarFocus = document.getElementById('sidebarFocus');
    
    if (sidebarStreak) sidebarStreak.textContent = studyData.streak || 0;
    if (sidebarHours) {
        const hours = studyData.totalStudyHours || (studyData.totalMinutes / 60).toFixed(1) || 0;
        sidebarHours.textContent = parseFloat(hours).toFixed(1);
    }
    if (sidebarTasks) {
        const completedTasks = tasks.filter(t => t.completed).length;
        sidebarTasks.textContent = completedTasks;
    }
    if (sidebarFocus) {
        const focusScore = calculateFocusScore();
        sidebarFocus.textContent = `${focusScore}%`;
    }
}

// ========== PROFILE MANAGEMENT ==========
async function saveProfile() {
    const name = document.getElementById('studentName').value.trim();
    const email = document.getElementById('studentEmail').value.trim();
    const bio = document.getElementById('studentBio').value.trim();
    
    if (!name) {
        showNotification("Please enter your name", "error");
        return;
    }
    
    currentUserName = name;
    saveUserData();
    
    if (currentUserId) {
        try {
            await firebaseUpdate(`users/${currentUserId}`, {
                name: currentUserName,
                email: email,
                bio: bio,
                updatedAt: new Date().toISOString()
            });
            
            await saveStudyDataToFirebase();
            
        } catch (error) {
            console.error("âŒ Error saving profile to Firebase:", error);
        }
    }
    
    showNotification("Profile saved successfully!", "success");
}

async function saveProfileSettings() {
    const name = document.getElementById('profileName').value.trim();
    const email = document.getElementById('profileEmail').value.trim();
    const bio = document.getElementById('profileBio').value.trim();
    
    if (!name) {
        showNotification("Please enter your name", "error");
        return;
    }
    
    currentUserName = name;
    saveUserData();
    
    document.getElementById('studentName').value = name;
    document.getElementById('studentEmail').value = email;
    document.getElementById('studentBio').value = bio;
    
    if (currentUserId) {
        try {
            await firebaseUpdate(`users/${currentUserId}`, {
                name: currentUserName,
                email: email,
                bio: bio,
                updatedAt: new Date().toISOString()
            });
            
            await saveStudyDataToFirebase();
            
        } catch (error) {
            console.error("âŒ Error saving profile to Firebase:", error);
        }
    }
    
    showNotification("Profile settings saved successfully!", "success");
}

// ========== NAVIGATION ==========
function showSection(sectionId) {
    console.log("ðŸ“± Switching to section:", sectionId);
    
    // Hide all sections first
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Update active nav items - MORE SPECIFIC MATCHING
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        const itemText = item.textContent.trim();
        
        // EXACT MATCHING based on expected text
        const expectedTexts = {
            'dashboard': 'ðŸ“Š Dashboard',
            'tasks': 'ðŸ“ Tasks',
            'assignments': 'ðŸ“š Assignments',
            'classroom': 'ðŸ« Classroom',
            'myclasses': 'ðŸŽ“ My Classes',
            'statistics': 'ðŸ“ˆ Statistics',
            'tools': 'ðŸ› ï¸ Study Tools',
            'ai': 'ðŸ¤– AI Help',
            'profile': 'ðŸ‘¤ Profile'
        };
        
        if (expectedTexts[sectionId] && itemText === expectedTexts[sectionId]) {
            item.classList.add('active');
        }
    });
    
    // Show the requested section
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
        sectionElement.style.display = 'block';
        currentSection = sectionId;
        persistData();
        
        // Load section-specific data
        loadSectionData(sectionId);
    } else {
        console.error("âŒ Section not found:", sectionId);
        showNotification("Section not available", "error");
        
        // Fallback to dashboard
        showSection('dashboard');
    }
}

// Load section-specific data
function loadSectionData(sectionId) {
    switch(sectionId) {
        case 'dashboard':
            renderDashboardTasks();
            renderDashboardAssignments();
            updateStreakUI();
            updateUI();
            updateDailyGoalUI();
            break;
            
        case 'tasks':
            renderTasks();
            break;
            
        case 'assignments':
            renderAssignments();
            break;
            
        case 'classroom':
            loadClassroomData();
            break;
            
        case 'myclasses':
            renderClassesList();
            break;
            
        case 'statistics':
            setTimeout(updateCharts, 100);
            break;
            
        case 'tools':
            // Nothing special needed
            break;
            
        case 'ai':
            // Nothing special needed
            break;
            
        case 'profile':
            // Load profile data
            document.getElementById('profileName').value = currentUserName || '';
            document.getElementById('profileEmail').value = localStorage.getItem('studentEmail') || '';
            document.getElementById('profileBio').value = localStorage.getItem('studentBio') || '';
            updateReferralUI();
            updateRainbowUI();
            break;
        case 'exitTicket':
            renderExitTicketStudentSection();
            break;
    }
}
    


   // Fixed showStudentMemoryWall function
function showStudentMemoryWall() {
    // Hide other sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show student memory wall
    const memoryWallSection = document.getElementById('studentMemoryWall');
    if (memoryWallSection) {
        memoryWallSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent.includes('ðŸ“ Memory Wall')) {
                item.classList.add('active');
            }
        });
        
        // Update header
        const header = document.getElementById('dashboardHeader');
        if (header) {
            header.querySelector('h1').textContent = 'Class Memory Wall';
            header.querySelector('.dashboard-subtitle').textContent = 'Share memories and encouragement with classmates';
        }
        
        // Load memory wall data
        setTimeout(() => {
            loadStudentMemoryWall();
        }, 100);
    } else {
        console.error("Student memory wall section not found!");
        showNotification("Memory wall feature not available", "error");
    }
}


function getNavItemText(sectionId) {
    const navTexts = {
        'dashboard': 'ðŸ“Š',
        'tasks': 'ðŸ“',
        'assignments': 'ðŸ“š',
        'classroom': 'ðŸ«',
        'myclasses': 'ðŸŽ“',
        'statistics': 'ðŸ“ˆ',
        'tools': 'ðŸ› ï¸',
        'ai': 'ðŸ¤–',
        'profile': 'ðŸ‘¤'
    };
    return navTexts[sectionId] || '';
}

function updateDashboardHeader(sectionId) {
    const header = document.getElementById('dashboardHeader');
    const subtitle = document.getElementById('dashboardSubtitle');
    
    if (!header || !subtitle) return;
    
    switch(sectionId) {
        case 'dashboard':
            header.querySelector('h1').textContent = 'Welcome to Your Learning Dashboard';
            subtitle.textContent = 'Track your progress, manage tasks, and achieve your study goals';
            break;
        case 'tasks':
            header.querySelector('h1').textContent = 'Task Manager';
            subtitle.textContent = 'Organize and track your daily tasks';
            renderTasks();
            break;
        case 'assignments':
            header.querySelector('h1').textContent = 'Assignment Tracker';
            subtitle.textContent = 'Manage your school assignments and deadlines';
            renderAssignments();
            break;
        case 'classroom':
            header.querySelector('h1').textContent = 'Classroom';
            subtitle.textContent = 'Connect with your teacher and classmates';
            loadClassroomData();
            break;
        case 'myclasses':
            header.querySelector('h1').textContent = 'My Classes';
            subtitle.textContent = 'Manage your classrooms and join new ones';
            renderClassesList();
            break;
        case 'statistics':
            header.querySelector('h1').textContent = 'Learning Statistics';
            subtitle.textContent = 'Visualize your progress with charts and insights';
            break;
        case 'tools':
            header.querySelector('h1').textContent = 'Study Tools';
            subtitle.textContent = 'Tools and resources to enhance your learning';
            break;
        case 'ai':
            header.querySelector('h1').textContent = 'AI Learning Resources';
            subtitle.textContent = 'AI-powered tools and educational resources';
            break;
        case 'profile':
            header.querySelector('h1').textContent = 'Profile Settings';
            subtitle.textContent = 'Manage your profile and preferences';
            break;
    }
}

// ========== UTILITY FUNCTIONS ==========
function initUI() {
    const savedTheme = localStorage.getItem('studentTheme') || 'light';
    const isPremiumUnlocked = getReferralCount() >= REFERRAL_TARGET;
    const isRainbowUnlocked = (studyData.streak || 0) >= 30 || localStorage.getItem(RAINBOW_UNLOCKED_KEY) === 'true';
    const isForestUnlocked = (studyData.streak || 0) >= 7 || localStorage.getItem(FOREST_UNLOCKED_KEY) === 'true';
    let appliedTheme = savedTheme;
    if (savedTheme === 'premium' && !isPremiumUnlocked) {
        appliedTheme = 'light';
    }
    if (savedTheme === 'rainbow' && !isRainbowUnlocked) {
        appliedTheme = 'light';
    }
    if (savedTheme === 'forest' && !isForestUnlocked) {
        appliedTheme = 'light';
    }
    document.body.className = appliedTheme;
    const themeSelector = document.querySelector('.theme-selector');
    if (themeSelector) themeSelector.value = appliedTheme;
    localStorage.setItem('studentTheme', appliedTheme);
    
    loadMotivationalQuote();
    loadInspiringStories();
    renderStudyHeatmap();
    
    const nameField = document.getElementById('studentName');
    if (nameField && currentUserName) nameField.value = currentUserName;
    
    const profileNameField = document.getElementById('profileName');
    if (profileNameField && currentUserName) profileNameField.value = currentUserName;
    
    showSection(currentSection);
    
    updateReferralUI();
    updateRainbowUI();
    renderDailyChallenge();
    setInterval(syncReferralCountFromFirebase, 30000);

    updateTimeGreeting();
    applyTimeTheme();
    setInterval(updateTimeGreeting, 600000);

    const chatbotBtn = document.getElementById('chatbotBtn');
    if (chatbotBtn) {
        chatbotBtn.addEventListener('click', showChatbotMessage);
    }
    showChatbotGreetingThenChallenge();
    scheduleChatbotMessage();
    updateStatsCompare();

    console.log("ðŸŽ¨ UI initialized with theme:", savedTheme);
}

function setupEventListeners() {
    const taskInput = document.getElementById('taskInput');
    if (taskInput) {
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
    }
    
    const taskInputFull = document.getElementById('taskInputFull');
    if (taskInputFull) {
        taskInputFull.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });
    }
    
    const hoursInput = document.getElementById('hoursInput');
    if (hoursInput) {
        hoursInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addStudyHours();
        });
    }
    
    document.getElementById('storyModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeStoryModal();
        }
    });

    const rainbowModal = document.getElementById('rainbowModal');
    if (rainbowModal) {
        rainbowModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRainbowModal();
            }
        });
    }
    const forestModal = document.getElementById('forestModal');
    if (forestModal) {
        forestModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeForestModal();
            }
        });
    }
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeStoryModal();
            closeRainbowModal();
            closeForestModal();
        }
    });
}

function loadAllData() {
    renderTasks();
    renderDashboardTasks();
    renderAssignments();
    renderDashboardAssignments();
    loadClassroomData();
    loadMotivationalQuote();
    loadInspiringStories();
    updateClassSelector();
    renderClassesList();
    
    const savedProfile = localStorage.getItem('studentProfile');
    if (savedProfile) {
        const profile = JSON.parse(savedProfile);
        document.getElementById('studentName').value = profile.name || '';
        document.getElementById('studentEmail').value = profile.email || '';
        document.getElementById('studentBio').value = profile.bio || '';
        document.getElementById('profileName').value = profile.name || '';
        document.getElementById('profileEmail').value = profile.email || '';
        document.getElementById('profileBio').value = profile.bio || '';
        currentUserName = profile.name || 'Student';
    }
    initDailyGoalInput();

}

// ========== MOTIVATIONAL QUOTES ==========
function loadMotivationalQuote() {
    const randomQuote = inspiringQuotes[Math.floor(Math.random() * inspiringQuotes.length)];
    document.getElementById('dailyQuote').textContent = `"${randomQuote.text}"`;
    document.getElementById('quoteAuthor').textContent = `â€” ${randomQuote.author}`;
}

// ========== TIME OF DAY THEMING + GREETING ==========
function getTimeGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return "Good morning! Ready to grind?";
    if (hour >= 12 && hour < 18) return "Good afternoon! Keep the momentum going.";
    if (hour >= 18 && hour < 22) return "Good evening! Time to make progress.";
    return "Late night study session?";
}

function isDaytime() {
    const hour = new Date().getHours();
    return hour >= 6 && hour < 18;
}

function updateTimeGreeting() {
    const el = document.getElementById('timeGreeting');
    if (el) el.textContent = getTimeGreeting();
}

function applyTimeTheme() {
    const savedTheme = localStorage.getItem('studentTheme') || 'light';
    if (savedTheme !== 'light' && savedTheme !== 'dark') return;
    const nextTheme = isDaytime() ? 'light' : 'dark';
    if (savedTheme !== nextTheme) {
        document.body.className = nextTheme;
        localStorage.setItem('studentTheme', nextTheme);
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = nextTheme;
    }
}

function newQuote() {
    loadMotivationalQuote();
    showNotification("New inspiration loaded! ðŸ’«", "info");
}

// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'ðŸ’¡';
    if (type === 'success') icon = 'âœ…';
    if (type === 'error') icon = 'âŒ';
    if (type === 'warning') icon = 'âš ï¸';
    if (type === 'info') icon = 'â„¹ï¸';
    
    toast.innerHTML = `
        <span style="font-size: 1.5rem;">${icon}</span>
        <div style="flex: 1;">
            <div style="font-weight: 700;">${message}</div>
            <div style="font-size: 0.875rem; opacity: 0.8;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

function updateSyncStatus(text, type = "info") {
    const syncStatus = document.getElementById('syncStatus');
    const syncIcon = syncStatus.querySelector('.sync-icon');
    const syncText = syncStatus.querySelector('.sync-text');
    
    if (!syncStatus) return;
    
    syncStatus.style.display = 'flex';
    syncStatus.className = `sync-status ${type}`;
    syncText.textContent = text;
    
    let icon = 'â³';
    if (type === 'success') icon = 'âœ…';
    if (type === 'error') icon = 'âŒ';
    if (type === 'warning') icon = 'âš ï¸';
    if (type === 'info') icon = 'â„¹ï¸';
    
    syncIcon.textContent = icon;
    
    if (type === 'success') {
        setTimeout(() => {
            syncStatus.style.opacity = '0';
            setTimeout(() => {
                syncStatus.style.display = 'none';
                syncStatus.style.opacity = '1';
            }, 300);
        }, 2000);
    }
}

// ========== THEME MANAGEMENT ==========
function changeTheme(theme) {
    const current = localStorage.getItem('studentTheme') || 'light';
    const referrals = getReferralCount();
    const wasFocus = document.body.classList.contains('focus-mode');
    const wasBlocker = document.body.classList.contains('focus-blocker-enabled');
    if (theme === 'premium' && referrals < REFERRAL_TARGET) {
        document.body.className = 'premium';
        if (wasFocus) document.body.classList.add('focus-mode');
        if (wasBlocker) document.body.classList.add('focus-blocker-enabled');
        openReferralModal();
        return;
    }
    if (theme === 'forest' && (studyData.streak || 0) < 7 && localStorage.getItem(FOREST_UNLOCKED_KEY) !== 'true') {
        previewForestTheme();
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = current;
        return;
    }
    if (theme === 'rainbow' && (studyData.streak || 0) < 30) {
        previewRainbowTheme();
        const themeSelector = document.querySelector('.theme-selector');
        if (themeSelector) themeSelector.value = current;
        return;
    } else {
        document.body.className = theme;
    }
    if (wasFocus) document.body.classList.add('focus-mode');
    if (wasBlocker) document.body.classList.add('focus-blocker-enabled');
    localStorage.setItem('studentTheme', theme);
    
    // Recreate charts with new theme colors
    if (currentSection === 'statistics') {
        setTimeout(updateCharts, 100);
    }
    
    showNotification(`Switched to ${theme} theme`, "success");
}

// ========== DATA IMPORT/EXPORT ==========
function exportData() {
    const allData = {
        exportDate: new Date().toISOString(),
        version: "2.5",
        user: {
            id: currentUserId,
            name: currentUserName,
            classes: userClasses
        },
        studyData: studyData,
        tasks: tasks,
        assignments: assignments,
        profile: JSON.parse(localStorage.getItem('studentProfile') || '{}')
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `student-data-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification("All data exported successfully", "success");
}

function clearAllData() {
    if (confirm("âš ï¸ This will delete ALL your data including tasks, assignments, study history, and profile. This cannot be undone! Continue?")) {
        localStorage.removeItem('studentPersistentData');
        localStorage.removeItem('studentTasks');
        localStorage.removeItem('studentAssignments');
        localStorage.removeItem('studentStudyData');
        localStorage.removeItem('studentProfile');
        localStorage.removeItem('studentUserClasses');
        localStorage.removeItem('studentUserId');
        localStorage.removeItem('studentName');
        localStorage.removeItem('studentTheme');
        
        tasks = [];
        assignments = [];
        studyData = {
            streak: 0,
            lastStudyDate: "",
            totalMinutes: 0,
            totalStudyDays: 0,
            totalStudyHours: 0,
            studySessions: [],
            weeklyPattern: [0, 0, 0, 0, 0, 0, 0],
            streakHistory: [],
            streakMilestones: [3, 7, 14, 30, 60, 90],
            currentMilestone: 0,
            dailyStats: [],
            focusScores: [],
            consistencyScores: []
        };
        userClasses = [];
        currentClassCode = null;
        selectedClassIndex = -1;
        currentUserId = `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        currentUserName = 'Student';
        
        document.getElementById('studentName').value = '';
        document.getElementById('studentEmail').value = '';
        document.getElementById('studentBio').value = '';
        document.getElementById('profileName').value = '';
        document.getElementById('profileEmail').value = '';
        document.getElementById('profileBio').value = '';
        document.getElementById('hoursInput').value = '';
        
        localStorage.setItem('studentUserId', currentUserId);
        
        loadAllData();
        updateAllStatistics();
        
        showNotification("All data cleared", "info");
    }
}

// ========== AUTOSAVE AND REFRESH ==========
function refreshData() {
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = 'ðŸ”„ Refreshing...';
    refreshBtn.disabled = true;
    
    loadAllData();
    updateAllStatistics();
    
    if (currentSection === 'statistics') {
        updateCharts();
    }
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
        showNotification("All data refreshed", "success");
    }, 1000);
}
// ========== FEEDBACK FORM ==========
function openFeedbackForm() {
    window.open('https://docs.google.com/forms/d/e/1FAIpQLScJMM1dwIx3HvSu9mxyZm3HgZ7UO7QwLX673JKellaKLSM7EQ/viewform?usp=publish-editor', '_blank');
}

// ========== STREAK SHARE (capture full streak card) ==========
async function captureStreakCard() {
    const card = document.querySelector('.streak-card');
    if (!card) throw new Error('Streak card not found');

    const canvas = await html2canvas(card, {
        backgroundColor: null,
        scale: 2
    });

    return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), 'image/png', 1.0);
    });
}

// Placeholder: replace with work.ink shortener once you provide endpoint/token
async function shortenUrl(longUrl) {
    return longUrl;
}

async function shareStreak() {
    const msg = document.getElementById('streakShareMsg');
    const shareBtn = document.getElementById('shareStreakBtn');

    if (!msg || !shareBtn) return;

    showNotification("Generating your streak imageâ€¦ please wait", "info");
    msg.textContent = 'Generating your streak image...';
    shareBtn.disabled = true;

    try {
        const card = document.querySelector('.streak-card');
        if (!card) throw new Error('Streak card not found');

        const canvas = await html2canvas(card, { backgroundColor: null, scale: 2 });
        const dataUrl = canvas.toDataURL('image/png');

        await navigator.clipboard.writeText(dataUrl);

        showNotification("URL copied! Paste it into a browser or chat to share.", "success");
        msg.textContent = 'URL copied! Paste into a browser or message.';
    } catch (err) {
        console.error(err);
        showNotification("Could not generate URL. Try again.", "error");
        msg.textContent = 'Could not generate the URL. Try again.';
    } finally {
        shareBtn.disabled = false;
    }
}



document.addEventListener('DOMContentLoaded', () => {
    const shareBtn = document.getElementById('shareStreakBtn');
    if (shareBtn) shareBtn.addEventListener('click', shareStreak);
});


// ========== INITIALIZATION COMPLETE ==========
console.log("âœ… Student Mode initialized successfully!");
// Add to all pages (guard analytics when SDK isn't loaded)
if (window.firebase && firebase.analytics) {
  firebase.analytics().logEvent('page_view', { page_location: window.location.href });
}



// Function to load memory wall for students
function loadStudentMemoryWall() {
    if (!currentClassCode) return;
    
    try {
        database.ref(`memoryWall/${currentClassCode}`).on('value', (snapshot) => {
            const memoriesContainer = document.getElementById('studentMemoryWall');
            if (!memoriesContainer) return;
            
            if (snapshot.exists()) {
                const memories = [];
                snapshot.forEach(child => {
                    memories.push(child.val());
                });
                
                // Sort by date (newest first)
                memories.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render memories
                memoriesContainer.innerHTML = memories.map(memory => `
                    <div class="memory-card">
                        <div class="memory-text">${memory.text}</div>
                        <div class="memory-footer">
                            <span class="memory-author">ðŸ‘¤ ${memory.author}</span>
                            <span class="memory-date">${getTimeAgo(memory.createdAt)}</span>
                        </div>
                        <button class="btn-like" onclick="likeMemoryAsStudent('${memory.id}')">
                            ðŸ‘ ${memory.likes || 0}
                        </button>
                    </div>
                `).join('');
            }
        });
    } catch (error) {
        console.error("Error loading memory wall for students:", error);
    }
}

function openExitTicketFromStudent() {
  showSection('exitTicket');
}

async function renderExitTicketStudentSection() {
  const questionsEl = document.getElementById('exitTicketStudentQuestions');
  const statusEl = document.getElementById('exitTicketStudentStatus');
  if (statusEl) statusEl.textContent = '';
  if (!currentClassCode) {
    if (questionsEl) questionsEl.textContent = 'Join a class to view Exit Tickets.';
    return;
  }
  if (questionsEl) questionsEl.textContent = 'Loading questions...';
  try {
    if (!database) throw new Error('No database');
    const snap = await database.ref(`exitTickets/${currentClassCode}/current`).once('value');
    if (!snap.exists()) {
      if (questionsEl) questionsEl.textContent = 'No Exit Ticket available yet.';
      return;
    }
    const data = snap.val();
    const questions = data.questions || [];
    if (!questions.length) {
      if (questionsEl) questionsEl.textContent = 'No Exit Ticket questions found.';
      return;
    }
    if (questionsEl) {
      questionsEl.innerHTML = questions.map((q, idx) => `<div style="margin-bottom: 8px;"><strong>${idx + 1}.</strong> ${q}</div>`).join('');
    }
  } catch (error) {
    if (questionsEl) questionsEl.textContent = 'Unable to load Exit Ticket. Please try again.';
  }
}

async function submitExitTicketStudent() {
  const statusEl = document.getElementById('exitTicketStudentStatus');
  const thankYouEl = document.getElementById('exitTicketThankYou');
  const formCard = document.getElementById('exitTicketFormCard');
  if (!currentClassCode) {
    if (statusEl) statusEl.textContent = 'Join a class to submit.';
    return;
  }
  const answers = [
    document.getElementById('exitTicketAnswer1').value.trim(),
    document.getElementById('exitTicketAnswer2').value.trim(),
    document.getElementById('exitTicketAnswer3').value.trim()
  ];
  if (!answers[0] && !answers[1] && !answers[2]) {
    if (statusEl) statusEl.textContent = 'Please answer at least one question.';
    return;
  }
  const payload = {
    answers: answers,
    submittedAt: new Date().toISOString(),
    student: localStorage.getItem('studentName') || 'Student'
  };
  try {
    if (!database) throw new Error('No database');
    await database.ref(`exitTickets/${currentClassCode}/responses`).push().set(payload);
    if (statusEl) statusEl.textContent = 'Exit Ticket submitted. Thank you!';
    if (formCard) formCard.style.display = 'none';
    if (thankYouEl) thankYouEl.style.display = 'block';
  } catch (error) {
    if (statusEl) statusEl.textContent = 'Unable to submit. Please try again.';
  }
}





// Student Mode Memory Wall Functions
let studentSelectedNoteColor = '#FFEB3B';
let studentMemoryWallNotes = [];

// Load memory wall for students
function loadStudentMemoryWall() {
    if (!currentClassCode) return;
    
    try {
        database.ref(`memoryWall/${currentClassCode}/notes`).on('value', (snapshot) => {
            if (snapshot.exists()) {
                studentMemoryWallNotes = [];
                snapshot.forEach(child => {
                    studentMemoryWallNotes.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                renderStudentStickyNotes();
            } else {
                studentMemoryWallNotes = [];
                renderStudentStickyNotes();
            }
        });
    } catch (error) {
        console.error("Error loading memory wall for student:", error);
        studentMemoryWallNotes = [];
        renderStudentStickyNotes();
    }
}

// Toggle add memory form for students
function studentToggleAddMemoryForm() {
    const form = document.getElementById('studentAddMemoryForm');
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        document.getElementById('studentMemoryText').focus();
        
        // Set up character count
        const textarea = document.getElementById('studentMemoryText');
        const charCount = document.getElementById('studentMemoryCharCount');
        
        textarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            
            if (length > 300) {
                this.value = this.value.substring(0, 300);
                charCount.textContent = '300';
                charCount.style.color = 'var(--danger)';
            } else {
                charCount.style.color = 'var(--text-muted)';
            }
        });
        
        // Set student name if available
        const studentName = localStorage.getItem('studentName') || 'Student';
        document.getElementById('studentMemoryAuthor').value = studentName;
    } else {
        form.style.display = 'none';
    }
}

// Student select note color
function studentSelectNoteColor(color) {
    studentSelectedNoteColor = color;
    
    // Update selected state
    document.querySelectorAll('#studentAddMemoryForm .color-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.color === color) {
            option.classList.add('selected');
        }
    });
}

// Student add memory
function studentAddMemoryFromForm() {
    const text = document.getElementById('studentMemoryText').value.trim();
    const author = document.getElementById('studentMemoryAuthor').value.trim() || 'Student';
    
    if (!text) {
        showNotification("Please write something for your memory note!", "error");
        return;
    }
    
    // Get student ID
    const studentId = localStorage.getItem('studentUserId') || 'student_' + Date.now();
    
    // Create new note
    const note = {
        id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        text: text,
        author: author,
        color: studentSelectedNoteColor,
        x: Math.random() * 70 + 10,
        y: Math.random() * 70 + 10,
        rotation: (Math.random() * 8) - 4,
        likes: 0,
        likedBy: [],
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        studentId: studentId,
        isStudentNote: true
    };
    
    try {
        const noteRef = database.ref(`memoryWall/${currentClassCode}/notes`).push();
        note.id = noteRef.key;
        
        noteRef.set(note)
            .then(() => {
                showNotification("Your memory has been added to the wall! ðŸ“", "success");
                
                // Clear form
                document.getElementById('studentMemoryText').value = '';
                document.getElementById('studentMemoryCharCount').textContent = '0';
                studentToggleAddMemoryForm();
            })
            .catch(error => {
                console.error("Error saving student note:", error);
                showNotification("Failed to save note: " + error.message, "error");
            });
    } catch (error) {
        console.error("Error saving student note:", error);
        showNotification("Error saving note", "error");
    }
}

// Render student sticky notes
function renderStudentStickyNotes() {
    const container = document.getElementById('studentStickyNotesContainer');
    if (!container) return;
    
    // Clear container
    container.innerHTML = '';
    
    if (studentMemoryWallNotes.length === 0) {
        // Show welcome message
        const welcomeNote = document.createElement('div');
        welcomeNote.className = 'sticky-note welcome';
        welcomeNote.style.position = 'absolute';
        welcomeNote.style.top = '50%';
        welcomeNote.style.left = '50%';
        welcomeNote.style.transform = 'translate(-50%, -50%) rotate(-1deg)';
        welcomeNote.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        welcomeNote.style.color = 'white';
        welcomeNote.style.width = '300px';
        welcomeNote.style.textAlign = 'center';
        
        welcomeNote.innerHTML = `
            <div class="note-content">
                <div class="note-text">Welcome to our Class Memory Wall! ðŸŽ‰<br><br>Share memories, achievements, or encouraging words!</div>
                <div class="note-meta">
                    <span class="note-author">ðŸ‘¨â€ðŸ« Teacher</span>
                </div>
            </div>
        `;
        
        container.appendChild(welcomeNote);
        return;
    }
    
    // Create each sticky note
    studentMemoryWallNotes.forEach(note => {
        const noteElement = createStudentStickyNoteElement(note);
        container.appendChild(noteElement);
    });
}

// Create student sticky note element
// In your createStudentStickyNoteElement() function
function createStudentStickyNoteElement(note) {
    try {
        const noteElement = document.createElement('div');
        noteElement.className = 'student-sticky-note';
        noteElement.id = `student-note-${note.id}`;
        
        // Apply note properties
        noteElement.style.background = note.color || '#FFEB3B';
        noteElement.style.left = `${note.x || 20}%`;
        noteElement.style.top = `${note.y || 20}%`;
        noteElement.style.transform = `rotate(${note.rotation || 0}deg)`;
        noteElement.style.zIndex = '2';
        
        // ADD THIS: Force dark text on light backgrounds
        const isLightColor = [
            '#FFEB3B', '#FFF9C4', '#C8E6C9', '#BBDEFB', 
            '#E1BEE7', '#FFCCBC', '#FFFFFF'
        ].some(color => (note.color || '').toUpperCase().includes(color));
        
        if (isLightColor) {
            noteElement.style.color = '#333';
        }
        
        // Format date
        const date = new Date(note.createdAt || Date.now());
        const timeAgo = getTimeAgo(note.createdAt);
        
        // Create note content
        noteElement.innerHTML = `
            <div class="student-note-content">
                <div class="student-note-text" style="color: inherit;">
                    ${escapeHtml(note.text || '')}
                </div>
                <div class="student-note-meta" style="color: inherit;">
                    <div class="student-note-author" style="color: inherit;">
                        ðŸ‘¤ ${escapeHtml(note.author || 'Anonymous')}
                        ${note.isStudentNote ? ' ðŸ‘¨â€ðŸŽ“' : ''}
                    </div>
                    <div class="student-note-date" style="color: inherit;" title="${date.toLocaleString()}">
                        ${timeAgo}
                    </div>
                </div>
                <div class="student-note-actions">
                    <div class="student-note-likes" style="color: inherit;">
                        <span>ðŸ‘</span>
                        <span>${note.likes || 0}</span>
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn-student-note btn-like" onclick="studentLikeNote('${note.id}', event)" style="color: #e63946;">
                        ðŸ‘
                    </button>
                </div>
            </div>
        `;
        
        // Add drag functionality
        setupStudentNoteDragging(noteElement, note);
        
        return noteElement;
    } catch (error) {
        console.error("Error creating student sticky note:", error, note);
        return null;
    }
}
// Setup student note dragging (temporary drag, doesn't save)
function setupStudentNoteDragging(noteElement) {
    let isDragging = false;
    let startX, startY;
    
    noteElement.addEventListener('mousedown', startDrag);
    noteElement.addEventListener('touchstart', startDragTouch);
    
    function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        startX = e.clientX - noteElement.offsetLeft;
        startY = e.clientY - noteElement.offsetTop;
        
        noteElement.classList.add('dragging');
        noteElement.style.zIndex = '1000';
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
    }
    
    function startDragTouch(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (e.touches.length === 1) {
            isDragging = true;
            const touch = e.touches[0];
            startX = touch.clientX - noteElement.offsetLeft;
            startY = touch.clientY - noteElement.offsetTop;
            
            noteElement.classList.add('dragging');
            noteElement.style.zIndex = '1000';
            
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', stopDragTouch);
        }
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        let newX = e.clientX - startX - whiteboardRect.left;
        let newY = e.clientY - startY - whiteboardRect.top;
        
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
    }
    
    function dragTouch(e) {
        if (!isDragging || e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        let newX = touch.clientX - startX - whiteboardRect.left;
        let newY = touch.clientY - startY - whiteboardRect.top;
        
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        noteElement.classList.remove('dragging');
        noteElement.style.zIndex = '2';
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
    }
    
    function stopDragTouch() {
        if (!isDragging) return;
        
        isDragging = false;
        noteElement.classList.remove('dragging');
        noteElement.style.zIndex = '2';
        
        document.removeEventListener('touchmove', dragTouch);
        document.removeEventListener('touchend', stopDragTouch);
    }
}

// Student like note
function studentLikeNote(noteId, event) {
    if (event) event.stopPropagation();
    
    const note = studentMemoryWallNotes.find(n => n.id === noteId);
    if (!note) return;
    
    // Get student ID
    const studentId = localStorage.getItem('studentUserId');
    if (!studentId) {
        showNotification("Please log in to like notes", "error");
        return;
    }
    
    // Check if already liked
    if (note.likedBy && note.likedBy.includes(studentId)) {
        showNotification("You already liked this note!", "info");
        return;
    }
    
    // Update in Firebase
    const newLikes = (note.likes || 0) + 1;
    const newLikedBy = [...(note.likedBy || []), studentId];
    
    database.ref(`memoryWall/${currentClassCode}/notes/${noteId}`).update({
        likes: newLikes,
        likedBy: newLikedBy
    })
    .then(() => {
        // Update UI
        note.likes = newLikes;
        note.likedBy = newLikedBy;
        
        const noteElement = document.getElementById(`student-note-${noteId}`);
        if (noteElement) {
            const likesSpan = noteElement.querySelector('.note-likes span:last-child');
            if (likesSpan) {
                likesSpan.textContent = newLikes;
            }
        }
        
        showNotification("Liked! ðŸ‘", "success");
    })
    .catch(error => {
        console.error("Error liking note:", error);
        showNotification("Failed to like note", "error");
    });
}





// Add this to your student mode navigation
// Memory Wall Navigation - Fixed
function showStudentMemoryWall() {
    console.log("ðŸ“ Showing student memory wall");
    
    // Hide all sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show memory wall
    const memoryWallSection = document.getElementById('studentMemoryWall');
    if (memoryWallSection) {
        memoryWallSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent.includes('ðŸ“ Memory Wall')) {
                item.classList.add('active');
            }
        });
        
        // Load memory wall data
        loadStudentMemoryWall();
    } else {
        console.error("Memory wall section not found!");
        showNotification("Memory wall feature not available", "error");
        showSection('dashboard'); // Fallback
    }
}








// Student Mode Memory Wall Navigation
let studentSelectedAddMemoryColor = '#FFEB3B';

// Show student memory wall
function showStudentMemoryWall() {
    // Hide other sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show student memory wall
    document.getElementById('studentMemoryWall').style.display = 'block';
    
    // Load memory wall data
    loadStudentMemoryWall();
}

// Show student add memory page
function showStudentAddMemoryPage() {
    document.getElementById('studentMemoryWall').style.display = 'none';
    document.getElementById('studentAddMemoryPage').style.display = 'block';
    
    // Reset form
    document.getElementById('studentAddMemoryText').value = '';
    document.getElementById('studentAddMemoryCharCount').textContent = '0';
    document.getElementById('studentAddMemoryPreviewText').textContent = 'Your memory will appear here...';
    
    // Set student name
    const studentName = localStorage.getItem('studentName') || 'Student';
    document.getElementById('studentAddMemoryAuthor').value = studentName;
    document.getElementById('studentAddMemoryPreviewAuthor').textContent = studentName;
    
    // Reset color
    studentSelectAddMemoryColor('#FFEB3B');
    
    // Setup preview
    setupStudentMemoryPreview();
}

// Go back to student memory wall
function studentBackToMemoryWall() {
    document.getElementById('studentAddMemoryPage').style.display = 'none';
    document.getElementById('studentMemoryWall').style.display = 'block';
}

// Student select color
function studentSelectAddMemoryColor(color) {
    studentSelectedAddMemoryColor = color;
    
    document.querySelectorAll('#studentAddMemoryPage .color-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.color === color) {
            option.classList.add('selected');
        }
    });
    
    document.getElementById('studentAddMemoryPreview').style.background = color;
}

// Setup student memory preview
function setupStudentMemoryPreview() {
    const textInput = document.getElementById('studentAddMemoryText');
    const authorInput = document.getElementById('studentAddMemoryAuthor');
    const charCount = document.getElementById('studentAddMemoryCharCount');
    
    textInput.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = length;
        
        document.getElementById('studentAddMemoryPreviewText').textContent = 
            this.value || 'Your memory will appear here...';
        
        if (length > 300) {
            this.value = this.value.substring(0, 300);
            charCount.textContent = '300';
            charCount.style.color = 'var(--danger)';
        } else {
            charCount.style.color = 'var(--text-muted)';
        }
    });
    
    authorInput.addEventListener('input', function() {
        const author = this.value.trim() || 'Student';
        document.getElementById('studentAddMemoryPreviewAuthor').textContent = author;
    });
}

// Student submit memory
function studentSubmitMemory() {
    const text = document.getElementById('studentAddMemoryText').value.trim();
    const author = document.getElementById('studentAddMemoryAuthor').value.trim() || 'Student';
    const studentId = localStorage.getItem('studentUserId') || 'student_' + Date.now();
    
    if (!text) {
        showNotification("Please write something for your memory note!", "error");
        return;
    }
    
    if (text.length < 10) {
        showNotification("Please write a bit more (at least 10 characters)", "warning");
        return;
    }
    
    const note = {
        id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        text: text,
        author: author,
        color: studentSelectedAddMemoryColor,
        x: Math.random() * 70 + 10,
        y: Math.random() * 70 + 10,
        rotation: (Math.random() * 8) - 4,
        likes: 0,
        likedBy: [],
        createdAt: new Date().toISOString(),
        classCode: currentClassCode,
        isTeacherNote: false,
        studentId: studentId,
        isStudentNote: true
    };
    
    try {
        const noteRef = database.ref(`memoryWall/${currentClassCode}/notes`).push();
        note.id = noteRef.key;
        
        noteRef.set(note)
            .then(() => {
                showNotification("Your memory has been added to the wall! ðŸ“", "success");
                studentBackToMemoryWall();
            })
            .catch(error => {
                console.error("Error saving student note:", error);
                showNotification("Failed to save note: " + error.message, "error");
            });
    } catch (error) {
        console.error("Error saving student note:", error);
        showNotification("Error saving note", "error");
    }
}








// Replace the existing showStudentMemoryWall function with this:
function showStudentMemoryWall() {
    // Hide other sections
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show student memory wall
    const memoryWallSection = document.getElementById('studentMemoryWall');
    if (memoryWallSection) {
        memoryWallSection.style.display = 'block';
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.textContent.includes('ðŸ“ Memory Wall')) {
                item.classList.add('active');
            }
        });
        
        // Load memory wall data
        loadStudentMemoryWall();
    } else {
        console.error("Student memory wall section not found!");
    }
}

// Add student memory wall loading function
function loadStudentMemoryWall() {
    if (!currentClassCode) {
        showNotification("Please join a class first", "error");
        return;
    }
    
    try {
        database.ref(`memoryWall/${currentClassCode}/notes`).on('value', (snapshot) => {
            if (snapshot.exists()) {
                studentMemoryWallNotes = [];
                snapshot.forEach(child => {
                    studentMemoryWallNotes.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                renderStudentStickyNotes();
                updateStudentMemoryWallStats();
            } else {
                studentMemoryWallNotes = [];
                renderStudentStickyNotes();
            }
        });
    } catch (error) {
        console.error("Error loading memory wall for student:", error);
    }
}

// Student render sticky notes

// Student memory wall stats
function updateStudentMemoryWallStats() {
    const totalNotes = studentMemoryWallNotes.length;
    const totalLikes = studentMemoryWallNotes.reduce((sum, note) => sum + (note.likes || 0), 0);
    const studentNotes = studentMemoryWallNotes.filter(note => note.isStudentNote).length;
    
    const totalEl = document.getElementById('studentTotalNotesCount');
    const likesEl = document.getElementById('studentTotalLikesCount');
    const studentEl = document.getElementById('studentNotesCount');
    
    if (totalEl) totalEl.textContent = totalNotes;
    if (likesEl) likesEl.textContent = totalLikes;
    if (studentEl) studentEl.textContent = studentNotes;
}





// COMPLETE Student Sticky Notes Renderer
function renderStudentStickyNotes() {
    const container = document.getElementById('studentStickyNotesContainer');
    if (!container) {
        console.error("Student sticky notes container not found!");
        return;
    }
    
    // Clear container
    container.innerHTML = '';
    
    if (!studentMemoryWallNotes || studentMemoryWallNotes.length === 0) {
        // Show welcome message for student
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (whiteboard) {
            const welcomeNote = document.createElement('div');
            welcomeNote.className = 'student-welcome-note';
            
            welcomeNote.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ðŸŽ‰</div>
                <div style="font-weight: 700; font-size: 1.25rem; margin-bottom: var(--spacing-sm);">
                    Welcome to the Class Memory Wall!
                </div>
                <div style="line-height: 1.5; opacity: 0.9;">
                    Be the first to share a memory, achievement, or encouraging word!
                </div>
            `;
            
            whiteboard.appendChild(welcomeNote);
        }
        updateStudentMemoryWallStats();
        return;
    }
    
    // Remove any existing welcome note
    const welcomeNote = document.querySelector('.student-welcome-note');
    if (welcomeNote) {
        welcomeNote.remove();
    }
    
    // Create each sticky note
    studentMemoryWallNotes.forEach(note => {
        const noteElement = createStudentStickyNoteElement(note);
        if (noteElement) {
            container.appendChild(noteElement);
        }
    });
    
    updateStudentMemoryWallStats();
}

// Create individual student sticky note element
function createStudentStickyNoteElement(note) {
    try {
        const noteElement = document.createElement('div');
        noteElement.className = 'student-sticky-note';
        noteElement.id = `student-note-${note.id}`;
        
        // Apply note properties
        noteElement.style.background = note.color || '#FFEB3B';
        noteElement.style.left = `${note.x || 20}%`;
        noteElement.style.top = `${note.y || 20}%`;
        noteElement.style.transform = `rotate(${note.rotation || 0}deg)`;
        noteElement.style.zIndex = '2';
        
        // Format date
        const date = new Date(note.createdAt || Date.now());
        const timeAgo = getTimeAgo(note.createdAt);
        
        // Create note content
        noteElement.innerHTML = `
            <div class="student-note-content">
                <div class="student-note-text">
                    ${escapeHtml(note.text || '')}
                </div>
                <div class="student-note-meta">
                    <div class="student-note-author">
                        ðŸ‘¤ ${escapeHtml(note.author || 'Anonymous')}
                        ${note.isStudentNote ? ' ðŸ‘¨â€ðŸŽ“' : ''}
                    </div>
                    <div class="student-note-date" title="${date.toLocaleString()}">
                        ${timeAgo}
                    </div>
                </div>
                <div class="student-note-actions">
                    <div class="student-note-likes">
                        <span>ðŸ‘</span>
                        <span>${note.likes || 0}</span>
                    </div>
                    <div style="flex-grow: 1;"></div>
                    <button class="btn-student-note btn-like" onclick="studentLikeNote('${note.id}', event)">
                        ðŸ‘
                    </button>
                </div>
            </div>
        `;
        
        // Add drag functionality for students
        setupStudentNoteDragging(noteElement, note);
        
        return noteElement;
    } catch (error) {
        console.error("Error creating student sticky note:", error, note);
        return null;
    }
}

// Setup dragging for student notes
function setupStudentNoteDragging(noteElement, note) {
    let isDragging = false;
    let startX, startY, initialX, initialY;
    
    const startDrag = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        isDragging = true;
        
        if (e.type === 'touchstart') {
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
        } else {
            startX = e.clientX;
            startY = e.clientY;
        }
        
        // Get current position
        const rect = noteElement.getBoundingClientRect();
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (!whiteboard) return;
        
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        initialX = rect.left - whiteboardRect.left;
        initialY = rect.top - whiteboardRect.top;
        
        noteElement.classList.add('dragging');
        noteElement.style.zIndex = '1000';
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', dragTouch);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDragTouch);
    };
    
    const drag = (e) => {
        if (!isDragging) return;
        
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (!whiteboard) return;
        
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        const currentX = e.clientX;
        const currentY = e.clientY;
        
        const deltaX = currentX - startX;
        const deltaY = currentY - startY;
        
        let newX = initialX + deltaX;
        let newY = initialY + deltaY;
        
        // Convert to percentages
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        // Keep within bounds
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
        
        // Update note data
        note.x = boundedX;
        note.y = boundedY;
    };
    
    const dragTouch = (e) => {
        if (!isDragging || e.touches.length !== 1) return;
        
        const touch = e.touches[0];
        const whiteboard = document.getElementById('studentMemoryWhiteboard');
        if (!whiteboard) return;
        
        const whiteboardRect = whiteboard.getBoundingClientRect();
        
        const currentX = touch.clientX;
        const currentY = touch.clientY;
        
        const deltaX = currentX - startX;
        const deltaY = currentY - startY;
        
        let newX = initialX + deltaX;
        let newY = initialY + deltaY;
        
        const xPercent = (newX / whiteboardRect.width) * 100;
        const yPercent = (newY / whiteboardRect.height) * 100;
        
        const boundedX = Math.max(0, Math.min(95, xPercent));
        const boundedY = Math.max(0, Math.min(95, yPercent));
        
        noteElement.style.left = `${boundedX}%`;
        noteElement.style.top = `${boundedY}%`;
        
        note.x = boundedX;
        note.y = boundedY;
    };
    
    const stopDrag = () => {
        if (!isDragging) return;
        
        isDragging = false;
        noteElement.classList.remove('dragging');
        noteElement.style.zIndex = '2';
        
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', dragTouch);
        document.removeEventListener('touchend', stopDragTouch);
        
        // Save position (students can only drag temporarily, not save)
        // Note: Student dragging is temporary, positions aren't saved to Firebase
    };
    
    const stopDragTouch = () => {
        stopDrag();
    };
    
    // Add event listeners
    noteElement.addEventListener('mousedown', startDrag);
    noteElement.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrag(e);
    }, { passive: false });
}

// Helper function for time ago
function getTimeAgo(dateString) {
    if (!dateString) return 'Recently';
    
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Recently';
    
    const now = new Date();
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / 60000);
    
    if (diffMinutes < 1) return 'Just now';
    if (diffMinutes < 60) return `${diffMinutes}m ago`;
    
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Escape HTML helper
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

// Update student memory wall stats
function updateStudentMemoryWallStats() {
    if (!studentMemoryWallNotes) {
        studentMemoryWallNotes = [];
    }
    
    const totalNotes = studentMemoryWallNotes.length;
    const totalLikes = studentMemoryWallNotes.reduce((sum, note) => sum + (note.likes || 0), 0);
    
    // Count student's own notes
    const studentId = localStorage.getItem('studentUserId');
    const studentNotes = studentId ? 
        studentMemoryWallNotes.filter(note => note.studentId === studentId).length : 
        0;
    
    const totalEl = document.getElementById('studentTotalNotesCount');
    const likesEl = document.getElementById('studentTotalLikesCount');
    const studentEl = document.getElementById('studentNotesCount');
    
    if (totalEl) totalEl.textContent = totalNotes;
    if (likesEl) likesEl.textContent = totalLikes;
    if (studentEl) studentEl.textContent = studentNotes;
}

// Refresh student memory wall
function refreshStudentMemoryWall() {
    loadStudentMemoryWall();
    showNotification("Memory wall refreshed", "info");
}

// Load student memory wall data
function loadStudentMemoryWall() {
    if (!currentClassCode) {
        showNotification("Please join a class first", "error");
        return;
    }
    
    console.log("Loading memory wall for class:", currentClassCode);
    
    try {
        // First clear existing data
        studentMemoryWallNotes = [];
        
        // Listen for memory wall changes
        const memoryWallRef = database.ref(`memoryWall/${currentClassCode}/notes`);
        
        memoryWallRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                const notes = [];
                snapshot.forEach(child => {
                    const noteData = child.val();
                    notes.push({
                        id: child.key,
                        ...noteData
                    });
                });
                
                studentMemoryWallNotes = notes;
                console.log("Loaded", studentMemoryWallNotes.length, "notes");
                renderStudentStickyNotes();
            } else {
                studentMemoryWallNotes = [];
                renderStudentStickyNotes();
                console.log("No memory wall notes found");
            }
        }, (error) => {
            console.error("Error loading memory wall:", error);
            showNotification("Error loading memory wall", "error");
        });
        
    } catch (error) {
        console.error("Error setting up memory wall listener:", error);
        showNotification("Error connecting to memory wall", "error");
    }
}




</script>
<div id="confettiLayer" aria-hidden="true"></div>
<div id="premiumSparkleLayer" class="premium-sparkle-layer" aria-hidden="true"></div>













<!-- ===== STUDENT DASHBOARD CLASSIFICATION ===== -->
<style>
/* View Buttons */
.student-view-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  padding: 16px 20px;
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 16px;
}

.student-view-bar h2 {
  font-size: 1.3rem;
  font-weight: 600;
  margin: 0;
  color: var(--text);
}

.student-view-options {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.student-view-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 30px;
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease;
}

.student-view-btn:hover {
  border-color: var(--accent);
  background: var(--accent-light);
  transform: translateY(-2px);
}

.student-view-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* Section visibility */
.study-progress-section,
.tasks-section,
.classroom-section,
.tools-section {
  transition: opacity 0.3s ease;
}

.hide-study .study-progress-section,
.hide-tasks .tasks-section,
.hide-class .classroom-section,
.hide-tools .tools-section {
  display: none !important;
}

/* Quick Stats - one line */
.quick-stats {
  display: grid !important;
  grid-template-columns: repeat(4, 1fr) !important;
  gap: 12px !important;
  margin-bottom: 24px !important;
}

.stat-card {
  background: var(--card) !important;
  border-radius: 12px !important;
  padding: 16px 12px !important;
  border: 1px solid var(--border) !important;
  display: flex !important;
  align-items: center !important;
  gap: 12px !important;
}

.stat-icon {
  width: 40px !important;
  height: 40px !important;
  border-radius: 10px !important;
  font-size: 1.2rem !important;
}

.stat-number {
  font-size: 1.5rem !important;
  font-weight: 700 !important;
  line-height: 1.2 !important;
  margin-bottom: 4px !important;
}

.stat-label {
  font-size: 0.75rem !important;
}

@media (max-width: 768px) {
  .student-view-bar {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .student-view-options {
    width: 100%;
  }
  
  .student-view-btn {
    flex: 1;
    justify-content: center;
  }
  
  .quick-stats {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}
</style>

<script>
(function() {
  console.log('ðŸ“Š Classifying student dashboard...');
  
  function classifyDashboard() {
    const dashboard = document.getElementById('dashboard');
    if (!dashboard) return;
    
    // Don't run if already done
    if (document.getElementById('student-view-bar')) return;
    
    // Add view buttons with actual dashboard content names
    const viewBar = document.createElement('div');
    viewBar.id = 'student-view-bar';
    viewBar.className = 'student-view-bar';
    viewBar.innerHTML = `
      <h2>My Dashboard</h2>
      <div class="student-view-options">
        <button class="student-view-btn active" onclick="switchDashboardView('all')">
          <span>ðŸ“Š</span> All
        </button>
        <button class="student-view-btn" onclick="switchDashboardView('study')">
          <span>ðŸ”¥</span> Study Progress
        </button>
        <button class="student-view-btn" onclick="switchDashboardView('tasks')">
          <span>âœ…</span> Tasks & Assignments
        </button>
        <button class="student-view-btn" onclick="switchDashboardView('tools')">
          <span>ðŸ› ï¸</span> Study Tools
        </button>
      </div>
    `;
    dashboard.insertBefore(viewBar, dashboard.firstChild);
    
    // Add section classes after a short delay
    setTimeout(addSectionClasses, 500);
  }
  
  function addSectionClasses() {
    console.log('Adding section classes...');
    
    const dashboard = document.getElementById('dashboard');
    if (!dashboard) return;
    
    // Remove any existing classes
    document.querySelectorAll('.study-progress-section, .tasks-section, .classroom-section, .tools-section').forEach(el => {
      el.classList.remove('study-progress-section', 'tasks-section', 'classroom-section', 'tools-section');
    });
    
    // STUDY PROGRESS SECTION (streak, stats, goals, study hours)
    const quickStats = dashboard.querySelector('.quick-stats');
    if (quickStats) quickStats.classList.add('study-progress-section');
    
    const streakCard = dashboard.querySelector('.streak-card');
    if (streakCard) streakCard.classList.add('study-progress-section');
    
    const goalCard = dashboard.querySelector('.goal-card');
    if (goalCard) goalCard.classList.add('study-progress-section');
    
    // TASKS SECTION
    const allCards = dashboard.querySelectorAll('.content-card');
    allCards.forEach(card => {
      const header = card.querySelector('.content-header h2');
      if (header) {
        const text = header.textContent || '';
        if (text.includes('My Tasks')) {
          card.classList.add('tasks-section');
        }
        if (text.includes('My Assignments')) {
          card.classList.add('tasks-section');
        }
        if (text.includes('Add Study Hours')) {
          card.classList.add('study-progress-section');
        }
        if (text.includes('Study Stats Compare')) {
          card.classList.add('tools-section');
        }
        if (text.includes('Learn By Teaching')) {
          card.classList.add('tools-section');
        }
      }
    });
    
    // TOOLS SECTION (quick notes, badges, motivation, profile, stats compare, teach mode)
    const quickNotes = dashboard.querySelector('.quick-notes-card');
    if (quickNotes) quickNotes.classList.add('tools-section');
    
    const badgesCard = dashboard.querySelector('.badges-card');
    if (badgesCard) badgesCard.classList.add('tools-section');
    
    const motivationCard = dashboard.querySelector('.motivation-card');
    if (motivationCard) motivationCard.classList.add('tools-section');
    
    const profileForm = dashboard.querySelector('.form-card:has(h2:contains("My Profile"))');
    if (profileForm) profileForm.classList.add('tools-section');
    
    const statsCompare = dashboard.querySelector('.content-card:has(h2:contains("Study Stats Compare"))');
    if (statsCompare) statsCompare.classList.add('tools-section');
    
    const teachMode = dashboard.querySelector('.content-card:has(h2:contains("Learn By Teaching"))');
    if (teachMode) teachMode.classList.add('tools-section');
    
    // Pro tips and footer are always visible (added to all sections)
    const proTips = dashboard.querySelectorAll('.pro-tip');
    proTips.forEach(tip => {
      tip.classList.add('study-progress-section', 'tasks-section', 'tools-section');
    });
    
    const footer = dashboard.querySelector('.footer');
    if (footer) {
      footer.classList.add('study-progress-section', 'tasks-section', 'tools-section');
    }
    
    console.log('âœ… Classes added - each section now has its own unique content');
  }
  
  // Switch view function
  window.switchDashboardView = function(view) {
    console.log('Switching to:', view);
    
    // Update button states
    document.querySelectorAll('.student-view-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Remove all hide classes
    document.body.classList.remove('hide-study', 'hide-tasks', 'hide-tools');
    
    // Add appropriate hide classes
    if (view === 'study') {
      document.body.classList.add('hide-tasks', 'hide-tools');
    } else if (view === 'tasks') {
      document.body.classList.add('hide-study', 'hide-tools');
    } else if (view === 'tools') {
      document.body.classList.add('hide-study', 'hide-tasks');
    }
    // 'all' view - no hide classes
  };
  
  // Run when dashboard is ready
  function tryClassify(attempt = 1) {
    const dashboard = document.getElementById('dashboard');
    if (dashboard && dashboard.children.length > 0) {
      classifyDashboard();
    } else if (attempt < 20) {
      setTimeout(() => tryClassify(attempt + 1), 500);
    }
  }
  
  // Start trying
  setTimeout(() => tryClassify(1), 2000);
  
  // Also run when switching to dashboard
  const originalShowSection = window.showSection;
  if (originalShowSection) {
    window.showSection = function(sectionId) {
      originalShowSection(sectionId);
      if (sectionId === 'dashboard') {
        setTimeout(() => {
          if (!document.getElementById('student-view-bar')) {
            classifyDashboard();
          }
        }, 500);
      }
    };
  }
})();
</script>


<!-- ===== STUDENT SIDEBAR ORGANIZATION ===== -->
<style>
/* Sidebar Sections */
.sidebar-section {
  margin-bottom: 20px !important;
  background: var(--card);
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--border);
  transition: all 0.2s ease;
}

.sidebar-section:hover {
  border-color: var(--accent);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.sidebar-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px !important;
  background: linear-gradient(135deg, rgba(79,70,229,0.02) 0%, rgba(16,185,129,0.02) 100%);
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: background 0.2s ease;
}

.sidebar-section-header:hover {
  background: linear-gradient(135deg, rgba(79,70,229,0.05) 0%, rgba(16,185,129,0.05) 100%);
}

.sidebar-section-header h3 {
  font-size: 1rem;
  font-weight: 600;
  margin: 0;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-section-header h3 span {
  font-size: 1.2rem;
}

.sidebar-section-header .collapse-icon {
  font-size: 1rem;
  color: var(--text-muted);
  transition: transform 0.3s ease;
}

.sidebar-section-header.collapsed .collapse-icon {
  transform: rotate(-90deg);
}

.sidebar-section-content {
  overflow: hidden;
  transition: max-height 0.3s ease, padding 0.3s ease;
  max-height: 1000px;
  padding: 16px;
}

.sidebar-section-content.collapsed {
  max-height: 0 !important;
  padding: 0 16px !important;
}

/* Section color accents */
.sidebar-section[data-section="nav"] .sidebar-section-header {
  border-left: 4px solid #3498db;
}
.sidebar-section[data-section="stats"] .sidebar-section-header {
  border-left: 4px solid #2ecc71;
}
.sidebar-section[data-section="stories"] .sidebar-section-header {
  border-left: 4px solid #f39c12;
}
.sidebar-section[data-section="heatmap"] .sidebar-section-header {
  border-left: 4px solid #9b59b6;
}
.sidebar-section[data-section="theme"] .sidebar-section-header {
  border-left: 4px solid #e74c3c;
}

/* Class stats card - neat design */
.sidebar-stats {
  background: var(--bg) !important;
  border-radius: 12px !important;
  padding: 16px !important;
  border: 1px solid var(--border);
  margin-bottom: 0 !important;
}

.sidebar-stats h3 {
  font-size: 0.9rem !important;
  margin-bottom: 12px !important;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0 !important;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-value {
  font-weight: 700;
  font-size: 1rem;
  color: var(--accent);
  background: var(--accent-light);
  padding: 4px 12px;
  border-radius: 30px;
}

/* Stories section */
.stories-section {
  background: var(--bg) !important;
  border: 1px solid var(--border);
  border-radius: 12px !important;
  padding: 16px !important;
  margin-bottom: 0 !important;
}

.stories-section h3 {
  font-size: 0.9rem !important;
  margin-bottom: 12px !important;
  display: flex;
  align-items: center;
  gap: 8px;
}

.story-item {
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 8px;
  background: var(--card);
  border: 1px solid var(--border);
  transition: all 0.2s ease;
  cursor: pointer;
}

.story-item:hover {
  transform: translateX(4px);
  border-color: var(--accent);
  background: var(--accent-light);
}

.story-name {
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.story-quote {
  font-size: 0.85rem;
  color: var(--text-muted);
  font-style: italic;
}

/* Heatmap section */
.heatmap-section {
  background: var(--bg) !important;
  border: 1px solid var(--border);
  border-radius: 12px !important;
  padding: 16px !important;
  margin-bottom: 0 !important;
}

.heatmap-section h3 {
  font-size: 0.9rem !important;
  margin-bottom: 12px !important;
  display: flex;
  align-items: center;
  gap: 8px;
}

.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.heatmap-cell {
  width: 100%;
  padding-top: 100%;
  border-radius: 4px;
  background: var(--border);
  position: relative;
}

.heatmap-cell.level-0 { background: rgba(148, 163, 184, 0.25); }
.heatmap-cell.level-1 { background: rgba(16, 185, 129, 0.25); }
.heatmap-cell.level-2 { background: rgba(16, 185, 129, 0.5); }
.heatmap-cell.level-3 { background: rgba(16, 185, 129, 0.75); }
.heatmap-cell.level-4 { background: rgba(16, 185, 129, 0.95); }

/* Theme selector */
.theme-selector {
  width: 100%;
  padding: 12px !important;
  border-radius: 12px !important;
  border: 1px solid var(--border) !important;
  background: var(--bg) !important;
  color: var(--text) !important;
  font-size: 0.9rem;
  cursor: pointer;
}

/* Sidebar spacing */
.sidebar {
  padding: 20px !important;
}

.sidebar-header {
  margin-bottom: 24px !important;
  text-align: center;
}

.class-switcher {
  margin-bottom: 24px !important;
}

.sidebar-nav {
  margin: 0 !important;
}

/* Animation */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.sidebar-section-content:not(.collapsed) {
  animation: slideDown 0.3s ease;
}

/* ===== RESPONSIVE & MODERN POLISH ===== */
/* Clean scrollbars */
.sidebar::-webkit-scrollbar,
.main-content::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.sidebar::-webkit-scrollbar-track,
.main-content::-webkit-scrollbar-track {
  background: transparent;
}

.sidebar::-webkit-scrollbar-thumb,
.main-content::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

.sidebar::-webkit-scrollbar-thumb:hover,
.main-content::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* Focus visible for accessibility */
:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .stat-card:hover,
  .btn:hover,
  .nav-item:hover,
  .content-card:hover {
    transform: none !important;
  }
}

/* Mobile safe areas */
@supports (padding: max(0px)) {
  @media (max-width: 767px) {
    .main-content {
      padding-left: max(var(--spacing-md), env(safe-area-inset-left)) !important;
      padding-right: max(var(--spacing-md), env(safe-area-inset-right)) !important;
      padding-bottom: max(var(--spacing-md), env(safe-area-inset-bottom)) !important;
    }
  }
}
</style>

<script>
(function() {
  console.log('ðŸ“‹ Organizing student sidebar...');
  
  function organizeStudentSidebar() {
    const sidebar = document.querySelector('.sidebar');
    if (!sidebar) {
      console.log('Sidebar not found');
      return false;
    }
    
    // Don't reorganize if already done
    if (sidebar.querySelector('.sidebar-section')) {
      console.log('Sidebar already organized');
      return true;
    }
    
    // Get all original sidebar content
    const sidebarHeader = sidebar.querySelector('.sidebar-header');
    const classSwitcher = sidebar.querySelector('.class-switcher');
    const sidebarNav = sidebar.querySelector('.sidebar-nav');
    const sidebarStats = sidebar.querySelector('.sidebar-stats');
    const storiesSection = sidebar.querySelector('.stories-section');
    const heatmapSection = sidebar.querySelector('.heatmap-section');
    const themeSelector = sidebar.querySelector('.theme-selector');
    
    // Clear sidebar
    sidebar.innerHTML = '';
    
    // Add header and class switcher at top (not in collapsible sections)
    if (sidebarHeader) sidebar.appendChild(sidebarHeader.cloneNode(true));
    if (classSwitcher) sidebar.appendChild(classSwitcher.cloneNode(true));
    
    // SECTION 1: Navigation
    if (sidebarNav) {
      const navSection = document.createElement('div');
      navSection.className = 'sidebar-section';
      navSection.setAttribute('data-section', 'nav');
      navSection.innerHTML = `
        <div class="sidebar-section-header" onclick="toggleSidebarSection('sidebar-nav-content')">
          <h3><span>ðŸ“‹</span> Navigation</h3>
          <span class="collapse-icon" id="sidebar-nav-icon">â–¼</span>
        </div>
        <div class="sidebar-section-content" id="sidebar-nav-content"></div>
      `;
      navSection.querySelector('.sidebar-section-content').appendChild(sidebarNav.cloneNode(true));
      sidebar.appendChild(navSection);
    }
    
    // SECTION 2: Today's Stats
    if (sidebarStats) {
      const statsSection = document.createElement('div');
      statsSection.className = 'sidebar-section';
      statsSection.setAttribute('data-section', 'stats');
      statsSection.innerHTML = `
        <div class="sidebar-section-header" onclick="toggleSidebarSection('sidebar-stats-content')">
          <h3><span>ðŸ“Š</span> Today's Stats</h3>
          <span class="collapse-icon" id="sidebar-stats-icon">â–¼</span>
        </div>
        <div class="sidebar-section-content" id="sidebar-stats-content"></div>
      `;
      statsSection.querySelector('.sidebar-section-content').appendChild(sidebarStats.cloneNode(true));
      sidebar.appendChild(statsSection);
    }
    
    // SECTION 3: Inspiring Stories
    if (storiesSection) {
      const storiesSectionDiv = document.createElement('div');
      storiesSectionDiv.className = 'sidebar-section';
      storiesSectionDiv.setAttribute('data-section', 'stories');
      storiesSectionDiv.innerHTML = `
        <div class="sidebar-section-header" onclick="toggleSidebarSection('sidebar-stories-content')">
          <h3><span>ðŸŒŸ</span> Inspiring Stories</h3>
          <span class="collapse-icon" id="sidebar-stories-icon">â–¼</span>
        </div>
        <div class="sidebar-section-content" id="sidebar-stories-content"></div>
      `;
      storiesSectionDiv.querySelector('.sidebar-section-content').appendChild(storiesSection.cloneNode(true));
      sidebar.appendChild(storiesSectionDiv);
    }
    
    // SECTION 4: Study Heatmap
    if (heatmapSection) {
      const heatmapSectionDiv = document.createElement('div');
      heatmapSectionDiv.className = 'sidebar-section';
      heatmapSectionDiv.setAttribute('data-section', 'heatmap');
      heatmapSectionDiv.innerHTML = `
        <div class="sidebar-section-header" onclick="toggleSidebarSection('sidebar-heatmap-content')">
          <h3><span>ðŸ—“ï¸</span> Study Heatmap</h3>
          <span class="collapse-icon" id="sidebar-heatmap-icon">â–¼</span>
        </div>
        <div class="sidebar-section-content" id="sidebar-heatmap-content"></div>
      `;
      heatmapSectionDiv.querySelector('.sidebar-section-content').appendChild(heatmapSection.cloneNode(true));
      sidebar.appendChild(heatmapSectionDiv);
    }
    
    // SECTION 5: Theme
    if (themeSelector) {
      const themeSection = document.createElement('div');
      themeSection.className = 'sidebar-section';
      themeSection.setAttribute('data-section', 'theme');
      themeSection.innerHTML = `
        <div class="sidebar-section-header" onclick="toggleSidebarSection('sidebar-theme-content')">
          <h3><span>ðŸŽ¨</span> Theme</h3>
          <span class="collapse-icon" id="sidebar-theme-icon">â–¼</span>
        </div>
        <div class="sidebar-section-content" id="sidebar-theme-content"></div>
      `;
      const themeWrapper = document.createElement('div');
      themeWrapper.style.padding = '8px 0';
      themeWrapper.appendChild(themeSelector.cloneNode(true));
      themeSection.querySelector('.sidebar-section-content').appendChild(themeWrapper);
      sidebar.appendChild(themeSection);
    }
    
    // Load saved states
    loadSidebarStates();
    
    console.log('âœ… Student sidebar organized into 5 sections');
    return true;
  }
  
  // Toggle sidebar section
  window.toggleSidebarSection = function(contentId) {
    const content = document.getElementById(contentId);
    const icon = document.getElementById(contentId.replace('content', 'icon'));
    const header = icon?.closest('.sidebar-section-header');
    
    if (content) {
      content.classList.toggle('collapsed');
      if (icon) {
        icon.style.transform = content.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0)';
      }
      if (header) {
        header.classList.toggle('collapsed', content.classList.contains('collapsed'));
      }
      
      // Save state
      try {
        localStorage.setItem('sidebar-' + contentId, content.classList.contains('collapsed'));
      } catch (e) {}
    }
  };
  
  // Load saved sidebar states
  function loadSidebarStates() {
    const sections = ['nav', 'stats', 'stories', 'heatmap', 'theme'];
    
    sections.forEach(section => {
      try {
        const saved = localStorage.getItem(`sidebar-sidebar-${section}-content`);
        if (saved === 'true') {
          const content = document.getElementById(`sidebar-${section}-content`);
          const icon = document.getElementById(`sidebar-${section}-icon`);
          
          if (content) {
            content.classList.add('collapsed');
            if (icon) icon.style.transform = 'rotate(-90deg)';
          }
        }
      } catch (e) {}
    });
  }
  
  // Try to organize sidebar when ready
  function tryOrganize(attempt = 1) {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar && sidebar.children.length > 0) {
      organizeStudentSidebar();
    } else if (attempt < 20) {
      setTimeout(() => tryOrganize(attempt + 1), 500);
    }
  }
  
  // Start trying
  setTimeout(() => tryOrganize(1), 1500);
  
  // Also try when page loads
  window.addEventListener('load', () => {
    setTimeout(() => {
      if (!document.querySelector('.sidebar-section')) {
        organizeStudentSidebar();
      }
    }, 2000);
  });
})();




</script>







<!-- ===== EPIC RPG QUEST SYSTEM - TRUE DATA CONNECTION ===== -->
<style>
/* ===== RPG VARIABLES ===== */
:root {
    --rpg-bg: #0a0f1f;
    --rpg-card: #151e2f;
    --rpg-card-light: #1e2a3a;
    --rpg-border: #2a3548;
    --rpg-text: #e2e8f0;
    --rpg-gold: #fbbf24;
    --rpg-silver: #94a3b8;
    --rpg-health: #ef4444;
    --rpg-mana: #3b82f6;
    --rpg-xp: #f59e0b;
    --rpg-legendary: #f97316;
    --rpg-epic: #a855f7;
    --rpg-rare: #3b82f6;
    --rpg-uncommon: #22c55e;
    --rpg-common: #64748b;
}

/* ===== GAME MASTER - POSITIONED LEFT OF CHATBOT ===== */
.game-master-panel {
    position: fixed;
    bottom: 100px;
    right: 180px; /* Positioned left of chatbot (which is at right: 20px) */
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    z-index: 997; /* Lower than chatbot's 998 */
    pointer-events: none;
    max-width: 300px;
}

.gm-bubble {
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border: 3px solid var(--rpg-gold);
    border-radius: 20px 20px 5px 20px;
    padding: 1rem 1.5rem;
    color: var(--rpg-text);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: bubbleAppear 0.3s ease-out;
    position: relative;
    font-family: 'Courier New', monospace;
    backdrop-filter: blur(10px);
    pointer-events: auto;
    width: 100%;
}

.gm-bubble::after {
    content: '';
    position: absolute;
    bottom: -12px;
    right: 20px;
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border-right: 3px solid var(--rpg-gold);
    border-bottom: 3px solid var(--rpg-gold);
    transform: rotate(45deg);
    border-radius: 0 0 5px 0;
}

.gm-character {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 30px 30px 30px 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(251,191,36,0.3);
    border: 3px solid var(--rpg-gold);
    pointer-events: auto;
    animation: gmFloat 3s ease-in-out infinite;
    margin-left: auto;
}

@keyframes gmFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-5px) rotate(2deg); }
}

.gm-character:hover {
    transform: scale(1.1) translateY(-5px);
    box-shadow: 0 15px 40px rgba(251,191,36,0.5);
}

/* ===== MAIN GAME CONTAINER ===== */
.rpg-dashboard {
    background: linear-gradient(135deg, #0f172a, #1e293b);
    border-radius: 40px;
    padding: 2rem;
    margin: 1rem;
    border: 3px solid var(--rpg-gold);
    box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    animation: dashboardAppear 0.8s ease-out;
}

/* ===== PRIORITY LAYOUT ===== */
.priority-1 { order: 1; margin-bottom: 2rem; }
.priority-2 { order: 2; margin-bottom: 2rem; }
.priority-3 { order: 3; margin-bottom: 1rem; }

/* ===== HERO SECTION ===== */
.hero-section {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 2rem;
    background: rgba(0,0,0,0.4);
    border-radius: 30px;
    padding: 1.5rem;
    border: 2px solid var(--rpg-gold);
}

.player-card {
    text-align: center;
    background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(0,0,0,0.5));
    border-radius: 20px;
    padding: 1.5rem;
    border: 2px solid var(--rpg-gold);
}

.player-avatar {
    font-size: 5rem;
    background: linear-gradient(135deg, var(--rpg-gold), var(--rpg-legendary));
    width: 120px;
    height: 120px;
    border-radius: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    transform: rotate(5deg);
    box-shadow: 0 0 30px rgba(251,191,36,0.3);
}

.player-name {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--rpg-gold);
    margin-bottom: 0.3rem;
}

.player-title {
    font-size: 1rem;
    color: var(--rpg-silver);
    background: rgba(0,0,0,0.5);
    padding: 0.3rem;
    border-radius: 30px;
}

.resource-bars {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.resource-item {
    width: 100%;
}

.resource-header {
    display: flex;
    justify-content: space-between;
    color: var(--rpg-text);
    margin-bottom: 0.4rem;
    font-size: 0.9rem;
    text-transform: uppercase;
}

.resource-track {
    height: 20px;
    background: rgba(0,0,0,0.7);
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid var(--rpg-border);
}

.resource-fill {
    height: 100%;
    width: 0%;
    transition: width 0.5s ease;
}

.resource-fill.xp { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.resource-fill.health { background: linear-gradient(90deg, #ef4444, #f87171); }
.resource-fill.mana { background: linear-gradient(90deg, #3b82f6, #60a5fa); }

/* ===== STATS GRID ===== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin: 2rem 0;
}

.stat-card {
    background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8));
    border: 2px solid var(--rpg-border);
    border-radius: 20px;
    padding: 1.2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    border-color: var(--rpg-gold);
}

.stat-icon { font-size: 2.5rem; min-width: 60px; text-align: center; }
.stat-label { font-size: 0.8rem; color: var(--rpg-silver); text-transform: uppercase; }
.stat-value { font-size: 2rem; font-weight: 800; color: var(--rpg-text); line-height: 1; }
.stat-bonus { font-size: 0.7rem; color: var(--rpg-gold); }

/* ===== QUICK ACTIONS ===== */
.quick-actions {
    display: flex;
    gap: 1rem;
    margin: 1.5rem 0;
    flex-wrap: wrap;
}

.action-btn {
    padding: 1rem 2rem;
    border: none;
    border-radius: 15px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, var(--rpg-gold), #f59e0b);
    color: black;
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn.secondary {
    background: linear-gradient(135deg, #475569, #334155);
    color: white;
}

/* ===== QUEST SECTIONS ===== */
.quest-category {
    margin-bottom: 2rem;
}

.category-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.2rem;
    padding-bottom: 0.5rem;
    border-bottom: 3px solid var(--rpg-gold);
}

.category-icon { font-size: 2rem; animation: iconSpin 4s linear infinite; }
@keyframes iconSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.category-title {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--rpg-gold);
}

.category-badge {
    margin-left: auto;
    background: var(--rpg-gold);
    color: black;
    padding: 0.3rem 1.2rem;
    border-radius: 30px;
    font-weight: 700;
    font-size: 0.9rem;
}

/* ===== QUEST CARDS ===== */
.quest-card {
    background: linear-gradient(135deg, rgba(30,40,60,0.9), rgba(20,30,50,0.95));
    border: 2px solid;
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    position: relative;
}

.quest-card:hover { transform: translateX(10px); }

.quest-card.common { border-color: var(--rpg-common); }
.quest-card.uncommon { border-color: var(--rpg-uncommon); }
.quest-card.rare { border-color: var(--rpg-rare); }
.quest-card.epic { border-color: var(--rpg-epic); }
.quest-card.legendary { border-color: var(--rpg-legendary); animation: legendaryPulse 2s infinite; }

@keyframes legendaryPulse {
    0%, 100% { box-shadow: 0 0 20px var(--rpg-legendary); }
    50% { box-shadow: 0 0 40px var(--rpg-legendary); }
}

.quest-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.quest-icon {
    width: 60px;
    height: 60px;
    background: rgba(0,0,0,0.5);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;
}

.quest-info { flex: 1; }
.quest-name { font-size: 1.3rem; font-weight: 700; color: var(--rpg-text); }
.quest-meta { display: flex; gap: 1rem; align-items: center; }

.quest-rarity {
    padding: 0.2rem 1rem;
    border-radius: 30px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
}

.quest-rarity.common { background: var(--rpg-common); color: black; }
.quest-rarity.uncommon { background: var(--rpg-uncommon); color: black; }
.quest-rarity.rare { background: var(--rpg-rare); color: white; }
.quest-rarity.epic { background: var(--rpg-epic); color: white; }
.quest-rarity.legendary { background: var(--rpg-legendary); color: white; }

.quest-xp { color: var(--rpg-xp); font-weight: 600; display: flex; align-items: center; gap: 0.3rem; }
.quest-description { color: var(--rpg-silver); margin-bottom: 1rem; padding-left: 4rem; }

.quest-rewards {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    padding-left: 4rem;
    flex-wrap: wrap;
}

.reward-chip {
    background: rgba(0,0,0,0.5);
    border: 2px solid var(--rpg-gold);
    border-radius: 30px;
    padding: 0.4rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--rpg-gold);
}

.quest-progress {
    margin: 1rem 0;
    padding-left: 4rem;
}

.progress-track {
    height: 8px;
    background: rgba(0,0,0,0.5);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.3rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--rpg-gold), var(--rpg-legendary));
    width: 0%;
    transition: width 0.5s ease;
}

.quest-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    padding-left: 4rem;
}

.quest-btn {
    flex: 1;
    padding: 0.8rem;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quest-btn.claim {
    background: linear-gradient(135deg, var(--rpg-gold), #f59e0b);
    color: black;
}

.quest-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ===== ACHIEVEMENTS GRID ===== */
.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.achievement-card {
    background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.7));
    border: 2px solid var(--rpg-border);
    border-radius: 15px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.achievement-card:hover {
    transform: translateY(-5px);
    border-color: var(--rpg-gold);
}

.achievement-card.unlocked {
    border-color: var(--rpg-gold);
    background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(0,0,0,0.5));
}

.achievement-icon { font-size: 2rem; min-width: 50px; text-align: center; }
.achievement-name { font-weight: 700; color: var(--rpg-text); font-size: 0.9rem; }
.achievement-desc { font-size: 0.75rem; color: var(--rpg-silver); }

/* ===== LEVEL UP MODAL ===== */
.rpg-level-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
}

.rpg-level-modal.show { display: flex; }

.level-modal-card {
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border: 4px solid var(--rpg-gold);
    border-radius: 50px;
    padding: 3rem;
    max-width: 600px;
    width: 90%;
    text-align: center;
    animation: modalPop 0.6s ease;
}

@keyframes modalPop {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modal-icon { font-size: 6rem; margin-bottom: 1rem; }
.modal-title { font-size: 4rem; font-weight: 900; color: var(--rpg-gold); }
.modal-level { font-size: 2rem; color: white; margin-bottom: 2rem; }

.modal-rewards {
    background: rgba(0,0,0,0.5);
    border-radius: 30px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 2px solid var(--rpg-gold);
}

.modal-reward-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid rgba(251,191,36,0.3);
    color: white;
    font-size: 1.2rem;
}

.modal-btn {
    background: var(--rpg-gold);
    color: black;
    border: none;
    padding: 1.2rem 3rem;
    border-radius: 50px;
    font-size: 1.3rem;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* ===== TOAST NOTIFICATIONS ===== */
.game-toast {
    position: fixed;
    bottom: 200px;
    right: 200px; /* Positioned left of chatbot */
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border: 2px solid;
    border-radius: 15px;
    padding: 1rem 1.5rem;
    min-width: 300px;
    z-index: 999;
    animation: toastSlide 0.5s ease;
    color: white;
}

@keyframes toastSlide {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .game-master-panel {
        right: 100px;
        bottom: 80px;
    }
    
    .hero-section {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<!-- ===== GAME MASTER PANEL (Positioned Left of Chatbot) ===== -->
<div class="game-master-panel" id="gameMasterPanel">
    <div class="gm-bubble" id="gmBubble">
        âš”ï¸ Greetings, Adventurer! I track your REAL study data. Click me for tips!
    </div>
    <div class="gm-character" id="gmCharacter" onclick="gmClick()">
        ðŸ§™â€â™‚ï¸
    </div>
</div>

<!-- ===== LEVEL UP MODAL ===== -->
<div class="rpg-level-modal" id="levelModal">
    <div class="level-modal-card">
        <div class="modal-icon">âš”ï¸</div>
        <div class="modal-title">LEVEL UP!</div>
        <div class="modal-level" id="modalLevel">Level 2</div>
        <div class="modal-rewards" id="modalRewards"></div>
        <button class="modal-btn" onclick="closeLevelModal()">CONTINUE</button>
    </div>
</div>

<script>
// ========== ULTIMATE RPG QUEST SYSTEM - TRUE DATA CONNECTION ==========

// Game Master Messages (All connected to real data)
const GM_MESSAGES = {
    welcome: "âš”ï¸ I track your REAL study data! Every task, hour, and streak is recorded!",
    xp: `âœ¨ You have {{xp}} XP. Need {{xpNeeded}} more for level {{nextLevel}}!`,
    health: `â¤ï¸ Health based on your consistency. Currently {{health}}/{{maxHealth}}!`,
    mana: `ðŸ’™ Mana = {{mana}}/{{maxMana}}. Earned from {{focusSessions}} focus sessions today!`,
    stats: `ðŸ“Š STR:{{str}} ({{tasks}} tasks), INT:{{int}} ({{hours}} hrs), WIS:{{wis}} ({{streak}} streak), LUK:{{luk}}`,
    daily: `ðŸ“… {{dailyDone}}/{{dailyTotal}} daily quests done. {{dailyLeft}} left today!`,
    weekly: `ðŸ“† {{weeklyDone}}/{{weeklyTotal}} weekly quests. {{weeklyLeft}} remain this week!`,
    legendary: `ðŸŒŸ Completed {{legendaryDone}} legendary quests. {{legendaryLeft}} to go!`,
    perfect: `âœ¨ You've had {{perfectDays}} Perfect Days! Each gives massive bonuses!`,
    streak: `ðŸ”¥ Current streak: {{streak}} days. Longest: {{longestStreak}}!`,
    level: `ðŸŒŸ Level {{level}}. {{xp}}/{{xpToNext}} XP to next level!`,
    mana_tip: `ðŸ’™ Mana regenerates {{manaRegen}} per day. Use it for dice rolls and boosts!`,
    health_tip: `â¤ï¸ Health = {{health}}%. Stay consistent to keep it high!`
};

// Game Master click handler - SHOWS REAL DATA
function gmClick() {
    const bubble = document.getElementById('gmBubble');
    const data = loadRpgData();
    const progress = collectRealProgress();
    
    // Replace placeholders with REAL values
    let message = GM_MESSAGES[Object.keys(GM_MESSAGES)[Math.floor(Math.random() * Object.keys(GM_MESSAGES).length)]];
    
    message = message
        .replace('{{xp}}', data.xp)
        .replace('{{xpNeeded}}', data.xpToNextLevel - data.xp)
        .replace('{{nextLevel}}', data.level + 1)
        .replace('{{health}}', data.health)
        .replace('{{maxHealth}}', data.maxHealth)
        .replace('{{mana}}', data.mana)
        .replace('{{maxMana}}', data.maxMana)
        .replace('{{focusSessions}}', progress.focusSessions)
        .replace('{{str}}', data.strength)
        .replace('{{int}}', data.intelligence)
        .replace('{{wis}}', data.wisdom)
        .replace('{{luk}}', data.luck)
        .replace('{{tasks}}', progress.totalTasks)
        .replace('{{hours}}', Math.round(progress.totalHours))
        .replace('{{streak}}', progress.streak)
        .replace('{{dailyDone}}', data.dailyQuests.filter(q => q.completed).length)
        .replace('{{dailyTotal}}', data.dailyQuests.length)
        .replace('{{dailyLeft}}', data.dailyQuests.length - data.dailyQuests.filter(q => q.completed).length)
        .replace('{{weeklyDone}}', data.weeklyQuests.filter(q => q.completed).length)
        .replace('{{weeklyTotal}}', data.weeklyQuests.length)
        .replace('{{weeklyLeft}}', data.weeklyQuests.length - data.weeklyQuests.filter(q => q.completed).length)
        .replace('{{legendaryDone}}', data.legendaryQuests.filter(q => q.completed).length)
        .replace('{{legendaryTotal}}', data.legendaryQuests.length)
        .replace('{{legendaryLeft}}', data.legendaryQuests.length - data.legendaryQuests.filter(q => q.completed).length)
        .replace('{{perfectDays}}', data.perfectDays)
        .replace('{{longestStreak}}', progress.longestStreak || progress.streak)
        .replace('{{level}}', data.level)
        .replace('{{xpToNext}}', data.xpToNextLevel)
        .replace('{{manaRegen}}', 10);
    
    bubble.textContent = message;
    
    // Animate
    bubble.style.animation = 'none';
    bubble.offsetHeight;
    bubble.style.animation = 'bubbleAppear 0.3s ease-out';
}

// ===== REAL DATA CONNECTION =====
const RPG_DATA_KEY = 'trueRpgData';

const defaultRpgData = {
    level: 1,
    xp: 0,
    xpToNextLevel: 100,
    totalXP: 0,
    
    // Stats (increased by real activities)
    strength: 5,      // Increased by completing tasks
    intelligence: 5,  // Increased by study hours
    wisdom: 5,        // Increased by streak days
    luck: 5,          // Increased by perfect days
    
    // Resources (based on real data)
    health: 100,
    maxHealth: 100,
    mana: 50,
    maxMana: 50,
    
    // Progress
    questsCompleted: 0,
    perfectDays: 0,
    achievements: [],
    titles: ['Novice Adventurer'],
    currentTitle: 'Novice Adventurer',
    
    // Quests
    dailyQuests: [],
    weeklyQuests: [],
    legendaryQuests: [],
    
    // Streaks
    dailyStreak: 0,
    lastDailyComplete: null,
    
    // Timestamps
    lastDailyReset: new Date().toDateString(),
    lastWeeklyReset: getWeekStart(),
    lastManaRegen: Date.now(),
    
    // History
    levelHistory: []
};

// ===== TITLES (Based on Real Level) =====
const GAME_TITLES = [
    { level: 1, title: 'Novice Adventurer', icon: 'ðŸŒ±', bonus: '+1 All Stats' },
    { level: 3, title: 'Apprentice Scholar', icon: 'ðŸ“š', bonus: '+2 Intelligence' },
    { level: 5, title: 'Skilled Warrior', icon: 'âš”ï¸', bonus: '+2 Strength' },
    { level: 7, title: 'Wise Sage', icon: 'ðŸ”®', bonus: '+2 Wisdom' },
    { level: 9, title: 'Lucky Rogue', icon: 'ðŸ€', bonus: '+2 Luck' },
    { level: 11, title: 'Elite Guardian', icon: 'ðŸ›¡ï¸', bonus: '+3 Strength, +3 Wisdom' },
    { level: 13, title: 'Mystic Mage', icon: 'ðŸ”®', bonus: '+3 Intelligence, +3 Luck' },
    { level: 15, title: 'Legendary Hero', icon: 'ðŸŒŸ', bonus: '+4 All Stats' },
    { level: 17, title: 'Dragon Slayer', icon: 'ðŸ‰', bonus: '+5 Strength, +20 Health' },
    { level: 19, title: 'Arcane Master', icon: 'âœ¨', bonus: '+5 Intelligence, +15 Mana' },
    { level: 21, title: 'Immortal Champion', icon: 'ðŸ†', bonus: '+6 All Stats' },
    { level: 23, title: 'Mythic Legend', icon: 'ðŸŒŒ', bonus: '+7 All Stats, +20 Health' },
    { level: 25, title: 'Divine Warlock', icon: 'âš¡', bonus: '+8 All Stats, +15 Mana' },
    { level: 27, title: 'Cosmic Overlord', icon: 'ðŸŒ ', bonus: '+10 All Stats' },
    { level: 30, title: 'Grandmaster', icon: 'ðŸ‘‘', bonus: '+15 All Stats, +50 Health, +30 Mana' }
];

// ===== DAILY QUESTS (Connected to Real Activities) =====
const DAILY_QUESTS = [
    {
        id: 'daily_focus',
        name: 'ðŸ§˜ Focus Warrior',
        description: 'Complete a 25-minute focused study session',
        icon: 'ðŸŽ¯',
        xp: 50,
        stats: { wisdom: 1 },
        manaCost: 10,
        requirement: 1,
        rarity: 'common',
        checkProgress: (data) => data.focusSessions || 0
    },
    {
        id: 'daily_tasks',
        name: 'âš”ï¸ Task Slayer',
        description: 'Complete 3 tasks from your to-do list',
        icon: 'âœ“',
        xp: 60,
        stats: { strength: 1 },
        requirement: 3,
        rarity: 'uncommon',
        checkProgress: (data) => data.todayTasks || 0
    },
    {
        id: 'daily_streak',
        name: 'ðŸ”¥ Streak Keeper',
        description: 'Maintain your study streak',
        icon: 'ðŸ”¥',
        xp: 75,
        stats: { luck: 1 },
        requirement: 1,
        rarity: 'rare',
        checkProgress: (data) => data.streakMaintained ? 1 : 0
    },
    {
        id: 'daily_hours',
        name: 'âŒ› Time Mage',
        description: 'Study for 2 hours total today',
        icon: 'âŒ›',
        xp: 100,
        stats: { intelligence: 1 },
        requirement: 2,
        rarity: 'epic',
        checkProgress: (data) => Math.floor(data.todayHours || 0)
    }
];

// ===== WEEKLY QUESTS =====
const WEEKLY_QUESTS = [
    {
        id: 'weekly_streak',
        name: 'ðŸ† Streak Legend',
        description: 'Maintain a 7-day study streak',
        icon: 'ðŸ”¥',
        xp: 500,
        stats: { luck: 3, wisdom: 2 },
        requirement: 7,
        rarity: 'epic',
        checkProgress: (data) => data.streak || 0
    },
    {
        id: 'weekly_tasks',
        name: 'âš”ï¸ Quest Master',
        description: 'Complete 20 tasks this week',
        icon: 'ðŸ“œ',
        xp: 400,
        stats: { strength: 3, intelligence: 2 },
        requirement: 20,
        rarity: 'epic',
        checkProgress: (data) => data.weeklyTasks || 0
    },
    {
        id: 'weekly_hours',
        name: 'â° Time Lord',
        description: 'Study 12 hours this week',
        icon: 'âŒ›',
        xp: 600,
        stats: { intelligence: 3, wisdom: 2 },
        requirement: 12,
        rarity: 'legendary',
        checkProgress: (data) => Math.floor(data.weeklyHours || 0)
    }
];

// ===== LEGENDARY QUESTS =====
const LEGENDARY_QUESTS = [
    {
        id: 'legend_first',
        name: 'ðŸŒŸ First Steps',
        description: 'Complete your first quest',
        icon: 'ðŸŒ±',
        xp: 100,
        stats: { luck: 2 },
        requirement: 1,
        rarity: 'common',
        checkProgress: (data) => data.questsCompleted >= 1 ? 1 : 0
    },
    {
        id: 'legend_10',
        name: 'âš”ï¸ Quest Apprentice',
        description: 'Complete 10 quests total',
        icon: 'âš”ï¸',
        xp: 250,
        stats: { strength: 2, intelligence: 2 },
        requirement: 10,
        rarity: 'uncommon',
        checkProgress: (data) => data.questsCompleted >= 10 ? 1 : 0
    },
    {
        id: 'legend_50',
        name: 'ðŸ‘‘ Quest Warrior',
        description: 'Complete 50 quests total',
        icon: 'ðŸ‘‘',
        xp: 600,
        stats: { wisdom: 3, luck: 3 },
        requirement: 50,
        rarity: 'rare',
        checkProgress: (data) => data.questsCompleted >= 50 ? 1 : 0
    },
    {
        id: 'legend_100',
        name: 'âœ¨ Quest Legend',
        description: 'Complete 100 quests total',
        icon: 'âœ¨',
        xp: 1200,
        stats: { all: 4 },
        requirement: 100,
        rarity: 'epic',
        checkProgress: (data) => data.questsCompleted >= 100 ? 1 : 0
    },
    {
        id: 'legend_streak_30',
        name: 'ðŸŒ‹ Inferno Master',
        description: 'Achieve a 30-day streak',
        icon: 'ðŸ”¥',
        xp: 2000,
        stats: { all: 5 },
        requirement: 30,
        rarity: 'legendary',
        checkProgress: (data) => (data.streak || 0) >= 30 ? 1 : 0
    }
];

// ===== ACHIEVEMENTS (Based on Real Milestones) =====
const RPG_ACHIEVEMENTS = [
    { id: 'ach_level_5', name: 'ðŸŒ± Level 5', desc: 'Reach level 5', icon: 'ðŸŒ±', xp: 200, stat: 'all' },
    { id: 'ach_level_10', name: 'âš”ï¸ Level 10', desc: 'Reach level 10', icon: 'âš”ï¸', xp: 500, stat: 'all' },
    { id: 'ach_level_20', name: 'ðŸ‘‘ Level 20', desc: 'Reach level 20', icon: 'ðŸ‘‘', xp: 1000, stat: 'all' },
    { id: 'ach_level_30', name: 'ðŸŒŸ Level 30', desc: 'Reach level 30', icon: 'ðŸŒŸ', xp: 2000, stat: 'all' },
    { id: 'ach_streak_7', name: 'ðŸ”¥ 7-Day Streak', desc: '7 day streak', icon: 'ðŸ”¥', xp: 300, stat: 'luck' },
    { id: 'ach_streak_30', name: 'ðŸŒ‹ 30-Day Streak', desc: '30 day streak', icon: 'ðŸŒ‹', xp: 1000, stat: 'all' },
    { id: 'ach_tasks_100', name: 'âœ… 100 Tasks', desc: 'Complete 100 tasks', icon: 'âœ“', xp: 500, stat: 'strength' },
    { id: 'ach_tasks_500', name: 'ðŸ‘‘ 500 Tasks', desc: 'Complete 500 tasks', icon: 'ðŸ‘‘', xp: 2000, stat: 'all' },
    { id: 'ach_hours_50', name: 'âŒ› 50 Hours', desc: 'Study 50 hours', icon: 'âŒ›', xp: 400, stat: 'intelligence' },
    { id: 'ach_hours_200', name: 'â³ 200 Hours', desc: 'Study 200 hours', icon: 'â³', xp: 1500, stat: 'all' }
];

// ===== UTILITY FUNCTIONS =====

function getWeekStart() {
    const d = new Date();
    d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1));
    return d.toDateString();
}

// Load/Save Game Data
function loadRpgData() {
    try {
        const saved = localStorage.getItem(RPG_DATA_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            const today = new Date().toDateString();
            const weekStart = getWeekStart();
            
            // Reset daily quests
            if (parsed.lastDailyReset !== today) {
                parsed.dailyQuests = initializeQuests(DAILY_QUESTS);
                parsed.lastDailyReset = today;
            }
            
            // Reset weekly quests
            if (parsed.lastWeeklyReset !== weekStart) {
                parsed.weeklyQuests = initializeQuests(WEEKLY_QUESTS);
                parsed.lastWeeklyReset = weekStart;
            }
            
            // Always ensure legendary quests exist
            if (!parsed.legendaryQuests || parsed.legendaryQuests.length === 0) {
                parsed.legendaryQuests = initializeQuests(LEGENDARY_QUESTS);
            }
            
            return parsed;
        }
    } catch (e) {
        console.error("Error loading game data:", e);
    }
    
    // New game
    return {
        ...defaultRpgData,
        dailyQuests: initializeQuests(DAILY_QUESTS),
        weeklyQuests: initializeQuests(WEEKLY_QUESTS),
        legendaryQuests: initializeQuests(LEGENDARY_QUESTS)
    };
}

function initializeQuests(questList) {
    return questList.map(q => ({
        ...q,
        progress: 0,
        completed: false,
        claimed: false
    }));
}

function saveRpgData(data) {
    try {
        localStorage.setItem(RPG_DATA_KEY, JSON.stringify(data));
    } catch (e) {
        console.error("Error saving game data:", e);
    }
}

// ===== COLLECT REAL PROGRESS FROM ACTUAL APP DATA =====
function collectRealProgress() {
    const today = new Date().toDateString();
    const todayStats = studyData.dailyStats?.find(s => s.date === today);
    
    // Focus sessions (25+ minutes)
    const focusSessions = studyData.studySessions?.filter(s => {
        if (!s.date) return false;
        return new Date(s.date).toDateString() === today && (s.hours || 0) >= 0.4;
    }).length || 0;
    
    // Today's completed tasks
    const todayTasks = tasks.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        return new Date(t.completedAt).toDateString() === today;
    }).length;
    
    // Weekly tasks
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weeklyTasks = tasks.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        return new Date(t.completedAt) >= weekAgo;
    }).length;
    
    // Weekly hours
    const weeklyHours = studyData.dailyStats?.reduce((sum, day) => {
        if (new Date(day.date) >= weekAgo) {
            return sum + (day.hours || 0);
        }
        return sum;
    }, 0) || 0;
    
    // Total completed tasks
    const totalTasks = tasks.filter(t => t.completed).length;
    
    // Total study hours
    const totalHours = parseFloat(studyData.totalStudyHours || 0);
    
    // Longest streak from history
    const longestStreak = studyData.streakHistory ? 
        Math.max(...studyData.streakHistory.map(s => s.streak || 0), studyData.streak || 0) : 
        studyData.streak || 0;
    
    return {
        focusSessions,
        todayTasks,
        streakMaintained: studyData.lastStudyDate === today ? 1 : 0,
        todayHours: todayStats?.hours || 0,
        streak: studyData.streak || 0,
        weeklyTasks,
        weeklyHours,
        totalTasks,
        totalHours,
        longestStreak,
        dayOfWeek: new Date().getDay(),
        hourOfDay: new Date().getHours()
    };
}

// ===== MANA CALCULATION - BASED ON REAL ACTIVITY =====
function calculateMana(data, progress) {
    // Base mana: 50
    // +5 per level
    // +1 per focus session today
    // +2 per task completed today
    // +3 per hour studied today
    
    const baseMana = 50;
    const levelBonus = (data.level - 1) * 5;
    const focusBonus = progress.focusSessions * 1;
    const taskBonus = progress.todayTasks * 2;
    const hourBonus = Math.floor(progress.todayHours) * 3;
    
    const maxMana = baseMana + levelBonus + 50; // Cap increases with level
    
    return {
        current: Math.min(maxMana, baseMana + levelBonus + focusBonus + taskBonus + hourBonus),
        max: maxMana
    };
}

// ===== HEALTH CALCULATION - BASED ON CONSISTENCY =====
function calculateHealth(data, progress) {
    // Base health: 100
    // +10 per level
    // -5 per missed day
    // +2 per consecutive streak day
    
    const baseHealth = 100;
    const levelBonus = (data.level - 1) * 10;
    const streakBonus = progress.streak * 2;
    
    // Check for missed days
    const lastActive = studyData.lastStudyDate ? new Date(studyData.lastStudyDate) : null;
    const today = new Date();
    let missedPenalty = 0;
    
    if (lastActive) {
        const daysDiff = Math.floor((today - lastActive) / (1000 * 60 * 60 * 24));
        if (daysDiff > 1) {
            missedPenalty = Math.min(30, (daysDiff - 1) * 5);
        }
    }
    
    const maxHealth = baseHealth + levelBonus + 50;
    const currentHealth = Math.max(50, Math.min(maxHealth, baseHealth + levelBonus + streakBonus - missedPenalty));
    
    return {
        current: currentHealth,
        max: maxHealth
    };
}

// ===== ADD XP AND LEVEL UP =====
function addRpgXP(amount, source = 'quest') {
    const data = loadRpgData();
    data.xp += amount;
    data.totalXP += amount;
    
    let leveledUp = false;
    let levelsGained = 0;
    
    while (data.xp >= data.xpToNextLevel) {
        data.xp -= data.xpToNextLevel;
        data.level++;
        levelsGained++;
        data.xpToNextLevel = Math.floor(data.xpToNextLevel * 1.3);
        
        // Level up bonuses
        data.strength += 1;
        data.intelligence += 1;
        data.wisdom += 1;
        data.luck += 1;
        
        leveledUp = true;
    }
    
    if (leveledUp) {
        // Check for new titles
        GAME_TITLES.forEach(title => {
            if (data.level >= title.level && !data.titles.includes(title.title)) {
                data.titles.push(title.title);
                data.currentTitle = title.title;
                
                // Apply title bonuses
                if (title.bonus.includes('All Stats')) {
                    const bonus = parseInt(title.bonus.split('+')[1]);
                    data.strength += bonus;
                    data.intelligence += bonus;
                    data.wisdom += bonus;
                    data.luck += bonus;
                }
                
                showGameToast('ðŸ† NEW TITLE!', `${title.icon} ${title.title}`, 'legendary');
            }
        });
        
        showLevelModal(data.level, levelsGained);
        checkAchievements(data);
    }
    
    saveRpgData(data);
    updateRpgUI();
    return leveledUp;
}

// Show level modal
function showLevelModal(newLevel, levelsGained) {
    const modal = document.getElementById('levelModal');
    const levelEl = document.getElementById('modalLevel');
    const rewardsEl = document.getElementById('modalRewards');
    
    levelEl.textContent = `Level ${newLevel}`;
    
    const bonusXP = 50 * levelsGained;
    rewardsEl.innerHTML = `
        <div class="modal-reward-row"><span>âœ¨</span><span>+${bonusXP} XP Bonus</span></div>
        <div class="modal-reward-row"><span>ðŸ“Š</span><span>+${levelsGained} All Stats</span></div>
        <div class="modal-reward-row"><span>â¤ï¸</span><span>+${10 * levelsGained} Max Health</span></div>
        <div class="modal-reward-row"><span>ðŸ’™</span><span>+${5 * levelsGained} Max Mana</span></div>
    `;
    
    modal.classList.add('show');
    
    // Add bonus XP
    const data = loadRpgData();
    data.xp += bonusXP;
    data.totalXP += bonusXP;
    
    saveRpgData(data);
}

function closeLevelModal() {
    document.getElementById('levelModal').classList.remove('show');
    updateRpgUI();
}

// Check achievements
function checkAchievements(data) {
    const progress = collectRealProgress();
    
    RPG_ACHIEVEMENTS.forEach(achievement => {
        if (!data.achievements.includes(achievement.id)) {
            let unlocked = false;
            
            if (achievement.id.includes('level')) {
                const level = parseInt(achievement.id.split('_')[2]);
                if (data.level >= level) unlocked = true;
            } else if (achievement.id.includes('streak')) {
                const streak = parseInt(achievement.id.split('_')[2]);
                if (progress.streak >= streak) unlocked = true;
            } else if (achievement.id.includes('tasks')) {
                const tasks = parseInt(achievement.id.split('_')[2]);
                if (progress.totalTasks >= tasks) unlocked = true;
            } else if (achievement.id.includes('hours')) {
                const hours = parseInt(achievement.id.split('_')[2]);
                if (progress.totalHours >= hours) unlocked = true;
            }
            
            if (unlocked) {
                data.achievements.push(achievement.id);
                addRpgXP(achievement.xp, 'achievement');
                
                if (achievement.stat === 'all') {
                    data.strength += 2;
                    data.intelligence += 2;
                    data.wisdom += 2;
                    data.luck += 2;
                } else if (achievement.stat) {
                    data[achievement.stat] += 2;
                }
                
                showGameToast('ðŸ† ACHIEVEMENT!', achievement.name, 'epic');
            }
        }
    });
    
    saveRpgData(data);
}

// ===== UPDATE QUEST PROGRESS WITH REAL DATA =====
function updateQuestProgress() {
    const data = loadRpgData();
    const progress = collectRealProgress();
    
    // Update health and mana based on real data
    const health = calculateHealth(data, progress);
    const mana = calculateMana(data, progress);
    
    data.health = health.current;
    data.maxHealth = health.max;
    data.mana = mana.current;
    data.maxMana = mana.max;
    
    let dailyCompleted = 0;
    
    // Update daily quests
    data.dailyQuests.forEach(quest => {
        if (!quest.completed && !quest.claimed) {
            const oldProgress = quest.progress;
            quest.progress = Math.min(quest.checkProgress(progress), quest.requirement);
            
            if (quest.progress >= quest.requirement && oldProgress < quest.progress && !quest.completed) {
                quest.completed = true;
                dailyCompleted++;
                showGameToast('âš”ï¸ QUEST COMPLETE!', quest.name, quest.rarity);
            }
        } else if (quest.completed && !quest.claimed) {
            dailyCompleted++;
        }
    });
    
    // Perfect Day check
    if (dailyCompleted === data.dailyQuests.length && data.dailyQuests.length > 0) {
        if (!data.legendaryQuests.some(q => q.id === 'legend_perfect_day')) {
            data.legendaryQuests.push({
                id: 'legend_perfect_day',
                name: 'âœ¨ Perfect Day Champion',
                description: 'Complete all daily quests in one day',
                icon: 'ðŸŒŸ',
                xp: 500,
                stats: { luck: 3, wisdom: 3 },
                requirement: 1,
                progress: 1,
                completed: true,
                claimed: false,
                rarity: 'legendary',
                checkProgress: () => 1
            });
            data.perfectDays++;
            showGameToast('ðŸŒŸ PERFECT DAY!', 'All daily quests completed!', 'legendary');
        }
    }
    
    // Update weekly quests
    data.weeklyQuests.forEach(quest => {
        if (!quest.completed && !quest.claimed) {
            const oldProgress = quest.progress;
            quest.progress = Math.min(quest.checkProgress(progress), quest.requirement);
            
            if (quest.progress >= quest.requirement && oldProgress < quest.progress && !quest.completed) {
                quest.completed = true;
                showGameToast('ðŸ† WEEKLY COMPLETE!', quest.name, 'epic');
            }
        }
    });
    
    // Update legendary quests
    data.legendaryQuests.forEach(quest => {
        if (!quest.completed && !quest.claimed) {
            const oldProgress = quest.progress;
            quest.progress = quest.checkProgress({...progress, ...data});
            
            if (quest.progress >= quest.requirement && oldProgress < quest.progress && !quest.completed) {
                quest.completed = true;
                showGameToast('ðŸŒŸ LEGENDARY!', quest.name, 'legendary');
            }
        }
    });
    
    saveRpgData(data);
    updateRpgUI();
}

// ===== CLAIM QUEST REWARD =====
function claimQuest(questId, category) {
    const data = loadRpgData();
    let quests = [];
    
    if (category === 'daily') quests = data.dailyQuests;
    else if (category === 'weekly') quests = data.weeklyQuests;
    else if (category === 'legendary') quests = data.legendaryQuests;
    
    const quest = quests.find(q => q.id === questId);
    
    if (!quest || !quest.completed || quest.claimed) {
        showGameToast('âŒ Cannot Claim', 'Quest already claimed', 'error');
        return false;
    }
    
    quest.claimed = true;
    data.questsCompleted++;
    
    // Apply stat rewards
    if (quest.stats) {
        Object.entries(quest.stats).forEach(([stat, value]) => {
            if (stat === 'all') {
                data.strength += value;
                data.intelligence += value;
                data.wisdom += value;
                data.luck += value;
            } else {
                data[stat] += value;
            }
        });
    }
    
    // Update daily streak
    if (category === 'daily') {
        const today = new Date().toDateString();
        if (data.lastDailyComplete === today) {
            data.dailyStreak++;
        } else {
            data.dailyStreak = 1;
        }
        data.lastDailyComplete = today;
    }
    
    // Calculate XP with bonuses
    let xpGain = quest.xp;
    
    // Streak bonus
    if (data.dailyStreak > 3) {
        xpGain = Math.floor(xpGain * (1 + (data.dailyStreak * 0.02)));
    }
    
    // Luck bonus
    const luckBonus = data.luck / 100;
    xpGain = Math.floor(xpGain * (1 + luckBonus));
    
    // Rarity bonus
    if (quest.rarity === 'rare') xpGain = Math.floor(xpGain * 1.2);
    if (quest.rarity === 'epic') xpGain = Math.floor(xpGain * 1.5);
    if (quest.rarity === 'legendary') xpGain = Math.floor(xpGain * 2);
    
    addRpgXP(xpGain, 'quest');
    
    showGameToast('âœ¨ REWARDS CLAIMED!', `+${xpGain} XP`, quest.rarity);
    
    saveRpgData(data);
    updateRpgUI();
    return true;
}

// Fix dice roll function
function rollDice() {
    const data = loadRpgData();
    
    if (data.mana < 5) {
        showNotification("âŒ Not enough mana! Need 5 mana to roll dice.", "error");
        return;
    }
    
    data.mana -= 5;
    data.diceRolls = (data.diceRolls || 0) + 1;
    
    const roll1 = Math.floor(Math.random() * 6) + 1;
    const roll2 = Math.floor(Math.random() * 6) + 1;
    const total = roll1 + roll2;
    
    let xpGain = 0;
    let message = '';
    
    if (total === 12) {
        xpGain = 100;
        message = 'ðŸŒŸ PERFECT ROLL! +100 XP!';
    } else if (total >= 10) {
        xpGain = 50;
        message = 'âœ¨ Great roll! +50 XP!';
    } else if (total >= 7) {
        xpGain = 25;
        message = 'ðŸ‘ Good roll! +25 XP!';
    } else {
        xpGain = 10;
        message = 'ðŸŽ² Keep trying! +10 XP!';
    }
    
    data.xp = (data.xp || 0) + xpGain;
    data.totalXP = (data.totalXP || 0) + xpGain;
    
    // Check for level up
    while (data.xp >= (data.xpToNextLevel || 100)) {
        data.xp -= (data.xpToNextLevel || 100);
        data.level = (data.level || 1) + 1;
        data.xpToNextLevel = Math.floor((data.xpToNextLevel || 100) * 1.3);
        
        // Increase stats on level up
        data.strength = (data.strength || 5) + 1;
        data.intelligence = (data.intelligence || 5) + 1;
        data.wisdom = (data.wisdom || 5) + 1;
        data.luck = (data.luck || 5) + 1;
        
        showNotification(`â­ LEVEL UP! Now level ${data.level}!`, "success");
    }
    
    saveRpgData(data);
    showNotification(`ðŸŽ² ${message}`, "success");
    updateBattleStats();
}

// ===== RENDER GAME UI =====
function renderRpgUI() {
    const data = loadRpgData();
    const progress = collectRealProgress();
    
    const xpPercent = (data.xp / data.xpToNextLevel) * 100;
    const healthPercent = (data.health / data.maxHealth) * 100;
    const manaPercent = (data.mana / data.maxMana) * 100;
    
    const currentTitle = GAME_TITLES.find(t => t.level <= data.level) || GAME_TITLES[0];
    
    return `
        <div class="rpg-dashboard">
            <!-- Priority 1: Hero Section -->
            <div class="priority-1">
                <div class="hero-section">
                    <div class="player-card">
                        <div class="player-avatar">${currentTitle.icon}</div>
                        <div class="player-name">${currentUserName || 'Adventurer'}</div>
                        <div class="player-title">${currentTitle.icon} ${data.currentTitle} (Lv.${data.level})</div>
                    </div>
                    
                    <div class="resource-bars">
                        <div class="resource-item">
                            <div class="resource-header">
                                <span>âœ¨ XP to Level ${data.level + 1}</span>
                                <span>${data.xp}/${data.xpToNextLevel}</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill xp" style="width: ${xpPercent}%;"></div>
                            </div>
                        </div>
                        
                        <div class="resource-item">
                            <div class="resource-header">
                                <span>â¤ï¸ Health (Consistency)</span>
                                <span>${Math.round(data.health)}/${Math.round(data.maxHealth)}</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill health" style="width: ${healthPercent}%;"></div>
                            </div>
                        </div>
                        
                        <div class="resource-item">
                            <div class="resource-header">
                                <span>ðŸ’™ Mana (Focus Energy)</span>
                                <span>${Math.round(data.mana)}/${Math.round(data.maxMana)}</span>
                            </div>
                            <div class="resource-track">
                                <div class="resource-fill mana" style="width: ${manaPercent}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’ª</div>
                        <div class="stat-content">
                            <div class="stat-label">Strength</div>
                            <div class="stat-value">${data.strength}</div>
                            <div class="stat-bonus">${progress.totalTasks} tasks done</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ§ </div>
                        <div class="stat-content">
                            <div class="stat-label">Intelligence</div>
                            <div class="stat-value">${data.intelligence}</div>
                            <div class="stat-bonus">${Math.round(progress.totalHours)} hrs studied</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“š</div>
                        <div class="stat-content">
                            <div class="stat-label">Wisdom</div>
                            <div class="stat-value">${data.wisdom}</div>
                            <div class="stat-bonus">${progress.streak} day streak</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ€</div>
                        <div class="stat-content">
                            <div class="stat-label">Luck</div>
                            <div class="stat-value">${data.luck}</div>
                            <div class="stat-bonus">${data.perfectDays} perfect days</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn" onclick="rollDice()" ${data.mana < 5 ? 'disabled' : ''}>
                        ðŸŽ² Roll Dice (5 Mana)
                    </button>
                    <button class="action-btn secondary" onclick="gmClick()">
                        ðŸ§™ Ask Game Master
                    </button>
                </div>
            </div>
            
            <!-- Priority 2: Quest Categories -->
            <div class="priority-2">
                <!-- Daily Quests -->
                <div class="quest-category">
                    <div class="category-header">
                        <div class="category-icon">ðŸ“…</div>
                        <div class="category-title">Daily Quests</div>
                        <div class="category-badge">ðŸ”¥ ${data.dailyStreak} Day Streak</div>
                    </div>
                    ${renderQuestCards(data.dailyQuests, 'daily')}
                </div>
                
                <!-- Weekly Quests -->
                <div class="quest-category">
                    <div class="category-header">
                        <div class="category-icon">ðŸ“†</div>
                        <div class="category-title">Weekly Quests</div>
                        <div class="category-badge">âš”ï¸ Epic Rewards</div>
                    </div>
                    ${renderQuestCards(data.weeklyQuests, 'weekly')}
                </div>
                
                <!-- Legendary Quests -->
                <div class="quest-category">
                    <div class="category-header">
                        <div class="category-icon">ðŸŒŸ</div>
                        <div class="category-title">Legendary Quests</div>
                        <div class="category-badge">${data.legendaryQuests.filter(q => q.completed).length}/${data.legendaryQuests.length}</div>
                    </div>
                    ${renderQuestCards(data.legendaryQuests, 'legendary')}
                </div>
            </div>
            
            <!-- Priority 3: Achievements -->
            <div class="priority-3">
                <div class="category-header">
                    <div class="category-icon">ðŸ†</div>
                    <div class="category-title">Achievements</div>
                    <div class="category-badge">${data.achievements.length}/${RPG_ACHIEVEMENTS.length}</div>
                </div>
                
                <div class="achievements-grid">
                    ${renderAchievements(data)}
                </div>
            </div>
        </div>
    `;
}

// Render quest cards
function renderQuestCards(quests, category) {
    return quests.map(quest => {
        const progressPercent = (quest.progress / quest.requirement) * 100;
        const canClaim = quest.completed && !quest.claimed;
        
        let statRewards = '';
        if (quest.stats) {
            statRewards = Object.entries(quest.stats).map(([stat, value]) => {
                const icons = { strength: 'ðŸ’ª', intelligence: 'ðŸ§ ', wisdom: 'ðŸ“š', luck: 'ðŸ€', all: 'ðŸ“Š' };
                return `<span class="reward-chip">${icons[stat] || 'âœ¨'} +${value}</span>`;
            }).join('');
        }
        
        return `
            <div class="quest-card ${quest.rarity}">
                <div class="quest-header">
                    <div class="quest-icon">${quest.icon}</div>
                    <div class="quest-info">
                        <div class="quest-name">${quest.name}</div>
                        <div class="quest-meta">
                            <span class="quest-rarity ${quest.rarity}">${quest.rarity}</span>
                            <span class="quest-xp">âœ¨ ${quest.xp} XP</span>
                        </div>
                    </div>
                </div>
                
                <div class="quest-description">${quest.description}</div>
                
                <div class="quest-rewards">
                    ${statRewards}
                </div>
                
                <div class="quest-progress">
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                    </div>
                    <div class="progress-text">
                        <span>Progress: ${quest.progress}/${quest.requirement}</span>
                        <span>${Math.round(progressPercent)}%</span>
                    </div>
                </div>
                
                <div class="quest-actions">
                    ${canClaim ? 
                        `<button class="quest-btn claim" onclick="claimQuest('${quest.id}', '${category}')">
                            âœ¨ CLAIM REWARDS
                        </button>` : 
                        quest.claimed ?
                        `<button class="quest-btn" disabled>âœ“ COMPLETED</button>` :
                        `<button class="quest-btn" disabled>
                            ${quest.progress >= quest.requirement ? 'READY!' : 'IN PROGRESS'}
                        </button>`
                    }
                </div>
            </div>
        `;
    }).join('');
}

// Render achievements
function renderAchievements(data) {
    return RPG_ACHIEVEMENTS.map(achievement => {
        const unlocked = data.achievements.includes(achievement.id);
        
        return `
            <div class="achievement-card ${unlocked ? 'unlocked' : ''}">
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-info">
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                </div>
            </div>
        `;
    }).join('');
}

// Show toast notification
function showGameToast(title, message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = 'game-toast';
    toast.style.borderColor = type === 'legendary' ? 'var(--rpg-legendary)' : 'var(--rpg-gold)';
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 2rem;">${type === 'legendary' ? 'ðŸŒŸ' : 'âœ¨'}</span>
            <div>
                <div style="font-weight: 700;">${title}</div>
                <div style="font-size: 0.9rem;">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'toastSlide 0.5s reverse';
        setTimeout(() => toast.remove(), 500);
    }, 4000);
}

// Update UI
function updateRpgUI() {
    const container = document.getElementById('rpgGameContainer');
    if (container && container.style.display === 'block') {
        container.innerHTML = renderRpgUI();
    }
}

// Show RPG section
function showRpgSection() {
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    let rpgContainer = document.getElementById('rpgGameContainer');
    if (!rpgContainer) {
        rpgContainer = document.createElement('div');
        rpgContainer.id = 'rpgGameContainer';
        rpgContainer.className = 'dashboard-content';
        rpgContainer.style.gridColumn = 'span 12';
        
        const mainContent = document.querySelector('.main-content .dashboard-grid') || 
                           document.querySelector('.main-content');
        if (mainContent) {
            mainContent.appendChild(rpgContainer);
        }
    }
    
    rpgContainer.style.display = 'block';
    rpgContainer.innerHTML = renderRpgUI();
    
    const header = document.getElementById('dashboardHeader');
    if (header) {
        header.querySelector('h1').textContent = 'ðŸŽ® RPG ADVENTURE';
        header.querySelector('.dashboard-subtitle').textContent = 'Your real study data powers your character!';
    }
}

// Add navigation
function addRpgNavItem() {
    const sidebarNav = document.querySelector('.sidebar-nav');
    if (!sidebarNav) return;
    
    if (document.querySelector('.nav-item.rpg-nav')) return;
    
    const navItem = document.createElement('div');
    navItem.className = 'nav-item rpg-nav';
    navItem.setAttribute('onclick', 'showRpgSection(); closeMobileMenu();');
    navItem.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    navItem.style.color = 'white';
    navItem.style.fontWeight = '800';
    navItem.style.border = '2px solid #fbbf24';
    navItem.innerHTML = 'ðŸŽ® RPG QUESTS';
    
    sidebarNav.insertBefore(navItem, sidebarNav.firstChild);
}

// Initialize
function initRpgSystem() {
    console.log("ðŸŽ® Initializing RPG System with REAL data connection...");
    
    addRpgNavItem();
    
    // Initial update
    setTimeout(() => {
        updateQuestProgress();
    }, 1000);
    
    // Auto-update every 30 seconds
    setInterval(() => {
        if (document.getElementById('rpgGameContainer')?.style.display === 'block') {
            updateQuestProgress();
        }
    }, 30000);
}

// Hook into existing functions
function hookIntoGame() {
    const functions = ['markStudyToday', 'addStudyHours', 'addTask', 'toggleTask'];
    functions.forEach(fnName => {
        const original = window[fnName];
        if (original) {
            window[fnName] = function() {
                original.apply(this, arguments);
                setTimeout(updateQuestProgress, 500);
            };
        }
    });
}

// Start when ready
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initRpgSystem();
        hookIntoGame();
    }, 2000);
});

// Override showSection
const rpgOriginalShowSection = window.showSection;
window.showSection = function(sectionId) {
    if (sectionId === 'rpg') {
        showRpgSection();
        return;
    }
    if (rpgOriginalShowSection) {
        rpgOriginalShowSection(sectionId);
    }
};




// ========== FIXED RPG SYSTEM WITH PROPER DATA CONNECTION ==========

// Override the RPG functions to work with your actual studyData
const originalLoadRpgData = loadRpgData;
loadRpgData = function() {
    try {
        // First try to get existing RPG data
        const saved = localStorage.getItem('trueRpgData');
        if (saved) {
            const parsed = JSON.parse(saved);
            
            // Update with current study data
            if (typeof studyData !== 'undefined') {
                // Calculate stats based on actual study data
                const totalTasks = tasks ? tasks.filter(t => t.completed).length : 0;
                const totalHours = parseFloat(studyData.totalStudyHours || 0);
                const streak = studyData.streak || 0;
                
                // Update RPG stats to match real progress
                parsed.strength = 5 + Math.floor(totalTasks / 10);
                parsed.intelligence = 5 + Math.floor(totalHours / 5);
                parsed.wisdom = 5 + Math.floor(streak / 3);
                parsed.luck = 5 + Math.floor((parsed.perfectDays || 0) / 2);
                
                // Update mana based on today's activity
                const today = new Date().toDateString();
                const todayStats = studyData.dailyStats?.find(s => s.date === today);
                const todaySessions = todayStats?.sessions || 0;
                parsed.mana = Math.min(parsed.maxMana || 100, 50 + (todaySessions * 10));
                
                // Update health based on streak
                parsed.health = Math.min(parsed.maxHealth || 100, 70 + (streak * 2));
                
                // Update XP based on total progress
                parsed.totalXP = Math.floor(totalHours * 10 + totalTasks * 5 + streak * 20);
                parsed.xp = parsed.totalXP % (parsed.xpToNextLevel || 100);
                parsed.level = 1 + Math.floor(parsed.totalXP / (parsed.xpToNextLevel || 100));
            }
            
            return parsed;
        }
    } catch (e) {
        console.error("Error loading RPG data:", e);
    }
    
    // Return default if nothing found
    return {
        level: 1,
        xp: 0,
        xpToNextLevel: 100,
        totalXP: 0,
        strength: 5,
        intelligence: 5,
        wisdom: 5,
        luck: 5,
        health: 100,
        maxHealth: 100,
        mana: 50,
        maxMana: 100,
        questsCompleted: 0,
        perfectDays: 0,
        achievements: [],
        titles: ['Novice Adventurer'],
        currentTitle: 'Novice Adventurer',
        dailyQuests: initializeQuests(DAILY_QUESTS),
        weeklyQuests: initializeQuests(WEEKLY_QUESTS),
        legendaryQuests: initializeQuests(LEGENDARY_QUESTS),
        dailyStreak: 0,
        lastDailyComplete: null,
        lastDailyReset: new Date().toDateString(),
        lastWeeklyReset: getWeekStart(),
        lastManaRegen: Date.now()
    };
}

// Fix collectRealProgress to actually work
const originalCollectRealProgress = collectRealProgress;
collectRealProgress = function() {
    if (typeof studyData === 'undefined') return {
        focusSessions: 0,
        todayTasks: 0,
        streakMaintained: 0,
        todayHours: 0,
        streak: 0,
        weeklyTasks: 0,
        weeklyHours: 0,
        totalTasks: 0,
        totalHours: 0,
        longestStreak: 0
    };
    
    const today = new Date().toDateString();
    const todayStats = studyData.dailyStats?.find(s => s.date === today);
    
    // Focus sessions (25+ minutes = 0.4+ hours)
    const focusSessions = studyData.studySessions?.filter(s => {
        if (!s.date) return false;
        return new Date(s.date).toDateString() === today && (s.hours || 0) >= 0.4;
    }).length || 0;
    
    // Today's completed tasks
    const todayTasks = tasks.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        return new Date(t.completedAt).toDateString() === today;
    }).length;
    
    // Weekly tasks
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weeklyTasks = tasks.filter(t => {
        if (!t.completed || !t.completedAt) return false;
        return new Date(t.completedAt) >= weekAgo;
    }).length;
    
    // Weekly hours
    const weeklyHours = studyData.dailyStats?.reduce((sum, day) => {
        if (new Date(day.date) >= weekAgo) {
            return sum + (day.hours || 0);
        }
        return sum;
    }, 0) || 0;
    
    // Total completed tasks
    const totalTasks = tasks.filter(t => t.completed).length;
    
    // Total study hours
    const totalHours = parseFloat(studyData.totalStudyHours || 0);
    
    // Longest streak
    const longestStreak = studyData.streakHistory ? 
        Math.max(...studyData.streakHistory.map(s => s.streak || 0), studyData.streak || 0) : 
        studyData.streak || 0;
    
    return {
        focusSessions,
        todayTasks,
        streakMaintained: studyData.lastStudyDate === today ? 1 : 0,
        todayHours: todayStats?.hours || 0,
        streak: studyData.streak || 0,
        weeklyTasks,
        weeklyHours,
        totalTasks,
        totalHours,
        longestStreak,
        dayOfWeek: new Date().getDay(),
        hourOfDay: new Date().getHours()
    };
}

// Fix quest initialization
if (typeof initializeQuests === 'undefined') {
    window.initializeQuests = function(questList) {
        return questList.map(q => ({
            ...q,
            progress: 0,
            completed: false,
            claimed: false
        }));
    };
}

// Fix getWeekStart
if (typeof getWeekStart === 'undefined') {
    window.getWeekStart = function() {
        const d = new Date();
        d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1));
        return d.toDateString();
    };
}

// Force update quest progress every 30 seconds
setInterval(() => {
    if (typeof studyData !== 'undefined') {
        updateQuestProgress();
    }
}, 30000);

// Override showGameToast to use your notification system
const originalShowGameToast = showGameToast;
showGameToast = function(title, message, type = 'info') {
    if (typeof showNotification === 'function') {
        showNotification(`${title}: ${message}`, type);
    } else {
        console.log(`${title}: ${message}`);
    }
};

// Initialize quests on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (typeof DAILY_QUESTS !== 'undefined') {
            // Initialize RPG data
            const data = loadRpgData();
            saveRpgData(data);
            console.log("âœ… RPG System initialized with real data!");
        }
    }, 3000);
});
</script>







<!-- ===== BATTLE SYSTEM SECTION ===== -->
<style>
/* ===== BATTLE STYLES ===== */
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

.battle-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Press Start 2P', cursive;
}

.battle-header {
    background: linear-gradient(135deg, var(--card), rgba(79,70,229,0.2));
    border: 3px solid #fbbf24;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.battle-title {
    font-size: 1.5rem;
    color: #fbbf24;
    text-shadow: 2px 2px 0 #000;
}

.battle-stats {
    display: flex;
    gap: 30px;
}

.battle-stat {
    text-align: center;
}

.battle-stat .label {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-bottom: 5px;
}

.battle-stat .value {
    font-size: 1.2rem;
    font-weight: 800;
    color: #fbbf24;
}

.battle-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
}

.battle-card {
    background: linear-gradient(135deg, var(--card), var(--bg));
    border: 3px solid #fbbf24;
    border-radius: 30px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.battle-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 70%);
    transform: rotate(45deg);
    transition: all 0.3s ease;
}

.battle-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(251,191,36,0.3);
}

.battle-card.create {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
}

.battle-card.join {
    background: linear-gradient(135deg, #10b981, #059669);
}

.battle-icon {
    font-size: 4rem;
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #fbbf24;
}

.battle-card-title {
    font-size: 1.8rem;
    font-weight: 800;
    color: white;
    margin-bottom: 10px;
    text-shadow: 2px 2px 0 #000;
}

.battle-card-desc {
    color: rgba(255,255,255,0.9);
    margin-bottom: 20px;
    font-size: 0.8rem;
}

.battle-cost {
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 10px;
    color: #fbbf24;
    font-size: 0.9rem;
    display: inline-block;
    border: 2px solid #fbbf24;
}

/* Battle Code Section */
.battle-code-section {
    max-width: 600px;
    margin: 0 auto;
    background: linear-gradient(135deg, var(--card), var(--bg));
    border: 4px solid #fbbf24;
    border-radius: 30px;
    padding: 40px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}

.battle-code-display {
    font-family: 'Press Start 2P', cursive;
    font-size: 3rem;
    font-weight: 900;
    letter-spacing: 10px;
    padding: 30px;
    background: #000;
    border-radius: 20px;
    border: 4px solid #fbbf24;
    margin: 20px 0;
    color: #fbbf24;
    text-shadow: 0 0 20px rgba(251,191,36,0.5);
}

.battle-code-input {
    width: 100%;
    padding: 20px;
    font-size: 2rem;
    text-align: center;
    font-family: 'Press Start 2P', cursive;
    letter-spacing: 10px;
    background: #000;
    border: 4px solid #fbbf24;
    border-radius: 20px;
    color: #fbbf24;
    margin: 20px 0;
    text-transform: uppercase;
}

.battle-code-input:focus {
    outline: none;
    box-shadow: 0 0 30px rgba(251,191,36,0.5);
}

/* Battle Buttons */
.battle-btn {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: black;
    border: none;
    padding: 15px 30px;
    font-size: 1.2rem;
    font-weight: 800;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'Press Start 2P', cursive;
    transition: all 0.3s ease;
    margin: 10px;
    border: 3px solid #000;
    min-width: 200px;
}

.battle-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px #fbbf24;
}

.battle-btn.secondary {
    background: linear-gradient(135deg, #64748b, #475569);
    color: white;
}

.battle-btn.danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.battle-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Waiting Room */
.waiting-room {
    text-align: center;
    padding: 40px;
}

.waiting-players {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 50px;
    margin: 40px 0;
}

.waiting-player {
    text-align: center;
    width: 200px;
}

.waiting-avatar {
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    border-radius: 30px;
    border: 4px solid #fbbf24;
    margin: 0 auto 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    animation: pulse 2s infinite;
}

.waiting-vs {
    font-size: 3rem;
    font-weight: 900;
    color: #fbbf24;
    text-shadow: 4px 4px 0 #000;
    animation: vsPulse 1s infinite;
}

@keyframes vsPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.waiting-status {
    color: #fbbf24;
    font-size: 1rem;
    margin-top: 20px;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Battle Nav Button */
.battle-nav-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    color: white !important;
    font-weight: 800 !important;
    border: 3px solid #fbbf24 !important;
    animation: navPulse 2s infinite !important;
    margin-top: 15px !important;
    font-family: 'Press Start 2P', cursive !important;
    font-size: 0.9rem !important;
}

@keyframes navPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Error Message */
.battle-error {
    color: #ef4444;
    margin: 10px 0;
    padding: 10px;
    background: rgba(239,68,68,0.1);
    border-radius: 10px;
    font-size: 0.8rem;
}

/* Loading Spinner */
.battle-loading {
    display: inline-block;
    width: 50px;
    height: 50px;
    border: 5px solid rgba(251,191,36,0.3);
    border-radius: 50%;
    border-top-color: #fbbf24;
    animation: spin 1s ease-in-out infinite;
    margin: 20px auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .battle-grid {
        grid-template-columns: 1fr;
    }
    
    .battle-code-display {
        font-size: 2rem;
        letter-spacing: 5px;
    }
    
    .waiting-players {
        flex-direction: column;
        gap: 20px;
    }
}



</style>

<script>

// ========== COMPLETE FIXED BATTLE SYSTEM WITH PROPER HTML ELEMENTS ==========

// Battle state
let currentBattleCode = null;
let currentBattleRole = null;
let battleCheckInterval = null;
let battleData = null;
let redirectAttempted = false;

// Diagnosis colors
const DIAG = {
    INFO: "ðŸ”µ [INFO]",
    SUCCESS: "âœ… [SUCCESS]",
    ERROR: "âŒ [ERROR]",
    BATTLE: "âš”ï¸ [BATTLE]",
    WAITING: "â³ [WAITING]",
    REDIRECT: "ðŸš€ [REDIRECT]",
    FIREBASE: "ðŸ”¥ [FIREBASE]",
    PLAYER1: "ðŸ‘¤ [PLAYER 1]",
    PLAYER2: "ðŸ‘¥ [PLAYER 2]"
};

function diag(type, message, data = null) {
    if (data) {
        console.log(`${type} ${message}`, data);
    } else {
        console.log(`${type} ${message}`);
    }
}

// Show battle section
function showBattleSection() {
    diag(DIAG.INFO, "Opening battle section...");
    
    document.querySelectorAll('.dashboard-content').forEach(section => {
        section.style.display = 'none';
    });
    
    const battleSection = document.getElementById('battle');
    if (battleSection) battleSection.style.display = 'block';
    
    // Reset views
    const mainMenu = document.getElementById('battleMainMenu');
    const codeView = document.getElementById('battleCodeView');
    const waitingRoom = document.getElementById('battleWaitingRoom');
    const activeView = document.getElementById('battleActiveView');
    
    if (mainMenu) mainMenu.style.display = 'block';
    if (codeView) codeView.style.display = 'none';
    if (waitingRoom) waitingRoom.style.display = 'none';
    if (activeView) activeView.style.display = 'none';
    
    updateBattleStats();
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.textContent.includes('âš”ï¸ BATTLE')) {
            item.classList.add('active');
        }
    });
    
    redirectAttempted = false;
}

// Update battle stats
function updateBattleStats() {
    const rpgData = loadBattleRpgData();
    const manaEl = document.getElementById('battleManaDisplay');
    const levelEl = document.getElementById('battleLevelDisplay');
    
    if (manaEl) manaEl.textContent = Math.round(rpgData.mana || 50);
    if (levelEl) levelEl.textContent = rpgData.level || 1;
}

// Load RPG data
function loadBattleRpgData() {
    try {
        const saved = localStorage.getItem('trueRpgData');
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.error("Error loading RPG data:", e);
    }
    
    return {
        level: 1,
        xp: 0,
        mana: 50,
        maxMana: 100,
        strength: 5,
        intelligence: 5,
        wisdom: 5,
        luck: 5,
        wins: 0,
        losses: 0
    };
}

// Save RPG data
function saveBattleRpgData(data) {
    try {
        localStorage.setItem('trueRpgData', JSON.stringify(data));
    } catch (e) {
        console.error("Error saving RPG data:", e);
    }
}

// Show battle code view
function showBattleCode(type) {
    const mainMenu = document.getElementById('battleMainMenu');
    const codeView = document.getElementById('battleCodeView');
    
    if (mainMenu) mainMenu.style.display = 'none';
    if (codeView) codeView.style.display = 'block';
    
    if (type === 'create') {
        diag(DIAG.BATTLE, "CREATOR: Starting battle creation...");
        
        const rpgData = loadBattleRpgData();
        if (rpgData.mana < 20) {
            diag(DIAG.ERROR, "Not enough mana!");
            alert("Not enough mana! Need 20 mana to create a battle.");
            backToBattleMenu();
            return;
        }
        
        rpgData.mana -= 20;
        saveBattleRpgData(rpgData);
        updateBattleStats();
        
        currentBattleCode = generateBattleCode();
        const codeDisplay = document.getElementById('generatedBattleCode');
        if (codeDisplay) codeDisplay.textContent = currentBattleCode;
        
        diag(DIAG.SUCCESS, `CREATOR: Battle code generated: ${currentBattleCode}`);
        
        const createView = document.getElementById('battleCreateView');
        const joinView = document.getElementById('battleJoinView');
        
        if (createView) createView.style.display = 'block';
        if (joinView) joinView.style.display = 'none';
        
        currentBattleRole = 'creator';
        redirectAttempted = false;
        
        createBattleInFirebase(currentBattleCode);
        
    } else {
        diag(DIAG.BATTLE, "JOINER: Opening join battle view...");
        
        const createView = document.getElementById('battleCreateView');
        const joinView = document.getElementById('battleJoinView');
        
        if (createView) createView.style.display = 'none';
        if (joinView) joinView.style.display = 'block';
        
        currentBattleRole = 'joiner';
        redirectAttempted = false;
    }
}

// Generate random 6-digit code
function generateBattleCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
    }
    return code;
}

// Check if Firebase is ready
function isFirebaseReady() {
    return typeof firebase !== 'undefined' && 
           firebase.database && 
           typeof database !== 'undefined' && 
           database;
}

// Create battle in Firebase
async function createBattleInFirebase(code) {
    if (!isFirebaseReady()) {
        diag(DIAG.ERROR, "Firebase not connected!");
        alert("Firebase not connected");
        backToBattleMenu();
        return;
    }
    
    try {
        const playerId = getPlayerId();
        const playerName = getPlayerName();
        const rpgData = loadBattleRpgData();
        
        diag(DIAG.FIREBASE, `Creating battle in Firebase with code: ${code}`);
        
        const timestamp = Date.now();
        
        const battleData = {
            metadata: {
                code: code,
                status: 'waiting',
                createdAt: timestamp,
                round: 1,
                roundTime: 99,
                roundStartTime: timestamp
            },
            player1: {
                id: playerId,
                name: playerName,
                gender: 'boy',
                level: rpgData.level,
                strength: rpgData.strength,
                intelligence: rpgData.intelligence,
                wisdom: rpgData.wisdom,
                luck: rpgData.luck,
                health: 100,
                maxHealth: 100,
                mana: 0,
                maxMana: 100,
                side: 'left'
            },
            player2: null,
            actions: {},
            winner: null,
            roundWins: {
                player1: 0,
                player2: 0
            }
        };
        
        await database.ref('battles/' + code).set(battleData);
        diag(DIAG.SUCCESS, "Battle created successfully in Firebase!");
        
        // Verify
        const checkSnap = await database.ref('battles/' + code).once('value');
        diag(DIAG.FIREBASE, `Verification - Battle exists: ${checkSnap.exists()}`);
        
    } catch (error) {
        diag(DIAG.ERROR, `Error creating battle: ${error.message}`);
        alert("Failed to create battle: " + error.message);
        backToBattleMenu();
    }
}

// Wait for opponent - FIXED with null checks
function waitForOpponent() {
    if (!currentBattleCode) {
        diag(DIAG.ERROR, "No battle code found!");
        alert("No battle code found!");
        return;
    }
    
    diag(DIAG.WAITING, `CREATOR: Waiting for opponent to join with code: ${currentBattleCode}`);
    
    // Hide code view, show waiting room
    const codeView = document.getElementById('battleCodeView');
    const waitingRoom = document.getElementById('battleWaitingRoom');
    
    if (codeView) codeView.style.display = 'none';
    if (waitingRoom) waitingRoom.style.display = 'block';
    
    // Update player names - CHECK IF ELEMENTS EXIST FIRST!
    const playerName = getPlayerName();
    
    // Try different possible IDs for the waiting room elements
    const possiblePlayer1Name = document.getElementById('player1Name') || document.getElementById('player-name-1');
    const possiblePlayer1Status = document.getElementById('player1Status') || document.getElementById('player-status-1');
    const possiblePlayer2Name = document.getElementById('player2Name') || document.getElementById('player-name-2');
    const possiblePlayer2Status = document.getElementById('player2Status') || document.getElementById('player-status-2');
    const possiblePlayer2Avatar = document.getElementById('player2Avatar') || document.getElementById('player-avatar-2');
    
    if (possiblePlayer1Name) possiblePlayer1Name.textContent = playerName;
    if (possiblePlayer1Status) possiblePlayer1Status.textContent = "âœ… READY";
    if (possiblePlayer2Name) possiblePlayer2Name.textContent = "Waiting...";
    if (possiblePlayer2Status) possiblePlayer2Status.textContent = "â³ JOINING";
    if (possiblePlayer2Avatar) possiblePlayer2Avatar.innerHTML = "â“";
    
    diag(DIAG.INFO, "Waiting room displayed. Share code with friend!");
    
    redirectAttempted = false;
    
    // Start checking for opponent
    startBattleCheck(currentBattleCode);
}

// Start battle check
function startBattleCheck(code) {
    if (!isFirebaseReady()) return;
    
    diag(DIAG.INFO, `Starting battle check every 2 seconds for code: ${code}`);
    
    if (battleCheckInterval) {
        clearInterval(battleCheckInterval);
    }
    
    battleCheckInterval = setInterval(async () => {
        await checkBattleStatus(code);
    }, 2000);
}

// Check battle status
async function checkBattleStatus(code) {
    if (!code || !isFirebaseReady() || redirectAttempted) return;
    
    try {
        const snapshot = await database.ref('battles/' + code).once('value');
        const battle = snapshot.val();
        
        if (!battle) {
            diag(DIAG.ERROR, `Battle ${code} not found in Firebase!`);
            return;
        }
        
        const hasPlayer2 = !!battle.player2;
        
        diag(DIAG.FIREBASE, `Status: ${battle.metadata?.status} | Player2 joined: ${hasPlayer2 ? 'YES' : 'NO'}`);
        
        // If player2 exists, redirect!
        if (battle.player2 && !redirectAttempted) {
            diag(DIAG.SUCCESS, "âœ…âœ…âœ… PLAYER 2 HAS JOINED! Redirecting creator...");
            forceCreatorRedirect(code, battle);
        }
    } catch (error) {
        diag(DIAG.ERROR, `Check error: ${error.message}`);
    }
}

// Force creator redirect
function forceCreatorRedirect(code, battle) {
    if (redirectAttempted) return;
    
    redirectAttempted = true;
    diag(DIAG.REDIRECT, "ðŸŽ®ðŸŽ®ðŸŽ® FORCING CREATOR REDIRECT NOW!");
    
    if (battleCheckInterval) {
        clearInterval(battleCheckInterval);
        battleCheckInterval = null;
    }
    
    // Try to update UI if elements exist
    const player2Name = document.getElementById('player2Name') || document.getElementById('player-name-2');
    const player2Status = document.getElementById('player2Status') || document.getElementById('player-status-2');
    const player2Avatar = document.getElementById('player2Avatar') || document.getElementById('player-avatar-2');
    
    if (player2Name) player2Name.textContent = battle.player2.name;
    if (player2Status) player2Status.textContent = "âœ… READY";
    if (player2Avatar) player2Avatar.innerHTML = "ðŸ‘¤";
    
    const waitingRoom = document.getElementById('battleWaitingRoom');
    const activeView = document.getElementById('battleActiveView');
    
    if (waitingRoom) waitingRoom.style.display = 'none';
    if (activeView) activeView.style.display = 'block';
    
    const playerId = getPlayerId();
    const playerName = getPlayerName();
    
    diag(DIAG.REDIRECT, "Redirecting creator to fighting_game.html in 2 seconds...");
    
    setTimeout(() => {
        const gameUrl = buildBattleUrl(code, playerId, playerName, true);
        diag(DIAG.REDIRECT, `Redirect URL: ${gameUrl}`);
        window.location.href = gameUrl;
    }, 2000);
}

// Join battle
async function joinBattle() {
    const codeInput = document.getElementById('joinBattleCode');
    if (!codeInput) {
        console.error("Join battle code input not found");
        return;
    }
    
    const code = codeInput.value.toUpperCase().trim();
    const errorEl = document.getElementById('battleJoinError');
    
    if (!code || code.length !== 6) {
        diag(DIAG.ERROR, "Invalid battle code entered");
        if (errorEl) errorEl.textContent = "Invalid code";
        return;
    }
    
    diag(DIAG.BATTLE, `JOINER: Attempting to join battle with code: ${code}`);
    
    if (!isFirebaseReady()) {
        diag(DIAG.ERROR, "Firebase not connected!");
        if (errorEl) errorEl.textContent = "Firebase not connected";
        return;
    }
    
    currentBattleCode = code;
    
    try {
        diag(DIAG.FIREBASE, `Fetching battle data for code: ${code}`);
        const snapshot = await database.ref('battles/' + code).once('value');
        const battle = snapshot.val();
        
        if (!battle) {
            diag(DIAG.ERROR, `Battle ${code} not found!`);
            if (errorEl) errorEl.textContent = "Battle not found";
            return;
        }
        
        if (battle.metadata?.status !== 'waiting') {
            diag(DIAG.ERROR, `Battle already started! Status: ${battle.metadata?.status}`);
            if (errorEl) errorEl.textContent = "Battle already started";
            return;
        }
        
        const playerId = getPlayerId();
        
        if (battle.player1?.id === playerId) {
            diag(DIAG.ERROR, "Cannot join your own battle!");
            if (errorEl) errorEl.textContent = "You created this battle";
            return;
        }
        
        const playerName = getPlayerName();
        const rpgData = loadBattleRpgData();
        
        diag(DIAG.PLAYER2, `Adding joiner as player2: ${playerName}`);
        
        // Add player2
        await database.ref('battles/' + code + '/player2').set({
            id: playerId,
            name: playerName,
            gender: 'girl',
            level: rpgData.level,
            strength: rpgData.strength,
            intelligence: rpgData.intelligence,
            wisdom: rpgData.wisdom,
            luck: rpgData.luck,
            health: 100,
            maxHealth: 100,
            mana: 0,
            maxMana: 100,
            side: 'right'
        });
        
        diag(DIAG.SUCCESS, "âœ… Player2 added successfully!");
        
        // Update status
        await database.ref('battles/' + code + '/metadata/status').set('fighting');
        diag(DIAG.SUCCESS, "âœ… Battle status updated to 'fighting'");
        
        if (errorEl) errorEl.textContent = '';
        
        const codeView = document.getElementById('battleCodeView');
        const activeView = document.getElementById('battleActiveView');
        
        if (codeView) codeView.style.display = 'none';
        if (activeView) activeView.style.display = 'block';
        
        diag(DIAG.REDIRECT, "Joiner redirecting in 2 seconds...");
        
        setTimeout(() => {
            const gameUrl = buildBattleUrl(code, playerId, playerName, false);
            diag(DIAG.REDIRECT, `Redirect URL: ${gameUrl}`);
            window.location.href = gameUrl;
        }, 2000);
        
    } catch (error) {
        diag(DIAG.ERROR, `Join error: ${error.message}`);
        if (errorEl) errorEl.textContent = "Failed to join: " + error.message;
    }
}

// Build URL
function buildBattleUrl(code, playerId, playerName, isPlayer1) {
    let baseUrl = window.location.href;
    if (baseUrl.includes('studentmode.html')) {
        baseUrl = baseUrl.replace('studentmode.html', '');
    } else {
        baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1);
    }
    
    return `${baseUrl}fighting_game.html?code=${code}&role=${isPlayer1 ? 'player1' : 'player2'}&name=${encodeURIComponent(playerName)}&id=${playerId}`;
}

// Copy battle code
function copyBattleCode() {
    if (!currentBattleCode) return;
    navigator.clipboard.writeText(currentBattleCode).then(() => {
        diag(DIAG.SUCCESS, `Code copied: ${currentBattleCode}`);
        alert("Code copied: " + currentBattleCode);
    });
}

// Cancel battle
async function cancelBattle() {
    diag(DIAG.INFO, "Cancelling battle...");
    
    if (battleCheckInterval) {
        clearInterval(battleCheckInterval);
        battleCheckInterval = null;
    }
    
    if (currentBattleCode && isFirebaseReady()) {
        try {
            await database.ref('battles/' + currentBattleCode).remove();
            diag(DIAG.SUCCESS, `Battle ${currentBattleCode} removed`);
        } catch (error) {
            diag(DIAG.ERROR, `Error removing battle: ${error.message}`);
        }
    }
    
    currentBattleCode = null;
    redirectAttempted = false;
    backToBattleMenu();
}

// Back to battle menu
function backToBattleMenu() {
    const mainMenu = document.getElementById('battleMainMenu');
    const codeView = document.getElementById('battleCodeView');
    const waitingRoom = document.getElementById('battleWaitingRoom');
    const activeView = document.getElementById('battleActiveView');
    
    if (mainMenu) mainMenu.style.display = 'block';
    if (codeView) codeView.style.display = 'none';
    if (waitingRoom) waitingRoom.style.display = 'none';
    if (activeView) activeView.style.display = 'none';
    
    if (battleCheckInterval) {
        clearInterval(battleCheckInterval);
        battleCheckInterval = null;
    }
    
    currentBattleCode = null;
    redirectAttempted = false;
}

// Get player ID
function getPlayerId() {
    return localStorage.getItem('studentUserId') || 'player_' + Date.now();
}

// Get player name
function getPlayerName() {
    return localStorage.getItem('studentName') || 'Player';
}

// Add battle nav button
function addBattleNavButton() {
    const sidebarNav = document.querySelector('.sidebar-nav');
    if (!sidebarNav) {
        setTimeout(addBattleNavButton, 1000);
        return;
    }
    
    if (document.querySelector('.battle-nav-btn')) return;
    
    const navItem = document.createElement('div');
    navItem.className = 'nav-item battle-nav-btn';
    navItem.setAttribute('onclick', 'showBattleSection(); closeMobileMenu();');
    navItem.innerHTML = 'âš”ï¸ BATTLE';
    
    sidebarNav.appendChild(navItem);
    console.log("âœ… Battle nav button added!");
}

// Initialize
function initBattleSystem() {
    console.log("âš”ï¸ Initializing Battle System...");
    addBattleNavButton();
}

// Start
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(initBattleSystem, 2000));
} else {
    setTimeout(initBattleSystem, 2000);
}


// ===== SIMPLE ACHIEVEMENT CHECKER =====
setInterval(function checkAchievementsSimple() {
    if (typeof studyData === 'undefined') return;
    
    const achievements = JSON.parse(localStorage.getItem('studentEarnedBadges') || '[]');
    const newAchievements = [];
    
    // Check streak achievements
    const streak = studyData.streak || 0;
    if (streak >= 3 && !achievements.includes('streak-3')) {
        newAchievements.push({ id: 'streak-3', name: '3-Day Streak' });
    }
    if (streak >= 7 && !achievements.includes('streak-7')) {
        newAchievements.push({ id: 'streak-7', name: '7-Day Streak' });
    }
    if (streak >= 14 && !achievements.includes('streak-14')) {
        newAchievements.push({ id: 'streak-14', name: '14-Day Streak' });
    }
    if (streak >= 30 && !achievements.includes('streak-30')) {
        newAchievements.push({ id: 'streak-30', name: '30-Day Streak' });
    }
    
    // Check task achievements
    const completedTasks = tasks.filter(t => t.completed).length;
    if (completedTasks >= 10 && !achievements.includes('tasks-10')) {
        newAchievements.push({ id: 'tasks-10', name: '10 Tasks Completed' });
    }
    if (completedTasks >= 50 && !achievements.includes('tasks-50')) {
        newAchievements.push({ id: 'tasks-50', name: '50 Tasks Completed' });
    }
    
    // Check study hours achievements
    const totalHours = parseFloat(studyData.totalStudyHours || 0);
    if (totalHours >= 10 && !achievements.includes('hours-10')) {
        newAchievements.push({ id: 'hours-10', name: '10 Hours Studied' });
    }
    if (totalHours >= 50 && !achievements.includes('hours-50')) {
        newAchievements.push({ id: 'hours-50', name: '50 Hours Studied' });
    }
    
    // Add new achievements
    if (newAchievements.length > 0) {
        newAchievements.forEach(ach => {
            achievements.push(ach.id);
            showNotification(`ðŸ† Achievement: ${ach.name}!`, "success");
        });
        localStorage.setItem('studentEarnedBadges', JSON.stringify(achievements));
        if (typeof renderBadges === 'function') renderBadges();
    }
}, 5000); // Check every 5 seconds




// ===== COMPLETE FIX FOR QUEST SYSTEM AND ACHIEVEMENTS =====
(function fixAllIssues() {
    console.log("ðŸ”§ Applying complete fixes...");
    
    // ===== FIX CSS SELECTOR ERROR =====
    window.addSectionClasses = function() {
        console.log('Adding section classes safely...');
        const dashboard = document.getElementById('dashboard');
        if (!dashboard) return;
        
        // Remove existing classes
        document.querySelectorAll('.study-progress-section, .tasks-section, .classroom-section, .tools-section').forEach(el => {
            el.classList.remove('study-progress-section', 'tasks-section', 'classroom-section', 'tools-section');
        });
        
        // Study progress section
        const quickStats = dashboard.querySelector('.quick-stats');
        if (quickStats) quickStats.classList.add('study-progress-section');
        
        const streakCard = dashboard.querySelector('.streak-card');
        if (streakCard) streakCard.classList.add('study-progress-section');
        
        const goalCard = dashboard.querySelector('.goal-card');
        if (goalCard) goalCard.classList.add('study-progress-section');
        
        // Tasks section
        const allCards = dashboard.querySelectorAll('.content-card');
        allCards.forEach(card => {
            const header = card.querySelector('.content-header h2');
            if (header) {
                const text = header.textContent || '';
                if (text.includes('My Tasks')) card.classList.add('tasks-section');
                if (text.includes('My Assignments')) card.classList.add('tasks-section');
                if (text.includes('Add Study Hours')) card.classList.add('study-progress-section');
                if (text.includes('Study Stats Compare')) card.classList.add('tools-section');
                if (text.includes('Learn By Teaching')) card.classList.add('tools-section');
            }
        });
        
        // Tools section
        const quickNotes = dashboard.querySelector('.quick-notes-card');
        if (quickNotes) quickNotes.classList.add('tools-section');
        
        const badgesCard = dashboard.querySelector('.badges-card');
        if (badgesCard) badgesCard.classList.add('tools-section');
        
        const motivationCard = dashboard.querySelector('.motivation-card');
        if (motivationCard) motivationCard.classList.add('tools-section');
        
        // Find profile form safely
        const formCards = dashboard.querySelectorAll('.form-card');
        formCards.forEach(card => {
            const header = card.querySelector('h2');
            if (header && header.textContent.includes('My Profile')) {
                card.classList.add('tools-section');
            }
        });
        
        console.log('âœ… Classes added safely');
    };
    
    // ===== FIX DATA LOADING =====
    // Ensure studyData and tasks are defined
    if (typeof studyData === 'undefined') {
        window.studyData = {
            streak: 0,
            lastStudyDate: "",
            totalMinutes: 0,
            totalStudyDays: 0,
            totalStudyHours: 0,
            studySessions: [],
            dailyStats: []
        };
    }
    
    if (typeof tasks === 'undefined') {
        window.tasks = [];
    }
    
    // ===== FIX COLLECT REAL PROGRESS =====
    window.collectRealProgress = function() {
        try {
            const today = new Date().toDateString();
            const todayStats = studyData?.dailyStats?.find(s => s?.date === today);
            
            // Safely calculate values
            const focusSessions = studyData?.studySessions?.filter(s => {
                if (!s?.date) return false;
                try {
                    return new Date(s.date).toDateString() === today && (s.hours || 0) >= 0.4;
                } catch {
                    return false;
                }
            }).length || 0;
            
            const todayTasks = tasks?.filter(t => {
                if (!t?.completed || !t?.completedAt) return false;
                try {
                    return new Date(t.completedAt).toDateString() === today;
                } catch {
                    return false;
                }
            }).length || 0;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const weeklyTasks = tasks?.filter(t => {
                if (!t?.completed || !t?.completedAt) return false;
                try {
                    return new Date(t.completedAt) >= weekAgo;
                } catch {
                    return false;
                }
            }).length || 0;
            
            const weeklyHours = studyData?.dailyStats?.reduce((sum, day) => {
                if (!day?.date) return sum;
                try {
                    if (new Date(day.date) >= weekAgo) {
                        return sum + (day.hours || 0);
                    }
                } catch {}
                return sum;
            }, 0) || 0;
            
            const totalTasks = tasks?.filter(t => t?.completed).length || 0;
            const totalHours = parseFloat(studyData?.totalStudyHours || 0);
            
            const streak = studyData?.streak || 0;
            
            // Get quests completed from RPG data
            let questsCompleted = 0;
            try {
                const rpgData = JSON.parse(localStorage.getItem('trueRpgData') || '{}');
                questsCompleted = rpgData.questsCompleted || 0;
            } catch (e) {}
            
            return {
                focusSessions: focusSessions,
                todayTasks: todayTasks,
                streakMaintained: studyData?.lastStudyDate === today ? 1 : 0,
                todayHours: todayStats?.hours || 0,
                streak: streak,
                weeklyTasks: weeklyTasks,
                weeklyHours: weeklyHours,
                totalTasks: totalTasks,
                totalHours: totalHours,
                longestStreak: streak,
                questsCompleted: questsCompleted
            };
        } catch (e) {
            console.error("Error in collectRealProgress:", e);
            return {
                focusSessions: 0, todayTasks: 0, streakMaintained: 0, todayHours: 0,
                streak: 0, weeklyTasks: 0, weeklyHours: 0, totalTasks: 0, totalHours: 0,
                longestStreak: 0, questsCompleted: 0
            };
        }
    };
    
    // ===== FIX ADD RPG XP (PREVENT INFINITE LOOP) =====
    const originalAddRpgXP = window.addRpgXP || function(amount, source) {
        try {
            const data = JSON.parse(localStorage.getItem('trueRpgData') || '{}');
            
            data.xp = (data.xp || 0) + amount;
            data.totalXP = (data.totalXP || 0) + amount;
            
            let leveledUp = false;
            
            while (data.xp >= (data.xpToNextLevel || 100)) {
                data.xp -= (data.xpToNextLevel || 100);
                data.level = (data.level || 1) + 1;
                data.xpToNextLevel = Math.floor((data.xpToNextLevel || 100) * 1.3);
                
                // Increase stats on level up
                data.strength = (data.strength || 5) + 1;
                data.intelligence = (data.intelligence || 5) + 1;
                data.wisdom = (data.wisdom || 5) + 1;
                data.luck = (data.luck || 5) + 1;
                
                leveledUp = true;
                
                // Show level up notification
                if (typeof showNotification === 'function') {
                    showNotification(`â­ LEVEL UP! Now level ${data.level}!`, "success");
                }
            }
            
            localStorage.setItem('trueRpgData', JSON.stringify(data));
            return leveledUp;
        } catch (e) {
            console.error("Error in addRpgXP:", e);
            return false;
        }
    };
    
    window.addRpgXP = originalAddRpgXP;
    
    // ===== FIX ACHIEVEMENTS (PREVENT INFINITE LOOP) =====
    // Track notified achievements
    let notifiedAchievements = JSON.parse(localStorage.getItem('notifiedAchievements') || '[]');
    
    function saveNotifiedAchievements() {
        localStorage.setItem('notifiedAchievements', JSON.stringify(notifiedAchievements));
    }
    
    // Separate achievement checker that doesn't call addRpgXP
    window.checkAchievements = function() {
        try {
            if (typeof studyData === 'undefined' || typeof tasks === 'undefined') return;
            
            const achievements = JSON.parse(localStorage.getItem('studentEarnedBadges') || '[]');
            const newAchievements = [];
            
            // Check streak achievements
            const streak = studyData.streak || 0;
            if (streak >= 3 && !achievements.includes('streak-3')) {
                newAchievements.push({ id: 'streak-3', name: '3-Day Streak ðŸ”¥' });
                achievements.push('streak-3');
            }
            if (streak >= 7 && !achievements.includes('streak-7')) {
                newAchievements.push({ id: 'streak-7', name: '7-Day Streak â­' });
                achievements.push('streak-7');
            }
            if (streak >= 14 && !achievements.includes('streak-14')) {
                newAchievements.push({ id: 'streak-14', name: '14-Day Streak ðŸ†' });
                achievements.push('streak-14');
            }
            if (streak >= 30 && !achievements.includes('streak-30')) {
                newAchievements.push({ id: 'streak-30', name: '30-Day Streak ðŸ‘‘' });
                achievements.push('streak-30');
            }
            
            // Check task achievements
            const completedTasks = tasks.filter(t => t.completed).length;
            if (completedTasks >= 10 && !achievements.includes('tasks-10')) {
                newAchievements.push({ id: 'tasks-10', name: '10 Tasks Completed âœ…' });
                achievements.push('tasks-10');
            }
            if (completedTasks >= 50 && !achievements.includes('tasks-50')) {
                newAchievements.push({ id: 'tasks-50', name: '50 Tasks Completed âš”ï¸' });
                achievements.push('tasks-50');
            }
            
            // Check study hours achievements
            const totalHours = parseFloat(studyData.totalStudyHours || 0);
            if (totalHours >= 10 && !achievements.includes('hours-10')) {
                newAchievements.push({ id: 'hours-10', name: '10 Hours Studied âŒ›' });
                achievements.push('hours-10');
            }
            if (totalHours >= 50 && !achievements.includes('hours-50')) {
                newAchievements.push({ id: 'hours-50', name: '50 Hours Studied â³' });
                achievements.push('hours-50');
            }
            
            // Only show notifications for new achievements
            if (newAchievements.length > 0) {
                newAchievements.forEach(ach => {
                    if (!notifiedAchievements.includes(ach.id)) {
                        if (typeof showNotification === 'function') {
                            showNotification(`ðŸ† Achievement Unlocked: ${ach.name}!`, "success");
                        }
                        notifiedAchievements.push(ach.id);
                    }
                });
                saveNotifiedAchievements();
                
                localStorage.setItem('studentEarnedBadges', JSON.stringify(achievements));
                if (typeof renderBadges === 'function') renderBadges();
            }
        } catch (e) {
            console.error("Achievement check error:", e);
        }
    };
    
    // ===== FIX UPDATE QUEST PROGRESS =====
    window.updateQuestProgress = function() {
        try {
            const data = JSON.parse(localStorage.getItem('trueRpgData') || '{}');
            const progress = collectRealProgress();
            
            if (!data || !progress) return;
            
            // Update quest progress without triggering achievements
            if (data.dailyQuests) {
                data.dailyQuests.forEach(quest => {
                    if (!quest.completed && !quest.claimed) {
                        if (quest.id === 'daily_focus') quest.progress = progress.focusSessions;
                        else if (quest.id === 'daily_tasks') quest.progress = progress.todayTasks;
                        else if (quest.id === 'daily_streak') quest.progress = progress.streakMaintained;
                        else if (quest.id === 'daily_hours') quest.progress = Math.floor(progress.todayHours);
                        
                        if (quest.progress >= quest.requirement && !quest.completed) {
                            quest.completed = true;
                        }
                    }
                });
            }
            
            if (data.weeklyQuests) {
                data.weeklyQuests.forEach(quest => {
                    if (!quest.completed && !quest.claimed) {
                        if (quest.id === 'weekly_streak') quest.progress = progress.streak;
                        else if (quest.id === 'weekly_tasks') quest.progress = progress.weeklyTasks;
                        else if (quest.id === 'weekly_hours') quest.progress = Math.floor(progress.weeklyHours);
                        
                        if (quest.progress >= quest.requirement && !quest.completed) {
                            quest.completed = true;
                        }
                    }
                });
            }
            
            if (data.legendaryQuests) {
                data.legendaryQuests.forEach(quest => {
                    if (!quest.completed && !quest.claimed) {
                        if (quest.id === 'legend_first') quest.progress = progress.questsCompleted >= 1 ? 1 : 0;
                        else if (quest.id === 'legend_10') quest.progress = progress.questsCompleted >= 10 ? 1 : 0;
                        else if (quest.id === 'legend_50') quest.progress = progress.questsCompleted >= 50 ? 1 : 0;
                        else if (quest.id === 'legend_100') quest.progress = progress.questsCompleted >= 100 ? 1 : 0;
                        else if (quest.id === 'legend_streak_30') quest.progress = progress.streak >= 30 ? 1 : 0;
                        
                        if (quest.progress >= quest.requirement && !quest.completed) {
                            quest.completed = true;
                        }
                    }
                });
            }
            
            localStorage.setItem('trueRpgData', JSON.stringify(data));
            
            // Update UI if visible
            if (document.getElementById('rpgGameContainer')?.style.display === 'block') {
                const container = document.getElementById('rpgGameContainer');
                if (container && typeof renderRpgUI === 'function') {
                    container.innerHTML = renderRpgUI();
                }
            }
            
        } catch (e) {
            console.error("Error updating quest progress:", e);
        }
    };
    
    // ===== HOOK INTO EXISTING FUNCTIONS =====
    const actions = ['markStudyToday', 'addStudyHours', 'addTask', 'toggleTask', 'completeTeachMode'];
    actions.forEach(fnName => {
        const original = window[fnName];
        if (original) {
            window[fnName] = function() {
                const result = original.apply(this, arguments);
                setTimeout(() => {
                    updateQuestProgress();
                    checkAchievements();
                }, 500);
                return result;
            };
        }
    });
    
    // ===== INITIALIZE QUESTS =====
    function initializeQuests() {
        try {
            let data = JSON.parse(localStorage.getItem('trueRpgData') || '{}');
            
            // Initialize quests if missing
            if (!data.dailyQuests) {
                data.dailyQuests = [
                    { id: 'daily_focus', name: 'ðŸ§˜ Focus Warrior', description: 'Complete a focus session', icon: 'ðŸŽ¯', xp: 50, requirement: 1, rarity: 'common', stats: { wisdom: 1 }, progress: 0, completed: false, claimed: false },
                    { id: 'daily_tasks', name: 'âš”ï¸ Task Slayer', description: 'Complete 3 tasks', icon: 'âœ“', xp: 60, requirement: 3, rarity: 'uncommon', stats: { strength: 1 }, progress: 0, completed: false, claimed: false },
                    { id: 'daily_streak', name: 'ðŸ”¥ Streak Keeper', description: 'Maintain your study streak', icon: 'ðŸ”¥', xp: 75, requirement: 1, rarity: 'rare', stats: { luck: 1 }, progress: 0, completed: false, claimed: false },
                    { id: 'daily_hours', name: 'âŒ› Time Mage', description: 'Study for 2 hours', icon: 'âŒ›', xp: 100, requirement: 2, rarity: 'epic', stats: { intelligence: 1 }, progress: 0, completed: false, claimed: false }
                ];
            }
            
            if (!data.weeklyQuests) {
                data.weeklyQuests = [
                    { id: 'weekly_streak', name: 'ðŸ† Streak Legend', description: 'Maintain a 7-day streak', icon: 'ðŸ”¥', xp: 500, requirement: 7, rarity: 'epic', stats: { luck: 3, wisdom: 2 }, progress: 0, completed: false, claimed: false },
                    { id: 'weekly_tasks', name: 'âš”ï¸ Quest Master', description: 'Complete 20 tasks', icon: 'ðŸ“œ', xp: 400, requirement: 20, rarity: 'epic', stats: { strength: 3, intelligence: 2 }, progress: 0, completed: false, claimed: false },
                    { id: 'weekly_hours', name: 'â° Time Lord', description: 'Study 12 hours', icon: 'âŒ›', xp: 600, requirement: 12, rarity: 'legendary', stats: { intelligence: 3, wisdom: 2 }, progress: 0, completed: false, claimed: false }
                ];
            }
            
            if (!data.legendaryQuests) {
                data.legendaryQuests = [
                    { id: 'legend_first', name: 'ðŸŒŸ First Steps', description: 'Complete your first quest', icon: 'ðŸŒ±', xp: 100, requirement: 1, rarity: 'common', stats: { luck: 2 }, progress: 0, completed: false, claimed: false },
                    { id: 'legend_10', name: 'âš”ï¸ Quest Apprentice', description: 'Complete 10 quests', icon: 'âš”ï¸', xp: 250, requirement: 10, rarity: 'uncommon', stats: { strength: 2, intelligence: 2 }, progress: 0, completed: false, claimed: false },
                    { id: 'legend_50', name: 'ðŸ‘‘ Quest Warrior', description: 'Complete 50 quests', icon: 'ðŸ‘‘', xp: 600, requirement: 50, rarity: 'rare', stats: { wisdom: 3, luck: 3 }, progress: 0, completed: false, claimed: false },
                    { id: 'legend_100', name: 'âœ¨ Quest Legend', description: 'Complete 100 quests', icon: 'âœ¨', xp: 1200, requirement: 100, rarity: 'epic', stats: { all: 4 }, progress: 0, completed: false, claimed: false },
                    { id: 'legend_streak_30', name: 'ðŸŒ‹ Inferno Master', description: 'Achieve a 30-day streak', icon: 'ðŸ”¥', xp: 2000, requirement: 30, rarity: 'legendary', stats: { all: 5 }, progress: 0, completed: false, claimed: false }
                ];
            }
            
            localStorage.setItem('trueRpgData', JSON.stringify(data));
            console.log("âœ… Quests initialized successfully");
            
            // Run initial updates
            setTimeout(() => {
                updateQuestProgress();
                checkAchievements();
            }, 1000);
            
        } catch (e) {
            console.error("Quest initialization error:", e);
        }
    }
    
    // Clear any existing intervals
    if (window._achievementInterval) {
        clearInterval(window._achievementInterval);
    }
    
    // Set new interval (check every 30 seconds instead of 10 to be safe)
    window._achievementInterval = setInterval(() => {
        checkAchievements();
    }, 30000);
    
    // Initialize
    setTimeout(initializeQuests, 2000);
    
    console.log("âœ… All fixes applied - infinite loops stopped, achievements working");
})();
</script>



<!-- Add this at the very end of your studentmode.html, just before the closing </body> tag -->

<style>
/* Make the navigation section scrollable */
.sidebar-nav {
    max-height: 400px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding-right: 8px !important;
}

/* Custom scrollbar styling */
.sidebar-nav::-webkit-scrollbar {
    width: 6px !important;
}

.sidebar-nav::-webkit-scrollbar-track {
    background: var(--bg) !important;
    border-radius: 3px !important;
}

.sidebar-nav::-webkit-scrollbar-thumb {
    background: var(--accent) !important;
    border-radius: 3px !important;
}

.sidebar-nav::-webkit-scrollbar-thumb:hover {
    background: var(--accent-dark) !important;
}

/* Firefox scrollbar */
.sidebar-nav {
    scrollbar-width: thin !important;
    scrollbar-color: var(--accent) var(--bg) !important;
}
</style>


<!-- Add this at the very end of your studentmode.html, just before the closing </body> tag -->

<style>
/* Make navigation scrollable */
.sidebar-nav {
    max-height: 400px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    padding-right: 5px !important;
}

.sidebar-nav::-webkit-scrollbar {
    width: 5px !important;
}

.sidebar-nav::-webkit-scrollbar-track {
    background: var(--bg) !important;
}

.sidebar-nav::-webkit-scrollbar-thumb {
    background: var(--accent) !important;
    border-radius: 3px !important;
}

/* Store and Moves buttons */
.store-nav-btn {
    background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
    color: black !important;
    font-weight: 800 !important;
    border: 3px solid #000 !important;
    margin-top: 2px !important;
}

.moves-nav-btn {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
    color: white !important;
    font-weight: 800 !important;
    border: 3px solid #fbbf24 !important;
    margin-top: 2px !important;
    margin-bottom: 5px !important;
}

/* Store and Moves Sections */
.store-section {
    background: linear-gradient(135deg, var(--card), var(--bg));
    border: 3px solid #fbbf24;
    border-radius: 30px;
    padding: 30px;
    margin: 20px 0;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #fbbf24;
    flex-wrap: wrap;
    gap: 15px;
}

.section-title {
    font-size: 2rem;
    font-weight: 800;
    color: #fbbf24;
    display: flex;
    align-items: center;
    gap: 10px;
}

.xp-display {
    background: #000;
    padding: 12px 25px;
    border-radius: 50px;
    border: 2px solid #fbbf24;
    color: #fbbf24;
    font-weight: 700;
    font-size: 1.2rem;
}

.moves-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.move-card {
    background: rgba(0,0,0,0.5);
    border: 2px solid;
    border-radius: 20px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    cursor: pointer;
}

.move-card.common { border-color: #64748b; }
.move-card.rare { border-color: #3b82f6; }
.move-card.epic { border-color: #a855f7; }
.move-card.legendary { border-color: #f97316; }

.move-card.owned {
    opacity: 0.7;
    border-color: #fbbf24;
}

.move-icon {
    font-size: 3rem;
    margin-bottom: 10px;
    text-align: center;
}

.move-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 5px;
    text-align: center;
}

.move-desc {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 15px;
    text-align: center;
}

.move-stats {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    margin-bottom: 15px;
}

.move-stat {
    text-align: center;
}

.move-stat .stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
}

.move-stat .stat-value {
    font-weight: 700;
    color: #fbbf24;
}

.move-cost {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
    color: black;
    padding: 8px;
    border-radius: 30px;
    font-weight: 700;
    text-align: center;
    border: 2px solid #000;
}

.owned-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #fbbf24;
    color: black;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    border: 2px solid #000;
}

.equip-btn {
    margin-top: 10px;
    padding: 8px;
    background: #fbbf24;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    width: 100%;
}

.equip-btn:hover {
    background: #f59e0b;
}

.equip-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #fbbf24;
    color: black;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    border: 2px solid #000;
}
</style>



<script>
// ===== MOVE SHOP & MY MOVES SYSTEM =====

// Move data
const MOVES = [
    { id: 'heavy_punch', name: 'HEAVY PUNCH', icon: 'ðŸ‘Š', rarity: 'common', xpCost: 200, damage: 30, manaCost: 10 },
    { id: 'power_kick', name: 'POWER KICK', icon: 'ðŸ¦µ', rarity: 'common', xpCost: 300, damage: 40, manaCost: 15 },
    { id: 'fire_punch', name: 'FIRE PUNCH', icon: 'ðŸ‘ŠðŸ”¥', rarity: 'rare', xpCost: 500, damage: 45, manaCost: 20 },
    { id: 'thunder_kick', name: 'THUNDER KICK', icon: 'ðŸ¦µâš¡', rarity: 'rare', xpCost: 600, damage: 50, manaCost: 25 },
    { id: 'ice_blast', name: 'ICE BLAST', icon: 'â„ï¸', rarity: 'epic', xpCost: 800, damage: 35, manaCost: 30 },
    { id: 'dragon_fury', name: 'DRAGON FURY', icon: 'ðŸ‰', rarity: 'legendary', xpCost: 1200, damage: 70, manaCost: 40 },
    { id: 'healing_light', name: 'HEALING LIGHT', icon: 'ðŸ’š', rarity: 'rare', xpCost: 400, heal: 40, manaCost: 25 }
];

const BASIC_MOVES = [
    { id: 'punch', name: 'PUNCH', icon: 'ðŸ‘Š', rarity: 'common', damage: 15, manaCost: 0 },
    { id: 'kick', name: 'KICK', icon: 'ðŸ¦µ', rarity: 'common', damage: 20, manaCost: 5 }
];

// State
let ownedMoves = [];
let equippedMoves = [];

// Get XP from RPG data
function getXP() {
    try {
        const data = localStorage.getItem('trueRpgData');
        if (data) {
            return JSON.parse(data).totalXP || 0;
        }
    } catch (e) {}
    return 0;
}

// Update XP in RPG data
function updateXP(amount) {
    try {
        const data = JSON.parse(localStorage.getItem('trueRpgData') || '{}');
        data.totalXP = (data.totalXP || 0) + amount;
        localStorage.setItem('trueRpgData', JSON.stringify(data));
    } catch (e) {}
}

// Load moves from storage
function loadMoves() {
    try {
        const saved = localStorage.getItem('battleOwnedMoves');
        ownedMoves = saved ? [...BASIC_MOVES, ...JSON.parse(saved)] : [...BASIC_MOVES];
    } catch {
        ownedMoves = [...BASIC_MOVES];
    }
    
    try {
        equippedMoves = JSON.parse(localStorage.getItem('battleEquippedMoves') || '["punch","kick"]');
    } catch {
        equippedMoves = ['punch', 'kick'];
    }
}

// Save moves
function saveMoves() {
    const special = ownedMoves.filter(m => !BASIC_MOVES.some(b => b.id === m.id));
    localStorage.setItem('battleOwnedMoves', JSON.stringify(special));
    localStorage.setItem('battleEquippedMoves', JSON.stringify(equippedMoves));
}

// Add buttons to sidebar
function addButtons() {
    const sidebarNav = document.querySelector('.sidebar-nav');
    if (!sidebarNav) {
        setTimeout(addButtons, 1000);
        return;
    }
    
    if (document.querySelector('.store-nav-btn')) return;
    
    // Store button
    const storeBtn = document.createElement('div');
    storeBtn.className = 'nav-item store-nav-btn';
    storeBtn.setAttribute('onclick', 'showStore(); closeMobileMenu();');
    storeBtn.innerHTML = 'ðŸª MOVE SHOP';
    
    // My moves button
    const movesBtn = document.createElement('div');
    movesBtn.className = 'nav-item moves-nav-btn';
    movesBtn.setAttribute('onclick', 'showMoves(); closeMobileMenu();');
    movesBtn.innerHTML = 'ðŸŽ® MY MOVES';
    
    sidebarNav.appendChild(storeBtn);
    sidebarNav.appendChild(movesBtn);
    
    console.log("âœ… Store and Moves buttons added");
}

// Show store
window.showStore = function() {
    document.querySelectorAll('.dashboard-content').forEach(s => s.style.display = 'none');
    document.getElementById('moveStore').style.display = 'block';
    
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector('.store-nav-btn')?.classList.add('active');
    
    loadMoves();
    document.getElementById('storeXpAmount').textContent = getXP();
    
    const grid = document.getElementById('storeMovesGrid');
    const xp = getXP();
    
    grid.innerHTML = MOVES.map(move => {
        const owned = ownedMoves.some(m => m.id === move.id);
        const canBuy = !owned && xp >= move.xpCost;
        
        return `
            <div class="move-card ${move.rarity} ${owned ? 'owned' : ''}" 
                 onclick="${canBuy ? `buyMove('${move.id}')` : ''}">
                <div class="move-icon">${move.icon}</div>
                <div class="move-name">${move.name}</div>
                <div class="move-desc">${move.damage ? `ðŸ’¥ ${move.damage} damage` : ''}${move.heal ? `ðŸ’š Heal ${move.heal}` : ''}</div>
                <div class="move-stats">
                    <div class="move-stat"><div class="stat-label">DMG</div><div class="stat-value">${move.damage || move.heal || '-'}</div></div>
                    <div class="move-stat"><div class="stat-label">MP</div><div class="stat-value">${move.manaCost}</div></div>
                </div>
                <div class="move-cost">âœ¨ ${move.xpCost} XP</div>
                ${owned ? '<div class="owned-badge">OWNED</div>' : ''}
            </div>
        `;
    }).join('');
    
    const header = document.getElementById('dashboardHeader');
    if (header) {
        header.querySelector('h1').textContent = 'ðŸª MOVE SHOP';
        header.querySelector('.dashboard-subtitle').textContent = 'Spend XP to unlock powerful moves!';
    }
};

// Show my moves
window.showMoves = function() {
    document.querySelectorAll('.dashboard-content').forEach(s => s.style.display = 'none');
    document.getElementById('myMoves').style.display = 'block';
    
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector('.moves-nav-btn')?.classList.add('active');
    
    loadMoves();
    document.getElementById('movesXpAmount').textContent = getXP();
    
    const grid = document.getElementById('myMovesGrid');
    const specialMoves = ownedMoves.filter(m => !BASIC_MOVES.some(b => b.id === m.id));
    
    if (specialMoves.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;">No special moves yet. Visit the shop!</div>';
    } else {
        grid.innerHTML = specialMoves.map(move => {
            const equipped = equippedMoves.includes(move.id);
            return `
                <div class="move-card ${move.rarity}">
                    <div class="move-icon">${move.icon}</div>
                    <div class="move-name">${move.name}</div>
                    <div class="move-desc">${move.damage ? `ðŸ’¥ ${move.damage} damage` : ''}${move.heal ? `ðŸ’š Heal ${move.heal}` : ''}</div>
                    <div class="move-stats">
                        <div class="move-stat"><div class="stat-label">DMG</div><div class="stat-value">${move.damage || move.heal || '-'}</div></div>
                        <div class="move-stat"><div class="stat-label">MP</div><div class="stat-value">${move.manaCost}</div></div>
                    </div>
                    ${equipped ? '<div class="equip-badge">EQUIPPED</div>' : ''}
                    <button class="equip-btn" onclick="toggleEquip(\'${move.id}\')">${equipped ? 'UNEQUIP' : 'EQUIP'}</button>
                </div>
            `;
        }).join('');
    }
    
    const header = document.getElementById('dashboardHeader');
    if (header) {
        header.querySelector('h1').textContent = 'ðŸŽ® MY MOVES';
        header.querySelector('.dashboard-subtitle').textContent = 'Equip up to 4 moves to use in battle';
    }
};

// Buy move
window.buyMove = function(moveId) {
    const move = MOVES.find(m => m.id === moveId);
    if (!move) return;
    
    const xp = getXP();
    if (xp < move.xpCost) {
        alert(`âŒ Need ${move.xpCost} XP!`);
        return;
    }
    
    updateXP(-move.xpCost);
    loadMoves();
    ownedMoves.push(move);
    saveMoves();
    
    document.getElementById('storeXpAmount').textContent = getXP();
    document.getElementById('movesXpAmount').textContent = getXP();
    
    alert(`âœ… Purchased ${move.name}!`);
    showStore();
};

// Toggle equip
window.toggleEquip = function(moveId) {
    loadMoves();
    
    const index = equippedMoves.indexOf(moveId);
    if (index > -1) {
        equippedMoves.splice(index, 1);
    } else {
        if (equippedMoves.length >= 4) {
            alert("You can only equip 4 moves!");
            return;
        }
        equippedMoves.push(moveId);
    }
    
    saveMoves();
    showMoves();
};

// Initialize
setTimeout(() => {
    loadMoves();
    addButtons();
    console.log("âœ… Move Shop and My Moves ready");
}, 2000);


</script>
</body>
</html>
